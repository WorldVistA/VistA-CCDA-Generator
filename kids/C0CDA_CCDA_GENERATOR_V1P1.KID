KIDS Distribution saved on Mar 05, 2018@02:49:01
Certified version of C0CDA ccda generator for Astronaut VistA. Proprietary
**KIDS**:C0CDA*1.0*1^

**INSTALL NAME**
C0CDA*1.0*1
"BLD",9698,0)
C0CDA*1.0*1^^0^3180305^n
"BLD",9698,1,0)
^^4^4^3180305^
"BLD",9698,1,1,0)
C0CDA ccda generation package customized for Astronaut VistA
"BLD",9698,1,2,0)
copyright George Lilly 2010-2018
"BLD",9698,1,3,0)
Not for public distribtion.
"BLD",9698,1,4,0)
For use by Astronaut VistA.
"BLD",9698,4,0)
^9.64PA^^
"BLD",9698,6.3)
1
"BLD",9698,"KRN",0)
^9.67PA^779.2^20
"BLD",9698,"KRN",.4,0)
.4
"BLD",9698,"KRN",.401,0)
.401
"BLD",9698,"KRN",.402,0)
.402
"BLD",9698,"KRN",.403,0)
.403
"BLD",9698,"KRN",.5,0)
.5
"BLD",9698,"KRN",.84,0)
.84
"BLD",9698,"KRN",3.6,0)
3.6
"BLD",9698,"KRN",3.8,0)
3.8
"BLD",9698,"KRN",9.2,0)
9.2
"BLD",9698,"KRN",9.8,0)
9.8
"BLD",9698,"KRN",9.8,"NM",0)
^9.68A^29^29
"BLD",9698,"KRN",9.8,"NM",1,0)
C0CDAC0^^0^B276169562
"BLD",9698,"KRN",9.8,"NM",2,0)
C0CDAC1^^0^B76574835
"BLD",9698,"KRN",9.8,"NM",3,0)
C0CDAC2^^0^B279347626
"BLD",9698,"KRN",9.8,"NM",4,0)
C0CDAC3^^0^B250874886
"BLD",9698,"KRN",9.8,"NM",5,0)
C0CDAC4^^0^B228032796
"BLD",9698,"KRN",9.8,"NM",6,0)
C0CDAC5^^0^B144664305
"BLD",9698,"KRN",9.8,"NM",7,0)
C0CDAC6^^0^B182000027
"BLD",9698,"KRN",9.8,"NM",8,0)
C0CDAC7^^0^B78096691
"BLD",9698,"KRN",9.8,"NM",9,0)
C0CDAC8^^0^B576732040
"BLD",9698,"KRN",9.8,"NM",10,0)
C0CDAC9^^0^B85540746
"BLD",9698,"KRN",9.8,"NM",11,0)
C0CDACD^^0^B26122201
"BLD",9698,"KRN",9.8,"NM",12,0)
C0CDACE^^0^B122081491
"BLD",9698,"KRN",9.8,"NM",13,0)
C0CDACF^^0^B42642199
"BLD",9698,"KRN",9.8,"NM",14,0)
C0CDACI^^0^B991484708
"BLD",9698,"KRN",9.8,"NM",15,0)
C0CDACM^^0^B91630586
"BLD",9698,"KRN",9.8,"NM",16,0)
C0CDACN^^0^B15735600
"BLD",9698,"KRN",9.8,"NM",17,0)
C0CDACP^^0^B949625958
"BLD",9698,"KRN",9.8,"NM",18,0)
C0CDACT^^0^B85720702
"BLD",9698,"KRN",9.8,"NM",19,0)
C0CDACU^^0^B104681872
"BLD",9698,"KRN",9.8,"NM",20,0)
C0CDACV^^0^B102805139
"BLD",9698,"KRN",9.8,"NM",21,0)
C0CDACW^^0^B10312003
"BLD",9698,"KRN",9.8,"NM",22,0)
C0CDACZ^^0^B219667
"BLD",9698,"KRN",9.8,"NM",23,0)
C0CDAD2^^0^B230502977
"BLD",9698,"KRN",9.8,"NM",24,0)
C0CDA^^0^B136158529
"BLD",9698,"KRN",9.8,"NM",25,0)
C0CDAOR^^0^B38289844
"BLD",9698,"KRN",9.8,"NM",26,0)
C0CDAPCE^^0^B2521747
"BLD",9698,"KRN",9.8,"NM",27,0)
C0CDAQH^^0^B142601431
"BLD",9698,"KRN",9.8,"NM",28,0)
C0CDAQU^^0^B1447833
"BLD",9698,"KRN",9.8,"NM",29,0)
KBAIQLDM^^0^B159500041
"BLD",9698,"KRN",9.8,"NM","B","C0CDA",24)

"BLD",9698,"KRN",9.8,"NM","B","C0CDAC0",1)

"BLD",9698,"KRN",9.8,"NM","B","C0CDAC1",2)

"BLD",9698,"KRN",9.8,"NM","B","C0CDAC2",3)

"BLD",9698,"KRN",9.8,"NM","B","C0CDAC3",4)

"BLD",9698,"KRN",9.8,"NM","B","C0CDAC4",5)

"BLD",9698,"KRN",9.8,"NM","B","C0CDAC5",6)

"BLD",9698,"KRN",9.8,"NM","B","C0CDAC6",7)

"BLD",9698,"KRN",9.8,"NM","B","C0CDAC7",8)

"BLD",9698,"KRN",9.8,"NM","B","C0CDAC8",9)

"BLD",9698,"KRN",9.8,"NM","B","C0CDAC9",10)

"BLD",9698,"KRN",9.8,"NM","B","C0CDACD",11)

"BLD",9698,"KRN",9.8,"NM","B","C0CDACE",12)

"BLD",9698,"KRN",9.8,"NM","B","C0CDACF",13)

"BLD",9698,"KRN",9.8,"NM","B","C0CDACI",14)

"BLD",9698,"KRN",9.8,"NM","B","C0CDACM",15)

"BLD",9698,"KRN",9.8,"NM","B","C0CDACN",16)

"BLD",9698,"KRN",9.8,"NM","B","C0CDACP",17)

"BLD",9698,"KRN",9.8,"NM","B","C0CDACT",18)

"BLD",9698,"KRN",9.8,"NM","B","C0CDACU",19)

"BLD",9698,"KRN",9.8,"NM","B","C0CDACV",20)

"BLD",9698,"KRN",9.8,"NM","B","C0CDACW",21)

"BLD",9698,"KRN",9.8,"NM","B","C0CDACZ",22)

"BLD",9698,"KRN",9.8,"NM","B","C0CDAD2",23)

"BLD",9698,"KRN",9.8,"NM","B","C0CDAOR",25)

"BLD",9698,"KRN",9.8,"NM","B","C0CDAPCE",26)

"BLD",9698,"KRN",9.8,"NM","B","C0CDAQH",27)

"BLD",9698,"KRN",9.8,"NM","B","C0CDAQU",28)

"BLD",9698,"KRN",9.8,"NM","B","KBAIQLDM",29)

"BLD",9698,"KRN",19,0)
19
"BLD",9698,"KRN",19.1,0)
19.1
"BLD",9698,"KRN",101,0)
101
"BLD",9698,"KRN",409.61,0)
409.61
"BLD",9698,"KRN",771,0)
771
"BLD",9698,"KRN",779.2,0)
779.2
"BLD",9698,"KRN",870,0)
870
"BLD",9698,"KRN",8989.51,0)
8989.51
"BLD",9698,"KRN",8989.52,0)
8989.52
"BLD",9698,"KRN",8994,0)
8994
"BLD",9698,"KRN","B",.4,.4)

"BLD",9698,"KRN","B",.401,.401)

"BLD",9698,"KRN","B",.402,.402)

"BLD",9698,"KRN","B",.403,.403)

"BLD",9698,"KRN","B",.5,.5)

"BLD",9698,"KRN","B",.84,.84)

"BLD",9698,"KRN","B",3.6,3.6)

"BLD",9698,"KRN","B",3.8,3.8)

"BLD",9698,"KRN","B",9.2,9.2)

"BLD",9698,"KRN","B",9.8,9.8)

"BLD",9698,"KRN","B",19,19)

"BLD",9698,"KRN","B",19.1,19.1)

"BLD",9698,"KRN","B",101,101)

"BLD",9698,"KRN","B",409.61,409.61)

"BLD",9698,"KRN","B",771,771)

"BLD",9698,"KRN","B",779.2,779.2)

"BLD",9698,"KRN","B",870,870)

"BLD",9698,"KRN","B",8989.51,8989.51)

"BLD",9698,"KRN","B",8989.52,8989.52)

"BLD",9698,"KRN","B",8994,8994)

"MBREQ")
0
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
29
"RTN","C0CDA")
0^24^B136158529
"RTN","C0CDA",1,0)
C0CDA ; GPL - CCDA Routines ;9/18/13  17:05
"RTN","C0CDA",2,0)
 ;;0.1;C0CDA;nopatch;noreleasedate;Build 1
"RTN","C0CDA",3,0)
 ;
"RTN","C0CDA",4,0)
 ; License Apache 2
"RTN","C0CDA",5,0)
 ; 
"RTN","C0CDA",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDA",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDA",8,0)
 ;
"RTN","C0CDA",9,0)
 Q
"RTN","C0CDA",10,0)
 ;
"RTN","C0CDA",11,0)
 ; This is the main entry point for the CCDA generation routines
"RTN","C0CDA",12,0)
 ;
"RTN","C0CDA",13,0)
wsCCDA(OUT,FILTER) ; web service which returns a ccda
"RTN","C0CDA",14,0)
 S DUZ=1
"RTN","C0CDA",15,0)
 S DUZ(2)=1 ; GPL HACK
"RTN","C0CDA",16,0)
 I '$D(DT) N DIQUIET S DIQUIET=1 D DT^DICRW
"RTN","C0CDA",17,0)
 S HTTPRSP("mime")="text/xml"
"RTN","C0CDA",18,0)
 S DFN=$G(FILTER("patientId"))
"RTN","C0CDA",19,0)
 I $G(FILTER("testpat"))'="" S C0TEST=1
"RTN","C0CDA",20,0)
 I DFN="" Q  ;
"RTN","C0CDA",21,0)
 N PARM
"RTN","C0CDA",22,0)
 ;D PRSPARMS(.FILTER,.PARM) ; parse incoming parms and overlay on defaults
"RTN","C0CDA",23,0)
 N SEL S SEL=$$FILTERV^C0CDAC0(.FILTER,DFN)
"RTN","C0CDA",24,0)
 ;Q:'SEL "no matching visits"
"RTN","C0CDA",25,0)
 D LOGARY^C0CDACU("FILTER") ; log the parm array
"RTN","C0CDA",26,0)
 N C0LOG S C0LOG=1
"RTN","C0CDA",27,0)
 D CCDARPC^C0CDAC0(.OUT,DFN,.FILTER)
"RTN","C0CDA",28,0)
 K ^GPL
"RTN","C0CDA",29,0)
 M ^GPL=^TMP("CCDA",$J)
"RTN","C0CDA",30,0)
 ;S @OUT@(2)="<?xml-stylesheet type=""text/xsl"" href=""http://ccda.vistaewd.net/resources/CDA.xsl""?>"
"RTN","C0CDA",31,0)
 S @OUT@(2)="<?xml-stylesheet type=""text/xsl"" href=""/resources/css/CDA.xsl""?>"
"RTN","C0CDA",32,0)
 D ADDCRLF^VPRJRUT(.OUT)
"RTN","C0CDA",33,0)
 Q
"RTN","C0CDA",34,0)
 ;
"RTN","C0CDA",35,0)
TESTCCDA ;
"RTN","C0CDA",36,0)
 K G
"RTN","C0CDA",37,0)
 S DEBUG=1
"RTN","C0CDA",38,0)
 N PRM
"RTN","C0CDA",39,0)
 S PRM("patientId")=1
"RTN","C0CDA",40,0)
 S PRM("id")="CCDA-100-1-20050801.xml"
"RTN","C0CDA",41,0)
 D wsCCDA(.G,.PRM)
"RTN","C0CDA",42,0)
 Q
"RTN","C0CDA",43,0)
 ;
"RTN","C0CDA",44,0)
CCDARPC(RTN,DFN,PARMS) ; generates a CCDA document for patient DFN
"RTN","C0CDA",45,0)
 ; RTN is passed by reference
"RTN","C0CDA",46,0)
 ; PARMS are parameters that govern the output of form: parm1:value1^parm2:value2 etc.
"RTN","C0CDA",47,0)
 ;   SELECT:LATEST will generate a ccda for the latest encounter
"RTN","C0CDA",48,0)
 ;   SELECT:date will generate a ccda for the encounter on the date
"RTN","C0CDA",49,0)
 ;
"RTN","C0CDA",50,0)
 N C0BCRTL,C0BLDBLD,C0BUILD,C0WRK,C0TBL,C0PARMS,C0LOG,C0LOGLOC
"RTN","C0CDA",51,0)
 ;
"RTN","C0CDA",52,0)
 ; create a work area for processing and clear it
"RTN","C0CDA",53,0)
 ;
"RTN","C0CDA",54,0)
 S C0WRK=$NA(^TMP("CCDA",$J)) ; work area root for entire process
"RTN","C0CDA",55,0)
 K @C0WRK ; make sure it is clear to begin
"RTN","C0CDA",56,0)
 S C0BCTRL=$NA(@C0WRK@("CTRL"))
"RTN","C0CDA",57,0)
 S @C0BCTRL@("PARMS")=""
"RTN","C0CDA",58,0)
 I $D(PARMS) M @C0BCTRL@("PARMS")=PARMS ; parameters for all processes to use
"RTN","C0CDA",59,0)
 S C0LOG=$G(PARMS("LOG")) ; produce a log of the extract: LOG:1
"RTN","C0CDA",60,0)
 I C0LOG["YES" S C0LOG=1 ; yes means 1
"RTN","C0CDA",61,0)
 S C0LOGLOC=$NA(@C0WRK@("LOG"))
"RTN","C0CDA",62,0)
 D:C0LOG  ;
"RTN","C0CDA",63,0)
 . D OUTLOG^C0CDACU("DFN: "_DFN_" "_$P(^DPT(DFN,0),"^",1))
"RTN","C0CDA",64,0)
 . N II S II=""
"RTN","C0CDA",65,0)
 . F  S II=$O(PARMS(II)) Q:II=""  D OUTLOG^C0CDACU("PARMS("_II_")="_PARMS(II))
"RTN","C0CDA",66,0)
 S C0BLDBLD=$NA(@C0BCTRL@("BLDBLD")) ; build list of build lists
"RTN","C0CDA",67,0)
 S @C0BLDBLD@("DFN")=DFN
"RTN","C0CDA",68,0)
 S @C0BLDBLD@("START-TIME")=$$NOW^XLFDT
"RTN","C0CDA",69,0)
 ;
"RTN","C0CDA",70,0)
 ; build a table of the processing order and routines to call
"RTN","C0CDA",71,0)
 ;
"RTN","C0CDA",72,0)
 D BTBL(.C0TBL,"BCCDA1^C0CDAC0",.PARMS) ; build the table of what to process
"RTN","C0CDA",73,0)
 ;
"RTN","C0CDA",74,0)
 ; set up control blocks and work areas for each build component
"RTN","C0CDA",75,0)
 ;
"RTN","C0CDA",76,0)
 N C0I
"RTN","C0CDA",77,0)
 F C0I=1:1:C0TBL(0) D  ;
"RTN","C0CDA",78,0)
 . N C0KEY,C0RT
"RTN","C0CDA",79,0)
 . S C0KEY=$P(C0TBL(C0I),",",1)
"RTN","C0CDA",80,0)
 . S C0RT=$P(C0TBL(C0I),",",2)
"RTN","C0CDA",81,0)
 . S C0BUILD=$NA(@C0WRK@("BUILD",C0KEY))
"RTN","C0CDA",82,0)
 . S @C0BLDBLD@(C0I)=C0BUILD
"RTN","C0CDA",83,0)
 . S @C0BLDBLD@(0)=C0I
"RTN","C0CDA",84,0)
 . S @C0BCTRL@("ORDER",C0I)=C0KEY
"RTN","C0CDA",85,0)
 . S @C0BCTRL@("ORDER",0)=C0I
"RTN","C0CDA",86,0)
 . S @C0BCTRL@(C0KEY,"ROUTINE")=C0RT
"RTN","C0CDA",87,0)
 . S @C0BCTRL@(C0KEY,"STATUS")="INIT" ; section is intialized
"RTN","C0CDA",88,0)
 . S @C0BCTRL@(C0KEY,"INIT-TIME")=$$NOW^XLFDT
"RTN","C0CDA",89,0)
 . S @C0BCTRL@(C0KEY,"BUILD-LIST")=C0BUILD
"RTN","C0CDA",90,0)
 . S @C0BCTRL@(C0KEY,"WORK-AREA")=$NA(@C0WRK@(C0KEY))
"RTN","C0CDA",91,0)
 D:$G(C0DEBUG) GTREE^KBAIVPR(C0BCTRL)
"RTN","C0CDA",92,0)
 ;
"RTN","C0CDA",93,0)
 ; the rest of the processing can be done from the C0BLDBLD table,
"RTN","C0CDA",94,0)
 ;  which contains the routine to call and the work area that returns
"RTN","C0CDA",95,0)
 ;  the result
"RTN","C0CDA",96,0)
 ; 
"RTN","C0CDA",97,0)
 ; at this point, we can spawn new taskman tasks to extract and build
"RTN","C0CDA",98,0)
 ;  all of the components of the document in parallel. in fact, we
"RTN","C0CDA",99,0)
 ;  could launch a parent task to spawn all of that work and use this
"RTN","C0CDA",100,0)
 ;  routine to monitor progress and return the final result when done. 
"RTN","C0CDA",101,0)
 ; 
"RTN","C0CDA",102,0)
 ; initially, we are going to process everything sequentially without
"RTN","C0CDA",103,0)
 ;  without using taskman
"RTN","C0CDA",104,0)
 ;
"RTN","C0CDA",105,0)
 F C0I=1:1:@C0BCTRL@("ORDER",0) D  ; for each component to be built
"RTN","C0CDA",106,0)
 . N C0KEY,C0BLD,C0RT,C0AREA,C0X,C0REPORT
"RTN","C0CDA",107,0)
 . S C0KEY=@C0BCTRL@("ORDER",C0I)
"RTN","C0CDA",108,0)
 . S C0BLD=@C0BCTRL@(C0KEY,"BUILD-LIST")
"RTN","C0CDA",109,0)
 . S C0RT=@C0BCTRL@(C0KEY,"ROUTINE")
"RTN","C0CDA",110,0)
 . S C0REPORT=$NA(@C0BCTRL@(C0KEY))
"RTN","C0CDA",111,0)
 . S C0AREA=@C0BCTRL@(C0KEY,"WORK-AREA")
"RTN","C0CDA",112,0)
 . S C0X="D "_C0RT_"(C0BLD,DFN,C0AREA,C0REPORT,C0BCTRL)"
"RTN","C0CDA",113,0)
 . D:C0LOG OUTLOG^C0CDACU("RUNNING "_C0X)
"RTN","C0CDA",114,0)
 . X C0X
"RTN","C0CDA",115,0)
 N LAST1 S LAST1=$NA(@C0WRK@("LAST1"))
"RTN","C0CDA",116,0)
 D GET^C0CDACU(LAST1,"TLAST1^C0CDAC0")
"RTN","C0CDA",117,0)
 N C0BLIST S C0BLIST=$NA(@C0WRK@("BUILD","C0BLIST"))
"RTN","C0CDA",118,0)
 D QUEUE^MXMLTMPL(C0BLIST,LAST1,1,@LAST1@(0))
"RTN","C0CDA",119,0)
 D ADDTO(C0BLDBLD,C0BLIST)
"RTN","C0CDA",120,0)
 D:$G(C0DEBUG) GTREE^KBAIVPR(C0WRK,9)
"RTN","C0CDA",121,0)
 D BUILDM(C0BLDBLD,.RTN)
"RTN","C0CDA",122,0)
 Q
"RTN","C0CDA",123,0)
 ;
"RTN","C0CDA",124,0)
BTBL(TBL,INTAG,PARM) ; build table TBL of processing order passed by reference 
"RTN","C0CDA",125,0)
 ; INTAG is the name of a tag that stores the table ie. BCCDA1^C0CDAC0
"RTN","C0CDA",126,0)
 ; gpl - added the ability to only process one clinical domain by specifying it
"RTN","C0CDA",127,0)
 ; in the parameters SECTIONONLY=MEDS for example
"RTN","C0CDA",128,0)
 ;;HEADER,HEADER^C0CDAC2
"RTN","C0CDA",129,0)
 ;;ALGY,ALLERGY^C0CDAC8
"RTN","C0CDA",130,0)
 ;;ENC,ENC^C0CDACV
"RTN","C0CDA",131,0)
 ;;SOC,SOC^C0CDAC7
"RTN","C0CDA",132,0)
 ;;MEDS,MEDS^C0CDAC4
"RTN","C0CDA",133,0)
 ;;PROBLEMS,PROBLEMS^C0CDAC3
"RTN","C0CDA",134,0)
 ;;LABS,LABS^C0CDAC5
"RTN","C0CDA",135,0)
 ;;VITALS,VITALS^C0CDAC6
"RTN","C0CDA",136,0)
 N GTAG,GRT,GI
"RTN","C0CDA",137,0)
 S GTAG=$P(INTAG,"^",1)
"RTN","C0CDA",138,0)
 S GRT=$P(INTAG,"^",2)
"RTN","C0CDA",139,0)
 N GN S GN=1
"RTN","C0CDA",140,0)
 F  S GI=GTAG_"+"_GN_"^"_GRT  Q:$T(@GI)'[";;"  D  ;
"RTN","C0CDA",141,0)
 . S TBL(GN)=$P($T(@GI),";;",2)
"RTN","C0CDA",142,0)
 . S TBL(0)=GN
"RTN","C0CDA",143,0)
 . I $G(CCDADEBUG) W !,GN," ",TBL(GN)
"RTN","C0CDA",144,0)
 . S GN=GN+1
"RTN","C0CDA",145,0)
 I $D(PARM("SECTIONONLY")) D  ;
"RTN","C0CDA",146,0)
 . N TTAB,GGI,GSEC S GGI=""
"RTN","C0CDA",147,0)
 . S GSEC=PARM("SECTIONONLY")
"RTN","C0CDA",148,0)
 . F GGI=1:1:TBL(0) D  ;
"RTN","C0CDA",149,0)
 . . I GSEC=$P(TBL(GGI),",",1) S TTAB=TBL(GGI)
"RTN","C0CDA",150,0)
 . I $D(TTAB) D  ;
"RTN","C0CDA",151,0)
 . . K TBL
"RTN","C0CDA",152,0)
 . . S TBL(1)=TTAB
"RTN","C0CDA",153,0)
 . . S TBL(0)=1
"RTN","C0CDA",154,0)
 Q
"RTN","C0CDA",155,0)
 ;
"RTN","C0CDA",156,0)
BUILDM(BBLIST,OUTXML) ; process a build list of build lists to generate xml
"RTN","C0CDA",157,0)
 ; both BBLIST and OUTXML are passed by name
"RTN","C0CDA",158,0)
 ;
"RTN","C0CDA",159,0)
 N BIGLIST,C0I,C0J,C0N
"RTN","C0CDA",160,0)
 S C0N=0
"RTN","C0CDA",161,0)
 F C0I=1:1:@BBLIST@(0) D  ;
"RTN","C0CDA",162,0)
 . N BLIST
"RTN","C0CDA",163,0)
 . S BLIST=@BBLIST@(C0I) ; build list
"RTN","C0CDA",164,0)
 . I '$D(@BLIST) Q  ;
"RTN","C0CDA",165,0)
 . F C0J=1:1:@BLIST@(0) D  ;
"RTN","C0CDA",166,0)
 . . S C0N=C0N+1
"RTN","C0CDA",167,0)
 . . S BIGLIST(C0N)=@BLIST@(C0J)
"RTN","C0CDA",168,0)
 . . S BIGLIST(0)=C0N
"RTN","C0CDA",169,0)
 S OUTXML=$NA(@C0WRK@("XML"))
"RTN","C0CDA",170,0)
 K @OUTXML
"RTN","C0CDA",171,0)
 D BUILD^MXMLTMPL("BIGLIST",OUTXML)
"RTN","C0CDA",172,0)
 K @OUTXML@(0)
"RTN","C0CDA",173,0)
 Q
"RTN","C0CDA",174,0)
 ;
"RTN","C0CDA",175,0)
ADDTO(DEST,WHAT) ; adds string WHAT to list DEST 
"RTN","C0CDA",176,0)
 ; DEST is passed by name
"RTN","C0CDA",177,0)
 N GN
"RTN","C0CDA",178,0)
 S GN=$O(@DEST@("AAAAAA"),-1)+1
"RTN","C0CDA",179,0)
 S @DEST@(GN)=WHAT
"RTN","C0CDA",180,0)
 S @DEST@(0)=GN ; count
"RTN","C0CDA",181,0)
 Q
"RTN","C0CDA",182,0)
 ;
"RTN","C0CDA",183,0)
CCDA(DFN,PARMS,sessid) ; extrinsic to create a ccda and return the filename
"RTN","C0CDA",184,0)
 ; PARMS is parameter string format: parm1=val1&parm2=val2&parm3=val3
"RTN","C0CDA",185,0)
 ; ignore sessid for now
"RTN","C0CDA",186,0)
 ;
"RTN","C0CDA",187,0)
 I '$D(^DPT(DFN)) Q ""
"RTN","C0CDA",188,0)
 I '$D(PARMS) N PARMS S PARMS=""
"RTN","C0CDA",189,0)
 N PARM
"RTN","C0CDA",190,0)
 ; defaults
"RTN","C0CDA",191,0)
 S PARM("DUZ")=135
"RTN","C0CDA",192,0)
 S PARM("SELECT")="ALL"
"RTN","C0CDA",193,0)
 S PARM("LOG")=1
"RTN","C0CDA",194,0)
 S PARM("MEDS")="FILTER1"
"RTN","C0CDA",195,0)
 D PRSPARMS(PARMS,.PARM) ; parse incoming parms and overlay on defaults
"RTN","C0CDA",196,0)
 N SEL S SEL=$$FILTERV(.PARM,DFN)
"RTN","C0CDA",197,0)
 Q:'SEL "no matching visits"
"RTN","C0CDA",198,0)
 D LOGARY^C0CDACU("PARM") ; log the parm array
"RTN","C0CDA",199,0)
 N C0LOG S C0LOG=1
"RTN","C0CDA",200,0)
 D CCDARPC(.CCDA,DFN,.PARM)
"RTN","C0CDA",201,0)
 N FN
"RTN","C0CDA",202,0)
 S FN=$$OUTCCDA(CCDA) ; 
"RTN","C0CDA",203,0)
 ;N C0LOGLOC S C0LOGLOC=$NA(^TMP("CCDA",$J,"LOG"))
"RTN","C0CDA",204,0)
 ;D BROWSE^DDBR(C0LOGLOC,"N","PATIENT "_DFN_" "_FN)
"RTN","C0CDA",205,0)
 K ^TMP("CCDA","GPL")
"RTN","C0CDA",206,0)
 M ^TMP("CCDA","GPL")=^TMP("CCDA",$J,"LOG")
"RTN","C0CDA",207,0)
 K ^TMP("CCDA",$J) ; clean up
"RTN","C0CDA",208,0)
 K C0BCTRL,C0DATE2,C0LOGLOC,CCDA,CV,GN,ORDIALOG,JJOHDID
"RTN","C0CDA",209,0)
 K ^TMP("MXMLDOM",$J)
"RTN","C0CDA",210,0)
 Q FN
"RTN","C0CDA",211,0)
 ;
"RTN","C0CDA",212,0)
PRSPARMS(PSTR,PARY) ; parse parms into array
"RTN","C0CDA",213,0)
 I PSTR="" Q  ;
"RTN","C0CDA",214,0)
 I PSTR["=" D  ;
"RTN","C0CDA",215,0)
 . N P1,P2,P3,P4,P5
"RTN","C0CDA",216,0)
 . S P2=$L(PSTR,"&")
"RTN","C0CDA",217,0)
 . F P1=1:1:P2 D  ;
"RTN","C0CDA",218,0)
 . . S P3=$P(PSTR,"&",P1)
"RTN","C0CDA",219,0)
 . . S X=$P(P3,"=",1)
"RTN","C0CDA",220,0)
 . . X ^%ZOSF("UPPERCASE")
"RTN","C0CDA",221,0)
 . . S P4=Y
"RTN","C0CDA",222,0)
 . . S X=$P(P3,"=",2)
"RTN","C0CDA",223,0)
 . . X ^%ZOSF("UPPERCASE")
"RTN","C0CDA",224,0)
 . . S P5=Y
"RTN","C0CDA",225,0)
 . . S PARY(P4)=P5
"RTN","C0CDA",226,0)
 D RDCTPRM(.PARM) ; further parse the REDACT parameter
"RTN","C0CDA",227,0)
 Q
"RTN","C0CDA",228,0)
 ;
"RTN","C0CDA",229,0)
RDCTPRM(PARM) ; used by PRSPARMS to further parse the REDACT parameter
"RTN","C0CDA",230,0)
 ; which has the format REDACT:uri1,uri2,uri3... Here's the result:
"RTN","C0CDA",231,0)
 ;G("REDACT")="1,2,3,4,5,6,7"
"RTN","C0CDA",232,0)
 ;G("REDACT",1)=1
"RTN","C0CDA",233,0)
 ;G("REDACT",2)=1
"RTN","C0CDA",234,0)
 ;G("REDACT",3)=1
"RTN","C0CDA",235,0)
 ;G("REDACT",4)=1
"RTN","C0CDA",236,0)
 ;G("REDACT",5)=1
"RTN","C0CDA",237,0)
 ;G("REDACT",6)=1
"RTN","C0CDA",238,0)
 ;G("REDACT",7)=1
"RTN","C0CDA",239,0)
 I '$D(PARM("REDACT")) Q  ;
"RTN","C0CDA",240,0)
 N Y S Y=PARM("REDACT")
"RTN","C0CDA",241,0)
 I Y="" Q
"RTN","C0CDA",242,0)
 N X S X=$L(Y,",")
"RTN","C0CDA",243,0)
 I X=1 S PARM("REDACT",Y)=1 Q  ;
"RTN","C0CDA",244,0)
 N Z
"RTN","C0CDA",245,0)
 F Z=1:1:X S PARM("REDACT",$P(Y,",",Z))=1 
"RTN","C0CDA",246,0)
 Q
"RTN","C0CDA",247,0)
 ;
"RTN","C0CDA",248,0)
FILTERV(PARM,DFN) ; modify the Parm array to select the visits to be extracted. 
"RTN","C0CDA",249,0)
 ; PARM is passed by ref
"RTN","C0CDA",250,0)
 N VIS
"RTN","C0CDA",251,0)
 D VISITS^C0CDACV(.VIS,DFN)
"RTN","C0CDA",252,0)
 I $O(VIS(""))="" Q 0 ; no matching visits
"RTN","C0CDA",253,0)
 N EKEYS ; table of valid select commands (all others are dates)
"RTN","C0CDA",254,0)
 S EKEYS("LATEST")=""
"RTN","C0CDA",255,0)
 S EKEYS("LATESTOP")=""
"RTN","C0CDA",256,0)
 S EKEYS("LATESTIP")=""
"RTN","C0CDA",257,0)
 S EKEYS("ALL")=""
"RTN","C0CDA",258,0)
 N RSLT S RSLT=0
"RTN","C0CDA",259,0)
 ;I $G(PARM("STARTDATERANGE"))'="" D  Q RSLT ;
"RTN","C0CDA",260,0)
 I '$D(PARM("SELECT")) S PARM("SELECT")=$G(PARM("select"))
"RTN","C0CDA",261,0)
 N SEL S SEL=$G(PARM("SELECT"))
"RTN","C0CDA",262,0)
 I SEL="" S SEL="ALL" S PARM("SELECT")="ALL"
"RTN","C0CDA",263,0)
 ;S RSLT=$$DODATES^C0CDAC0(.VIS,.PARM) ; establish effective dates for header
"RTN","C0CDA",264,0)
 S PARM("date")=$G(VIS(1,"date")) ; best discharge date is the latest visit date
"RTN","C0CDA",265,0)
 I '$D(EKEYS(SEL)) D  Q RSLT ;
"RTN","C0CDA",266,0)
 . S RSLT=$$DODATES^C0CDAC0(.VIS,.PARM)
"RTN","C0CDA",267,0)
 I $G(PARM("SELECT"))="LATEST" D  Q 1 ;
"RTN","C0CDA",268,0)
 . M PARM=VIS(1)
"RTN","C0CDA",269,0)
 . I VIS(1,"visitType")="inpatient" D EXTENDIP(.VIS,.PARM,1)
"RTN","C0CDA",270,0)
 S RSLT=0
"RTN","C0CDA",271,0)
 I $G(PARM("SELECT"))="LATESTOP" D  Q RSLT ;
"RTN","C0CDA",272,0)
 . N ZI S ZI=""
"RTN","C0CDA",273,0)
 . N DONE S DONE=0
"RTN","C0CDA",274,0)
 . F  S ZI=$O(VIS(ZI)) Q:DONE  Q:ZI=""  D  ;
"RTN","C0CDA",275,0)
 . . I VIS(ZI,"visitType")="outpatient" D  ;
"RTN","C0CDA",276,0)
 . . . S RSLT=1
"RTN","C0CDA",277,0)
 . . . S DONE=1
"RTN","C0CDA",278,0)
 . . . M PARM=VIS(ZI)
"RTN","C0CDA",279,0)
 S RSLT=0
"RTN","C0CDA",280,0)
 I $G(PARM("SELECT"))="LATESTIP" D  Q RSLT ;
"RTN","C0CDA",281,0)
 . N ZI S ZI=""
"RTN","C0CDA",282,0)
 . N DONE S DONE=0
"RTN","C0CDA",283,0)
 . F  S ZI=$O(VIS(ZI)) Q:DONE  Q:ZI=""  D  ;
"RTN","C0CDA",284,0)
 . . I VIS(ZI,"visitType")="inpatient" D  ;
"RTN","C0CDA",285,0)
 . . . S RSLT=1
"RTN","C0CDA",286,0)
 . . . S DONE=1
"RTN","C0CDA",287,0)
 . . . M PARM=VIS(ZI) ; will be used for endDateTime for multi day stays
"RTN","C0CDA",288,0)
 . . . D EXTENDIP(.VIS,.PARM,ZI) ; extend the date range to the whole hospital stay
"RTN","C0CDA",289,0)
 Q 1
"RTN","C0CDA",290,0)
 ;
"RTN","C0CDA",291,0)
DODATES(VIS,PARM) ; extrinsic which handles paramaters which include
"RTN","C0CDA",292,0)
 ; startDateRange:xxxx
"RTN","C0CDA",293,0)
 N RSP S RSP=1
"RTN","C0CDA",294,0)
 N SEL S SEL=$G(PARM("SELECT"))
"RTN","C0CDA",295,0)
 I SEL="" Q 0
"RTN","C0CDA",296,0)
 S PARM("STARTDATERANGE")=$P(SEL,":",1)
"RTN","C0CDA",297,0)
 S PARM("ENDDATERANGE")=$P(SEL,":",2)
"RTN","C0CDA",298,0)
 I PARM("ENDDATERANGE")="" S PARM("ENDDATERANGE")="T"
"RTN","C0CDA",299,0)
 N X
"RTN","C0CDA",300,0)
 S X=$$FMDATE($G(PARM("STARTDATERANGE")))
"RTN","C0CDA",301,0)
 I X>-1 S PARM("startDateTime")=X
"RTN","C0CDA",302,0)
 E  S RSP=0 Q RSP
"RTN","C0CDA",303,0)
 S X=$$FMDATE($G(PARM("ENDDATERANGE")))
"RTN","C0CDA",304,0)
 I X>-1 S PARM("endDateTime")=$S(X>PARM("startDateTime"):X,1:$$NOW^XLFDT)
"RTN","C0CDA",305,0)
 E  D  ;
"RTN","C0CDA",306,0)
 . S PARM("endDateTime")=$$NOW^XLFDT
"RTN","C0CDA",307,0)
 N ZI,ZV S ZI=""
"RTN","C0CDA",308,0)
 F  S ZI=$O(VIS(ZI)) Q:ZI=""  S ZV(VIS(ZI,"date"),ZI)=""
"RTN","C0CDA",309,0)
 ;I $D(ZV(PARM("startDateTime"))) S RSP=0 Q RSP
"RTN","C0CDA",310,0)
 I $O(ZV(PARM("startDateTime")),-1)="" S RSP=0
"RTN","C0CDA",311,0)
 Q RSP
"RTN","C0CDA",312,0)
 ;
"RTN","C0CDA",313,0)
FMDATE(IDT) ; extrinsic that returns the fileman date. DT is in one of these forms:
"RTN","C0CDA",314,0)
 ; YYYYMMDD which is used by CDA documents and our parameters
"RTN","C0CDA",315,0)
 ; JAN 12,2011 or any valid fileman date
"RTN","C0CDA",316,0)
 N DT S DT=$P(IDT,".") ; date portion
"RTN","C0CDA",317,0)
 N DS S DS=$P(IDT,".",2) ; second portion
"RTN","C0CDA",318,0)
 N TY S TY=$E(DT,1,4)
"RTN","C0CDA",319,0)
 N RTN S RTN=-1
"RTN","C0CDA",320,0)
 I ((TY>1700)&(TY<3000)) D  Q RTN
"RTN","C0CDA",321,0)
 . N TM S TM=$E(DT,5,6)
"RTN","C0CDA",322,0)
 . N TD S TD=$E(DT,7,8)
"RTN","C0CDA",323,0)
 . N X,Y,DL
"RTN","C0CDA",324,0)
 . S DL=$L(DT) ; LENGTH OF DATE PROVIDED
"RTN","C0CDA",325,0)
 . S X=$S(DL=4:DT,DL=6:TM_"/"_TY,1:TM_"/"_TD_"/"_TY)
"RTN","C0CDA",326,0)
 . D ^%DT
"RTN","C0CDA",327,0)
 . S RTN=Y
"RTN","C0CDA",328,0)
 N X S X=DT
"RTN","C0CDA",329,0)
 D ^%DT
"RTN","C0CDA",330,0)
 S RTN=Y
"RTN","C0CDA",331,0)
 Q RTN
"RTN","C0CDA",332,0)
 ;
"RTN","C0CDA",333,0)
EXTENDIP(VIS,PARM,WHICH) ; extend the extraction date range for inpatient to include
"RTN","C0CDA",334,0)
 ; all days of a hospital stay, and optionally the immediately previous ER visit
"RTN","C0CDA",335,0)
 ; VIS is the array of visits passed by reference
"RTN","C0CDA",336,0)
 ; PARM is the parameter array passed by reference
"RTN","C0CDA",337,0)
 ; WHICH is the selected inpatient visit to extend, passed by value
"RTN","C0CDA",338,0)
 N STOP S STOP=0
"RTN","C0CDA",339,0)
 N ZJ S ZJ=WHICH
"RTN","C0CDA",340,0)
 F  S ZJ=$O(VIS(ZJ)) Q:STOP  Q:ZJ=""  D  
"RTN","C0CDA",341,0)
 . I $G(VIS(ZJ,"visitType"))'="inpatient" S STOP=1 ; no more inpatient days           
"RTN","C0CDA",342,0)
 . E  S PARM("startDateTime")=$G(VIS(ZJ,"startDateTime")) ; include this day          
"RTN","C0CDA",343,0)
 ;
"RTN","C0CDA",344,0)
 ; now check for whether to include the immediately previous ER visit in the extract
"RTN","C0CDA",345,0)
 ;
"RTN","C0CDA",346,0)
 I $G(PARM("INCLUDEPREVIOUSERVISIT"))=1 D  ; include previous ER visit                
"RTN","C0CDA",347,0)
 . N ZK
"RTN","C0CDA",348,0)
 . I ZJ="" S ZK=$O(VIS("AAAAAA"),-1)
"RTN","C0CDA",349,0)
 . E  S ZK=ZJ-1
"RTN","C0CDA",350,0)
 . I $G(VIS(ZK,"typeName"))="ER-EMERGENCY ROOM VISIT" D  ;                        
"RTN","C0CDA",351,0)
 . . S PARM("startDateTime")=$G(VIS(ZK,"startDateTime")) ; new start date  
"RTN","C0CDA",352,0)
 Q
"RTN","C0CDA",353,0)
 ;
"RTN","C0CDA",354,0)
TEST ;
"RTN","C0CDA",355,0)
 S DFN=$$PAT()
"RTN","C0CDA",356,0)
 N PARMS
"RTN","C0CDA",357,0)
 K DIR
"RTN","C0CDA",358,0)
 S DIR(0)="FO"
"RTN","C0CDA",359,0)
 S DIR("B")="select=latest&meds=filter1&log=1"
"RTN","C0CDA",360,0)
 S DUZ("L")="Enter parameters"
"RTN","C0CDA",361,0)
 D ^DIR
"RTN","C0CDA",362,0)
 ;S PARMS=$TR(Y,",","^")
"RTN","C0CDA",363,0)
 S PARMS=Y
"RTN","C0CDA",364,0)
 N C0LOG S C0LOG=1
"RTN","C0CDA",365,0)
 ;D CCDARPC(.CCDA,DFN,.PARMS)
"RTN","C0CDA",366,0)
 N FN
"RTN","C0CDA",367,0)
 S FN=$$CCDA(DFN,PARMS) ; 
"RTN","C0CDA",368,0)
 W !,FN
"RTN","C0CDA",369,0)
 I FN="no matching visits" Q  ;
"RTN","C0CDA",370,0)
 N C0LOGLOC S C0LOGLOC=$NA(^TMP("CCDA","GPL"))
"RTN","C0CDA",371,0)
 D BROWSE^DDBR(C0LOGLOC,"N","PATIENT "_DFN_" "_FN)
"RTN","C0CDA",372,0)
 Q
"RTN","C0CDA",373,0)
 ;
"RTN","C0CDA",374,0)
OUTCCDA(CCDA) ; write out a ccda xml file to the test directory
"RTN","C0CDA",375,0)
 N GF S GF=$$FMDTOUTC^C0CDACU($$NOW^XLFDT)_"-CCDA-"_DFN_".xml"
"RTN","C0CDA",376,0)
 S @CCDA@(0)=$O(@CCDA@(""),-1)
"RTN","C0CDA",377,0)
 N G2
"RTN","C0CDA",378,0)
 D MISSING^MXMLTMPL(CCDA,"G2")
"RTN","C0CDA",379,0)
 I $D(G2) D  ;
"RTN","C0CDA",380,0)
 . D:$G(C0LOG) OUTLOG^C0CDACU("MISSING VARIABLES")
"RTN","C0CDA",381,0)
 . N II S II=""
"RTN","C0CDA",382,0)
 . F  S II=$O(G2(II)) Q:II=""  D  ;
"RTN","C0CDA",383,0)
 . . D:$G(C0LOG) OUTLOG^C0CDACU(G2(II))
"RTN","C0CDA",384,0)
 K @CCDA@(0)
"RTN","C0CDA",385,0)
 N RSLT S RSLT=""
"RTN","C0CDA",386,0)
 I $$GTF^%ZISH($na(@CCDA@(1)),4,$$TESTDIR^C0CDACZ(),GF) D  ;
"RTN","C0CDA",387,0)
 . D:$G(C0LOG) OUTLOG^C0CDACU("CCDA "_GF_" WRITTEN TO: "_$$TESTDIR^C0CDACZ)
"RTN","C0CDA",388,0)
 . S RSLT=GF
"RTN","C0CDA",389,0)
 Q RSLT
"RTN","C0CDA",390,0)
 ;
"RTN","C0CDA",391,0)
PAT() ; extrinsic which returns a dfn from the patient selected
"RTN","C0CDA",392,0)
 S DIC=2,DIC(0)="AEMQ" D ^DIC
"RTN","C0CDA",393,0)
 I Y<1 Q  ; EXIT
"RTN","C0CDA",394,0)
 S DFN=$P(Y,U,1) ; SET THE PATIENT
"RTN","C0CDA",395,0)
 Q +Y
"RTN","C0CDA",396,0)
 ;
"RTN","C0CDA",397,0)
BCCDA1(TBL) ; BASIC CCDA - THIS TABLE LOADS ITSELF
"RTN","C0CDA",398,0)
 ;;HEADER,HEADER^C0CDAC2
"RTN","C0CDA",399,0)
 ;;ALGY,ALLERGY^C0CDAC8
"RTN","C0CDA",400,0)
 ;;ENC,ENC^C0CDACV
"RTN","C0CDA",401,0)
 ;;SOC,SOC^C0CDAC7
"RTN","C0CDA",402,0)
 ;;MEDS,MEDS^C0CDAC4
"RTN","C0CDA",403,0)
 ;;PROBLEMS,PROBLEMS^C0CDAC3
"RTN","C0CDA",404,0)
 ;;LABS,LABS^C0CDAC5
"RTN","C0CDA",405,0)
 ;;VITALS,VITALS^C0CDAC6
"RTN","C0CDA",406,0)
 N GTAG,GRT,GI
"RTN","C0CDA",407,0)
 S GTAG="BCCDA1"
"RTN","C0CDA",408,0)
 S GRT="C0CDAC0"
"RTN","C0CDA",409,0)
 N GN S GN=1
"RTN","C0CDA",410,0)
 F  S GI=GTAG_"+"_GN_"^"_GRT  Q:$T(@GI)'[";;"  D  ;
"RTN","C0CDA",411,0)
 . S TBL(GN)=$P($T(@GI),";;",2)
"RTN","C0CDA",412,0)
 . I $G(CCDADEBUG) W !,GN," ",TBL(GN)
"RTN","C0CDA",413,0)
 . S GN=GN+1
"RTN","C0CDA",414,0)
 Q
"RTN","C0CDA",415,0)
 ;
"RTN","C0CDA",416,0)
TLAST1 ;
"RTN","C0CDA",417,0)
 ;;</structuredBody>
"RTN","C0CDA",418,0)
 ;;</component>
"RTN","C0CDA",419,0)
 ;;</ClinicalDocument>
"RTN","C0CDA",420,0)
 Q
"RTN","C0CDA",421,0)
 ;
"RTN","C0CDAC0")
0^1^B276169562
"RTN","C0CDAC0",1,0)
C0CDAC0 ; GPL - Patient Portal - CCDA Routines ;9/18/13  17:05
"RTN","C0CDAC0",2,0)
 ;;0.1;C0CDA;nopatch;noreleasedate;Build 1
"RTN","C0CDAC0",3,0)
 ;
"RTN","C0CDAC0",4,0)
 ; License AGPL v3.0
"RTN","C0CDAC0",5,0)
 ; 
"RTN","C0CDAC0",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDAC0",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDAC0",8,0)
 ;
"RTN","C0CDAC0",9,0)
 Q
"RTN","C0CDAC0",10,0)
 ;
"RTN","C0CDAC0",11,0)
 ; This is the main entry point for the CCDA generation routines
"RTN","C0CDAC0",12,0)
 ;
"RTN","C0CDAC0",13,0)
CCDARPC(RTN,DFN,PARMS) ; generates a CCDA document for patient DFN
"RTN","C0CDAC0",14,0)
 ; RTN is passed by reference
"RTN","C0CDAC0",15,0)
 ; PARMS are parameters that govern the output of form: parm1:value1^parm2:value2 etc.
"RTN","C0CDAC0",16,0)
 ;   SELECT:LATEST will generate a ccda for the latest encounter
"RTN","C0CDAC0",17,0)
 ;   SELECT:date will generate a ccda for the encounter on the date
"RTN","C0CDAC0",18,0)
 ;
"RTN","C0CDAC0",19,0)
 N C0BCRTL,C0BLDBLD,C0BUILD,C0WRK,C0TBL,C0PARMS,C0LOG,C0LOGLOC
"RTN","C0CDAC0",20,0)
 ;
"RTN","C0CDAC0",21,0)
 ; create a work area for processing and clear it
"RTN","C0CDAC0",22,0)
 ;
"RTN","C0CDAC0",23,0)
 ;astro gpl
"RTN","C0CDAC0",24,0)
 D INITMAPS^KBAIQLDM ; make sure maps are initialized
"RTN","C0CDAC0",25,0)
 ; end astro gpl
"RTN","C0CDAC0",26,0)
 S C0WRK=$NA(^TMP("CCDA",$J)) ; work area root for entire process
"RTN","C0CDAC0",27,0)
 K @C0WRK ; make sure it is clear to begin
"RTN","C0CDAC0",28,0)
 S C0BCTRL=$NA(@C0WRK@("CTRL"))
"RTN","C0CDAC0",29,0)
 S @C0BCTRL@("PARMS")=""
"RTN","C0CDAC0",30,0)
 I $D(PARMS) M @C0BCTRL@("PARMS")=PARMS ; parameters for all processes to use
"RTN","C0CDAC0",31,0)
 S C0LOG=$G(PARMS("LOG")) ; produce a log of the extract: LOG:1
"RTN","C0CDAC0",32,0)
 I C0LOG["YES" S C0LOG=1 ; yes means 1
"RTN","C0CDAC0",33,0)
 S C0LOGLOC=$NA(@C0WRK@("LOG"))
"RTN","C0CDAC0",34,0)
 D:C0LOG  ;
"RTN","C0CDAC0",35,0)
 . D OUTLOG^C0CDACU("DFN: "_DFN_" "_$P(^DPT(DFN,0),"^",1))
"RTN","C0CDAC0",36,0)
 . N II S II=""
"RTN","C0CDAC0",37,0)
 . F  S II=$O(PARMS(II)) Q:II=""  D OUTLOG^C0CDACU("PARMS("_II_")="_PARMS(II))
"RTN","C0CDAC0",38,0)
 S C0BLDBLD=$NA(@C0BCTRL@("BLDBLD")) ; build list of build lists
"RTN","C0CDAC0",39,0)
 S @C0BLDBLD@("DFN")=DFN
"RTN","C0CDAC0",40,0)
 S @C0BLDBLD@("START-TIME")=$$NOW^XLFDT
"RTN","C0CDAC0",41,0)
 ;
"RTN","C0CDAC0",42,0)
 ; build a table of the processing order and routines to call
"RTN","C0CDAC0",43,0)
 ;
"RTN","C0CDAC0",44,0)
 D BTBL(.C0TBL,"BCCDA1^C0CDAC0") ; build the table of what to process
"RTN","C0CDAC0",45,0)
 ;D BTBL(.C0TBL,"BCCDA2^C0CDAC0") ; build the table of what to process
"RTN","C0CDAC0",46,0)
 ;
"RTN","C0CDAC0",47,0)
 ; set up control blocks and work areas for each build component
"RTN","C0CDAC0",48,0)
 ;
"RTN","C0CDAC0",49,0)
 N C0I
"RTN","C0CDAC0",50,0)
 F C0I=1:1:C0TBL(0) D  ;
"RTN","C0CDAC0",51,0)
 . N C0KEY,C0RT
"RTN","C0CDAC0",52,0)
 . S C0KEY=$P(C0TBL(C0I),",",1)
"RTN","C0CDAC0",53,0)
 . S C0RT=$P(C0TBL(C0I),",",2)
"RTN","C0CDAC0",54,0)
 . S C0BUILD=$NA(@C0WRK@("BUILD",C0KEY))
"RTN","C0CDAC0",55,0)
 . S @C0BLDBLD@(C0I)=C0BUILD
"RTN","C0CDAC0",56,0)
 . S @C0BLDBLD@(0)=C0I
"RTN","C0CDAC0",57,0)
 . S @C0BCTRL@("ORDER",C0I)=C0KEY
"RTN","C0CDAC0",58,0)
 . S @C0BCTRL@("ORDER",0)=C0I
"RTN","C0CDAC0",59,0)
 . S @C0BCTRL@(C0KEY,"ROUTINE")=C0RT
"RTN","C0CDAC0",60,0)
 . S @C0BCTRL@(C0KEY,"STATUS")="INIT" ; section is intialized
"RTN","C0CDAC0",61,0)
 . S @C0BCTRL@(C0KEY,"INIT-TIME")=$$NOW^XLFDT
"RTN","C0CDAC0",62,0)
 . S @C0BCTRL@(C0KEY,"BUILD-LIST")=C0BUILD
"RTN","C0CDAC0",63,0)
 . S @C0BCTRL@(C0KEY,"WORK-AREA")=$NA(@C0WRK@(C0KEY))
"RTN","C0CDAC0",64,0)
 D:$G(C0DEBUG) GTREE^KBAIVPR(C0BCTRL)
"RTN","C0CDAC0",65,0)
 ;
"RTN","C0CDAC0",66,0)
 ; the rest of the processing can be done from the C0BLDBLD table,
"RTN","C0CDAC0",67,0)
 ;  which contains the routine to call and the work area that returns
"RTN","C0CDAC0",68,0)
 ;  the result
"RTN","C0CDAC0",69,0)
 ; 
"RTN","C0CDAC0",70,0)
 ; at this point, we can spawn new taskman tasks to extract and build
"RTN","C0CDAC0",71,0)
 ;  all of the components of the document in parallel. in fact, we
"RTN","C0CDAC0",72,0)
 ;  could launch a parent task to spawn all of that work and use this
"RTN","C0CDAC0",73,0)
 ;  routine to monitor progress and return the final result when done. 
"RTN","C0CDAC0",74,0)
 ; 
"RTN","C0CDAC0",75,0)
 ; initially, we are going to process everything sequentially without
"RTN","C0CDAC0",76,0)
 ;  without using taskman
"RTN","C0CDAC0",77,0)
 ;
"RTN","C0CDAC0",78,0)
 N ERROR S ERROR=""
"RTN","C0CDAC0",79,0)
 F C0I=1:1:@C0BCTRL@("ORDER",0) Q:$G(ERROR)'=""  D  ; for each component to be built
"RTN","C0CDAC0",80,0)
 . N C0KEY,C0BLD,C0RT,C0AREA,C0X,C0REPORT
"RTN","C0CDAC0",81,0)
 . S C0KEY=@C0BCTRL@("ORDER",C0I)
"RTN","C0CDAC0",82,0)
 . S C0BLD=@C0BCTRL@(C0KEY,"BUILD-LIST")
"RTN","C0CDAC0",83,0)
 . S C0RT=@C0BCTRL@(C0KEY,"ROUTINE")
"RTN","C0CDAC0",84,0)
 . S C0REPORT=$NA(@C0BCTRL@(C0KEY))
"RTN","C0CDAC0",85,0)
 . S C0AREA=@C0BCTRL@(C0KEY,"WORK-AREA")
"RTN","C0CDAC0",86,0)
 . S C0X="D "_C0RT_"(C0BLD,DFN,C0AREA,C0REPORT,C0BCTRL)"
"RTN","C0CDAC0",87,0)
 . D:C0LOG OUTLOG^C0CDACU("RUNNING "_C0X)
"RTN","C0CDAC0",88,0)
 . X C0X
"RTN","C0CDAC0",89,0)
 . I $G(@C0BCTRL@("PARMS","error"))'="" D  Q  ;
"RTN","C0CDAC0",90,0)
 . . S ERROR=1
"RTN","C0CDAC0",91,0)
 . . S PARMS("error")=$G(@C0BCTRL@("PARMS","error"))
"RTN","C0CDAC0",92,0)
 Q:ERROR
"RTN","C0CDAC0",93,0)
 N LAST1 S LAST1=$NA(@C0WRK@("LAST1"))
"RTN","C0CDAC0",94,0)
 D GET^C0CDACU(LAST1,"TLAST1^C0CDAC0")
"RTN","C0CDAC0",95,0)
 N C0BLIST S C0BLIST=$NA(@C0WRK@("BUILD","C0BLIST"))
"RTN","C0CDAC0",96,0)
 D QUEUE^MXMLTMPL(C0BLIST,LAST1,1,@LAST1@(0))
"RTN","C0CDAC0",97,0)
 D ADDTO(C0BLDBLD,C0BLIST)
"RTN","C0CDAC0",98,0)
 D:$G(C0DEBUG) GTREE^KBAIVPR(C0WRK,9)
"RTN","C0CDAC0",99,0)
 D BUILDM(C0BLDBLD,.RTN)
"RTN","C0CDAC0",100,0)
 Q
"RTN","C0CDAC0",101,0)
 ;
"RTN","C0CDAC0",102,0)
BTBL(TBL,INTAG) ; build table TBL of processing order passed by reference 
"RTN","C0CDAC0",103,0)
 ; INTAG is the name of a tag that stores the table ie. BCCDA1^C0CDAC0
"RTN","C0CDAC0",104,0)
 N GTAG,GRT,GI
"RTN","C0CDAC0",105,0)
 S GTAG=$P(INTAG,"^",1)
"RTN","C0CDAC0",106,0)
 S GRT=$P(INTAG,"^",2)
"RTN","C0CDAC0",107,0)
 N GN S GN=1
"RTN","C0CDAC0",108,0)
 F  S GI=GTAG_"+"_GN_"^"_GRT  Q:$T(@GI)'[";;"  D  ;
"RTN","C0CDAC0",109,0)
 . S TBL(GN)=$P($T(@GI),";;",2)
"RTN","C0CDAC0",110,0)
 . S TBL(0)=GN
"RTN","C0CDAC0",111,0)
 . I $G(CCDADEBUG) W !,GN," ",TBL(GN)
"RTN","C0CDAC0",112,0)
 . S GN=GN+1
"RTN","C0CDAC0",113,0)
 Q
"RTN","C0CDAC0",114,0)
 ;
"RTN","C0CDAC0",115,0)
BUILDM(BBLIST,OUTXML) ; process a build list of build lists to generate xml
"RTN","C0CDAC0",116,0)
 ; both BBLIST and OUTXML are passed by name
"RTN","C0CDAC0",117,0)
 ;
"RTN","C0CDAC0",118,0)
 N BIGLIST,C0I,C0J,C0N
"RTN","C0CDAC0",119,0)
 S C0N=0
"RTN","C0CDAC0",120,0)
 F C0I=1:1:@BBLIST@(0) D  ;
"RTN","C0CDAC0",121,0)
 . N BLIST
"RTN","C0CDAC0",122,0)
 . S BLIST=@BBLIST@(C0I) ; build list
"RTN","C0CDAC0",123,0)
 . I '$D(@BLIST) Q  ;
"RTN","C0CDAC0",124,0)
 . F C0J=1:1:@BLIST@(0) D  ;
"RTN","C0CDAC0",125,0)
 . . S C0N=C0N+1
"RTN","C0CDAC0",126,0)
 . . S BIGLIST(C0N)=@BLIST@(C0J)
"RTN","C0CDAC0",127,0)
 . . S BIGLIST(0)=C0N
"RTN","C0CDAC0",128,0)
 I $G(OUTXML)="" S OUTXML=$NA(@C0WRK@("XML")) ; gpl let the caller say where
"RTN","C0CDAC0",129,0)
 K @OUTXML
"RTN","C0CDAC0",130,0)
 D BUILD^MXMLTMPL("BIGLIST",OUTXML)
"RTN","C0CDAC0",131,0)
 K @OUTXML@(0)
"RTN","C0CDAC0",132,0)
 Q
"RTN","C0CDAC0",133,0)
 ;
"RTN","C0CDAC0",134,0)
ADDTO(DEST,WHAT) ; adds string WHAT to list DEST 
"RTN","C0CDAC0",135,0)
 ; DEST is passed by name
"RTN","C0CDAC0",136,0)
 N GN
"RTN","C0CDAC0",137,0)
 S GN=$O(@DEST@("AAAAAA"),-1)+1
"RTN","C0CDAC0",138,0)
 S @DEST@(GN)=WHAT
"RTN","C0CDAC0",139,0)
 S @DEST@(0)=GN ; count
"RTN","C0CDAC0",140,0)
 Q
"RTN","C0CDAC0",141,0)
 ;
"RTN","C0CDAC0",142,0)
CCDA(DFN,PARMS,sessid) ; extrinsic to create a ccda and return the filename
"RTN","C0CDAC0",143,0)
 ; PARMS is parameter string format: parm1=val1&parm2=val2&parm3=val3
"RTN","C0CDAC0",144,0)
 ; ignore sessid for now
"RTN","C0CDAC0",145,0)
 ;
"RTN","C0CDAC0",146,0)
 I '$D(^DPT(DFN)) D  Q ""
"RTN","C0CDAC0",147,0)
 . S PARMS("error")="Invalid patient "_DFN
"RTN","C0CDAC0",148,0)
 I '$D(DUZ) D  Q ""
"RTN","C0CDAC0",149,0)
 . S PARMS("error")="DUZ not set"
"RTN","C0CDAC0",150,0)
 I '$D(PARMS) S PARMS=""
"RTN","C0CDAC0",151,0)
 N PARM
"RTN","C0CDAC0",152,0)
 ; defaults
"RTN","C0CDAC0",153,0)
 S PARM("DUZ")=1
"RTN","C0CDAC0",154,0)
 S PARM("SELECT")="ALL"
"RTN","C0CDAC0",155,0)
 S PARM("LOG")=1
"RTN","C0CDAC0",156,0)
 S PARM("MEDS")="FILTER1"
"RTN","C0CDAC0",157,0)
 D PRSPARMS(.PARMS,.PARM) ; parse incoming parms and overlay on defaults
"RTN","C0CDAC0",158,0)
 N SEL S SEL=$$FILTERV(.PARM,DFN)
"RTN","C0CDAC0",159,0)
 I 'SEL D  Q "" ;
"RTN","C0CDAC0",160,0)
 . S PARMS("error")="no matching visits"
"RTN","C0CDAC0",161,0)
 D LOGARY^C0CDACU("PARM") ; log the parm array
"RTN","C0CDAC0",162,0)
 N C0LOG S C0LOG=1
"RTN","C0CDAC0",163,0)
 D CCDARPC(.CCDA,DFN,.PARM)
"RTN","C0CDAC0",164,0)
 I $G(PARM("error"))'="" D  Q "" ;
"RTN","C0CDAC0",165,0)
 . S PARMS("error")=$G(PARM("error"))
"RTN","C0CDAC0",166,0)
 N FN
"RTN","C0CDAC0",167,0)
 S FN=$$OUTCCDA(CCDA) ; 
"RTN","C0CDAC0",168,0)
 ;N C0LOGLOC S C0LOGLOC=$NA(^TMP("CCDA",$J,"LOG"))
"RTN","C0CDAC0",169,0)
 ;D BROWSE^DDBR(C0LOGLOC,"N","PATIENT "_DFN_" "_FN)
"RTN","C0CDAC0",170,0)
 K ^TMP("CCDA","GPL")
"RTN","C0CDAC0",171,0)
 M ^TMP("CCDA","GPL")=^TMP("CCDA",$J,"LOG")
"RTN","C0CDAC0",172,0)
 K ^TMP("CCDA",$J) ; clean up
"RTN","C0CDAC0",173,0)
 K C0BCTRL,C0DATE2,C0LOGLOC,CCDA,CV,GN,ORDIALOG,JJOHDID
"RTN","C0CDAC0",174,0)
 K ^TMP("MXMLDOM",$J)
"RTN","C0CDAC0",175,0)
 Q FN
"RTN","C0CDAC0",176,0)
 ;
"RTN","C0CDAC0",177,0)
PRSPARMS(PSTR,PARY) ; parse parms into array
"RTN","C0CDAC0",178,0)
 N DATTYP D DATATYPE(.DATTYP)
"RTN","C0CDAC0",179,0)
 I $G(PSTR)="" Q  ;
"RTN","C0CDAC0",180,0)
 I PSTR["=" D  ;
"RTN","C0CDAC0",181,0)
 . N P1,P2,P3,P4,P5
"RTN","C0CDAC0",182,0)
 . S P2=$L(PSTR,"&")
"RTN","C0CDAC0",183,0)
 . F P1=1:1:P2 D  ;
"RTN","C0CDAC0",184,0)
 . . S P3=$P(PSTR,"&",P1)
"RTN","C0CDAC0",185,0)
 . . S X=$P(P3,"=",1)
"RTN","C0CDAC0",186,0)
 . . X ^%ZOSF("UPPERCASE")
"RTN","C0CDAC0",187,0)
 . . S P4=Y
"RTN","C0CDAC0",188,0)
 . . S X=$P(P3,"=",2)
"RTN","C0CDAC0",189,0)
 . . I $G(DATTYP(P4))'="" S PARY(P4)=X ;
"RTN","C0CDAC0",190,0)
 . . E  D  ;
"RTN","C0CDAC0",191,0)
 . . . X ^%ZOSF("UPPERCASE")
"RTN","C0CDAC0",192,0)
 . . . S P5=Y
"RTN","C0CDAC0",193,0)
 . . . S PARY(P4)=P5
"RTN","C0CDAC0",194,0)
 D RDCTPRM(.PARM) ; further parse the REDACT parameters
"RTN","C0CDAC0",195,0)
 ;D RDCTPRM(.PARY) ; further parse the REDACT parameters
"RTN","C0CDAC0",196,0)
 Q
"RTN","C0CDAC0",197,0)
 ;
"RTN","C0CDAC0",198,0)
DATATYPE(DATATYPE) ; passes back a datatype array for parameters
"RTN","C0CDAC0",199,0)
 S DATATYPE("REASONFORVISIT")="text"
"RTN","C0CDAC0",200,0)
 S DATATYPE("PLANOFCARE")="text"
"RTN","C0CDAC0",201,0)
 S DATATYPE("REASONFORREFERRAL")="text"
"RTN","C0CDAC0",202,0)
 S DATATYPE("FUNCTIONALSTATUS")="text"
"RTN","C0CDAC0",203,0)
 S DATATYPE("ADVANCEDIRECTIVES")="text"
"RTN","C0CDAC0",204,0)
 S DATATYPE("INSTRUCTIONS")="text"
"RTN","C0CDAC0",205,0)
 S DATATYPE("FAMILYHISTORY")="text"
"RTN","C0CDAC0",206,0)
 S DATATYPE("ENCOUNTER")="uri"
"RTN","C0CDAC0",207,0)
 Q
"RTN","C0CDAC0",208,0)
 ;
"RTN","C0CDAC0",209,0)
RDCTPRM(PARM) ; used by PRSPARMS to further parse the REDACT parameter
"RTN","C0CDAC0",210,0)
 ; which has the format REDACT:uri1,uri2,uri3... Here's the result:
"RTN","C0CDAC0",211,0)
 ;G("REDACT")="1,2,3,4,5,6,7"
"RTN","C0CDAC0",212,0)
 ;G("REDACT",1)=1
"RTN","C0CDAC0",213,0)
 ;G("REDACT",2)=1
"RTN","C0CDAC0",214,0)
 ;G("REDACT",3)=1
"RTN","C0CDAC0",215,0)
 ;G("REDACT",4)=1
"RTN","C0CDAC0",216,0)
 ;G("REDACT",5)=1
"RTN","C0CDAC0",217,0)
 ;G("REDACT",6)=1
"RTN","C0CDAC0",218,0)
 ;G("REDACT",7)=1
"RTN","C0CDAC0",219,0)
 I '$D(PARM("REDACT")) Q  ;
"RTN","C0CDAC0",220,0)
 N Y S Y=PARM("REDACT")
"RTN","C0CDAC0",221,0)
 I Y="" Q
"RTN","C0CDAC0",222,0)
 N X S X=$L(Y,",")
"RTN","C0CDAC0",223,0)
 I X=1 S PARM("REDACT",Y)=1 Q  ;
"RTN","C0CDAC0",224,0)
 N Z
"RTN","C0CDAC0",225,0)
 F Z=1:1:X S PARM("REDACT",$P(Y,",",Z))=1 
"RTN","C0CDAC0",226,0)
 Q
"RTN","C0CDAC0",227,0)
 ;
"RTN","C0CDAC0",228,0)
UPPARM(ZPARM) ; ZPARM IS THE PARM ARRAY PASSED BY REFERENCE
"RTN","C0CDAC0",229,0)
 ; ALL ELEMENTS ARE MADE UPPERCASE FOR EASIER PROCESSING
"RTN","C0CDAC0",230,0)
 N DATTYP D DATATYPE(.DATTYP)
"RTN","C0CDAC0",231,0)
 N ZX S ZX=""
"RTN","C0CDAC0",232,0)
 F  S ZX=$O(ZPARM(ZX)) Q:ZX=""  D  ;
"RTN","C0CDAC0",233,0)
 . N X
"RTN","C0CDAC0",234,0)
 . S X=ZX
"RTN","C0CDAC0",235,0)
 . X ^%ZOSF("UPPERCASE")
"RTN","C0CDAC0",236,0)
 . S ZPARM(Y)=ZPARM(ZX)
"RTN","C0CDAC0",237,0)
 . I $G(DATTYP(Y))="" D  ; uppercase the value
"RTN","C0CDAC0",238,0)
 . . N ZV S ZV=Y
"RTN","C0CDAC0",239,0)
 . . N X,Y
"RTN","C0CDAC0",240,0)
 . . S X=ZPARM(ZX)
"RTN","C0CDAC0",241,0)
 . . X ^%ZOSF("UPPERCASE")
"RTN","C0CDAC0",242,0)
 . . S ZPARM(ZV)=Y
"RTN","C0CDAC0",243,0)
 Q
"RTN","C0CDAC0",244,0)
 ;
"RTN","C0CDAC0",245,0)
FILTERV(PARM,DFN) ; modify the Parm array to select the visits to be extracted. 
"RTN","C0CDAC0",246,0)
 ; PARM is passed by ref
"RTN","C0CDAC0",247,0)
 D UPPARM(.PARM)
"RTN","C0CDAC0",248,0)
 N VIS
"RTN","C0CDAC0",249,0)
 D VISITS^C0CDACV(.VIS,DFN)
"RTN","C0CDAC0",250,0)
 I $O(VIS(""))="" Q 0 ; no matching visits
"RTN","C0CDAC0",251,0)
 N EKEYS ; table of valid select commands (all others are dates)
"RTN","C0CDAC0",252,0)
 S EKEYS("LATEST")=""
"RTN","C0CDAC0",253,0)
 S EKEYS("LATESTOP")=""
"RTN","C0CDAC0",254,0)
 S EKEYS("LATESTIP")=""
"RTN","C0CDAC0",255,0)
 S EKEYS("ALL")=""
"RTN","C0CDAC0",256,0)
 N RSLT S RSLT=0
"RTN","C0CDAC0",257,0)
 ;I $G(PARM("STARTDATERANGE"))'="" D  Q RSLT ;
"RTN","C0CDAC0",258,0)
 N SEL S SEL=$G(PARM("SELECT"))
"RTN","C0CDAC0",259,0)
 I SEL="" I $G(PARM("ENCOUNTER"))="" S SEL="ALL" S PARM("SELECT")="ALL"
"RTN","C0CDAC0",260,0)
 I $G(PARM("ENCOUNTER"))'="" S SEL="" S PARM("SELECT")=""
"RTN","C0CDAC0",261,0)
 ;S RSLT=$$DODATES(.VIS,.PARM) ; establish effective dates for header
"RTN","C0CDAC0",262,0)
 S PARM("date")=$G(VIS(1,"date")) ; best discharge date is the latest visit date
"RTN","C0CDAC0",263,0)
 I '$D(EKEYS(SEL)) D  Q RSLT ;
"RTN","C0CDAC0",264,0)
 . S RSLT=$$DODATES(.VIS,.PARM)
"RTN","C0CDAC0",265,0)
 I $G(PARM("SELECT"))="LATEST" D  Q 1 ;
"RTN","C0CDAC0",266,0)
 . M PARM=VIS(1)
"RTN","C0CDAC0",267,0)
 . I VIS(1,"visitType")="inpatient" D EXTENDIP(.VIS,.PARM,1)
"RTN","C0CDAC0",268,0)
 S RSLT=0
"RTN","C0CDAC0",269,0)
 I $G(PARM("SELECT"))="LATESTOP" D  Q RSLT ;
"RTN","C0CDAC0",270,0)
 . N ZI S ZI=""
"RTN","C0CDAC0",271,0)
 . N DONE S DONE=0
"RTN","C0CDAC0",272,0)
 . F  S ZI=$O(VIS(ZI)) Q:DONE  Q:ZI=""  D  ;
"RTN","C0CDAC0",273,0)
 . . I VIS(ZI,"visitType")="outpatient" D  ;
"RTN","C0CDAC0",274,0)
 . . . S RSLT=1
"RTN","C0CDAC0",275,0)
 . . . S DONE=1
"RTN","C0CDAC0",276,0)
 . . . M PARM=VIS(ZI)
"RTN","C0CDAC0",277,0)
 S RSLT=0
"RTN","C0CDAC0",278,0)
 I $G(PARM("SELECT"))="LATESTIP" D  Q RSLT ;
"RTN","C0CDAC0",279,0)
 . N ZI S ZI=""
"RTN","C0CDAC0",280,0)
 . N DONE S DONE=0
"RTN","C0CDAC0",281,0)
 . F  S ZI=$O(VIS(ZI)) Q:DONE  Q:ZI=""  D  ;
"RTN","C0CDAC0",282,0)
 . . I $G(VIS(ZI,"visitType"))="" S DONE=1 Q  ;
"RTN","C0CDAC0",283,0)
 . . I VIS(ZI,"visitType")="inpatient" D  ;
"RTN","C0CDAC0",284,0)
 . . . S RSLT=1
"RTN","C0CDAC0",285,0)
 . . . S DONE=1
"RTN","C0CDAC0",286,0)
 . . . M PARM=VIS(ZI) ; will be used for endDateTime for multi day stays
"RTN","C0CDAC0",287,0)
 . . . D EXTENDIP(.VIS,.PARM,ZI) ; extend the date range to the whole hospital stay
"RTN","C0CDAC0",288,0)
 Q 1
"RTN","C0CDAC0",289,0)
 ;
"RTN","C0CDAC0",290,0)
DODATES(VIS,PARM) ; extrinsic which handles paramaters which include
"RTN","C0CDAC0",291,0)
 ; startDateRange:xxxx
"RTN","C0CDAC0",292,0)
 N RSP S RSP=1
"RTN","C0CDAC0",293,0)
 N ENCURI S ENCURI=$G(PARM("ENCOUNTER")) ; selection by encounter URI
"RTN","C0CDAC0",294,0)
 I ENCURI'="" D  ;
"RTN","C0CDAC0",295,0)
 . N ENCVISIT ; visit pointed to by the uri
"RTN","C0CDAC0",296,0)
 . S ENCVISIT=$O(VIS("URI",ENCURI,""))
"RTN","C0CDAC0",297,0)
 . I ENCVISIT="" D  Q  ; oops not found
"RTN","C0CDAC0",298,0)
 . . D OUTLOG^C0CDACU(ENCURI_" NOT FOUND")
"RTN","C0CDAC0",299,0)
 . S PARM("startDateTime")=VIS(ENCVISIT,"startDateTime")
"RTN","C0CDAC0",300,0)
 . S PARM("endDateTime")=$G(VIS(ENCVISIT,"endDateTime"),VIS(ENCVISIT,"startDateTime")) ;
"RTN","C0CDAC0",301,0)
 I $G(PARM("startDateTime"))="" D  ; not requested by uri
"RTN","C0CDAC0",302,0)
 . N SEL S SEL=$G(PARM("SELECT"))
"RTN","C0CDAC0",303,0)
 . I SEL="" S RSP=0
"RTN","C0CDAC0",304,0)
 . S PARM("STARTDATERANGE")=$P(SEL,":",1)
"RTN","C0CDAC0",305,0)
 . S PARM("ENDDATERANGE")=$P(SEL,":",2)
"RTN","C0CDAC0",306,0)
 . ;I PARM("ENDDATERANGE")="" S PARM("ENDDATERANGE")="T"
"RTN","C0CDAC0",307,0)
 . ;I PARM("ENDDATERANGE")="" S PARM("ENDDATERANGE")=PARM("STARTDATERANGE")
"RTN","C0CDAC0",308,0)
 . N SX,EX ; start X and end X
"RTN","C0CDAC0",309,0)
 . S SX=$$FMDATE($G(PARM("STARTDATERANGE")))
"RTN","C0CDAC0",310,0)
 . I SX>-1 S PARM("startDateTime")=SX
"RTN","C0CDAC0",311,0)
 . E  S RSP=0 Q
"RTN","C0CDAC0",312,0)
 . N YEAR,MONTH,DAY,NEXT
"RTN","C0CDAC0",313,0)
 . I $L(SX)'=7 Q  ; YYYMMDD
"RTN","C0CDAC0",314,0)
 . S YEAR=$E(SX,1,3)
"RTN","C0CDAC0",315,0)
 . S MONTH=$E(SX,4,5)
"RTN","C0CDAC0",316,0)
 . S DAY=$E(SX,6,7)
"RTN","C0CDAC0",317,0)
 . I MONTH="00" S NEXT=YEAR+1_MONTH_DAY ; add one year
"RTN","C0CDAC0",318,0)
 . E  I DAY="00" D  ;
"RTN","C0CDAC0",319,0)
 . . I MONTH=12 S NEXT=YEAR+1_"01"_DAY
"RTN","C0CDAC0",320,0)
 . . E  S NEXT=YEAR_MONTH+1_DAY
"RTN","C0CDAC0",321,0)
 . . S NEXT=$$FMADD^XLFDT(NEXT,-3,0,0) ; subtract 3 days to get end of month
"RTN","C0CDAC0",322,0)
 . I '$D(NEXT) S NEXT=SX ;$$FMADD^XLFDT(SX,1,0,0) ; add one day
"RTN","C0CDAC0",323,0)
 . I $G(DEBUG)=1 S PARM("NEXT")=NEXT
"RTN","C0CDAC0",324,0)
 . I $G(PARM("ENDDATERANGE"))="" S PARM("ENDDATERANGE")=$$FMTE^XLFDT(NEXT)
"RTN","C0CDAC0",325,0)
 . S EX=$$FMDATE($G(PARM("ENDDATERANGE")))
"RTN","C0CDAC0",326,0)
 . I EX>-1 S PARM("endDateTime")=$S(EX>=PARM("startDateTime"):EX,1:$$NOW^XLFDT)
"RTN","C0CDAC0",327,0)
 . E  D  ;
"RTN","C0CDAC0",328,0)
 . . S PARM("endDateTime")=$$NOW^XLFDT
"RTN","C0CDAC0",329,0)
 . . S RSP=1
"RTN","C0CDAC0",330,0)
 I RSP=0 Q RSP
"RTN","C0CDAC0",331,0)
 ;
"RTN","C0CDAC0",332,0)
 ; Handle selection by month or year
"RTN","C0CDAC0",333,0)
 ;
"RTN","C0CDAC0",334,0)
 I PARM("startDateTime")=PARM("endDateTime") D  ;
"RTN","C0CDAC0",335,0)
 . ;
"RTN","C0CDAC0",336,0)
 ;
"RTN","C0CDAC0",337,0)
 S PARM("endDateTime")=$$FMADD^XLFDT(PARM("endDateTime"),2,0,0,0)
"RTN","C0CDAC0",338,0)
 ; add two days to the 
"RTN","C0CDAC0",339,0)
 ; end date of the range -- to allow time for lab and vital entries
"RTN","C0CDAC0",340,0)
 ;
"RTN","C0CDAC0",341,0)
 ; move the endDateTime to encompass the period between visits to get labs and vitals
"RTN","C0CDAC0",342,0)
 ;
"RTN","C0CDAC0",343,0)
 N ZG
"RTN","C0CDAC0",344,0)
 S ZG=$O(VIS("DATE",PARM("endDateTime")))
"RTN","C0CDAC0",345,0)
 I ZG'="" S PARM("endDateTime")=ZG ; the next visit
"RTN","C0CDAC0",346,0)
 ;N ZI,ZV S ZI=""
"RTN","C0CDAC0",347,0)
 ;F  S ZI=$O(VIS(ZI)) Q:ZI=""  S ZV(VIS(ZI,"date"),ZI)=""
"RTN","C0CDAC0",348,0)
 ;I $D(ZV(PARM("startDateTime"))) S RSP=0 Q RSP
"RTN","C0CDAC0",349,0)
 ;I $O(VIS("DATE",(PARM("startDateTime"))),-1)="" S RSP=0
"RTN","C0CDAC0",350,0)
 I $O(VIS("DATE",(PARM("startDateTime"))))="" S RSP=0
"RTN","C0CDAC0",351,0)
 I $G(DEBUG) ZWR PARM ZWR VIS W !,"RSP=",RSP
"RTN","C0CDAC0",352,0)
 Q RSP
"RTN","C0CDAC0",353,0)
 ;
"RTN","C0CDAC0",354,0)
FMDATE(IDT) ; extrinsic that returns the fileman date. DT is in one of these forms:
"RTN","C0CDAC0",355,0)
 ; YYYYMMDD which is used by CDA documents and our parameters
"RTN","C0CDAC0",356,0)
 ; JAN 12,2011 or any valid fileman date
"RTN","C0CDAC0",357,0)
 N DT S DT=$P(IDT,".") ; date portion
"RTN","C0CDAC0",358,0)
 N DS S DS=$P(IDT,".",2) ; second portion
"RTN","C0CDAC0",359,0)
 N TY S TY=$E(DT,1,4)
"RTN","C0CDAC0",360,0)
 N RTN S RTN=-1
"RTN","C0CDAC0",361,0)
 I ((TY>1700)&(TY<3000)) D  Q RTN
"RTN","C0CDAC0",362,0)
 . N TM S TM=$E(DT,5,6)
"RTN","C0CDAC0",363,0)
 . N TD S TD=$E(DT,7,8)
"RTN","C0CDAC0",364,0)
 . N X,Y,DL
"RTN","C0CDAC0",365,0)
 . S DL=$L(DT) ; LENGTH OF DATE PROVIDED
"RTN","C0CDAC0",366,0)
 . S X=$S(DL=4:DT,DL=6:TM_"/"_TY,1:TM_"/"_TD_"/"_TY)
"RTN","C0CDAC0",367,0)
 . D ^%DT
"RTN","C0CDAC0",368,0)
 . S RTN=Y
"RTN","C0CDAC0",369,0)
 N X S X=DT
"RTN","C0CDAC0",370,0)
 D ^%DT
"RTN","C0CDAC0",371,0)
 S RTN=Y
"RTN","C0CDAC0",372,0)
 Q RTN
"RTN","C0CDAC0",373,0)
 ;
"RTN","C0CDAC0",374,0)
EXTENDIP(VIS,PARM,WHICH) ; extend the extraction date range for inpatient to include
"RTN","C0CDAC0",375,0)
 ; all days of a hospital stay, and optionally the immediately previous ER visit
"RTN","C0CDAC0",376,0)
 ; VIS is the array of visits passed by reference
"RTN","C0CDAC0",377,0)
 ; PARM is the parameter array passed by reference
"RTN","C0CDAC0",378,0)
 ; WHICH is the selected inpatient visit to extend, passed by value
"RTN","C0CDAC0",379,0)
 N STOP S STOP=0
"RTN","C0CDAC0",380,0)
 N ZJ S ZJ=WHICH
"RTN","C0CDAC0",381,0)
 F  S ZJ=$O(VIS(ZJ)) Q:STOP  Q:ZJ=""  D  
"RTN","C0CDAC0",382,0)
 . I $G(VIS(ZJ,"visitType"))'="inpatient" S STOP=1 ; no more inpatient days           
"RTN","C0CDAC0",383,0)
 . E  S PARM("startDateTime")=$G(VIS(ZJ,"startDateTime")) ; include this day          
"RTN","C0CDAC0",384,0)
 ;
"RTN","C0CDAC0",385,0)
 ; now check for whether to include the immediately previous ER visit in the extract
"RTN","C0CDAC0",386,0)
 ;
"RTN","C0CDAC0",387,0)
 I $G(PARM("INCLUDEPREVIOUSERVISIT"))=1 D  ; include previous ER visit                
"RTN","C0CDAC0",388,0)
 . N ZK
"RTN","C0CDAC0",389,0)
 . I ZJ="" S ZK=$O(VIS("AAAAAA"),-1)
"RTN","C0CDAC0",390,0)
 . E  S ZK=ZJ-1
"RTN","C0CDAC0",391,0)
 . I $G(VIS(ZK,"typeName"))="ER-EMERGENCY ROOM VISIT" D  ;                        
"RTN","C0CDAC0",392,0)
 . . S PARM("startDateTime")=$G(VIS(ZK,"startDateTime")) ; new start date  
"RTN","C0CDAC0",393,0)
 Q
"RTN","C0CDAC0",394,0)
 ;
"RTN","C0CDAC0",395,0)
TEST ;
"RTN","C0CDAC0",396,0)
 S DFN=$$PAT()
"RTN","C0CDAC0",397,0)
 N PARMS
"RTN","C0CDAC0",398,0)
 K DIR
"RTN","C0CDAC0",399,0)
 S DIR(0)="FO"
"RTN","C0CDAC0",400,0)
 S DIR("B")="select=latest&meds=filter1&log=1"
"RTN","C0CDAC0",401,0)
 S DUZ("L")="Enter parameters"
"RTN","C0CDAC0",402,0)
 D ^DIR
"RTN","C0CDAC0",403,0)
 ;S PARMS=$TR(Y,",","^")
"RTN","C0CDAC0",404,0)
 S PARMS=Y
"RTN","C0CDAC0",405,0)
 N C0LOG S C0LOG=1
"RTN","C0CDAC0",406,0)
 ;D CCDARPC(.CCDA,DFN,.PARMS)
"RTN","C0CDAC0",407,0)
 N FN
"RTN","C0CDAC0",408,0)
 S FN=$$CCDA(DFN,.PARMS) ; 
"RTN","C0CDAC0",409,0)
 W !,FN
"RTN","C0CDAC0",410,0)
 I $D(PARMS("error")) ZWR PARMS Q  ;
"RTN","C0CDAC0",411,0)
 N C0LOGLOC S C0LOGLOC=$NA(^TMP("CCDA",$J,"LOG"))
"RTN","C0CDAC0",412,0)
 D BROWSE^DDBR(C0LOGLOC,"N","PATIENT "_DFN_" "_FN)
"RTN","C0CDAC0",413,0)
 Q
"RTN","C0CDAC0",414,0)
 ;
"RTN","C0CDAC0",415,0)
OUTCCDA(CCDA) ; write out a ccda xml file to the test directory
"RTN","C0CDAC0",416,0)
 N GF S GF=$$FMDTOUTC^C0CDACU($$NOW^XLFDT)_"-CCDA-"_DFN_".xml"
"RTN","C0CDAC0",417,0)
 S @CCDA@(0)=$O(@CCDA@(""),-1)
"RTN","C0CDAC0",418,0)
 N G2
"RTN","C0CDAC0",419,0)
 D MISSING^MXMLTMPL(CCDA,"G2")
"RTN","C0CDAC0",420,0)
 I $D(G2) D  ;
"RTN","C0CDAC0",421,0)
 . D:$G(C0LOG) OUTLOG^C0CDACU("MISSING VARIABLES")
"RTN","C0CDAC0",422,0)
 . N II S II=""
"RTN","C0CDAC0",423,0)
 . F  S II=$O(G2(II)) Q:II=""  D  ;
"RTN","C0CDAC0",424,0)
 . . D:$G(C0LOG) OUTLOG^C0CDACU(G2(II))
"RTN","C0CDAC0",425,0)
 K @CCDA@(0)
"RTN","C0CDAC0",426,0)
 N RSLT S RSLT=""
"RTN","C0CDAC0",427,0)
 I $$GTF^%ZISH($na(@CCDA@(1)),4,$$TESTDIR^C0CDACZ(),GF) D  ;
"RTN","C0CDAC0",428,0)
 . D:$G(C0LOG) OUTLOG^C0CDACU("CCDA "_GF_" WRITTEN TO: "_$$TESTDIR^C0CDACZ)
"RTN","C0CDAC0",429,0)
 . S RSLT=GF
"RTN","C0CDAC0",430,0)
 Q RSLT
"RTN","C0CDAC0",431,0)
 ;
"RTN","C0CDAC0",432,0)
PAT() ; extrinsic which returns a dfn from the patient selected
"RTN","C0CDAC0",433,0)
 S DIC=2,DIC(0)="AEMQ" D ^DIC
"RTN","C0CDAC0",434,0)
 I Y<1 Q  ; EXIT
"RTN","C0CDAC0",435,0)
 S DFN=$P(Y,U,1) ; SET THE PATIENT
"RTN","C0CDAC0",436,0)
 Q +Y
"RTN","C0CDAC0",437,0)
 ;
"RTN","C0CDAC0",438,0)
BCCDA1(TBL) ; BASIC CCDA - THIS TABLE LOADS ITSELF
"RTN","C0CDAC0",439,0)
 ;;HEADER,HEADER^C0CDAC2
"RTN","C0CDAC0",440,0)
 ;;ALGY,ALLERGY^C0CDAC8
"RTN","C0CDAC0",441,0)
 ;;DOCS,DOCS^C0CDACT
"RTN","C0CDAC0",442,0)
 ;;IMMU,IMMU^C0CDACI
"RTN","C0CDAC0",443,0)
 ;;ENC,ENC^C0CDACV
"RTN","C0CDAC0",444,0)
 ;;PROC,PROC^C0CDACP
"RTN","C0CDAC0",445,0)
 ;;SOC,SOC^C0CDAC7
"RTN","C0CDAC0",446,0)
 ;;MEDS,MEDS^C0CDAC4
"RTN","C0CDAC0",447,0)
 ;;PROBLEMS,PROBLEMS^C0CDAC3
"RTN","C0CDAC0",448,0)
 ;;LABS,LABS^C0CDAC5
"RTN","C0CDAC0",449,0)
 ;;VITALS,VITALS^C0CDAC6
"RTN","C0CDAC0",450,0)
 ;;FUNC,FUNCSTAT^C0CDACF
"RTN","C0CDAC0",451,0)
 N GTAG,GRT,GI
"RTN","C0CDAC0",452,0)
 S GTAG="BCCDA1"
"RTN","C0CDAC0",453,0)
 S GRT="C0CDAC0"
"RTN","C0CDAC0",454,0)
 N GN S GN=1
"RTN","C0CDAC0",455,0)
 F  S GI=GTAG_"+"_GN_"^"_GRT  Q:$T(@GI)'[";;"  D  ;
"RTN","C0CDAC0",456,0)
 . S TBL(GN)=$P($T(@GI),";;",2)
"RTN","C0CDAC0",457,0)
 . I $G(CCDADEBUG) W !,GN," ",TBL(GN)
"RTN","C0CDAC0",458,0)
 . S GN=GN+1
"RTN","C0CDAC0",459,0)
 Q
"RTN","C0CDAC0",460,0)
 ; retired calls
"RTN","C0CDAC0",461,0)
 ;;DOCS,DOCS^C0CDACT
"RTN","C0CDAC0",462,0)
 ;;RFV,RFV^C0CDAC9
"RTN","C0CDAC0",463,0)
 ;;PLOC,PLOC^C0CDAC9
"RTN","C0CDAC0",464,0)
 ;;RFR,RFR^C0CDAC9
"RTN","C0CDAC0",465,0)
 ;;FUNC,FUNC^C0CDAC9
"RTN","C0CDAC0",466,0)
 ;;ADVD,ADVD^C0CDAC9
"RTN","C0CDAC0",467,0)
 ;;FAMH,FAMH^C0CDAC9
"RTN","C0CDAC0",468,0)
 ;;INST,INST^C0CDAC9
"RTN","C0CDAC0",469,0)
 ;;DIS,DIS^C0CDAC9
"RTN","C0CDAC0",470,0)
 ;
"RTN","C0CDAC0",471,0)
BCCDA2(TBL) ; BASIC CCDA - THIS TABLE LOADS ITSELF
"RTN","C0CDAC0",472,0)
 ;;HEADER,HEADER^C0CDAC2
"RTN","C0CDAC0",473,0)
 ;;ALGY,ALLERGY^C0CDAC8
"RTN","C0CDAC0",474,0)
 ;;DOCS,DOCS^C0CDACT
"RTN","C0CDAC0",475,0)
 ;;IMMU,IMMU^C0CDACI
"RTN","C0CDAC0",476,0)
 ;;ENC,ENC^C0CDACV
"RTN","C0CDAC0",477,0)
 ;;PROC,PROC^C0CDACP
"RTN","C0CDAC0",478,0)
 ;;SOC,SOC^C0CDAC7
"RTN","C0CDAC0",479,0)
 ;;MEDS,MEDS^C0CDAC4
"RTN","C0CDAC0",480,0)
 ;;PROBLEMS,PROBLEMS^C0CDAC3
"RTN","C0CDAC0",481,0)
 ;;VITALS,VITALS^C0CDAC6
"RTN","C0CDAC0",482,0)
 ;;FUNC,FUNCSTAT^C0CDACF
"RTN","C0CDAC0",483,0)
 N GTAG,GRT,GI
"RTN","C0CDAC0",484,0)
 S GTAG="BCCDA2"
"RTN","C0CDAC0",485,0)
 S GRT="C0CDAC0"
"RTN","C0CDAC0",486,0)
 N GN S GN=1
"RTN","C0CDAC0",487,0)
 F  S GI=GTAG_"+"_GN_"^"_GRT  Q:$T(@GI)'[";;"  D  ;
"RTN","C0CDAC0",488,0)
 . S TBL(GN)=$P($T(@GI),";;",2)
"RTN","C0CDAC0",489,0)
 . I $G(CCDADEBUG) W !,GN," ",TBL(GN)
"RTN","C0CDAC0",490,0)
 . S GN=GN+1
"RTN","C0CDAC0",491,0)
 Q
"RTN","C0CDAC0",492,0)
 ;
"RTN","C0CDAC0",493,0)
TLAST1 ;
"RTN","C0CDAC0",494,0)
 ;;</structuredBody>
"RTN","C0CDAC0",495,0)
 ;;</component>
"RTN","C0CDAC0",496,0)
 ;;</ClinicalDocument>
"RTN","C0CDAC0",497,0)
 Q
"RTN","C0CDAC0",498,0)
 ;
"RTN","C0CDAC0",499,0)
PLISTFN() ;
"RTN","C0CDAC0",500,0)
 Q 1130580001.301
"RTN","C0CDAC0",501,0)
 ;
"RTN","C0CDAC0",502,0)
PDATAFN() ;
"RTN","C0CDAC0",503,0)
 Q 1130580001.3111
"RTN","C0CDAC0",504,0)
 ;
"RTN","C0CDAC0",505,0)
CCDALIST(COUNT,START,C0CPARM) ; generate ccda documents from a patient list
"RTN","C0CDAC0",506,0)
 I '$D(START) S START=1 ; start at the first patient in the list
"RTN","C0CDAC0",507,0)
 I '$D(COUNT) S COUNT=10 ; generate 10 documents
"RTN","C0CDAC0",508,0)
 N C0LIEN
"RTN","C0CDAC0",509,0)
 N DIC
"RTN","C0CDAC0",510,0)
 S DIC=$$PLISTFN()
"RTN","C0CDAC0",511,0)
 S DIC(0)="AEMQ"
"RTN","C0CDAC0",512,0)
 D ^DIC
"RTN","C0CDAC0",513,0)
 I Y<1 Q  ; EXIT
"RTN","C0CDAC0",514,0)
 S C0LIEN=+$P(Y,U,1) ; SET THE PATIENT LIST IEN
"RTN","C0CDAC0",515,0)
 W !,"PATIENT LIST IEN= ",C0LIEN
"RTN","C0CDAC0",516,0)
 N RARY ; RESULTS ARRAY
"RTN","C0CDAC0",517,0)
 S RARY=$NA(^TMP("CCDALIST",$J))
"RTN","C0CDAC0",518,0)
 K @RARY
"RTN","C0CDAC0",519,0)
 N PATLST S PATLST=$NA(^C0Q(301,C0LIEN,1,"B"))
"RTN","C0CDAC0",520,0)
 N DOLST S DOLST=""
"RTN","C0CDAC0",521,0)
 D SUBLIST^C0CDACU("DOLST",PATLST,COUNT,START) ; pull the sublist
"RTN","C0CDAC0",522,0)
 N CNT S CNT=0
"RTN","C0CDAC0",523,0)
 N ZI S ZI=0
"RTN","C0CDAC0",524,0)
 F  S ZI=$O(DOLST(ZI)) Q:+ZI=0  D  ;
"RTN","C0CDAC0",525,0)
 . W:$D(^DPT(ZI)) !,$G(^DPT(ZI,0))
"RTN","C0CDAC0",526,0)
 . N CCDAFNAM S CCDAFNAM=$$CCDA(ZI,$G(C0CPARM))
"RTN","C0CDAC0",527,0)
 . W !,"Extracting with parameters: ",$G(C0CPARM)
"RTN","C0CDAC0",528,0)
 . W !,"Writing CCDA xml file: ",CCDAFNAM
"RTN","C0CDAC0",529,0)
 . I CCDAFNAM="" Q  ;
"RTN","C0CDAC0",530,0)
 . S CNT=CNT+1
"RTN","C0CDAC0",531,0)
 . S @RARY@(CNT)=CCDAFNAM
"RTN","C0CDAC0",532,0)
 N LISTOUT
"RTN","C0CDAC0",533,0)
 S LISTOUT=$NA(^TMP("C0OUT",$J))
"RTN","C0CDAC0",534,0)
 K @LISTOUT
"RTN","C0CDAC0",535,0)
 D CCDARPT(LISTOUT,RARY)
"RTN","C0CDAC0",536,0)
 Q
"RTN","C0CDAC0",537,0)
 ;
"RTN","C0CDAC0",538,0)
CCDARPT(LISTOUT,ZARY) ; generate an html report for the list of CCDAs
"RTN","C0CDAC0",539,0)
 D ADDTO(LISTOUT,"<!DOCTYPE HTML><html><head></head><body><div align=""center""> <text>")
"RTN","C0CDAC0",540,0)
 N C0TBL
"RTN","C0CDAC0",541,0)
 S C0TBL("TITLE")="CCDA Generation from Patient List"
"RTN","C0CDAC0",542,0)
 S C0TBL("HEADER",1)="CCDA Link"
"RTN","C0CDAC0",543,0)
 N % S %=""
"RTN","C0CDAC0",544,0)
 F  S %=$O(@ZARY@(%)) Q:%=""  D  ;
"RTN","C0CDAC0",545,0)
 . S C0TBL(%,1)=$$HREF^C0CDACW(@ZARY@(%))
"RTN","C0CDAC0",546,0)
 D GENHTML^C0CDACW(LISTOUT,"C0TBL") 
"RTN","C0CDAC0",547,0)
 D ADDTO(LISTOUT,"</text></div></body></html>")
"RTN","C0CDAC0",548,0)
 K @LISTOUT@(0)
"RTN","C0CDAC0",549,0)
 N GF S GF="CCDA-TEST-"_C0LIEN_"-"_COUNT_"-"_START_".html"
"RTN","C0CDAC0",550,0)
 W !,"Writing file ",GF
"RTN","C0CDAC0",551,0)
 N RSLT S RSLT=""
"RTN","C0CDAC0",552,0)
 I $$GTF^%ZISH($na(@LISTOUT@(1)),3,$$TESTDIR^C0CDACZ(),GF) D  ;
"RTN","C0CDAC0",553,0)
 . D:$G(C0LOG) OUTLOG^C0CDACU("CCDA "_GF_" WRITTEN TO: "_$$TESTDIR^C0CDACZ)
"RTN","C0CDAC0",554,0)
 . S RSLT=GF
"RTN","C0CDAC0",555,0)
 Q
"RTN","C0CDAC0",556,0)
 ;
"RTN","C0CDAC0",557,0)
OLDTEST ;
"RTN","C0CDAC0",558,0)
 N C0FDA
"RTN","C0CDAC0",559,0)
 N ZI S ZI=0
"RTN","C0CDAC0",560,0)
 F  S ZI=$O(^C0Q(301,C0LIEN,1,"B",ZI)) Q:+ZI=0  D  ;
"RTN","C0CDAC0",561,0)
 . W:$D(^DPT(ZI)) !,$G(^DPT(ZI,0))
"RTN","C0CDAC0",562,0)
 . N CCDAFNAM S CCDAFNAM=$$CCDA(ZI,"notes=all")
"RTN","C0CDAC0",563,0)
 . I CCDAFNAM="" Q  ;
"RTN","C0CDAC0",564,0)
 . N ZIEN
"RTN","C0CDAC0",565,0)
 . S ZIEN=$O(^C0Q(301,C0LIEN,1,"B",ZI,""))
"RTN","C0CDAC0",566,0)
 . S C0FDA($$PDATAFN(),"+1,"_ZIEN_","_C0LIEN_",",.01)="CCDA|"_$$FMTE^XLFDT($$NOW^XLFDT())
"RTN","C0CDAC0",567,0)
 . S C0FDA($$PDATAFN(),"+1,"_ZIEN_","_C0LIEN_",",.02)=CCDAFNAM
"RTN","C0CDAC0",568,0)
 ZWR C0FDA
"RTN","C0CDAC0",569,0)
 ;D UPDIE(.C0FDA)
"RTN","C0CDAC0",570,0)
 Q
"RTN","C0CDAC0",571,0)
 ;
"RTN","C0CDAC0",572,0)
UPDIE(ZFDA,ZIEN) ; INTERNAL ROUTINE TO CALL UPDATE^DIE AND CHECK FOR ERRORS
"RTN","C0CDAC0",573,0)
 ; ZFDA IS PASSED BY REFERENCE
"RTN","C0CDAC0",574,0)
 ; ZIEN IS PASSED BY REFERENCE
"RTN","C0CDAC0",575,0)
 D:$G(DEBUG)
"RTN","C0CDAC0",576,0)
 . ZWRITE ZFDA
"RTN","C0CDAC0",577,0)
 . B
"RTN","C0CDAC0",578,0)
 K ZERR
"RTN","C0CDAC0",579,0)
 D CLEAN^DILF
"RTN","C0CDAC0",580,0)
 D UPDATE^DIE("K","ZFDA","ZIEN","ZERR")
"RTN","C0CDAC0",581,0)
 I '$G(TRUST) I $D(ZERR) S ZZERR=ZZERR ; ZZERR DOESN'T EXIST,
"RTN","C0CDAC0",582,0)
 ; INVOKE THE ERROR TRAP IF TASKED
"RTN","C0CDAC0",583,0)
 ;. W "ERROR",!
"RTN","C0CDAC0",584,0)
 ;. ZWR ZERR
"RTN","C0CDAC0",585,0)
 ;. B
"RTN","C0CDAC0",586,0)
 K ZFDA
"RTN","C0CDAC0",587,0)
 Q
"RTN","C0CDAC0",588,0)
 ;
"RTN","C0CDAC0",589,0)
 
"RTN","C0CDAC0",590,0)
  
"RTN","C0CDAC1")
0^2^B76574835
"RTN","C0CDAC1",1,0)
C0CDAC1 ; GPL - Patient Portal - CCDA Template Routines ;8/29/13  17:05
"RTN","C0CDAC1",2,0)
 ;;0.1;C0CDA;nopatch;noreleasedate;Build 1
"RTN","C0CDAC1",3,0)
 ;
"RTN","C0CDAC1",4,0)
 ; License AGPL v3.0
"RTN","C0CDAC1",5,0)
 ; 
"RTN","C0CDAC1",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDAC1",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDAC1",8,0)
 ;
"RTN","C0CDAC1",9,0)
 Q
"RTN","C0CDAC1",10,0)
 ;
"RTN","C0CDAC1",11,0)
FILEIN ; import the valueset xml file, parse with MXML, and put the dom in ^TMP
"RTN","C0CDAC1",12,0)
 ;
"RTN","C0CDAC1",13,0)
 N FNAME,DIRNAME
"RTN","C0CDAC1",14,0)
 W !,"Please enter the directory and file name for the NLM Valueset XML file"
"RTN","C0CDAC1",15,0)
 Q:'$$GETDIR(.DIRNAME,"/home/vista") ; prompt the user for the directory
"RTN","C0CDAC1",16,0)
 Q:'$$GETFN(.FNAME,"toc.xml") ; prompt user for filename
"RTN","C0CDAC1",17,0)
 N GN S GN=$NA(^KBAI("CCDA","PARTNERS")) ; root to store xml and dom
"RTN","C0CDAC1",18,0)
 K @GN ; clear the area
"RTN","C0CDAC1",19,0)
 N GN1 S GN1=$NA(@GN@("XML",1)) ; place to put the xml file
"RTN","C0CDAC1",20,0)
 W !,"Reading in file ",FNAME," from directory ",DIRNAME
"RTN","C0CDAC1",21,0)
 Q:$$FTG^%ZISH(DIRNAME,FNAME,GN1,4)=""
"RTN","C0CDAC1",22,0)
 N KBAIDID
"RTN","C0CDAC1",23,0)
 W !,"Parsing file ",FNAME
"RTN","C0CDAC1",24,0)
 S KBAIDID=$$EN^MXMLDOM($NA(@GN@("XML")),"W")
"RTN","C0CDAC1",25,0)
 I KBAIDID=0 D  Q  ;
"RTN","C0CDAC1",26,0)
 . ZWRITE ^TMP("MXMLERR",$J,*)
"RTN","C0CDAC1",27,0)
 W !,"Merging MXMLDOM to TMP"
"RTN","C0CDAC1",28,0)
 M @GN@("DOM")=^TMP("MXMLDOM",$J,KBAIDID)
"RTN","C0CDAC1",29,0)
 K ^TMP("MXMLDOM",$J)
"RTN","C0CDAC1",30,0)
 Q
"RTN","C0CDAC1",31,0)
 ;
"RTN","C0CDAC1",32,0)
GETDIR(KBAIDIR,KBAIDEF) ; extrinsic which prompts for directory
"RTN","C0CDAC1",33,0)
 ; returns true if the user gave values
"RTN","C0CDAC1",34,0)
 S DIR(0)="F^3:240"
"RTN","C0CDAC1",35,0)
 S DIR("A")="File Directory"
"RTN","C0CDAC1",36,0)
 I '$D(KBAIDEF) S KBAIDEF="/home/vista/"
"RTN","C0CDAC1",37,0)
 S DIR("B")=KBAIDEF
"RTN","C0CDAC1",38,0)
 D ^DIR
"RTN","C0CDAC1",39,0)
 I Y="^" Q 0 ;
"RTN","C0CDAC1",40,0)
 S KBAIDIR=Y
"RTN","C0CDAC1",41,0)
 Q 1
"RTN","C0CDAC1",42,0)
 ;
"RTN","C0CDAC1",43,0)
GETFN(KBAIFN,KBAIDEF) ; extrinsic which prompts for filename
"RTN","C0CDAC1",44,0)
 ; returns true if the user gave values
"RTN","C0CDAC1",45,0)
 S DIR(0)="F^3:240"
"RTN","C0CDAC1",46,0)
 S DIR("A")="File Name"
"RTN","C0CDAC1",47,0)
 I '$D(KBAIDEF) S KBAIDEF="toc.xml"
"RTN","C0CDAC1",48,0)
 S DIR("B")=KBAIDEF
"RTN","C0CDAC1",49,0)
 D ^DIR
"RTN","C0CDAC1",50,0)
 I Y="" Q 0 ;
"RTN","C0CDAC1",51,0)
 I Y="^" Q 0 ;
"RTN","C0CDAC1",52,0)
 S KBAIFN=Y
"RTN","C0CDAC1",53,0)
 Q 1
"RTN","C0CDAC1",54,0)
 ;
"RTN","C0CDAC1",55,0)
WKSPACE(ZWHERE) ; extrinsic that returns a workspace global reference
"RTN","C0CDAC1",56,0)
 ; ZWHERE IS PASSED BY VALUE AND HAS FORMAT PROJECT:SPACE:TOPIC
"RTN","C0CDAC1",57,0)
 N ZDIR,ZPROJ,ZSPACE,ZPROJ,ZTOPIC,ZFILE,ZROOT,ZTARG
"RTN","C0CDAC1",58,0)
 S ZROOT=$NA(^KBAI)
"RTN","C0CDAC1",59,0)
 S ZPROJ=$P(ZWHERE,":",1)
"RTN","C0CDAC1",60,0)
 S ZSPACE=$P(ZWHERE,":",2)
"RTN","C0CDAC1",61,0)
 S ZTOPIC=$P(ZWHERE,":",3)
"RTN","C0CDAC1",62,0)
 S ZTARG=$NA(@ZROOT@(ZPROJ,ZSPACE,ZTOPIC))
"RTN","C0CDAC1",63,0)
 Q ZTARG
"RTN","C0CDAC1",64,0)
 ;
"RTN","C0CDAC1",65,0)
tree(where,prefix,docid) ; show a tree starting at a node in MXML.
"RTN","C0CDAC1",66,0)
 ; 
"RTN","C0CDAC1",67,0)
 i $g(prefix)="" s prefix="|--" ; starting prefix
"RTN","C0CDAC1",68,0)
 ;n node s node=$na(^KBAI("CCDA","TOC","DOM",where))
"RTN","C0CDAC1",69,0)
 n node s node=$na(^TMP("MXMLDOM",$J,docid,where))
"RTN","C0CDAC1",70,0)
 n txt s txt=$$CLEAN($$ALLTXT(node))
"RTN","C0CDAC1",71,0)
 w !,prefix_@node_" "_txt
"RTN","C0CDAC1",72,0)
 n zi s zi=""
"RTN","C0CDAC1",73,0)
 f  s zi=$o(@node@("A",zi)) q:zi=""  d  ;
"RTN","C0CDAC1",74,0)
 . w !,prefix_"  : "_zi_"^"_$g(@node@("A",zi))
"RTN","C0CDAC1",75,0)
 f  s zi=$o(@node@("C",zi)) q:zi=""  d  ;
"RTN","C0CDAC1",76,0)
 . d tree(zi,"|  "_prefix,docid)
"RTN","C0CDAC1",77,0)
 q
"RTN","C0CDAC1",78,0)
 ;
"RTN","C0CDAC1",79,0)
show(what) ;
"RTN","C0CDAC1",80,0)
 I '$D(C0XJOB) S C0XJOB=$J
"RTN","C0CDAC1",81,0)
 d tree(what)
"RTN","C0CDAC1",82,0)
 q
"RTN","C0CDAC1",83,0)
 ; 
"RTN","C0CDAC1",84,0)
tree2(where,prefix,root,zout) ; show a tree starting at a node in MXML. 
"RTN","C0CDAC1",85,0)
 ; node is passed by name
"RTN","C0CDAC1",86,0)
 ; 
"RTN","C0CDAC1",87,0)
 i $g(prefix)="" s prefix="|--" ; starting prefix
"RTN","C0CDAC1",88,0)
 i '$d(KBAIJOB) s KBAIJOB=$J
"RTN","C0CDAC1",89,0)
 i '$d(root) s root=$na(^TMP("MXMLDOM",1))
"RTN","C0CDAC1",90,0)
 n node s node=$na(@root@(where))
"RTN","C0CDAC1",91,0)
 n txt s txt=$$CLEAN($$ALLTXT(node))
"RTN","C0CDAC1",92,0)
 w !,where," ",prefix_@node_" "_txt
"RTN","C0CDAC1",93,0)
 d oneout(zout,where_prefix_@node_" "_txt)
"RTN","C0CDAC1",94,0)
 n zi s zi=""
"RTN","C0CDAC1",95,0)
 f  s zi=$o(@node@("A",zi)) q:zi=""  d  ;
"RTN","C0CDAC1",96,0)
 . w !,where," ",prefix_"  : "_zi_"^"_$g(@node@("A",zi))
"RTN","C0CDAC1",97,0)
 . d oneout(zout,where_prefix_"  : "_zi_"^"_$g(@node@("A",zi)))
"RTN","C0CDAC1",98,0)
 f  s zi=$o(@node@("C",zi)) q:zi=""  d  ;
"RTN","C0CDAC1",99,0)
 . d tree2(zi,"|  "_prefix,root,zout)
"RTN","C0CDAC1",100,0)
 q
"RTN","C0CDAC1",101,0)
 ;
"RTN","C0CDAC1",102,0)
oneout(zbuf,ztxt) ; adds a line to zbuf
"RTN","C0CDAC1",103,0)
 n zi s zi=$o(@zbuf@(""),-1)+1
"RTN","C0CDAC1",104,0)
 s @zbuf@(zi)=ztxt
"RTN","C0CDAC1",105,0)
 q
"RTN","C0CDAC1",106,0)
 ;
"RTN","C0CDAC1",107,0)
go ; 
"RTN","C0CDAC1",108,0)
 d mktemp2^C0CDAC1("advanceDirective",213,219)
"RTN","C0CDAC1",109,0)
 d mktemp2^C0CDAC1("reasonForVisit",319,325)
"RTN","C0CDAC1",110,0)
 d mktemp2^C0CDAC1("familyHistory",326,332)
"RTN","C0CDAC1",111,0)
 d mktemp2^C0CDAC1("functionalStatus",333,338)
"RTN","C0CDAC1",112,0)
 d mktemp2^C0CDAC1("instructions",363,370)
"RTN","C0CDAC1",113,0)
 d mktemp2^C0CDAC1("planOfCare",876,882)
"RTN","C0CDAC1",114,0)
 d mktemp2^C0CDAC1("reasonForReferral",1332,1338)
"RTN","C0CDAC1",115,0)
 q
"RTN","C0CDAC1",116,0)
 ;
"RTN","C0CDAC1",117,0)
 ;mktemp2(zrtn,zbeg,zend,zname) ; create an xml template out of the MXML dom
"RTN","C0CDAC1",118,0)
mktemp2(zname,zbeg,zend,zrtn) ; create an xml template out of the MXML dom
"RTN","C0CDAC1",119,0)
 ; at docid beginning with zbeg and ending with zend, both nodes passed by
"RTN","C0CDAC1",120,0)
 ; value. zrtn is passed by name.
"RTN","C0CDAC1",121,0)
 I '$D(zrtn) S zrtn="GPL" K GPL
"RTN","C0CDAC1",122,0)
 N GN S GN=$NA(^TMP("MXMLDOM",$J,1))
"RTN","C0CDAC1",123,0)
 K @GN
"RTN","C0CDAC1",124,0)
 M @GN=^KBAI("CCDA","TOC","DOM")
"RTN","C0CDAC1",125,0)
 D OUTXML(zrtn,1,zbeg,zend)
"RTN","C0CDAC1",126,0)
 N GTMP S GTMP=$NA(^TMP("JJOHXML",$J))
"RTN","C0CDAC1",127,0)
 K @GTMP
"RTN","C0CDAC1",128,0)
 M @GTMP=@zrtn
"RTN","C0CDAC1",129,0)
 N ZDOC S ZDOC=$$PARSE(GTMP)
"RTN","C0CDAC1",130,0)
 I $D(^TMP("MXMLERR",$J)) D  B  ;
"RTN","C0CDAC1",131,0)
 . ZWR ^TMP("MXMLERR",$J,*)
"RTN","C0CDAC1",132,0)
 W $$GTF^%ZISH($na(@GTMP@(1)),3,"/home/vista/",zname_".temp")
"RTN","C0CDAC1",133,0)
 K @GTMP
"RTN","C0CDAC1",134,0)
 D tree(1,,ZDOC)
"RTN","C0CDAC1",135,0)
 K ^TMP("MXMLDOM",$J,ZDOC)
"RTN","C0CDAC1",136,0)
 Q
"RTN","C0CDAC1",137,0)
 ;
"RTN","C0CDAC1",138,0)
PARSE(INXML,INDOC) ;CALL THE MXML PARSER ON INXML, PASSED BY NAME
"RTN","C0CDAC1",139,0)
 ; EXTRINSIC WHICH RETURNS THE DOCID ASSIGNED BY MXML
"RTN","C0CDAC1",140,0)
 Q $$EN^MXMLDOM(INXML,"W")
"RTN","C0CDAC1",141,0)
 ;
"RTN","C0CDAC1",142,0)
mktemp(zname,zbeg,zend,root) ; create a template named zname
"RTN","C0CDAC1",143,0)
 ; beginning at node zbeg and ending at node zend of root
"RTN","C0CDAC1",144,0)
 ; root is passed by name, all others passed by value
"RTN","C0CDAC1",145,0)
 ;
"RTN","C0CDAC1",146,0)
 ;i '$d(root) s root=$na(^KBAI("CCDA","PARTNERS","DOM"))
"RTN","C0CDAC1",147,0)
 i '$d(root) s root=$na(^KBAI("CCDA","TOC","DOM"))
"RTN","C0CDAC1",148,0)
 n zg s zg=$na(^KBAI("TEMPLATE",zname,"DOM")) ; place to put the template
"RTN","C0CDAC1",149,0)
 s @zg@("created")=$$NOW^XLFDT
"RTN","C0CDAC1",150,0)
 n zii s zii=$o(@root@(zbeg),-1)
"RTN","C0CDAC1",151,0)
 n zn s zn=0
"RTN","C0CDAC1",152,0)
 f  s zii=$o(@root@(zii)) q:+zii>zend  d  ;
"RTN","C0CDAC1",153,0)
 . s zn=zn+1
"RTN","C0CDAC1",154,0)
 . m @zg@(zn)=@root@(zii)
"RTN","C0CDAC1",155,0)
 q
"RTN","C0CDAC1",156,0)
 ;
"RTN","C0CDAC1",157,0)
showtemp(zname,root) ; display a template stored at root (passed by name)
"RTN","C0CDAC1",158,0)
 ;
"RTN","C0CDAC1",159,0)
 i '$d(root) s root=$na(^KBAI("TEMPLATE",zname,"DOM"))
"RTN","C0CDAC1",160,0)
 i '$d(@root@(1)) d  q  ;
"RTN","C0CDAC1",161,0)
 . w !,"Error, template ",zname," does not exist"
"RTN","C0CDAC1",162,0)
 n out s out=$na(^TMP("CCDAOUT2",$J))
"RTN","C0CDAC1",163,0)
 d tree2(1,,root,out)
"RTN","C0CDAC1",164,0)
 D BROWSE^DDBR(out,"N","Transfer of Care CCDA")
"RTN","C0CDAC1",165,0)
 k @out
"RTN","C0CDAC1",166,0)
 q
"RTN","C0CDAC1",167,0)
 ;
"RTN","C0CDAC1",168,0)
ALLTXT(where) ; extrinsic returns concatinated all text lines from the node 
"RTN","C0CDAC1",169,0)
 ;
"RTN","C0CDAC1",170,0)
 n zti s zti=""
"RTN","C0CDAC1",171,0)
 n ztr s ztr=""
"RTN","C0CDAC1",172,0)
 f  s zti=$o(@where@("T",zti)) q:zti=""  d  ;
"RTN","C0CDAC1",173,0)
 . s ztr=ztr_$g(@where@("T",zti))
"RTN","C0CDAC1",174,0)
 q ztr
"RTN","C0CDAC1",175,0)
 ;
"RTN","C0CDAC1",176,0)
CLEAN(STR) ; extrinsic function; returns string
"RTN","C0CDAC1",177,0)
 ;; Removes all non printable characters from a string.
"RTN","C0CDAC1",178,0)
 ;; STR by Value
"RTN","C0CDAC1",179,0)
 N TR,I
"RTN","C0CDAC1",180,0)
 F I=0:1:31 S TR=$G(TR)_$C(I)
"RTN","C0CDAC1",181,0)
 S TR=TR_$C(127)
"RTN","C0CDAC1",182,0)
 N ZR S ZR=$TR(STR,TR)
"RTN","C0CDAC1",183,0)
 S ZR=$$LDBLNKS(ZR) ; get rid of leading blanks
"RTN","C0CDAC1",184,0)
 QUIT ZR
"RTN","C0CDAC1",185,0)
 ;
"RTN","C0CDAC1",186,0)
LDBLNKS(st) ; extrinsic which removes leading blanks from a string
"RTN","C0CDAC1",187,0)
 n pos f pos=1:1:$l(st)  q:$e(st,pos)'=" "
"RTN","C0CDAC1",188,0)
 q $e(st,pos,$l(st))
"RTN","C0CDAC1",189,0)
 ;
"RTN","C0CDAC1",190,0)
toc ; display the Transfer of Care sample xml
"RTN","C0CDAC1",191,0)
 n gn s gn=$na(^KBAI("CCDA","TOC","DOM"))
"RTN","C0CDAC1",192,0)
 n out s out=$na(^TMP("CCDAOUT",$J))
"RTN","C0CDAC1",193,0)
 d tree2(1,,gn,out)
"RTN","C0CDAC1",194,0)
 D BROWSE^DDBR(out,"N","Transfer of Care CCDA")
"RTN","C0CDAC1",195,0)
 k @out
"RTN","C0CDAC1",196,0)
 q
"RTN","C0CDAC1",197,0)
 ;
"RTN","C0CDAC1",198,0)
partners ; display the partners healthcare sample xml
"RTN","C0CDAC1",199,0)
 n gn s gn=$na(^KBAI("CCDA","PARTNERS","DOM"))
"RTN","C0CDAC1",200,0)
 n out s out=$na(^TMP("CCDAOUT",$J))
"RTN","C0CDAC1",201,0)
 d tree2(1,,gn,out)
"RTN","C0CDAC1",202,0)
 D BROWSE^DDBR(out,"N","Partners Healthcare sample CCDA")
"RTN","C0CDAC1",203,0)
 k @out
"RTN","C0CDAC1",204,0)
 q
"RTN","C0CDAC1",205,0)
 ;
"RTN","C0CDAC1",206,0)
ISMULT(ZOID) ; RETURN TRUE IF ZOID IS ONE OF A MULTIPLE
"RTN","C0CDAC1",207,0)
 N ZN
"RTN","C0CDAC1",208,0)
 ;I $$TAG(ZOID)["entry" B
"RTN","C0CDAC1",209,0)
 S ZN=$$NXTSIB(ZOID)
"RTN","C0CDAC1",210,0)
 I ZN'="" Q $$TAG(ZOID)=$$TAG(ZN) ; IF TAG IS THE SAME AS NEXT SIB TAG
"RTN","C0CDAC1",211,0)
 Q 0
"RTN","C0CDAC1",212,0)
 ;
"RTN","C0CDAC1",213,0)
FIRST(ZOID) ;RETURNS THE OID OF THE FIRST CHILD OF ZOID
"RTN","C0CDAC1",214,0)
 Q $$CHILD^MXMLDOM(JJOHDOC,ZOID)
"RTN","C0CDAC1",215,0)
 ;
"RTN","C0CDAC1",216,0)
PARENT(ZOID) ;RETURNS THE OID OF THE PARENT OF ZOID
"RTN","C0CDAC1",217,0)
 Q $$PARENT^MXMLDOM(JJOHDOC,ZOID)
"RTN","C0CDAC1",218,0)
 ;
"RTN","C0CDAC1",219,0)
ATT(RTN,NODE) ;GET ATTRIBUTES FOR ZOID
"RTN","C0CDAC1",220,0)
 S HANDLE=JJOHDOC
"RTN","C0CDAC1",221,0)
 K @RTN
"RTN","C0CDAC1",222,0)
 D GETTXT^MXMLDOM("A")
"RTN","C0CDAC1",223,0)
 Q
"RTN","C0CDAC1",224,0)
 ;
"RTN","C0CDAC1",225,0)
TAG(ZOID) ; RETURNS THE XML TAG FOR THE NODE
"RTN","C0CDAC1",226,0)
 N X,Y
"RTN","C0CDAC1",227,0)
 S Y=""
"RTN","C0CDAC1",228,0)
 S X=$G(C0CCBK("TAG")) ;IS THERE A CALLBACK FOR THIS ROUTINE
"RTN","C0CDAC1",229,0)
 I X'="" X X ; EXECUTE THE CALLBACK, SHOULD SET Y
"RTN","C0CDAC1",230,0)
 I Y="" S Y=$$NAME^MXMLDOM(JJOHDOC,ZOID)
"RTN","C0CDAC1",231,0)
 Q Y
"RTN","C0CDAC1",232,0)
 ;
"RTN","C0CDAC1",233,0)
NXTSIB(ZOID) ; RETURNS THE NEXT SIBLING
"RTN","C0CDAC1",234,0)
 Q $$SIBLING^MXMLDOM(JJOHDOC,ZOID)
"RTN","C0CDAC1",235,0)
 ;
"RTN","C0CDAC1",236,0)
DATA(ZT,ZOID) ; RETURNS DATA FOR THE NODE
"RTN","C0CDAC1",237,0)
 ;N ZT,ZN S ZT=""
"RTN","C0CDAC1",238,0)
 ;S C0CDOM=$NA(^TMP("MXMLDOM",$J,JJOHDOC))
"RTN","C0CDAC1",239,0)
 ;Q $G(@C0CDOM@(ZOID,"T",1))
"RTN","C0CDAC1",240,0)
 S ZN=$$TEXT^MXMLDOM(JJOHDOC,ZOID,ZT)
"RTN","C0CDAC1",241,0)
 Q
"RTN","C0CDAC1",242,0)
 ;
"RTN","C0CDAC1",243,0)
OUTXML(ZRTN,INID,ZBEG,ZEND) ; USES MXMLBLD TO OUTPUT XML FROM AN MXMLDOM
"RTN","C0CDAC1",244,0)
 ; ZBEG AND ZEND ARE PASSED BY VALUE AND DEFINE A RANGE OF NODES TO OUTPUT
"RTN","C0CDAC1",245,0)
 ; ZRTN IS PASSED BY NAME. INID IS PASSED BY VALUE AND IS THE DOCID OF THE DOM
"RTN","C0CDAC1",246,0)
 ;
"RTN","C0CDAC1",247,0)
 I '$D(ZBEG) S ZBEG=1
"RTN","C0CDAC1",248,0)
 I '$D(ZEND) S ZEND=$O(^TMP("MXMLDOM",$J,INID,""),-1) ; LAST NODE
"RTN","C0CDAC1",249,0)
 S JJOHDOC=INID
"RTN","C0CDAC1",250,0)
 D START^MXMLBLD($$TAG(ZBEG),,"G")
"RTN","C0CDAC1",251,0)
 N ZMAX S ZMAX=ZEND
"RTN","C0CDAC1",252,0)
 D NDOUT2($$FIRST(ZBEG),ZMAX)
"RTN","C0CDAC1",253,0)
 D END^MXMLBLD ;END THE DOCUMENT
"RTN","C0CDAC1",254,0)
 M @ZRTN=^TMP("MXMLBLD",$J)
"RTN","C0CDAC1",255,0)
 K ^TMP("MXMLBLD",$J)
"RTN","C0CDAC1",256,0)
 Q
"RTN","C0CDAC1",257,0)
 ;
"RTN","C0CDAC1",258,0)
NDOUT(ZOID) ;CALLBACK ROUTINE - IT IS RECURSIVE
"RTN","C0CDAC1",259,0)
 N ZI S ZI=$$FIRST(ZOID)
"RTN","C0CDAC1",260,0)
 I ZI'=0 D  ; THERE IS A CHILD
"RTN","C0CDAC1",261,0)
 . N ZATT D ATT("ZATT",ZOID) ; THESE ARE THE ATTRIBUTES MOVED TO ZATT
"RTN","C0CDAC1",262,0)
 . D MULTI^C0CMXMLB("",$$TAG(ZOID),.ZATT,"NDOUT^C0CDAC1(ZI)") ;HAVE CHILDREN
"RTN","C0CDAC1",263,0)
 E  D  ; NO CHILD - IF NO CHILDREN, A NODE HAS DATA, IS AN ENDPOINT
"RTN","C0CDAC1",264,0)
 . ;W "DOING",ZOID,!
"RTN","C0CDAC1",265,0)
 . N ZD D DATA("ZD",ZOID) ;NODES WITHOUT CHILDREN HAVE DATA
"RTN","C0CDAC1",266,0)
 . N ZATT D ATT("ZATT",ZOID) ;ATTRIBUTES
"RTN","C0CDAC1",267,0)
 . D ITEM^MXMLBLD("",$$TAG(ZOID),.ZATT,$G(ZD(1))) ;NO CHILDREN
"RTN","C0CDAC1",268,0)
 I $$NXTSIB(ZOID)'=0 D  ; THERE IS A SIBLING
"RTN","C0CDAC1",269,0)
 . D NDOUT($$NXTSIB(ZOID)) ;RECURSE FOR SIBLINGS
"RTN","C0CDAC1",270,0)
 Q
"RTN","C0CDAC1",271,0)
 ;
"RTN","C0CDAC1",272,0)
NDOUT2(ZOID,MAX) ;CALLBACK ROUTINE - IT IS RECURSIVE
"RTN","C0CDAC1",273,0)
 ; MAX IS A LIMITER NODE FOR PROCESSING CHILDREN
"RTN","C0CDAC1",274,0)
 N ZI S ZI=$$FIRST(ZOID)
"RTN","C0CDAC1",275,0)
 I ZI'=0 D  ; THERE IS A CHILD
"RTN","C0CDAC1",276,0)
 . I ZI>MAX Q  ; do not go beyond the MAX node
"RTN","C0CDAC1",277,0)
 . N ZATT D ATT("ZATT",ZOID) ; THESE ARE THE ATTRIBUTES MOVED TO ZATT
"RTN","C0CDAC1",278,0)
 . D MULTI^MXMLBLD("",$$TAG(ZOID),.ZATT,"NDOUT2^C0CDAC1(ZI,MAX)") ;CHILDREN
"RTN","C0CDAC1",279,0)
 E  D  ; NO CHILD - IF NO CHILDREN, A NODE HAS DATA, IS AN ENDPOINT
"RTN","C0CDAC1",280,0)
 . ;W "DOING",ZOID,!
"RTN","C0CDAC1",281,0)
 . N ZD D DATA("ZD",ZOID) ;NODES WITHOUT CHILDREN HAVE DATA
"RTN","C0CDAC1",282,0)
 . N ZATT D ATT("ZATT",ZOID) ;ATTRIBUTES
"RTN","C0CDAC1",283,0)
 . D ITEM^MXMLBLD("",$$TAG(ZOID),.ZATT,$G(ZD(1))) ;NO CHILDREN
"RTN","C0CDAC1",284,0)
 I $$NXTSIB(ZOID)'=0 D  ; THERE IS A SIBLING
"RTN","C0CDAC1",285,0)
 . I $$NXTSIB(ZOID)>MAX Q  ; don't go beyond the max
"RTN","C0CDAC1",286,0)
 . D NDOUT2($$NXTSIB(ZOID),MAX) ;RECURSE FOR SIBLINGS
"RTN","C0CDAC1",287,0)
 Q
"RTN","C0CDAC1",288,0)
 ;
"RTN","C0CDAC2")
0^3^B279347626
"RTN","C0CDAC2",1,0)
C0CDAC2 ; GPL - CCDA Header Routines ;/14/13  17:05
"RTN","C0CDAC2",2,0)
 ;;0.1;C0CDA;nopatch;noreleasedate;Build 1
"RTN","C0CDAC2",3,0)
 ;
"RTN","C0CDAC2",4,0)
 ; License AGPL v3.0
"RTN","C0CDAC2",5,0)
 ; 
"RTN","C0CDAC2",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDAC2",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDAC2",8,0)
 ;
"RTN","C0CDAC2",9,0)
 Q
"RTN","C0CDAC2",10,0)
 ;
"RTN","C0CDAC2",11,0)
GETHDR(RTN,DFN) ; returns the built header xml
"RTN","C0CDAC2",12,0)
 N GBLD,GWRK,GRPT
"RTN","C0CDAC2",13,0)
 S GWRK=$NA(^TMP("CCDA",$J))
"RTN","C0CDAC2",14,0)
 K @GWRK
"RTN","C0CDAC2",15,0)
 S GBLD=$NA(@GWRK@("BLDLIST"))
"RTN","C0CDAC2",16,0)
 S GRPT=$NA(@GWRK@("CTRL","HEADER"))
"RTN","C0CDAC2",17,0)
 D HEADER(GBLD,DFN,GWRK)
"RTN","C0CDAC2",18,0)
 D BUILD^MXMLTMPL(GBLD,RTN)
"RTN","C0CDAC2",19,0)
 N G2
"RTN","C0CDAC2",20,0)
 D MISSING^MXMLTMPL(RTN,"G2")
"RTN","C0CDAC2",21,0)
 I $D(G2) D  ;
"RTN","C0CDAC2",22,0)
 . W !,"MISSING VARIABLES"
"RTN","C0CDAC2",23,0)
 . ZWR G2
"RTN","C0CDAC2",24,0)
 Q
"RTN","C0CDAC2",25,0)
 ;
"RTN","C0CDAC2",26,0)
HEADER(CCDABLD,DFN,CCDAWRK,CCDARPT,CCDACTRL) ; create a ccda header for patient DFN
"RTN","C0CDAC2",27,0)
 ; use workarea CCDAWRK passed by name
"RTN","C0CDAC2",28,0)
 ; return a build list in CCDABLD passed by name
"RTN","C0CDAC2",29,0)
 ;
"RTN","C0CDAC2",30,0)
 ; the header includes the start of the CCDA document and the patient, author
"RTN","C0CDAC2",31,0)
 ; documentationOf and componentOf sections
"RTN","C0CDAC2",32,0)
 ;
"RTN","C0CDAC2",33,0)
 I '$D(CCDAWRK) S CCDAWRK=$NA(^TMP("CCDA",$J))
"RTN","C0CDAC2",34,0)
 N CCDAV,CCDARTN,PARMS,HAVDTS
"RTN","C0CDAC2",35,0)
 I $D(@CCDACTRL@("PARMS")) M PARMS=@CCDACTRL@("PARMS")
"RTN","C0CDAC2",36,0)
 S HAVDTS=0
"RTN","C0CDAC2",37,0)
 I $D(PARMS("startDateTime")) S HAVDTS=1
"RTN","C0CDAC2",38,0)
 D GETPAT^C0CDACD(.CCDARTN,DFN,"demographics") ; get patient demographics
"RTN","C0CDAC2",39,0)
 M CCDAV=CCDARTN("patient",1)
"RTN","C0CDAC2",40,0)
 N G2
"RTN","C0CDAC2",41,0)
 D  ;
"RTN","C0CDAC2",42,0)
 . S G2(1)="address@stateProvince"
"RTN","C0CDAC2",43,0)
 . S G2(2)="address@city"
"RTN","C0CDAC2",44,0)
 . S G2(3)="address@postalCode"
"RTN","C0CDAC2",45,0)
 . S G2(4)="address@streetLine1"
"RTN","C0CDAC2",46,0)
 N ZI S ZI=""
"RTN","C0CDAC2",47,0)
 F  S ZI=$O(G2(ZI)) Q:ZI=""  D  ;
"RTN","C0CDAC2",48,0)
 . N GV S GV=G2(ZI)
"RTN","C0CDAC2",49,0)
 . I '$D(CCDAV(GV)) S CCDAV(GV)=""
"RTN","C0CDAC2",50,0)
 D SETORGV(.CCDAV)
"RTN","C0CDAC2",51,0)
 ; give the ability to pass in the docId as a parameter
"RTN","C0CDAC2",52,0)
 I $G(PARMS("docId"))'="" S CCDAV("docNumber")=PARMS("docId")
"RTN","C0CDAC2",53,0)
 I $G(PARMS("error"))'="" D  Q  ;
"RTN","C0CDAC2",54,0)
 . S @CCDACTRL@("PARMS","error")=$G(PARMS("error"))
"RTN","C0CDAC2",55,0)
 ;
"RTN","C0CDAC2",56,0)
 ; gpl astro
"RTN","C0CDAC2",57,0)
 ;
"RTN","C0CDAC2",58,0)
 N VARS2 ; for second mapping
"RTN","C0CDAC2",59,0)
 S VARS2("suffix")=""
"RTN","C0CDAC2",60,0)
 S VARS2("tele")="<telecom nullFlavor=""UNK""></telecom>"
"RTN","C0CDAC2",61,0)
 ;
"RTN","C0CDAC2",62,0)
 
"RTN","C0CDAC2",63,0)
 D SETPATV(.CCDAV)
"RTN","C0CDAC2",64,0)
 ; import episode date and text from parms
"RTN","C0CDAC2",65,0)
 N C0D S C0D=$G(PARMS("date"))
"RTN","C0CDAC2",66,0)
 ;
"RTN","C0CDAC2",67,0)
 I C0D="" S C0D=$$NOW^XLFDT
"RTN","C0CDAC2",68,0)
 ; end gpl astro
"RTN","C0CDAC2",69,0)
 I C0D'="" S CCDAV("docOfDate")=$$FMDTOUTC^C0CDACU(C0D)
"RTN","C0CDAC2",70,0)
 S CCDAV("docCreated")=$$FMDTOUTC^C0CDACU($$NOW^XLFDT())
"RTN","C0CDAC2",71,0)
 S CCDAV("encompassingEncounterExtension")=$$UUID^C0CDACU() ; random
"RTN","C0CDAC2",72,0)
 I C0D'="" S CCDAV("encompassingEncounterEffectiveTime")=$$FMDTOUTC^C0CDACU(C0D)
"RTN","C0CDAC2",73,0)
 N CCDATYPE,WRK
"RTN","C0CDAC2",74,0)
 ; build the header
"RTN","C0CDAC2",75,0)
 S CCDATYPE="HEADER"
"RTN","C0CDAC2",76,0)
 S WRK=$NA(@CCDAWRK@(CCDATYPE))
"RTN","C0CDAC2",77,0)
 ; astro gpl
"RTN","C0CDAC2",78,0)
 I $G(PARMS("GPLTEST"))=1 B
"RTN","C0CDAC2",79,0)
 I $G(CCDAV("raceCode"))="UNK" D GETNMAP^C0CDACU(WRK,"THEADER3^C0CDAC2","CCDAV")
"RTN","C0CDAC2",80,0)
 I $G(CCDAV("raceCode"))'="UNK" D  ;
"RTN","C0CDAC2",81,0)
 . N RACECD2 S RACECD2=$$RACECODE2(DFN)
"RTN","C0CDAC2",82,0)
 . I RACECD2=1 D GETNMAP^C0CDACU(WRK,"THEADER2^C0CDAC2","CCDAV")
"RTN","C0CDAC2",83,0)
 . I RACECD2=0 D GETNMAP^C0CDACU(WRK,"THEADER^C0CDAC2","CCDAV")
"RTN","C0CDAC2",84,0)
 N WRK2
"RTN","C0CDAC2",85,0)
 D JUSTMAP^C0CDACU(WRK,"VARS2","WRK2")
"RTN","C0CDAC2",86,0)
 M @WRK=WRK2
"RTN","C0CDAC2",87,0)
 ;M ^gpl("JUSTMAP")=@WRK
"RTN","C0CDAC2",88,0)
 ;M ^gpl("WRK2")=WRK2
"RTN","C0CDAC2",89,0)
 ; end astro gpl
"RTN","C0CDAC2",90,0)
 D QUEUE^MXMLTMPL(CCDABLD,WRK,1,@WRK@(0))
"RTN","C0CDAC2",91,0)
 ;N LAST1
"RTN","C0CDAC2",92,0)
 ;S LAST1(1)="</structuredBody>"
"RTN","C0CDAC2",93,0)
 ;S LAST1(2)="</component>"
"RTN","C0CDAC2",94,0)
 ;S LAST1(3)="</ClinicalDocument>" ; do this after all the rest
"RTN","C0CDAC2",95,0)
 ;S LAST1(0)=3 ; count
"RTN","C0CDAC2",96,0)
 ; build the author
"RTN","C0CDAC2",97,0)
 S CCDATYPE="AUTHOR"
"RTN","C0CDAC2",98,0)
 S WRK=$NA(@CCDAWRK@(CCDATYPE))
"RTN","C0CDAC2",99,0)
 D GETNMAP^C0CDACU(WRK,"TAUTHOR2^C0CDAC2","CCDAV")
"RTN","C0CDAC2",100,0)
 D QUEUE^MXMLTMPL(CCDABLD,WRK,1,@WRK@(0))
"RTN","C0CDAC2",101,0)
 ; build the documentationOf
"RTN","C0CDAC2",102,0)
 S CCDATYPE="DOCOF"
"RTN","C0CDAC2",103,0)
 S WRK=$NA(@CCDAWRK@(CCDATYPE))
"RTN","C0CDAC2",104,0)
 D GETNMAP^C0CDACU(WRK,"TDOCOF^C0CDAC2","CCDAV")
"RTN","C0CDAC2",105,0)
 D QUEUE^MXMLTMPL(CCDABLD,WRK,1,@WRK@(0))
"RTN","C0CDAC2",106,0)
 ; build the componentOf
"RTN","C0CDAC2",107,0)
 S CCDATYPE="COMPOF"
"RTN","C0CDAC2",108,0)
 S WRK=$NA(@CCDAWRK@(CCDATYPE))
"RTN","C0CDAC2",109,0)
 D GETNMAP^C0CDACU(WRK,"TCOMPOF^C0CDAC2","CCDAV")
"RTN","C0CDAC2",110,0)
 D QUEUE^MXMLTMPL(CCDABLD,WRK,1,@WRK@(0))
"RTN","C0CDAC2",111,0)
 ; build the last lines - MOVED TO C0
"RTN","C0CDAC2",112,0)
 ;S CCDATYPE="LAST"
"RTN","C0CDAC2",113,0)
 ;S WRK=$NA(@CCDAWRK@(CCDATYPE))
"RTN","C0CDAC2",114,0)
 ;M @WRK=LAST1
"RTN","C0CDAC2",115,0)
 ;D QUEUE^MXMLTMPL(CCDABLD,WRK,1,@WRK@(0))
"RTN","C0CDAC2",116,0)
 ;
"RTN","C0CDAC2",117,0)
 Q
"RTN","C0CDAC2",118,0)
 ;
"RTN","C0CDAC2",119,0)
RACECODE2(DFN) ; returns 1 if health factor for secondary race code
"RTN","C0CDAC2",120,0)
 ; is present - astro gpl
"RTN","C0CDAC2",121,0)
 N C0CHF
"RTN","C0CDAC2",122,0)
 D GETPAT^C0CDACE(.C0CHF,DFN,"health-factors")
"RTN","C0CDAC2",123,0)
 ;ZWR C0CHF
"RTN","C0CDAC2",124,0)
 N ZI,ZR S ZI=0 S ZR=0
"RTN","C0CDAC2",125,0)
 F  S ZI=$O(C0CHF("results","healthFactors",ZI)) Q:((+ZI=0)!(ZR=1))  D  ;
"RTN","C0CDAC2",126,0)
 . I $G(C0CHF("results","healthFactors",ZI,"factor","name@value"))="EUROPEAN" S ZR=1
"RTN","C0CDAC2",127,0)
 Q ZR
"RTN","C0CDAC2",128,0)
 ;
"RTN","C0CDAC2",129,0)
TEST ;
"RTN","C0CDAC2",130,0)
 N GBLD
"RTN","C0CDAC2",131,0)
 S GBLD=$NA(^TMP("CCDA",$J,"BLDLIST"))
"RTN","C0CDAC2",132,0)
 S CCDAWORK=$NA(^TMP("CCDA",$J))
"RTN","C0CDAC2",133,0)
 S DFN=2
"RTN","C0CDAC2",134,0)
 D HEADER(GBLD,DFN,CCDAWORK)
"RTN","C0CDAC2",135,0)
 ; try building the document
"RTN","C0CDAC2",136,0)
 N CCDA S CCDA=$NA(@CCDAWORK@("XML"))
"RTN","C0CDAC2",137,0)
 D BUILD^MXMLTMPL(GBLD,CCDA)
"RTN","C0CDAC2",138,0)
 K @CCDA@(0)
"RTN","C0CDAC2",139,0)
 N GF S GF=$$FMDTOUTC^C0CDACU($$NOW^XLFDT)_"-HEADER-"_DFN_".xml"
"RTN","C0CDAC2",140,0)
 W $$GTF^%ZISH($na(@CCDA@(1)),4,$$TESTDIR^C0CDACZ(),GF)
"RTN","C0CDAC2",141,0)
 Q
"RTN","C0CDAC2",142,0)
 ;
"RTN","C0CDAC2",143,0)
SETORGV(ARY,ADUZ,ADUZ2) ; sets organization variables based on the DUZ
"RTN","C0CDAC2",144,0)
 ; ARY is passed by reference
"RTN","C0CDAC2",145,0)
 ; optional pass in the DUZ to use. otherwise the current DUZ is used
"RTN","C0CDAC2",146,0)
 ; ADUZ is the person to use ADUZ2 is the institution in DUZ(2) to use
"RTN","C0CDAC2",147,0)
 ;
"RTN","C0CDAC2",148,0)
 ;S ARY("orgOID")="2.16.840.1.113883.5.83" ; WORLDVISTA HL7 OID -
"RTN","C0CDAC2",149,0)
 S ARY("orgOID")=$$ORGOID^C0CDACU() ; look up the oid
"RTN","C0CDAC2",150,0)
 ; REPLACE WITH OROVILLE OID
"RTN","C0CDAC2",151,0)
 S ARY("docNumber")="10C3FBF4-D8EC-11E2-92F7-1708D1228400" ; make random
"RTN","C0CDAC2",152,0)
 S ARY("docNumber")=$$UUID^C0CDACU() ; random
"RTN","C0CDAC2",153,0)
 N UDUZ,UDUZ2
"RTN","C0CDAC2",154,0)
 I $G(ADUZ)="" D  ;
"RTN","C0CDAC2",155,0)
 . S UDUZ=DUZ ; use current DUZ values
"RTN","C0CDAC2",156,0)
 . S UDUZ2=$G(DUZ(2))
"RTN","C0CDAC2",157,0)
 E  D  ;
"RTN","C0CDAC2",158,0)
 . S UDUZ=$G(ADUZ)
"RTN","C0CDAC2",159,0)
 . S UDUZ2=$G(ADUZ2)
"RTN","C0CDAC2",160,0)
 I UDUZ2="" D  Q  ;
"RTN","C0CDAC2",161,0)
 . S PARMS("error")=$G(DUZ(2))_" INSTITUTION NOT KNOWN - EXITING"
"RTN","C0CDAC2",162,0)
 . W:$G(DEBUG) !,$G(DUZ(2))," INSTITUTION NOT KNOWN - EXITING"
"RTN","C0CDAC2",163,0)
 S ARY("orgName")=$$GET1^DIQ(4,UDUZ2_",",.01) ; org name from Institution file
"RTN","C0CDAC2",164,0)
 S ARY("orgState")=$$GET1^DIQ(4,UDUZ2_",",.02) ; 
"RTN","C0CDAC2",165,0)
 S ARY("orgCity")=$$GET1^DIQ(4,UDUZ2_",",1.03) ; 
"RTN","C0CDAC2",166,0)
 S ARY("orgZip")=$$GET1^DIQ(4,UDUZ2_",",1.04) ; 
"RTN","C0CDAC2",167,0)
 S ARY("orgAddr")=$$GET1^DIQ(4,UDUZ2_",",1.01) ; 
"RTN","C0CDAC2",168,0)
 S ARY("orgShortName")=$$GET1^DIQ(4,UDUZ2_",",.05) ; 
"RTN","C0CDAC2",169,0)
 S ARY("orgNPI")=$$GET1^DIQ(4,UDUZ2_",",41.99) ;
"RTN","C0CDAC2",170,0)
 I $G(ARY("orgNPI"))="" S ARY("orgNPI")="UNK" 
"RTN","C0CDAC2",171,0)
 S ARY("healthCareFacilityExtension")=UDUZ2_"^"_ARY("orgShortName")
"RTN","C0CDAC2",172,0)
 ; gpl astro
"RTN","C0CDAC2",173,0)
 N C0CTEL S C0CTEL=$$GET1^DIQ(4.03,"1,"_UDUZ2_",",.03)
"RTN","C0CDAC2",174,0)
 ;S ARY("orgTelephone")="tel:"_$$GET1^DIQ(4.03,"1,"_UDUZ2_",",.03)
"RTN","C0CDAC2",175,0)
 S ARY("orgTelephone")=$S(C0CTEL="":"",1:"tel:"_C0CTEL)
"RTN","C0CDAC2",176,0)
 ; end gpl astro
"RTN","C0CDAC2",177,0)
 N NAME S NAME=$P(^VA(200,UDUZ,0),U)
"RTN","C0CDAC2",178,0)
 D NAMECOMP^XLFNAME(.NAME)
"RTN","C0CDAC2",179,0)
 S ARY("assignedPersonGivenName")=NAME("GIVEN")
"RTN","C0CDAC2",180,0)
 S ARY("assignedPersonFamilyName")=NAME("FAMILY")
"RTN","C0CDAC2",181,0)
 S ARY("assignedPersonSuffix")=""
"RTN","C0CDAC2",182,0)
 I $G(NAME("SUFFIX"))'="" S ARY("assignedPersonSuffix")="<suffix>"_NAME("SUFFIX")_"</suffix>"
"RTN","C0CDAC2",183,0)
 S ARY("authorTime")=$$FMDTOUTC^C0CDACU($$NOW^XLFDT,"DT")
"RTN","C0CDAC2",184,0)
 Q
"RTN","C0CDAC2",185,0)
 ;
"RTN","C0CDAC2",186,0)
SETPATV(ARY) ; set patient variables
"RTN","C0CDAC2",187,0)
 ;
"RTN","C0CDAC2",188,0)
 ; this is the method that the extract uses for demographics
"RTN","C0CDAC2",189,0)
 ; we need to pull out the display text which is not included in
"RTN","C0CDAC2",190,0)
 ; the extract
"RTN","C0CDAC2",191,0)
 ;
"RTN","C0CDAC2",192,0)
 N VADM,VA,VAERR,X
"RTN","C0CDAC2",193,0)
 S X=+$$GETICN^MPIF001(DFN)
"RTN","C0CDAC2",194,0)
 D DEM^VADPT
"RTN","C0CDAC2",195,0)
 ;
"RTN","C0CDAC2",196,0)
 N VPRDEM,VPRDEM1
"RTN","C0CDAC2",197,0)
 D GETPAT^C0CDACE(.VPRDEM1,DFN,"demographics") ; to get codes
"RTN","C0CDAC2",198,0)
 S VPRDEM=$NA(VPRDEM1("results","demographics","patient"))
"RTN","C0CDAC2",199,0)
 ;
"RTN","C0CDAC2",200,0)
 I '$D(ARY("icn@value")) S ARY("icn@value")="UNK"
"RTN","C0CDAC2",201,0)
 S ARY("birthTime")=$$FMDTOUTC^C0CDACU(ARY("dob@value"))
"RTN","C0CDAC2",202,0)
 ; gpl astro
"RTN","C0CDAC2",203,0)
 N GNAME S GNAME=$G(@VPRDEM@("givenNames@value"))
"RTN","C0CDAC2",204,0)
 ;I GNAME[" " D  ; there is a middle name
"RTN","C0CDAC2",205,0)
 D  ;
"RTN","C0CDAC2",206,0)
 . S ARY("given1")=""
"RTN","C0CDAC2",207,0)
 . S ARY("given2")=""
"RTN","C0CDAC2",208,0)
 . S ARY("given1")=$P(GNAME," ",1)
"RTN","C0CDAC2",209,0)
 . S ARY("given2")=$P(GNAME," ",2)
"RTN","C0CDAC2",210,0)
 . ;S ARY("suffix")=""
"RTN","C0CDAC2",211,0)
 . I $E(GNAME,$L(GNAME)-1,$L(GNAME))="JR" S VARS2("suffix")="<suffix>JR</suffix>"
"RTN","C0CDAC2",212,0)
 . I $E(GNAME,$L(GNAME)-1,$L(GNAME))="SR" S VARS2("suffix")="<suffix>SR</suffix>"
"RTN","C0CDAC2",213,0)
 . ;
"RTN","C0CDAC2",214,0)
 . ; previous name
"RTN","C0CDAC2",215,0)
 . S VARS2("previousName")=""
"RTN","C0CDAC2",216,0)
 . I $D(@VPRDEM@("aliases")) D  ;
"RTN","C0CDAC2",217,0)
 . . N PREVFAM,PREVGIVN
"RTN","C0CDAC2",218,0)
 . . S PREVFAM=$G(@VPRDEM@("aliases","alias@familyName"))
"RTN","C0CDAC2",219,0)
 . . S PREVGIVN=$G(@VPRDEM@("aliases","alias@givenNames"))
"RTN","C0CDAC2",220,0)
 . . S VARS2("previousName")="<name><given qualifier=""BR"">"_PREVGIVN_"</given><family qualifier=""BR"">"_PREVFAM_"</family></name>"
"RTN","C0CDAC2",221,0)
 . ; <name> <given qualifier="BR">Alicia</given> <given>Jones</given> <family qualifier="BR">Newman</family></name>
"RTN","C0CDAC2",222,0)
 . ;
"RTN","C0CDAC2",223,0)
 . N TELE S TELE=$G(@VPRDEM@("telecomList","telecom@value"))
"RTN","C0CDAC2",224,0)
 . I TELE'="" D  ;
"RTN","C0CDAC2",225,0)
 . . S VARS2("tele")=""
"RTN","C0CDAC2",226,0)
 . . N TELEN S TELEN=$G(@VPRDEM@("telecomList","telecom@value"))
"RTN","C0CDAC2",227,0)
 . . N TELEU S TELEU=$G(@VPRDEM@("telecomList","telecom@usageType"))
"RTN","C0CDAC2",228,0)
 . . I TELEU'="" S VARS2("tele")=VARS2("tele")_"<telecom use="""_TELEU_""" value=""tel:+1-"_TELEN_"""/>"
"RTN","C0CDAC2",229,0)
 . . E  S VARS2("tele")=VARS2("tele")_"<telecom value=""tel:+1-"_TELEN_"""/>"
"RTN","C0CDAC2",230,0)
 . I TELE="" D  ;
"RTN","C0CDAC2",231,0)
 . . S TELE=$G(@VPRDEM@("telecomList",1,"telecom@value"))
"RTN","C0CDAC2",232,0)
 . . I TELE="" Q  ;
"RTN","C0CDAC2",233,0)
 . . S VARS2("tele")=""
"RTN","C0CDAC2",234,0)
 . . N TELEI S TELEI=0
"RTN","C0CDAC2",235,0)
 . . F  S TELEI=$O(@VPRDEM@("telecomList",TELEI)) Q:+TELEI=0  D  ;
"RTN","C0CDAC2",236,0)
 . . . N TELEN S TELEN=$G(@VPRDEM@("telecomList",TELEI,"telecom@value"))
"RTN","C0CDAC2",237,0)
 . . . N TELEU S TELEU=$G(@VPRDEM@("telecomList",TELEI,"telecom@usageType"))
"RTN","C0CDAC2",238,0)
 . . . I TELEU'="" S VARS2("tele")=VARS2("tele")_"<telecom use="""_TELEU_""" value=""tel:+1-"_TELEN_"""/>"
"RTN","C0CDAC2",239,0)
 . . . E  S VARS2("tele")=VARS2("tele")_"<telecom value=""tel:+1-"_TELEN_"""/>"
"RTN","C0CDAC2",240,0)
 . . . ;M ^gpl("TELEN")=TELEN
"RTN","C0CDAC2",241,0)
 . . . ;M ^gpl("TELEU")=TELEU
"RTN","C0CDAC2",242,0)
 . ;M ^gpl("TELE")=TELE
"RTN","C0CDAC2",243,0)
 . ;M ^gpl("VARS2")=VARS2
"RTN","C0CDAC2",244,0)
 . ;M ^gpl("DEM")=@VPRDEM
"RTN","C0CDAC2",245,0)
 ; end gpl astro
"RTN","C0CDAC2",246,0)
 ;S ARY("maritalCode")=$P(VADM(10),U,1)
"RTN","C0CDAC2",247,0)
 N MARCD
"RTN","C0CDAC2",248,0)
 S MARCD=$G(@VPRDEM@("maritalStatus@value"))
"RTN","C0CDAC2",249,0)
 I MARCD="S" S MARCD="L" ; legally separated
"RTN","C0CDAC2",250,0)
 I MARCD="N" S MARCD="S" ; never married
"RTN","C0CDAC2",251,0)
 ;
"RTN","C0CDAC2",252,0)
 ; Here is the value set 2.16.840.1.113883.1.11.12212 for marital status
"RTN","C0CDAC2",253,0)
 ;
"RTN","C0CDAC2",254,0)
 ;  A	Annulled
"RTN","C0CDAC2",255,0)
 ;  D	Divorced
"RTN","C0CDAC2",256,0)
 ;  T	Domestic partner
"RTN","C0CDAC2",257,0)
 ;  I	Interlocutory	
"RTN","C0CDAC2",258,0)
 ;  L	Legally Separated
"RTN","C0CDAC2",259,0)
 ;  M	Married	
"RTN","C0CDAC2",260,0)
 ;  S	Never Married
"RTN","C0CDAC2",261,0)
 ;  P	Polygamous	
"RTN","C0CDAC2",262,0)
 ;  W	Widowed
"RTN","C0CDAC2",263,0)
 ;
"RTN","C0CDAC2",264,0)
 S ARY("maritalCode")=MARCD
"RTN","C0CDAC2",265,0)
 S ARY("maritalText")=$P(VADM(10),U,2)
"RTN","C0CDAC2",266,0)
 S ARY("religionCode")=$P(VADM(9),U,1)
"RTN","C0CDAC2",267,0)
 S ARY("religionName")=$P(VADM(9),U,2)
"RTN","C0CDAC2",268,0)
 ;S ARY("raceCode")=$P($G(VADM(12,1)),U,1)
"RTN","C0CDAC2",269,0)
 S ARY("raceCode")=$G(@VPRDEM@("races","race@value"))
"RTN","C0CDAC2",270,0)
 ; astro gpl
"RTN","C0CDAC2",271,0)
 I ARY("raceCode")="" D  ;
"RTN","C0CDAC2",272,0)
 . NEW tmprace
"RTN","C0CDAC2",273,0)
 . S tmprace=$G(@VPRDEM@("races",1,"race@value"))
"RTN","C0CDAC2",274,0)
 . IF $l($$MAP^KBAIQLDM(tmprace,"race"))>3 S ARY("raceCode")=tmprace quit  ;
"RTN","C0CDAC2",275,0)
 . S tmprace=$G(@VPRDEM@("races",2,"race@value"))
"RTN","C0CDAC2",276,0)
 . IF $l($$MAP^KBAIQLDM(tmprace,"race"))>3 S ARY("raceCode")=tmprace quit  ;
"RTN","C0CDAC2",277,0)
 I $P($G(VADM(12,1)),U,2)="WHITE, NOT OF HISPANIC ORIGIN" S ARY("raceCode")="2106-3" ; this code was left out of the Race file on most systems
"RTN","C0CDAC2",278,0)
 I ARY("raceCode")="" S ARY("raceName")="UNK"
"RTN","C0CDAC2",279,0)
 E  S ARY("raceName")=$P($G(VADM(12,1)),U,2)_" ("_$P($G(VADM(12,1,1)),U,2)_")"
"RTN","C0CDAC2",280,0)
 ;S ARY("ethnicCode")=$P($G(VADM(11,1)),U,1)
"RTN","C0CDAC2",281,0)
 S ARY("ethnicCode")=$G(@VPRDEM@("ethnicities","ethnicity@value"))
"RTN","C0CDAC2",282,0)
 I ARY("ethnicCode")="" S ARY("ethnicName")="UNK"
"RTN","C0CDAC2",283,0)
 E  D  ;
"RTN","C0CDAC2",284,0)
 . N ETHHOW S ETHHOW=$G(VADM(11,1,1))
"RTN","C0CDAC2",285,0)
 . I ETHHOW="" S ARY("ethnicName")=$P(VADM(11,1),U,2)
"RTN","C0CDAC2",286,0)
 . E  S ARY("ethnicName")=$P(VADM(11,1),U,2)_" ("_$P(ETHHOW,U,2)_")"
"RTN","C0CDAC2",287,0)
 N LANG S LANG=$$GET1^DIQ(2,DFN_",",256000) ; name of language
"RTN","C0CDAC2",288,0)
 N LPRM ; language lookup parameters
"RTN","C0CDAC2",289,0)
 N LCDE,LRTN ; 
"RTN","C0CDAC2",290,0)
 S LPRM("table")="Primary Language"
"RTN","C0CDAC2",291,0)
 S LPRM("name")=LANG
"RTN","C0CDAC2",292,0)
 D LOOKUP^C0CDACU(.LRTN,.LPRM)
"RTN","C0CDAC2",293,0)
 S LCDE=$G(LRTN("code"))
"RTN","C0CDAC2",294,0)
 I LCDE="" S LCDE="en-US"
"RTN","C0CDAC2",295,0)
 S ARY("languageCode")=LCDE
"RTN","C0CDAC2",296,0)
 ;S ARY("languageCode")="eng" ; used to be hardcoded to english
"RTN","C0CDAC2",297,0)
 ;S ARY("encompassingEncounterEffectiveTime")=$$FMDTOUTC^C0CDACU(ARY("facilities.facility@latestDate"))
"RTN","C0CDAC2",298,0)
 N C2I S C2I=""
"RTN","C0CDAC2",299,0)
 F  S C2I=$O(ARY(C2I)) Q:C2I=""  D  ;
"RTN","C0CDAC2",300,0)
 . I C2I="assignedPersonSuffix" Q  
"RTN","C0CDAC2",301,0)
 . I ARY(C2I)="" S ARY(C2I)="UNK"
"RTN","C0CDAC2",302,0)
 Q
"RTN","C0CDAC2",303,0)
 ;
"RTN","C0CDAC2",304,0)
 ;;<religiousAffiliationCode code="@@religionCode@@" displayName="@@religionName@@" codeSystem="2.16.840.1.113883.5.1076" codeSystemName="ReligiousAffiliation"/>
"RTN","C0CDAC2",305,0)
THEADER ;
"RTN","C0CDAC2",306,0)
 ;;<?xml version="1.0" encoding="utf-8" ?>
"RTN","C0CDAC2",307,0)
 ;;<?xml-stylesheet type="text/xsl" href="CDA.xsl"?>
"RTN","C0CDAC2",308,0)
 ;;<ClinicalDocument classCode="DOCCLIN" moodCode="EVN" xmlns="urn:hl7-org:v3" xmlns:sdtc="urn:hl7-org:sdtc" xmlns:voc="urn:hl7-org:v3/voc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:hl7-org:v3 CDASchemas\cda\Schemas\CDA.xsd">
"RTN","C0CDAC2",309,0)
 ;;<realmCode code="US"></realmCode>
"RTN","C0CDAC2",310,0)
 ;;<typeId extension="POCD_HD000040" root="2.16.840.1.113883.1.3"></typeId>
"RTN","C0CDAC2",311,0)
 ;;<!-- US Realm Header -->
"RTN","C0CDAC2",312,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.1.1" extension="2015-08-01"/>
"RTN","C0CDAC2",313,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.1.1"/>
"RTN","C0CDAC2",314,0)
 ;;    <!-- CCD -->
"RTN","C0CDAC2",315,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.1.2" extension="2015-08-01"/>
"RTN","C0CDAC2",316,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.1.2"/>
"RTN","C0CDAC2",317,0)
 ;;<id extension="@@docNumber@@" root="@@orgOID@@"></id>
"RTN","C0CDAC2",318,0)
 ;;<code code="34133-9" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Summarization of Episode Note"></code>
"RTN","C0CDAC2",319,0)
 ;;<title>Test Clinic Summarization of Episode Note</title>
"RTN","C0CDAC2",320,0)
 ;;<effectiveTime value="@@docCreated@@"></effectiveTime>
"RTN","C0CDAC2",321,0)
 ;;<confidentialityCode code="N" codeSystem="2.16.840.1.113883.5.25" codeSystemName="Confidentiality" displayName="Normal"></confidentialityCode>
"RTN","C0CDAC2",322,0)
 ;;<languageCode code="en-US"></languageCode>
"RTN","C0CDAC2",323,0)
 ;;<recordTarget contextControlCode="OP" typeCode="RCT">
"RTN","C0CDAC2",324,0)
 ;;<patientRole classCode="PAT">
"RTN","C0CDAC2",325,0)
 ;;<id extension="@@icn@value@@" root="@@orgOID@@"></id>
"RTN","C0CDAC2",326,0)
 ;;<id extension="@@id@value@@" root="@@orgOID@@.2.2"></id>
"RTN","C0CDAC2",327,0)
 ;;<addr>
"RTN","C0CDAC2",328,0)
 ;;<country>US</country>
"RTN","C0CDAC2",329,0)
 ;;<state>@@address@stateProvince@@</state>
"RTN","C0CDAC2",330,0)
 ;;<city>@@address@city@@</city>
"RTN","C0CDAC2",331,0)
 ;;<postalCode>@@address@postalCode@@</postalCode>
"RTN","C0CDAC2",332,0)
 ;;<streetAddressLine>@@address@streetLine1@@</streetAddressLine>
"RTN","C0CDAC2",333,0)
 ;;</addr>
"RTN","C0CDAC2",334,0)
 ;;@@tele@@
"RTN","C0CDAC2",335,0)
 ;;<patient classCode="PSN" determinerCode="INSTANCE">
"RTN","C0CDAC2",336,0)
 ;;<name>
"RTN","C0CDAC2",337,0)
 ;;<family>@@familyName@value@@</family>
"RTN","C0CDAC2",338,0)
 ;;<given>@@given1@@</given>
"RTN","C0CDAC2",339,0)
 ;;<given>@@given2@@</given>
"RTN","C0CDAC2",340,0)
 ;;</name>
"RTN","C0CDAC2",341,0)
 ;;@@previousName@@
"RTN","C0CDAC2",342,0)
 ;;<administrativeGenderCode code="@@gender@value@@" codeSystem="2.16.840.1.113883.5.1" codeSystemName="AdministrativeGender" displayName="@@gender@value@@"></administrativeGenderCode>
"RTN","C0CDAC2",343,0)
 ;;<birthTime value="@@birthTime@@"/>
"RTN","C0CDAC2",344,0)
 ;;<maritalStatusCode code="@@maritalCode@@" displayName="@@maritalText@@" codeSystem="2.16.840.1.113883.5.2" codeSystemName="MaritalStatus"/>
"RTN","C0CDAC2",345,0)
 ;;<religiousAffiliationCode nullFlavor="UNK" />
"RTN","C0CDAC2",346,0)
 ;;<raceCode code="@@raceCode@@" displayName="@@raceName@@" codeSystem="2.16.840.1.113883.6.238" codeSystemName="OMB Standards for Race and Ethnicity"/>
"RTN","C0CDAC2",347,0)
 ;;<sdtc:raceCode code="2108-9" codeSystem="2.16.840.1.113883.6.238" displayName="White European" codeSystemName="OMB Standards for Race and Ethnicity"/>
"RTN","C0CDAC2",348,0)
 ;;<ethnicGroupCode code="@@ethnicCode@@" displayName="@@ethnicName@@" codeSystem="2.16.840.1.113883.6.238" codeSystemName="OMB Standards for Race and Ethnicity"/>
"RTN","C0CDAC2",349,0)
 ;;<languageCommunication>
"RTN","C0CDAC2",350,0)
 ;;<!-- CONF 5407: LanguageCode Code System 2.16.840.1.113883.1.11.11526 -->
"RTN","C0CDAC2",351,0)
 ;;<languageCode code="@@languageCode@@"/>
"RTN","C0CDAC2",352,0)
 ;;<modeCode code="ESP" displayName="Expressed spoken" codeSystem="2.16.840.1.113883.5.60" codeSystemName="LanguageAbilityMode"/>
"RTN","C0CDAC2",353,0)
 ;;</languageCommunication>
"RTN","C0CDAC2",354,0)
 ;;</patient>
"RTN","C0CDAC2",355,0)
 ;;</patientRole>
"RTN","C0CDAC2",356,0)
 ;;</recordTarget>
"RTN","C0CDAC2",357,0)
 Q
"RTN","C0CDAC2",358,0)
 ;
"RTN","C0CDAC2",359,0)
THEADER2 ; astro gpl - added second raceCode - need to generalize
"RTN","C0CDAC2",360,0)
 ;;<?xml version="1.0" encoding="utf-8" ?>
"RTN","C0CDAC2",361,0)
 ;;<?xml-stylesheet type="text/xsl" href="CDA.xsl"?>
"RTN","C0CDAC2",362,0)
 ;;<ClinicalDocument classCode="DOCCLIN" moodCode="EVN" xmlns="urn:hl7-org:v3" xmlns:sdtc="urn:hl7-org:sdtc" xmlns:voc="urn:hl7-org:v3/voc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:hl7-org:v3 CDASchemas\cda\Schemas\CDA.xsd">
"RTN","C0CDAC2",363,0)
 ;;<realmCode code="US"></realmCode>
"RTN","C0CDAC2",364,0)
 ;;<typeId extension="POCD_HD000040" root="2.16.840.1.113883.1.3"></typeId>
"RTN","C0CDAC2",365,0)
 ;;<!-- US Realm Header -->
"RTN","C0CDAC2",366,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.1.1" extension="2015-08-01"/>
"RTN","C0CDAC2",367,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.1.1"/>
"RTN","C0CDAC2",368,0)
 ;;    <!-- CCD -->
"RTN","C0CDAC2",369,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.1.2" extension="2015-08-01"/>
"RTN","C0CDAC2",370,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.1.2"/>
"RTN","C0CDAC2",371,0)
 ;;<id extension="@@docNumber@@" root="@@orgOID@@"></id>
"RTN","C0CDAC2",372,0)
 ;;<code code="34133-9" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Summarization of Episode Note"></code>
"RTN","C0CDAC2",373,0)
 ;;<title>Test Clinic Summarization of Episode Note</title>
"RTN","C0CDAC2",374,0)
 ;;<effectiveTime value="@@docCreated@@"></effectiveTime>
"RTN","C0CDAC2",375,0)
 ;;<confidentialityCode code="N" codeSystem="2.16.840.1.113883.5.25" codeSystemName="Confidentiality" displayName="Normal"></confidentialityCode>
"RTN","C0CDAC2",376,0)
 ;;<languageCode code="en-US"></languageCode>
"RTN","C0CDAC2",377,0)
 ;;<recordTarget contextControlCode="OP" typeCode="RCT">
"RTN","C0CDAC2",378,0)
 ;;<patientRole classCode="PAT">
"RTN","C0CDAC2",379,0)
 ;;<id extension="@@icn@value@@" root="@@orgOID@@"></id>
"RTN","C0CDAC2",380,0)
 ;;<id extension="@@id@value@@" root="@@orgOID@@.2.2"></id>
"RTN","C0CDAC2",381,0)
 ;;<addr>
"RTN","C0CDAC2",382,0)
 ;;<country>US</country>
"RTN","C0CDAC2",383,0)
 ;;<state>@@address@stateProvince@@</state>
"RTN","C0CDAC2",384,0)
 ;;<city>@@address@city@@</city>
"RTN","C0CDAC2",385,0)
 ;;<postalCode>@@address@postalCode@@</postalCode>
"RTN","C0CDAC2",386,0)
 ;;<streetAddressLine>@@address@streetLine1@@</streetAddressLine>
"RTN","C0CDAC2",387,0)
 ;;</addr>
"RTN","C0CDAC2",388,0)
 ;;@@tele@@
"RTN","C0CDAC2",389,0)
 ;;<patient classCode="PSN" determinerCode="INSTANCE">
"RTN","C0CDAC2",390,0)
;;<name>
"RTN","C0CDAC2",391,0)
 ;;<family>@@familyName@value@@</family>
"RTN","C0CDAC2",392,0)
 ;;<given>@@given1@@</given>
"RTN","C0CDAC2",393,0)
 ;;<given>@@given2@@</given>
"RTN","C0CDAC2",394,0)
 ;;</name>
"RTN","C0CDAC2",395,0)
 ;;@@previousName@@
"RTN","C0CDAC2",396,0)
 ;;<administrativeGenderCode code="@@gender@value@@" codeSystem="2.16.840.1.113883.5.1" codeSystemName="AdministrativeGender" displayName="@@gender@value@@"></administrativeGenderCode>
"RTN","C0CDAC2",397,0)
 ;;<birthTime value="@@birthTime@@"/>
"RTN","C0CDAC2",398,0)
 ;;<maritalStatusCode code="@@maritalCode@@" displayName="@@maritalText@@" codeSystem="2.16.840.1.113883.5.2" codeSystemName="MaritalStatus"/>
"RTN","C0CDAC2",399,0)
 ;;<religiousAffiliationCode nullFlavor="UNK" />
"RTN","C0CDAC2",400,0)
 ;;<raceCode code="@@raceCode@@" displayName="@@raceName@@" codeSystem="2.16.840.1.113883.6.238" codeSystemName="OMB Standards for Race and Ethnicity"/>
"RTN","C0CDAC2",401,0)
 ;;<sdtc:raceCode code="2108-9" codeSystem="2.16.840.1.113883.6.238" displayName="White European" codeSystemName="OMB Standards for Race and Ethnicity"/>
"RTN","C0CDAC2",402,0)
 ;;<ethnicGroupCode code="@@ethnicCode@@" displayName="@@ethnicName@@" codeSystem="2.16.840.1.113883.6.238" codeSystemName="OMB Standards for Race and Ethnicity"/>
"RTN","C0CDAC2",403,0)
 ;;<languageCommunication>
"RTN","C0CDAC2",404,0)
 ;;<!-- CONF 5407: LanguageCode Code System 2.16.840.1.113883.1.11.11526 -->
"RTN","C0CDAC2",405,0)
 ;;<languageCode code="@@languageCode@@"/>
"RTN","C0CDAC2",406,0)
 ;;<modeCode code="ESP" displayName="Expressed spoken" codeSystem="2.16.840.1.113883.5.60" codeSystemName="LanguageAbilityMode"/>
"RTN","C0CDAC2",407,0)
 ;;</languageCommunication>
"RTN","C0CDAC2",408,0)
 ;;</patient>
"RTN","C0CDAC2",409,0)
 ;;</patientRole>
"RTN","C0CDAC2",410,0)
 ;;</recordTarget>
"RTN","C0CDAC2",411,0)
 Q
"RTN","C0CDAC2",412,0)
 ;
"RTN","C0CDAC2",413,0)
THEADER3 ; for patients with unknown race and ethnicity codes
"RTN","C0CDAC2",414,0)
 ;;<?xml version="1.0" encoding="utf-8" ?>
"RTN","C0CDAC2",415,0)
 ;;<?xml-stylesheet type="text/xsl" href="CDA.xsl"?>
"RTN","C0CDAC2",416,0)
 ;;<ClinicalDocument classCode="DOCCLIN" moodCode="EVN" xmlns="urn:hl7-org:v3" xmlns:sdtc="urn:hl7-org:sdtc" xmlns:voc="urn:hl7-org:v3/voc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:hl7-org:v3 CDASchemas\cda\Schemas\CDA.xsd">
"RTN","C0CDAC2",417,0)
 ;;<realmCode code="US"></realmCode>
"RTN","C0CDAC2",418,0)
 ;;<typeId extension="POCD_HD000040" root="2.16.840.1.113883.1.3"></typeId>
"RTN","C0CDAC2",419,0)
 ;;<!-- US Realm Header -->
"RTN","C0CDAC2",420,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.1.1" extension="2015-08-01"/>
"RTN","C0CDAC2",421,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.1.1"/>
"RTN","C0CDAC2",422,0)
 ;;    <!-- CCD -->
"RTN","C0CDAC2",423,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.1.2" extension="2015-08-01"/>
"RTN","C0CDAC2",424,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.1.2"/>
"RTN","C0CDAC2",425,0)
 ;;<id extension="@@docNumber@@" root="@@orgOID@@"></id>
"RTN","C0CDAC2",426,0)
 ;;<code code="34133-9" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Summarization of Episode Note"></code>
"RTN","C0CDAC2",427,0)
 ;;<title>Test Clinic Summarization of Episode Note</title>
"RTN","C0CDAC2",428,0)
 ;;<effectiveTime value="@@docCreated@@"></effectiveTime>
"RTN","C0CDAC2",429,0)
 ;;<confidentialityCode code="N" codeSystem="2.16.840.1.113883.5.25" codeSystemName="Confidentiality" displayName="Normal"></confidentialityCode>
"RTN","C0CDAC2",430,0)
 ;;<languageCode code="en-US"></languageCode>
"RTN","C0CDAC2",431,0)
 ;;<recordTarget contextControlCode="OP" typeCode="RCT">
"RTN","C0CDAC2",432,0)
 ;;<patientRole classCode="PAT">
"RTN","C0CDAC2",433,0)
 ;;<id extension="@@icn@value@@" root="@@orgOID@@"></id>
"RTN","C0CDAC2",434,0)
 ;;<id extension="@@id@value@@" root="@@orgOID@@.2.2"></id>
"RTN","C0CDAC2",435,0)
 ;;<addr>
"RTN","C0CDAC2",436,0)
 ;;<country>US</country>
"RTN","C0CDAC2",437,0)
 ;;<state>@@address@stateProvince@@</state>
"RTN","C0CDAC2",438,0)
 ;;<city>@@address@city@@</city>
"RTN","C0CDAC2",439,0)
 ;;<postalCode>@@address@postalCode@@</postalCode>
"RTN","C0CDAC2",440,0)
 ;;<streetAddressLine>@@address@streetLine1@@</streetAddressLine>
"RTN","C0CDAC2",441,0)
 ;;</addr>
"RTN","C0CDAC2",442,0)
 ;;@@tele@@
"RTN","C0CDAC2",443,0)
 ;;<patient classCode="PSN" determinerCode="INSTANCE">
"RTN","C0CDAC2",444,0)
 ;;<name>
"RTN","C0CDAC2",445,0)
 ;;<family>@@familyName@value@@</family>
"RTN","C0CDAC2",446,0)
 ;;<given>@@given1@@</given>
"RTN","C0CDAC2",447,0)
 ;;<given>@@given2@@</given>
"RTN","C0CDAC2",448,0)
 ;;@@suffix@@
"RTN","C0CDAC2",449,0)
 ;;</name>
"RTN","C0CDAC2",450,0)
 ;;@@previousName@@
"RTN","C0CDAC2",451,0)
 ;;<administrativeGenderCode code="@@gender@value@@" codeSystem="2.16.840.1.113883.5.1" codeSystemName="AdministrativeGender" displayName="@@gender@value@@"></administrativeGenderCode>
"RTN","C0CDAC2",452,0)
 ;;<birthTime value="@@birthTime@@"/>
"RTN","C0CDAC2",453,0)
 ;;<maritalStatusCode code="@@maritalCode@@" displayName="@@maritalText@@" codeSystem="2.16.840.1.113883.5.2" codeSystemName="MaritalStatus"/>
"RTN","C0CDAC2",454,0)
 ;;<religiousAffiliationCode nullFlavor="UNK" />
"RTN","C0CDAC2",455,0)
 ;;<raceCode nullFlavor="UNK" />
"RTN","C0CDAC2",456,0)
 ;;<ethnicGroupCode nullFlavor="UNK" />
"RTN","C0CDAC2",457,0)
 ;;<languageCommunication>
"RTN","C0CDAC2",458,0)
 ;;<!-- CONF 5407: LanguageCode Code System 2.16.840.1.113883.1.11.11526 -->
"RTN","C0CDAC2",459,0)
 ;;<languageCode code="@@languageCode@@"/>
"RTN","C0CDAC2",460,0)
 ;;<modeCode code="ESP" displayName="Expressed spoken" codeSystem="2.16.840.1.113883.5.60" codeSystemName="LanguageAbilityMode"/>
"RTN","C0CDAC2",461,0)
 ;;</languageCommunication>
"RTN","C0CDAC2",462,0)
 ;;</patient>
"RTN","C0CDAC2",463,0)
 ;;</patientRole>
"RTN","C0CDAC2",464,0)
 ;;</recordTarget>
"RTN","C0CDAC2",465,0)
 Q
"RTN","C0CDAC2",466,0)
 ;
"RTN","C0CDAC2",467,0)
 ; removed
"RTN","C0CDAC2",468,0)
 ;;<religiousAffiliationCode code="@@religionCode@@" displayName="@@religionName@@" codeSystem="2.16.840.1.113883.5.1076" codeSystemName="ReligiousAffiliation"/>
"RTN","C0CDAC2",469,0)
 ;
"RTN","C0CDAC2",470,0)
TAUTHOR ;
"RTN","C0CDAC2",471,0)
 ;;<author>
"RTN","C0CDAC2",472,0)
 ;;<time value='@@authorTime@@'></time>
"RTN","C0CDAC2",473,0)
 ;;<assignedAuthor classCode="ASSIGNED">
"RTN","C0CDAC2",474,0)
 ;;<id nullFlavor="NI"/>
"RTN","C0CDAC2",475,0)
 ;;<addr nullFlavor="NI"/>
"RTN","C0CDAC2",476,0)
 ;;<telecom nullFlavor="NI"/>
"RTN","C0CDAC2",477,0)
 ;;<assignedAuthoringDevice>
"RTN","C0CDAC2",478,0)
 ;;<manufacturerModelName>WorldVistA</manufacturerModelName>
"RTN","C0CDAC2",479,0)
 ;;<softwareName>Opensource CDA Documents Generator</softwareName>
"RTN","C0CDAC2",480,0)
 ;;</assignedAuthoringDevice>
"RTN","C0CDAC2",481,0)
 ;;<representedOrganization>
"RTN","C0CDAC2",482,0)
 ;;<id extension="3" root="1.3.6.1.4.1.22812.11.99930.3"/>
"RTN","C0CDAC2",483,0)
 ;;<name>Local Community Hospital</name>
"RTN","C0CDAC2",484,0)
 ;;<telecom value="tel:+1-(555)555-1014"/>
"RTN","C0CDAC2",485,0)
 ;;<addr>
"RTN","C0CDAC2",486,0)
 ;;<streetAddressLine>4444 Hospital Way</streetAddressLine>
"RTN","C0CDAC2",487,0)
 ;;<city>Portland</city>
"RTN","C0CDAC2",488,0)
 ;;<state>OR</state>
"RTN","C0CDAC2",489,0)
 ;;<postalCode>97005</postalCode>
"RTN","C0CDAC2",490,0)
 ;;<country>US</country>
"RTN","C0CDAC2",491,0)
 ;;</addr>
"RTN","C0CDAC2",492,0)
 ;;</representedOrganization>
"RTN","C0CDAC2",493,0)
 ;;</assignedAuthor>
"RTN","C0CDAC2",494,0)
 ;;</author>
"RTN","C0CDAC2",495,0)
 ;;<custodian>
"RTN","C0CDAC2",496,0)
 ;;<assignedCustodian classCode="ASSIGNED">
"RTN","C0CDAC2",497,0)
 ;;<representedCustodianOrganization classCode="ORG" determinerCode="INSTANCE">
"RTN","C0CDAC2",498,0)
 ;;<id extension="CDA" root="@@orgOID@@"></id>
"RTN","C0CDAC2",499,0)
 ;;<name>@@orgName@@</name>
"RTN","C0CDAC2",500,0)
 ;;<telecom use="WP" value="@@orgTelephone@@"></telecom>
"RTN","C0CDAC2",501,0)
 ;;<addr>
"RTN","C0CDAC2",502,0)
 ;;<state>@@orgState@@</state>
"RTN","C0CDAC2",503,0)
 ;;<city>@@orgCity@@</city>
"RTN","C0CDAC2",504,0)
 ;;<postalCode>@@orgZip@@</postalCode>
"RTN","C0CDAC2",505,0)
 ;;<streetAddressLine>@@orgAddr@@</streetAddressLine>
"RTN","C0CDAC2",506,0)
 ;;</addr>
"RTN","C0CDAC2",507,0)
 ;;</representedCustodianOrganization>
"RTN","C0CDAC2",508,0)
 ;;</assignedCustodian>
"RTN","C0CDAC2",509,0)
 ;;</custodian>
"RTN","C0CDAC2",510,0)
 Q
"RTN","C0CDAC2",511,0)
 ;
"RTN","C0CDAC2",512,0)
TAUTHOR2 ; putting addresses and phone numbers in all 3 author slots
"RTN","C0CDAC2",513,0)
 ;;<author>
"RTN","C0CDAC2",514,0)
 ;;<time value='@@authorTime@@'></time>
"RTN","C0CDAC2",515,0)
 ;;<assignedAuthor classCode="ASSIGNED">
"RTN","C0CDAC2",516,0)
 ;;<id nullFlavor="NI"/>
"RTN","C0CDAC2",517,0)
 ;;<addr>
"RTN","C0CDAC2",518,0)
 ;;<state>@@orgState@@</state>
"RTN","C0CDAC2",519,0)
 ;;<city>@@orgCity@@</city>
"RTN","C0CDAC2",520,0)
 ;;<postalCode>@@orgZip@@</postalCode>
"RTN","C0CDAC2",521,0)
 ;;<streetAddressLine>@@orgAddr@@</streetAddressLine>
"RTN","C0CDAC2",522,0)
 ;;</addr>
"RTN","C0CDAC2",523,0)
 ;;<telecom use="WP" value="@@orgTelephone@@"></telecom>
"RTN","C0CDAC2",524,0)
 ;;<assignedAuthoringDevice>
"RTN","C0CDAC2",525,0)
 ;;<manufacturerModelName>WorldVistA</manufacturerModelName>
"RTN","C0CDAC2",526,0)
 ;;<softwareName>Opensource CDA Documents Generator</softwareName>
"RTN","C0CDAC2",527,0)
 ;;</assignedAuthoringDevice>
"RTN","C0CDAC2",528,0)
 ;;<representedOrganization>
"RTN","C0CDAC2",529,0)
 ;;<id extension="3" root="1.3.6.1.4.1.22812.11.99930.3"/>
"RTN","C0CDAC2",530,0)
 ;;<name>@@orgName@@</name>
"RTN","C0CDAC2",531,0)
 ;;<telecom use="WP" value="@@orgTelephone@@"></telecom>
"RTN","C0CDAC2",532,0)
 ;;<addr>
"RTN","C0CDAC2",533,0)
 ;;<state>@@orgState@@</state>
"RTN","C0CDAC2",534,0)
 ;;<city>@@orgCity@@</city>
"RTN","C0CDAC2",535,0)
 ;;<postalCode>@@orgZip@@</postalCode>
"RTN","C0CDAC2",536,0)
 ;;<streetAddressLine>@@orgAddr@@</streetAddressLine>
"RTN","C0CDAC2",537,0)
 ;;</addr>
"RTN","C0CDAC2",538,0)
 ;;</representedOrganization>
"RTN","C0CDAC2",539,0)
 ;;</assignedAuthor>
"RTN","C0CDAC2",540,0)
 ;;</author>
"RTN","C0CDAC2",541,0)
 ;;<custodian>
"RTN","C0CDAC2",542,0)
 ;;<assignedCustodian classCode="ASSIGNED">
"RTN","C0CDAC2",543,0)
 ;;<representedCustodianOrganization classCode="ORG" determinerCode="INSTANCE">
"RTN","C0CDAC2",544,0)
 ;;<id extension="CDA" root="@@orgOID@@"></id>
"RTN","C0CDAC2",545,0)
 ;;<name>@@orgName@@</name>
"RTN","C0CDAC2",546,0)
 ;;<telecom use="WP" value="@@orgTelephone@@"></telecom>
"RTN","C0CDAC2",547,0)
 ;;<addr>
"RTN","C0CDAC2",548,0)
 ;;<state>@@orgState@@</state>
"RTN","C0CDAC2",549,0)
 ;;<city>@@orgCity@@</city>
"RTN","C0CDAC2",550,0)
 ;;<postalCode>@@orgZip@@</postalCode>
"RTN","C0CDAC2",551,0)
 ;;<streetAddressLine>@@orgAddr@@</streetAddressLine>
"RTN","C0CDAC2",552,0)
 ;;</addr>
"RTN","C0CDAC2",553,0)
 ;;</representedCustodianOrganization>
"RTN","C0CDAC2",554,0)
 ;;</assignedCustodian>
"RTN","C0CDAC2",555,0)
 ;;</custodian>
"RTN","C0CDAC2",556,0)
 Q
"RTN","C0CDAC2",557,0)
 ;
"RTN","C0CDAC2",558,0)
TDOCOF ;
"RTN","C0CDAC2",559,0)
 ;;<documentationOf>
"RTN","C0CDAC2",560,0)
 ;;<serviceEvent classCode="PCPR" moodCode="EVN">
"RTN","C0CDAC2",561,0)
 ;;<effectiveTime>
"RTN","C0CDAC2",562,0)
 ;;<low nullFlavor="UNK"></low>
"RTN","C0CDAC2",563,0)
 ;;<high value="@@docOfDate@@"></high>
"RTN","C0CDAC2",564,0)
 ;;</effectiveTime>
"RTN","C0CDAC2",565,0)
 ;;<performer typeCode="PRF">
"RTN","C0CDAC2",566,0)
 ;;<assignedEntity>
"RTN","C0CDAC2",567,0)
 ;;<id extension="@@orgNPI@@" root="2.16.840.1.113883.4.6"></id>
"RTN","C0CDAC2",568,0)
 ;;<addr>
"RTN","C0CDAC2",569,0)
 ;;<state>@@orgState@@</state>
"RTN","C0CDAC2",570,0)
 ;;<city>@@orgCity@@</city>
"RTN","C0CDAC2",571,0)
 ;;<postalCode>@@orgZip@@</postalCode>
"RTN","C0CDAC2",572,0)
 ;;<streetAddressLine>@@orgAddr@@</streetAddressLine>
"RTN","C0CDAC2",573,0)
 ;;</addr>
"RTN","C0CDAC2",574,0)
 ;;<telecom use="WP" value="@@orgTelephone@@"></telecom>
"RTN","C0CDAC2",575,0)
 ;;<assignedPerson>
"RTN","C0CDAC2",576,0)
 ;;<name>
"RTN","C0CDAC2",577,0)
 ;;<family>@@assignedPersonFamilyName@@</family>
"RTN","C0CDAC2",578,0)
 ;;<given>@@assignedPersonGivenName@@</given>
"RTN","C0CDAC2",579,0)
 ;;@@assignedPersonSuffix@@
"RTN","C0CDAC2",580,0)
 ;;</name>
"RTN","C0CDAC2",581,0)
 ;;</assignedPerson>
"RTN","C0CDAC2",582,0)
 ;;</assignedEntity>
"RTN","C0CDAC2",583,0)
 ;;</performer>
"RTN","C0CDAC2",584,0)
 ;;</serviceEvent>
"RTN","C0CDAC2",585,0)
 ;;</documentationOf>
"RTN","C0CDAC2",586,0)
 Q
"RTN","C0CDAC2",587,0)
 ;
"RTN","C0CDAC2",588,0)
TCOMPOF ;
"RTN","C0CDAC2",589,0)
 ;;<componentOf>
"RTN","C0CDAC2",590,0)
 ;;<encompassingEncounter>
"RTN","C0CDAC2",591,0)
 ;;<id extension="@@encompassingEncounterExtension@@" root="@@orgOID@@"></id>
"RTN","C0CDAC2",592,0)
 ;;<effectiveTime value="@@encompassingEncounterEffectiveTime@@"></effectiveTime>
"RTN","C0CDAC2",593,0)
 ;;<responsibleParty>
"RTN","C0CDAC2",594,0)
 ;;<assignedEntity>
"RTN","C0CDAC2",595,0)
 ;;<id nullFlavor="UNK"></id>
"RTN","C0CDAC2",596,0)
 ;;<addr>
"RTN","C0CDAC2",597,0)
 ;;<state>@@orgState@@</state>
"RTN","C0CDAC2",598,0)
 ;;<city>@@orgCity@@</city>
"RTN","C0CDAC2",599,0)
 ;;<postalCode>@@orgZip@@</postalCode>
"RTN","C0CDAC2",600,0)
 ;;<streetAddressLine>@@orgAddr@@</streetAddressLine>
"RTN","C0CDAC2",601,0)
 ;;</addr>
"RTN","C0CDAC2",602,0)
 ;;<telecom use="WP" value="@@orgTelephone@@"></telecom>
"RTN","C0CDAC2",603,0)
 ;;<assignedPerson>
"RTN","C0CDAC2",604,0)
 ;;<name>
"RTN","C0CDAC2",605,0)
 ;;<family>@@assignedPersonFamilyName@@</family>
"RTN","C0CDAC2",606,0)
 ;;<given>@@assignedPersonGivenName@@</given>
"RTN","C0CDAC2",607,0)
 ;;@@assignedPersonSuffix@@
"RTN","C0CDAC2",608,0)
 ;;</name>
"RTN","C0CDAC2",609,0)
 ;;</assignedPerson>
"RTN","C0CDAC2",610,0)
 ;;</assignedEntity>
"RTN","C0CDAC2",611,0)
 ;;</responsibleParty>
"RTN","C0CDAC2",612,0)
 ;;<location>
"RTN","C0CDAC2",613,0)
 ;;<healthCareFacility>
"RTN","C0CDAC2",614,0)
 ;;<id extension="@@healthCareFacilityExtension@@" root="@@orgOID@@"></id>
"RTN","C0CDAC2",615,0)
 ;;<location>
"RTN","C0CDAC2",616,0)
 ;;<name>@@orgName@@</name>
"RTN","C0CDAC2",617,0)
 ;;<addr>
"RTN","C0CDAC2",618,0)
 ;;<state>@@orgState@@</state>
"RTN","C0CDAC2",619,0)
 ;;<city>@@orgCity@@</city>
"RTN","C0CDAC2",620,0)
 ;;<postalCode>@@orgCity@@</postalCode>
"RTN","C0CDAC2",621,0)
 ;;<streetAddressLine>@@orgAddr@@</streetAddressLine>
"RTN","C0CDAC2",622,0)
 ;;</addr>
"RTN","C0CDAC2",623,0)
 ;;</location>
"RTN","C0CDAC2",624,0)
 ;;</healthCareFacility>
"RTN","C0CDAC2",625,0)
 ;;</location>
"RTN","C0CDAC2",626,0)
 ;;</encompassingEncounter>
"RTN","C0CDAC2",627,0)
 ;;</componentOf>
"RTN","C0CDAC2",628,0)
 ;;<component>
"RTN","C0CDAC2",629,0)
 ;;<structuredBody>
"RTN","C0CDAC2",630,0)
 Q
"RTN","C0CDAC2",631,0)
 ;
"RTN","C0CDAC2",632,0)
TLAST1 ;
"RTN","C0CDAC2",633,0)
 ;;</structuredBody>
"RTN","C0CDAC2",634,0)
 ;;</component>
"RTN","C0CDAC2",635,0)
 ;;</ClinicalDocument>
"RTN","C0CDAC2",636,0)
 Q
"RTN","C0CDAC2",637,0)
 ;
"RTN","C0CDAC3")
0^4^B250874886
"RTN","C0CDAC3",1,0)
C0CDAC3 ; GPL - Patient Portal - CCDA Routines ;09/17/13  17:05
"RTN","C0CDAC3",2,0)
 ;;0.1;C0CDA;nopatch;noreleasedate;Build 1
"RTN","C0CDAC3",3,0)
 ;
"RTN","C0CDAC3",4,0)
 ; License AGPL v3.0
"RTN","C0CDAC3",5,0)
 ; 
"RTN","C0CDAC3",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDAC3",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDAC3",8,0)
 Q
"RTN","C0CDAC3",9,0)
 ;
"RTN","C0CDAC3",10,0)
PROBLEMS(BLIST,DFN,CCDAWRK,CCDARPT,CCDACTRL) ;
"RTN","C0CDAC3",11,0)
 ;
"RTN","C0CDAC3",12,0)
 N CCDAV
"RTN","C0CDAC3",13,0)
 S @CCDARPT@("STATUS")="EXTRACTING"
"RTN","C0CDAC3",14,0)
 S @CCDARPT@("EXTRACT-BEGIN")=$$NOW^XLFDT
"RTN","C0CDAC3",15,0)
 D GETPAT^C0CDACD(.CCDAV,DFN,"problems")
"RTN","C0CDAC3",16,0)
 I '$D(CCDAV) D  Q  ;
"RTN","C0CDAC3",17,0)
 . N PSECT S PSECT=$NA(@CCDAWRK@("PSECTION"))
"RTN","C0CDAC3",18,0)
 . D GET^C0CDACU(PSECT,"TNOPROB^C0CDAC3")
"RTN","C0CDAC3",19,0)
 . D QUEUE^MXMLTMPL(BLIST,PSECT,1,@PSECT@(0))
"RTN","C0CDAC3",20,0)
 ;
"RTN","C0CDAC3",21,0)
 S @CCDARPT@("EXTRACT-ENDS")=$$NOW^XLFDT
"RTN","C0CDAC3",22,0)
 ;
"RTN","C0CDAC3",23,0)
 ; the problem section component - moved to after computations in case all problems 
"RTN","C0CDAC3",24,0)
 ;   are redacted
"RTN","C0CDAC3",25,0)
 ;
"RTN","C0CDAC3",26,0)
 ;N PSECT S PSECT=$NA(@CCDAWRK@("PSECTION"))
"RTN","C0CDAC3",27,0)
 ;D GET^C0CDACU(PSECT,"TPROBSEC^C0CDAC3")
"RTN","C0CDAC3",28,0)
 ;D QUEUE^MXMLTMPL(BLIST,PSECT,1,@PSECT@(0))
"RTN","C0CDAC3",29,0)
 ;
"RTN","C0CDAC3",30,0)
 ; problem section html
"RTN","C0CDAC3",31,0)
 ;
"RTN","C0CDAC3",32,0)
 N C0HTML,C0ARY
"RTN","C0CDAC3",33,0)
 S C0ARY("TITLE")="Problems"
"RTN","C0CDAC3",34,0)
 S C0ARY("HEADER",1)="Date"
"RTN","C0CDAC3",35,0)
 S C0ARY("HEADER",2)="Problems"
"RTN","C0CDAC3",36,0)
 S C0ARY("HEADER",3)="Status"
"RTN","C0CDAC3",37,0)
 ;S C0ARY("HEADER",4)="Comments"
"RTN","C0CDAC3",38,0)
 S C0ARY("HEADER",5)="Source"
"RTN","C0CDAC3",39,0)
 ;
"RTN","C0CDAC3",40,0)
 N C0N S C0N=0
"RTN","C0CDAC3",41,0)
 N C0I S C0I=0
"RTN","C0CDAC3",42,0)
 F  S C0I=$O(CCDAV("problem",C0I)) Q:+C0I=0  D  ;
"RTN","C0CDAC3",43,0)
 . N C0DATE S C0DATE=CCDAV("problem",C0I,"entered@value")
"RTN","C0CDAC3",44,0)
 . S CCDAV("problem",C0I,"uri")="uri_9000011-"_$G(CCDAV("problem",C0I,"id@value"))
"RTN","C0CDAC3",45,0)
 . Q:$$REDACT^C0CDACV(CCDAV("problem",C0I,"uri"),.PARMS)
"RTN","C0CDAC3",46,0)
 . ; astro gpl
"RTN","C0CDAC3",47,0)
 . ;
"RTN","C0CDAC3",48,0)
 . N PROB S PROB=$G(CCDAV("problem",C0I,"name@value"))
"RTN","C0CDAC3",49,0)
 . I PROB["449868002" Q  ;
"RTN","C0CDAC3",50,0)
 . I PROB["102513008" Q  ;
"RTN","C0CDAC3",51,0)
 . I PROB["211896002" Q  ;
"RTN","C0CDAC3",52,0)
 . N ICDVALUE S ICDVALUE=$G(CCDAV("problem",C0I,"icd@value"))
"RTN","C0CDAC3",53,0)
 . I ICDVALUE["Z71.1" Q  ;
"RTN","C0CDAC3",54,0)
 . ; end astro
"RTN","C0CDAC3",55,0)
 . ;
"RTN","C0CDAC3",56,0)
 . S C0N=C0N+1
"RTN","C0CDAC3",57,0)
 . S C0ARY(C0N,1)=$$HTMLDT^C0CDACU(C0DATE) ; problem date
"RTN","C0CDAC3",58,0)
 . S C0ARY(C0N,1,"ID")=$G(CCDAV("problem",C0I,"uri"))
"RTN","C0CDAC3",59,0)
 . N PROBNAM S PROBNAM=CCDAV("problem",C0I,"name@value")
"RTN","C0CDAC3",60,0)
 . S PROBNAM=$$CHARCHK^MXMLBLD(PROBNAM) ; make it xml safe
"RTN","C0CDAC3",61,0)
 . S CCDAV("problem",C0I,"name@value")=PROBNAM ; correct in the array
"RTN","C0CDAC3",62,0)
 . S C0ARY(C0N,2)=CCDAV("problem",C0I,"name@value") ; problem name
"RTN","C0CDAC3",63,0)
 . S C0ARY(C0N,3)=CCDAV("problem",C0I,"status@name") ; problem status
"RTN","C0CDAC3",64,0)
 . ;S C0ARY(C0N,4)=$G(CCDAV("problem",C0I,"comments.comment@commentText"))
"RTN","C0CDAC3",65,0)
 . S C0ARY(C0N,5)=CCDAV("problem",C0I,"provider@name") ; problem source
"RTN","C0CDAC3",66,0)
 ;
"RTN","C0CDAC3",67,0)
 I +$O(C0ARY("AAAAA"),-1)=0 D  Q  ; all problems have been redacted
"RTN","C0CDAC3",68,0)
 . N PSECT S PSECT=$NA(@CCDAWRK@("PSECTION"))
"RTN","C0CDAC3",69,0)
 . D GET^C0CDACU(PSECT,"TNOPROB^C0CDAC3")
"RTN","C0CDAC3",70,0)
 . D QUEUE^MXMLTMPL(BLIST,PSECT,1,@PSECT@(0))
"RTN","C0CDAC3",71,0)
 ;
"RTN","C0CDAC3",72,0)
 ; the problem section component
"RTN","C0CDAC3",73,0)
 ;
"RTN","C0CDAC3",74,0)
 N PSECT S PSECT=$NA(@CCDAWRK@("PSECTION"))
"RTN","C0CDAC3",75,0)
 D GET^C0CDACU(PSECT,"TPROBSEC^C0CDAC3")
"RTN","C0CDAC3",76,0)
 D QUEUE^MXMLTMPL(BLIST,PSECT,1,@PSECT@(0))
"RTN","C0CDAC3",77,0)
 ;
"RTN","C0CDAC3",78,0)
 ;  problem html digest
"RTN","C0CDAC3",79,0)
 ;
"RTN","C0CDAC3",80,0)
 N PHTML S PHTML=$NA(@CCDAWRK@("PROBHTML"))
"RTN","C0CDAC3",81,0)
 D GENHTML^C0CDACU(PHTML,"C0ARY")
"RTN","C0CDAC3",82,0)
 D QUEUE^MXMLTMPL(BLIST,PHTML,1,@PHTML@(0))
"RTN","C0CDAC3",83,0)
 ;
"RTN","C0CDAC3",84,0)
 ; problem xml generation
"RTN","C0CDAC3",85,0)
 ;
"RTN","C0CDAC3",86,0)
 N WRK
"RTN","C0CDAC3",87,0)
 F  S C0I=$O(CCDAV("problem",C0I)) Q:+C0I=0  D  ;
"RTN","C0CDAC3",88,0)
 . K C0ARY
"RTN","C0CDAC3",89,0)
 . M C0ARY=CCDAV("problem",C0I)
"RTN","C0CDAC3",90,0)
 . Q:$$REDACT^C0CDACV(CCDAV("problem",C0I,"uri"),.PARMS)
"RTN","C0CDAC3",91,0)
 . S C0ARY("uri")=$G(CCDAV("problem",C0I,"uri"))
"RTN","C0CDAC3",92,0)
 . S C0ARY("code@value")=$G(C0ARY("icd@value")) ; default to icd9 code
"RTN","C0CDAC3",93,0)
 . S C0ARY("codeSystem")=$P($$ICD9(),"^",1) ; default to icd9 codes
"RTN","C0CDAC3",94,0)
 . S C0ARY("codeSystemName")=$P($$ICD9(),"^",2) 
"RTN","C0CDAC3",95,0)
 . S C0ARY("code@name")=$G(C0ARY("name@value"))
"RTN","C0CDAC3",96,0)
 . N CODE S CODE=$G(C0ARY("icd@value")) ; icd9 code
"RTN","C0CDAC3",97,0)
 . I CODE'="" D  ; 
"RTN","C0CDAC3",98,0)
 . . N CNAME,SCODE S CNAME=C0ARY("code@name")
"RTN","C0CDAC3",99,0)
 . . S SCODE=""
"RTN","C0CDAC3",100,0)
 . . I CNAME["(SCT" D  ; snomed code is provided
"RTN","C0CDAC3",101,0)
 . . . S SCODE=$P($P(CNAME,"(SCT ",2),")",1)
"RTN","C0CDAC3",102,0)
 . . I SCODE="" Q  ;
"RTN","C0CDAC3",103,0)
 . . ;N SCODE S SCODE=$O(^JJOHPP(201,"I2S",CODE,"")) ; look up snomed cod
"RTN","C0CDAC3",104,0)
 . . N LEXS
"RTN","C0CDAC3",105,0)
 . . D EN^LEXCODE(SCODE)
"RTN","C0CDAC3",106,0)
 . . I $D(LEXS("SCT",1)) D  ; found in the lexicon
"RTN","C0CDAC3",107,0)
 . . . ;ZWR LEXS
"RTN","C0CDAC3",108,0)
 . . . D:C0LOG OUTLOG^C0CDACU("LEXS(0)="_LEXS(0))
"RTN","C0CDAC3",109,0)
 . . . D:C0LOG OUTLOG^C0CDACU("LEXS(""SCT"",0)="_LEXS("SCT",0))
"RTN","C0CDAC3",110,0)
 . . . D:C0LOG OUTLOG^C0CDACU("LEXS(""SCT"",1)="_LEXS("SCT",1))
"RTN","C0CDAC3",111,0)
 . . . S C0ARY("code@name")=$P(LEXS("SCT",1),"^",2) ; snomed display name from Lexicon
"RTN","C0CDAC3",112,0)
 . . E  S SCODE=""
"RTN","C0CDAC3",113,0)
 . . I SCODE'="" D  ;
"RTN","C0CDAC3",114,0)
 . . . S C0ARY("code@value")=SCODE
"RTN","C0CDAC3",115,0)
 . . . S C0ARY("codeSystem")=$P($$SNOMED(),"^",1) ; snomed system oid
"RTN","C0CDAC3",116,0)
 . . . S C0ARY("codeSystemName")=$P($$SNOMED(),"^",2) ; snomed system name 
"RTN","C0CDAC3",117,0)
 . S C0ARY("problemReference")="#"_$G(C0ARY("uri"))
"RTN","C0CDAC3",118,0)
 . S C0ARY("guid1")=$$UUID^C0CDACU() ; random guid for observation tmplate
"RTN","C0CDAC3",119,0)
 . S C0ARY("guid2")=$$UUID^C0CDACU() ; random guid for problem tmplate
"RTN","C0CDAC3",120,0)
 . I CCDAV("problem",C0I,"status@code")="A" D  ;
"RTN","C0CDAC3",121,0)
 . . S C0ARY("statusCode")="55561003"
"RTN","C0CDAC3",122,0)
 . . S C0ARY("statusName")="Active"
"RTN","C0CDAC3",123,0)
 . I CCDAV("problem",C0I,"status@code")="I" D  ;
"RTN","C0CDAC3",124,0)
 . . S C0ARY("statusCode")="413322009"
"RTN","C0CDAC3",125,0)
 . . S C0ARY("statusName")="Resolved"
"RTN","C0CDAC3",126,0)
 . N C0DATE S C0DATE=CCDAV("problem",C0I,"entered@value")
"RTN","C0CDAC3",127,0)
 . S C0ARY("effectiveDate")=$$FMDTOUTC^C0CDACU(C0DATE) ; problem date
"RTN","C0CDAC3",128,0)
 . S WRK=$NA(@CCDAWRK@("PROB",C0I))
"RTN","C0CDAC3",129,0)
 . D GETNMAP^C0CDACU(WRK,"TPROB^C0CDAC3","C0ARY")
"RTN","C0CDAC3",130,0)
 . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC3",131,0)
 ;
"RTN","C0CDAC3",132,0)
 ; problem section ending
"RTN","C0CDAC3",133,0)
 ;
"RTN","C0CDAC3",134,0)
 N PROBEND S PROBEND=$NA(@CCDAWRK@("PROBEND"))
"RTN","C0CDAC3",135,0)
 D GET^C0CDACU(PROBEND,"TPROBEND^C0CDAC3")
"RTN","C0CDAC3",136,0)
 D QUEUE^MXMLTMPL(BLIST,PROBEND,1,@PROBEND@(0))
"RTN","C0CDAC3",137,0)
 ;
"RTN","C0CDAC3",138,0)
 Q
"RTN","C0CDAC3",139,0)
 ;
"RTN","C0CDAC3",140,0)
ICD9() ; ICD-9-CM OID
"RTN","C0CDAC3",141,0)
 Q "2.16.840.1.113883.6.103^ICD-9-CM"
"RTN","C0CDAC3",142,0)
SNOMED() ; SNOMED-CT
"RTN","C0CDAC3",143,0)
 Q "2.16.840.1.113883.6.96^SNOMED-CT"
"RTN","C0CDAC3",144,0)
 ;
"RTN","C0CDAC3",145,0)
TPROBSEC ;
"RTN","C0CDAC3",146,0)
 ;;<component>
"RTN","C0CDAC3",147,0)
 ;;<section classCode="DOCSECT" moodCode="EVN">
"RTN","C0CDAC3",148,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.5.1"></templateId>
"RTN","C0CDAC3",149,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.5.1" extension="2015-08-01"></templateId>
"RTN","C0CDAC3",150,0)
 ;;<code code="11450-4" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Problem List"></code>
"RTN","C0CDAC3",151,0)
 Q
"RTN","C0CDAC3",152,0)
 ;
"RTN","C0CDAC3",153,0)
TPROB ;
"RTN","C0CDAC3",154,0)
 ;;<entry>
"RTN","C0CDAC3",155,0)
 ;;<act classCode="ACT" moodCode="EVN">
"RTN","C0CDAC3",156,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.3"/>
"RTN","C0CDAC3",157,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.3" extension="2015-08-01"/>
"RTN","C0CDAC3",158,0)
 ;;<id root="@@guid1@@"></id>
"RTN","C0CDAC3",159,0)
 ;;<code code="CONC" codeSystem="2.16.840.1.113883.5.6"></code>
"RTN","C0CDAC3",160,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC3",161,0)
 ;;<effectiveTime>
"RTN","C0CDAC3",162,0)
 ;;<low value="@@effectiveDate@@"></low>
"RTN","C0CDAC3",163,0)
 ;;</effectiveTime>
"RTN","C0CDAC3",164,0)
 ;;<entryRelationship contextConductionInd="true" inversionInd="false" typeCode="SUBJ">
"RTN","C0CDAC3",165,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC3",166,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.4"></templateId>
"RTN","C0CDAC3",167,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.4" extension="2015-08-01"></templateId>
"RTN","C0CDAC3",168,0)
 ;;<id root="@@guid2@@"></id>
"RTN","C0CDAC3",169,0)
 ;;<code code="55607006" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED CT" displayName="Problem">
"RTN","C0CDAC3",170,0)
 ;;<translation code="75326-9" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Problem"/>
"RTN","C0CDAC3",171,0)
 ;;</code>
"RTN","C0CDAC3",172,0)
 ;;<text mediaType="text/plain">
"RTN","C0CDAC3",173,0)
 ;;<reference value="@@problemReference@@"/>
"RTN","C0CDAC3",174,0)
 ;;</text>
"RTN","C0CDAC3",175,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC3",176,0)
 ;;<effectiveTime>
"RTN","C0CDAC3",177,0)
 ;;<low value="@@effectiveDate@@"></low>
"RTN","C0CDAC3",178,0)
 ;;</effectiveTime>
"RTN","C0CDAC3",179,0)
 ;;<value code="@@code@value@@" codeSystem="@@codeSystem@@" codeSystemName="@@codeSystemName@@" displayName="@@code@name@@" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="CD">
"RTN","C0CDAC3",180,0)
 ;;<originalText>@@name@value@@</originalText>
"RTN","C0CDAC3",181,0)
 ;;</value>
"RTN","C0CDAC3",182,0)
 ;;<entryRelationship contextConductionInd="true" typeCode="REFR">
"RTN","C0CDAC3",183,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC3",184,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.6"></templateId>
"RTN","C0CDAC3",185,0)
 ;;<code code="33999-4" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Status" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="CE"></code>
"RTN","C0CDAC3",186,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC3",187,0)
 ;;<value code="@@statusCode@@" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED CT" displayName="@@statusName@@" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="CD"></value>
"RTN","C0CDAC3",188,0)
 ;;</observation>
"RTN","C0CDAC3",189,0)
 ;;</entryRelationship>
"RTN","C0CDAC3",190,0)
 ;;<entryRelationship contextConductionInd="true" typeCode="REFR">
"RTN","C0CDAC3",191,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC3",192,0)
 ;;<code code="48766-0" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Information source"></code>
"RTN","C0CDAC3",193,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC3",194,0)
 ;;<value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ST">TEST,VIEW,M.D.</value>
"RTN","C0CDAC3",195,0)
 ;;</observation>
"RTN","C0CDAC3",196,0)
 ;;</entryRelationship>
"RTN","C0CDAC3",197,0)
 ;;</observation>
"RTN","C0CDAC3",198,0)
 ;;</entryRelationship>
"RTN","C0CDAC3",199,0)
 ;;</act>
"RTN","C0CDAC3",200,0)
 ;;</entry>
"RTN","C0CDAC3",201,0)
 Q
"RTN","C0CDAC3",202,0)
 ;
"RTN","C0CDAC3",203,0)
TPROBHB ; problem HTML
"RTN","C0CDAC3",204,0)
 ;;<title>Problems</title>
"RTN","C0CDAC3",205,0)
 ;;<text>
"RTN","C0CDAC3",206,0)
 ;;<table border="1" width="100%">
"RTN","C0CDAC3",207,0)
 ;;<thead>
"RTN","C0CDAC3",208,0)
 ;;<tr>
"RTN","C0CDAC3",209,0)
 ;;<th>Date</th>
"RTN","C0CDAC3",210,0)
 ;;<th>Problems</th>
"RTN","C0CDAC3",211,0)
 ;;<th>Status</th>
"RTN","C0CDAC3",212,0)
 ;;<th>Comments</th>
"RTN","C0CDAC3",213,0)
 ;;<th>Source</th>
"RTN","C0CDAC3",214,0)
 ;;</tr>
"RTN","C0CDAC3",215,0)
 ;;</thead>
"RTN","C0CDAC3",216,0)
 ;;<tbody>
"RTN","C0CDAC3",217,0)
 Q
"RTN","C0CDAC3",218,0)
 ;
"RTN","C0CDAC3",219,0)
TPROBHM ; sample html middle
"RTN","C0CDAC3",220,0)
 ;;<tr>
"RTN","C0CDAC3",221,0)
 ;;<td>02/22/2013</td>
"RTN","C0CDAC3",222,0)
 ;;<td ID="Problem-2862900">Community acquired pneumonia</td>
"RTN","C0CDAC3",223,0)
 ;;<td>Active</td>
"RTN","C0CDAC3",224,0)
 ;;<td></td>
"RTN","C0CDAC3",225,0)
 ;;<td>TEST,VIEW,M.D.</td>
"RTN","C0CDAC3",226,0)
 ;;</tr>
"RTN","C0CDAC3",227,0)
 ;;<tr>
"RTN","C0CDAC3",228,0)
 ;;<td>02/22/2013</td>
"RTN","C0CDAC3",229,0)
 ;;<td ID="Problem-2862901">Asthma</td>
"RTN","C0CDAC3",230,0)
 ;;<td>Active</td>
"RTN","C0CDAC3",231,0)
 ;;<td></td>
"RTN","C0CDAC3",232,0)
 ;;<td>TEST,VIEW,M.D.</td>
"RTN","C0CDAC3",233,0)
 ;;</tr>
"RTN","C0CDAC3",234,0)
 ;;<tr>
"RTN","C0CDAC3",235,0)
 ;;<td>02/22/2013</td>
"RTN","C0CDAC3",236,0)
 ;;<td ID="Problem-2862902">Hypoxemia</td>
"RTN","C0CDAC3",237,0)
 ;;<td>Active</td>
"RTN","C0CDAC3",238,0)
 ;;<td></td>
"RTN","C0CDAC3",239,0)
 ;;<td>TEST,VIEW,M.D.</td>
"RTN","C0CDAC3",240,0)
 ;;</tr>
"RTN","C0CDAC3",241,0)
TPROBHE ; html ending
"RTN","C0CDAC3",242,0)
 ;;</tbody>
"RTN","C0CDAC3",243,0)
 ;;</table>
"RTN","C0CDAC3",244,0)
 ;;</text>
"RTN","C0CDAC3",245,0)
 Q
"RTN","C0CDAC3",246,0)
 ;
"RTN","C0CDAC3",247,0)
 ;;<entry contextConductionInd="true" typeCode="DRIV">
"RTN","C0CDAC3",248,0)
 ;;<act classCode="ACT" moodCode="EVN">
"RTN","C0CDAC3",249,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.3"></templateId>
"RTN","C0CDAC3",250,0)
 ;;<id extension="2862900" root="1.3.6.1.4.1.16517"></id>
"RTN","C0CDAC3",251,0)
 ;;<code code="CONC" codeSystem="2.16.840.1.113883.5.6"></code>
"RTN","C0CDAC3",252,0)
 ;;<statusCode code="active"></statusCode>
"RTN","C0CDAC3",253,0)
 ;;<effectiveTime>
"RTN","C0CDAC3",254,0)
 ;;<low value="20130222"></low>
"RTN","C0CDAC3",255,0)
 ;;</effectiveTime>
"RTN","C0CDAC3",256,0)
 ;;</act>
"RTN","C0CDAC3",257,0)
 ;;</entry>
"RTN","C0CDAC3",258,0)
TPROBEND ;
"RTN","C0CDAC3",259,0)
 ;;</section>
"RTN","C0CDAC3",260,0)
 ;;</component>
"RTN","C0CDAC3",261,0)
 Q
"RTN","C0CDAC3",262,0)
 ;
"RTN","C0CDAC3",263,0)
TNOPROB ;
"RTN","C0CDAC3",264,0)
 ;;<!-- Problem Section -->
"RTN","C0CDAC3",265,0)
 ;;<component>
"RTN","C0CDAC3",266,0)
 ;;  <section>
"RTN","C0CDAC3",267,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.5.1"></templateId>
"RTN","C0CDAC3",268,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.5.1" extension="2015-08-01"></templateId>
"RTN","C0CDAC3",269,0)
 ;;    <code code="11450-4" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Problem List"/>
"RTN","C0CDAC3",270,0)
 ;;    <title>PROBLEMS</title>
"RTN","C0CDAC3",271,0)
 ;;    <text>
"RTN","C0CDAC3",272,0)
 ;;      <content ID="Concern_1">Problem Concern:
"RTN","C0CDAC3",273,0)
 ;;      Concern Tracker Start Date: 06/07/2013 16:05:06
"RTN","C0CDAC3",274,0)
 ;;      Concern Tracker End Date: 
"RTN","C0CDAC3",275,0)
 ;;      Concern Status: Active
"RTN","C0CDAC3",276,0)
 ;;      <content ID="problems1">No known <content ID="problemType1">problems.</content></content>
"RTN","C0CDAC3",277,0)
 ;;      </content>
"RTN","C0CDAC3",278,0)
 ;;    </text>
"RTN","C0CDAC3",279,0)
 ;;    <entry typeCode="DRIV">
"RTN","C0CDAC3",280,0)
 ;;      <!-- Problem Concern Act -->	
"RTN","C0CDAC3",281,0)
 ;;      <act classCode="ACT" moodCode="EVN">
"RTN","C0CDAC3",282,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.3"/>
"RTN","C0CDAC3",283,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.3" extension="2015-08-01"/>
"RTN","C0CDAC3",284,0)
 ;;      	<id root="36e3e930-7b14-11db-9fe1-0800200c9a66"/>
"RTN","C0CDAC3",285,0)
 ;;      	<!-- SDWG supports 48765-2 or CONC in the code element -->
"RTN","C0CDAC3",286,0)
 ;;      	<code code="CONC" codeSystem="2.16.840.1.113883.5.6"/>
"RTN","C0CDAC3",287,0)
 ;;      	<text><reference value="#Concern_1"></reference></text>
"RTN","C0CDAC3",288,0)
 ;;      	<statusCode code="active"/> <!-- The concern is not active, in terms of there being an active condition to be managed.-->
"RTN","C0CDAC3",289,0)
 ;;      	<effectiveTime>
"RTN","C0CDAC3",290,0)
 ;;      	  <low value="20130607160506"/> <!-- Time at which THIS concern began being tracked.-->
"RTN","C0CDAC3",291,0)
 ;;      	  <high/>
"RTN","C0CDAC3",292,0)
 ;;      	</effectiveTime>
"RTN","C0CDAC3",293,0)
 ;;      	<author>
"RTN","C0CDAC3",294,0)
 ;;      	  <time value="20130607160506"/>
"RTN","C0CDAC3",295,0)
 ;;      	  <assignedAuthor>
"RTN","C0CDAC3",296,0)
 ;;      	    <id extension="66666" root="2.16.840.1.113883.4.6"/>
"RTN","C0CDAC3",297,0)
 ;;      	    <code code="207RC0000X" codeSystem="2.16.840.1.113883.6.101" codeSystemName="NUCC"
"RTN","C0CDAC3",298,0)
 ;;      		  displayName="Cardiovascular Disease"/>
"RTN","C0CDAC3",299,0)
 ;;      	    <addr>
"RTN","C0CDAC3",300,0)
 ;;      	      <streetAddressLine>6666 StreetName St.</streetAddressLine>
"RTN","C0CDAC3",301,0)
 ;;      	      <city>Silver Spring</city><state>MD</state><postalCode>20901</postalCode>
"RTN","C0CDAC3",302,0)
 ;;      	      <country>US</country>
"RTN","C0CDAC3",303,0)
 ;;      	    </addr>
"RTN","C0CDAC3",304,0)
 ;;      	    <telecom value="tel:+1(301)666-6666" use="WP"/>
"RTN","C0CDAC3",305,0)
 ;;      	    <assignedPerson>
"RTN","C0CDAC3",306,0)
 ;;      	      <name>
"RTN","C0CDAC3",307,0)
 ;;      		<given>Heartly</given>
"RTN","C0CDAC3",308,0)
 ;;      		<family>Sixer</family>
"RTN","C0CDAC3",309,0)
 ;;      		<suffix>MD</suffix>
"RTN","C0CDAC3",310,0)
 ;;      	      </name>
"RTN","C0CDAC3",311,0)
 ;;      	    </assignedPerson>
"RTN","C0CDAC3",312,0)
 ;;      	  </assignedAuthor>
"RTN","C0CDAC3",313,0)
 ;;      	</author>
"RTN","C0CDAC3",314,0)
 ;;      	<entryRelationship typeCode="SUBJ">
"RTN","C0CDAC3",315,0)
 ;;      	  <observation classCode="OBS" moodCode="EVN" negationInd="true">
"RTN","C0CDAC3",316,0)
 ;;      	    <!-- Model of Meaning for No Problems -->
"RTN","C0CDAC3",317,0)
 ;;      	    <!-- This is more consistent with how we did no known allergies. -->
"RTN","C0CDAC3",318,0)
 ;;      	    <!-- The use of negationInd corresponds with the newer Observation.ValueNegationInd -->
"RTN","C0CDAC3",319,0)
 ;;      	    <!-- The negationInd = true negates the value element. --> 
"RTN","C0CDAC3",320,0)
 ;;      	    <!-- problem observation template -->
"RTN","C0CDAC3",321,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.4"></templateId>
"RTN","C0CDAC3",322,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.4" extension="2015-08-01"></templateId>
"RTN","C0CDAC3",323,0)
 ;;      	    <id root="4adc1021-7b14-11db-9fe1-0800200c9a67"/>
"RTN","C0CDAC3",324,0)
 ;;<code code="55607006" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED CT" displayName="Problem">
"RTN","C0CDAC3",325,0)
 ;;<translation code="75326-9" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Problem"/>
"RTN","C0CDAC3",326,0)
 ;;</code>
"RTN","C0CDAC3",327,0)
 ;;      	    <text><reference value="#problems1"></reference></text>
"RTN","C0CDAC3",328,0)
 ;;      	    <statusCode code="completed"/>
"RTN","C0CDAC3",329,0)
 ;;      	    <effectiveTime>
"RTN","C0CDAC3",330,0)
 ;;      	      <low value="20130607160506"/>
"RTN","C0CDAC3",331,0)
 ;;      	    </effectiveTime>
"RTN","C0CDAC3",332,0)
 ;;      	    <!-- The time when this was biologically relevant ie True for the patient. -->
"RTN","C0CDAC3",333,0)
 ;;      	    <!-- As a minimum time interval over which this is true, populate the effectiveTime/low with the current time. -->
"RTN","C0CDAC3",334,0)
 ;;      	    <!-- It would be equally valid to have a longer range of time over which this statement was represented as being true. -->
"RTN","C0CDAC3",335,0)
 ;;      	    <!-- As a maximum, you would never indicate an effectiveTime/high that was greater than the current point in time. -->
"RTN","C0CDAC3",336,0)
 ;;      	    
"RTN","C0CDAC3",337,0)
 ;;      	    <!-- This idea assumes that the value element could come from the Problem value set, or-->
"RTN","C0CDAC3",338,0)
 ;;      	    <!-- when negationInd was true, is could also come from the ProblemType value set (and code would be ASSERTION). -->
"RTN","C0CDAC3",339,0)
 ;;      	    <value xsi:type="CD" code="55607006"
"RTN","C0CDAC3",340,0)
 ;;      		   displayName="Problem"
"RTN","C0CDAC3",341,0)
 ;;      		   codeSystem="2.16.840.1.113883.6.96"
"RTN","C0CDAC3",342,0)
 ;;      		   codeSystemName="SNOMED CT">
"RTN","C0CDAC3",343,0)
 ;;      	      <originalText><reference value="#problemType1"></reference></originalText>
"RTN","C0CDAC3",344,0)
 ;;<translation code="75326-9" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Problem"/>
"RTN","C0CDAC3",345,0)
 ;;      	    </value>
"RTN","C0CDAC3",346,0)
 ;;      	    <author>
"RTN","C0CDAC3",347,0)
 ;;      	      <time value="20130607160506"/>
"RTN","C0CDAC3",348,0)
 ;;      	      <assignedAuthor>
"RTN","C0CDAC3",349,0)
 ;;      		<id extension="66666" root="2.16.840.1.113883.4.6"/>
"RTN","C0CDAC3",350,0)
 ;;      		<code code="207RC0000X" codeSystem="2.16.840.1.113883.6.101" codeSystemName="NUCC"
"RTN","C0CDAC3",351,0)
 ;;      		      displayName="Cardiovascular Disease"/>
"RTN","C0CDAC3",352,0)
 ;;      		<addr>
"RTN","C0CDAC3",353,0)
 ;;      		  <streetAddressLine>6666 StreetName St.</streetAddressLine>
"RTN","C0CDAC3",354,0)
 ;;      		  <city>Silver Spring</city><state>MD</state><postalCode>20901</postalCode>
"RTN","C0CDAC3",355,0)
 ;;      		  <country>US</country>
"RTN","C0CDAC3",356,0)
 ;;      		</addr>
"RTN","C0CDAC3",357,0)
 ;;      		<telecom value="tel:+1(301)666-6666" use="WP"/>
"RTN","C0CDAC3",358,0)
 ;;      		<assignedPerson>
"RTN","C0CDAC3",359,0)
 ;;      		  <name>
"RTN","C0CDAC3",360,0)
 ;;      		    <given>Heartly</given>
"RTN","C0CDAC3",361,0)
 ;;      		    <family>Sixer</family>
"RTN","C0CDAC3",362,0)
 ;;      		    <suffix>MD</suffix>
"RTN","C0CDAC3",363,0)
 ;;      		  </name>
"RTN","C0CDAC3",364,0)
 ;;      		</assignedPerson>
"RTN","C0CDAC3",365,0)
 ;;      	      </assignedAuthor>
"RTN","C0CDAC3",366,0)
 ;;      	    </author>
"RTN","C0CDAC3",367,0)
 ;;  	  </observation>
"RTN","C0CDAC3",368,0)
 ;;      	</entryRelationship>
"RTN","C0CDAC3",369,0)
 ;;      </act>
"RTN","C0CDAC3",370,0)
 ;;    </entry>
"RTN","C0CDAC3",371,0)
 ;;  </section>
"RTN","C0CDAC3",372,0)
 ;;</component>
"RTN","C0CDAC3",373,0)
 Q
"RTN","C0CDAC3",374,0)
 ;
"RTN","C0CDAC4")
0^5^B228032796
"RTN","C0CDAC4",1,0)
C0CDAC4 ; GPL - Patient Portal - CCDA Routines ;09/23/13  17:05
"RTN","C0CDAC4",2,0)
 ;;0.1;C0CDA;nopatch;noreleasedate;Build 1
"RTN","C0CDAC4",3,0)
 ;
"RTN","C0CDAC4",4,0)
 ; License AGPL v3.0
"RTN","C0CDAC4",5,0)
 ; 
"RTN","C0CDAC4",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDAC4",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDAC4",8,0)
 ;
"RTN","C0CDAC4",9,0)
 Q
"RTN","C0CDAC4",10,0)
 ;
"RTN","C0CDAC4",11,0)
MEDS(BLIST,DFN,CCDAWRK,CCDARPT,CCDACTRL) ;
"RTN","C0CDAC4",12,0)
 ;
"RTN","C0CDAC4",13,0)
 N CCDAV,CCDAV1,PARMS,HAVDTS,MEDMODE
"RTN","C0CDAC4",14,0)
 I $D(@CCDACTRL@("PARMS")) M PARMS=@CCDACTRL@("PARMS")
"RTN","C0CDAC4",15,0)
 S MEDMODE=$G(PARMS("MEDS")) ; ALL, ACTIVE, or FILTER1
"RTN","C0CDAC4",16,0)
 ; FILTER1 shows all active meds and all inactive in the time range
"RTN","C0CDAC4",17,0)
 ; astro gpl
"RTN","C0CDAC4",18,0)
 I MEDMODE="" D  ;
"RTN","C0CDAC4",19,0)
 . S MEDMODE="ACTIVE"
"RTN","C0CDAC4",20,0)
 . S PARMS("MEDS")="ACTIVE"
"RTN","C0CDAC4",21,0)
 ; end astro
"RTN","C0CDAC4",22,0)
 S HAVDTS=0
"RTN","C0CDAC4",23,0)
 I $D(PARMS("startDateTime")) S HAVDTS=1
"RTN","C0CDAC4",24,0)
 S @CCDARPT@("STATUS")="EXTRACTING"
"RTN","C0CDAC4",25,0)
 S @CCDARPT@("EXTRACT-BEGIN")=$$NOW^XLFDT
"RTN","C0CDAC4",26,0)
 D GETPAT^C0CDACE(.CCDAV1,DFN,"meds")
"RTN","C0CDAC4",27,0)
 ;M CCDAV=CCDAV1("results","meds")
"RTN","C0CDAC4",28,0)
 I '$D(CCDAV1) Q  ;
"RTN","C0CDAC4",29,0)
 I CCDAV1("results","meds@total")=0 D  Q  ;
"RTN","C0CDAC4",30,0)
 . N MSECT S MSECT=$NA(@CCDAWRK@("MEDSECTION"))
"RTN","C0CDAC4",31,0)
 . D GET^C0CDACU(MSECT,"TNOMEDS^C0CDAC4")
"RTN","C0CDAC4",32,0)
 . D QUEUE^MXMLTMPL(BLIST,MSECT,1,@MSECT@(0))
"RTN","C0CDAC4",33,0)
 I CCDAV1("results","meds@total")=1 D  ;
"RTN","C0CDAC4",34,0)
 . M CCDAV(1)=CCDAV1("results","meds")
"RTN","C0CDAC4",35,0)
 E  M CCDAV=CCDAV1("results","meds")
"RTN","C0CDAC4",36,0)
 ;b
"RTN","C0CDAC4",37,0)
 S @CCDARPT@("EXTRACT-ENDS")=$$NOW^XLFDT
"RTN","C0CDAC4",38,0)
 ;
"RTN","C0CDAC4",39,0)
 ; medication section html
"RTN","C0CDAC4",40,0)
 ;
"RTN","C0CDAC4",41,0)
 N C0HTML,C0ARY
"RTN","C0CDAC4",42,0)
 S C0ARY("TITLE")="Medications"
"RTN","C0CDAC4",43,0)
 S C0ARY("HEADER",1)="Date"
"RTN","C0CDAC4",44,0)
 S C0ARY("HEADER",2)="Medication"
"RTN","C0CDAC4",45,0)
 ;S C0ARY("HEADER",3)="Dose"
"RTN","C0CDAC4",46,0)
 ;S C0ARY("HEADER",4)="Form"
"RTN","C0CDAC4",47,0)
 ;S C0ARY("HEADER",5)="Route"
"RTN","C0CDAC4",48,0)
 ;S C0ARY("HEADER",6)="Frequency"
"RTN","C0CDAC4",49,0)
 S C0ARY("HEADER",7)="Directions"
"RTN","C0CDAC4",50,0)
 ;S C0ARY("HEADER",8)="Comments"
"RTN","C0CDAC4",51,0)
 S C0ARY("HEADER",8)="Status"
"RTN","C0CDAC4",52,0)
 S C0ARY("HEADER",9)="Source"
"RTN","C0CDAC4",53,0)
 ;
"RTN","C0CDAC4",54,0)
 N C0IURIS S C0IURIS="" ; array to hold URIs to avoid duplicates
"RTN","C0CDAC4",55,0)
 N C0I S C0I="AAAAA"
"RTN","C0CDAC4",56,0)
 N C0N S C0N=0
"RTN","C0CDAC4",57,0)
 F  S C0I=$O(CCDAV(C0I),-1) Q:+C0I=0  D  ;
"RTN","C0CDAC4",58,0)
 . N C0DATE S C0DATE=$G(CCDAV(C0I,"med","start@value"))
"RTN","C0CDAC4",59,0)
 . I C0DATE="" S C0DATE=$G(CCDAV(C0I,"med","ordered@value"))
"RTN","C0CDAC4",60,0)
 . N GGID S GGID="uri_55-"_DFN_"_"_$G(CCDAV(C0I,"med","medID@value"))
"RTN","C0CDAC4",61,0)
 . S GGID=$TR(GGID,";","-")
"RTN","C0CDAC4",62,0)
 . I $D(C0IURIS(GGID)) D  ; duplicate URI detected
"RTN","C0CDAC4",63,0)
 . . S GGID=GGID_"-"_$G(CCDAV(C0I,"med","id@value"))
"RTN","C0CDAC4",64,0)
 . S C0IURIS(GGID)="" ; put the URI in the array
"RTN","C0CDAC4",65,0)
 . S CCDAV(C0I,"med","uri")=GGID
"RTN","C0CDAC4",66,0)
 . Q:$$REDACT^C0CDACV(CCDAV(C0I,"med","uri"),.PARMS)
"RTN","C0CDAC4",67,0)
 . Q:$$MEDSKIP(.PARMS,C0DATE,$NA(CCDAV(C0I)))
"RTN","C0CDAC4",68,0)
 . S C0N=C0N+1
"RTN","C0CDAC4",69,0)
 . I C0DATE'="" S C0ARY(C0N,1)=$$HTMLDT^C0CDACU(C0DATE) ; start date
"RTN","C0CDAC4",70,0)
 . E  S C0ARY(C0N,1)="" ; no start date
"RTN","C0CDAC4",71,0)
 . S C0ARY(C0N,1,"ID")=$G(CCDAV(C0I,"med","uri"))
"RTN","C0CDAC4",72,0)
 . N VUID
"RTN","C0CDAC4",73,0)
 . S VUID=$G(CCDAV(C0I,"med","products","product","vaProduct@vuid"))
"RTN","C0CDAC4",74,0)
 . I VUID="" S VUID=$G(CCDAV(C0I,"med","products",1,"product","vaProduct@vuid"))
"RTN","C0CDAC4",75,0)
 . ; find Rxnorm code here
"RTN","C0CDAC4",76,0)
 . I '$D(CCDAV(C0I,"med","RxNormCode@value")) D  ;
"RTN","C0CDAC4",77,0)
 . . S CCDAV(C0I,"med","RxNormCode@value")=$P($$RXNORM(VUID),"^",1)
"RTN","C0CDAC4",78,0)
 . . I CCDAV(C0I,"med","RxNormCode@value")="" S CCDAV(C0I,"med","RxNormCode@value")="UNK"
"RTN","C0CDAC4",79,0)
 . I +CCDAV(C0I,"med","RxNormCode@value")'=0 D  ; if we have an RxNorm number, map it
"RTN","C0CDAC4",80,0)
 . . N RXNMAP S RXNMAP=$$MAP^KBAIQLDM(+CCDAV(C0I,"med","RxNormCode@value"),"preferedRxnorm")
"RTN","C0CDAC4",81,0)
 . . I RXNMAP'="" S CCDAV(C0I,"med","RxNormCode@value")=RXNMAP
"RTN","C0CDAC4",82,0)
 . I CCDAV(C0I,"med","vaType@value")="N" D  ; non-VA med
"RTN","C0CDAC4",83,0)
 . . I CCDAV(C0I,"med","sig")["|" D  ;
"RTN","C0CDAC4",84,0)
 . . . S CCDAV(C0I,"med","name@value")=$P(CCDAV(C0I,"med","sig"),"|",1) ;eRx
"RTN","C0CDAC4",85,0)
 . . . S CCDAV(C0I,"med","name@value")=$$SYMENC^MXMLUTL(CCDAV(C0I,"med","name@value")) ; xml safe
"RTN","C0CDAC4",86,0)
 . . . S CCDAV(C0I,"med","sig")=$$SYMENC^MXMLUTL($P(CCDAV(C0I,"med","sig"),"|",2)) ;eRx
"RTN","C0CDAC4",87,0)
 . . I $G(CCDAV(C0I,"med","doses","dose@units"))["|" D  ; eRx doses
"RTN","C0CDAC4",88,0)
 . . . S CCDAV(C0I,"med","doses","dose@dose")=$P(CCDAV(C0I,"med","doses","dose@units"),"|",2)
"RTN","C0CDAC4",89,0)
 . S C0ARY(C0N,2)=$$SYMENC^MXMLUTL(CCDAV(C0I,"med","name@value")) ; med name
"RTN","C0CDAC4",90,0)
 . I $G(CCDAV(C0I,"med","RxNormCode@value"))'="" D  ;
"RTN","C0CDAC4",91,0)
 . . S C0ARY(C0N,2)=C0ARY(C0N,2)_" (RxNorm: "_CCDAV(C0I,"med","RxNormCode@value")_")"
"RTN","C0CDAC4",92,0)
 . ;S C0ARY(C0N,3)=$G(CCDAV(C0I,"med","doses","dose@dose"))_" "_$G(CCDAV(C0I,"med","doses","dose@units")) ; dose
"RTN","C0CDAC4",93,0)
 . ;I C0ARY(C0N,3)'="" S C0ARY(C0N,3)=$$SYMENC^MXMLUTL(C0ARY(C0N,3))
"RTN","C0CDAC4",94,0)
 . ;I C0ARY(C0N,3)=0 S C0ARY(C0N,3)="" ; surpress zero dose
"RTN","C0CDAC4",95,0)
 . ;I C0ARY(C0N,3)="0 " S C0ARY(C0N,3)="" ; surpress zero dose
"RTN","C0CDAC4",96,0)
 . ;S C0ARY(C0N,4)=$G(CCDAV(C0I,"med","form@value")) ; form
"RTN","C0CDAC4",97,0)
 . ;I CCDAV(C0I,"med","vaType@value")="V" D  ; IV 
"RTN","C0CDAC4",98,0)
 . . ;S C0ARY(C0N,3)=$G(CCDAV(C0I,"med","rate@value")) ; dose
"RTN","C0CDAC4",99,0)
 . . ;S C0ARY(C0N,4)="IV" ; form
"RTN","C0CDAC4",100,0)
 . ;S C0ARY(C0N,5)=$G(CCDAV(C0I,"med","doses","dose@route")) ; route
"RTN","C0CDAC4",101,0)
 . ;S C0ARY(C0N,6)=$G(CCDAV(C0I,"med","doses","dose@schedule")) ; frequency
"RTN","C0CDAC4",102,0)
 . S C0ARY(C0N,7)=$$SYMENC^MXMLUTL($G(CCDAV(C0I,"med","sig"))) ; directions
"RTN","C0CDAC4",103,0)
 . ;S C0ARY(C0N,8)=" " ; comments
"RTN","C0CDAC4",104,0)
 . S C0ARY(C0N,8)=CCDAV(C0I,"med","status@value") ; med status
"RTN","C0CDAC4",105,0)
 . S C0ARY(C0N,9)=$G(CCDAV(C0I,"med","currentProvider@name")) ; med source
"RTN","C0CDAC4",106,0)
 . I C0ARY(C0N,9)="" S C0ARY(C0N,9)=$G(CCDAV(C0I,"med","orderingProvider@name"))
"RTN","C0CDAC4",107,0)
 . I C0ARY(C0N,9)="" D  ;
"RTN","C0CDAC4",108,0)
 . . N ZDUZ S ZDUZ=$G(CCDAV(C0I,"med","orderingProvider@value"))
"RTN","C0CDAC4",109,0)
 . . I ZDUZ'="" S C0ARY(C0N,9)=$P($G(^VA(200,ZDUZ,0)),U,1)
"RTN","C0CDAC4",110,0)
 ;
"RTN","C0CDAC4",111,0)
 I +$O(C0ARY("AAAAA"),-1)=0 D  Q  ; all meds have been redacted
"RTN","C0CDAC4",112,0)
 . N MSECT S MSECT=$NA(@CCDAWRK@("MEDSECTION"))
"RTN","C0CDAC4",113,0)
 . D GET^C0CDACU(MSECT,"TNOMEDS^C0CDAC4")
"RTN","C0CDAC4",114,0)
 . D QUEUE^MXMLTMPL(BLIST,MSECT,1,@MSECT@(0))
"RTN","C0CDAC4",115,0)
 ;
"RTN","C0CDAC4",116,0)
 ; the medication section component
"RTN","C0CDAC4",117,0)
 ;
"RTN","C0CDAC4",118,0)
 N MSECT S MSECT=$NA(@CCDAWRK@("MEDSECTION"))
"RTN","C0CDAC4",119,0)
 D GET^C0CDACU(MSECT,"TMEDSEC^C0CDAC4")
"RTN","C0CDAC4",120,0)
 D QUEUE^MXMLTMPL(BLIST,MSECT,1,@MSECT@(0))
"RTN","C0CDAC4",121,0)
 ;
"RTN","C0CDAC4",122,0)
 ; generate the html
"RTN","C0CDAC4",123,0)
 ;
"RTN","C0CDAC4",124,0)
 N MHTML S MHTML=$NA(@CCDAWRK@("MEDHTML"))
"RTN","C0CDAC4",125,0)
 D GENHTML^C0CDACU(MHTML,"C0ARY")
"RTN","C0CDAC4",126,0)
 D QUEUE^MXMLTMPL(BLIST,MHTML,1,@MHTML@(0))
"RTN","C0CDAC4",127,0)
 ;
"RTN","C0CDAC4",128,0)
 ; medication xml generation
"RTN","C0CDAC4",129,0)
 ;
"RTN","C0CDAC4",130,0)
 N WRK
"RTN","C0CDAC4",131,0)
 S C0I="AAAA"
"RTN","C0CDAC4",132,0)
 F  S C0I=$O(CCDAV(C0I),-1) Q:+C0I=0  D  ;
"RTN","C0CDAC4",133,0)
 . K C0ARY
"RTN","C0CDAC4",134,0)
 . M C0ARY=CCDAV(C0I,"med")
"RTN","C0CDAC4",135,0)
 . I $$REDACT^C0CDACV(CCDAV(C0I,"med","uri"),.PARMS) Q  ;
"RTN","C0CDAC4",136,0)
 . S C0ARY("medName")=CCDAV(C0I,"med","name@value")
"RTN","C0CDAC4",137,0)
 . S C0ARY("medID")="#"_$G(CCDAV(C0I,"med","uri"))
"RTN","C0CDAC4",138,0)
 . S C0ARY("guid")=$$UUID^C0CDACU() ; random guid
"RTN","C0CDAC4",139,0)
 . I $G(CCDAV(C0I,"med","status@value"))="active" D  ;
"RTN","C0CDAC4",140,0)
 . . S C0ARY("statusCode")="55561003"
"RTN","C0CDAC4",141,0)
 . . S C0ARY("statusName")="Active"
"RTN","C0CDAC4",142,0)
 . I $G(CCDAV(C0I,"med","vaStatus@value"))="PENDING" D  ;
"RTN","C0CDAC4",143,0)
 . . S C0ARY("statusCode")="421139008"
"RTN","C0CDAC4",144,0)
 . . S C0ARY("statusName")="On Hold"
"RTN","C0CDAC4",145,0)
 . I $G(CCDAV(C0I,"med","vaStatus@value"))="historical" D  ;
"RTN","C0CDAC4",146,0)
 . . S C0ARY("statusCode")="392521001"
"RTN","C0CDAC4",147,0)
 . . S C0ARY("statusName")="Prior History"
"RTN","C0CDAC4",148,0)
 . I $G(C0ARY("statusCode"))=""  D  ; 
"RTN","C0CDAC4",149,0)
 . . ; includes $G(CCDAV(C0I,"med","status@value"))="not active" D  ;
"RTN","C0CDAC4",150,0)
 . . S C0ARY("statusCode")="73425007"
"RTN","C0CDAC4",151,0)
 . . S C0ARY("statusName")="Not Active"
"RTN","C0CDAC4",152,0)
 . N C0DATE S C0DATE=$G(CCDAV(C0I,"med","start@value"))
"RTN","C0CDAC4",153,0)
 . I C0DATE="" S C0DATE=$G(CCDAV(C0I,"med","ordered@value"))
"RTN","C0CDAC4",154,0)
 . Q:$$MEDSKIP(.PARMS,C0DATE,$NA(CCDAV(C0I)))
"RTN","C0CDAC4",155,0)
 . S C0ARY("RxNormCode@value")=$G(CCDAV(C0I,"med","RxNormCode@value"))
"RTN","C0CDAC4",156,0)
 . S C0ARY("timeLow")=$$FMDTOUTC^C0CDACU(C0DATE) ; med date
"RTN","C0CDAC4",157,0)
 . S C0ARY("medProvider")=$G(CCDAV(C0I,"med","orderingProvider@name"),"UNK")
"RTN","C0CDAC4",158,0)
 . S WRK=$NA(@CCDAWRK@("MED",C0I))
"RTN","C0CDAC4",159,0)
 . I $G(CCDAV(C0I,"med","vaType@value"))="V" D  ; 
"RTN","C0CDAC4",160,0)
 . . D GETNMAP^C0CDACU(WRK,"TMEDIV^C0CDAC4","C0ARY")
"RTN","C0CDAC4",161,0)
 . D GETNMAP^C0CDACU(WRK,"TMED^C0CDAC4","C0ARY")
"RTN","C0CDAC4",162,0)
 . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC4",163,0)
 ;
"RTN","C0CDAC4",164,0)
 ; medication section ending
"RTN","C0CDAC4",165,0)
 ;
"RTN","C0CDAC4",166,0)
 N MEDEND S MEDEND=$NA(@CCDAWRK@("MEDEND"))
"RTN","C0CDAC4",167,0)
 D GET^C0CDACU(MEDEND,"TMEDEND^C0CDAC4")
"RTN","C0CDAC4",168,0)
 D QUEUE^MXMLTMPL(BLIST,MEDEND,1,@MEDEND@(0))
"RTN","C0CDAC4",169,0)
 ;
"RTN","C0CDAC4",170,0)
 Q
"RTN","C0CDAC4",171,0)
 ;
"RTN","C0CDAC4",172,0)
RXNORM(C0VUID) ; extrinsic returns the RxNorm code ^ RxNorm version
"RTN","C0CDAC4",173,0)
 N VUID,RXNIEN,RXNORM,SRCIEN,RXNNAME,RXNVER
"RTN","C0CDAC4",174,0)
 ; 
"RTN","C0CDAC4",175,0)
 ; begin changes for systems that have eRx installed
"RTN","C0CDAC4",176,0)
 ; RxNorm is found in the ^C0P("RXN") global - gpl
"RTN","C0CDAC4",177,0)
 ; It has moved to ^C0CRXN
"RTN","C0CDAC4",178,0)
 ;
"RTN","C0CDAC4",179,0)
 N ZC,ZCD,ZCDS,ZCDSV ; CODE,CODE SYSTEM,CODE VERSION
"RTN","C0CDAC4",180,0)
 S (ZC,ZCD,ZCDS,ZCDSV)="" ; INITIALIZE
"RTN","C0CDAC4",181,0)
 S (RXNORM,RXNNAME,RXNVER)="" ;INITIALIZE
"RTN","C0CDAC4",182,0)
 ;I $D(^C0CRXN) D  Q RXNORM
"RTN","C0CDAC4",183,0)
 ;. ;S RXNORM=$$VUI2RXN^C0CRXNLK(C0VUID,"CD")
"RTN","C0CDAC4",184,0)
 ;. S RXNORM=$$VUI2RXN^C0CRXNLK(C0VUID) ; gpl 9/23/2017 use the older interface here
"RTN","C0CDAC4",185,0)
 ;Q RXNORM
"RTN","C0CDAC4",186,0)
 ;
"RTN","C0CDAC4",187,0)
 I $D(^C0P("RXN")) D  ; 
"RTN","C0CDAC4",188,0)
 . ;S VUID=$$GET1^DIQ(50.68,VAPROD,99.99)
"RTN","C0CDAC4",189,0)
 . S VUID=C0VUID
"RTN","C0CDAC4",190,0)
 . S ZC=$$CODE^C0CUTIL(VUID)
"RTN","C0CDAC4",191,0)
 . S ZCD=$P(ZC,"^",1) ; CODE TO USE
"RTN","C0CDAC4",192,0)
 . S ZCDS=$P(ZC,"^",2) ; CODING SYSTEM - RXNORM OR VUID
"RTN","C0CDAC4",193,0)
 . S ZCDSV=$P(ZC,"^",3) ; CODING SYSTEM VERSION
"RTN","C0CDAC4",194,0)
 . S RXNORM=ZCD ; THE CODE
"RTN","C0CDAC4",195,0)
 . S RXNNAME=ZCDS ; THE CODING SYSTEM
"RTN","C0CDAC4",196,0)
 . S RXNVER=ZCDSV ; THE CODING SYSTEM VERSION
"RTN","C0CDAC4",197,0)
 . ;N ZGMED S ZGMED=@MAP@("MEDPRODUCTNAMETEXT")
"RTN","C0CDAC4",198,0)
 . ;S @MAP@("MEDPRODUCTNAMETEXT")=ZGMED_" "_ZCDS_": "_ZCD
"RTN","C0CDAC4",199,0)
 E  I $D(^C0CRXN) D  ; $Data is for Systems that don't have our RxNorm file yet
"RTN","C0CDAC4",200,0)
 . ;S VUID=$$GET1^DIQ(50.68,VAPROD,99.99)
"RTN","C0CDAC4",201,0)
 . S VUID=C0VUID
"RTN","C0CDAC4",202,0)
 . S RXNIEN=$$FIND1^DIC(176.001,,,VUID,"VUID")
"RTN","C0CDAC4",203,0)
 . S RXNORM=$$GET1^DIQ(176.001,RXNIEN,.01)
"RTN","C0CDAC4",204,0)
 . S SRCIEN=$$FIND1^DIC(176.003,,"B","RXNORM")
"RTN","C0CDAC4",205,0)
 . S RXNNAME=$$GET1^DIQ(176.003,SRCIEN,6)
"RTN","C0CDAC4",206,0)
 . S RXNVER=$$GET1^DIQ(176.003,SRCIEN,7)
"RTN","C0CDAC4",207,0)
 Q RXNORM_"^"_RXNVER_"^"_RXNNAME
"RTN","C0CDAC4",208,0)
 ;
"RTN","C0CDAC4",209,0)
MEDSKIP(PRMS,DTE,CDAV) ; extrinsic which filters meds
"RTN","C0CDAC4",210,0)
 ;B
"RTN","C0CDAC4",211,0)
 I $G(PRMS("MEDS"))="" Q 0 ; no fiters, don't skip
"RTN","C0CDAC4",212,0)
 I @CDAV@("med","status@value")="active" Q 0 ; always show active meds
"RTN","C0CDAC4",213,0)
 I PRMS("MEDS")="ALL" Q 0 ; show all inactive meds
"RTN","C0CDAC4",214,0)
 I PRMS("MEDS")="ACTIVE" Q 1 ; skip inactive meds 
"RTN","C0CDAC4",215,0)
 Q $$SKIP^C0CDACV(DTE,.PRMS) ; filters inactive according to date - FILTER1
"RTN","C0CDAC4",216,0)
 ;
"RTN","C0CDAC4",217,0)
TMEDSEC ;
"RTN","C0CDAC4",218,0)
 ;;<component>
"RTN","C0CDAC4",219,0)
 ;;<section classCode="DOCSECT" moodCode="EVN">
"RTN","C0CDAC4",220,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.1.1"></templateId>
"RTN","C0CDAC4",221,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.1.1" extension="2014-06-09"></templateId>
"RTN","C0CDAC4",222,0)
 ;;<code code="10160-0" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="History of medication use"></code>
"RTN","C0CDAC4",223,0)
 Q
"RTN","C0CDAC4",224,0)
 ;
"RTN","C0CDAC4",225,0)
TMED ;
"RTN","C0CDAC4",226,0)
 ;;<entry>
"RTN","C0CDAC4",227,0)
 ;;<substanceAdministration classCode="SBADM" moodCode="EVN">
"RTN","C0CDAC4",228,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.16"></templateId>
"RTN","C0CDAC4",229,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.16" extension="2014-06-09"></templateId>
"RTN","C0CDAC4",230,0)
 ;;<id extension="4671088" root="1.3.6.1.4.1.16517"></id>
"RTN","C0CDAC4",231,0)
 ;;<text>
"RTN","C0CDAC4",232,0)
 ;;<reference value="@@medID@@"></reference>
"RTN","C0CDAC4",233,0)
 ;;</text>
"RTN","C0CDAC4",234,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC4",235,0)
 ;;<effectiveTime xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="IVL_TS">
"RTN","C0CDAC4",236,0)
 ;;<low value="@@timeLow@@"></low>
"RTN","C0CDAC4",237,0)
 ;;<high nullFlavor="UNK"></high>
"RTN","C0CDAC4",238,0)
 ;;</effectiveTime>
"RTN","C0CDAC4",239,0)
 ;;<doseQuantity nullFlavor="UNK" />
"RTN","C0CDAC4",240,0)
 ;;<consumable typeCode="CSM">
"RTN","C0CDAC4",241,0)
 ;;<manufacturedProduct classCode="MANU">
"RTN","C0CDAC4",242,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.23"></templateId>
"RTN","C0CDAC4",243,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.23" extension="2014-06-09"></templateId>
"RTN","C0CDAC4",244,0)
 ;;<manufacturedMaterial classCode="MMAT" determinerCode="KIND">
"RTN","C0CDAC4",245,0)
 ;;<code code="@@RxNormCode@value@@" codeSystem="2.16.840.1.113883.6.88" displayName="@@medName@@">
"RTN","C0CDAC4",246,0)
 ;;<originalText>
"RTN","C0CDAC4",247,0)
 ;;<reference value="@@medID@@"></reference>
"RTN","C0CDAC4",248,0)
 ;;</originalText>
"RTN","C0CDAC4",249,0)
 ;;</code>
"RTN","C0CDAC4",250,0)
 ;;</manufacturedMaterial>
"RTN","C0CDAC4",251,0)
 ;;</manufacturedProduct>
"RTN","C0CDAC4",252,0)
 ;;</consumable>
"RTN","C0CDAC4",253,0)
 ;;<entryRelationship typeCode="REFR">
"RTN","C0CDAC4",254,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC4",255,0)
 ;;<templateId root="2.16.840.1.113883.10.20.1.47"></templateId>
"RTN","C0CDAC4",256,0)
 ;;<code code="33999-4" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Status"></code>
"RTN","C0CDAC4",257,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC4",258,0)
 ;;<value code="@@statusCode@@" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED" displayName="@@statusName@@" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="CD"></value>
"RTN","C0CDAC4",259,0)
 ;;</observation>
"RTN","C0CDAC4",260,0)
 ;;</entryRelationship>
"RTN","C0CDAC4",261,0)
 ;;<entryRelationship contextConductionInd="true" typeCode="REFR">
"RTN","C0CDAC4",262,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC4",263,0)
 ;;<code code="48766-0" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Information source"></code>
"RTN","C0CDAC4",264,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC4",265,0)
 ;;<value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ST">@@medProvider@@</value>
"RTN","C0CDAC4",266,0)
 ;;</observation>
"RTN","C0CDAC4",267,0)
 ;;</entryRelationship>
"RTN","C0CDAC4",268,0)
 ;;</substanceAdministration>
"RTN","C0CDAC4",269,0)
 ;;</entry>
"RTN","C0CDAC4",270,0)
 Q
"RTN","C0CDAC4",271,0)
 ;
"RTN","C0CDAC4",272,0)
TMEDIV ; template for IV meds - only one medication
"RTN","C0CDAC4",273,0)
 ;;<entry>
"RTN","C0CDAC4",274,0)
 ;;<substanceAdministration classCode="SBADM" moodCode="EVN">
"RTN","C0CDAC4",275,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.16"></templateId>
"RTN","C0CDAC4",276,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.16" extension="2014-06-09"></templateId>
"RTN","C0CDAC4",277,0)
 ;;<id root="@@guid@@"></id>
"RTN","C0CDAC4",278,0)
 ;;<text>
"RTN","C0CDAC4",279,0)
 ;;<reference value="@@medID@@"></reference>
"RTN","C0CDAC4",280,0)
 ;;</text>
"RTN","C0CDAC4",281,0)
 ;;<statusCode code="active"></statusCode>
"RTN","C0CDAC4",282,0)
 ;;<effectiveTime xsi:type="IVL_TS">
"RTN","C0CDAC4",283,0)
 ;;<low value="@@timeLow@@"></low>
"RTN","C0CDAC4",284,0)
 ;;<high value="@@timeHigh@@"></high>
"RTN","C0CDAC4",285,0)
 ;;</effectiveTime>
"RTN","C0CDAC4",286,0)
 ;;<effectiveTime operator="A" xsi:type="EIVL_TS">
"RTN","C0CDAC4",287,0)
 ;;<event code="HS"></event>
"RTN","C0CDAC4",288,0)
 ;;</effectiveTime>
"RTN","C0CDAC4",289,0)
 ;;<routeCode code="C38299" codeSystem="2.16.840.1.113883.3.26.1.1" codeSystemName="NCI Thesaurus" displayName="SUBCUTANEOUS"></routeCode>
"RTN","C0CDAC4",290,0)
 ;;<doseQuantity unit="@@doseUnit@@" value="@@doseQuantity@@"></doseQuantity>
"RTN","C0CDAC4",291,0)
 ;;<administrationUnitCode code="C42945" codeSystem="2.16.840.1.113883.3.26.1.1" codeSystemName="NCI Thesaurus" displayName="INJECTION, SOLUTION"></administrationUnitCode>
"RTN","C0CDAC4",292,0)
 ;;<consumable>
"RTN","C0CDAC4",293,0)
 ;;<manufacturedProduct classCode="MANU">
"RTN","C0CDAC4",294,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.23"></templateId>
"RTN","C0CDAC4",295,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.23" extension="2014-06-09"></templateId>
"RTN","C0CDAC4",296,0)
 ;;<manufacturedMaterial>
"RTN","C0CDAC4",297,0)
 ;;<code code="@@RxNormCode@value@@" codeSystem="2.16.840.1.113883.6.88" codeSystemName="RxNorm" displayName="@@medName@@">
"RTN","C0CDAC4",298,0)
 ;;<originalText>
"RTN","C0CDAC4",299,0)
 ;;<reference value="@@medID@@"></reference>
"RTN","C0CDAC4",300,0)
 ;;</originalText>
"RTN","C0CDAC4",301,0)
 ;;</code>
"RTN","C0CDAC4",302,0)
 ;;</manufacturedMaterial>
"RTN","C0CDAC4",303,0)
 ;;</manufacturedProduct>
"RTN","C0CDAC4",304,0)
 ;;</consumable>
"RTN","C0CDAC4",305,0)
 ;;</substanceAdministration>
"RTN","C0CDAC4",306,0)
 ;;</entry>
"RTN","C0CDAC4",307,0)
 Q
"RTN","C0CDAC4",308,0)
 ;
"RTN","C0CDAC4",309,0)
TMEDEND ;
"RTN","C0CDAC4",310,0)
 ;;</section>
"RTN","C0CDAC4",311,0)
 ;;</component>
"RTN","C0CDAC4",312,0)
 Q
"RTN","C0CDAC4",313,0)
 ;
"RTN","C0CDAC4",314,0)
TNOMEDS ;
"RTN","C0CDAC4",315,0)
 ;;<component>
"RTN","C0CDAC4",316,0)
 ;;  <section>
"RTN","C0CDAC4",317,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.1.1"></templateId>
"RTN","C0CDAC4",318,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.1.1" extension="2014-06-09"></templateId>
"RTN","C0CDAC4",319,0)
 ;;    <code code="10160-0" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="History of Medication Use"/>
"RTN","C0CDAC4",320,0)
 ;;    <title>MEDICATIONS</title>
"RTN","C0CDAC4",321,0)
 ;;    <text><content ID="meds1">No Information About Medications</content></text>
"RTN","C0CDAC4",322,0)
 ;;    <entry typeCode="DRIV">
"RTN","C0CDAC4",323,0)
 ;;      <substanceAdministration moodCode="EVN" classCode="SBADM" nullFlavor="NI">
"RTN","C0CDAC4",324,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.16"></templateId>
"RTN","C0CDAC4",325,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.16" extension="2014-06-09"></templateId>
"RTN","C0CDAC4",326,0)
 ;;	<id root="2.16.840.1.113883.3.3208.101.10" extension="20130607111500-MedicationActivity"/>
"RTN","C0CDAC4",327,0)
 ;;	<text><reference value="#meds1"/></text>
"RTN","C0CDAC4",328,0)
 ;;	<statusCode code="completed"/>
"RTN","C0CDAC4",329,0)
 ;;	<effectiveTime xsi:type="IVL_TS"><low nullFlavor="NI"/><high nullFlavor="NI"/></effectiveTime>
"RTN","C0CDAC4",330,0)
 ;;	<effectiveTime xsi:type="PIVL_TS" operator="A" nullFlavor="NI"/> <!-- Added to meet the "SHOULD" and avoid the warning from the validator -->
"RTN","C0CDAC4",331,0)
 ;;	<doseQuantity nullFlavor="NI"/> <!-- Added to meet the "SHOULD" and avoid the warning from the validator -->
"RTN","C0CDAC4",332,0)
 ;;	<consumable>
"RTN","C0CDAC4",333,0)
 ;;	  <manufacturedProduct classCode="MANU">
"RTN","C0CDAC4",334,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.23"></templateId>
"RTN","C0CDAC4",335,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.23" extension="2014-06-09"></templateId>
"RTN","C0CDAC4",336,0)
 ;;	    <manufacturedMaterial>
"RTN","C0CDAC4",337,0)
 ;;	      <code nullFlavor="NI">
"RTN","C0CDAC4",338,0)
 ;;		<originalText><reference value="#meds1"/></originalText> <!-- I don't this this should need to be present unless you are populating a table with NI-->
"RTN","C0CDAC4",339,0)
 ;;	      </code>
"RTN","C0CDAC4",340,0)
 ;;	    </manufacturedMaterial>
"RTN","C0CDAC4",341,0)
 ;;	  </manufacturedProduct>
"RTN","C0CDAC4",342,0)
 ;;	</consumable>
"RTN","C0CDAC4",343,0)
 ;;      </substanceAdministration>
"RTN","C0CDAC4",344,0)
 ;;    </entry>
"RTN","C0CDAC4",345,0)
 ;;  </section>
"RTN","C0CDAC4",346,0)
 ;;</component>
"RTN","C0CDAC4",347,0)
 Q
"RTN","C0CDAC4",348,0)
 ;
"RTN","C0CDAC5")
0^6^B144664305
"RTN","C0CDAC5",1,0)
C0CDAC5 ; GPL - Patient Portal - CCDA Routines ;09/23/13  17:05
"RTN","C0CDAC5",2,0)
 ;;0.1;JJOHPP;nopatch;noreleasedate;Build 1
"RTN","C0CDAC5",3,0)
 ;
"RTN","C0CDAC5",4,0)
 ; License AGPL v3.0
"RTN","C0CDAC5",5,0)
 ; 
"RTN","C0CDAC5",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDAC5",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDAC5",8,0)
 ;
"RTN","C0CDAC5",9,0)
 Q
"RTN","C0CDAC5",10,0)
 ;
"RTN","C0CDAC5",11,0)
LABS(BLIST,DFN,CCDAWRK,CCDARPT,CCDACTRL) ;
"RTN","C0CDAC5",12,0)
 ;
"RTN","C0CDAC5",13,0)
 N CCDAV,CCDAV1,PARMS,HAVDTS
"RTN","C0CDAC5",14,0)
 I $D(@CCDACTRL@("PARMS")) M PARMS=@CCDACTRL@("PARMS")
"RTN","C0CDAC5",15,0)
 S HAVDTS=0
"RTN","C0CDAC5",16,0)
 I $D(PARMS("startDateTime")) S HAVDTS=1
"RTN","C0CDAC5",17,0)
 N STRT,STOP
"RTN","C0CDAC5",18,0)
 S STRT=$G(PARMS("startDateTime"))
"RTN","C0CDAC5",19,0)
 S STOP=$G(PARMS("endDateTime"))
"RTN","C0CDAC5",20,0)
 S @CCDARPT@("STATUS")="EXTRACTING"
"RTN","C0CDAC5",21,0)
 S @CCDARPT@("EXTRACT-BEGIN")=$$NOW^XLFDT
"RTN","C0CDAC5",22,0)
 D GETPAT^C0CDACE(.CCDAV1,DFN,"labs",STRT,STOP)
"RTN","C0CDAC5",23,0)
 D HFLABS(.CCDAV1,DFN) ; see if there are health factor labs
"RTN","C0CDAC5",24,0)
 I '$D(CCDAV1) Q  ;
"RTN","C0CDAC5",25,0)
 I CCDAV1("results","labs@total")=0 D  Q  ;
"RTN","C0CDAC5",26,0)
 . N LSECT S LSECT=$NA(@CCDAWRK@("LABSECTION"))
"RTN","C0CDAC5",27,0)
 . D GET^C0CDACU(LSECT,"TNORESULTS^C0CDAC5")
"RTN","C0CDAC5",28,0)
 . D QUEUE^MXMLTMPL(BLIST,LSECT,1,@LSECT@(0))
"RTN","C0CDAC5",29,0)
 I CCDAV1("results","labs@total")=1 D  ;
"RTN","C0CDAC5",30,0)
 . M CCDAV(1)=CCDAV1("results","labs")
"RTN","C0CDAC5",31,0)
 E  M CCDAV=CCDAV1("results","labs")
"RTN","C0CDAC5",32,0)
 D URINEAPP(.CCDAV) ; add urine appearance result
"RTN","C0CDAC5",33,0)
 S @CCDARPT@("EXTRACT-ENDS")=$$NOW^XLFDT
"RTN","C0CDAC5",34,0)
 ;
"RTN","C0CDAC5",35,0)
 ; deterimine if there are labs in the date range
"RTN","C0CDAC5",36,0)
 ;
"RTN","C0CDAC5",37,0)
 N HAVELABS S HAVELABS=1
"RTN","C0CDAC5",38,0)
 I HAVDTS=1 D  ; we have requested dates
"RTN","C0CDAC5",39,0)
 . S HAVELABS=0 ; assume no labs in date range
"RTN","C0CDAC5",40,0)
 . N C0I S C0I=0
"RTN","C0CDAC5",41,0)
 . F  S C0I=$O(CCDAV(C0I)) Q:HAVELABS  Q:+C0I=0  D  ;
"RTN","C0CDAC5",42,0)
 . . N C0DATE S C0DATE=$G(CCDAV(C0I,"lab","collected@value"))
"RTN","C0CDAC5",43,0)
 . . I $$SKIP^C0CDACV(C0DATE,.PARMS)=0 S HAVELABS=1
"RTN","C0CDAC5",44,0)
 I $D(C0DEBUG) I 'HAVELABS W !,"NO LABS"
"RTN","C0CDAC5",45,0)
 ;Q:'HAVELABS
"RTN","C0CDAC5",46,0)
 I 'HAVELABS D  Q  ;
"RTN","C0CDAC5",47,0)
 . N LSECT S LSECT=$NA(@CCDAWRK@("LABSECTION"))
"RTN","C0CDAC5",48,0)
 . D GET^C0CDACU(LSECT,"TNORESULTS^C0CDAC5")
"RTN","C0CDAC5",49,0)
 . D QUEUE^MXMLTMPL(BLIST,LSECT,1,@LSECT@(0))
"RTN","C0CDAC5",50,0)
 ;
"RTN","C0CDAC5",51,0)
 ; lab section html
"RTN","C0CDAC5",52,0)
 ;
"RTN","C0CDAC5",53,0)
 N C0HTML,C0ARY
"RTN","C0CDAC5",54,0)
 S C0ARY("TITLE")="Lab Results"
"RTN","C0CDAC5",55,0)
 S C0ARY("HEADER",1)="Date"
"RTN","C0CDAC5",56,0)
 S C0ARY("HEADER",2)="Test"
"RTN","C0CDAC5",57,0)
 S C0ARY("HEADER",3)="Value"
"RTN","C0CDAC5",58,0)
 S C0ARY("HEADER",4)="Reference Range"
"RTN","C0CDAC5",59,0)
 ;S C0ARY("HEADER",5)="Abnormal Flag"
"RTN","C0CDAC5",60,0)
 S C0ARY("HEADER",6)="Comments"
"RTN","C0CDAC5",61,0)
 ;S C0ARY("HEADER",7)="Ordering Provider"
"RTN","C0CDAC5",62,0)
 ;
"RTN","C0CDAC5",63,0)
 N C0N S C0N=0
"RTN","C0CDAC5",64,0)
 N C0I S C0I=0
"RTN","C0CDAC5",65,0)
 F  S C0I=$O(CCDAV(C0I)) Q:+C0I=0  D  ;
"RTN","C0CDAC5",66,0)
 . N C0DATE S C0DATE=$G(CCDAV(C0I,"lab","collected@value"))
"RTN","C0CDAC5",67,0)
 . Q:$$SKIP^C0CDACV(C0DATE,.PARMS)
"RTN","C0CDAC5",68,0)
 . ; exclusion - astro gpl
"RTN","C0CDAC5",69,0)
 . I $G(CCDAV(C0I,"lab","collected@value"))=3180219 I DFN=13194 Q  ;
"RTN","C0CDAC5",70,0)
 . ; end exclusion
"RTN","C0CDAC5",71,0)
 . N GGID S GGID="uri_"_$G(CCDAV(C0I,"lab","id@value"))
"RTN","C0CDAC5",72,0)
 . S GGID=$TR(GGID,";","-")
"RTN","C0CDAC5",73,0)
 . S GGID=$TR(GGID,".","_")
"RTN","C0CDAC5",74,0)
 . S CCDAV(C0I,"lab","uri")=GGID
"RTN","C0CDAC5",75,0)
 . Q:$$REDACT^C0CDACV(CCDAV(C0I,"lab","uri"),.PARMS)
"RTN","C0CDAC5",76,0)
 . S C0N=C0N+1
"RTN","C0CDAC5",77,0)
 . I C0DATE'="" S C0ARY(C0N,1)=$$HTMLDT^C0CDACU(C0DATE) ; date
"RTN","C0CDAC5",78,0)
 . E  S C0ARY(C0N,1)="" ; no date
"RTN","C0CDAC5",79,0)
 . S C0ARY(C0N,1,"ID")=$G(CCDAV(C0I,"lab","uri"))
"RTN","C0CDAC5",80,0)
 . ; astro gpl
"RTN","C0CDAC5",81,0)
 . N LABNAME,LOINCODE SET LABNAME=$G(CCDAV(C0I,"lab","test@value"))
"RTN","C0CDAC5",82,0)
 . ;D INITMAPS^KBAIQLDM
"RTN","C0CDAC5",83,0)
 . SET LOINCODE=$$UNMAP^KBAIQLDM(LABNAME,"labs")
"RTN","C0CDAC5",84,0)
 . IF LOINCODE="" S C0ARY("code")="UNK" S LOINCODE="UNK"
"RTN","C0CDAC5",85,0)
 . ELSE  S C0ARY("code")=LOINCODE
"RTN","C0CDAC5",86,0)
 . ;s ^gpl("lab",LOINCODE)=LABNAME
"RTN","C0CDAC5",87,0)
 . ; end astro gpl
"RTN","C0CDAC5",88,0)
 . S C0ARY(C0N,2)=CCDAV(C0I,"lab","test@value")_" (LOINC: "_LOINCODE_")" ; lab test name
"RTN","C0CDAC5",89,0)
 . S C0ARY(C0N,2)=$$CHARCHK^MXMLBLD(C0ARY(C0N,2)) ; make the result XML safe
"RTN","C0CDAC5",90,0)
 . I $G(CCDAV(C0I,"lab","localName@value"))="PROTEIN" S CCDAV(C0I,"lab","result@value")=100
"RTN","C0CDAC5",91,0)
 . I $G(CCDAV(C0I,"lab","localName@value"))="GLU" D  ;
"RTN","C0CDAC5",92,0)
 . . S CCDAV(C0I,"lab","result@value")=50
"RTN","C0CDAC5",93,0)
 . . S CCDAV(C0I,"lab","units@value")="mg/dL"
"RTN","C0CDAC5",94,0)
 . I $G(CCDAV(C0I,"lab","localName@value"))="GLUCOSE" D  ;
"RTN","C0CDAC5",95,0)
 . . S CCDAV(C0I,"lab","result@value")=50
"RTN","C0CDAC5",96,0)
 . . S CCDAV(C0I,"lab","units@value")="mg/dL"
"RTN","C0CDAC5",97,0)
 . I DFN=13194 D  ; fix error in this patient
"RTN","C0CDAC5",98,0)
 . . I LOINCODE="50544-6" S CCDAV(C0I,"lab","result@value")=10
"RTN","C0CDAC5",99,0)
 . ; end astro
"RTN","C0CDAC5",100,0)
 . NEW LUNITS S LUNITS=$G(CCDAV(C0I,"lab","units@value")) ; lab test result value 
"RTN","C0CDAC5",101,0)
 . I LUNITS="" S LUNITS=$$MAP^KBAIQLDM(LOINCODE,"units")
"RTN","C0CDAC5",102,0)
 . S C0ARY(C0N,3)=$G(CCDAV(C0I,"lab","result@value"))_" "_LUNITS
"RTN","C0CDAC5",103,0)
 . ;S C0ARY(C0N,3)=$$CHARCHK^MXMLBLD(C0ARY(C0N,3)) ; make the result XML safe
"RTN","C0CDAC5",104,0)
 . I $G(CCDAV(C0I,"lab","low@value"))'="" D  ;
"RTN","C0CDAC5",105,0)
 . . S CCDAV(C0I,"lab","low@value")=$$MAP^KBAIQLDM(LOINCODE,"rangeLow")
"RTN","C0CDAC5",106,0)
 . . S CCDAV(C0I,"lab","high@value")=$$MAP^KBAIQLDM(LOINCODE,"rangeHigh")
"RTN","C0CDAC5",107,0)
 . I $G(CCDAV(C0I,"lab","low@value"))'="" S C0ARY(C0N,4)="low:  "_CCDAV(C0I,"lab","low@value")_" high: "_CCDAV(C0I,"lab","high@value")
"RTN","C0CDAC5",108,0)
 . E  S C0ARY(C0N,4)=" "
"RTN","C0CDAC5",109,0)
 . S C0ARY(C0N,4)=$$CHARCHK^MXMLBLD(C0ARY(C0N,4)) ; make the normals XML safe
"RTN","C0CDAC5",110,0)
 . ;S C0ARY(C0N,5)=$G(CCDAV(C0I,"lab","interpretation@value"))_" "
"RTN","C0CDAC5",111,0)
 . S C0ARY(C0N,6)=$G(CCDAV(C0I,"lab","comment"))_" "
"RTN","C0CDAC5",112,0)
 . S C0ARY(C0N,6)=$$CHARCHK^MXMLBLD(C0ARY(C0N,6)) ; make the comment XML safe
"RTN","C0CDAC5",113,0)
 . ;S C0ARY(C0N,7)=" " 
"RTN","C0CDAC5",114,0)
 ;
"RTN","C0CDAC5",115,0)
 I +$O(C0ARY("AAAAA"),-1)=0 Q  ; all labs have been redacted
"RTN","C0CDAC5",116,0)
 ;
"RTN","C0CDAC5",117,0)
 ; the labs section component
"RTN","C0CDAC5",118,0)
 ;
"RTN","C0CDAC5",119,0)
 N LSECT S LSECT=$NA(@CCDAWRK@("LABSECTION"))
"RTN","C0CDAC5",120,0)
 D GET^C0CDACU(LSECT,"TLABSEC^C0CDAC5")
"RTN","C0CDAC5",121,0)
 D QUEUE^MXMLTMPL(BLIST,LSECT,1,@LSECT@(0))
"RTN","C0CDAC5",122,0)
 ;
"RTN","C0CDAC5",123,0)
 ; lab html digest generation
"RTN","C0CDAC5",124,0)
 ;
"RTN","C0CDAC5",125,0)
 N LHTML S LHTML=$NA(@CCDAWRK@("LABHTML"))
"RTN","C0CDAC5",126,0)
 D GENHTML^C0CDACU(LHTML,"C0ARY")
"RTN","C0CDAC5",127,0)
 D QUEUE^MXMLTMPL(BLIST,LHTML,1,@LHTML@(0))
"RTN","C0CDAC5",128,0)
 ;
"RTN","C0CDAC5",129,0)
 ; labs xml processing
"RTN","C0CDAC5",130,0)
 ;
"RTN","C0CDAC5",131,0)
 ;N LTBL D INITBL(.VTBL) ; initialize coding table
"RTN","C0CDAC5",132,0)
 N C0LCNT S C0LCNT=0
"RTN","C0CDAC5",133,0)
 F  S C0I=$O(CCDAV(C0I)) Q:+C0I=0  D  ; 
"RTN","C0CDAC5",134,0)
 . N C0J S C0J=0
"RTN","C0CDAC5",135,0)
 . N C0DATE S C0DATE=CCDAV(C0I,"lab","collected@value")
"RTN","C0CDAC5",136,0)
 . S C0DATE2=$$FMDTOUTC^C0CDACU(C0DATE)
"RTN","C0CDAC5",137,0)
 . Q:$$SKIP^C0CDACV(C0DATE,.PARMS)
"RTN","C0CDAC5",138,0)
 . ; exclusion - astro gpl
"RTN","C0CDAC5",139,0)
 . I $G(CCDAV(C0I,"lab","collected@value"))=3180219 I DFN=13194 Q  ;
"RTN","C0CDAC5",140,0)
 . ; end exclusion
"RTN","C0CDAC5",141,0)
 . I $$REDACT^C0CDACV(CCDAV(C0I,"lab","uri"),.PARMS) D  Q  ;
"RTN","C0CDAC5",142,0)
 . K C0ARY
"RTN","C0CDAC5",143,0)
 . S C0ARY("labGuid")=$G(CCDAV(C0I,"lab","uri")) ;$$UUID^C0CDACU() ; random
"RTN","C0CDAC5",144,0)
 . S C0ARY("orgOID")=$$ORGOID^C0CDACU() ; fetch organization OID
"RTN","C0CDAC5",145,0)
 . S C0ARY("resultTime")=C0DATE2
"RTN","C0CDAC5",146,0)
 . S C0ARY("labTestText")=$G(CCDAV(C0I,"lab","test@value"))
"RTN","C0CDAC5",147,0)
 . S C0ARY("labDisplayName")=$G(CCDAV(C0I,"lab","test@value"))
"RTN","C0CDAC5",148,0)
 . ; adding loinc here
"RTN","C0CDAC5",149,0)
 . ; astro gpl
"RTN","C0CDAC5",150,0)
 . N LABNAME,LOINCODE SET LABNAME=$G(CCDAV(C0I,"lab","test@value"))
"RTN","C0CDAC5",151,0)
 . D INITMAPS^KBAIQLDM
"RTN","C0CDAC5",152,0)
 . SET LOINCODE=$$UNMAP^KBAIQLDM(LABNAME)
"RTN","C0CDAC5",153,0)
 . IF LOINCODE="" S C0ARY("code")="UNK"
"RTN","C0CDAC5",154,0)
 . ELSE  S C0ARY("code")=LOINCODE
"RTN","C0CDAC5",155,0)
 . I DFN=13194 D  ; fix error in this patient
"RTN","C0CDAC5",156,0)
 . . I LOINCODE="50544-6" S CCDAV(C0I,"lab","result@value")=10
"RTN","C0CDAC5",157,0)
 . ; end astro gpl
"RTN","C0CDAC5",158,0)
 . S C0ARY("codeSystemOID")="2.16.840.1.113883.6.1" ; loinc
"RTN","C0CDAC5",159,0)
 . S C0ARY("codeSystemName")="LOINC"
"RTN","C0CDAC5",160,0)
 . IF LABNAME="" S C0ARY("labDisplayName")="UNK" ; unknown 
"RTN","C0CDAC5",161,0)
 . ELSE  S C0ARY("labDisplayName")=LABNAME ;
"RTN","C0CDAC5",162,0)
 . S C0LCNT=C0LCNT+1 ; count of xml pieces in labs
"RTN","C0CDAC5",163,0)
 . N WRK S WRK=$NA(@CCDAWRK@("LABXML",C0LCNT))
"RTN","C0CDAC5",164,0)
 . D GETNMAP^C0CDACU(WRK,"TLABORG^C0CDAC5","C0ARY")
"RTN","C0CDAC5",165,0)
 . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC5",166,0)
 . S C0ARY("labSource")=$G(CCDAV(C0I,"lab","facility@name"))
"RTN","C0CDAC5",167,0)
 . S C0ARY("resultUnit")=$G(CCDAV(C0I,"lab","units@value"))
"RTN","C0CDAC5",168,0)
 . I C0ARY("resultUnit")="" S C0ARY("resultUnit")=$$MAP^KBAIQLDM(LOINCODE,"units")
"RTN","C0CDAC5",169,0)
 . I C0ARY("resultUnit")="" S C0ARY("resultUnit")="[arb'U]" ; arbitrary unit
"RTN","C0CDAC5",170,0)
 . ;I LOINCODE="5811-5" S C0ARY("resultUnit")=""
"RTN","C0CDAC5",171,0)
 . ;S C0ARY("resultUnit")=$$CHARCHK^MXMLBLD(C0ARY("resultUnit"))
"RTN","C0CDAC5",172,0)
 . S C0ARY("resultValue")=$G(CCDAV(C0I,"lab","result@value"))
"RTN","C0CDAC5",173,0)
 . ; astro gpl
"RTN","C0CDAC5",174,0)
 . I C0ARY("resultValue")="Neg" S C0ARY("resultValue")="Negative"
"RTN","C0CDAC5",175,0)
 . ; astro gpl
"RTN","C0CDAC5",176,0)
 . S C0ARY("referenceLow")=$G(CCDAV(C0I,"lab","low@value"))
"RTN","C0CDAC5",177,0)
 . S C0ARY("referenceHigh")=$G(CCDAV(C0I,"lab","high@value"))
"RTN","C0CDAC5",178,0)
 . ; end astro
"RTN","C0CDAC5",179,0)
 . I $G(CCDAV(C0I,"lab","low@value"))'="" S C0ARY("referenceRangeText")="low:  "_CCDAV(C0I,"lab","low@value")_" high: "_CCDAV(C0I,"lab","high@value")_" units: "_$G(CCDAV(C0I,"lab","units@value"))
"RTN","C0CDAC5",180,0)
 . S C0ARY("referenceRangeText")=$G(C0ARY("referenceRangeText")) ; 
"RTN","C0CDAC5",181,0)
 . ;
"RTN","C0CDAC5",182,0)
 . ; 
"RTN","C0CDAC5",183,0)
 . N ISNUM,ISTMP,ISNIL
"RTN","C0CDAC5",184,0)
 . S ISNIL=0 ; special case of result value null
"RTN","C0CDAC5",185,0)
 . S ISTMP=$G(C0ARY("resultValue")) ; want to know if it is numeric
"RTN","C0CDAC5",186,0)
 . ;I ISTMP="" I $G(CCDAV(C0I,"lab","comment"))'="" S C0ARY("resultValue")="See Comment"
"RTN","C0CDAC5",187,0)
 . I ISTMP="" S C0ARY("resultValue")="See Comment" ; some comments are null
"RTN","C0CDAC5",188,0)
 . ;I $L(+ISTMP)=$L(ISTMP) S ISNUM=1 ; this doesn't work for "A" or "B"
"RTN","C0CDAC5",189,0)
 . I ((+ISTMP=0)&(ISTMP'="0")) S ISNUM=0
"RTN","C0CDAC5",190,0)
 . E  I $L(+ISTMP)=$L(ISTMP) S ISNUM=1
"RTN","C0CDAC5",191,0)
 . E  S ISNUM=0 ; use both methods to detect numerics
"RTN","C0CDAC5",192,0)
 . ;
"RTN","C0CDAC5",193,0)
 . S C0LCNT=C0LCNT+1
"RTN","C0CDAC5",194,0)
 . S WRK=$NA(@CCDAWRK@("LABXML",C0LCNT))
"RTN","C0CDAC5",195,0)
 . D:ISNUM GETNMAP^C0CDACU(WRK,"TLABRSLT^C0CDAC5","C0ARY")
"RTN","C0CDAC5",196,0)
 . D:'ISNUM GETNMAP^C0CDACU(WRK,"TLRSLT2^C0CDAC5","C0ARY")
"RTN","C0CDAC5",197,0)
 . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC5",198,0)
 . S C0LCNT=C0LCNT+1
"RTN","C0CDAC5",199,0)
 . S WRK=$NA(@CCDAWRK@("LABXML",C0LCNT))
"RTN","C0CDAC5",200,0)
 . D GET^C0CDACU(WRK,"TLABOEND^C0CDAC5")
"RTN","C0CDAC5",201,0)
 . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC5",202,0)
 W:$D(C0DEBUG) !,"FOUND LABS: ",C0LCNT/3
"RTN","C0CDAC5",203,0)
 ;
"RTN","C0CDAC5",204,0)
 ;
"RTN","C0CDAC5",205,0)
 ; lab section ending
"RTN","C0CDAC5",206,0)
 ;
"RTN","C0CDAC5",207,0)
 N LABEND S LABEND=$NA(@CCDAWRK@("LABEND"))
"RTN","C0CDAC5",208,0)
 D GET^C0CDACU(LABEND,"TLABEND^C0CDAC5")
"RTN","C0CDAC5",209,0)
 D QUEUE^MXMLTMPL(BLIST,LABEND,1,@LABEND@(0))
"RTN","C0CDAC5",210,0)
 ;
"RTN","C0CDAC5",211,0)
 Q
"RTN","C0CDAC5",212,0)
 ;
"RTN","C0CDAC5",213,0)
HFLABS(G,DFN) ; retrieve lab tests from Health Factors
"RTN","C0CDAC5",214,0)
 ; 
"RTN","C0CDAC5",215,0)
 N TBL2 ; table of health factors we are looking for
"RTN","C0CDAC5",216,0)
 S TBL2("50544-6","EVEROLIMUS BLOOD LEVEL")="" ; 
"RTN","C0CDAC5",217,0)
 N ZJ S ZJ=""
"RTN","C0CDAC5",218,0)
 F  S ZJ=$O(TBL2(ZJ)) Q:ZJ=""  D  ; make a B index
"RTN","C0CDAC5",219,0)
 . N ZN S ZN=$O(TBL2(ZJ,""))
"RTN","C0CDAC5",220,0)
 . S TBL2("B",ZN,ZJ)=""
"RTN","C0CDAC5",221,0)
 ;
"RTN","C0CDAC5",222,0)
 N C0HF
"RTN","C0CDAC5",223,0)
 D GETPAT^C0CDACE(.C0HF,DFN,"health-factors")
"RTN","C0CDAC5",224,0)
 N HFLOC S HFLOC=$NA(C0HF("results","healthFactors"))
"RTN","C0CDAC5",225,0)
 I $G(C0HF("results","healthFactors@total"))=1 D  ;
"RTN","C0CDAC5",226,0)
 . N HFTMP M HFTMP=@HFLOC@("factor")
"RTN","C0CDAC5",227,0)
 . K @HFLOC@("factor")
"RTN","C0CDAC5",228,0)
 . M @HFLOC@(1,"factor")=HFTMP
"RTN","C0CDAC5",229,0)
 N ZI S ZI=0
"RTN","C0CDAC5",230,0)
 F  S ZI=$O(@HFLOC@(ZI)) Q:+ZI=0  D  ;
"RTN","C0CDAC5",231,0)
 . N HF S HF=$G(@HFLOC@(ZI,"factor","name@value"))
"RTN","C0CDAC5",232,0)
 . ;W !,HF
"RTN","C0CDAC5",233,0)
 . I $O(TBL2("B",HF,""))="" Q  ; not in table
"RTN","C0CDAC5",234,0)
 . ;
"RTN","C0CDAC5",235,0)
 . NEW LOINCODE S LOINCODE=$O(TBL2("B",HF,""))
"RTN","C0CDAC5",236,0)
 . NEW LABNAME S LABNAME=HF
"RTN","C0CDAC5",237,0)
 . ; 
"RTN","C0CDAC5",238,0)
 . ;
"RTN","C0CDAC5",239,0)
 . NEW DESTLOC S DESTLOC=$NA(G("results","labs"))
"RTN","C0CDAC5",240,0)
 . NEW DESTIEN
"RTN","C0CDAC5",241,0)
 . IF $G(RTN("results","labs@total"))=1 D  ;
"RTN","C0CDAC5",242,0)
 . . N LRTMP 
"RTN","C0CDAC5",243,0)
 . . M LRTMP=@DESTLOC@("lab")
"RTN","C0CDAC5",244,0)
 . . K @DESTLOC@("lab")
"RTN","C0CDAC5",245,0)
 . . M @DESTLOC@(1,"lab")=LRTMP
"RTN","C0CDAC5",246,0)
 . IF $G(RTN("results","labs@total"))=0 D  ;
"RTN","C0CDAC5",247,0)
 . . S DESTIEN=1
"RTN","C0CDAC5",248,0)
 . . S DESTLOC=$NA(@DESTLOC@("lab"))
"RTN","C0CDAC5",249,0)
 . ELSE  D  ;
"RTN","C0CDAC5",250,0)
 . . S DESTIEN=$O(@DESTLOC@(""),-1)+1
"RTN","C0CDAC5",251,0)
 . . S DESTLOC=$NA(@DESTLOC@(DESTIEN,"lab"))
"RTN","C0CDAC5",252,0)
 . IF $G(LOINCODE)'="" D  ; patient has a LOINC code
"RTN","C0CDAC5",253,0)
 . . N DATETIME S DATETIME=$G(@HFLOC@(ZI,"factor","recorded@value"))
"RTN","C0CDAC5",254,0)
 . . S @DESTLOC@("collected@value")=DATETIME
"RTN","C0CDAC5",255,0)
 . . S @DESTLOC@("id@value")="LOINC."_$G(@HFLOC@(ZI,"factor","id@value"))
"RTN","C0CDAC5",256,0)
 . . S @DESTLOC@("localName@value")=LABNAME
"RTN","C0CDAC5",257,0)
 . . S @DESTLOC@("comment")="NOTICE: Lab values entered manually. Typographical/human error possible.  Ordering Provider: Ignacio Valdes MD Report Released Date/Time: Oct 26, 2017 Performing Lab: HOPE BRIDGE   3519 Blue Bonnet HOUSTON, TX 77025 "
"RTN","C0CDAC5",258,0)
 . . S @DESTLOC@("comment@xml:space")="preserve"
"RTN","C0CDAC5",259,0)
 . . S @DESTLOC@("facility@code")="580HOP"
"RTN","C0CDAC5",260,0)
 . . S @DESTLOC@("facility@name")="HOPE BRIDGE"
"RTN","C0CDAC5",261,0)
 . . S @DESTLOC@("high@value")=" 0"
"RTN","C0CDAC5",262,0)
 . . S @DESTLOC@("id@value")="CH;6828973;2"_$G(@HFLOC@(ZI,"factor","id@value"))
"RTN","C0CDAC5",263,0)
 . . S @DESTLOC@("low@value")="0 "
"RTN","C0CDAC5",264,0)
 . . S @DESTLOC@("result@value")=$G(@HFLOC@(ZI,"factor","comment@value"))
"RTN","C0CDAC5",265,0)
 . . S @DESTLOC@("resulted@value")=DATETIME
"RTN","C0CDAC5",266,0)
 . . S @DESTLOC@("sample@value")="BLOOD"
"RTN","C0CDAC5",267,0)
 . . S @DESTLOC@("specimen@code")="0X000"
"RTN","C0CDAC5",268,0)
 . . S @DESTLOC@("specimen@name")="BLOOD"
"RTN","C0CDAC5",269,0)
 . . S @DESTLOC@("status@value")="completed"
"RTN","C0CDAC5",270,0)
 . . S @DESTLOC@("test@value")=LABNAME
"RTN","C0CDAC5",271,0)
 . . S @DESTLOC@("type@value")="CH"
"RTN","C0CDAC5",272,0)
 . . S RTN("results","labs@total")=DESTIEN
"RTN","C0CDAC5",273,0)
 Q
"RTN","C0CDAC5",274,0)
 ;
"RTN","C0CDAC5",275,0)
TLABSEC ;
"RTN","C0CDAC5",276,0)
 ;;<component>
"RTN","C0CDAC5",277,0)
 ;;<section classCode="DOCSECT" moodCode="EVN">
"RTN","C0CDAC5",278,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.3.1"></templateId>
"RTN","C0CDAC5",279,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.3.1" extension="2015-08-01"></templateId>
"RTN","C0CDAC5",280,0)
 ;;<code code="30954-2" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Relevant diagnostic tests and/or laboratory data"></code>
"RTN","C0CDAC5",281,0)
 Q
"RTN","C0CDAC5",282,0)
 ;
"RTN","C0CDAC5",283,0)
TLABORG ; lab organizer
"RTN","C0CDAC5",284,0)
 ;;<entry>
"RTN","C0CDAC5",285,0)
 ;;<organizer classCode="CLUSTER" moodCode="EVN">
"RTN","C0CDAC5",286,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.1" extension="2015-08-01"></templateId>
"RTN","C0CDAC5",287,0)
 ;;<id extension="@@labGuid@@" root="@@orgOID@@"></id>
"RTN","C0CDAC5",288,0)
 ;;<code code="@@code@@" codeSystem="@@codeSystemOID@@" codeSystemName="@@codeSystemName@@" displayName="@@labDisplayName@@"></code>
"RTN","C0CDAC5",289,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC5",290,0)
 Q
"RTN","C0CDAC5",291,0)
 ;
"RTN","C0CDAC5",292,0)
LOINCOID()
"RTN","C0CDAC5",293,0)
 Q "2.16.840.1.113883.6.1"
"RTN","C0CDAC5",294,0)
 ;
"RTN","C0CDAC5",295,0)
TLABRSLT ; 
"RTN","C0CDAC5",296,0)
 ;;<component>
"RTN","C0CDAC5",297,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC5",298,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.2"></templateId>
"RTN","C0CDAC5",299,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.2" extension="2015-08-01"></templateId>
"RTN","C0CDAC5",300,0)
 ;;<id extension="@@labGuid@@" root="@@orgOID@@"></id>
"RTN","C0CDAC5",301,0)
 ;;<code code="@@code@@" codeSystem="@@codeSystemOID@@" codeSystemName="@@codeSystemName@@" displayName="@@labDisplayName@@">
"RTN","C0CDAC5",302,0)
 ;;<originalText>@@labTestText@@</originalText>
"RTN","C0CDAC5",303,0)
 ;;</code>
"RTN","C0CDAC5",304,0)
 ;;<text mediaType="text/plain">
"RTN","C0CDAC5",305,0)
 ;;<reference value="#@@labGuid@@"></reference>
"RTN","C0CDAC5",306,0)
 ;;</text>
"RTN","C0CDAC5",307,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC5",308,0)
 ;;<effectiveTime value="@@resultTime@@"></effectiveTime>
"RTN","C0CDAC5",309,0)
 ;;<value unit="@@resultUnit@@" value="@@resultValue@@" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="PQ"></value>
"RTN","C0CDAC5",310,0)
 ;;<entryRelationship contextConductionInd="true" typeCode="REFR">
"RTN","C0CDAC5",311,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC5",312,0)
 ;;<code code="48766-0" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Information source"></code>
"RTN","C0CDAC5",313,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC5",314,0)
 ;;<value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ST">@@labSource@@</value>
"RTN","C0CDAC5",315,0)
 ;;</observation>
"RTN","C0CDAC5",316,0)
 ;;</entryRelationship>
"RTN","C0CDAC5",317,0)
 ;;<referenceRange typeCode="REFV">
"RTN","C0CDAC5",318,0)
 ;;<observationRange classCode="OBS" moodCode="EVN.CRT">
"RTN","C0CDAC5",319,0)
 ;;<text mediaType="text/plain" representation="TXT">@@referenceRangeText@@</text>
"RTN","C0CDAC5",320,0)
 ;;<value xsi:type="IVL_PQ">
"RTN","C0CDAC5",321,0)
 ;;<low value="@@referenceLow@@" unit="@@resultUnit@@"/>
"RTN","C0CDAC5",322,0)
 ;;<high value="@@referenceHigh@@" unit="@@resultUnit@@"/>
"RTN","C0CDAC5",323,0)
 ;;</value>
"RTN","C0CDAC5",324,0)
 ;;</observationRange>
"RTN","C0CDAC5",325,0)
 ;;</referenceRange>
"RTN","C0CDAC5",326,0)
 ;;</observation>
"RTN","C0CDAC5",327,0)
 ;;</component>
"RTN","C0CDAC5",328,0)
 Q
"RTN","C0CDAC5",329,0)
 ;
"RTN","C0CDAC5",330,0)
TLRSLT2 ; for non-numeric results 
"RTN","C0CDAC5",331,0)
 ;;<component>
"RTN","C0CDAC5",332,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC5",333,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.2"></templateId>
"RTN","C0CDAC5",334,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.2" extension="2015-08-01"></templateId>
"RTN","C0CDAC5",335,0)
 ;;<id extension="@@labGuid@@" root="@@orgOID@@"></id>
"RTN","C0CDAC5",336,0)
 ;;<code code="@@code@@" codeSystem="@@codeSystemOID@@" codeSystemName="@@codeSystemName@@" displayName="@@labDisplayName@@">
"RTN","C0CDAC5",337,0)
 ;;<originalText>@@labTestText@@</originalText>
"RTN","C0CDAC5",338,0)
 ;;</code>
"RTN","C0CDAC5",339,0)
 ;;<text mediaType="text/plain">
"RTN","C0CDAC5",340,0)
 ;;<reference value="#@@labGuid@@"></reference>
"RTN","C0CDAC5",341,0)
 ;;</text>
"RTN","C0CDAC5",342,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC5",343,0)
 ;;<effectiveTime value="@@resultTime@@"></effectiveTime>
"RTN","C0CDAC5",344,0)
 ;;<value xsi:type="ST">@@resultValue@@</value>
"RTN","C0CDAC5",345,0)
 ;;<entryRelationship contextConductionInd="true" typeCode="REFR">
"RTN","C0CDAC5",346,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC5",347,0)
 ;;<code code="48766-0" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Information source"></code>
"RTN","C0CDAC5",348,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC5",349,0)
 ;;<value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ST">@@labSource@@</value>
"RTN","C0CDAC5",350,0)
 ;;</observation>
"RTN","C0CDAC5",351,0)
 ;;</entryRelationship>
"RTN","C0CDAC5",352,0)
 ;;<referenceRange typeCode="REFV">
"RTN","C0CDAC5",353,0)
 ;;<observationRange classCode="OBS" moodCode="EVN.CRT">
"RTN","C0CDAC5",354,0)
 ;;<text mediaType="text/plain" representation="TXT">@@referenceRangeText@@</text>
"RTN","C0CDAC5",355,0)
 ;;<value xsi:type="ST">TEXT</value>
"RTN","C0CDAC5",356,0)
 ;;</observationRange>
"RTN","C0CDAC5",357,0)
 ;;</referenceRange>
"RTN","C0CDAC5",358,0)
 ;;</observation>
"RTN","C0CDAC5",359,0)
 ;;</component>
"RTN","C0CDAC5",360,0)
 Q
"RTN","C0CDAC5",361,0)
 ;
"RTN","C0CDAC5",362,0)
TLABOEND ; organizer ending
"RTN","C0CDAC5",363,0)
 ;;</organizer>
"RTN","C0CDAC5",364,0)
 ;;</entry>
"RTN","C0CDAC5",365,0)
 Q
"RTN","C0CDAC5",366,0)
 ;
"RTN","C0CDAC5",367,0)
TLABEND ;
"RTN","C0CDAC5",368,0)
 ;;</section>
"RTN","C0CDAC5",369,0)
 ;;</component>
"RTN","C0CDAC5",370,0)
 Q
"RTN","C0CDAC5",371,0)
 ;
"RTN","C0CDAC5",372,0)
URINEAPP(CCDAV1) ; inserts a lab test for Urine appearance of CLEAR
"RTN","C0CDAC5",373,0)
 ;
"RTN","C0CDAC5",374,0)
 N ZIEN S ZIEN=$O(CCDAV(""),-1)+1
"RTN","C0CDAC5",375,0)
 ;
"RTN","C0CDAC5",376,0)
 S CCDAV(ZIEN,"lab","collected@value")=3171027
"RTN","C0CDAC5",377,0)
 S CCDAV(ZIEN,"lab","comment")="NOTICE: Lab values entered manually. Typographical/human error possible.  Ordering Provider: Albert Davis Report Released Date/Time: Oct 27, 2017 Performing Lab: ASTRONAUT HARRRIS COUNTY NET [CLIA# 12345698771AB] 3519 Blue Bonnet HOUSTON, TX 77025 "
"RTN","C0CDAC5",378,0)
 S CCDAV(ZIEN,"lab","comment@xml:space")="preserve"
"RTN","C0CDAC5",379,0)
 S CCDAV(ZIEN,"lab","facility@code")=580
"RTN","C0CDAC5",380,0)
 S CCDAV(ZIEN,"lab","facility@name")="ASTRONAUT HARRRIS COUNTY NET"
"RTN","C0CDAC5",381,0)
 S CCDAV(ZIEN,"lab","high@value")=" 0"
"RTN","C0CDAC5",382,0)
 S CCDAV(ZIEN,"lab","id@value")="CH;6828972;999"
"RTN","C0CDAC5",383,0)
 S CCDAV(ZIEN,"lab","localName@value")="APPEARANCE "
"RTN","C0CDAC5",384,0)
 S CCDAV(ZIEN,"lab","low@value")="0 "
"RTN","C0CDAC5",385,0)
 S CCDAV(ZIEN,"lab","result@value")="CLEAR"
"RTN","C0CDAC5",386,0)
 S CCDAV(ZIEN,"lab","resulted@value")=3171027
"RTN","C0CDAC5",387,0)
 S CCDAV(ZIEN,"lab","sample@value")="BLOOD"
"RTN","C0CDAC5",388,0)
 S CCDAV(ZIEN,"lab","specimen@code")="0X000"
"RTN","C0CDAC5",389,0)
 S CCDAV(ZIEN,"lab","specimen@name")="BLOOD"
"RTN","C0CDAC5",390,0)
 S CCDAV(ZIEN,"lab","status@value")="completed"
"RTN","C0CDAC5",391,0)
 S CCDAV(ZIEN,"lab","test@value")="APPEARANCE OF URINE"
"RTN","C0CDAC5",392,0)
 S CCDAV(ZIEN,"lab","type@value")="CH"
"RTN","C0CDAC5",393,0)
 ;
"RTN","C0CDAC5",394,0)
 ;S CCDAV1("results","labs@total")=ZIEN
"RTN","C0CDAC5",395,0)
 ;
"RTN","C0CDAC5",396,0)
 Q
"RTN","C0CDAC5",397,0)
 ;
"RTN","C0CDAC5",398,0)
TESTUAPP ;
"RTN","C0CDAC5",399,0)
 S DFN=13166
"RTN","C0CDAC5",400,0)
 D GETPAT^C0CDACE(.CCDAV1,DFN,"labs")
"RTN","C0CDAC5",401,0)
 M CCDAV=CCDAV1("results","labs")
"RTN","C0CDAC5",402,0)
 D URINEAPP(.CCDAV)
"RTN","C0CDAC5",403,0)
 ZWR CCDAV
"RTN","C0CDAC5",404,0)
 Q
"RTN","C0CDAC5",405,0)
 ;
"RTN","C0CDAC5",406,0)
TNORESULTS ;
"RTN","C0CDAC5",407,0)
 ;;<component>
"RTN","C0CDAC5",408,0)
 ;; <!-- nullFlavor of NI indicates No Information.-->
"RTN","C0CDAC5",409,0)
 ;;  <!-- Validator currently checks for entries even in case of nullFlavor - this will need to be updated if approved.-->
"RTN","C0CDAC5",410,0)
 ;;  <section nullFlavor="NI">
"RTN","C0CDAC5",411,0)
 ;;  <templateId root="2.16.840.1.113883.10.20.22.2.3.1"/>
"RTN","C0CDAC5",412,0)
 ;;  <templateId root="2.16.840.1.113883.10.20.22.2.3.1" extension="2015-08-01"/>
"RTN","C0CDAC5",413,0)
 ;;  <!-- Results Section with Coded Entries Required-->
"RTN","C0CDAC5",414,0)
 ;;  <code code="30954-2" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Relevant diagnostic tests and/or laboratory data"/>
"RTN","C0CDAC5",415,0)
 ;;  <title>RESULTS</title>
"RTN","C0CDAC5",416,0)
 ;;  <text>No Information</text>
"RTN","C0CDAC5",417,0)
 ;;  </section>
"RTN","C0CDAC5",418,0)
 ;;  </component>
"RTN","C0CDAC5",419,0)
 Q
"RTN","C0CDAC5",420,0)
 ;
"RTN","C0CDAC6")
0^7^B182000027
"RTN","C0CDAC6",1,0)
C0CDAC6 ; GPL - Patient Portal - CCDA Routines ;09/23/13  17:05
"RTN","C0CDAC6",2,0)
 ;;0.1;JJOHPP;nopatch;noreleasedate;Build 1
"RTN","C0CDAC6",3,0)
 ;
"RTN","C0CDAC6",4,0)
 ; License AGPL v3.0
"RTN","C0CDAC6",5,0)
 ; 
"RTN","C0CDAC6",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDAC6",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDAC6",8,0)
 ;
"RTN","C0CDAC6",9,0)
 Q
"RTN","C0CDAC6",10,0)
 ;
"RTN","C0CDAC6",11,0)
VITALS(BLIST,DFN,CCDAWRK,CCDARPT,CCDACTRL) ;
"RTN","C0CDAC6",12,0)
 ;
"RTN","C0CDAC6",13,0)
 N CCDAV,CCDAV1,PARMS,HAVDTS
"RTN","C0CDAC6",14,0)
 I $D(@CCDACTRL@("PARMS")) M PARMS=@CCDACTRL@("PARMS")
"RTN","C0CDAC6",15,0)
 S HAVDTS=0
"RTN","C0CDAC6",16,0)
 I $D(PARMS("startDateTime")) S HAVDTS=1
"RTN","C0CDAC6",17,0)
 N STRT,STOP
"RTN","C0CDAC6",18,0)
 S STRT=$G(PARMS("startDateTime"))
"RTN","C0CDAC6",19,0)
 S STOP=$G(PARMS("endDateTime"))
"RTN","C0CDAC6",20,0)
 S @CCDARPT@("STATUS")="EXTRACTING"
"RTN","C0CDAC6",21,0)
 S @CCDARPT@("EXTRACT-BEGIN")=$$NOW^XLFDT
"RTN","C0CDAC6",22,0)
 D GETPAT^C0CDACD(.CCDAV1,DFN,"vitals",STRT,STOP) ; 
"RTN","C0CDAC6",23,0)
 I '$D(CCDAV1) Q  ;
"RTN","C0CDAC6",24,0)
 D POSTPRS(.CCDAV,.CCDAV1) ; special handling for vitals array
"RTN","C0CDAC6",25,0)
 S @CCDARPT@("EXTRACT-ENDS")=$$NOW^XLFDT
"RTN","C0CDAC6",26,0)
 ;
"RTN","C0CDAC6",27,0)
 ; deterimine if there are vitals in the date range
"RTN","C0CDAC6",28,0)
 ;
"RTN","C0CDAC6",29,0)
 N HAVEVIT S HAVEVIT=1
"RTN","C0CDAC6",30,0)
 I HAVDTS=1 D  ; we have requested dates
"RTN","C0CDAC6",31,0)
 . S HAVEVIT=0 ; assume no vitals in date range
"RTN","C0CDAC6",32,0)
 . N C0I S C0I=0
"RTN","C0CDAC6",33,0)
 . F  S C0I=$O(CCDAV(C0I)) Q:HAVEVIT  Q:+C0I=0  D  ;
"RTN","C0CDAC6",34,0)
 . . N C0DATE S C0DATE=$G(CCDAV(C0I,"taken@value"))
"RTN","C0CDAC6",35,0)
 . . I $$SKIP^C0CDACV(C0DATE,.PARMS)=0 S HAVEVIT=1
"RTN","C0CDAC6",36,0)
 I $D(C0DEBUG) I 'HAVEVIT W !,"NO VITALS"
"RTN","C0CDAC6",37,0)
 Q:'HAVEVIT
"RTN","C0CDAC6",38,0)
 ;
"RTN","C0CDAC6",39,0)
 ; vitals section html
"RTN","C0CDAC6",40,0)
 ;
"RTN","C0CDAC6",41,0)
 N C0HTML,C0ARY
"RTN","C0CDAC6",42,0)
 S C0ARY("TITLE")="Vital Signs"
"RTN","C0CDAC6",43,0)
 S C0ARY("HEADER",1)="Date"
"RTN","C0CDAC6",44,0)
 S C0ARY("HEADER",2)="Vital Sign"
"RTN","C0CDAC6",45,0)
 S C0ARY("HEADER",3)="Value"
"RTN","C0CDAC6",46,0)
 S C0ARY("HEADER",4)="Details"
"RTN","C0CDAC6",47,0)
 S C0ARY("HEADER",5)="Source"
"RTN","C0CDAC6",48,0)
 ;
"RTN","C0CDAC6",49,0)
 N DONE ; array of things that are done - for latest processing
"RTN","C0CDAC6",50,0)
 I $G(PARMS("VITALS"))="" S PARMS("VITALS")="LATEST"
"RTN","C0CDAC6",51,0)
 N C0I S C0I=0
"RTN","C0CDAC6",52,0)
 N C0N S C0N=0
"RTN","C0CDAC6",53,0)
 F  S C0I=$O(CCDAV(C0I)) Q:+C0I=0  D  ;
"RTN","C0CDAC6",54,0)
 . N C0DATE,C0D S C0D=$G(CCDAV(C0I,"taken@value"))
"RTN","C0CDAC6",55,0)
 . Q:$$SKIP^C0CDACV(C0D,.PARMS)
"RTN","C0CDAC6",56,0)
 . I C0D'="" S C0DATE=$$HTMLDT^C0CDACU(C0D) ; date
"RTN","C0CDAC6",57,0)
 . E  S C0DATE="" ; no date
"RTN","C0CDAC6",58,0)
 . N C0I2 S C0I2=0
"RTN","C0CDAC6",59,0)
 . F  S C0I2=$O(CCDAV(C0I,C0I2)) Q:+C0I2=0  D  ;
"RTN","C0CDAC6",60,0)
 . . N GGID S GGID="uri_120_5-"_$G(CCDAV(C0I,C0I2,"measurement@id"))
"RTN","C0CDAC6",61,0)
 . . S CCDAV(C0I,C0I2,"uri")=GGID
"RTN","C0CDAC6",62,0)
 . . Q:$$REDACT^C0CDACV(CCDAV(C0I,C0I2,"uri"),.PARMS)
"RTN","C0CDAC6",63,0)
 . . Q:CCDAV(C0I,C0I2,"measurement@value")="Unavailable"
"RTN","C0CDAC6",64,0)
 . . N VNAME S VNAME=CCDAV(C0I,C0I2,"measurement@name") ; vital sign name
"RTN","C0CDAC6",65,0)
 . . I $G(PARMS("VITALS"))="LATEST" I $D(DONE(VNAME)) Q  ; already did this one
"RTN","C0CDAC6",66,0)
 . . S DONE(VNAME)=""
"RTN","C0CDAC6",67,0)
 . . S C0N=C0N+1 ; HTML line
"RTN","C0CDAC6",68,0)
 . . ;I C0I2=1 S C0ARY(C0N,1)=C0DATE ; switch these to get a battery look
"RTN","C0CDAC6",69,0)
 . . S C0ARY(C0N,1)=C0DATE
"RTN","C0CDAC6",70,0)
 . . ;E  S C0ARY(C0N,1)=""
"RTN","C0CDAC6",71,0)
 . . S C0ARY(C0N,1,"ID")=$G(CCDAV(C0I,C0I2,"uri"))
"RTN","C0CDAC6",72,0)
 . . I $G(CCDAV(C0I,C0I2,"measurement@name"))="" Q  ; not a valid record
"RTN","C0CDAC6",73,0)
 . . I $G(CCDAV(C0I,C0I2,"measurement@value"))="" Q  ; not a valid record
"RTN","C0CDAC6",74,0)
 . . I $G(CCDAV(C0I,C0I2,"measurement@value"))="Refused" Q  ; not valid
"RTN","C0CDAC6",75,0)
 . . S C0ARY(C0N,2)=CCDAV(C0I,C0I2,"measurement@name") ; vital sign name
"RTN","C0CDAC6",76,0)
 . . S C0ARY(C0N,3)=CCDAV(C0I,C0I2,"measurement@value")_" "_$G(CCDAV(C0I,C0I2,"measurement@units")) ; measurement value
"RTN","C0CDAC6",77,0)
 . . I $G(CCDAV(C0I,C0I2,"measurement@metricValue"))'="" D  ;
"RTN","C0CDAC6",78,0)
 . . . I $G(CCDAV(C0I,C0I2,"measurement@metricUnits"))="kg" D  ;
"RTN","C0CDAC6",79,0)
 . . . . N TKG S TKG=CCDAV(C0I,C0I2,"measurement@metricValue")
"RTN","C0CDAC6",80,0)
 . . . . I TKG["." S TKG=$P(TKG,".",1)
"RTN","C0CDAC6",81,0)
 . . . . S CCDAV(C0I,C0I2,"measurement@metricValue")=TKG
"RTN","C0CDAC6",82,0)
 . . . S C0ARY(C0N,3)=CCDAV(C0I,C0I2,"measurement@metricValue")_" "_$G(CCDAV(C0I,C0I2,"measurement@metricUnits")) ; measurement value
"RTN","C0CDAC6",83,0)
 . . I $G(CCDAV(C0I,C0I2,"measurement@low"))'="" S C0ARY(C0N,4)="low:  "_CCDAV(C0I,C0I2,"measurement@low")_" high: "_CCDAV(C0I,C0I2,"measurement@high")
"RTN","C0CDAC6",84,0)
 . . E  S C0ARY(C0N,4)=" "
"RTN","C0CDAC6",85,0)
 . . S C0ARY(C0N,5)=$G(CCDAV(C0I,"location@name"))_" " ; source
"RTN","C0CDAC6",86,0)
 ;
"RTN","C0CDAC6",87,0)
 I +$O(C0ARY("AAAAA"),-1)=0 Q  ; all vitals have been redacted
"RTN","C0CDAC6",88,0)
 ;
"RTN","C0CDAC6",89,0)
 ; the vitals section component
"RTN","C0CDAC6",90,0)
 ;
"RTN","C0CDAC6",91,0)
 N LSECT S LSECT=$NA(@CCDAWRK@("VITALSECTION"))
"RTN","C0CDAC6",92,0)
 D GET^C0CDACU(LSECT,"TVITSEC^C0CDAC6")
"RTN","C0CDAC6",93,0)
 D QUEUE^MXMLTMPL(BLIST,LSECT,1,@LSECT@(0))
"RTN","C0CDAC6",94,0)
 ;
"RTN","C0CDAC6",95,0)
 ; vitals html generation
"RTN","C0CDAC6",96,0)
 ;
"RTN","C0CDAC6",97,0)
 N LHTML S LHTML=$NA(@CCDAWRK@("VITHTML"))
"RTN","C0CDAC6",98,0)
 D GENHTML^C0CDACU(LHTML,"C0ARY")
"RTN","C0CDAC6",99,0)
 D QUEUE^MXMLTMPL(BLIST,LHTML,1,@LHTML@(0))
"RTN","C0CDAC6",100,0)
 ;
"RTN","C0CDAC6",101,0)
 ; vitals xml processing
"RTN","C0CDAC6",102,0)
 ;
"RTN","C0CDAC6",103,0)
 N VTBL D INITBL(.VTBL) ; initialize coding table
"RTN","C0CDAC6",104,0)
 N C0VCNT S C0VCNT=0
"RTN","C0CDAC6",105,0)
 F  S C0I=$O(CCDAV(C0I)) Q:+C0I=0  D  ; 
"RTN","C0CDAC6",106,0)
 . N C0J S C0J=0
"RTN","C0CDAC6",107,0)
 . N C0DTE S C0DTE=$G(CCDAV(C0I,"taken@value"))
"RTN","C0CDAC6",108,0)
 . Q:$$SKIP^C0CDACV(C0DTE,.PARMS) ; quit if not in date range
"RTN","C0CDAC6",109,0)
 . N C0DATE S C0DATE=$$FMDTOUTC^C0CDACU(C0DTE)
"RTN","C0CDAC6",110,0)
 . K C0ARY
"RTN","C0CDAC6",111,0)
 . S C0ARY("guid1")=$$UUID^C0CDACU() ; random
"RTN","C0CDAC6",112,0)
 . S C0ARY("vitalDateTime")=C0DATE
"RTN","C0CDAC6",113,0)
 . S C0VCNT=C0VCNT+1 ; count of xml pieces in vitals
"RTN","C0CDAC6",114,0)
 . N WRK S WRK=$NA(@CCDAWRK@("VITXML",C0VCNT))
"RTN","C0CDAC6",115,0)
 . D GETNMAP^C0CDACU(WRK,"TVITORG^C0CDAC6","C0ARY")
"RTN","C0CDAC6",116,0)
 . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC6",117,0)
 . F  S C0J=$O(CCDAV(C0I,C0J)) Q:+C0J=0  D  ;
"RTN","C0CDAC6",118,0)
 . . K C0ARY
"RTN","C0CDAC6",119,0)
 . . Q:$$REDACT^C0CDACV(CCDAV(C0I,C0J,"uri"),.PARMS)
"RTN","C0CDAC6",120,0)
 . . Q:$G(CCDAV(C0I,C0J,"measurement@value"))="Unavailable"
"RTN","C0CDAC6",121,0)
 . . I $G(CCDAV(C0I,C0J,"measurement@name"))="" Q  ; not a valid record
"RTN","C0CDAC6",122,0)
 . . I $G(CCDAV(C0I,C0J,"measurement@value"))="" Q  ; not a valid record
"RTN","C0CDAC6",123,0)
 . . I $G(CCDAV(C0I,C0J,"measurement@value"))="Refused" Q  ; not valid
"RTN","C0CDAC6",124,0)
 . . S C0VCNT=C0VCNT+1
"RTN","C0CDAC6",125,0)
 . . S C0ARY("vitalDateTime")=C0DATE
"RTN","C0CDAC6",126,0)
 . . S C0ARY("guid2")=$$UUID^C0CDACU() ; guid for each vital
"RTN","C0CDAC6",127,0)
 . . S C0ARY("vitalsRef")="#"_$G(CCDAV(C0I,C0J,"uri"))
"RTN","C0CDAC6",128,0)
 . . S C0ARY("measurement@units")=$G(CCDAV(C0I,C0J,"measurement@units"))
"RTN","C0CDAC6",129,0)
 . . I $G(CCDAV(C0I,C0J,"measurement@metricUnits"))'="" D  ;
"RTN","C0CDAC6",130,0)
 . . . S C0ARY("measurement@units")=$G(CCDAV(C0I,C0J,"measurement@metricUnits"))
"RTN","C0CDAC6",131,0)
 . . . I C0ARY("measurement@units")="C" S C0ARY("measurement@units")="Cel"
"RTN","C0CDAC6",132,0)
 . . I C0ARY("measurement@units")="" S C0ARY("measurement@units")="UNK"
"RTN","C0CDAC6",133,0)
 . . ; convert units to UCUM
"RTN","C0CDAC6",134,0)
 . . I C0ARY("measurement@units")="in" S C0ARY("measurement@units")="[in_us]"
"RTN","C0CDAC6",135,0)
 . . I C0ARY("measurement@units")="lb" S C0ARY("measurement@units")="[lb_av]"
"RTN","C0CDAC6",136,0)
 . . I C0ARY("measurement@units")="F" S C0ARY("measurement@units")="[degF]"
"RTN","C0CDAC6",137,0)
 . . S C0ARY("measurement@value")=$G(CCDAV(C0I,C0J,"measurement@value"))
"RTN","C0CDAC6",138,0)
 . . I $G(CCDAV(C0I,C0J,"measurement@metricValue"))'="" D  ;
"RTN","C0CDAC6",139,0)
 . . . ; astro gpl
"RTN","C0CDAC6",140,0)
 . . . N C0V S C0V=$G(CCDAV(C0I,C0J,"measurement@metricValue"))
"RTN","C0CDAC6",141,0)
 . . . I C0V["." S C0V=$P(C0V,".",1)
"RTN","C0CDAC6",142,0)
 . . . S C0ARY("measurement@value")=C0V
"RTN","C0CDAC6",143,0)
 . . S C0ARY("vitalSource")=$G(CCDAV(C0I,"location@name"))
"RTN","C0CDAC6",144,0)
 . . N VIT S VIT=CCDAV(C0I,C0J,"measurement@name")
"RTN","C0CDAC6",145,0)
 . . S C0ARY("measurement@name")=VIT
"RTN","C0CDAC6",146,0)
 . . I VIT="BLOOD PRESSURE" D VITBP  Q  ;
"RTN","C0CDAC6",147,0)
 . . I '$D(VTBL(VIT)) D  ; vital not found in table
"RTN","C0CDAC6",148,0)
 . . . S C0ARY("vitalsName")=VIT
"RTN","C0CDAC6",149,0)
 . . E  D  ; found in table
"RTN","C0CDAC6",150,0)
 . . . S C0ARY("vitalsName")=VTBL(VIT,"name")
"RTN","C0CDAC6",151,0)
 . . . S C0ARY("vitalsCode")=VTBL(VIT,"loinc")
"RTN","C0CDAC6",152,0)
 . . . I C0ARY("vitalsName")="PAIN" S C0ARY("measurement@units")="1 to 10" ; fix this
"RTN","C0CDAC6",153,0)
 . . S WRK=$NA(@CCDAWRK@("VITXML",C0VCNT))
"RTN","C0CDAC6",154,0)
 . . D GETNMAP^C0CDACU(WRK,"TVITOBS^C0CDAC6","C0ARY")
"RTN","C0CDAC6",155,0)
 . . ;B
"RTN","C0CDAC6",156,0)
 . . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC6",157,0)
 . S C0VCNT=C0VCNT+1
"RTN","C0CDAC6",158,0)
 . S WRK=$NA(@CCDAWRK@("VITXML",C0VCNT))
"RTN","C0CDAC6",159,0)
 . D GET^C0CDACU(WRK,"TORGEND^C0CDAC6")
"RTN","C0CDAC6",160,0)
 . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC6",161,0)
 ;
"RTN","C0CDAC6",162,0)
 ; vital section ending
"RTN","C0CDAC6",163,0)
 ;
"RTN","C0CDAC6",164,0)
 N VITEND S VITEND=$NA(@CCDAWRK@("VITEND"))
"RTN","C0CDAC6",165,0)
 D GET^C0CDACU(VITEND,"TVITEND^C0CDAC6")
"RTN","C0CDAC6",166,0)
 D QUEUE^MXMLTMPL(BLIST,VITEND,1,@VITEND@(0))
"RTN","C0CDAC6",167,0)
 ;
"RTN","C0CDAC6",168,0)
 Q
"RTN","C0CDAC6",169,0)
 ;
"RTN","C0CDAC6",170,0)
VITBP ; special handling for blood pressure.. split into two measurements
"RTN","C0CDAC6",171,0)
 N BPVAL,SYS,DIA
"RTN","C0CDAC6",172,0)
 S BPVAL=C0ARY("measurement@value") ; ie 100/58
"RTN","C0CDAC6",173,0)
 S SYS=+$P(BPVAL,"/",1) ; numerator
"RTN","C0CDAC6",174,0)
 S DIA=+$P(BPVAL,"/",2) ; denominator
"RTN","C0CDAC6",175,0)
 I BPVAL["//" D  ; typo
"RTN","C0CDAC6",176,0)
 . S SYS=+$P(BPVAL,"//",1) ; numerator
"RTN","C0CDAC6",177,0)
 . S DIA=+$P(BPVAL,"//",2) ; denominator
"RTN","C0CDAC6",178,0)
 ;
"RTN","C0CDAC6",179,0)
 S C0ARY("vitalsName")=VTBL("BP SYSTOLIC","name")
"RTN","C0CDAC6",180,0)
 S C0ARY("vitalsCode")=VTBL("BP SYSTOLIC","loinc")
"RTN","C0CDAC6",181,0)
 S C0ARY("measurement@value")=SYS
"RTN","C0CDAC6",182,0)
 S C0VCNT=C0VCNT+1
"RTN","C0CDAC6",183,0)
 S WRK=$NA(@CCDAWRK@("VITXML",C0VCNT))
"RTN","C0CDAC6",184,0)
 D GETNMAP^C0CDACU(WRK,"TVITOBS^C0CDAC6","C0ARY")
"RTN","C0CDAC6",185,0)
 D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC6",186,0)
 ;
"RTN","C0CDAC6",187,0)
 S C0ARY("vitalsName")=VTBL("BP DIASTOLIC","name")
"RTN","C0CDAC6",188,0)
 S C0ARY("vitalsCode")=VTBL("BP DIASTOLIC","loinc")
"RTN","C0CDAC6",189,0)
 S C0ARY("measurement@value")=DIA
"RTN","C0CDAC6",190,0)
 S C0VCNT=C0VCNT+1
"RTN","C0CDAC6",191,0)
 S WRK=$NA(@CCDAWRK@("VITXML",C0VCNT))
"RTN","C0CDAC6",192,0)
 D GETNMAP^C0CDACU(WRK,"TVITOBS^C0CDAC6","C0ARY")
"RTN","C0CDAC6",193,0)
 D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC6",194,0)
 Q
"RTN","C0CDAC6",195,0)
 ;
"RTN","C0CDAC6",196,0)
INITBL(TBL) ; initialize vitals coding table
"RTN","C0CDAC6",197,0)
 ; 
"RTN","C0CDAC6",198,0)
 S TBL("TEMPERATURE","loinc")="8310-5"
"RTN","C0CDAC6",199,0)
 S TBL("TEMPERATURE","name")="Body Temperature"
"RTN","C0CDAC6",200,0)
 S TBL("BP DIASTOLIC","loinc")="8462-4"
"RTN","C0CDAC6",201,0)
 S TBL("BP DIASTOLIC","name")="INTRAVASCULAR DIASTOLIC"
"RTN","C0CDAC6",202,0)
 S TBL("BP SYSTOLIC","loinc")="8480-6"
"RTN","C0CDAC6",203,0)
 S TBL("BP SYSTOLIC","name")="INTRAVASCULAR SYSTOLIC"
"RTN","C0CDAC6",204,0)
 S TBL("HEAD","loinc")="8287-5"
"RTN","C0CDAC6",205,0)
 S TBL("HEAD","name")="Head Circumference"
"RTN","C0CDAC6",206,0)
 S TBL("PULSE","loinc")="8867-4"
"RTN","C0CDAC6",207,0)
 S TBL("PULSE","name")="Heart Rate"
"RTN","C0CDAC6",208,0)
 S TBL("HEIGHT","loinc")="8302-2"
"RTN","C0CDAC6",209,0)
 S TBL("HEIGHT","name")="Height"
"RTN","C0CDAC6",210,0)
 S TBL("HEIGHT LYING","loinc")="8306-3"
"RTN","C0CDAC6",211,0)
 S TBL("HEIGHT LYING","name")="Height (Lying)"
"RTN","C0CDAC6",212,0)
 S TBL("PULSE OXIMETRY","loinc")="59408-5"
"RTN","C0CDAC6",213,0)
 ;S TBL("PULSE OXIMETRY","loinc")="2710-2"
"RTN","C0CDAC6",214,0)
 S TBL("PULSE OXIMETRY","name")="OXYGEN SATURATION"
"RTN","C0CDAC6",215,0)
 S TBL("RESPIRATION","loinc")="9279-1"
"RTN","C0CDAC6",216,0)
 S TBL("RESPIRATION","name")="Respiratory Rate"
"RTN","C0CDAC6",217,0)
 ;S TBL("WEIGHT","loinc")="3141-9"
"RTN","C0CDAC6",218,0)
 ;S TBL("WEIGHT","name")="Weight Measured"
"RTN","C0CDAC6",219,0)
 S TBL("WEIGHT","loinc")="29463-7"
"RTN","C0CDAC6",220,0)
 S TBL("WEIGHT","name")="Body Weight"
"RTN","C0CDAC6",221,0)
 S TBL("PAIN","loinc")="38214-3"
"RTN","C0CDAC6",222,0)
 S TBL("PAIN","name")="PAIN SEVERITY"
"RTN","C0CDAC6",223,0)
 Q
"RTN","C0CDAC6",224,0)
 ;
"RTN","C0CDAC6",225,0)
POSTPRS(OARY,IARY) ; further parse the vitals array. 
"RTN","C0CDAC6",226,0)
 ; OARY (output array) and IARY (input array) are passed by reference
"RTN","C0CDAC6",227,0)
 ; here's a sample we will work from:
"RTN","C0CDAC6",228,0)
 ;G("vital",101,"entered@value")=3080930.12033
"RTN","C0CDAC6",229,0)
 ;G("vital",101,"facility@code")=195966
"RTN","C0CDAC6",230,0)
 ;G("vital",101,"facility@name")="OROVILLE HOSPITAL"
"RTN","C0CDAC6",231,0)
 ;G("vital",101,"location@code")=3
"RTN","C0CDAC6",232,0)
 ;G("vital",101,"location@name")="IF-FINE"
"RTN","C0CDAC6",233,0)
 ;G("vital",101,"measurements.measurement[1].qualifiers.qualifier[1]@name")="L ARM"
"RTN","C0CDAC6",234,0)
 ;G("vital",101,"measurements.measurement[1].qualifiers.qualifier[2]@name")="SITTING"
"RTN","C0CDAC6",235,0)
 ;G("vital",101,"measurements.measurement[1].qualifiers.qualifier[3]@name")="CUFF"
"RTN","C0CDAC6",236,0)
 ;G("vital",101,"measurements.measurement[1].qualifiers.qualifier[4]@name")="ADULT"
"RTN","C0CDAC6",237,0)
 ;G("vital",101,"measurements.measurement[1]@high")="210/110"
"RTN","C0CDAC6",238,0)
 ;G("vital",101,"measurements.measurement[1]@id")=52
"RTN","C0CDAC6",239,0)
 ;G("vital",101,"measurements.measurement[1]@low")="100/60"
"RTN","C0CDAC6",240,0)
 ;G("vital",101,"measurements.measurement[1]@name")="BLOOD PRESSURE"
"RTN","C0CDAC6",241,0)
 ;G("vital",101,"measurements.measurement[1]@units")="mm[Hg]"
"RTN","C0CDAC6",242,0)
 ;G("vital",101,"measurements.measurement[1]@value")="156/72"
"RTN","C0CDAC6",243,0)
 ;G("vital",101,"measurements.measurement[1]@vuid")=4500634
"RTN","C0CDAC6",244,0)
 ;G("vital",101,"measurements.measurement[2].qualifiers.qualifier@name")="ACTUAL"
"RTN","C0CDAC6",245,0)
 ;G("vital",101,"measurements.measurement[2]@id")=55
"RTN","C0CDAC6",246,0)
 ;G("vital",101,"measurements.measurement[2]@metricUnits")="cm"
"RTN","C0CDAC6",247,0)
 ;G("vital",101,"measurements.measurement[2]@metricValue")=182.88
"RTN","C0CDAC6",248,0)
 ;G("vital",101,"measurements.measurement[2]@name")="HEIGHT"
"RTN","C0CDAC6",249,0)
 ;G("vital",101,"measurements.measurement[2]@units")="in"
"RTN","C0CDAC6",250,0)
 ;G("vital",101,"measurements.measurement[2]@value")=72
"RTN","C0CDAC6",251,0)
 ;G("vital",101,"measurements.measurement[2]@vuid")=4688724
"RTN","C0CDAC6",252,0)
 ;G("vital",101,"measurements.measurement[3].qualifiers.qualifier[1]@name")="RADIAL"
"RTN","C0CDAC6",253,0)
 ;G("vital",101,"measurements.measurement[3].qualifiers.qualifier[2]@name")="SITTING"
"RTN","C0CDAC6",254,0)
 ;G("vital",101,"measurements.measurement[3].qualifiers.qualifier[3]@name")="PALPATED"
"RTN","C0CDAC6",255,0)
 ;G("vital",101,"measurements.measurement[3].qualifiers.qualifier[4]@name")="LEFT"
"RTN","C0CDAC6",256,0)
 ;G("vital",101,"measurements.measurement[3]@high")=120
"RTN","C0CDAC6",257,0)
 ;G("vital",101,"measurements.measurement[3]@id")=50
"RTN","C0CDAC6",258,0)
 ;G("vital",101,"measurements.measurement[3]@low")=60
"RTN","C0CDAC6",259,0)
 ;G("vital",101,"measurements.measurement[3]@name")="PULSE"
"RTN","C0CDAC6",260,0)
 ;G("vital",101,"measurements.measurement[3]@units")="/min"
"RTN","C0CDAC6",261,0)
 ;G("vital",101,"measurements.measurement[3]@value")=96
"RTN","C0CDAC6",262,0)
 ;G("vital",101,"measurements.measurement[3]@vuid")=4500636
"RTN","C0CDAC6",263,0)
 ;G("vital",101,"measurements.measurement[4]@id")=53
"RTN","C0CDAC6",264,0)
 ;G("vital",101,"measurements.measurement[4]@name")="PAIN"
"RTN","C0CDAC6",265,0)
 ;G("vital",101,"measurements.measurement[4]@value")=1
"RTN","C0CDAC6",266,0)
 ;G("vital",101,"measurements.measurement[4]@vuid")=4500635
"RTN","C0CDAC6",267,0)
 ;G("vital",101,"measurements.measurement[5]@high")=100
"RTN","C0CDAC6",268,0)
 ;G("vital",101,"measurements.measurement[5]@id")=54
"RTN","C0CDAC6",269,0)
 ;G("vital",101,"measurements.measurement[5]@low")=0
"RTN","C0CDAC6",270,0)
 ;G("vital",101,"measurements.measurement[5]@name")="PULSE OXIMETRY"
"RTN","C0CDAC6",271,0)
 ;G("vital",101,"measurements.measurement[5]@units")="%"
"RTN","C0CDAC6",272,0)
 ;G("vital",101,"measurements.measurement[5]@value")=98
"RTN","C0CDAC6",273,0)
 ;G("vital",101,"measurements.measurement[5]@vuid")=4500637
"RTN","C0CDAC6",274,0)
 ;G("vital",101,"measurements.measurement[6].qualifiers.qualifier[1]@name")="SPONTANEOUS"
"RTN","C0CDAC6",275,0)
 ;G("vital",101,"measurements.measurement[6].qualifiers.qualifier[2]@name")="SITTING"
"RTN","C0CDAC6",276,0)
 ;G("vital",101,"measurements.measurement[6]@high")=30
"RTN","C0CDAC6",277,0)
 ;G("vital",101,"measurements.measurement[6]@id")=51
"RTN","C0CDAC6",278,0)
 ;G("vital",101,"measurements.measurement[6]@low")=8
"RTN","C0CDAC6",279,0)
 ;G("vital",101,"measurements.measurement[6]@name")="RESPIRATION"
"RTN","C0CDAC6",280,0)
 ;G("vital",101,"measurements.measurement[6]@units")="/min"
"RTN","C0CDAC6",281,0)
 ;G("vital",101,"measurements.measurement[6]@value")=20
"RTN","C0CDAC6",282,0)
 ;G("vital",101,"measurements.measurement[6]@vuid")=4688725
"RTN","C0CDAC6",283,0)
 ;G("vital",101,"measurements.measurement[7].qualifiers.qualifier@name")="ORAL"
"RTN","C0CDAC6",284,0)
 ;G("vital",101,"measurements.measurement[7]@high")=102
"RTN","C0CDAC6",285,0)
 ;G("vital",101,"measurements.measurement[7]@id")=49
"RTN","C0CDAC6",286,0)
 ;G("vital",101,"measurements.measurement[7]@low")=95
"RTN","C0CDAC6",287,0)
 ;G("vital",101,"measurements.measurement[7]@metricUnits")="C"
"RTN","C0CDAC6",288,0)
 ;G("vital",101,"measurements.measurement[7]@metricValue")=37.5
"RTN","C0CDAC6",289,0)
 ;G("vital",101,"measurements.measurement[7]@name")="TEMPERATURE"
"RTN","C0CDAC6",290,0)
 ;G("vital",101,"measurements.measurement[7]@units")="F"
"RTN","C0CDAC6",291,0)
 ;G("vital",101,"measurements.measurement[7]@value")=99.5
"RTN","C0CDAC6",292,0)
 ;G("vital",101,"measurements.measurement[7]@vuid")=4500638
"RTN","C0CDAC6",293,0)
 ;G("vital",101,"measurements.measurement[8].qualifiers.qualifier[1]@name")="ACTUAL"
"RTN","C0CDAC6",294,0)
 ;G("vital",101,"measurements.measurement[8].qualifiers.qualifier[2]@name")="STANDING"
"RTN","C0CDAC6",295,0)
 ;G("vital",101,"measurements.measurement[8]@id")=56
"RTN","C0CDAC6",296,0)
 ;G("vital",101,"measurements.measurement[8]@metricUnits")="kg"
"RTN","C0CDAC6",297,0)
 ;G("vital",101,"measurements.measurement[8]@metricValue")=88.64
"RTN","C0CDAC6",298,0)
 ;G("vital",101,"measurements.measurement[8]@name")="WEIGHT"
"RTN","C0CDAC6",299,0)
 ;G("vital",101,"measurements.measurement[8]@units")="lb"
"RTN","C0CDAC6",300,0)
 ;G("vital",101,"measurements.measurement[8]@value")=195
"RTN","C0CDAC6",301,0)
 ;G("vital",101,"measurements.measurement[8]@vuid")=4500639
"RTN","C0CDAC6",302,0)
 ;G("vital",101,"taken@value")=3080930.130648
"RTN","C0CDAC6",303,0)
 ;
"RTN","C0CDAC6",304,0)
 N C0I,C0I2,C0I3,C0N1,C0N2,C0V
"RTN","C0CDAC6",305,0)
 S C0I=$O(IARY("")) ; vital
"RTN","C0CDAC6",306,0)
 S C0N1=0
"RTN","C0CDAC6",307,0)
 F  S C0N1=$O(IARY(C0I,C0N1)) Q:+C0N1=0  D  ;
"RTN","C0CDAC6",308,0)
 . S C0I2=""
"RTN","C0CDAC6",309,0)
 . F  S C0I2=$O(IARY(C0I,C0N1,C0I2)) Q:C0I2=""  D  ;
"RTN","C0CDAC6",310,0)
 . . S C0V=IARY(C0I,C0N1,C0I2) ; value
"RTN","C0CDAC6",311,0)
 . . I C0I2["qualifiers.qualifier" D  Q  ;
"RTN","C0CDAC6",312,0)
 . . . W:$G(C0DEBUG) !,"found qualifier: ",C0I2
"RTN","C0CDAC6",313,0)
 . . . S C0N2=$P($P(C0I2,"measurements.measurement[",2),"]",1) ; [x] value
"RTN","C0CDAC6",314,0)
 . . . I C0I2["qualifier@" D  Q  ;
"RTN","C0CDAC6",315,0)
 . . . . N C0VV S C0VV="qualifier@"_$P(C0I2,"qualifier@",2) 
"RTN","C0CDAC6",316,0)
 . . . . S OARY(C0N1,C0N2,C0VV,1)=C0V
"RTN","C0CDAC6",317,0)
 . . . E  D  Q  ;
"RTN","C0CDAC6",318,0)
 . . . . N C0N3 S C0N3=$P($P(C0I2,"qualifier[",2),"]",1) ; [y] value
"RTN","C0CDAC6",319,0)
 . . . . S OARY(C0N1,C0N2,"qualifier",C0N3)=C0V
"RTN","C0CDAC6",320,0)
 . . I C0I2["measurements.measurement[" D  Q  ;
"RTN","C0CDAC6",321,0)
 . . . N C0VN S C0VN=$P(C0I2,"]",2) ; @variableName
"RTN","C0CDAC6",322,0)
 . . . S C0N2=$P($P(C0I2,"measurements.measurement[",2),"]",1) ; [x] value
"RTN","C0CDAC6",323,0)
 . . . S OARY(C0N1,C0N2,"measurement"_C0VN)=C0V
"RTN","C0CDAC6",324,0)
 . . . W:$G(C0DEBUG) !,"found measurement: ",C0VN," ",C0I2
"RTN","C0CDAC6",325,0)
 . . E  I C0I2["measurements.measurement@" D  Q  ;
"RTN","C0CDAC6",326,0)
 . . . N C0VN S C0VN=$P(C0I2,"measurements.",2)
"RTN","C0CDAC6",327,0)
 . . . S OARY(C0N1,1,C0VN)=C0V
"RTN","C0CDAC6",328,0)
 . . . W:$G(C0DEBUG) !,"found solo measurement: ",C0VN," ",C0I2
"RTN","C0CDAC6",329,0)
 . . S OARY(C0N1,C0I2)=C0V
"RTN","C0CDAC6",330,0)
 I $D(C0DEBUG) B
"RTN","C0CDAC6",331,0)
 Q
"RTN","C0CDAC6",332,0)
 ;
"RTN","C0CDAC6",333,0)
TVITSEC ;
"RTN","C0CDAC6",334,0)
 ;;<component>
"RTN","C0CDAC6",335,0)
 ;;<section classCode="DOCSECT" moodCode="EVN">
"RTN","C0CDAC6",336,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.4.1"></templateId>
"RTN","C0CDAC6",337,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.4.1" extension="2015-08-01"></templateId>
"RTN","C0CDAC6",338,0)
 ;;<code code="8716-3" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Vital Signs"></code>
"RTN","C0CDAC6",339,0)
 Q
"RTN","C0CDAC6",340,0)
 ;
"RTN","C0CDAC6",341,0)
TVITORG ; vitals organizer
"RTN","C0CDAC6",342,0)
 ;;<entry>
"RTN","C0CDAC6",343,0)
 ;;<organizer classCode="CLUSTER" moodCode="EVN">
"RTN","C0CDAC6",344,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.26"></templateId>
"RTN","C0CDAC6",345,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.26" extension="2015-08-01"></templateId>
"RTN","C0CDAC6",346,0)
 ;;<id root="@@guid1@@"></id>
"RTN","C0CDAC6",347,0)
 ;;<code code="46680005" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED" displayName="vital signs">
"RTN","C0CDAC6",348,0)
 ;;<translation code="74728-7" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Vital signs, weight, height, head circumference, oximetry, BMI, and BSA panel - HL7.CCDAr1.1" />
"RTN","C0CDAC6",349,0)
 ;;</code>
"RTN","C0CDAC6",350,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC6",351,0)
 ;;<effectiveTime value="@@vitalDateTime@@"></effectiveTime>
"RTN","C0CDAC6",352,0)
 Q
"RTN","C0CDAC6",353,0)
 ;
"RTN","C0CDAC6",354,0)
TVITOBS ; vitals observation
"RTN","C0CDAC6",355,0)
 ;;<component>
"RTN","C0CDAC6",356,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC6",357,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.27"></templateId>
"RTN","C0CDAC6",358,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.27" extension="2014-06-09"></templateId>
"RTN","C0CDAC6",359,0)
 ;;<id root="@@guid2@@"></id>
"RTN","C0CDAC6",360,0)
 ;;<code code="@@vitalsCode@@" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="@@vitalsName@@">
"RTN","C0CDAC6",361,0)
 ;;<originalText>@@measurement@name@@</originalText>
"RTN","C0CDAC6",362,0)
 ;;</code>
"RTN","C0CDAC6",363,0)
 ;;<text mediaType="text/plain">
"RTN","C0CDAC6",364,0)
 ;;<reference value="@@vitalsRef@@"></reference>
"RTN","C0CDAC6",365,0)
 ;;</text>
"RTN","C0CDAC6",366,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC6",367,0)
 ;;<effectiveTime value="@@vitalDateTime@@"></effectiveTime>
"RTN","C0CDAC6",368,0)
 ;;<value unit="@@measurement@units@@" value="@@measurement@value@@" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="PQ"></value>
"RTN","C0CDAC6",369,0)
 ;;<entryRelationship contextConductionInd="true" typeCode="REFR">
"RTN","C0CDAC6",370,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC6",371,0)
 ;;<code code="48766-0" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Information source"></code>
"RTN","C0CDAC6",372,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC6",373,0)
 ;;<value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ST">@@vitalSource@@</value>
"RTN","C0CDAC6",374,0)
 ;;</observation>
"RTN","C0CDAC6",375,0)
 ;;</entryRelationship>
"RTN","C0CDAC6",376,0)
 ;;</observation>
"RTN","C0CDAC6",377,0)
 ;;</component>
"RTN","C0CDAC6",378,0)
 Q
"RTN","C0CDAC6",379,0)
 ;
"RTN","C0CDAC6",380,0)
TORGEND ;
"RTN","C0CDAC6",381,0)
 ;;</organizer>
"RTN","C0CDAC6",382,0)
 ;;</entry>
"RTN","C0CDAC6",383,0)
 Q
"RTN","C0CDAC6",384,0)
 ;
"RTN","C0CDAC6",385,0)
TVITEND ;
"RTN","C0CDAC6",386,0)
 ;;</section>
"RTN","C0CDAC6",387,0)
 ;;</component>
"RTN","C0CDAC6",388,0)
 Q
"RTN","C0CDAC6",389,0)
 ;
"RTN","C0CDAC7")
0^8^B78096691
"RTN","C0CDAC7",1,0)
C0CDAC7 ; GPL - Patient Portal - CCDA Routines ;09/17/13  17:05
"RTN","C0CDAC7",2,0)
 ;;0.1;JJOHPP;nopatch;noreleasedate;Build 1
"RTN","C0CDAC7",3,0)
 ;
"RTN","C0CDAC7",4,0)
 ; License AGPL v3.0
"RTN","C0CDAC7",5,0)
 ; 
"RTN","C0CDAC7",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDAC7",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDAC7",8,0)
 Q
"RTN","C0CDAC7",9,0)
 ;
"RTN","C0CDAC7",10,0)
MEASURE ; see what smoking health factors are being used
"RTN","C0CDAC7",11,0)
 ;
"RTN","C0CDAC7",12,0)
 ;N GN S GN=$NA(^C0Q(301,59,1,"B")) ; list of patients with smoking status
"RTN","C0CDAC7",13,0)
 N GN S GN=$NA(^DPT)
"RTN","C0CDAC7",14,0)
 K ^KBAI("HF")
"RTN","C0CDAC7",15,0)
 N ZI S ZI=0
"RTN","C0CDAC7",16,0)
 F  S ZI=$O(@GN@(ZI)) Q:+ZI=0  D  ;
"RTN","C0CDAC7",17,0)
 . S DFN=ZI
"RTN","C0CDAC7",18,0)
 . S ZYR="MU14"
"RTN","C0CDAC7",19,0)
 . W !,"DFN: ",DFN
"RTN","C0CDAC7",20,0)
 . D SMOKING^C0QMU121
"RTN","C0CDAC7",21,0)
 ;ZWR ^KBAI("HF",*)
"RTN","C0CDAC7",22,0)
 Q
"RTN","C0CDAC7",23,0)
 ;
"RTN","C0CDAC7",24,0)
SOC(BLIST,DFN,CCDAWRK,CCDARPT,CCDACTRL) ;
"RTN","C0CDAC7",25,0)
 ;
"RTN","C0CDAC7",26,0)
 N CCDAV,CCDAV1
"RTN","C0CDAC7",27,0)
 S @CCDARPT@("STATUS")="EXTRACTING"
"RTN","C0CDAC7",28,0)
 S @CCDARPT@("EXTRACT-BEGIN")=$$NOW^XLFDT
"RTN","C0CDAC7",29,0)
 D GETPAT^C0CDACE(.CCDAV1,DFN,"health-factors")
"RTN","C0CDAC7",30,0)
 I '$D(CCDAV1) Q  ;
"RTN","C0CDAC7",31,0)
 D FILTER(.CCDAV,$NA(CCDAV1("results","healthFactors"))) ; find relevant
"RTN","C0CDAC7",32,0)
 S @CCDARPT@("EXTRACT-ENDS")=$$NOW^XLFDT
"RTN","C0CDAC7",33,0)
 ;
"RTN","C0CDAC7",34,0)
 ; social history section html
"RTN","C0CDAC7",35,0)
 ;
"RTN","C0CDAC7",36,0)
 N C0HTML,C0ARY
"RTN","C0CDAC7",37,0)
 S C0ARY("TITLE")="Social History"
"RTN","C0CDAC7",38,0)
 S C0ARY("HEADER",1)="Start Date"
"RTN","C0CDAC7",39,0)
 ;S C0ARY("HEADER",2)="End Date"
"RTN","C0CDAC7",40,0)
 S C0ARY("HEADER",3)="Type"
"RTN","C0CDAC7",41,0)
 S C0ARY("HEADER",4)="Comments"
"RTN","C0CDAC7",42,0)
 S C0ARY("HEADER",5)="Source"
"RTN","C0CDAC7",43,0)
 ;
"RTN","C0CDAC7",44,0)
 N C0I S C0I=0
"RTN","C0CDAC7",45,0)
 F  S C0I=$O(CCDAV(C0I)) Q:+C0I=0  D  ;
"RTN","C0CDAC7",46,0)
 . N C0DATE S C0DATE=$G(CCDAV(C0I,"factor","recorded@value"))
"RTN","C0CDAC7",47,0)
 . N GGID S GGID="uri_SCT-"_$G(CCDAV(C0I,"factor","snomed@code"))
"RTN","C0CDAC7",48,0)
 . S CCDAV(C0I,"uri")=GGID
"RTN","C0CDAC7",49,0)
 . Q:$$REDACT^C0CDACV(CCDAV(C0I,"uri"),.PARMS)
"RTN","C0CDAC7",50,0)
 . I C0DATE'="" S C0ARY(C0I,1)=$$HTMLDT^C0CDACU(C0DATE) ; health factor date
"RTN","C0CDAC7",51,0)
 . E  S C0ARY(C0I,1)=""
"RTN","C0CDAC7",52,0)
 . S C0ARY(C0I,1,"ID")=$G(CCDAV(C0I,"uri"))
"RTN","C0CDAC7",53,0)
 . ;S C0ARY(C0I,2)="" ;"not available"
"RTN","C0CDAC7",54,0)
 . S C0ARY(C0I,3)=CCDAV(C0I,"factor","snomed@text") ; health factor name
"RTN","C0CDAC7",55,0)
 . S C0ARY(C0I,4)="Snomed Code: "_CCDAV(C0I,"factor","snomed@code")
"RTN","C0CDAC7",56,0)
 . ;N ZDUZ S ZDUZ=CCDAV(C0I,"factor","id@value") ; source
"RTN","C0CDAC7",57,0)
 . S C0ARY(C0I,5)=CCDAV(C0I,"factor","facility@name")
"RTN","C0CDAC7",58,0)
 ;
"RTN","C0CDAC7",59,0)
 I +$O(C0ARY("AAAAA"),-1)=0 Q  ; all social history has been redacted
"RTN","C0CDAC7",60,0)
 ;
"RTN","C0CDAC7",61,0)
 ; the social history section component
"RTN","C0CDAC7",62,0)
 ;
"RTN","C0CDAC7",63,0)
 N SSECT S SSECT=$NA(@CCDAWRK@("SOCSECT"))
"RTN","C0CDAC7",64,0)
 D GET^C0CDACU(SSECT,"TSOCSEC^C0CDAC7")
"RTN","C0CDAC7",65,0)
 D QUEUE^MXMLTMPL(BLIST,SSECT,1,@SSECT@(0))
"RTN","C0CDAC7",66,0)
 ;
"RTN","C0CDAC7",67,0)
 ; social history html generation
"RTN","C0CDAC7",68,0)
 ;
"RTN","C0CDAC7",69,0)
 N SHTML S SHTML=$NA(@CCDAWRK@("SOCHTML"))
"RTN","C0CDAC7",70,0)
 D GENHTML^C0CDACU(SHTML,"C0ARY")
"RTN","C0CDAC7",71,0)
 D QUEUE^MXMLTMPL(BLIST,SHTML,1,@SHTML@(0))
"RTN","C0CDAC7",72,0)
 ;
"RTN","C0CDAC7",73,0)
 ; social history xml generation
"RTN","C0CDAC7",74,0)
 ;
"RTN","C0CDAC7",75,0)
 N WRK
"RTN","C0CDAC7",76,0)
 F  S C0I=$O(CCDAV(C0I)) Q:+C0I=0  D  ;
"RTN","C0CDAC7",77,0)
 . Q:$$REDACT^C0CDACV(CCDAV(C0I,"uri"),.PARMS)
"RTN","C0CDAC7",78,0)
 . K C0ARY
"RTN","C0CDAC7",79,0)
 . S C0ARY("uri")=$G(CCDAV(C0I,"uri"))
"RTN","C0CDAC7",80,0)
 . I C0ARY("uri")="" S C0ARY("uri")="uri-SCT-unknown"
"RTN","C0CDAC7",81,0)
 . M C0ARY=CCDAV(C0I,"factor")
"RTN","C0CDAC7",82,0)
 . S C0ARY("guid")=$$UUID^C0CDACU() ; random
"RTN","C0CDAC7",83,0)
 . S C0ARY("orgOID")=$$ORGOID^C0CDACU() ; fetch organization OID
"RTN","C0CDAC7",84,0)
 . N C0D S C0D=$G(CCDAV(C0I,"factor","recorded@value"))
"RTN","C0CDAC7",85,0)
 . N C0DATE
"RTN","C0CDAC7",86,0)
 . I C0D'="" D  ;
"RTN","C0CDAC7",87,0)
 . . S C0DATE=$$FMDTOUTC^C0CDACU(C0D)
"RTN","C0CDAC7",88,0)
 . E  S C0DATE=""
"RTN","C0CDAC7",89,0)
 . S C0ARY("effectiveDate")=C0DATE
"RTN","C0CDAC7",90,0)
 . S WRK=$NA(@CCDAWRK@("SOC",C0I))
"RTN","C0CDAC7",91,0)
 . D GETNMAP^C0CDACU(WRK,"TSOC^C0CDAC7","C0ARY")
"RTN","C0CDAC7",92,0)
 . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC7",93,0)
 ;
"RTN","C0CDAC7",94,0)
 ; social history section ending
"RTN","C0CDAC7",95,0)
 ;
"RTN","C0CDAC7",96,0)
 N SOCEND S SOCEND=$NA(@CCDAWRK@("SOCEND"))
"RTN","C0CDAC7",97,0)
 D GET^C0CDACU(SOCEND,"TSOCEND^C0CDAC7")
"RTN","C0CDAC7",98,0)
 D QUEUE^MXMLTMPL(BLIST,SOCEND,1,@SOCEND@(0))
"RTN","C0CDAC7",99,0)
 ;
"RTN","C0CDAC7",100,0)
 Q
"RTN","C0CDAC7",101,0)
 ;
"RTN","C0CDAC7",102,0)
FILTER(RTN,ZARY) ; filter health factors for Smoking factors
"RTN","C0CDAC7",103,0)
 ; add Snomed codes and text to results
"RTN","C0CDAC7",104,0)
 ; RTN passed by reference. ZARY passed by name
"RTN","C0CDAC7",105,0)
 ;
"RTN","C0CDAC7",106,0)
 ; - sort not needed, the health factor are already sorted reverse data order
"RTN","C0CDAC7",107,0)
 ;
"RTN","C0CDAC7",108,0)
 N SMOTBL D SNOTBL("SMOTBL") ; initialize lookup table
"RTN","C0CDAC7",109,0)
 N DONE S DONE=0
"RTN","C0CDAC7",110,0)
 N ZI S ZI=""
"RTN","C0CDAC7",111,0)
 F  S ZI=$O(@ZARY@(ZI)) Q:DONE  Q:ZI=""  D  ;
"RTN","C0CDAC7",112,0)
 . N HF S HF=$G(@ZARY@(ZI,"factor","name@value")) ; name of the health factor
"RTN","C0CDAC7",113,0)
 . I '$D(SMOTBL(HF)) Q  ;
"RTN","C0CDAC7",114,0)
 . N SNO S SNO=$O(SMOTBL(HF,""))
"RTN","C0CDAC7",115,0)
 . S RTN(1,"factor","snomed@code")=SNO
"RTN","C0CDAC7",116,0)
 . S RTN(1,"factor","snomed@text")=$O(SMOTBL(HF,SNO,""))
"RTN","C0CDAC7",117,0)
 . S RTN(1,"factor","recorded@value")=$G(@ZARY@(ZI,"factor","recorded@value"))
"RTN","C0CDAC7",118,0)
 . S RTN(1,"factor","facility@name")=$G(@ZARY@(ZI,"factor","facility@name"))
"RTN","C0CDAC7",119,0)
 . S DONE=1
"RTN","C0CDAC7",120,0)
 I 'DONE D  ; no smoking health factors found
"RTN","C0CDAC7",121,0)
 . S RTN(1,"factor","snomed@code")=266927001
"RTN","C0CDAC7",122,0)
 . S RTN(1,"factor","snomed@text")="Unknown if ever smoked."
"RTN","C0CDAC7",123,0)
 . S RTN(1,"factor","recorded@value")=$$NOW^XLFDT ; we found out now
"RTN","C0CDAC7",124,0)
 . N C0FAC S C0FAC=$G(@ZARY@(ZI,"factor","facility@name"))
"RTN","C0CDAC7",125,0)
 . I C0FAC="" D  ;
"RTN","C0CDAC7",126,0)
 . . N C0ORG D SETORGV^C0CDAC2(.C0ORG,DUZ,$G(DUZ(2)))
"RTN","C0CDAC7",127,0)
 . . S C0FAC=C0ORG("orgName")
"RTN","C0CDAC7",128,0)
 . S RTN(1,"factor","facility@name")=C0FAC
"RTN","C0CDAC7",129,0)
 Q
"RTN","C0CDAC7",130,0)
 ;
"RTN","C0CDAC7",131,0)
SNOTBL(ZA) ; initializes smoking health factor snomed lookup table
"RTN","C0CDAC7",132,0)
 S @ZA@("Smokeless Tobacco User",77176002,"Smoker, current status unknown")=""
"RTN","C0CDAC7",133,0)
 S @ZA@("Current Smoker - Yes",77176002,"Smoker, current status unknown")=""
"RTN","C0CDAC7",134,0)
 S @ZA@("Smoking Cessation (OPH)",77176002,"Smoker, current status unknown")=""
"RTN","C0CDAC7",135,0)
 S @ZA@("Former Smoker",8517006,"Former smoker.")=""
"RTN","C0CDAC7",136,0)
 S @ZA@("Smoking (PMH)",8517006,"Former smoker.")=""
"RTN","C0CDAC7",137,0)
 S @ZA@("Quit Smokeless Tobacco <1 Yr Ago",8517006,"Former smoker.")=""
"RTN","C0CDAC7",138,0)
 S @ZA@("Quit Smokeless Tobacco > 20 Yrs Ago",8517006,"Former smoker.")=""
"RTN","C0CDAC7",139,0)
 S @ZA@("Quit Smokeless Tobacco: 1-5 Yrs Ago",8517006,"Former smoker.")=""
"RTN","C0CDAC7",140,0)
 S @ZA@("Quit Smoking",8517006,"Former smoker.")=""
"RTN","C0CDAC7",141,0)
 S @ZA@("Quit Smoking < 1 Yr Ago",8517006,"Former smoker.")=""
"RTN","C0CDAC7",142,0)
 S @ZA@("Quit Smoking > 20 Yrs Ago",8517006,"Former smoker.")=""
"RTN","C0CDAC7",143,0)
 S @ZA@("Quit Smoking: 1-5 Yrs Ago",8517006,"Former smoker.")=""
"RTN","C0CDAC7",144,0)
 S @ZA@("Quit Smoking: 10-20 Yrs Ago",8517006,"Former smoker.")=""
"RTN","C0CDAC7",145,0)
 S @ZA@("Quit Smoking: 5-10 Yrs Ago",8517006,"Former smoker.")=""
"RTN","C0CDAC7",146,0)
 S @ZA@("Non-Smoker",266919005,"Never smoker.")=""
"RTN","C0CDAC7",147,0)
 S @ZA@("Non-Tobacco User",266919005,"Never smoker.")=""
"RTN","C0CDAC7",148,0)
 S @ZA@("Current Smoker - No",266919005,"Never smoker.")=""
"RTN","C0CDAC7",149,0)
 S @ZA@("STATUS-CURRENT EVERY DAY SMOKER (001)",449868002,"Current every day smoker.")=""
"RTN","C0CDAC7",150,0)
 S @ZA@("STATUS-CURRENT SOME DAY SMOKER (002)",428041000124106,"Current some day smoker.")=""
"RTN","C0CDAC7",151,0)
 S @ZA@("STATUS-FORMER SMOKER (003)",8517006,"Former smoker.")=""
"RTN","C0CDAC7",152,0)
 S @ZA@("STATUS-NEVER SMOKER (004)",266919005,"Never smoker.")=""
"RTN","C0CDAC7",153,0)
 S @ZA@("STATUS-SMOKER, CURRENT STATUS UNK (005)",77176002,"Smoker, current status unknown.")=""
"RTN","C0CDAC7",154,0)
 S @ZA@("STATUS-UNKNOWN IF EVER SMOKED (009)",266927001,"Unknown if ever smoked.")=""
"RTN","C0CDAC7",155,0)
 ; gpl astro
"RTN","C0CDAC7",156,0)
 S @ZA@("TMG TOBACCO EVERYDAY USER",449868002,"Smokes tobacco daily (finding)")=""
"RTN","C0CDAC7",157,0)
 Q
"RTN","C0CDAC7",158,0)
 ;
"RTN","C0CDAC7",159,0)
SORTBD(ZOUT,ZIN) ; sort health factors to reverse date order
"RTN","C0CDAC7",160,0)
 N ZZI,ZZJ,ZTMP
"RTN","C0CDAC7",161,0)
 S ZZI=""
"RTN","C0CDAC7",162,0)
 F  S ZZI=$O(@ZIN@(ZZI)) Q:ZZI=""  D  ;
"RTN","C0CDAC7",163,0)
 . N ZDT S ZDT=$G(@ZIN@(ZZI,"factor","recorded@value"))
"RTN","C0CDAC7",164,0)
 . I ZDT="" Q  ;
"RTN","C0CDAC7",165,0)
 . S ZTMP(ZDT,ZZI)=""
"RTN","C0CDAC7",166,0)
 S ZZI=""
"RTN","C0CDAC7",167,0)
 S ZCNT=0
"RTN","C0CDAC7",168,0)
 F  S ZZI=$O(ZTMP(ZZI),-1) Q:ZZI=""  D  ;
"RTN","C0CDAC7",169,0)
 . S ZCNT=ZCNT+1
"RTN","C0CDAC7",170,0)
 . M @ZOUT@(ZCNT)=@ZIN@($O(ZTMP(ZZI,"")))
"RTN","C0CDAC7",171,0)
 Q
"RTN","C0CDAC7",172,0)
 ;
"RTN","C0CDAC7",173,0)
ICD9() ; ICD-9-CM OID
"RTN","C0CDAC7",174,0)
 Q "2.16.840.1.113883.6.103^ICD-9-CM"
"RTN","C0CDAC7",175,0)
SNOMED() ; SNOMED-CT
"RTN","C0CDAC7",176,0)
 Q "2.16.840.1.113883.6.96^SNOMED-CT"
"RTN","C0CDAC7",177,0)
 ;
"RTN","C0CDAC7",178,0)
TSOCSEC ;
"RTN","C0CDAC7",179,0)
 ;;<component>
"RTN","C0CDAC7",180,0)
 ;;<section classCode="DOCSECT" moodCode="EVN">
"RTN","C0CDAC7",181,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.17"></templateId>
"RTN","C0CDAC7",182,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.17" extension="2015-08-01"></templateId>
"RTN","C0CDAC7",183,0)
 ;;<code code="29762-2" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Social History"></code>
"RTN","C0CDAC7",184,0)
 Q
"RTN","C0CDAC7",185,0)
 ;
"RTN","C0CDAC7",186,0)
TSOC ;
"RTN","C0CDAC7",187,0)
 ;;<entry>
"RTN","C0CDAC7",188,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC7",189,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.78"></templateId>
"RTN","C0CDAC7",190,0)
 ;;<id extension="@@guid@@" root="@@orgOID@@"></id>
"RTN","C0CDAC7",191,0)
 ;;<code code="ASSERTION" codeSystem="2.16.840.1.113883.5.4"></code>
"RTN","C0CDAC7",192,0)
 ;;<text>
"RTN","C0CDAC7",193,0)
 ;;<reference value="#@@uri@@"></reference>
"RTN","C0CDAC7",194,0)
 ;;</text>
"RTN","C0CDAC7",195,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC7",196,0)
 ;;<effectiveTime>
"RTN","C0CDAC7",197,0)
 ;;<low value="@@effectiveDate@@"></low>
"RTN","C0CDAC7",198,0)
 ;;</effectiveTime>
"RTN","C0CDAC7",199,0)
 ;;<value code="@@snomed@code@@" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED" displayName="@@snomed@text@@" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="CD"></value>
"RTN","C0CDAC7",200,0)
 ;;<entryRelationship contextConductionInd="true" typeCode="REFR">
"RTN","C0CDAC7",201,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC7",202,0)
 ;;<code code="48766-0" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Information source"></code>
"RTN","C0CDAC7",203,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC7",204,0)
 ;;<value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ST">@@facility@name@@</value>
"RTN","C0CDAC7",205,0)
 ;;</observation>
"RTN","C0CDAC7",206,0)
 ;;</entryRelationship>
"RTN","C0CDAC7",207,0)
 ;;</observation>
"RTN","C0CDAC7",208,0)
 ;;</entry>
"RTN","C0CDAC7",209,0)
 Q
"RTN","C0CDAC7",210,0)
 ;
"RTN","C0CDAC7",211,0)
TSOCEND ;
"RTN","C0CDAC7",212,0)
 ;;</section>
"RTN","C0CDAC7",213,0)
 ;;</component>
"RTN","C0CDAC7",214,0)
 Q
"RTN","C0CDAC7",215,0)
 ;
"RTN","C0CDAC8")
0^9^B576732040
"RTN","C0CDAC8",1,0)
C0CDAC8 ; GPL - Patient Portal - CCDA Routines ;09/17/13  17:05
"RTN","C0CDAC8",2,0)
 ;;0.1;JJOHPP;nopatch;noreleasedate;Build 1
"RTN","C0CDAC8",3,0)
 ;
"RTN","C0CDAC8",4,0)
 ; License AGPL v3.0
"RTN","C0CDAC8",5,0)
 ; 
"RTN","C0CDAC8",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDAC8",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDAC8",8,0)
 Q
"RTN","C0CDAC8",9,0)
 ;
"RTN","C0CDAC8",10,0)
ALLERGY(BLIST,DFN,CCDAWRK,CCDARPT,CCDACTRL) ;
"RTN","C0CDAC8",11,0)
 ;
"RTN","C0CDAC8",12,0)
 N CCDAV,CCDAV1
"RTN","C0CDAC8",13,0)
 S @CCDARPT@("STATUS")="EXTRACTING"
"RTN","C0CDAC8",14,0)
 S @CCDARPT@("EXTRACT-BEGIN")=$$NOW^XLFDT
"RTN","C0CDAC8",15,0)
 D GETPAT^C0CDACE(.CCDAV1,DFN,"allergies")
"RTN","C0CDAC8",16,0)
 I '$D(CCDAV1) Q  ;
"RTN","C0CDAC8",17,0)
 I CCDAV1("results","reactions@total")=0 Q  ;
"RTN","C0CDAC8",18,0)
 I $G(CCDAV1("results","reactions","allergy","assessment@value"))="not done" Q  ;
"RTN","C0CDAC8",19,0)
 I CCDAV1("results","reactions@total")=1 D  ;
"RTN","C0CDAC8",20,0)
 . M CCDAV(1)=CCDAV1("results","reactions")
"RTN","C0CDAC8",21,0)
 E  M CCDAV=CCDAV1("results","reactions")
"RTN","C0CDAC8",22,0)
 S @CCDARPT@("EXTRACT-ENDS")=$$NOW^XLFDT
"RTN","C0CDAC8",23,0)
 ;
"RTN","C0CDAC8",24,0)
 ; allergy section html
"RTN","C0CDAC8",25,0)
 ;
"RTN","C0CDAC8",26,0)
 N C0HTML,C0ARY,NKA
"RTN","C0CDAC8",27,0)
 S NKA=0 ; no known allergy flag
"RTN","C0CDAC8",28,0)
 S C0ARY("TITLE")="Allergies"
"RTN","C0CDAC8",29,0)
 S C0ARY("HEADER",1)="Date"
"RTN","C0CDAC8",30,0)
 S C0ARY("HEADER",2)="Allergies"
"RTN","C0CDAC8",31,0)
 S C0ARY("HEADER",3)="Reaction"
"RTN","C0CDAC8",32,0)
 S C0ARY("HEADER",4)="Severity"
"RTN","C0CDAC8",33,0)
 ;S C0ARY("HEADER",5)="Status"
"RTN","C0CDAC8",34,0)
 S C0ARY("HEADER",6)="Comments"
"RTN","C0CDAC8",35,0)
 S C0ARY("HEADER",7)="Source"
"RTN","C0CDAC8",36,0)
 ;
"RTN","C0CDAC8",37,0)
 I $G(CCDAV1("results","reactions","allergy","assessment@value"))="nka" D  ;
"RTN","C0CDAC8",38,0)
 . S NKA=1
"RTN","C0CDAC8",39,0)
 . S C0ARY(1,1)=""
"RTN","C0CDAC8",40,0)
 . S C0ARY(1,2)="No Know Allergies"
"RTN","C0CDAC8",41,0)
 . S C0ARY(1,3)=""
"RTN","C0CDAC8",42,0)
 . S C0ARY(1,4)=""
"RTN","C0CDAC8",43,0)
 . ;S C0ARY(1,5)=""
"RTN","C0CDAC8",44,0)
 . S C0ARY(1,6)=""
"RTN","C0CDAC8",45,0)
 . S C0ARY(1,7)=$G(CCDAV1("results","reactions","allergy","facility@name"))
"RTN","C0CDAC8",46,0)
 . S CCDAV(1,"allergy","uri")="noallergies"
"RTN","C0CDAC8",47,0)
 E  D  ;
"RTN","C0CDAC8",48,0)
 . N C0N S C0N=0
"RTN","C0CDAC8",49,0)
 . N C0I S C0I=0
"RTN","C0CDAC8",50,0)
 . F  S C0I=$O(CCDAV(C0I)) Q:+C0I=0  D  ;
"RTN","C0CDAC8",51,0)
 . . N C0DATE S C0DATE=$G(CCDAV(C0I,"allergy","entered@value"))
"RTN","C0CDAC8",52,0)
 . . S CCDAV(C0I,"allergy","uri")="uri_120_8-"_$G(CCDAV(C0I,"allergy","id@value"))
"RTN","C0CDAC8",53,0)
 . . Q:$$REDACT^C0CDACV(CCDAV(C0I,"allergy","uri"),.PARMS)
"RTN","C0CDAC8",54,0)
 . . S C0ARY(C0N,1,"uri")=$G(CCDAV(C0I,"allergy","uri"))
"RTN","C0CDAC8",55,0)
 . . S C0N=C0N+1
"RTN","C0CDAC8",56,0)
 . . I C0DATE'="" S C0ARY(C0N,1)=$$HTMLDT^C0CDACU(C0DATE) ; allergy entered date
"RTN","C0CDAC8",57,0)
 . . E  S C0ARY(C0N,1)=""
"RTN","C0CDAC8",58,0)
 . . S C0ARY(C0N,1,"ID")=$G(CCDAV(C0I,"allergy","uri"))
"RTN","C0CDAC8",59,0)
 . . S C0ARY(C0N,2)=$G(CCDAV(C0I,"allergy","name@value")) ; allergy
"RTN","C0CDAC8",60,0)
 . . N VUID,RXN
"RTN","C0CDAC8",61,0)
 . . S VUID=$G(CCDAV(C0I,"allergy","vuid@value"))
"RTN","C0CDAC8",62,0)
 . . I VUID'="" D  ;
"RTN","C0CDAC8",63,0)
 . . . S RXN=$$RXNORM^C0CDAC4(VUID)
"RTN","C0CDAC8",64,0)
 . . . N RXNMAP S RXNMAP=$$MAP^KBAIQLDM(+RXN)
"RTN","C0CDAC8",65,0)
 . . . I RXNMAP'="" S RXN=RXNMAP
"RTN","C0CDAC8",66,0)
 . . . I +RXN'=0 S C0ARY(C0N,2)=C0ARY(C0N,2)_" (Rxnorm: "_+RXN_")"
"RTN","C0CDAC8",67,0)
 . . D REACT(.CCDAV,C0I) ; process multiline reactions
"RTN","C0CDAC8",68,0)
 . . S C0ARY(C0N,3)=$G(CCDAV(C0I,"allergy","reactions","reactionSummary")) ; 
"RTN","C0CDAC8",69,0)
 . . S C0ARY(C0N,4)=$G(CCDAV(C0I,"allergy","severity@value")) ; severity
"RTN","C0CDAC8",70,0)
 . . ;S C0ARY(C0N,5)="" ; CCDAV(C0I,"allergy","facility@name") ; status tbd
"RTN","C0CDAC8",71,0)
 . . D COMMENT(.CCDAV,C0I) ; process multiline comments - set source
"RTN","C0CDAC8",72,0)
 . . S C0ARY(C0N,6)=$G(CCDAV(C0I,"allergy","comments","commentSummary")) ; 
"RTN","C0CDAC8",73,0)
 . . S C0ARY(C0N,7)=$G(CCDAV(C0I,"allergy","comments","commentSource")) ; source
"RTN","C0CDAC8",74,0)
 ;
"RTN","C0CDAC8",75,0)
 ;I +$O(C0ARY("AAAAAA"),-1)=0 D  Q  ; all allergies have been redacted
"RTN","C0CDAC8",76,0)
 I $G(CCDAV1("results","reactions","allergy","assessment@value"))="nka" D  Q  ;
"RTN","C0CDAC8",77,0)
 . N ASECT S ASECT=$NA(@CCDAWRK@("ALGYSECT"))
"RTN","C0CDAC8",78,0)
 . D GET^C0CDACU(ASECT,"TALGYV5^C0CDAC8")
"RTN","C0CDAC8",79,0)
 . D QUEUE^MXMLTMPL(BLIST,ASECT,1,@ASECT@(0))
"RTN","C0CDAC8",80,0)
 ;
"RTN","C0CDAC8",81,0)
 ; the allergy section component
"RTN","C0CDAC8",82,0)
 ;
"RTN","C0CDAC8",83,0)
 N ASECT S ASECT=$NA(@CCDAWRK@("ALGYSECT"))
"RTN","C0CDAC8",84,0)
 D GET^C0CDACU(ASECT,"TALGYSEC^C0CDAC8")
"RTN","C0CDAC8",85,0)
 D QUEUE^MXMLTMPL(BLIST,ASECT,1,@ASECT@(0))
"RTN","C0CDAC8",86,0)
 ;
"RTN","C0CDAC8",87,0)
 ; allergy html digest generation
"RTN","C0CDAC8",88,0)
 ;
"RTN","C0CDAC8",89,0)
 N AHTML S AHTML=$NA(@CCDAWRK@("ALGYHTML"))
"RTN","C0CDAC8",90,0)
 D GENHTML^C0CDACU(AHTML,"C0ARY")
"RTN","C0CDAC8",91,0)
 D QUEUE^MXMLTMPL(BLIST,AHTML,1,@AHTML@(0))
"RTN","C0CDAC8",92,0)
 ;
"RTN","C0CDAC8",93,0)
 ; allergy xml generation
"RTN","C0CDAC8",94,0)
 ;
"RTN","C0CDAC8",95,0)
 N WRK
"RTN","C0CDAC8",96,0)
 I NKA=1 D  Q  ;
"RTN","C0CDAC8",97,0)
 . S C0ARY("allergyGuid")=$$UUID^C0CDACU() ; random
"RTN","C0CDAC8",98,0)
 . S C0ARY("allergyGuid2")=$$UUID^C0CDACU() ; random
"RTN","C0CDAC8",99,0)
 . N C0DATE S C0DATE=$G(CCDAV(C0I,"allergy","entered@value"))
"RTN","C0CDAC8",100,0)
 . I C0DATE'="" S C0ARY("effectiveDate")=$$FMDTOUTC^C0CDACU(C0DATE) ; allergy entered date
"RTN","C0CDAC8",101,0)
 . E  S C0ARY("effectiveDate")=$$FMDTOUTC^C0CDACU($G(PARM("date")))
"RTN","C0CDAC8",102,0)
 . S WRK=$NA(@CCDAWRK@("ALGYV4",1))
"RTN","C0CDAC8",103,0)
 . D GETNMAP^C0CDACU(WRK,"TALGYV4^C0CDAC8","C0ARY")
"RTN","C0CDAC8",104,0)
 . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC8",105,0)
 . N ALGYEND S ALGYEND=$NA(@CCDAWRK@("ALGYEND"))
"RTN","C0CDAC8",106,0)
 . D GET^C0CDACU(ALGYEND,"TALGYEND^C0CDAC8")
"RTN","C0CDAC8",107,0)
 . D QUEUE^MXMLTMPL(BLIST,ALGYEND,1,@ALGYEND@(0))
"RTN","C0CDAC8",108,0)
 N C0I S C0I=0
"RTN","C0CDAC8",109,0)
 F  S C0I=$O(CCDAV(C0I)) Q:+C0I=0  D  ;
"RTN","C0CDAC8",110,0)
 . N C0DATE S C0DATE=$G(CCDAV(C0I,"allergy","entered@value"))
"RTN","C0CDAC8",111,0)
 . I C0DATE'="" S C0ARY("effectiveDate")=$$FMDTOUTC^C0CDACU(C0DATE) ; allergy entered date
"RTN","C0CDAC8",112,0)
 . E  S C0ARY("effectiveDate")="UNK"
"RTN","C0CDAC8",113,0)
 . I $$REDACT^C0CDACV($G(CCDAV(C0I,"allergy","uri")),.PARMS) D  Q  ;
"RTN","C0CDAC8",114,0)
 . S C0ARY("uri")=$G(CCDAV(C0I,"allergy","uri"))
"RTN","C0CDAC8",115,0)
 . S C0ARY("allerginName")=$G(CCDAV(C0I,"allergy","name@value")) ; allergy
"RTN","C0CDAC8",116,0)
 . S C0ARY("severityName")=$G(CCDAV(C0I,"allergy","severity@value")) ; severity
"RTN","C0CDAC8",117,0)
 . N C0SEV S C0SEV=""
"RTN","C0CDAC8",118,0)
 . I C0ARY("severityName")="MILD" S C0SEV=255604002
"RTN","C0CDAC8",119,0)
 . I C0ARY("severityName")="MODERATE" S C0SEV=6736007
"RTN","C0CDAC8",120,0)
 . I C0ARY("severityName")="SEVERE" S C0SEV=24484000
"RTN","C0CDAC8",121,0)
 . I C0SEV="" S C0SEV="UNK"
"RTN","C0CDAC8",122,0)
 . S C0ARY("severityCode")=C0SEV ; severity snomed code
"RTN","C0CDAC8",123,0)
 . S C0ARY("status")="" ; CCDAV(C0I,"allergy","facility@name") ; status tbd
"RTN","C0CDAC8",124,0)
 . D COMMENT(.CCDAV,C0I) ; process multiline comments - set source
"RTN","C0CDAC8",125,0)
 . S C0ARY("allergyComment")=$G(CCDAV(C0I,"allergy","comments","commentSummary")) ; 
"RTN","C0CDAC8",126,0)
 . S C0ARY("allergySource")=$G(CCDAV(C0I,"allergy","comments","commentSource")) ; source
"RTN","C0CDAC8",127,0)
 . I C0ARY("allergySource")="" D  ;
"RTN","C0CDAC8",128,0)
 . . S C0ARY("allergySource")=$G(CCDAV(C0I,"allergy","facility@name"))
"RTN","C0CDAC8",129,0)
 . S C0ARY("allergyGuid")=$$UUID^C0CDACU() ; random
"RTN","C0CDAC8",130,0)
 . S C0ARY("orgOID")=$$ORGOID^C0CDACU() ; fetch organization OID
"RTN","C0CDAC8",131,0)
 . S C0ARY("VUID")=$G(CCDAV(C0I,"allergy","vuid@value"))
"RTN","C0CDAC8",132,0)
 . I C0ARY("VUID")="" S C0ARY("VUID")=$G(CCDAV(C0I,"allergy","drugIngredients","drugIngredient@vuid"))
"RTN","C0CDAC8",133,0)
 . S C0ARY("TYPE")=$G(CCDAV(C0I,"allergy","type@name"))
"RTN","C0CDAC8",134,0)
 . ;
"RTN","C0CDAC8",135,0)
 . ; beginning of allergy
"RTN","C0CDAC8",136,0)
 . S WRK=$NA(@CCDAWRK@("ALGY",C0I))
"RTN","C0CDAC8",137,0)
 . D GETNMAP^C0CDACU(WRK,"TALGY^C0CDAC8","C0ARY")
"RTN","C0CDAC8",138,0)
 . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC8",139,0)
 . ;
"RTN","C0CDAC8",140,0)
 . ; allergy to substance or to drug
"RTN","C0CDAC8",141,0)
 . I C0ARY("TYPE")'="DRUG" D  ; no VUID no drug
"RTN","C0CDAC8",142,0)
 . . S C0ARY("allerginCode")="UNK"
"RTN","C0CDAC8",143,0)
 . . S C0ARY("allerginCodeSystemOID")=$$VAOID()
"RTN","C0CDAC8",144,0)
 . . S C0ARY("allerginCodeSystemName")="VANDF"
"RTN","C0CDAC8",145,0)
 . . S WRK=$NA(@CCDAWRK@("ALGYV2",C0I))
"RTN","C0CDAC8",146,0)
 . . D GETNMAP^C0CDACU(WRK,"TALGYV2^C0CDAC8","C0ARY")
"RTN","C0CDAC8",147,0)
 . . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC8",148,0)
 . I C0ARY("TYPE")="DRUG" D  ; drug allergy
"RTN","C0CDAC8",149,0)
 . . N RXN S RXN=$$RXNORM^C0CDAC4(C0ARY("VUID"))
"RTN","C0CDAC8",150,0)
 . . N RXNMAP S RXNMAP=$$MAP^KBAIQLDM(+RXN)
"RTN","C0CDAC8",151,0)
 . . I RXNMAP'="" S RXN=RXNMAP
"RTN","C0CDAC8",152,0)
 . . I RXN'="" D  ;
"RTN","C0CDAC8",153,0)
 . . . S C0ARY("allerginCode")=+RXN
"RTN","C0CDAC8",154,0)
 . . . S C0ARY("allerginCodeSystemOID")=$$RXNOID()
"RTN","C0CDAC8",155,0)
 . . . S C0ARY("allerginCodeSystemName")="RxNorm"
"RTN","C0CDAC8",156,0)
 . . I RXN="" D  ;
"RTN","C0CDAC8",157,0)
 . . . S C0ARY("allerginCode")=C0ARY("VUID")
"RTN","C0CDAC8",158,0)
 . . . S C0ARY("allerginCodeSystemOID")=$$VAOID()
"RTN","C0CDAC8",159,0)
 . . . S C0ARY("allerginCodeSystemName")="VANDF"
"RTN","C0CDAC8",160,0)
 . . S WRK=$NA(@CCDAWRK@("ALGYV1",C0I))
"RTN","C0CDAC8",161,0)
 . . D GETNMAP^C0CDACU(WRK,"TALGYV1^C0CDAC8","C0ARY")
"RTN","C0CDAC8",162,0)
 . . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC8",163,0)
 . ;
"RTN","C0CDAC8",164,0)
 . ; reaction
"RTN","C0CDAC8",165,0)
 . ;I $G(CCDAV(C0I,"allergy","reactions","reaction@name"))'="" D  ; make it look like a mult
"RTN","C0CDAC8",166,0)
 . ;. N ZZ M ZZ=CCDAV(C0I,"allergy","reactions")
"RTN","C0CDAC8",167,0)
 . ;. M CCDAV(C0I,"allergy","reactions",1)=ZZ
"RTN","C0CDAC8",168,0)
 . I $D(CCDAV(C0I,"allergy","reactions")) D  ;
"RTN","C0CDAC8",169,0)
 . . N ZR S ZR=$NA(CCDAV(C0I,"allergy","reactions"))
"RTN","C0CDAC8",170,0)
 . . I $D(CCDAV(C0I,"allergy","reactions",1)) S ZR=$NA(@ZR@(1))
"RTN","C0CDAC8",171,0)
 . . N ZRN S ZRN=$G(@ZR@("reaction@name"))
"RTN","C0CDAC8",172,0)
 . . I ZRN="" S ZRN="UNKNOWN"
"RTN","C0CDAC8",173,0)
 . . N OK,ZRM
"RTN","C0CDAC8",174,0)
 . . S OK=$$GETMAP^C0CDACM(.ZRM,"reaction",ZRN)
"RTN","C0CDAC8",175,0)
 . . I 'OK S OK=$$GETMAP^C0CDACM(.ZRM,"reaction","UNKNOWN") ; don't know the Snomed
"RTN","C0CDAC8",176,0)
 . . ;I $G(DEBUG) I $D(ZRM) ZWR ZRM ;B
"RTN","C0CDAC8",177,0)
 . . S C0ARY("reactionName")=$G(ZRM("snomedText"))
"RTN","C0CDAC8",178,0)
 . . I C0ARY("reactionName")="" S C0ARY("reactionName")=ZRN
"RTN","C0CDAC8",179,0)
 . . S C0ARY("reactionCode")=$G(ZRM("snomedCode"))
"RTN","C0CDAC8",180,0)
 . . I C0ARY("reactionCode")="" D  ;
"RTN","C0CDAC8",181,0)
 . . . S C0ARY("reactionCode")=261665006 ; means unknown
"RTN","C0CDAC8",182,0)
 . . . S C0ARY("reactionName")="Unknown"
"RTN","C0CDAC8",183,0)
 . . S WRK=$NA(@CCDAWRK@("ALGYR1",C0I))
"RTN","C0CDAC8",184,0)
 . . D GETNMAP^C0CDACU(WRK,"TALGYR^C0CDAC8","C0ARY")
"RTN","C0CDAC8",185,0)
 . . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC8",186,0)
 . ;
"RTN","C0CDAC8",187,0)
 . ; severity
"RTN","C0CDAC8",188,0)
 . I C0ARY("severityName")'="" D  ;
"RTN","C0CDAC8",189,0)
 . . S WRK=$NA(@CCDAWRK@("ALGYS",C0I))
"RTN","C0CDAC8",190,0)
 . . D GETNMAP^C0CDACU(WRK,"TALGYS^C0CDAC8","C0ARY")
"RTN","C0CDAC8",191,0)
 . . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC8",192,0)
 . ;
"RTN","C0CDAC8",193,0)
 . ; comments
"RTN","C0CDAC8",194,0)
 . I C0ARY("allergyComment")'="" D  ;
"RTN","C0CDAC8",195,0)
 . . S WRK=$NA(@CCDAWRK@("ALGYC",C0I))
"RTN","C0CDAC8",196,0)
 . . D GETNMAP^C0CDACU(WRK,"TALGYC^C0CDAC8","C0ARY")
"RTN","C0CDAC8",197,0)
 . . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC8",198,0)
 . ;
"RTN","C0CDAC8",199,0)
 . ; source
"RTN","C0CDAC8",200,0)
 . I C0ARY("allergySource")'="" D  ;
"RTN","C0CDAC8",201,0)
 . . S WRK=$NA(@CCDAWRK@("ALGYSRC",C0I))
"RTN","C0CDAC8",202,0)
 . . D GETNMAP^C0CDACU(WRK,"TALGYSRC^C0CDAC8","C0ARY")
"RTN","C0CDAC8",203,0)
 . . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC8",204,0)
 . ;
"RTN","C0CDAC8",205,0)
 . ; end of allergy
"RTN","C0CDAC8",206,0)
 . S WRK=$NA(@CCDAWRK@("ALGYE",C0I))
"RTN","C0CDAC8",207,0)
 . D GETNMAP^C0CDACU(WRK,"TALGYE^C0CDAC8","C0ARY")
"RTN","C0CDAC8",208,0)
 . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDAC8",209,0)
 ; 
"RTN","C0CDAC8",210,0)
 ; allergy section ending
"RTN","C0CDAC8",211,0)
 ;
"RTN","C0CDAC8",212,0)
 N ALGYEND S ALGYEND=$NA(@CCDAWRK@("ALGYEND"))
"RTN","C0CDAC8",213,0)
 D GET^C0CDACU(ALGYEND,"TALGYEND^C0CDAC8")
"RTN","C0CDAC8",214,0)
 D QUEUE^MXMLTMPL(BLIST,ALGYEND,1,@ALGYEND@(0))
"RTN","C0CDAC8",215,0)
 ;
"RTN","C0CDAC8",216,0)
 Q
"RTN","C0CDAC8",217,0)
 ;
"RTN","C0CDAC8",218,0)
REACT(ZARY,ZI) ; handle multiple line reactions
"RTN","C0CDAC8",219,0)
 ; sets CCDAV(ZI,"allergy","reactions","reactionSummary") to one text line
"RTN","C0CDAC8",220,0)
 N GN S GN=$NA(ZARY(ZI,"allergy","reactions"))
"RTN","C0CDAC8",221,0)
 I $G(@GN@(1,"reaction@name"))'="" D  Q  ;
"RTN","C0CDAC8",222,0)
 . ;B
"RTN","C0CDAC8",223,0)
 . N ZJ,ZN
"RTN","C0CDAC8",224,0)
 . S ZN=$O(@GN@(""),-1)
"RTN","C0CDAC8",225,0)
 . F ZJ=1:1:ZN D  ;
"RTN","C0CDAC8",226,0)
 . . I ZJ>1 S @GN@("reactionSummary")=@GN@("reactionSummary")_". "
"RTN","C0CDAC8",227,0)
 . . S @GN@("reactionSummary")=$G(@GN@("reactionSummary"))_@GN@(ZJ,"reaction@name")
"RTN","C0CDAC8",228,0)
 S @GN@("reactionSummary")=$G(@GN@("reaction@name"))
"RTN","C0CDAC8",229,0)
 Q
"RTN","C0CDAC8",230,0)
 ;
"RTN","C0CDAC8",231,0)
REACT2(ZARY,ZI) ; handle multiple line reactions - use <li></li> for lines
"RTN","C0CDAC8",232,0)
 ; sets CCDAV(ZI,"allergy","reactions","reactionSummary") to one text line
"RTN","C0CDAC8",233,0)
 N ZGN S ZGN=$NA(ZARY(ZI,"allergy","reactions"))
"RTN","C0CDAC8",234,0)
 I $G(@ZGN@(1,"reaction@name"))'="" D  Q  ;
"RTN","C0CDAC8",235,0)
 . N ZJ,ZN
"RTN","C0CDAC8",236,0)
 . S ZN=$O(@ZGN@(""),-1)
"RTN","C0CDAC8",237,0)
 . S @ZGN@("reactionSummary")="<ul>" ; unordered list
"RTN","C0CDAC8",238,0)
 . F ZJ=1:1:ZN D  ;
"RTN","C0CDAC8",239,0)
 . . S @ZGN@("reactionSummary")=$G(@ZGN@("reactionSummary"))_"<li>"_@ZGN@(ZJ,"reaction@name")_"</li>"
"RTN","C0CDAC8",240,0)
 . S @ZGN@("reactionSummary")=@ZGN@("reactionSummary")_"</ul>"
"RTN","C0CDAC8",241,0)
 S @ZGN@("reactionSummary")=$G(@ZGN@("reaction@name"))
"RTN","C0CDAC8",242,0)
 Q
"RTN","C0CDAC8",243,0)
 ;
"RTN","C0CDAC8",244,0)
COMMENT(ZARY,ZI) ; handle multiline comments and set allergy source
"RTN","C0CDAC8",245,0)
 ; sets CCDAV(ZI,"allergy","comments","commentSummary") to one text line
"RTN","C0CDAC8",246,0)
 ; sets CCDAV(ZI,"allergy","comments","commentSource") to comment source
"RTN","C0CDAC8",247,0)
 N ZGN S ZGN=$NA(ZARY(ZI,"allergy","comments"))
"RTN","C0CDAC8",248,0)
 S @ZGN@("commentSource")=$G(@ZGN@("comment@enteredBy"))
"RTN","C0CDAC8",249,0)
 I $G(@ZGN@(1,"commentText"))'="" D  Q  ;
"RTN","C0CDAC8",250,0)
 . ;B
"RTN","C0CDAC8",251,0)
 . N ZJ,ZN
"RTN","C0CDAC8",252,0)
 . S ZN=$O(@ZGN@(""),-1)
"RTN","C0CDAC8",253,0)
 . F ZJ=1:1:ZN D  ;
"RTN","C0CDAC8",254,0)
 . . I ZJ>1 S @ZGN@("commentSummary")=@ZGN@("commentSummary")_". "
"RTN","C0CDAC8",255,0)
 . . S @ZGN@("commentSummary")=$G(@ZGN@("commentSummary"))_@ZGN@(ZJ,"comment@commentText")
"RTN","C0CDAC8",256,0)
 S @ZGN@("commentSummary")=$G(@ZGN@("comment@commentText"))
"RTN","C0CDAC8",257,0)
 ;
"RTN","C0CDAC8",258,0)
 Q
"RTN","C0CDAC8",259,0)
 ;
"RTN","C0CDAC8",260,0)
VAOID() ; Oid for VA coding system
"RTN","C0CDAC8",261,0)
 Q "2.16.840.1.113883.6.229"
"RTN","C0CDAC8",262,0)
 ;
"RTN","C0CDAC8",263,0)
RXNOID() ; RxNorm OID
"RTN","C0CDAC8",264,0)
 Q "2.16.840.1.113883.6.88"
"RTN","C0CDAC8",265,0)
 ;
"RTN","C0CDAC8",266,0)
 ;;<section classCode="DOCSECT" moodCode="EVN">
"RTN","C0CDAC8",267,0)
 ;
"RTN","C0CDAC8",268,0)
TALGYSEC ; 
"RTN","C0CDAC8",269,0)
 ;;<component>
"RTN","C0CDAC8",270,0)
 ;;<section>
"RTN","C0CDAC8",271,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.6.1"></templateId>
"RTN","C0CDAC8",272,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.6.1" extension="2015-08-01"></templateId>
"RTN","C0CDAC8",273,0)
 ;;<code code="48765-2" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Allergies, adverse reactions, alert"></code>
"RTN","C0CDAC8",274,0)
 Q
"RTN","C0CDAC8",275,0)
 ;
"RTN","C0CDAC8",276,0)
TALGY ;
"RTN","C0CDAC8",277,0)
 ;;<entry>
"RTN","C0CDAC8",278,0)
 ;;<act classCode="ACT" moodCode="EVN">
"RTN","C0CDAC8",279,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.30"></templateId>
"RTN","C0CDAC8",280,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.30" extension="2015-08-01"></templateId>
"RTN","C0CDAC8",281,0)
 ;;<id root="@@allergyGuid@@"></id>
"RTN","C0CDAC8",282,0)
 ;;<code code="48765-2" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Allergies, adverse reactions, alerts"></code>
"RTN","C0CDAC8",283,0)
 ;;<statusCode code="active"></statusCode>
"RTN","C0CDAC8",284,0)
 ;;<effectiveTime>
"RTN","C0CDAC8",285,0)
 ;;<low value="@@effectiveDate@@"></low>
"RTN","C0CDAC8",286,0)
 ;;</effectiveTime>
"RTN","C0CDAC8",287,0)
 ;;<entryRelationship typeCode="SUBJ">
"RTN","C0CDAC8",288,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC8",289,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.7"></templateId>
"RTN","C0CDAC8",290,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.7" extension="2014-06-09"></templateId>
"RTN","C0CDAC8",291,0)
 ;;<id extension="3355135" root="1.3.6.1.4.1.16517"></id>
"RTN","C0CDAC8",292,0)
 ;;<code code="ASSERTION" codeSystem="2.16.840.1.113883.5.4" codeSystemName="ActCode"></code>
"RTN","C0CDAC8",293,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC8",294,0)
 ;;<effectiveTime>
"RTN","C0CDAC8",295,0)
 ;;<low value="@@effectiveDate@@"></low>
"RTN","C0CDAC8",296,0)
 ;;</effectiveTime>
"RTN","C0CDAC8",297,0)
 Q
"RTN","C0CDAC8",298,0)
 ;
"RTN","C0CDAC8",299,0)
TALGYV1 ; drug allergy
"RTN","C0CDAC8",300,0)
 ;;<value code="416098002" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED CT" displayName="drug allergy" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="CD"></value>
"RTN","C0CDAC8",301,0)
 ;;<participant typeCode="CSM">
"RTN","C0CDAC8",302,0)
 ;;<participantRole classCode="MANU">
"RTN","C0CDAC8",303,0)
 ;;<playingEntity classCode="MMAT">
"RTN","C0CDAC8",304,0)
 ;;<code code="@@allerginCode@@" codeSystem="@@allerginCodeSystemOID@@" codeSystemName="@@allerginCodeSystemName@@" displayName="@@allerginName@@">
"RTN","C0CDAC8",305,0)
 ;;<originalText>
"RTN","C0CDAC8",306,0)
 ;;<reference value="#@@uri@@"></reference>
"RTN","C0CDAC8",307,0)
 ;;</originalText>
"RTN","C0CDAC8",308,0)
 ;;<translation code="@@allerginCode@@" codeSystem="@@allerginCodeSystemOID@@" codeSystemName="@@allerginCodeSystemName@@" displayName="@@allerginName@@"></translation>
"RTN","C0CDAC8",309,0)
 ;;</code>
"RTN","C0CDAC8",310,0)
 ;;<name>@@allerginName@@</name>
"RTN","C0CDAC8",311,0)
 ;;</playingEntity>
"RTN","C0CDAC8",312,0)
 ;;</participantRole>
"RTN","C0CDAC8",313,0)
 ;;</participant>
"RTN","C0CDAC8",314,0)
 ;;<entryRelationship inversionInd="true" typeCode="SUBJ">
"RTN","C0CDAC8",315,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC8",316,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.28"></templateId>
"RTN","C0CDAC8",317,0)
 ;;<code code="33999-4" codeSystem="2.16.840.1.113883.6.1"></code>
"RTN","C0CDAC8",318,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC8",319,0)
 ;;<value code="55561003" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED" displayName="Active" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="CE"></value>
"RTN","C0CDAC8",320,0)
 ;;</observation>
"RTN","C0CDAC8",321,0)
 ;;</entryRelationship>
"RTN","C0CDAC8",322,0)
 Q
"RTN","C0CDAC8",323,0)
 ;
"RTN","C0CDAC8",324,0)
TALGYV2 ; substance allergy
"RTN","C0CDAC8",325,0)
 ;;<value code="419199007" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED CT" displayName="allergy to substance" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="CD"></value>
"RTN","C0CDAC8",326,0)
 ;;<participant typeCode="CSM">
"RTN","C0CDAC8",327,0)
 ;;<participantRole classCode="MANU">
"RTN","C0CDAC8",328,0)
 ;;<playingEntity classCode="MMAT">
"RTN","C0CDAC8",329,0)
 ;;<code nullFlavor="OTH">
"RTN","C0CDAC8",330,0)
 ;;<originalText>
"RTN","C0CDAC8",331,0)
 ;;<reference value="#@@uri@@"></reference>
"RTN","C0CDAC8",332,0)
 ;;</originalText>
"RTN","C0CDAC8",333,0)
 ;;<translation code="@@allerginCode@@" codeSystem="@@allerginCodeSystemOID@@" codeSystemName="@@allerginCodeSystemName@@" displayName="@@allerginName@@"></translation>
"RTN","C0CDAC8",334,0)
 ;;</code>
"RTN","C0CDAC8",335,0)
 ;;<name>@@allerginName@@</name>
"RTN","C0CDAC8",336,0)
 ;;</playingEntity>
"RTN","C0CDAC8",337,0)
 ;;</participantRole>
"RTN","C0CDAC8",338,0)
 ;;</participant>
"RTN","C0CDAC8",339,0)
 ;;<entryRelationship inversionInd="true" typeCode="SUBJ">
"RTN","C0CDAC8",340,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC8",341,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.28"></templateId>
"RTN","C0CDAC8",342,0)
 ;;<code code="33999-4" codeSystem="2.16.840.1.113883.6.1"></code>
"RTN","C0CDAC8",343,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC8",344,0)
 ;;<value code="55561003" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED" displayName="Active" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="CE"></value>
"RTN","C0CDAC8",345,0)
 ;;</observation>
"RTN","C0CDAC8",346,0)
 ;;</entryRelationship>
"RTN","C0CDAC8",347,0)
 Q
"RTN","C0CDAC8",348,0)
 ;
"RTN","C0CDAC8",349,0)
TALGYV3 ; no Known Allergy case
"RTN","C0CDAC8",350,0)
 ;;<entry typeCode="DRIV">
"RTN","C0CDAC8",351,0)
 ;;<act classCode="ACT" moodCode="EVN">
"RTN","C0CDAC8",352,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.30"></templateId>
"RTN","C0CDAC8",353,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.30" extension="2015-08-01"></templateId>
"RTN","C0CDAC8",354,0)
 ;;<id root="@@allergyGuid@@"/>
"RTN","C0CDAC8",355,0)
 ;;<code nullFlavor="NA"/>
"RTN","C0CDAC8",356,0)
 ;;<statusCode code="active"/>						
"RTN","C0CDAC8",357,0)
 ;;<effectiveTime>
"RTN","C0CDAC8",358,0)
 ;;<low nullFlavor="NA"/>
"RTN","C0CDAC8",359,0)
 ;;</effectiveTime>							
"RTN","C0CDAC8",360,0)
 ;;<entryRelationship typeCode="SUBJ" inversionInd="false">
"RTN","C0CDAC8",361,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC8",362,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.7"></templateId>
"RTN","C0CDAC8",363,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.7" extension="2014-06-09"></templateId>
"RTN","C0CDAC8",364,0)
 ;;<id root="2b37be6b-9b1c-4069-bbca-1caf5fe1937d"/>
"RTN","C0CDAC8",365,0)
 ;;<code code="420134006" codeSystem="2.16.840.1.113883.6.96" displayName="Propensity to adverse reactions (disorder)"
"RTN","C0CDAC8",366,0)
 ;;codeSystemName="SNOMED CT"/>
"RTN","C0CDAC8",367,0)
 ;;<statusCode code="completed"/>
"RTN","C0CDAC8",368,0)
 ;;<effectiveTime>
"RTN","C0CDAC8",369,0)
 ;;<low nullFlavor="UNK"/>
"RTN","C0CDAC8",370,0)
 ;;</effectiveTime>
"RTN","C0CDAC8",371,0)
 ;;<value xsi:type="CD" code="160244002" codeSystem="2.16.840.1.113883.6.96" displayName="No Known allergies" codeSystemName="SNOMED CT">
"RTN","C0CDAC8",372,0)
 ;;<originalText>
"RTN","C0CDAC8",373,0)
 ;;<reference value="#noallergies"/>
"RTN","C0CDAC8",374,0)
 ;;</originalText>
"RTN","C0CDAC8",375,0)
 ;;</value>
"RTN","C0CDAC8",376,0)
 ;;</observation>
"RTN","C0CDAC8",377,0)
 ;;</entryRelationship>
"RTN","C0CDAC8",378,0)
 ;;</act>
"RTN","C0CDAC8",379,0)
 ;;</entry>
"RTN","C0CDAC8",380,0)
 Q
"RTN","C0CDAC8",381,0)
 ;
"RTN","C0CDAC8",382,0)
TALGYV4 ; no known allergy case
"RTN","C0CDAC8",383,0)
 ;;<!-- No Known Allergies -->
"RTN","C0CDAC8",384,0)
 ;;<entry typeCode="DRIV">
"RTN","C0CDAC8",385,0)
 ;;<!-- Allergy Concern Act -->
"RTN","C0CDAC8",386,0)
 ;;<act classCode="ACT" moodCode="EVN">
"RTN","C0CDAC8",387,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.30"/>
"RTN","C0CDAC8",388,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.30" extension="2015-08-01"></templateId>
"RTN","C0CDAC8",389,0)
 ;;<id root="@@allergyGuid@@"/>
"RTN","C0CDAC8",390,0)
 ;;<code code="48765-2" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Allergies, adverse reactions, alerts"/>
"RTN","C0CDAC8",391,0)
 ;;<!--currently tracked concerns are active concerns-->
"RTN","C0CDAC8",392,0)
 ;;<statusCode code="active"/>         
"RTN","C0CDAC8",393,0)
 ;;<effectiveTime>
"RTN","C0CDAC8",394,0)
 ;;<!--show time when the concern first began being tracked-->
"RTN","C0CDAC8",395,0)
 ;;<low value="@@effectiveDate@@"/>         
"RTN","C0CDAC8",396,0)
 ;;</effectiveTime>
"RTN","C0CDAC8",397,0)
 ;;<entryRelationship typeCode="SUBJ">
"RTN","C0CDAC8",398,0)
 ;;<!-- No Known Allergies -->
"RTN","C0CDAC8",399,0)
 ;;<observation classCode="OBS" moodCode="EVN" negationInd="true">
"RTN","C0CDAC8",400,0)
 ;;<!-- allergy - intolerance observation template -->
"RTN","C0CDAC8",401,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.7"/>
"RTN","C0CDAC8",402,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.7" extension="2014-06-09" /> 
"RTN","C0CDAC8",403,0)
 ;;<id root="@@allergyGuid@@"/>
"RTN","C0CDAC8",404,0)
 ;;<code code="ASSERTION" codeSystem="2.16.840.1.113883.5.4"/>
"RTN","C0CDAC8",405,0)
 ;;<statusCode code="completed"/>
"RTN","C0CDAC8",406,0)
 ;;<!-- date/time the patient made the assertion -->
"RTN","C0CDAC8",407,0)
 ;;<effectiveTime>
"RTN","C0CDAC8",408,0)
 ;;<high value="@@effectiveDate@@"/>
"RTN","C0CDAC8",409,0)
 ;;</effectiveTime>
"RTN","C0CDAC8",410,0)
 ;;<value xsi:type="CD" code="419199007" displayName="Allergy to substance (disorder)" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED CT">
"RTN","C0CDAC8",411,0)
 ;;<originalText>
"RTN","C0CDAC8",412,0)
 ;;<reference value="#noallergies"/>
"RTN","C0CDAC8",413,0)
 ;;</originalText>
"RTN","C0CDAC8",414,0)
 ;;</value>
"RTN","C0CDAC8",415,0)
 ;;</observation>
"RTN","C0CDAC8",416,0)
 ;;</entryRelationship>
"RTN","C0CDAC8",417,0)
 ;;</act>
"RTN","C0CDAC8",418,0)
 ;;</entry>
"RTN","C0CDAC8",419,0)
 Q
"RTN","C0CDAC8",420,0)
 ;
"RTN","C0CDAC8",421,0)
TALGYV5 ; no known allergies astro gpl
"RTN","C0CDAC8",422,0)
 ;;<!-- Allergies Section -->
"RTN","C0CDAC8",423,0)
 ;;<component>
"RTN","C0CDAC8",424,0)
 ;;  <section>
"RTN","C0CDAC8",425,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.6.1"></templateId>
"RTN","C0CDAC8",426,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.6.1" extension="2015-08-01"></templateId>
"RTN","C0CDAC8",427,0)
 ;;    <code code="48765-2" codeSystem="2.16.840.1.113883.6.1" displayName="Allergies, adverse reactions, alerts" codeSystemName="LOINC"/>
"RTN","C0CDAC8",428,0)
 ;;    <title>ALLERGIES</title>
"RTN","C0CDAC8",429,0)
 ;;    <text>
"RTN","C0CDAC8",430,0)
 ;;      <content ID="Alg_Concern_1">Allergy Concern:
"RTN","C0CDAC8",431,0)
 ;;      Concern Tracker Start Date: 01/03/2014
"RTN","C0CDAC8",432,0)
 ;;      Concern Tracker End Date:
"RTN","C0CDAC8",433,0)
 ;;      Concern Tracker Status: Completed
"RTN","C0CDAC8",434,0)
 ;;    <content ID="allergy1">No known <content ID="adverseEvent1">allergies.</content></content></content></text>
"RTN","C0CDAC8",435,0)
 ;;    <entry typeCode="DRIV">
"RTN","C0CDAC8",436,0)
 ;;      <!-- Allergy Concern Act -->
"RTN","C0CDAC8",437,0)
 ;;      <act classCode="ACT" moodCode="EVN">
"RTN","C0CDAC8",438,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.30"></templateId>
"RTN","C0CDAC8",439,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.30" extension="2015-08-01"></templateId>
"RTN","C0CDAC8",440,0)
 ;;      	<id root="36e3e930-7b14-11db-9fe1-0800200c9a66"/>
"RTN","C0CDAC8",441,0)
 ;;      	<!-- SDWG supports 48765-2 or CONC in the code element -->
"RTN","C0CDAC8",442,0)
 ;;      	<!--<code code="CONC" codeSystem="2.16.840.1.113883.5.6"/>-->
"RTN","C0CDAC8",443,0)
 ;;      	<code code="48765-2" codeSystem="2.16.840.1.113883.6.1" displayName="Allergies, adverse reactions, alerts" codeSystemName="LOINC"/>
"RTN","C0CDAC8",444,0)
 ;;      	<text><reference value="#Alg_Concern_1"></reference></text>
"RTN","C0CDAC8",445,0)
 ;;      	<statusCode code="completed"/> <!-- The concern is not active, in terms of there being an active condition to be managed.-->
"RTN","C0CDAC8",446,0)
 ;;      	<effectiveTime>
"RTN","C0CDAC8",447,0)
 ;;      	  <low value="20100103"/> <!--show time when the concern about allergies was assessed and completed. -->
"RTN","C0CDAC8",448,0)
 ;;      	  <high/>
"RTN","C0CDAC8",449,0)
 ;;      	</effectiveTime>
"RTN","C0CDAC8",450,0)
 ;;      	<entryRelationship typeCode="SUBJ">
"RTN","C0CDAC8",451,0)
 ;;      	  <!-- No Known Allergies -->
"RTN","C0CDAC8",452,0)
 ;;      	  <!-- The use of negationInd corresponds with the newer Observation.valueNegationInd -->
"RTN","C0CDAC8",453,0)
 ;;      	  <!-- The negationInd = true negates the observation/value -->
"RTN","C0CDAC8",454,0)
 ;;      	  <observation classCode="OBS" moodCode="EVN" negationInd="true">
"RTN","C0CDAC8",455,0)
 ;;      	    <!-- allergy - intolerance observation template -->
"RTN","C0CDAC8",456,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.7"></templateId>
"RTN","C0CDAC8",457,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.7" extension="2014-06-09"></templateId>
"RTN","C0CDAC8",458,0)
 ;;      	    <id root="4adc1020-7b14-11db-9fe1-0800200c9a66"/>
"RTN","C0CDAC8",459,0)
 ;;      	    <code code="ASSERTION" codeSystem="2.16.840.1.113883.5.4"/>
"RTN","C0CDAC8",460,0)
 ;;      	    <statusCode code="completed"/>
"RTN","C0CDAC8",461,0)
 ;;      	    <!-- N/A - author/time records when this assertion was made -->
"RTN","C0CDAC8",462,0)
 ;;      	    <effectiveTime>
"RTN","C0CDAC8",463,0)
 ;;      	      <low value="20100103"/>
"RTN","C0CDAC8",464,0)
 ;;      	    </effectiveTime>
"RTN","C0CDAC8",465,0)
 ;;      	    <!-- The time when this was biologically relevant ie True for the patient. -->
"RTN","C0CDAC8",466,0)
 ;;      	    <!-- As a minimum time interval over which this is true, populate the effectiveTime/low with the current time. -->
"RTN","C0CDAC8",467,0)
 ;;      	    <!-- It would be equally valid to have a longer range of time over which this statement was represented as being true. -->
"RTN","C0CDAC8",468,0)
 ;;      	    <!-- As a maximum, you would never indicate an effectiveTime/high that was greater than the current point in time. -->
"RTN","C0CDAC8",469,0)
 ;;      	    <value xsi:type="CD" code="419199007"
"RTN","C0CDAC8",470,0)
 ;;      		   displayName="Allergy to substance (disorder)"
"RTN","C0CDAC8",471,0)
 ;;      		   codeSystem="2.16.840.1.113883.6.96"
"RTN","C0CDAC8",472,0)
 ;;      		   codeSystemName="SNOMED CT"/>
"RTN","C0CDAC8",473,0)
 ;;      	    <author>
"RTN","C0CDAC8",474,0)
 ;;      	      <time value="20100103"/>
"RTN","C0CDAC8",475,0)
 ;;      	      <assignedAuthor>
"RTN","C0CDAC8",476,0)
 ;;      		<id extension="99999999" root="2.16.840.1.113883.4.6"/>
"RTN","C0CDAC8",477,0)
 ;;      		<code code="200000000X" codeSystem="2.16.840.1.113883.6.101"
"RTN","C0CDAC8",478,0)
 ;;      		      displayName="Allopathic &amp; Osteopathic Physicians"/>
"RTN","C0CDAC8",479,0)
 ;;      		<telecom use="WP" value="tel:555-555-1002"/>
"RTN","C0CDAC8",480,0)
 ;;      		<assignedPerson>
"RTN","C0CDAC8",481,0)
 ;;      		  <name>
"RTN","C0CDAC8",482,0)
 ;;      		    <given>Henry</given>
"RTN","C0CDAC8",483,0)
 ;;      		    <family>Seven</family>
"RTN","C0CDAC8",484,0)
 ;;      		  </name>
"RTN","C0CDAC8",485,0)
 ;;      		</assignedPerson>
"RTN","C0CDAC8",486,0)
 ;;      	      </assignedAuthor>
"RTN","C0CDAC8",487,0)
 ;;      	    </author>
"RTN","C0CDAC8",488,0)
 ;;                  <participant typeCode="CSM">
"RTN","C0CDAC8",489,0)
 ;;                       <participantRole classCode="MANU">
"RTN","C0CDAC8",490,0)
 ;;                           <playingEntity classCode="MMAT">
"RTN","C0CDAC8",491,0)
 ;;                               <code nullFlavor="NA"/>
"RTN","C0CDAC8",492,0)
 ;;                           </playingEntity>
"RTN","C0CDAC8",493,0)
 ;;                       </participantRole>
"RTN","C0CDAC8",494,0)
 ;;                   </participant>
"RTN","C0CDAC8",495,0)
 ;;      	  </observation>
"RTN","C0CDAC8",496,0)
 ;;      	</entryRelationship>
"RTN","C0CDAC8",497,0)
 ;;      </act>
"RTN","C0CDAC8",498,0)
 ;;    </entry>
"RTN","C0CDAC8",499,0)
 ;;  </section>
"RTN","C0CDAC8",500,0)
 ;;</component>
"RTN","C0CDAC8",501,0)
 Q
"RTN","C0CDAC8",502,0)
 ;
"RTN","C0CDAC8",503,0)
TALGYR ; reaction
"RTN","C0CDAC8",504,0)
 ;;<entryRelationship inversionInd="true" typeCode="MFST">
"RTN","C0CDAC8",505,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC8",506,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.9"></templateId>
"RTN","C0CDAC8",507,0)
 ;;<id nullFlavor="UNK"></id>
"RTN","C0CDAC8",508,0)
 ;;<code code="ASSERTION" codeSystem="2.16.840.1.113883.5.4"></code>
"RTN","C0CDAC8",509,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC8",510,0)
 ;;<value code="@@reactionCode@@" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED" displayName="@@reactionName@@" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="CD"></value>
"RTN","C0CDAC8",511,0)
 ;;</observation>
"RTN","C0CDAC8",512,0)
 ;;</entryRelationship>
"RTN","C0CDAC8",513,0)
 Q
"RTN","C0CDAC8",514,0)
 ;
"RTN","C0CDAC8",515,0)
 ;;<reference value="#@@severityUri@@"></reference>
"RTN","C0CDAC8",516,0)
TALGYS ; severity
"RTN","C0CDAC8",517,0)
 ;;<entryRelationship inversionInd="true" typeCode="SUBJ">
"RTN","C0CDAC8",518,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC8",519,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.8"></templateId>
"RTN","C0CDAC8",520,0)
 ;;<code code="SEV" codeSystem="2.16.840.1.113883.5.4" codeSystemName="ActCode" displayName="Severity Observation"></code>
"RTN","C0CDAC8",521,0)
 ;;<text>
"RTN","C0CDAC8",522,0)
 ;;</text>
"RTN","C0CDAC8",523,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC8",524,0)
 ;;<value code="@@severityCode@@" codeSystem="2.16.840.1.113883.6.96" displayName="@@severityName@@" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="CD"></value>
"RTN","C0CDAC8",525,0)
 ;;</observation>
"RTN","C0CDAC8",526,0)
 ;;</entryRelationship>
"RTN","C0CDAC8",527,0)
 Q
"RTN","C0CDAC8",528,0)
 ;
"RTN","C0CDAC8",529,0)
TALGYC ; comment
"RTN","C0CDAC8",530,0)
 ;;<entryRelationship inversionInd="true" typeCode="SUBJ">
"RTN","C0CDAC8",531,0)
 ;;<act classCode="ACT" moodCode="EVN">
"RTN","C0CDAC8",532,0)
 ;;<templateId root="2.16.840.1.113883.10.20.1.40"></templateId>
"RTN","C0CDAC8",533,0)
 ;;<templateId root="2.16.840.1.113883.3.88.11.83.11"></templateId>
"RTN","C0CDAC8",534,0)
 ;;<templateId root="1.3.6.1.4.1.19376.1.5.3.1.4.2"></templateId>
"RTN","C0CDAC8",535,0)
 ;;<code code="48767-8" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Annotation Comment"></code>
"RTN","C0CDAC8",536,0)
 ;;<text>@@allergyComment@@
"RTN","C0CDAC8",537,0)
 ;;<reference value="#allergyComment-@@allergyGuid@@"></reference>
"RTN","C0CDAC8",538,0)
 ;;</text>
"RTN","C0CDAC8",539,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC8",540,0)
 ;;</act>
"RTN","C0CDAC8",541,0)
 ;;</entryRelationship>
"RTN","C0CDAC8",542,0)
 Q
"RTN","C0CDAC8",543,0)
 ;
"RTN","C0CDAC8",544,0)
TALGYSRC ; source
"RTN","C0CDAC8",545,0)
 ;;<entryRelationship contextConductionInd="true" typeCode="REFR">
"RTN","C0CDAC8",546,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDAC8",547,0)
 ;;<code code="48766-0" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Information source"></code>
"RTN","C0CDAC8",548,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDAC8",549,0)
 ;;<value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ST">@@allergySource@@</value>
"RTN","C0CDAC8",550,0)
 ;;</observation>
"RTN","C0CDAC8",551,0)
 ;;</entryRelationship>
"RTN","C0CDAC8",552,0)
 ;;</observation>
"RTN","C0CDAC8",553,0)
 Q
"RTN","C0CDAC8",554,0)
 ;
"RTN","C0CDAC8",555,0)
TALGYE ; end of allergy
"RTN","C0CDAC8",556,0)
 ;;</entryRelationship>
"RTN","C0CDAC8",557,0)
 ;;</act>
"RTN","C0CDAC8",558,0)
 ;;</entry>
"RTN","C0CDAC8",559,0)
 Q
"RTN","C0CDAC8",560,0)
 ;
"RTN","C0CDAC8",561,0)
TALGYEND ; end of section
"RTN","C0CDAC8",562,0)
 ;;</section>
"RTN","C0CDAC8",563,0)
 ;;</component>
"RTN","C0CDAC8",564,0)
 Q
"RTN","C0CDAC8",565,0)
 ;
"RTN","C0CDAC9")
0^10^B85540746
"RTN","C0CDAC9",1,0)
C0CDAC9 ; GPL - Patient Portal - CCDA Routines ;09/17/13  17:05
"RTN","C0CDAC9",2,0)
 ;;0.1;C0CDA;nopatch;noreleasedate;Build 1
"RTN","C0CDAC9",3,0)
 ;
"RTN","C0CDAC9",4,0)
 ; License AGPL v3.0
"RTN","C0CDAC9",5,0)
 ; 
"RTN","C0CDAC9",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDAC9",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDAC9",8,0)
 Q
"RTN","C0CDAC9",9,0)
 ;
"RTN","C0CDAC9",10,0)
 ; reason for visit
"RTN","C0CDAC9",11,0)
 ;
"RTN","C0CDAC9",12,0)
RFV(BLIST,DFN,CCDAWRK,CCDARPT,CCDACTRL) ; reason for visit
"RTN","C0CDAC9",13,0)
 ;
"RTN","C0CDAC9",14,0)
 N C0ARY,PARMS
"RTN","C0CDAC9",15,0)
 I $D(@CCDACTRL@("PARMS")) M PARMS=@CCDACTRL@("PARMS")
"RTN","C0CDAC9",16,0)
 Q:$$REDACT^C0CDACV("uri_reasonForVisit",.PARMS)
"RTN","C0CDAC9",17,0)
 Q:$$REDACT^C0CDACV("URI_REASONFORVISIT",.PARMS)
"RTN","C0CDAC9",18,0)
 I $G(PARMS("REASONFORVISIT"))="" S C0ARY("reasonForVisit")="Unknown"
"RTN","C0CDAC9",19,0)
 E  S C0ARY("reasonForVisit")=PARMS("REASONFORVISIT")
"RTN","C0CDAC9",20,0)
 ;
"RTN","C0CDAC9",21,0)
 ; the Reason for Visit section component
"RTN","C0CDAC9",22,0)
 ;
"RTN","C0CDAC9",23,0)
 N SSECT S SSECT=$NA(@CCDAWRK@("RFVSECT"))
"RTN","C0CDAC9",24,0)
 D GETNMAP^C0CDACU(SSECT,"TRFVSEC^C0CDAC9","C0ARY")
"RTN","C0CDAC9",25,0)
 D QUEUE^MXMLTMPL(BLIST,SSECT,1,@SSECT@(0))
"RTN","C0CDAC9",26,0)
 ;
"RTN","C0CDAC9",27,0)
 ;
"RTN","C0CDAC9",28,0)
 Q
"RTN","C0CDAC9",29,0)
 ;
"RTN","C0CDAC9",30,0)
 ;
"RTN","C0CDAC9",31,0)
TRFVSEC ;
"RTN","C0CDAC9",32,0)
 ;;<component>
"RTN","C0CDAC9",33,0)
 ;;<section>
"RTN","C0CDAC9",34,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.12"></templateId> <code code="29299-5" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="REASON FOR VISIT"></code>
"RTN","C0CDAC9",35,0)
 ;;<title>Reason For Visit</title>
"RTN","C0CDAC9",36,0)
 ;;<text ID="uri_reasonForVisit">
"RTN","C0CDAC9",37,0)
 ;;<paragraph>@@reasonForVisit@@</paragraph>
"RTN","C0CDAC9",38,0)
 ;;</text>
"RTN","C0CDAC9",39,0)
 ;;</section>
"RTN","C0CDAC9",40,0)
 ;;</component>
"RTN","C0CDAC9",41,0)
 Q
"RTN","C0CDAC9",42,0)
 ;
"RTN","C0CDAC9",43,0)
 ; plan of care
"RTN","C0CDAC9",44,0)
 ;
"RTN","C0CDAC9",45,0)
PLOC(BLIST,DFN,CCDAWRK,CCDARPT,CCDACTRL) ;
"RTN","C0CDAC9",46,0)
 ;
"RTN","C0CDAC9",47,0)
 N C0ARY,PARMS
"RTN","C0CDAC9",48,0)
 I $D(@CCDACTRL@("PARMS")) M PARMS=@CCDACTRL@("PARMS")
"RTN","C0CDAC9",49,0)
 Q:$$REDACT^C0CDACV("uri_planOfCare",.PARMS)
"RTN","C0CDAC9",50,0)
 Q:$$REDACT^C0CDACV("URI_PLANOFCARE",.PARMS)
"RTN","C0CDAC9",51,0)
 I $G(PARMS("PLANOFCARE"))="" S C0ARY("planOfCare")="Unknown"
"RTN","C0CDAC9",52,0)
 E  S C0ARY("planOfCare")=PARMS("PLANOFCARE")
"RTN","C0CDAC9",53,0)
 ;
"RTN","C0CDAC9",54,0)
 ; the Plan of Care section component
"RTN","C0CDAC9",55,0)
 ;
"RTN","C0CDAC9",56,0)
 N SSECT S SSECT=$NA(@CCDAWRK@("PLOCSECT"))
"RTN","C0CDAC9",57,0)
 D GETNMAP^C0CDACU(SSECT,"TPLOCSEC^C0CDAC9","C0ARY")
"RTN","C0CDAC9",58,0)
 D QUEUE^MXMLTMPL(BLIST,SSECT,1,@SSECT@(0))
"RTN","C0CDAC9",59,0)
 ;
"RTN","C0CDAC9",60,0)
 ;
"RTN","C0CDAC9",61,0)
 Q
"RTN","C0CDAC9",62,0)
 ;
"RTN","C0CDAC9",63,0)
 ;
"RTN","C0CDAC9",64,0)
TPLOCSEC ;
"RTN","C0CDAC9",65,0)
 ;;<component>
"RTN","C0CDAC9",66,0)
 ;;<section>
"RTN","C0CDAC9",67,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.10"></templateId>
"RTN","C0CDAC9",68,0)
 ;;<code code="18776-5" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Treatment plan"></code>
"RTN","C0CDAC9",69,0)
 ;;@@text@@
"RTN","C0CDAC9",70,0)
 ;;</section>
"RTN","C0CDAC9",71,0)
 ;;</component>
"RTN","C0CDAC9",72,0)
 Q
"RTN","C0CDAC9",73,0)
 ;
"RTN","C0CDAC9",74,0)
 ; reason for referral
"RTN","C0CDAC9",75,0)
 ;
"RTN","C0CDAC9",76,0)
RFR(BLIST,DFN,CCDAWRK,CCDARPT,CCDACTRL) ;
"RTN","C0CDAC9",77,0)
 ;
"RTN","C0CDAC9",78,0)
 N C0ARY,PARMS
"RTN","C0CDAC9",79,0)
 I $D(@CCDACTRL@("PARMS")) M PARMS=@CCDACTRL@("PARMS")
"RTN","C0CDAC9",80,0)
 Q:$$REDACT^C0CDACV("uri_reasonForReferral",.PARMS)
"RTN","C0CDAC9",81,0)
 Q:$$REDACT^C0CDACV("URI_REASONFORREFERRAL",.PARMS)
"RTN","C0CDAC9",82,0)
 I $G(PARMS("REASONFORREFERRAL"))="" S C0ARY("reasonForReferral")="Unknown"
"RTN","C0CDAC9",83,0)
 E  S C0ARY("reasonForReferral")=PARMS("REASONFORREFERRAL")
"RTN","C0CDAC9",84,0)
 ;
"RTN","C0CDAC9",85,0)
 ; the Reason For Referral section component
"RTN","C0CDAC9",86,0)
 ;
"RTN","C0CDAC9",87,0)
 N SSECT S SSECT=$NA(@CCDAWRK@("RFRSECT"))
"RTN","C0CDAC9",88,0)
 D GETNMAP^C0CDACU(SSECT,"TRFRSEC^C0CDAC9","C0ARY")
"RTN","C0CDAC9",89,0)
 D QUEUE^MXMLTMPL(BLIST,SSECT,1,@SSECT@(0))
"RTN","C0CDAC9",90,0)
 ;
"RTN","C0CDAC9",91,0)
 ;
"RTN","C0CDAC9",92,0)
 Q
"RTN","C0CDAC9",93,0)
 ;
"RTN","C0CDAC9",94,0)
 ;
"RTN","C0CDAC9",95,0)
TRFRSEC ;
"RTN","C0CDAC9",96,0)
 ;;<component>
"RTN","C0CDAC9",97,0)
 ;;<section>
"RTN","C0CDAC9",98,0)
 ;;<templateId root="1.3.6.1.4.1.19376.1.5.3.1.3.1"></templateId>
"RTN","C0CDAC9",99,0)
 ;;<code code="42349-1" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="REASON FOR REFERRAL"></code>
"RTN","C0CDAC9",100,0)
 ;;<title>Reason For Referral</title>
"RTN","C0CDAC9",101,0)
 ;;<text ID="uri_reasonForReferral">
"RTN","C0CDAC9",102,0)
 ;;<paragraph>@@reasonForReferral@@</paragraph>
"RTN","C0CDAC9",103,0)
 ;;</text>
"RTN","C0CDAC9",104,0)
 ;;</section>
"RTN","C0CDAC9",105,0)
 ;;</component>
"RTN","C0CDAC9",106,0)
 Q
"RTN","C0CDAC9",107,0)
 ;
"RTN","C0CDAC9",108,0)
 ; functional status
"RTN","C0CDAC9",109,0)
 ;
"RTN","C0CDAC9",110,0)
FUNC(BLIST,DFN,CCDAWRK,CCDARPT,CCDACTRL) ;
"RTN","C0CDAC9",111,0)
 ;
"RTN","C0CDAC9",112,0)
 N C0ARY,PARMS
"RTN","C0CDAC9",113,0)
 I $D(@CCDACTRL@("PARMS")) M PARMS=@CCDACTRL@("PARMS")
"RTN","C0CDAC9",114,0)
 Q:$$REDACT^C0CDACV("uri_functionalStatus",.PARMS)
"RTN","C0CDAC9",115,0)
 Q:$$REDACT^C0CDACV("URI_FUNCTIONALSTATUS",.PARMS)
"RTN","C0CDAC9",116,0)
 I $G(PARMS("FUNCTIONALSTATUS"))="" S C0ARY("functionalStatus")="Unknown"
"RTN","C0CDAC9",117,0)
 E  S C0ARY("functionalStatus")=PARMS("FUNCTIONALSTATUS")
"RTN","C0CDAC9",118,0)
 ;
"RTN","C0CDAC9",119,0)
 ; the Functional Status section component
"RTN","C0CDAC9",120,0)
 ;
"RTN","C0CDAC9",121,0)
 N SSECT S SSECT=$NA(@CCDAWRK@("FUNCSECT"))
"RTN","C0CDAC9",122,0)
 D GETNMAP^C0CDACU(SSECT,"TFUNCSEC^C0CDAC9","C0ARY")
"RTN","C0CDAC9",123,0)
 D QUEUE^MXMLTMPL(BLIST,SSECT,1,@SSECT@(0))
"RTN","C0CDAC9",124,0)
 ;
"RTN","C0CDAC9",125,0)
 ;
"RTN","C0CDAC9",126,0)
 Q
"RTN","C0CDAC9",127,0)
 ;
"RTN","C0CDAC9",128,0)
 ;
"RTN","C0CDAC9",129,0)
TFUNCSEC ;
"RTN","C0CDAC9",130,0)
 ;;<component>
"RTN","C0CDAC9",131,0)
 ;;<section>
"RTN","C0CDAC9",132,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.14"></templateId>
"RTN","C0CDAC9",133,0)
 ;;<code code="47420-5" codeSystem="2.16.840.1.113883.6.1"></code>
"RTN","C0CDAC9",134,0)
 ;;@@text@@
"RTN","C0CDAC9",135,0)
 ;;</section>
"RTN","C0CDAC9",136,0)
 ;;</component>
"RTN","C0CDAC9",137,0)
 Q
"RTN","C0CDAC9",138,0)
 ;
"RTN","C0CDAC9",139,0)
 ; advance directives
"RTN","C0CDAC9",140,0)
 ;
"RTN","C0CDAC9",141,0)
ADVD(BLIST,DFN,CCDAWRK,CCDARPT,CCDACTRL) ;
"RTN","C0CDAC9",142,0)
 ;
"RTN","C0CDAC9",143,0)
 N C0ARY,PARMS
"RTN","C0CDAC9",144,0)
 I $D(@CCDACTRL@("PARMS")) M PARMS=@CCDACTRL@("PARMS")
"RTN","C0CDAC9",145,0)
 Q:$$REDACT^C0CDACV("uri_advanceDirectives",.PARMS)
"RTN","C0CDAC9",146,0)
 Q:$$REDACT^C0CDACV("URI_ADVANCEDIRECTIVES",.PARMS)
"RTN","C0CDAC9",147,0)
 I $G(PARMS("ADVANCEDIRECTIVES"))="" S C0ARY("advanceDirectives")="No advance directives exist for this patient."
"RTN","C0CDAC9",148,0)
 E  S C0ARY("advanceDirectives")=PARMS("ADVANCEDIRECTIVES")
"RTN","C0CDAC9",149,0)
 ;
"RTN","C0CDAC9",150,0)
 ; the Advance Directives section component
"RTN","C0CDAC9",151,0)
 ;
"RTN","C0CDAC9",152,0)
 N SSECT S SSECT=$NA(@CCDAWRK@("ADVDSECT"))
"RTN","C0CDAC9",153,0)
 D GETNMAP^C0CDACU(SSECT,"TADVDSEC^C0CDAC9","C0ARY")
"RTN","C0CDAC9",154,0)
 D QUEUE^MXMLTMPL(BLIST,SSECT,1,@SSECT@(0))
"RTN","C0CDAC9",155,0)
 ;
"RTN","C0CDAC9",156,0)
 ;
"RTN","C0CDAC9",157,0)
 Q
"RTN","C0CDAC9",158,0)
 ;
"RTN","C0CDAC9",159,0)
 ;
"RTN","C0CDAC9",160,0)
TADVDSEC ;
"RTN","C0CDAC9",161,0)
 ;;<component>
"RTN","C0CDAC9",162,0)
 ;;<section>
"RTN","C0CDAC9",163,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.21"></templateId>
"RTN","C0CDAC9",164,0)
 ;;<code code="42348-3" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Advance Directives"></code>
"RTN","C0CDAC9",165,0)
 ;;@@text@@
"RTN","C0CDAC9",166,0)
 ;;</section>
"RTN","C0CDAC9",167,0)
 ;;</component>
"RTN","C0CDAC9",168,0)
 Q
"RTN","C0CDAC9",169,0)
 ;
"RTN","C0CDAC9",170,0)
 ;
"RTN","C0CDAC9",171,0)
 ; instructions
"RTN","C0CDAC9",172,0)
 ;
"RTN","C0CDAC9",173,0)
INST(BLIST,DFN,CCDAWRK,CCDARPT,CCDACTRL) ;
"RTN","C0CDAC9",174,0)
 ;
"RTN","C0CDAC9",175,0)
 N C0ARY,PARMS
"RTN","C0CDAC9",176,0)
 I $D(@CCDACTRL@("PARMS")) M PARMS=@CCDACTRL@("PARMS")
"RTN","C0CDAC9",177,0)
 Q:$$REDACT^C0CDACV("uri_instructions",.PARMS)
"RTN","C0CDAC9",178,0)
 Q:$$REDACT^C0CDACV("URI_INSTRUCTIONS",.PARMS)
"RTN","C0CDAC9",179,0)
 I $G(PARMS("INSTRUCTIONS"))="" S C0ARY("text")="Unknown"
"RTN","C0CDAC9",180,0)
 E  S C0ARY("text")=PARMS("INSTRUCTIONS")
"RTN","C0CDAC9",181,0)
 ;
"RTN","C0CDAC9",182,0)
 ; the Instructions section component
"RTN","C0CDAC9",183,0)
 ;
"RTN","C0CDAC9",184,0)
 N SSECT S SSECT=$NA(@CCDAWRK@("INSTSECT"))
"RTN","C0CDAC9",185,0)
 D GETNMAP^C0CDACU(SSECT,"TINSTSEC^C0CDAC9","C0ARY")
"RTN","C0CDAC9",186,0)
 D QUEUE^MXMLTMPL(BLIST,SSECT,1,@SSECT@(0))
"RTN","C0CDAC9",187,0)
 ;
"RTN","C0CDAC9",188,0)
 ;
"RTN","C0CDAC9",189,0)
 Q
"RTN","C0CDAC9",190,0)
 ;
"RTN","C0CDAC9",191,0)
 ;
"RTN","C0CDAC9",192,0)
TINSTSEC ;
"RTN","C0CDAC9",193,0)
 ;;<component>
"RTN","C0CDAC9",194,0)
 ;;<section>
"RTN","C0CDAC9",195,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.45"></templateId>
"RTN","C0CDAC9",196,0)
 ;;<id root="184fdbe3-f480-4199-976d-e0bb0dd02551"></id>
"RTN","C0CDAC9",197,0)
 ;;<code code="69730-0" codeSystem="2.16.840.1.113883.6.1" codeSystemVersion="LOINC" displayName="Instructions"></code>
"RTN","C0CDAC9",198,0)
 ;;<title>Instructions</title>
"RTN","C0CDAC9",199,0)
 ;;<text ID="uri_instructions">
"RTN","C0CDAC9",200,0)
 ;;@@text@@
"RTN","C0CDAC9",201,0)
 ;;</text>
"RTN","C0CDAC9",202,0)
 ;;</section>
"RTN","C0CDAC9",203,0)
 ;;</component>
"RTN","C0CDAC9",204,0)
 Q
"RTN","C0CDAC9",205,0)
 ;
"RTN","C0CDAC9",206,0)
TNOTESEC ;
"RTN","C0CDAC9",207,0)
 ;;<component>
"RTN","C0CDAC9",208,0)
 ;;<section>
"RTN","C0CDAC9",209,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.45"></templateId>
"RTN","C0CDAC9",210,0)
 ;;<id root="184fdbe3-f480-4199-976d-e0bb0dd02551"></id>
"RTN","C0CDAC9",211,0)
 ;;<code code="69730-0" codeSystem="2.16.840.1.113883.6.1" codeSystemVersion="LOINC" displayName="Instructions"></code>
"RTN","C0CDAC9",212,0)
 ;;@@text@@
"RTN","C0CDAC9",213,0)
 ;;</section>
"RTN","C0CDAC9",214,0)
 ;;</component>
"RTN","C0CDAC9",215,0)
 Q
"RTN","C0CDAC9",216,0)
 ;
"RTN","C0CDAC9",217,0)
 ;
"RTN","C0CDAC9",218,0)
 ; family history
"RTN","C0CDAC9",219,0)
 ;
"RTN","C0CDAC9",220,0)
FAMH(BLIST,DFN,CCDAWRK,CCDARPT,CCDACTRL) ;
"RTN","C0CDAC9",221,0)
 ;
"RTN","C0CDAC9",222,0)
 N C0ARY,PARMS
"RTN","C0CDAC9",223,0)
 I $D(@CCDACTRL@("PARMS")) M PARMS=@CCDACTRL@("PARMS")
"RTN","C0CDAC9",224,0)
 Q:$$REDACT^C0CDACV("uri_familyHistory",.PARMS)
"RTN","C0CDAC9",225,0)
 Q:$$REDACT^C0CDACV("URI_FAMILYHISTORY",.PARMS)
"RTN","C0CDAC9",226,0)
 I $G(PARMS("FAMILYHISTORY"))="" S C0ARY("familyHistory")="Non-contributory"
"RTN","C0CDAC9",227,0)
 E  S C0ARY("familyHistory")=PARMS("FAMILYHISTORY")
"RTN","C0CDAC9",228,0)
 ;
"RTN","C0CDAC9",229,0)
 ; the Family History section component
"RTN","C0CDAC9",230,0)
 ;
"RTN","C0CDAC9",231,0)
 N SSECT S SSECT=$NA(@CCDAWRK@("FAMHSECT"))
"RTN","C0CDAC9",232,0)
 D GETNMAP^C0CDACU(SSECT,"TFAMHSEC^C0CDAC9","C0ARY")
"RTN","C0CDAC9",233,0)
 D QUEUE^MXMLTMPL(BLIST,SSECT,1,@SSECT@(0))
"RTN","C0CDAC9",234,0)
 ;
"RTN","C0CDAC9",235,0)
 ;
"RTN","C0CDAC9",236,0)
 Q
"RTN","C0CDAC9",237,0)
 ;
"RTN","C0CDAC9",238,0)
 ;
"RTN","C0CDAC9",239,0)
TFAMHSEC ;
"RTN","C0CDAC9",240,0)
 ;;<component>
"RTN","C0CDAC9",241,0)
 ;;<section>
"RTN","C0CDAC9",242,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.15"></templateId>
"RTN","C0CDAC9",243,0)
 ;;<code code="10157-6" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Family History"></code>
"RTN","C0CDAC9",244,0)
 ;;<title>Family History</title>
"RTN","C0CDAC9",245,0)
 ;;<text ID="uri_familyHistory">
"RTN","C0CDAC9",246,0)
 ;;<paragraph>@@familyHistory@@</paragraph>
"RTN","C0CDAC9",247,0)
 ;;</text>
"RTN","C0CDAC9",248,0)
 ;;</section>
"RTN","C0CDAC9",249,0)
 ;;</component>
"RTN","C0CDAC9",250,0)
 Q
"RTN","C0CDAC9",251,0)
 ;
"RTN","C0CDAC9",252,0)
 ;
"RTN","C0CDAC9",253,0)
 ; Discharge Instructions
"RTN","C0CDAC9",254,0)
 ;
"RTN","C0CDAC9",255,0)
DIS(BLIST,DFN,CCDAWRK,CCDARPT,CCDACTRL) ; 
"RTN","C0CDAC9",256,0)
 ;
"RTN","C0CDAC9",257,0)
 N C0ARY,PARMS
"RTN","C0CDAC9",258,0)
 I $D(@CCDACTRL@("PARMS")) M PARMS=@CCDACTRL@("PARMS")
"RTN","C0CDAC9",259,0)
 Q:$$REDACT^C0CDACV("uri_dischargeInstructions",.PARMS)
"RTN","C0CDAC9",260,0)
 Q:$$REDACT^C0CDACV("URI_DISCHARGEINSTRUCTIONS",.PARMS)
"RTN","C0CDAC9",261,0)
 I $G(PARMS("DISCHARGE"))="" S C0ARY("dischargeText")="Unknown"
"RTN","C0CDAC9",262,0)
 E  S C0ARY("dischargeText")=PARMS("DISCHARGE")
"RTN","C0CDAC9",263,0)
 ;
"RTN","C0CDAC9",264,0)
 ; the Discharge Instructions section component
"RTN","C0CDAC9",265,0)
 ;
"RTN","C0CDAC9",266,0)
 N SSECT S SSECT=$NA(@CCDAWRK@("DISSECT"))
"RTN","C0CDAC9",267,0)
 D GETNMAP^C0CDACU(SSECT,"TDISSEC^C0CDAC9","C0ARY")
"RTN","C0CDAC9",268,0)
 D QUEUE^MXMLTMPL(BLIST,SSECT,1,@SSECT@(0))
"RTN","C0CDAC9",269,0)
 ;
"RTN","C0CDAC9",270,0)
 ;
"RTN","C0CDAC9",271,0)
 Q
"RTN","C0CDAC9",272,0)
 ;
"RTN","C0CDAC9",273,0)
 ;
"RTN","C0CDAC9",274,0)
TDISSEC ;
"RTN","C0CDAC9",275,0)
 ;;<component>
"RTN","C0CDAC9",276,0)
 ;; <section>
"RTN","C0CDAC9",277,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.41"/>
"RTN","C0CDAC9",278,0)
 ;;<code code="8653-8" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Hospital Discharge Instructions"/>
"RTN","C0CDAC9",279,0)
 ;;@@text@@
"RTN","C0CDAC9",280,0)
 ;;</section>
"RTN","C0CDAC9",281,0)
 ;;</component>
"RTN","C0CDAC9",282,0)
 Q
"RTN","C0CDAC9",283,0)
 ;
"RTN","C0CDACD")
0^11^B26122201
"RTN","C0CDACD",1,0)
C0CDACD ; GPL - Patient Portal - DOM PROCESSING ROUTINES ;8/29/13  17:05
"RTN","C0CDACD",2,0)
 ;;0.1;COCDA;nopatch;noreleasedate;Build 1
"RTN","C0CDACD",3,0)
 ;
"RTN","C0CDACD",4,0)
 ; License AGPL v3.0
"RTN","C0CDACD",5,0)
 ; 
"RTN","C0CDACD",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDACD",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDACD",8,0)
 ;
"RTN","C0CDACD",9,0)
 Q
"RTN","C0CDACD",10,0)
 ;
"RTN","C0CDACD",11,0)
 ; here are the types that are supported:
"RTN","C0CDACD",12,0)
 ;demographics;reactions;problems;vitals;labs;meds;immunizations;observation;
"RTN","C0CDACD",13,0)
 ;visits;appointments;documents;procedures;consults;flags;factors;skinTests;
"RTN","C0CDACD",14,0)
 ;exams;education;insurance
"RTN","C0CDACD",15,0)
 ;
"RTN","C0CDACD",16,0)
GETPAT(RTN,ZPATID,ZTYP,START,STOP,METHOD) ; get patient data
"RTN","C0CDACD",17,0)
 N JJOHARY
"RTN","C0CDACD",18,0)
 S START=$G(START)
"RTN","C0CDACD",19,0)
 S STOP=$G(STOP)
"RTN","C0CDACD",20,0)
 D GET^VPRD(.JJOHARY,ZPATID,ZTYP,START,STOP)
"RTN","C0CDACD",21,0)
 S JJOHDID=$$PARSE(JJOHARY,ZPATID_"-"_ZTYP)
"RTN","C0CDACD",22,0)
 D DOMO(1,"/","RTN","GIDX","GARY",,"/results/"_ZTYP_"/")
"RTN","C0CDACD",23,0)
 I $G(METHOD)=2 D  ;
"RTN","C0CDACD",24,0)
 . K RTN
"RTN","C0CDACD",25,0)
 . D DEMUX2("RTN","GARY")
"RTN","C0CDACD",26,0)
 K GIDX,GARY,@JJOHARY
"RTN","C0CDACD",27,0)
 ;
"RTN","C0CDACD",28,0)
 Q
"RTN","C0CDACD",29,0)
 ;
"RTN","C0CDACD",30,0)
GETNHIN(RTN,ZPATID,ZTYP) ; get patient data
"RTN","C0CDACD",31,0)
 N JJOHARY
"RTN","C0CDACD",32,0)
 D GET^C0CDACN(.JJOHARY,ZPATID,ZTYP)
"RTN","C0CDACD",33,0)
 S JJOHDID=$$PARSE(JJOHARY,ZPATID_"-"_ZTYP)
"RTN","C0CDACD",34,0)
 D DOMO(1,"/","RTN","GIDX","GARY",,"/results/")
"RTN","C0CDACD",35,0)
 K GIDX,GARY,@JJOHARY
"RTN","C0CDACD",36,0)
 ;
"RTN","C0CDACD",37,0)
 Q
"RTN","C0CDACD",38,0)
 ;
"RTN","C0CDACD",39,0)
TEST ;
"RTN","C0CDACD",40,0)
 K GARY,GIDX,GNARY
"RTN","C0CDACD",41,0)
 S JJOHDID=1
"RTN","C0CDACD",42,0)
 D DOMO(1,"/","GNARY","GIDX","GARY",,"/results/")
"RTN","C0CDACD",43,0)
 Q
"RTN","C0CDACD",44,0)
 ;
"RTN","C0CDACD",45,0)
DOMO(ZOID,ZPATH,ZNARY,ZXIDX,ZXPARY,ZNUM,ZREDUX) ; RECURSIVE ROUTINE TO POPULATE
"RTN","C0CDACD",46,0)
 ; THE XPATH INDEX ZXIDX, PASSED BY NAME
"RTN","C0CDACD",47,0)
 ; THE XPATH ARRAY XPARY, PASSED BY NAME
"RTN","C0CDACD",48,0)
 ; ZOID IS THE STARTING OID
"RTN","C0CDACD",49,0)
 ; ZPATH IS THE STARTING XPATH, USUALLY "/"
"RTN","C0CDACD",50,0)
 ; ZNUM IS THE MULTIPLE NUMBER [x], USUALLY NULL WHEN ON THE TOP NODE
"RTN","C0CDACD",51,0)
 ; ZREDUX IS THE XPATH REDUCTION STRING, TAKEN OUT OF EACH XPATH IF PRESENT
"RTN","C0CDACD",52,0)
 I $G(ZREDUX)="" S ZREDUX=""
"RTN","C0CDACD",53,0)
 N NEWPATH,NARY ; NEWPATH IS AN XPATH NARY IS AN NHIN MUMPS ARRAY
"RTN","C0CDACD",54,0)
 N NEWNUM S NEWNUM=""
"RTN","C0CDACD",55,0)
 I $G(ZNUM)>0 S NEWNUM="["_ZNUM_"]"
"RTN","C0CDACD",56,0)
 S NEWPATH=ZPATH_"/"_$$TAG(ZOID)_NEWNUM ; CREATE THE XPATH FOR THIS NODE
"RTN","C0CDACD",57,0)
 I $G(ZREDUX)'="" D  ; REDUX PROVIDED?
"RTN","C0CDACD",58,0)
 . N GT S GT=$P(NEWPATH,ZREDUX,2)
"RTN","C0CDACD",59,0)
 . I GT'="" S NEWPATH=GT
"RTN","C0CDACD",60,0)
 S @ZXIDX@(NEWPATH)=ZOID ; ADD THE XPATH FOR THIS NODE TO THE XPATH INDEX
"RTN","C0CDACD",61,0)
 N GA D ATT("GA",ZOID) ; GET ATTRIBUTES FOR THIS NODE
"RTN","C0CDACD",62,0)
 I $D(GA) D  ; PROCESS THE ATTRIBUTES
"RTN","C0CDACD",63,0)
 . N ZI S ZI=""
"RTN","C0CDACD",64,0)
 . F  S ZI=$O(GA(ZI)) Q:ZI=""  D  ; FOR EACH ATTRIBUTE
"RTN","C0CDACD",65,0)
 . . N ZP S ZP=NEWPATH_"@"_ZI ; PATH FOR ATTRIBUTE
"RTN","C0CDACD",66,0)
 . . S @ZXPARY@(ZP)=GA(ZI) ; ADD THE ATTRIBUTE XPATH TO THE XP ARRAY
"RTN","C0CDACD",67,0)
 . . I GA(ZI)'="" D ADDNARY(ZP,GA(ZI)) ; ADD THE NHIN ARRAY VALUE
"RTN","C0CDACD",68,0)
 N GD D DATA("GD",ZOID) ; SEE IF THERE IS DATA FOR THIS NODE
"RTN","C0CDACD",69,0)
 I $D(GD(2)) D  ;
"RTN","C0CDACD",70,0)
 . M @ZXPARY@(NEWPATH)=GD ; IF MULITPLE DATA MERGE TO THE ARRAY
"RTN","C0CDACD",71,0)
 E  I $D(GD(1)) D  ;
"RTN","C0CDACD",72,0)
 . S @ZXPARY@(NEWPATH)=GD(1) ; IF SINGLE VALUE, ADD TO ARRAY
"RTN","C0CDACD",73,0)
 . I GD(1)'="" D ADDNARY(NEWPATH,GD(1)) ; ADD TO NHIN ARRAY
"RTN","C0CDACD",74,0)
 N ZFRST S ZFRST=$$FIRST(ZOID) ; SET FIRST CHILD
"RTN","C0CDACD",75,0)
 I ZFRST'=0 D  ; THERE IS A CHILD
"RTN","C0CDACD",76,0)
 . N ZNUM
"RTN","C0CDACD",77,0)
 . N ZMULT S ZMULT=$$ISMULT(ZFRST) ; IS FIRST CHILD A MULTIPLE
"RTN","C0CDACD",78,0)
 . D DOMO(ZFRST,NEWPATH,ZNARY,ZXIDX,ZXPARY,$S(ZMULT:1,1:""),ZREDUX) ; THE CHILD
"RTN","C0CDACD",79,0)
 N GNXT S GNXT=$$NXTSIB(ZOID)
"RTN","C0CDACD",80,0)
 I $$TAG(GNXT)'=$$TAG(ZOID) S ZNUM="" ; RESET COUNTING AFTER MULTIPLES
"RTN","C0CDACD",81,0)
 I GNXT'=0 D  ;
"RTN","C0CDACD",82,0)
 . N ZMULT S ZMULT=$$ISMULT(GNXT) ; IS THE SIBLING A MULTIPLE?
"RTN","C0CDACD",83,0)
 . I (ZNUM="")&(ZMULT) D  ; SIBLING IS FIRST OF MULTIPLES
"RTN","C0CDACD",84,0)
 . . N ZNUM S ZNUM=1 ;
"RTN","C0CDACD",85,0)
 . . D DOMO(GNXT,ZPATH,ZNARY,ZXIDX,ZXPARY,ZNUM,ZREDUX) ; DO NEXT SIB
"RTN","C0CDACD",86,0)
 . E  D DOMO(GNXT,ZPATH,ZNARY,ZXIDX,ZXPARY,$S(ZNUM>0:ZNUM+1,1:""),ZREDUX) ; SIB
"RTN","C0CDACD",87,0)
 Q
"RTN","C0CDACD",88,0)
 ;
"RTN","C0CDACD",89,0)
ADDNARY(ZXP,ZVALUE) ; ADD AN NHIN ARRAY VALUE TO ZNARY
"RTN","C0CDACD",90,0)
 ;
"RTN","C0CDACD",91,0)
 ; IF ZATT=1 THE ARRAY IS ADDED AS ATTRIBUTES
"RTN","C0CDACD",92,0)
 ;
"RTN","C0CDACD",93,0)
 N ZZI,ZZJ,ZZN
"RTN","C0CDACD",94,0)
 S ZZI=$P(ZXP,"/",1) ; FIRST PIECE OF XPATH ARRAY
"RTN","C0CDACD",95,0)
 I ZZI="" Q  ; DON'T ADD THIS ONE .. PROBABLY THE //results NODE
"RTN","C0CDACD",96,0)
 S ZZJ=$P(ZXP,ZZI_"/",2) ; REST OF XPATH ARRAY
"RTN","C0CDACD",97,0)
 S ZZJ=$TR(ZZJ,"/",".") ; REPLACE / WITH .
"RTN","C0CDACD",98,0)
 I ZZI'["]" D  ; A SINGLETON
"RTN","C0CDACD",99,0)
 . S ZZN=1
"RTN","C0CDACD",100,0)
 E  D  ; THERE IS AN [x] OCCURANCE
"RTN","C0CDACD",101,0)
 . S ZZN=$P($P(ZZI,"[",2),"]",1) ; PULL OUT THE OCCURANCE
"RTN","C0CDACD",102,0)
 . S ZZI=$P(ZZI,"[",1) ; TAKE OUT THE [X]
"RTN","C0CDACD",103,0)
 I ZZJ'="" D  ; TIME TO ADD THE VALUE
"RTN","C0CDACD",104,0)
 . S @ZNARY@(ZZI,ZZN,ZZJ)=ZVALUE
"RTN","C0CDACD",105,0)
 Q
"RTN","C0CDACD",106,0)
 ;
"RTN","C0CDACD",107,0)
PARSE(INXML,INDOC) ;CALL THE MXML PARSER ON INXML, PASSED BY NAME
"RTN","C0CDACD",108,0)
 ; INDOC IS PASSED AS THE DOCUMENT NAME - DON'T KNOW WHERE TO STORE THIS NOW
"RTN","C0CDACD",109,0)
 ; EXTRINSIC WHICH RETURNS THE DOCID ASSIGNED BY MXML
"RTN","C0CDACD",110,0)
 ;Q $$EN^MXMLDOM(INXML)
"RTN","C0CDACD",111,0)
 Q $$EN^MXMLDOM(INXML,"W")
"RTN","C0CDACD",112,0)
 ;
"RTN","C0CDACD",113,0)
ISMULT(ZOID) ; RETURN TRUE IF ZOID IS ONE OF A MULTIPLE
"RTN","C0CDACD",114,0)
 N ZN
"RTN","C0CDACD",115,0)
 ;I $$TAG(ZOID)["entry" B
"RTN","C0CDACD",116,0)
 S ZN=$$NXTSIB(ZOID)
"RTN","C0CDACD",117,0)
 I ZN'="" Q $$TAG(ZOID)=$$TAG(ZN) ; IF TAG IS THE SAME AS NEXT SIB TAG
"RTN","C0CDACD",118,0)
 Q 0
"RTN","C0CDACD",119,0)
 ;
"RTN","C0CDACD",120,0)
FIRST(ZOID) ;RETURNS THE OID OF THE FIRST CHILD OF ZOID
"RTN","C0CDACD",121,0)
 Q $$CHILD^MXMLDOM(JJOHDID,ZOID)
"RTN","C0CDACD",122,0)
 ;
"RTN","C0CDACD",123,0)
PARENT(ZOID) ;RETURNS THE OID OF THE PARENT OF ZOID
"RTN","C0CDACD",124,0)
 Q $$PARENT^MXMLDOM(JJOHDID,ZOID)
"RTN","C0CDACD",125,0)
 ;
"RTN","C0CDACD",126,0)
ATT(RTN,NODE) ;GET ATTRIBUTES FOR ZOID
"RTN","C0CDACD",127,0)
 S HANDLE=JJOHDID
"RTN","C0CDACD",128,0)
 K @RTN
"RTN","C0CDACD",129,0)
 D GETTXT^MXMLDOM("A")
"RTN","C0CDACD",130,0)
 Q
"RTN","C0CDACD",131,0)
 ;
"RTN","C0CDACD",132,0)
TAG(ZOID) ; RETURNS THE XML TAG FOR THE NODE
"RTN","C0CDACD",133,0)
 ;
"RTN","C0CDACD",134,0)
 N X,Y
"RTN","C0CDACD",135,0)
 S Y=""
"RTN","C0CDACD",136,0)
 S X=$G(JJOHCBK("TAG")) ;IS THERE A CALLBACK FOR THIS ROUTINE
"RTN","C0CDACD",137,0)
 I X'="" X X ; EXECUTE THE CALLBACK, SHOULD SET Y
"RTN","C0CDACD",138,0)
 I Y="" S Y=$$NAME^MXMLDOM(JJOHDID,ZOID)
"RTN","C0CDACD",139,0)
 Q Y
"RTN","C0CDACD",140,0)
 ;
"RTN","C0CDACD",141,0)
NXTSIB(ZOID) ; RETURNS THE NEXT SIBLING
"RTN","C0CDACD",142,0)
 Q $$SIBLING^MXMLDOM(JJOHDID,ZOID)
"RTN","C0CDACD",143,0)
 ;
"RTN","C0CDACD",144,0)
DATA(ZT,ZOID) ; RETURNS DATA FOR THE NODE
"RTN","C0CDACD",145,0)
 ;N ZT,ZN S ZT=""
"RTN","C0CDACD",146,0)
 ;S C0SDOM=$NA(^TMP("MXMLDOM",$J,JJOHDID))
"RTN","C0CDACD",147,0)
 ;Q $G(@C0SDOM@(ZOID,"T",1))
"RTN","C0CDACD",148,0)
 S ZN=$$TEXT^MXMLDOM(JJOHDID,ZOID,ZT)
"RTN","C0CDACD",149,0)
 Q
"RTN","C0CDACD",150,0)
 ;
"RTN","C0CDACD",151,0)
DEMUX2(OARY,IARY,DEPTH) ;CONVERT AN XPATH ARRAY PASSED AS IARY TO
"RTN","C0CDACD",152,0)
 ; FORMAT @OARY@(x,variablename) where x is the first multiple
"RTN","C0CDACD",153,0)
 ; IF DEPTH=2, THE LAST 2 PARTS OF THE XPATH WILL BE USED
"RTN","C0CDACD",154,0)
 N ZI,ZJ,ZK,ZL,ZM S ZI=""
"RTN","C0CDACD",155,0)
 F  S ZI=$O(@IARY@(ZI)) Q:ZI=""  D  ;
"RTN","C0CDACD",156,0)
 . D DEMUX^C0CMXP("ZJ",ZI)
"RTN","C0CDACD",157,0)
 . S ZK=$P(ZJ,"^",3)
"RTN","C0CDACD",158,0)
 . S ZM=$RE($P($RE(ZK),"/",1))
"RTN","C0CDACD",159,0)
 . I $G(DEPTH)=2 D  ;LAST TWO PARTS OF XPATH USED FOR THE VARIABLE NAME
"RTN","C0CDACD",160,0)
 . . S ZM=$RE($P($RE(ZK),"/",2))_"."_ZM
"RTN","C0CDACD",161,0)
 . S ZL=$P(ZJ,"^",1)
"RTN","C0CDACD",162,0)
 . I ZL="" S ZL=1
"RTN","C0CDACD",163,0)
 . I $D(@OARY@(ZL,ZM)) D  ;IT'S A DUP
"RTN","C0CDACD",164,0)
 . . S @OARY@(ZL,ZM_"[2]")=@IARY@(ZI)
"RTN","C0CDACD",165,0)
 . E  S @OARY@(ZL,ZM)=@IARY@(ZI)
"RTN","C0CDACD",166,0)
 Q
"RTN","C0CDACD",167,0)
 ;
"RTN","C0CDACE")
0^12^B122081491
"RTN","C0CDACE",1,0)
C0CDACE ; GPL - Patient Portal - DOM PROCESSING ROUTINES ;8/29/13  17:05
"RTN","C0CDACE",2,0)
 ;;0.1;C0CDA;nopatch;noreleasedate;Build 1
"RTN","C0CDACE",3,0)
 ;
"RTN","C0CDACE",4,0)
 ; License AGPL v3.0
"RTN","C0CDACE",5,0)
 ; 
"RTN","C0CDACE",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDACE",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDACE",8,0)
 ;
"RTN","C0CDACE",9,0)
 Q
"RTN","C0CDACE",10,0)
 ;
"RTN","C0CDACE",11,0)
 ; here are the types that are supported:
"RTN","C0CDACE",12,0)
 ;demographics;reactions;problems;vitals;labs;meds;immunizations;observation;
"RTN","C0CDACE",13,0)
 ;visits;appointments;documents;procedures;consults;flags;factors;skinTests;
"RTN","C0CDACE",14,0)
 ;exams;education;insurance
"RTN","C0CDACE",15,0)
 ;
"RTN","C0CDACE",16,0)
GETPAT(RTN,ZPATID,ZTYP,START,STOP) ; get patient data
"RTN","C0CDACE",17,0)
 N C0CDAARY
"RTN","C0CDACE",18,0)
 S START=$G(START) 
"RTN","C0CDACE",19,0)
 S STOP=$G(STOP)
"RTN","C0CDACE",20,0)
 D GET^VPRD(.C0CDAARY,ZPATID,ZTYP,START,STOP)
"RTN","C0CDACE",21,0)
 ;D GET^HMPD(.C0CDAARY,ZPATID,ZTYP,START,STOP)
"RTN","C0CDACE",22,0)
 ;K ^TMP("MXMLDOM",$J,1)
"RTN","C0CDACE",23,0)
 S C0CDADID=$$PARSE(C0CDAARY,ZPATID_"-"_ZTYP)
"RTN","C0CDACE",24,0)
 k RTN
"RTN","C0CDACE",25,0)
 N ZDOM S ZDOM=$NA(^TMP("MXMLDOM",$J,C0CDADID))
"RTN","C0CDACE",26,0)
 d domo3("RTN",,,ZDOM)
"RTN","C0CDACE",27,0)
 ;D DOMO(1,"/","RTN","GIDX","GARY",,"/results/"_ZTYP_"/")
"RTN","C0CDACE",28,0)
 K GIDX,GARY,@C0CDAARY,@ZDOM ; gpl 20151004 
"RTN","C0CDACE",29,0)
 ;
"RTN","C0CDACE",30,0)
 Q
"RTN","C0CDACE",31,0)
 ;
"RTN","C0CDACE",32,0)
GETNHIN(RTN,ZPATID,ZTYP) ; get patient data
"RTN","C0CDACE",33,0)
 N C0CDAARY
"RTN","C0CDACE",34,0)
 D GET^C0CDACN(.C0CDAARY,ZPATID,ZTYP)
"RTN","C0CDACE",35,0)
 K ^TMP("MXMLDOM",$J,1)
"RTN","C0CDACE",36,0)
 S C0CDADID=$$PARSE(C0CDAARY,ZPATID_"-"_ZTYP)
"RTN","C0CDACE",37,0)
 k RTN
"RTN","C0CDACE",38,0)
 N ZDOM S ZDOM=$NA(^TMP("MXMLDOM",$J,C0CDADID))
"RTN","C0CDACE",39,0)
 ;d domo2("RTN",ZDOM)
"RTN","C0CDACE",40,0)
 d domo3("RTN",,,ZDOM)
"RTN","C0CDACE",41,0)
 ;D DOMO(1,"/","RTN","GIDX","GARY",,"/results/")
"RTN","C0CDACE",42,0)
 ;K GIDX,GARY,@C0CDAARY
"RTN","C0CDACE",43,0)
 ;
"RTN","C0CDACE",44,0)
 Q
"RTN","C0CDACE",45,0)
 ;
"RTN","C0CDACE",46,0)
GETBIG ; 
"RTN","C0CDACE",47,0)
 S GN=$NA(^KBAI("TOOBIG","XML"))
"RTN","C0CDACE",48,0)
 S GD="/home/vista/CCDA/"
"RTN","C0CDACE",49,0)
 S GF="TOOBIG.xml"
"RTN","C0CDACE",50,0)
 K @GN
"RTN","C0CDACE",51,0)
 S OK=$$FTG^%ZISH(GD,GF,$NA(@GN@(1)),3)
"RTN","C0CDACE",52,0)
 S GDOM=$NA(^KBAI("TOOBIG","DOM"))
"RTN","C0CDACE",53,0)
 D:OK PARSE^KBAIOSD3(GDOM,GN)
"RTN","C0CDACE",54,0)
 K ^TMP("MXMLDOM",$J,1)
"RTN","C0CDACE",55,0)
 M ^TMP("MXMLDOM",$J,1)=@GDOM
"RTN","C0CDACE",56,0)
 Q
"RTN","C0CDACE",57,0)
 ;
"RTN","C0CDACE",58,0)
tree(where,prefix,docid,zout,zary) ; show a tree starting at a node in MXML. 
"RTN","C0CDACE",59,0)
 ; node is passed by name
"RTN","C0CDACE",60,0)
 ; 
"RTN","C0CDACE",61,0)
 i '$d(zary) s zary="GARY"
"RTN","C0CDACE",62,0)
 i '$d(@zary) s @zary=""
"RTN","C0CDACE",63,0)
 i $g(prefix)="" s prefix="/" ; starting prefix
"RTN","C0CDACE",64,0)
 i '$d(KBAIJOB) s KBAIJOB=$J
"RTN","C0CDACE",65,0)
 n node s node=$na(^TMP("MXMLDOM",KBAIJOB,docid,where))
"RTN","C0CDACE",66,0)
 n txt s txt=$$CLEAN($$ALLTXT(node))
"RTN","C0CDACE",67,0)
 n g s g=prefix
"RTN","C0CDACE",68,0)
 n gt s gt=prefix_"/"_@node
"RTN","C0CDACE",69,0)
 n gt1 s gt1=1
"RTN","C0CDACE",70,0)
 i $d(@zary@(gt)) d  ;
"RTN","C0CDACE",71,0)
 . s gt1=$o(@zary@(gt,""),-1)+1
"RTN","C0CDACE",72,0)
 ;i txt'="",txt'=" " d  ;
"RTN","C0CDACE",73,0)
 s @zary@(gt1,gt)=txt
"RTN","C0CDACE",74,0)
 s @zary@(gt,gt1)=txt
"RTN","C0CDACE",75,0)
 w !,gt_" "_txt
"RTN","C0CDACE",76,0)
 d oneout(zout,prefix_@node_" "_txt)
"RTN","C0CDACE",77,0)
 n zi s zi=""
"RTN","C0CDACE",78,0)
 f  s zi=$o(@node@("A",zi)) q:zi=""  d  ;
"RTN","C0CDACE",79,0)
 . s @zary@(gt1,g,@node_"@"_zi)=$g(@node@("A",zi))
"RTN","C0CDACE",80,0)
 . w !,prefix_"/"_@node_"@"_zi_"="_$g(@node@("A",zi))
"RTN","C0CDACE",81,0)
 . d oneout(zout,prefix_"/"_@node_"@"_zi_"="_$g(@node@("A",zi)))
"RTN","C0CDACE",82,0)
 f  s zi=$o(@node@("C",zi)) q:zi=""  d  ;
"RTN","C0CDACE",83,0)
 . d tree(zi,prefix_"/"_@node,docid,zout)
"RTN","C0CDACE",84,0)
 q
"RTN","C0CDACE",85,0)
 ;
"RTN","C0CDACE",86,0)
domo2(zary,zdom,redux,zout,where,prefix,znum) ; returns zary passed by name
"RTN","C0CDACE",87,0)
 ; with all the actual data in the dom - only works well for some kind of xml 
"RTN","C0CDACE",88,0)
 ; 
"RTN","C0CDACE",89,0)
 i '$d(gidx) s gidx="gidx"
"RTN","C0CDACE",90,0)
 i $g(zout)="" k zout
"RTN","C0CDACE",91,0)
 i '$d(redux) s redux=""
"RTN","C0CDACE",92,0)
 i '$d(where) s where=1
"RTN","C0CDACE",93,0)
 i '$d(@zary) s @zary=""
"RTN","C0CDACE",94,0)
 i '$d(znum) s znum=1
"RTN","C0CDACE",95,0)
 ;m GGIDX=gidx
"RTN","C0CDACE",96,0)
 i $g(prefix)="" s prefix="" ; starting prefix
"RTN","C0CDACE",97,0)
 n node 
"RTN","C0CDACE",98,0)
 i '$d(zdom) s zdom=$na(^TMP("MXMLDOM",$J,$o(^TMP("MXMLDOM",$J,"AAAAA"),-1)))
"RTN","C0CDACE",99,0)
 s node=$na(@zdom@(where))
"RTN","C0CDACE",100,0)
 n txt s txt=$$CLEAN($$ALLTXT(node))
"RTN","C0CDACE",101,0)
 n g s g=prefix
"RTN","C0CDACE",102,0)
 n gt s gt=prefix_"."_@node
"RTN","C0CDACE",103,0)
 n gt1 s gt1=$g(znum)
"RTN","C0CDACE",104,0)
 ;i $l(g,".")=3 d  ;
"RTN","C0CDACE",105,0)
 ;. s znum=znum+1
"RTN","C0CDACE",106,0)
 ;. s gt1=znum
"RTN","C0CDACE",107,0)
 w !,gt," ",gt1
"RTN","C0CDACE",108,0)
 ;i @node="documents" b  ;
"RTN","C0CDACE",109,0)
 ;;. ;B
"RTN","C0CDACE",110,0)
 ;b  ; i $d(gt1,@node) 
"RTN","C0CDACE",111,0)
 i $d(@gidx@(gt)) d  ;
"RTN","C0CDACE",112,0)
 . s gt1=@gidx@(gt)+1
"RTN","C0CDACE",113,0)
 . s znum=gt1
"RTN","C0CDACE",114,0)
 ;e  s gt1=1
"RTN","C0CDACE",115,0)
 i @node="visit" d  ;
"RTN","C0CDACE",116,0)
 . s @gidx@(gt)=gt1
"RTN","C0CDACE",117,0)
 . ;b
"RTN","C0CDACE",118,0)
 ;n gt1 s gt1=1
"RTN","C0CDACE",119,0)
 ;i $d(@gidx@(gt)) d  ;
"RTN","C0CDACE",120,0)
 ;. s gt1=$o(@gidx@(gt,""),-1)+1
"RTN","C0CDACE",121,0)
 ;. b
"RTN","C0CDACE",122,0)
 i txt'="",txt'=" " d  ;
"RTN","C0CDACE",123,0)
 . s @zary@(gt1,@node)=txt
"RTN","C0CDACE",124,0)
 ;s @gidx@(gt,gt1)=txt
"RTN","C0CDACE",125,0)
 w:$g(C0DEBUG) !,gt_" "_txt
"RTN","C0CDACE",126,0)
 i $d(zout) d oneout(zout,prefix_@node_" "_txt)
"RTN","C0CDACE",127,0)
 n zi s zi=""
"RTN","C0CDACE",128,0)
 f  s zi=$o(@node@("A",zi)) q:zi=""  d  ;
"RTN","C0CDACE",129,0)
 . n gr,gpred s gr=$p(g,redux,2)
"RTN","C0CDACE",130,0)
 . s gpred=gr_@node_"."_zi
"RTN","C0CDACE",131,0)
 . w !,gpred
"RTN","C0CDACE",132,0)
 . i $d(@zary@(gt1,gpred)) d  ;
"RTN","C0CDACE",133,0)
 . . n i,j f i=1:1  s j=gpred_"["_i_"]" q:'$d(@zary@(j))  s gpred=j
"RTN","C0CDACE",134,0)
 . s @zary@(gt1,gpred)=$g(@node@("A",zi))
"RTN","C0CDACE",135,0)
 . ;B
"RTN","C0CDACE",136,0)
 . w:$g(C0DEBUG) !,prefix_@node_"@"_zi_"="_$g(@node@("A",zi))
"RTN","C0CDACE",137,0)
 . i $d(zout) d oneout(zout,prefix_"."_@node_"@"_zi_"="_$g(@node@("A",zi)))
"RTN","C0CDACE",138,0)
 f  s zi=$o(@node@("C",zi)) q:zi=""  d  ;
"RTN","C0CDACE",139,0)
 . d domo2(zary,zdom,redux,$g(zout),zi,prefix_"."_@node,znum)
"RTN","C0CDACE",140,0)
 q
"RTN","C0CDACE",141,0)
 ;
"RTN","C0CDACE",142,0)
domo3(zary,what,where,zdom,lvl) ; simplified domo
"RTN","C0CDACE",143,0)
 ; zary is the return array
"RTN","C0CDACE",144,0)
 ; what is the tag to begin with starting at where, a node in the zdom
"RTN","C0CDACE",145,0)
 ; multiple is the index to be used for a muliple entry 0 is a singleton
"RTN","C0CDACE",146,0)
 ; 
"RTN","C0CDACE",147,0)
 i '$d(zdom) s zdom=$na(^TMP("MXMLDOM",$J,$o(^TMP("MXMLDOM",$J,"AAAAA"),-1)))
"RTN","C0CDACE",148,0)
 i '$d(where) s where=1
"RTN","C0CDACE",149,0)
 i $g(what)="" s what=@zdom@(where)
"RTN","C0CDACE",150,0)
 i '$d(lvl) s lvl=0 n znum s znum=0 ; first time
"RTN","C0CDACE",151,0)
 ;
"RTN","C0CDACE",152,0)
 n txt s txt=$$CLEAN($$ALLTXT($NA(@zdom@(where))))
"RTN","C0CDACE",153,0)
 i txt'="" i txt'=" " d  ;
"RTN","C0CDACE",154,0)
 . s @zary@(@zdom@(where))=txt
"RTN","C0CDACE",155,0)
 ;
"RTN","C0CDACE",156,0)
 n zi s zi=""
"RTN","C0CDACE",157,0)
 f  s zi=$o(@zdom@(where,"A",zi)) q:zi=""  d  ;
"RTN","C0CDACE",158,0)
 . s @zary@(what_"@"_zi)=@zdom@(where,"A",zi)
"RTN","C0CDACE",159,0)
 f  s zi=$o(@zdom@(where,"C",zi)) q:zi=""  d  ;
"RTN","C0CDACE",160,0)
 . n mult s mult=$$ismult(where,zdom)
"RTN","C0CDACE",161,0)
 . ;i '$d(znum) n znum s znum(where)=0
"RTN","C0CDACE",162,0)
 . i mult>0 s znum(where)=$g(znum(where))+1
"RTN","C0CDACE",163,0)
 . i $g(C0DEBUG) i mult>0 D  ;
"RTN","C0CDACE",164,0)
 . . w !,"where ",where," what ",what," zi ",zi," lvl ",lvl,!
"RTN","C0CDACE",165,0)
 . . zwr znum
"RTN","C0CDACE",166,0)
 . i mult=0 d domo3($na(@zary@(what)),@zdom@(where,"C",zi),zi,zdom,lvl+1)
"RTN","C0CDACE",167,0)
 . i mult>0 d domo3($na(@zary@(what,znum(where))),@zdom@(where,"C",zi),zi,zdom,lvl+1)
"RTN","C0CDACE",168,0)
 q
"RTN","C0CDACE",169,0)
 ;
"RTN","C0CDACE",170,0)
ismult(zidx,zdom) ; extrinsic which returns one if the node contains multiple
"RTN","C0CDACE",171,0)
 ; children with the same tag
"RTN","C0CDACE",172,0)
 n ztags,zzi,zj,rtn s zzi="" s rtn=0
"RTN","C0CDACE",173,0)
 f  s zzi=$o(@zdom@(zidx,"C",zzi)) q:rtn=1  q:zzi=""  d  ;
"RTN","C0CDACE",174,0)
 . s zj=@zdom@(zidx,"C",zzi)
"RTN","C0CDACE",175,0)
 . i $d(ztags(zj)) s rtn=1
"RTN","C0CDACE",176,0)
 . s ztags(zj)=""
"RTN","C0CDACE",177,0)
 q rtn
"RTN","C0CDACE",178,0)
 ;
"RTN","C0CDACE",179,0)
testmult ;
"RTN","C0CDACE",180,0)
 n zdom
"RTN","C0CDACE",181,0)
 s zdom=$na(^TMP("MXMLDOM",$J,1))
"RTN","C0CDACE",182,0)
 n gi,gj s gi=""
"RTN","C0CDACE",183,0)
 f  s gi=$o(@zdom@(gi)) q:gi=""  d  ;
"RTN","C0CDACE",184,0)
 . i $$ismult(gi,zdom) zwr @zdom@(gi,*)
"RTN","C0CDACE",185,0)
 q
"RTN","C0CDACE",186,0)
 ;
"RTN","C0CDACE",187,0)
findnxt(tag,znd) ; private extrinsic which returns a node id of tag
"RTN","C0CDACE",188,0)
 i '$d(zdom) s zdom=$na(^TMP("MXMLDOM",$J,$o(^TMP("MXMLDOM",$J,"AAAAA"),-1)))
"RTN","C0CDACE",189,0)
 ;i @zdom@(znd)=tag q znd ; easy case
"RTN","C0CDACE",190,0)
 n gi,done,rslt s gi="" s done=0
"RTN","C0CDACE",191,0)
 f  s gi=$o(@zdom@(znd,"C",gi)) q:done  q:gi=""  d  ;
"RTN","C0CDACE",192,0)
 . i @zdom@(znd,"C",gi)=tag s done=1 s rslt=gi
"RTN","C0CDACE",193,0)
 q:done rslt
"RTN","C0CDACE",194,0)
 f  s gi=$o(@zdom@(znd,"C",gi)) q:done  q:gi=""  d  ;
"RTN","C0CDACE",195,0)
 . s rslt=$$findnxt(tag,gi)
"RTN","C0CDACE",196,0)
 . i rslt'="" s done=1
"RTN","C0CDACE",197,0)
 q:done rslt
"RTN","C0CDACE",198,0)
 ;i $d(@zdom@(znd,"P")) d  ;
"RTN","C0CDACE",199,0)
 ;. s rslt=$$findnxt(tag,@zdom@(znd,"P")) ; check the parent if any
"RTN","C0CDACE",200,0)
 q rslt
"RTN","C0CDACE",201,0)
 ;
"RTN","C0CDACE",202,0)
oneout(zbuf,ztxt) ; adds a line to zbuf
"RTN","C0CDACE",203,0)
 n zi s zi=$o(@zbuf@(""),-1)+1
"RTN","C0CDACE",204,0)
 s @zbuf@(zi)=ztxt
"RTN","C0CDACE",205,0)
 q
"RTN","C0CDACE",206,0)
 ;
"RTN","C0CDACE",207,0)
ALLTXT(where) ; extrinsic which returns all text lines from the node .. concatinated 
"RTN","C0CDACE",208,0)
 ; together
"RTN","C0CDACE",209,0)
 n zti s zti=""
"RTN","C0CDACE",210,0)
 n ztr s ztr=""
"RTN","C0CDACE",211,0)
 f  s zti=$o(@where@("T",zti)) q:zti=""  d  ;
"RTN","C0CDACE",212,0)
 . s ztr=ztr_$g(@where@("T",zti))
"RTN","C0CDACE",213,0)
 q ztr
"RTN","C0CDACE",214,0)
 ;
"RTN","C0CDACE",215,0)
CLEAN(STR) ; extrinsic function; returns string - gpl borrowed from the CCR package
"RTN","C0CDACE",216,0)
 ;; Removes all non printable characters from a string.
"RTN","C0CDACE",217,0)
 ;; STR by Value
"RTN","C0CDACE",218,0)
 N TR,I
"RTN","C0CDACE",219,0)
 F I=0:1:31 S TR=$G(TR)_$C(I)
"RTN","C0CDACE",220,0)
 S TR=TR_$C(127)
"RTN","C0CDACE",221,0)
 N ZR S ZR=$TR(STR,TR)
"RTN","C0CDACE",222,0)
 S ZR=$$LDBLNKS(ZR) ; get rid of leading blanks
"RTN","C0CDACE",223,0)
 QUIT ZR
"RTN","C0CDACE",224,0)
 ;
"RTN","C0CDACE",225,0)
CLEAN2(STR) ; clean a string of all non printable characters
"RTN","C0CDACE",226,0)
 N I,J,OUT
"RTN","C0CDACE",227,0)
 S OUT=STR
"RTN","C0CDACE",228,0)
 F I=1:1:$L(STR) D  ;
"RTN","C0CDACE",229,0)
 . S J=$ASCII($E(STR,I))
"RTN","C0CDACE",230,0)
 . I J>127 S $E(OUT,I)=" "
"RTN","C0CDACE",231,0)
 Q OUT
"RTN","C0CDACE",232,0)
 ;
"RTN","C0CDACE",233,0)
LDBLNKS(st) ; extrinsic which removes leading blanks from a string
"RTN","C0CDACE",234,0)
 n pos f pos=1:1:$l(st)  q:$e(st,pos)'=" "
"RTN","C0CDACE",235,0)
 q $e(st,pos,$l(st))
"RTN","C0CDACE",236,0)
 ;
"RTN","C0CDACE",237,0)
TEST ;
"RTN","C0CDACE",238,0)
 S GDOM=$NA(^KBAI("TOOBIG","DOM"))
"RTN","C0CDACE",239,0)
 K ^TMP("MXMLDOM",$J)
"RTN","C0CDACE",240,0)
 M ^TMP("MXMLDOM",$J,1)=@GDOM
"RTN","C0CDACE",241,0)
 K GARY,GIDX,GNARY
"RTN","C0CDACE",242,0)
 S C0CDADID=1
"RTN","C0CDACE",243,0)
 ;D DOMO(1,"/","GNARY","GIDX","GARY",,"/results/")
"RTN","C0CDACE",244,0)
 K G,GARY
"RTN","C0CDACE",245,0)
 ;d domo2("GARY",,"..results.")
"RTN","C0CDACE",246,0)
 d domo3("GARY")
"RTN","C0CDACE",247,0)
 Q
"RTN","C0CDACE",248,0)
 ;
"RTN","C0CDACE",249,0)
DOMO(ZOID,ZPATH,ZNARY,ZXIDX,ZXPARY,ZNUM,ZREDUX) ; RECURSIVE ROUTINE TO POPULATE
"RTN","C0CDACE",250,0)
 ; THE XPATH INDEX ZXIDX, PASSED BY NAME
"RTN","C0CDACE",251,0)
 ; THE XPATH ARRAY XPARY, PASSED BY NAME
"RTN","C0CDACE",252,0)
 ; ZOID IS THE STARTING OID
"RTN","C0CDACE",253,0)
 ; ZPATH IS THE STARTING XPATH, USUALLY "/"
"RTN","C0CDACE",254,0)
 ; ZNUM IS THE MULTIPLE NUMBER [x], USUALLY NULL WHEN ON THE TOP NODE
"RTN","C0CDACE",255,0)
 ; ZREDUX IS THE XPATH REDUCTION STRING, TAKEN OUT OF EACH XPATH IF PRESENT
"RTN","C0CDACE",256,0)
 I $G(ZREDUX)="" S ZREDUX=""
"RTN","C0CDACE",257,0)
 N NEWPATH,NARY ; NEWPATH IS AN XPATH NARY IS AN NHIN MUMPS ARRAY
"RTN","C0CDACE",258,0)
 N NEWNUM S NEWNUM=""
"RTN","C0CDACE",259,0)
 I $G(ZNUM)>0 S NEWNUM="["_ZNUM_"]"
"RTN","C0CDACE",260,0)
 S NEWPATH=ZPATH_"/"_$$TAG(ZOID)_NEWNUM ; CREATE THE XPATH FOR THIS NODE
"RTN","C0CDACE",261,0)
 I $G(ZREDUX)'="" D  ; REDUX PROVIDED?
"RTN","C0CDACE",262,0)
 . N GT S GT=$P(NEWPATH,ZREDUX,2)
"RTN","C0CDACE",263,0)
 . I GT'="" S NEWPATH=GT
"RTN","C0CDACE",264,0)
 S @ZXIDX@(NEWPATH)=ZOID ; ADD THE XPATH FOR THIS NODE TO THE XPATH INDEX
"RTN","C0CDACE",265,0)
 N GA D ATT("GA",ZOID) ; GET ATTRIBUTES FOR THIS NODE
"RTN","C0CDACE",266,0)
 I $D(GA) D  ; PROCESS THE ATTRIBUTES
"RTN","C0CDACE",267,0)
 . N ZI S ZI=""
"RTN","C0CDACE",268,0)
 . F  S ZI=$O(GA(ZI)) Q:ZI=""  D  ; FOR EACH ATTRIBUTE
"RTN","C0CDACE",269,0)
 . . N ZP S ZP=NEWPATH_"@"_ZI ; PATH FOR ATTRIBUTE
"RTN","C0CDACE",270,0)
 . . S @ZXPARY@(ZP)=GA(ZI) ; ADD THE ATTRIBUTE XPATH TO THE XP ARRAY
"RTN","C0CDACE",271,0)
 . . I GA(ZI)'="" D ADDNARY(ZP,GA(ZI)) ; ADD THE NHIN ARRAY VALUE
"RTN","C0CDACE",272,0)
 N GD D DATA("GD",ZOID) ; SEE IF THERE IS DATA FOR THIS NODE
"RTN","C0CDACE",273,0)
 I $D(GD(2)) D  ;
"RTN","C0CDACE",274,0)
 . M @ZXPARY@(NEWPATH)=GD ; IF MULITPLE DATA MERGE TO THE ARRAY
"RTN","C0CDACE",275,0)
 E  I $D(GD(1)) D  ;
"RTN","C0CDACE",276,0)
 . S @ZXPARY@(NEWPATH)=GD(1) ; IF SINGLE VALUE, ADD TO ARRAY
"RTN","C0CDACE",277,0)
 . I GD(1)'="" D ADDNARY(NEWPATH,GD(1)) ; ADD TO NHIN ARRAY
"RTN","C0CDACE",278,0)
 N ZFRST S ZFRST=$$FIRST(ZOID) ; SET FIRST CHILD
"RTN","C0CDACE",279,0)
 ;I ZFRST=0 Q  ; get out early if no children
"RTN","C0CDACE",280,0)
 W:$G(ZNUM)'="" !,"ZNUM= ",ZNUM," ",ZPATH
"RTN","C0CDACE",281,0)
 I ZFRST'=0 D  ; THERE IS A CHILD
"RTN","C0CDACE",282,0)
 . N ZNUM
"RTN","C0CDACE",283,0)
 . N ZMULT S ZMULT=$$ISMULT(ZFRST) ; IS FIRST CHILD A MULTIPLE
"RTN","C0CDACE",284,0)
 . D DOMO(ZFRST,NEWPATH,ZNARY,ZXIDX,ZXPARY,$S(ZMULT:1,1:""),ZREDUX) ; THE CHILD
"RTN","C0CDACE",285,0)
 N GNXT S GNXT=$$NXTSIB(ZOID)
"RTN","C0CDACE",286,0)
 I $$TAG(GNXT)'=$$TAG(ZOID) S ZNUM="" ; RESET COUNTING AFTER MULTIPLES
"RTN","C0CDACE",287,0)
 I GNXT'=0 D  ;
"RTN","C0CDACE",288,0)
 . N ZMULT S ZMULT=$$ISMULT(GNXT) ; IS THE SIBLING A MULTIPLE?
"RTN","C0CDACE",289,0)
 . I (ZNUM="")&(ZMULT) D  ; SIBLING IS FIRST OF MULTIPLES
"RTN","C0CDACE",290,0)
 . . N ZNUM S ZNUM=1 ;
"RTN","C0CDACE",291,0)
 . . D DOMO(GNXT,ZPATH,ZNARY,ZXIDX,ZXPARY,ZNUM,ZREDUX) ; DO NEXT SIB
"RTN","C0CDACE",292,0)
 . E  D DOMO(GNXT,ZPATH,ZNARY,ZXIDX,ZXPARY,$S(ZNUM>0:ZNUM+1,1:""),ZREDUX) ; SIB
"RTN","C0CDACE",293,0)
 Q
"RTN","C0CDACE",294,0)
 ;
"RTN","C0CDACE",295,0)
ADDNARY(ZXP,ZVALUE) ; ADD AN NHIN ARRAY VALUE TO ZNARY
"RTN","C0CDACE",296,0)
 ;
"RTN","C0CDACE",297,0)
 ; IF ZATT=1 THE ARRAY IS ADDED AS ATTRIBUTES
"RTN","C0CDACE",298,0)
 ;
"RTN","C0CDACE",299,0)
 N ZZI,ZZJ,ZZN
"RTN","C0CDACE",300,0)
 S ZZI=$P(ZXP,"/",1) ; FIRST PIECE OF XPATH ARRAY
"RTN","C0CDACE",301,0)
 I ZZI="" Q  ; DON'T ADD THIS ONE .. PROBABLY THE //results NODE
"RTN","C0CDACE",302,0)
 S ZZJ=$P(ZXP,ZZI_"/",2) ; REST OF XPATH ARRAY
"RTN","C0CDACE",303,0)
 S ZZJ=$TR(ZZJ,"/",".") ; REPLACE / WITH .
"RTN","C0CDACE",304,0)
 I ZZI'["]" D  ; A SINGLETON
"RTN","C0CDACE",305,0)
 . S ZZN=1
"RTN","C0CDACE",306,0)
 E  D  ; THERE IS AN [x] OCCURANCE
"RTN","C0CDACE",307,0)
 . S ZZN=$P($P(ZZI,"[",2),"]",1) ; PULL OUT THE OCCURANCE
"RTN","C0CDACE",308,0)
 . S ZZI=$P(ZZI,"[",1) ; TAKE OUT THE [X]
"RTN","C0CDACE",309,0)
 I ZZJ'="" D  ; TIME TO ADD THE VALUE
"RTN","C0CDACE",310,0)
 . S @ZNARY@(ZZI,ZZN,ZZJ)=ZVALUE
"RTN","C0CDACE",311,0)
 Q
"RTN","C0CDACE",312,0)
 ;
"RTN","C0CDACE",313,0)
PARSE(INXML,INDOC) ;CALL THE MXML PARSER ON INXML, PASSED BY NAME
"RTN","C0CDACE",314,0)
 ; INDOC IS PASSED AS THE DOCUMENT NAME - DON'T KNOW WHERE TO STORE THIS NOW
"RTN","C0CDACE",315,0)
 ; EXTRINSIC WHICH RETURNS THE DOCID ASSIGNED BY MXML
"RTN","C0CDACE",316,0)
 ;Q $$EN^MXMLDOM(INXML)
"RTN","C0CDACE",317,0)
 Q $$EN^MXMLDOM(INXML,"W")
"RTN","C0CDACE",318,0)
 ;
"RTN","C0CDACE",319,0)
ISMULT(ZOID) ; RETURN TRUE IF ZOID IS ONE OF A MULTIPLE
"RTN","C0CDACE",320,0)
 N ZN
"RTN","C0CDACE",321,0)
 ;I $$TAG(ZOID)["entry" B
"RTN","C0CDACE",322,0)
 S ZN=$$NXTSIB(ZOID)
"RTN","C0CDACE",323,0)
 I ZN'="" Q $$TAG(ZOID)=$$TAG(ZN) ; IF TAG IS THE SAME AS NEXT SIB TAG
"RTN","C0CDACE",324,0)
 Q 0
"RTN","C0CDACE",325,0)
 ;
"RTN","C0CDACE",326,0)
FIRST(ZOID) ;RETURNS THE OID OF THE FIRST CHILD OF ZOID
"RTN","C0CDACE",327,0)
 Q $$CHILD^MXMLDOM(C0CDADID,ZOID)
"RTN","C0CDACE",328,0)
 ;
"RTN","C0CDACE",329,0)
PARENT(ZOID) ;RETURNS THE OID OF THE PARENT OF ZOID
"RTN","C0CDACE",330,0)
 Q $$PARENT^MXMLDOM(C0CDADID,ZOID)
"RTN","C0CDACE",331,0)
 ;
"RTN","C0CDACE",332,0)
ATT(RTN,NODE) ;GET ATTRIBUTES FOR ZOID
"RTN","C0CDACE",333,0)
 S HANDLE=C0CDADID
"RTN","C0CDACE",334,0)
 K @RTN
"RTN","C0CDACE",335,0)
 D GETTXT^MXMLDOM("A")
"RTN","C0CDACE",336,0)
 Q
"RTN","C0CDACE",337,0)
 ;
"RTN","C0CDACE",338,0)
TAG(ZOID) ; RETURNS THE XML TAG FOR THE NODE
"RTN","C0CDACE",339,0)
 ;
"RTN","C0CDACE",340,0)
 N X,Y
"RTN","C0CDACE",341,0)
 S Y=""
"RTN","C0CDACE",342,0)
 S X=$G(C0CDACBK("TAG")) ;IS THERE A CALLBACK FOR THIS ROUTINE
"RTN","C0CDACE",343,0)
 I X'="" X X ; EXECUTE THE CALLBACK, SHOULD SET Y
"RTN","C0CDACE",344,0)
 I Y="" S Y=$$NAME^MXMLDOM(C0CDADID,ZOID)
"RTN","C0CDACE",345,0)
 Q Y
"RTN","C0CDACE",346,0)
 ;
"RTN","C0CDACE",347,0)
NXTSIB(ZOID) ; RETURNS THE NEXT SIBLING
"RTN","C0CDACE",348,0)
 Q $$SIBLING^MXMLDOM(C0CDADID,ZOID)
"RTN","C0CDACE",349,0)
 ;
"RTN","C0CDACE",350,0)
DATA(ZT,ZOID) ; RETURNS DATA FOR THE NODE
"RTN","C0CDACE",351,0)
 ;N ZT,ZN S ZT=""
"RTN","C0CDACE",352,0)
 ;S C0SDOM=$NA(^TMP("MXMLDOM",$J,C0CDADID))
"RTN","C0CDACE",353,0)
 ;Q $G(@C0SDOM@(ZOID,"T",1))
"RTN","C0CDACE",354,0)
 S ZN=$$TEXT^MXMLDOM(C0CDADID,ZOID,ZT)
"RTN","C0CDACE",355,0)
 Q
"RTN","C0CDACE",356,0)
 ;
"RTN","C0CDACE",357,0)
DEMUX2(OARY,IARY,DEPTH) ;CONVERT AN XPATH ARRAY PASSED AS IARY TO
"RTN","C0CDACE",358,0)
 ; FORMAT @OARY@(x,variablename) where x is the first multiple
"RTN","C0CDACE",359,0)
 ; IF DEPTH=2, THE LAST 2 PARTS OF THE XPATH WILL BE USED
"RTN","C0CDACE",360,0)
 N ZI,ZJ,ZK,ZL,ZM S ZI=""
"RTN","C0CDACE",361,0)
 F  S ZI=$O(@IARY@(ZI)) Q:ZI=""  D  ;
"RTN","C0CDACE",362,0)
 . D DEMUX^C0CMXP("ZJ",ZI)
"RTN","C0CDACE",363,0)
 . S ZK=$P(ZJ,"^",3)
"RTN","C0CDACE",364,0)
 . S ZM=$RE($P($RE(ZK),"/",1))
"RTN","C0CDACE",365,0)
 . I $G(DEPTH)=2 D  ;LAST TWO PARTS OF XPATH USED FOR THE VARIABLE NAME
"RTN","C0CDACE",366,0)
 . . S ZM=$RE($P($RE(ZK),"/",2))_"."_ZM
"RTN","C0CDACE",367,0)
 . S ZL=$P(ZJ,"^",1)
"RTN","C0CDACE",368,0)
 . I ZL="" S ZL=1
"RTN","C0CDACE",369,0)
 . I $D(@OARY@(ZL,ZM)) D  ;IT'S A DUP
"RTN","C0CDACE",370,0)
 . . S @OARY@(ZL,ZM_"[2]")=@IARY@(ZI)
"RTN","C0CDACE",371,0)
 . E  S @OARY@(ZL,ZM)=@IARY@(ZI)
"RTN","C0CDACE",372,0)
 Q
"RTN","C0CDACE",373,0)
 ;
"RTN","C0CDACF")
0^13^B42642199
"RTN","C0CDACF",1,0)
C0CDACF ; GPL - CCDA Routines ;09/17/13  17:05
"RTN","C0CDACF",2,0)
 ;;0.1;C0CDA;nopatch;noreleasedate;Build 1
"RTN","C0CDACF",3,0)
 ;
"RTN","C0CDACF",4,0)
 ; License AGPL v3.0
"RTN","C0CDACF",5,0)
 ; 
"RTN","C0CDACF",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDACF",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDACF",8,0)
 Q
"RTN","C0CDACF",9,0)
 ;
"RTN","C0CDACF",10,0)
FUNCSTAT(BLIST,DFN,CCDAWRK,CCDARPT,CCDACTRL) ;
"RTN","C0CDACF",11,0)
 ;
"RTN","C0CDACF",12,0)
 ; initial implementation is for PHQ9 tests records as a health factor
"RTN","C0CDACF",13,0)
 ;
"RTN","C0CDACF",14,0)
 N CCDAV,CCDAV1
"RTN","C0CDACF",15,0)
 S @CCDARPT@("STATUS")="EXTRACTING"
"RTN","C0CDACF",16,0)
 S @CCDARPT@("EXTRACT-BEGIN")=$$NOW^XLFDT
"RTN","C0CDACF",17,0)
 ;I $G(C0TEST) D TESTPAT(.CCDAV1) ; use a unit test patient for now
"RTN","C0CDACF",18,0)
 E  D GETPAT^C0CDACE(.CCDAV1,DFN,"healthfactors")
"RTN","C0CDACF",19,0)
 I '$D(CCDAV1) Q  ;
"RTN","C0CDACF",20,0)
 I +$G(CCDAV1("results","healthFactors@total"))=0 Q  ;
"RTN","C0CDACF",21,0)
 I CCDAV1("results","healthFactors@total")=1 D  ;
"RTN","C0CDACF",22,0)
 . M CCDAV(1)=CCDAV1("results","healthFactors")
"RTN","C0CDACF",23,0)
 E  M CCDAV=CCDAV1("results","healthFactors")
"RTN","C0CDACF",24,0)
 S @CCDARPT@("EXTRACT-ENDS")=$$NOW^XLFDT
"RTN","C0CDACF",25,0)
 ;
"RTN","C0CDACF",26,0)
 ; functional status section html
"RTN","C0CDACF",27,0)
 ;
"RTN","C0CDACF",28,0)
 N C0HTML,C0ARY
"RTN","C0CDACF",29,0)
 S C0ARY("TITLE")="Functional and Congnitive Status"
"RTN","C0CDACF",30,0)
 S C0ARY("HEADER",1)="Date"
"RTN","C0CDACF",31,0)
 S C0ARY("HEADER",2)="Description"
"RTN","C0CDACF",32,0)
 S C0ARY("HEADER",3)="Codes"
"RTN","C0CDACF",33,0)
 S C0ARY("HEADER",4)="Status"
"RTN","C0CDACF",34,0)
 S C0ARY("HEADER",5)="Results"
"RTN","C0CDACF",35,0)
 S C0ARY("HEADER",6)="Comments"
"RTN","C0CDACF",36,0)
 ;
"RTN","C0CDACF",37,0)
 D  ;
"RTN","C0CDACF",38,0)
 . N C0N S C0N=0
"RTN","C0CDACF",39,0)
 . N C0I S C0I=0
"RTN","C0CDACF",40,0)
 . F  S C0I=$O(CCDAV(C0I)) Q:+C0I=0  D  ;
"RTN","C0CDACF",41,0)
 . . I $G(CCDAV(C0I,"factor","name@value"))'["LOINC" Q  ; not LOINC code here
"RTN","C0CDACF",42,0)
 . . N LOINC S LOINC=""
"RTN","C0CDACF",43,0)
 . . I CCDAV(C0I,"factor","name@value")["44261-6" D  ; we have a PQH9 test
"RTN","C0CDACF",44,0)
 . . . S CCDAV("LOINC","44261-6",C0I)=""
"RTN","C0CDACF",45,0)
 . . . S CCDAV(C0I,"factor","code")="LOINC: 44261-6"
"RTN","C0CDACF",46,0)
 . . E  Q  ; no PHQ9 test here
"RTN","C0CDACF",47,0)
 . . N C0DATE S C0DATE=$G(CCDAV(C0I,"factor","recorded@value"))
"RTN","C0CDACF",48,0)
 . . N ZURI
"RTN","C0CDACF",49,0)
 . . I $D(CCDAV(C0I,"factor","id@value")) D  ;
"RTN","C0CDACF",50,0)
 . . . S ZURI="PHQ9-LOINC-44261-6-"_CCDAV(C0I,"factor","id@value")
"RTN","C0CDACF",51,0)
 . . . S ZURI="uri"_ZURI
"RTN","C0CDACF",52,0)
 . . S CCDAV(C0I,"factor","uri")=ZURI
"RTN","C0CDACF",53,0)
 . . Q:$$REDACT^C0CDACV(CCDAV(C0I,"factor","uri"),.PARMS)
"RTN","C0CDACF",54,0)
 . . S C0ARY(C0N,1,"uri")=$G(CCDAV(C0I,"factor","uri"))
"RTN","C0CDACF",55,0)
 . . S C0N=C0N+1
"RTN","C0CDACF",56,0)
 . . I C0DATE'="" S C0ARY(C0N,1)=$$HTMLDT^C0CDACU(C0DATE) ; test date
"RTN","C0CDACF",57,0)
 . . E  S C0ARY(C0N,1)=""
"RTN","C0CDACF",58,0)
 . . S C0ARY(C0N,1,"ID")=$G(CCDAV(C0I,"factor","uri"))
"RTN","C0CDACF",59,0)
 . . N UNAME,UCODE ; useName, useCode
"RTN","C0CDACF",60,0)
 . . S (UNAME,UCODE)=""
"RTN","C0CDACF",61,0)
 . . N PNAME,PCODE
"RTN","C0CDACF",62,0)
 . . S PNAME="PATIENT HEALTH QUESTIONNAIRE 9 ITEM TOTAL SCORE"
"RTN","C0CDACF",63,0)
 . . S PCODE=$G(CCDAV(C0I,"factor","code"))
"RTN","C0CDACF",64,0)
 . . ;N TCODE,TNAME
"RTN","C0CDACF",65,0)
 . . ;S TCODE=$G(CCDAV(C0I,"procedure","type@code"))
"RTN","C0CDACF",66,0)
 . . ;S TNAME=$G(CCDAV(C0I,"procedure","type@name"))
"RTN","C0CDACF",67,0)
 . . ;I PNAME="Unknown" S PNAME=""
"RTN","C0CDACF",68,0)
 . . ;I TNAME'="" S UNAME=TNAME S UCODE=TCODE
"RTN","C0CDACF",69,0)
 . . ;I UNAME="" S UNAME=PNAME S UCODE=PCODE
"RTN","C0CDACF",70,0)
 . . ;I UNAME="" D  ;
"RTN","C0CDACF",71,0)
 . . ;. S UNAME=$G(CCDAV(C0I,"procedure","imagingType@name")) ; procedure name
"RTN","C0CDACF",72,0)
 . . ;. S UCODE=$G(CCDAV(C0I,"procedure","imagingType@code")) ; procedure code
"RTN","C0CDACF",73,0)
 . . ;S UNAME=$$CHARCHK^MXMLBLD(UNAME)
"RTN","C0CDACF",74,0)
 . . ;S PNAME=$$CHARCHK^MXMLBLD(PNAME)
"RTN","C0CDACF",75,0)
 . . ;S CCDAV(C0I,"procedure","cptCode")=UCODE
"RTN","C0CDACF",76,0)
 . . ;S CCDAV(C0I,"procedure","cptName")=UNAME
"RTN","C0CDACF",77,0)
 . . S C0ARY(C0N,2)=PNAME
"RTN","C0CDACF",78,0)
 . . S C0ARY(C0N,3)=$G(CCDAV(C0I,"factor","code"))
"RTN","C0CDACF",79,0)
 . . S C0ARY(C0N,4)="" ; don't know status
"RTN","C0CDACF",80,0)
 . . S C0ARY(C0N,5)="" ; initialize the score
"RTN","C0CDACF",81,0)
 . . S C0ARY(C0N,6)="" ; no comments or fields
"RTN","C0CDACF",82,0)
 . . D  ; get the score
"RTN","C0CDACF",83,0)
 . . . N HFX ; health factor xtract
"RTN","C0CDACF",84,0)
 . . . N HFID ; health factor record ien
"RTN","C0CDACF",85,0)
 . . . S HFID=CCDAV(C0I,"factor","id@value")
"RTN","C0CDACF",86,0)
 . . . Q:+HFID=0
"RTN","C0CDACF",87,0)
 . . . D FMX^KBAIWEB("HFX",9000010.23,HFID) ; get the record
"RTN","C0CDACF",88,0)
 . . . S C0ARY(C0N,5)=$G(HFX("V_HEALTH_FACTORS",HFID,"COMMENTS"))
"RTN","C0CDACF",89,0)
 . . . S CCDAV(C0I,"factor","score")=$G(HFX("V_HEALTH_FACTORS",HFID,"COMMENTS"))
"RTN","C0CDACF",90,0)
 . . ;S C0ARY(C0N,2)=C0ARY(C0N,2)_" (CPT: "_+UCODE_") "_PNAME
"RTN","C0CDACF",91,0)
 . . ;S C0ARY(C0N,3)=$G(CCDAV(C0I,"procedure","location@name")) ; 
"RTN","C0CDACF",92,0)
 . . ;S C0ARY(C0N,4)=$G(CCDAV(C0I,"procedure","status@value"))
"RTN","C0CDACF",93,0)
 ;
"RTN","C0CDACF",94,0)
 I +$O(C0ARY("AAAAA"),-1)=0 Q  ; all factors have been redacted
"RTN","C0CDACF",95,0)
 ;
"RTN","C0CDACF",96,0)
 ; the funcitonal and congnitive status section component
"RTN","C0CDACF",97,0)
 ;
"RTN","C0CDACF",98,0)
 N FSECT S FSECT=$NA(@CCDAWRK@("FUNCSECT"))
"RTN","C0CDACF",99,0)
 D GET^C0CDACU(FSECT,"TFUNCSEC^C0CDACF")
"RTN","C0CDACF",100,0)
 D QUEUE^MXMLTMPL(BLIST,FSECT,1,@FSECT@(0))
"RTN","C0CDACF",101,0)
 ;
"RTN","C0CDACF",102,0)
 ; procedure html digest generation
"RTN","C0CDACF",103,0)
 ;
"RTN","C0CDACF",104,0)
 N FHTML S FHTML=$NA(@CCDAWRK@("FUNCHTML"))
"RTN","C0CDACF",105,0)
 D GENHTML^C0CDACU(FHTML,"C0ARY")
"RTN","C0CDACF",106,0)
 D QUEUE^MXMLTMPL(BLIST,FHTML,1,@FHTML@(0))
"RTN","C0CDACF",107,0)
 ;
"RTN","C0CDACF",108,0)
 ; procedure xml generation
"RTN","C0CDACF",109,0)
 ;
"RTN","C0CDACF",110,0)
 N WRK
"RTN","C0CDACF",111,0)
 N C0I S C0I=0
"RTN","C0CDACF",112,0)
 F  S C0I=$O(CCDAV(C0I)) Q:+C0I=0  D  ;
"RTN","C0CDACF",113,0)
 . N C0DATE S C0DATE=$G(CCDAV(C0I,"factor","recorded@value"))
"RTN","C0CDACF",114,0)
 . I C0DATE'="" S C0ARY("recordedDate")=$$FMDTOUTC^C0CDACU(C0DATE) ; test date
"RTN","C0CDACF",115,0)
 . E  S C0ARY("recordedDate")="UNK"
"RTN","C0CDACF",116,0)
 . I $$REDACT^C0CDACV($G(CCDAV(C0I,"factor","uri")),.PARMS) D  Q  ;
"RTN","C0CDACF",117,0)
 . S C0ARY("uri")=$G(CCDAV(C0I,"factor","uri"))
"RTN","C0CDACF",118,0)
 . S C0ARY("guid")=$$UUID^C0CDACU() ; random
"RTN","C0CDACF",119,0)
 . S C0ARY("score")=$G(CCDAV(C0I,"factor","score"))
"RTN","C0CDACF",120,0)
 . I C0ARY("score")="" Q  ; no score, no entry
"RTN","C0CDACF",121,0)
 . D SETORGV^C0CDAC2(.C0ARY)
"RTN","C0CDACF",122,0)
 . ;
"RTN","C0CDACF",123,0)
 . ; factor
"RTN","C0CDACF",124,0)
 . S WRK=$NA(@CCDAWRK@("FUNC",C0I))
"RTN","C0CDACF",125,0)
 . D GETNMAP^C0CDACU(WRK,"TPHQ9^C0CDACF","C0ARY")
"RTN","C0CDACF",126,0)
 . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDACF",127,0)
 ; 
"RTN","C0CDACF",128,0)
 ; functional status section ending
"RTN","C0CDACF",129,0)
 ;
"RTN","C0CDACF",130,0)
 N FUNCEND S FUNCEND=$NA(@CCDAWRK@("FUNCEND"))
"RTN","C0CDACF",131,0)
 D GET^C0CDACU(FUNCEND,"TFUNCEND^C0CDACF")
"RTN","C0CDACF",132,0)
 D QUEUE^MXMLTMPL(BLIST,FUNCEND,1,@FUNCEND@(0))
"RTN","C0CDACF",133,0)
 ;
"RTN","C0CDACF",134,0)
 Q
"RTN","C0CDACF",135,0)
 ;
"RTN","C0CDACF",136,0)
TFUNCSEC ;
"RTN","C0CDACF",137,0)
 ;;<component>
"RTN","C0CDACF",138,0)
 ;;<section>
"RTN","C0CDACF",139,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.14"/>
"RTN","C0CDACF",140,0)
 ;;<code code="47420-5" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Functional Status"/>
"RTN","C0CDACF",141,0)
 Q
"RTN","C0CDACF",142,0)
 ;
"RTN","C0CDACF",143,0)
TPHQ9 ;
"RTN","C0CDACF",144,0)
 ;;<entry>
"RTN","C0CDACF",145,0)
 ;;<observation classCode="OBS" moodCode="EVN" >
"RTN","C0CDACF",146,0)
 ;;<!-- Consolidation Assessment Scale Observation templateId -->
"RTN","C0CDACF",147,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.69"/>
"RTN","C0CDACF",148,0)
 ;;<!-- Risk Category Assessment -->
"RTN","C0CDACF",149,0)
 ;;<templateId root="2.16.840.1.113883.10.20.24.3.69" extension="2016-02-01"/>
"RTN","C0CDACF",150,0)
 ;;<id root="1.3.6.1.4.1.115" extension="@@guid@@"/>
"RTN","C0CDACF",151,0)
 ;;<code code="44261-6" codeSystem="2.16.840.1.113883.6.1" sdtc:valueSet="2.16.840.1.113883.3.67.1.101.11.723">
"RTN","C0CDACF",152,0)
 ;;<originalText>Risk Category Assessment: PHQ-9 Tool</originalText></code>
"RTN","C0CDACF",153,0)
 ;;<text>Risk Category Assessment: PHQ-9 Tool</text>
"RTN","C0CDACF",154,0)
 ;;<statusCode code="completed"/>
"RTN","C0CDACF",155,0)
 ;;<effectiveTime>
"RTN","C0CDACF",156,0)
 ;;<low value='@@recordedDate@@'/>
"RTN","C0CDACF",157,0)
 ;;<high value='@@recordedDate@@'/>
"RTN","C0CDACF",158,0)
 ;;</effectiveTime>
"RTN","C0CDACF",159,0)
 ;;<value xsi:type="PQ" value="@@score@@" unit="1"/>
"RTN","C0CDACF",160,0)
 ;;</observation>
"RTN","C0CDACF",161,0)
 ;;</entry>
"RTN","C0CDACF",162,0)
 Q
"RTN","C0CDACF",163,0)
 ;
"RTN","C0CDACF",164,0)
TFUNCEND ; end of section
"RTN","C0CDACF",165,0)
 ;;</section>
"RTN","C0CDACF",166,0)
 ;;</component>
"RTN","C0CDACF",167,0)
 Q
"RTN","C0CDACF",168,0)
 ;
"RTN","C0CDACI")
0^14^B991484708
"RTN","C0CDACI",1,0)
C0CDACI ; GPL - Patient Portal - CCDA Routines ;09/17/13  17:05
"RTN","C0CDACI",2,0)
 ;;0.1;JJOHPP;nopatch;noreleasedate;Build 1
"RTN","C0CDACI",3,0)
 ;
"RTN","C0CDACI",4,0)
 ; License AGPL v3.0
"RTN","C0CDACI",5,0)
 ; 
"RTN","C0CDACI",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDACI",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDACI",8,0)
 Q
"RTN","C0CDACI",9,0)
 ;
"RTN","C0CDACI",10,0)
IMMU(BLIST,DFN,CCDAWRK,CCDARPT,CCDACTRL) ;
"RTN","C0CDACI",11,0)
 ;
"RTN","C0CDACI",12,0)
 N CCDAV,CCDAV1
"RTN","C0CDACI",13,0)
 S @CCDARPT@("STATUS")="EXTRACTING"
"RTN","C0CDACI",14,0)
 S @CCDARPT@("EXTRACT-BEGIN")=$$NOW^XLFDT
"RTN","C0CDACI",15,0)
 D GETPAT^C0CDACE(.CCDAV1,DFN,"immunizations")
"RTN","C0CDACI",16,0)
 I '$D(CCDAV1) Q  ;
"RTN","C0CDACI",17,0)
 I +$G(CCDAV1("results","immunizations@total"))=0 D  Q  ;
"RTN","C0CDACI",18,0)
 . Q  ; turned off because it caused a validation error
"RTN","C0CDACI",19,0)
 . N ISECT S ISECT=$NA(@CCDAWRK@("IMMUSECT"))
"RTN","C0CDACI",20,0)
 . D GET^C0CDACU(ISECT,"TNOIMMU^C0CDACI")
"RTN","C0CDACI",21,0)
 . D QUEUE^MXMLTMPL(BLIST,ISECT,1,@ISECT@(0))
"RTN","C0CDACI",22,0)
 I CCDAV1("results","immunizations@total")=1 D  ;
"RTN","C0CDACI",23,0)
 . M CCDAV(1)=CCDAV1("results","immunizations")
"RTN","C0CDACI",24,0)
 E  M CCDAV=CCDAV1("results","immunizations")
"RTN","C0CDACI",25,0)
 S @CCDARPT@("EXTRACT-ENDS")=$$NOW^XLFDT
"RTN","C0CDACI",26,0)
 ;
"RTN","C0CDACI",27,0)
 ; immunizations section html
"RTN","C0CDACI",28,0)
 ;
"RTN","C0CDACI",29,0)
 N C0HTML,C0ARY
"RTN","C0CDACI",30,0)
 S C0ARY("TITLE")="Immunization"
"RTN","C0CDACI",31,0)
 S C0ARY("HEADER",1)="Date"
"RTN","C0CDACI",32,0)
 S C0ARY("HEADER",2)="Vaccine"
"RTN","C0CDACI",33,0)
 S C0ARY("HEADER",3)="Location"
"RTN","C0CDACI",34,0)
 ;
"RTN","C0CDACI",35,0)
 D  ;
"RTN","C0CDACI",36,0)
 . N C0N S C0N=0
"RTN","C0CDACI",37,0)
 . N C0I S C0I=0
"RTN","C0CDACI",38,0)
 . F  S C0I=$O(CCDAV(C0I)) Q:+C0I=0  D  ;
"RTN","C0CDACI",39,0)
 . . N C0DATE S C0DATE=$G(CCDAV(C0I,"immunization","administered@value"))
"RTN","C0CDACI",40,0)
 . . S CCDAV(C0I,"immunization","uri")="uri_9000010_11-"_$G(CCDAV(C0I,"immunization","id@value"))
"RTN","C0CDACI",41,0)
 . . Q:$$REDACT^C0CDACV(CCDAV(C0I,"immunization","uri"),.PARMS)
"RTN","C0CDACI",42,0)
 . . S C0ARY(C0N,1,"uri")=$G(CCDAV(C0I,"immunization","uri"))
"RTN","C0CDACI",43,0)
 . . S C0N=C0N+1
"RTN","C0CDACI",44,0)
 . . I C0DATE'="" S C0ARY(C0N,1)=$$HTMLDT^C0CDACU(C0DATE) ; immunization date
"RTN","C0CDACI",45,0)
 . . E  S C0ARY(C0N,1)=""
"RTN","C0CDACI",46,0)
 . . S C0ARY(C0N,1,"ID")=$G(CCDAV(C0I,"immunization","uri"))
"RTN","C0CDACI",47,0)
 . . N INAME S INAME=$G(CCDAV(C0I,"immunization","name@value")) ; immunization name
"RTN","C0CDACI",48,0)
 . . S C0ARY(C0N,2)=INAME
"RTN","C0CDACI",49,0)
 . . N CVX ; look up CVX code here
"RTN","C0CDACI",50,0)
 . . I '$D(^JJOHcodeMap("immunizations")) D SETMAP
"RTN","C0CDACI",51,0)
 . . S CVX=$O(^JJOHcodeMap("immunizations","B",INAME,""))
"RTN","C0CDACI",52,0)
 . . N PNAME
"RTN","C0CDACI",53,0)
 . . I CVX'="" D  ;
"RTN","C0CDACI",54,0)
 . . . S PNAME=$G(^JJOHcodeMap("immunizations",CVX,"preferredName"))
"RTN","C0CDACI",55,0)
 . . I $G(PNAME)'="" D  ;
"RTN","C0CDACI",56,0)
 . . . I CVX=999 Q  ;
"RTN","C0CDACI",57,0)
 . . . S CCDAV(C0I,"immunization","displayName")=PNAME
"RTN","C0CDACI",58,0)
 . . . S C0ARY(C0N,2)=PNAME
"RTN","C0CDACI",59,0)
 . . I CVX="" S CVX=999
"RTN","C0CDACI",60,0)
 . . S CCDAV(C0I,"immunization","CVX")=CVX
"RTN","C0CDACI",61,0)
 . . S C0ARY(C0N,2)=C0ARY(C0N,2)_" (CVX: "_+CVX_") ("_INAME_")"
"RTN","C0CDACI",62,0)
 . . S C0ARY(C0N,3)=$G(CCDAV(C0I,"immunization","facility@name")) ; 
"RTN","C0CDACI",63,0)
 ;
"RTN","C0CDACI",64,0)
 I +$O(C0ARY("AAAAA"),-1)=0 Q  ; all immunizations have been redacted
"RTN","C0CDACI",65,0)
 ;
"RTN","C0CDACI",66,0)
 ; the immunization section component
"RTN","C0CDACI",67,0)
 ;
"RTN","C0CDACI",68,0)
 N ISECT S ISECT=$NA(@CCDAWRK@("IMMUSECT"))
"RTN","C0CDACI",69,0)
 D GET^C0CDACU(ISECT,"TIMMUSEC^C0CDACI")
"RTN","C0CDACI",70,0)
 D QUEUE^MXMLTMPL(BLIST,ISECT,1,@ISECT@(0))
"RTN","C0CDACI",71,0)
 ;
"RTN","C0CDACI",72,0)
 ; immunization html digest generation
"RTN","C0CDACI",73,0)
 ;
"RTN","C0CDACI",74,0)
 N IHTML S IHTML=$NA(@CCDAWRK@("IMMUHTML"))
"RTN","C0CDACI",75,0)
 D GENHTML^C0CDACU(IHTML,"C0ARY")
"RTN","C0CDACI",76,0)
 D QUEUE^MXMLTMPL(BLIST,IHTML,1,@IHTML@(0))
"RTN","C0CDACI",77,0)
 ;
"RTN","C0CDACI",78,0)
 ; immunization xml generation
"RTN","C0CDACI",79,0)
 ;
"RTN","C0CDACI",80,0)
 N WRK
"RTN","C0CDACI",81,0)
 N C0I S C0I=0
"RTN","C0CDACI",82,0)
 F  S C0I=$O(CCDAV(C0I)) Q:+C0I=0  D  ;
"RTN","C0CDACI",83,0)
 . N C0DATE S C0DATE=$G(CCDAV(C0I,"immunization","administered@value"))
"RTN","C0CDACI",84,0)
 . I C0DATE'="" S C0ARY("immuTime")=$$FMDTOUTC^C0CDACU(C0DATE) ; immunization date
"RTN","C0CDACI",85,0)
 . E  S C0ARY("immuTime")="UNK"
"RTN","C0CDACI",86,0)
 . I $$REDACT^C0CDACV(CCDAV(C0I,"immunization","uri"),.PARMS) D  Q  ;
"RTN","C0CDACI",87,0)
 . S C0ARY("uri")=$G(CCDAV(C0I,"immunization","uri"))
"RTN","C0CDACI",88,0)
 . N PNAME S PNAME=$G(CCDAV(C0I,"immunization","displayName"))
"RTN","C0CDACI",89,0)
 . I PNAME'="" S C0ARY("CVXname")=PNAME
"RTN","C0CDACI",90,0)
 . E  S C0ARY("CVXname")=$G(CCDAV(C0I,"immunization","name@value")) ; immu name
"RTN","C0CDACI",91,0)
 . S C0ARY("CVXcode")=$G(CCDAV(C0I,"immunization","CVX")) ; immu code
"RTN","C0CDACI",92,0)
 . S C0ARY("immuLocation")=$G(CCDAV(C0I,"immunization","facility@name"))
"RTN","C0CDACI",93,0)
 . S C0ARY("immuGuid")=$$UUID^C0CDACU() ; random
"RTN","C0CDACI",94,0)
 . ;S C0ARY("orgOID")=$$ORGOID^C0CDACU() ; fetch organization OID
"RTN","C0CDACI",95,0)
 . ;
"RTN","C0CDACI",96,0)
 . ; immunizaiton
"RTN","C0CDACI",97,0)
 . S WRK=$NA(@CCDAWRK@("IMMU",C0I))
"RTN","C0CDACI",98,0)
 . D GETNMAP^C0CDACU(WRK,"TIMMU^C0CDACI","C0ARY")
"RTN","C0CDACI",99,0)
 . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDACI",100,0)
 ; 
"RTN","C0CDACI",101,0)
 ; immunization section ending
"RTN","C0CDACI",102,0)
 ;
"RTN","C0CDACI",103,0)
 N IMMUEND S IMMUEND=$NA(@CCDAWRK@("IMMUEND"))
"RTN","C0CDACI",104,0)
 D GET^C0CDACU(IMMUEND,"TIMMUEND^C0CDACI")
"RTN","C0CDACI",105,0)
 D QUEUE^MXMLTMPL(BLIST,IMMUEND,1,@IMMUEND@(0))
"RTN","C0CDACI",106,0)
 ;
"RTN","C0CDACI",107,0)
 Q
"RTN","C0CDACI",108,0)
 ;
"RTN","C0CDACI",109,0)
TIMMUSEC ; 
"RTN","C0CDACI",110,0)
 ;;<component>
"RTN","C0CDACI",111,0)
 ;;<section>
"RTN","C0CDACI",112,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.2.1"/>
"RTN","C0CDACI",113,0)
 ;;<code code="11369-6" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="History of immunizations"/>
"RTN","C0CDACI",114,0)
 Q
"RTN","C0CDACI",115,0)
 ;
"RTN","C0CDACI",116,0)
TIMMU ;
"RTN","C0CDACI",117,0)
 ;;<entry>
"RTN","C0CDACI",118,0)
 ;;<substanceAdministration moodCode="EVN" classCode="SBADM" negationInd="true">
"RTN","C0CDACI",119,0)
 ;;<!-- Immunization Activity entry template -->
"RTN","C0CDACI",120,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.52"/>
"RTN","C0CDACI",121,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.52" extension="2015-08-01"/>
"RTN","C0CDACI",122,0)
 ;;<id root="@@immuGuid@@"/>
"RTN","C0CDACI",123,0)
 ;;<statusCode code="completed"/>
"RTN","C0CDACI",124,0)
 ;;<effectiveTime value="@@immuTime@@"/>
"RTN","C0CDACI",125,0)
 ;;<consumable>
"RTN","C0CDACI",126,0)
 ;;<manufacturedProduct classCode="MANU">
"RTN","C0CDACI",127,0)
 ;;<!-- Immunization Medication Information template -->
"RTN","C0CDACI",128,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.54"/>
"RTN","C0CDACI",129,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.54" extension="2014-06-09"/>
"RTN","C0CDACI",130,0)
 ;;<manufacturedMaterial>
"RTN","C0CDACI",131,0)
 ;;<code code="@@CVXcode@@" displayName="@@CVXname@@" codeSystem="2.16.840.1.113883.12.292" codeSystemName="Vaccines administered (CVX)">
"RTN","C0CDACI",132,0)
 ;;<originalText>
"RTN","C0CDACI",133,0)
 ;;<reference value="#@@uri@@"/>
"RTN","C0CDACI",134,0)
 ;;</originalText>
"RTN","C0CDACI",135,0)
 ;;</code>
"RTN","C0CDACI",136,0)
 ;;</manufacturedMaterial>
"RTN","C0CDACI",137,0)
 ;;<manufacturerOrganization>
"RTN","C0CDACI",138,0)
 ;;<name>Influenza Vaccine Company</name>
"RTN","C0CDACI",139,0)
 ;;</manufacturerOrganization>
"RTN","C0CDACI",140,0)
 ;;</manufacturedProduct>
"RTN","C0CDACI",141,0)
 ;;</consumable>
"RTN","C0CDACI",142,0)
 ;;</substanceAdministration>
"RTN","C0CDACI",143,0)
 ;;</entry>
"RTN","C0CDACI",144,0)
 Q
"RTN","C0CDACI",145,0)
 ;
"RTN","C0CDACI",146,0)
TIMMUEND ; end of section
"RTN","C0CDACI",147,0)
 ;;</section>
"RTN","C0CDACI",148,0)
 ;;</component>
"RTN","C0CDACI",149,0)
 Q
"RTN","C0CDACI",150,0)
 ;
"RTN","C0CDACI",151,0)
SETMAP ;
"RTN","C0CDACI",152,0)
 N G S G=$NA(^JJOHcodeMap("immunizations"))
"RTN","C0CDACI",153,0)
 K @G
"RTN","C0CDACI",154,0)
 S @G@(1,"CPT")=90701
"RTN","C0CDACI",155,0)
 S @G@(1,"CVXcode")=1
"RTN","C0CDACI",156,0)
 S @G@(1,"altName",1)="DIP,PERT,TET (DPT)"
"RTN","C0CDACI",157,0)
 S @G@(1,"altName",2)="DIP.,PERT.,TET. (DPT)"
"RTN","C0CDACI",158,0)
 S @G@(1,"preferredName")="DTP"
"RTN","C0CDACI",159,0)
 S @G@(2,"CPT")=90712
"RTN","C0CDACI",160,0)
 S @G@(2,"CVXcode")=2
"RTN","C0CDACI",161,0)
 S @G@(2,"altName",1)="ORAL POLIOVIRUS"
"RTN","C0CDACI",162,0)
 S @G@(2,"preferredName")="OPV"
"RTN","C0CDACI",163,0)
 S @G@(3,"CPT")=90707
"RTN","C0CDACI",164,0)
 S @G@(3,"CVXcode")=3
"RTN","C0CDACI",165,0)
 S @G@(3,"altName",1)="MMR1"
"RTN","C0CDACI",166,0)
 S @G@(3,"altName",2)="MEASLES,MUMPS,RUBELLA (MMR)"
"RTN","C0CDACI",167,0)
 S @G@(3,"altName",3)="MEASLES,MUMPS,RUBELLA PED #1"
"RTN","C0CDACI",168,0)
 S @G@(3,"altName",4)="MEASLES,MUMPS,RUBELLA PED #2"
"RTN","C0CDACI",169,0)
 S @G@(3,"preferredName")="MMR"
"RTN","C0CDACI",170,0)
 S @G@(4,"CPT")=90708
"RTN","C0CDACI",171,0)
 S @G@(4,"CVXcode")=4
"RTN","C0CDACI",172,0)
 S @G@(4,"altName",1)="MEASLES,RUBELLA (MR)"
"RTN","C0CDACI",173,0)
 S @G@(4,"preferredName")="M/R"
"RTN","C0CDACI",174,0)
 S @G@(5,"CPT")=90705
"RTN","C0CDACI",175,0)
 S @G@(5,"CVXcode")=5
"RTN","C0CDACI",176,0)
 S @G@(5,"altName",1)="MEASLES"
"RTN","C0CDACI",177,0)
 S @G@(5,"preferredName")="measles"
"RTN","C0CDACI",178,0)
 S @G@(6,"CPT")=90706
"RTN","C0CDACI",179,0)
 S @G@(6,"CVXcode")=6
"RTN","C0CDACI",180,0)
 S @G@(6,"altName",1)="RUBELLA"
"RTN","C0CDACI",181,0)
 S @G@(6,"preferredName")="rubella"
"RTN","C0CDACI",182,0)
 S @G@(7,"CPT")=90704
"RTN","C0CDACI",183,0)
 S @G@(7,"CVXcode")=7
"RTN","C0CDACI",184,0)
 S @G@(7,"altName",1)="MUMPS"
"RTN","C0CDACI",185,0)
 S @G@(7,"preferredName")="mumps"
"RTN","C0CDACI",186,0)
 S @G@(8,"CPT")=90744
"RTN","C0CDACI",187,0)
 S @G@(8,"CVXcode")=8
"RTN","C0CDACI",188,0)
 S @G@(8,"altName",1)="HEP B PED/ADOL 3 DOSE"
"RTN","C0CDACI",189,0)
 S @G@(8,"altName",2)="HEPB PED/ADOL-2"
"RTN","C0CDACI",190,0)
 S @G@(8,"altName",3)="HEPB PED/ADOL-3"
"RTN","C0CDACI",191,0)
 S @G@(8,"altName",4)="HEPB PED/ADOL-4"
"RTN","C0CDACI",192,0)
 S @G@(8,"altName",5)="HEPB, PED/ADOL-1"
"RTN","C0CDACI",193,0)
 S @G@(8,"preferredName")="Hep B, adolescent or pediatric"
"RTN","C0CDACI",194,0)
 S @G@(9,"CPT")=90718
"RTN","C0CDACI",195,0)
 S @G@(9,"CVXcode")=9
"RTN","C0CDACI",196,0)
 ; astro gpl
"RTN","C0CDACI",197,0)
 ;S @G@(9,"altName",1)="TETANUS DIPTHERIA (TD-ADULT)"
"RTN","C0CDACI",198,0)
 ; end astro
"RTN","C0CDACI",199,0)
 S @G@(9,"preferredName")="Td (adult), adsorbed"
"RTN","C0CDACI",200,0)
 S @G@(10,"CPT")=90713
"RTN","C0CDACI",201,0)
 S @G@(10,"CVXcode")=10
"RTN","C0CDACI",202,0)
 S @G@(10,"altName",1)="IPV4"
"RTN","C0CDACI",203,0)
 S @G@(10,"altName",2)="IPV1"
"RTN","C0CDACI",204,0)
 S @G@(10,"altName",3)="IPV2"
"RTN","C0CDACI",205,0)
 S @G@(10,"altName",4)="IPV3"
"RTN","C0CDACI",206,0)
 S @G@(10,"altName",5)="POLIOVIRUS PED #1"
"RTN","C0CDACI",207,0)
 S @G@(10,"altName",6)="POLIOVIRUS PED #2"
"RTN","C0CDACI",208,0)
 S @G@(10,"altName",7)="POLIOVIRUS PED #3"
"RTN","C0CDACI",209,0)
 S @G@(10,"altName",8)="POLIOVIRUS PED #4"
"RTN","C0CDACI",210,0)
 S @G@(10,"preferredName")="IPV"
"RTN","C0CDACI",211,0)
 S @G@(12,"CPT")=90296
"RTN","C0CDACI",212,0)
 S @G@(12,"CVXcode")=12
"RTN","C0CDACI",213,0)
 S @G@(12,"preferredName")="diphtheria antitoxin"
"RTN","C0CDACI",214,0)
 S @G@(13,"CPT")=90389
"RTN","C0CDACI",215,0)
 S @G@(13,"CVXcode")=13
"RTN","C0CDACI",216,0)
 S @G@(13,"preferredName")="TIG"
"RTN","C0CDACI",217,0)
 S @G@(14,"CPT")=90741
"RTN","C0CDACI",218,0)
 S @G@(14,"CVXcode")=14
"RTN","C0CDACI",219,0)
 S @G@(14,"altName",1)="GAMMA GLOBULIN"
"RTN","C0CDACI",220,0)
 S @G@(14,"preferredName")="IG, unspecified formulation"
"RTN","C0CDACI",221,0)
 S @G@(16,"CPT")=90659
"RTN","C0CDACI",222,0)
 S @G@(16,"CVXcode")=16
"RTN","C0CDACI",223,0)
 S @G@(16,"altName",1)="FLU,WHOLE"
"RTN","C0CDACI",224,0)
 S @G@(16,"preferredName")="influenza, whole"
"RTN","C0CDACI",225,0)
 S @G@(17,"CPT")=90737
"RTN","C0CDACI",226,0)
 S @G@(17,"CVXcode")=17
"RTN","C0CDACI",227,0)
 S @G@(17,"altName",1)="INFLUENZA B"
"RTN","C0CDACI",228,0)
 S @G@(17,"preferredName")="Hib, unspecified formulation"
"RTN","C0CDACI",229,0)
 S @G@(18,"CPT")=90675
"RTN","C0CDACI",230,0)
 S @G@(18,"CVXcode")=18
"RTN","C0CDACI",231,0)
 S @G@(18,"altName",1)="RABIES,IM"
"RTN","C0CDACI",232,0)
 S @G@(18,"preferredName")="rabies, intramuscular injection"
"RTN","C0CDACI",233,0)
 S @G@(19,"CPT")=90728
"RTN","C0CDACI",234,0)
 S @G@(19,"CVXcode")=19
"RTN","C0CDACI",235,0)
 S @G@(19,"altName",1)="BCG,PERCUT"
"RTN","C0CDACI",236,0)
 S @G@(19,"preferredName")="BCG"
"RTN","C0CDACI",237,0)
 S @G@(20,"CVXcode")=20
"RTN","C0CDACI",238,0)
 S @G@(20,"altName",1)="DIP.,PERT.,TET. (DPT) PED 5"
"RTN","C0CDACI",239,0)
 S @G@(20,"altName",2)="DIP.,PERT.,TET. (DPT) PED 1"
"RTN","C0CDACI",240,0)
 S @G@(20,"altName",3)="DIP.,PERT.,TET. (DPT) PED 2"
"RTN","C0CDACI",241,0)
 S @G@(20,"altName",4)="DIP.,PERT.,TET. (DPT) PED 3"
"RTN","C0CDACI",242,0)
 S @G@(20,"altName",5)="DIP.,PERT.,TET. (DPT) PED 4"
"RTN","C0CDACI",243,0)
 S @G@(20,"preferredName")="DTaP"
"RTN","C0CDACI",244,0)
 S @G@(21,"CPT")=90716
"RTN","C0CDACI",245,0)
 S @G@(21,"CVXcode")=21
"RTN","C0CDACI",246,0)
 S @G@(21,"altName",1)="VZV2 INFANT"
"RTN","C0CDACI",247,0)
 S @G@(21,"altName",2)="CHICKENPOX"
"RTN","C0CDACI",248,0)
 S @G@(21,"altName",3)="VZV1 INFANT"
"RTN","C0CDACI",249,0)
 S @G@(21,"preferredName")="varicella"
"RTN","C0CDACI",250,0)
 S @G@(22,"CPT")=90720
"RTN","C0CDACI",251,0)
 S @G@(22,"CVXcode")=22
"RTN","C0CDACI",252,0)
 S @G@(22,"altName",1)="DTB/HIB"
"RTN","C0CDACI",253,0)
 S @G@(22,"preferredName")="DTP-Hib"
"RTN","C0CDACI",254,0)
 S @G@(23,"CPT")=90727
"RTN","C0CDACI",255,0)
 S @G@(23,"CVXcode")=23
"RTN","C0CDACI",256,0)
 S @G@(23,"altName",1)="PLAGUE"
"RTN","C0CDACI",257,0)
 S @G@(23,"preferredName")="plague"
"RTN","C0CDACI",258,0)
 S @G@(24,"CPT")=90581
"RTN","C0CDACI",259,0)
 S @G@(24,"CVXcode")=24
"RTN","C0CDACI",260,0)
 S @G@(24,"altName",1)="ANTHRAX,SC"
"RTN","C0CDACI",261,0)
 S @G@(24,"preferredName")="anthrax"
"RTN","C0CDACI",262,0)
 S @G@(25,"CPT")=90690
"RTN","C0CDACI",263,0)
 S @G@(25,"CVXcode")=25
"RTN","C0CDACI",264,0)
 S @G@(25,"altName",1)="TYPHOID,ORAL"
"RTN","C0CDACI",265,0)
 S @G@(25,"preferredName")="typhoid, oral"
"RTN","C0CDACI",266,0)
 S @G@(26,"CPT")=90725
"RTN","C0CDACI",267,0)
 S @G@(26,"CVXcode")=26
"RTN","C0CDACI",268,0)
 S @G@(26,"altName",1)="CHOLERA, ORAL"
"RTN","C0CDACI",269,0)
 S @G@(26,"altName",2)="CHOLERA"
"RTN","C0CDACI",270,0)
 S @G@(26,"preferredName")="cholera"
"RTN","C0CDACI",271,0)
 S @G@(27,"CPT")=90287
"RTN","C0CDACI",272,0)
 S @G@(27,"CVXcode")=27
"RTN","C0CDACI",273,0)
 S @G@(27,"preferredName")="botulinum antitoxin"
"RTN","C0CDACI",274,0)
 S @G@(28,"CPT")=90702
"RTN","C0CDACI",275,0)
 S @G@(28,"CVXcode")=28
"RTN","C0CDACI",276,0)
 S @G@(28,"altName",1)="DIPTHERIA-TETANUS (DT-PEDS)"
"RTN","C0CDACI",277,0)
 S @G@(28,"preferredName")="DT (pediatric)"
"RTN","C0CDACI",278,0)
 S @G@(29,"CPT")=90291
"RTN","C0CDACI",279,0)
 S @G@(29,"CVXcode")=29
"RTN","C0CDACI",280,0)
 S @G@(29,"preferredName")="CMVIG"
"RTN","C0CDACI",281,0)
 S @G@(30,"CPT")=90371
"RTN","C0CDACI",282,0)
 S @G@(30,"CVXcode")=30
"RTN","C0CDACI",283,0)
 S @G@(30,"preferredName")="HBIG"
"RTN","C0CDACI",284,0)
 S @G@(32,"CPT")=90733
"RTN","C0CDACI",285,0)
 S @G@(32,"CVXcode")=32
"RTN","C0CDACI",286,0)
 S @G@(32,"altName",1)="MENINGOCOCCAL"
"RTN","C0CDACI",287,0)
 S @G@(32,"preferredName")="meningococcal MPSV4"
"RTN","C0CDACI",288,0)
 S @G@(33,"CPT")=90732
"RTN","C0CDACI",289,0)
 S @G@(33,"CVXcode")=33
"RTN","C0CDACI",290,0)
 S @G@(33,"altName",1)="PNEUMOVAX"
"RTN","C0CDACI",291,0)
 S @G@(33,"altName",2)="PNEUMOCOCCAL"
"RTN","C0CDACI",292,0)
 S @G@(33,"preferredName")="pneumococcal polysaccharide PPV23"
"RTN","C0CDACI",293,0)
 S @G@(34,"CPT")=90376
"RTN","C0CDACI",294,0)
 S @G@(34,"CVXcode")=34
"RTN","C0CDACI",295,0)
 S @G@(34,"preferredName")="RIG"
"RTN","C0CDACI",296,0)
 S @G@(35,"CPT")=90703
"RTN","C0CDACI",297,0)
 S @G@(35,"CVXcode")=35
"RTN","C0CDACI",298,0)
 S @G@(35,"altName",1)="TETANUS TOXOID"
"RTN","C0CDACI",299,0)
 S @G@(35,"preferredName")="tetanus toxoid, adsorbed"
"RTN","C0CDACI",300,0)
 S @G@(36,"CPT")=90396
"RTN","C0CDACI",301,0)
 S @G@(36,"CVXcode")=36
"RTN","C0CDACI",302,0)
 S @G@(36,"preferredName")="VZIG"
"RTN","C0CDACI",303,0)
 S @G@(37,"CPT")=90717
"RTN","C0CDACI",304,0)
 S @G@(37,"CVXcode")=37
"RTN","C0CDACI",305,0)
 S @G@(37,"altName",1)="YELLOW FEVER"
"RTN","C0CDACI",306,0)
 S @G@(37,"preferredName")="yellow fever"
"RTN","C0CDACI",307,0)
 S @G@(38,"altName",1)="RUBELLA, MUMPS"
"RTN","C0CDACI",308,0)
 S @G@(39,"CPT")=90735
"RTN","C0CDACI",309,0)
 S @G@(39,"CVXcode")=39
"RTN","C0CDACI",310,0)
 S @G@(39,"altName",1)="ENCEPHALITIS"
"RTN","C0CDACI",311,0)
 S @G@(39,"preferredName")="Japanese encephalitis SC"
"RTN","C0CDACI",312,0)
 S @G@(40,"CPT")=90676
"RTN","C0CDACI",313,0)
 S @G@(40,"CVXcode")=40
"RTN","C0CDACI",314,0)
 S @G@(40,"altName",1)="RABIES,ID"
"RTN","C0CDACI",315,0)
 S @G@(40,"preferredName")="rabies, intradermal injection"
"RTN","C0CDACI",316,0)
 S @G@(41,"CPT")=90692
"RTN","C0CDACI",317,0)
 S @G@(41,"CVXcode")=41
"RTN","C0CDACI",318,0)
 S @G@(41,"altName",1)="TYPHOID,H-P,SC/ID"
"RTN","C0CDACI",319,0)
 S @G@(41,"preferredName")="typhoid, parenteral"
"RTN","C0CDACI",320,0)
 S @G@(42,"CPT")=90745
"RTN","C0CDACI",321,0)
 S @G@(42,"CVXcode")=42
"RTN","C0CDACI",322,0)
 S @G@(42,"altName",1)="HEP B4 INFANT"
"RTN","C0CDACI",323,0)
 S @G@(42,"altName",2)="HEP B1 INFANT"
"RTN","C0CDACI",324,0)
 S @G@(42,"altName",3)="HEP B2 INFANT"
"RTN","C0CDACI",325,0)
 S @G@(42,"altName",4)="HEP B3 INFANT"
"RTN","C0CDACI",326,0)
 S @G@(42,"preferredName")="Hep B, adolescent/high risk infant"
"RTN","C0CDACI",327,0)
 S @G@(43,"CPT")=90746
"RTN","C0CDACI",328,0)
 S @G@(43,"CVXcode")=43
"RTN","C0CDACI",329,0)
 S @G@(43,"altName",1)="SWINE FLU BIVAL"
"RTN","C0CDACI",330,0)
 S @G@(43,"preferredName")="Hep B, adult"
"RTN","C0CDACI",331,0)
 S @G@(44,"CPT")=90747
"RTN","C0CDACI",332,0)
 S @G@(44,"CVXcode")=44
"RTN","C0CDACI",333,0)
 S @G@(44,"altName",1)="HEPB, ILL PAT"
"RTN","C0CDACI",334,0)
 S @G@(44,"preferredName")="Hep B, dialysis"
"RTN","C0CDACI",335,0)
 S @G@(45,"CPT")=90731
"RTN","C0CDACI",336,0)
 S @G@(45,"CVXcode")=45
"RTN","C0CDACI",337,0)
 S @G@(45,"altName",1)="HEPATITIS B"
"RTN","C0CDACI",338,0)
 S @G@(45,"preferredName")="Hep B, unspecified formulation"
"RTN","C0CDACI",339,0)
 S @G@(46,"CPT")=90646
"RTN","C0CDACI",340,0)
 S @G@(46,"CVXcode")=46
"RTN","C0CDACI",341,0)
 S @G@(46,"altName",1)="HIB,PRP-D"
"RTN","C0CDACI",342,0)
 S @G@(46,"preferredName")="Hib (PRP-D)"
"RTN","C0CDACI",343,0)
 S @G@(47,"CPT")=90645
"RTN","C0CDACI",344,0)
 S @G@(47,"CVXcode")=47
"RTN","C0CDACI",345,0)
 S @G@(47,"altName",1)="HIB PED 4"
"RTN","C0CDACI",346,0)
 S @G@(47,"altName",2)="HIB PED 1"
"RTN","C0CDACI",347,0)
 S @G@(47,"altName",3)="HIB PED 2"
"RTN","C0CDACI",348,0)
 S @G@(47,"altName",4)="HIB PED 3"
"RTN","C0CDACI",349,0)
 S @G@(47,"altName",5)="HIB,HBOC"
"RTN","C0CDACI",350,0)
 S @G@(47,"preferredName")="Hib (HbOC)"
"RTN","C0CDACI",351,0)
 S @G@(48,"CPT")=90648
"RTN","C0CDACI",352,0)
 S @G@(48,"CVXcode")=48
"RTN","C0CDACI",353,0)
 S @G@(48,"altName",1)="HIB,PRP-T"
"RTN","C0CDACI",354,0)
 S @G@(48,"preferredName")="Hib (PRP-T)"
"RTN","C0CDACI",355,0)
 S @G@(49,"CPT")=90647
"RTN","C0CDACI",356,0)
 S @G@(49,"CVXcode")=49
"RTN","C0CDACI",357,0)
 S @G@(49,"altName",1)="HiB3"
"RTN","C0CDACI",358,0)
 S @G@(49,"altName",2)="HIB,PRP-OMP"
"RTN","C0CDACI",359,0)
 S @G@(49,"altName",3)="HiB1"
"RTN","C0CDACI",360,0)
 S @G@(49,"altName",4)="HiB2"
"RTN","C0CDACI",361,0)
 S @G@(49,"preferredName")="Hib (PRP-OMP)"
"RTN","C0CDACI",362,0)
 S @G@(50,"CPT")=90721
"RTN","C0CDACI",363,0)
 S @G@(50,"CVXcode")=50
"RTN","C0CDACI",364,0)
 S @G@(50,"preferredName")="DTaP-Hib"
"RTN","C0CDACI",365,0)
 S @G@(51,"CPT")=90748
"RTN","C0CDACI",366,0)
 S @G@(51,"CVXcode")=51
"RTN","C0CDACI",367,0)
 S @G@(51,"altName",1)="HEPB/HIB"
"RTN","C0CDACI",368,0)
 S @G@(51,"preferredName")="Hib-Hep B"
"RTN","C0CDACI",369,0)
 S @G@(52,"CPT")=90632
"RTN","C0CDACI",370,0)
 S @G@(52,"CVXcode")=52
"RTN","C0CDACI",371,0)
 S @G@(52,"altName",1)="HEPA ADULT"
"RTN","C0CDACI",372,0)
 S @G@(52,"preferredName")="Hep A, adult"
"RTN","C0CDACI",373,0)
 S @G@(53,"CPT")=90693
"RTN","C0CDACI",374,0)
 S @G@(53,"CVXcode")=53
"RTN","C0CDACI",375,0)
 S @G@(53,"altName",1)="TYPHOID,AKD,SC"
"RTN","C0CDACI",376,0)
 S @G@(53,"preferredName")="typhoid, parenteral, AKD (U.S. military)"
"RTN","C0CDACI",377,0)
 S @G@(54,"CPT")=90476
"RTN","C0CDACI",378,0)
 S @G@(54,"CVXcode")=54
"RTN","C0CDACI",379,0)
 S @G@(54,"altName",1)="ADENOVIRUS,TYPE 4"
"RTN","C0CDACI",380,0)
 S @G@(54,"preferredName")="adenovirus, type 4"
"RTN","C0CDACI",381,0)
 S @G@(55,"CPT")=90477
"RTN","C0CDACI",382,0)
 S @G@(55,"CVXcode")=55
"RTN","C0CDACI",383,0)
 S @G@(55,"altName",1)="ADENOVIRUS,TYPE 7"
"RTN","C0CDACI",384,0)
 S @G@(55,"preferredName")="adenovirus, type 7"
"RTN","C0CDACI",385,0)
 S @G@(62,"CPT")=90649
"RTN","C0CDACI",386,0)
 S @G@(62,"CVXcode")=62
"RTN","C0CDACI",387,0)
 S @G@(62,"preferredName")="HPV, quadrivalent"
"RTN","C0CDACI",388,0)
 S @G@(66,"CPT")=90665
"RTN","C0CDACI",389,0)
 S @G@(66,"CVXcode")=66
"RTN","C0CDACI",390,0)
 S @G@(66,"altName",1)="LYME DISEASE"
"RTN","C0CDACI",391,0)
 S @G@(66,"preferredName")="Lyme disease"
"RTN","C0CDACI",392,0)
 S @G@(71,"CPT")=90379
"RTN","C0CDACI",393,0)
 S @G@(71,"CVXcode")=71
"RTN","C0CDACI",394,0)
 S @G@(71,"preferredName")="RSV-IGIV"
"RTN","C0CDACI",395,0)
 S @G@(75,"altName",1)="SMALLPOX"
"RTN","C0CDACI",396,0)
 S @G@(79,"CPT")=90393
"RTN","C0CDACI",397,0)
 S @G@(79,"CVXcode")=79
"RTN","C0CDACI",398,0)
 S @G@(79,"preferredName")="vaccinia immune globulin"
"RTN","C0CDACI",399,0)
 S @G@(83,"CPT")=90633
"RTN","C0CDACI",400,0)
 S @G@(83,"CVXcode")=83
"RTN","C0CDACI",401,0)
 S @G@(83,"altName",1)="HEP A2 PEDS"
"RTN","C0CDACI",402,0)
 S @G@(83,"altName",2)="HEP A1 PEDS"
"RTN","C0CDACI",403,0)
 S @G@(83,"altName",3)="HEPA,PED/ADOL-2"
"RTN","C0CDACI",404,0)
 S @G@(83,"preferredName")="Hep A, ped/adol, 2 dose"
"RTN","C0CDACI",405,0)
 S @G@(84,"CPT")=90634
"RTN","C0CDACI",406,0)
 S @G@(84,"CVXcode")=84
"RTN","C0CDACI",407,0)
 S @G@(84,"altName",1)="HEP A3 PEDS"
"RTN","C0CDACI",408,0)
 S @G@(84,"altName",2)="HEPA,PED/ADOL-3 DOSE"
"RTN","C0CDACI",409,0)
 S @G@(84,"preferredName")="Hep A, ped/adol, 3 dose"
"RTN","C0CDACI",410,0)
 S @G@(85,"CPT")=90730
"RTN","C0CDACI",411,0)
 S @G@(85,"CVXcode")=85
"RTN","C0CDACI",412,0)
 S @G@(85,"altName",1)="HEPATITIS A"
"RTN","C0CDACI",413,0)
 S @G@(85,"preferredName")="Hep A, unspecified formulation"
"RTN","C0CDACI",414,0)
 S @G@(86,"CPT")=90281
"RTN","C0CDACI",415,0)
 S @G@(86,"CVXcode")=86
"RTN","C0CDACI",416,0)
 S @G@(86,"preferredName")="IG"
"RTN","C0CDACI",417,0)
 S @G@(87,"CPT")=90283
"RTN","C0CDACI",418,0)
 S @G@(87,"CVXcode")=87
"RTN","C0CDACI",419,0)
 S @G@(87,"preferredName")="IGIV"
"RTN","C0CDACI",420,0)
 S @G@(88,"CPT")=90724
"RTN","C0CDACI",421,0)
 S @G@(88,"CVXcode")=88
"RTN","C0CDACI",422,0)
 S @G@(88,"altName",1)="INFLUENZA"
"RTN","C0CDACI",423,0)
 S @G@(88,"preferredName")="influenza, unspecified formulation"
"RTN","C0CDACI",424,0)
 S @G@(90,"CPT")=90726
"RTN","C0CDACI",425,0)
 S @G@(90,"CVXcode")=90
"RTN","C0CDACI",426,0)
 S @G@(90,"altName",1)="RABIES"
"RTN","C0CDACI",427,0)
 S @G@(90,"preferredName")="rabies, unspecified formulation"
"RTN","C0CDACI",428,0)
 S @G@(91,"CPT")=90714
"RTN","C0CDACI",429,0)
 S @G@(91,"CVXcode")=91
"RTN","C0CDACI",430,0)
 S @G@(91,"altName",1)="TYPHOID"
"RTN","C0CDACI",431,0)
 S @G@(91,"preferredName")="typhoid, unspecified formulation"
"RTN","C0CDACI",432,0)
 S @G@(93,"CPT")=90378
"RTN","C0CDACI",433,0)
 S @G@(93,"CVXcode")=93
"RTN","C0CDACI",434,0)
 S @G@(93,"preferredName")="RSV-MAb"
"RTN","C0CDACI",435,0)
 S @G@(94,"CPT")=90710
"RTN","C0CDACI",436,0)
 S @G@(94,"CVXcode")=94
"RTN","C0CDACI",437,0)
 S @G@(94,"altName",1)="MEA-MUMPS-RUB-VARCELLA"
"RTN","C0CDACI",438,0)
 S @G@(94,"preferredName")="MMRV"
"RTN","C0CDACI",439,0)
 S @G@(100,"CPT")=90669
"RTN","C0CDACI",440,0)
 S @G@(100,"CVXcode")=100
"RTN","C0CDACI",441,0)
 S @G@(100,"altName",1)="PNEUMOCOCCAL PED 4"
"RTN","C0CDACI",442,0)
 S @G@(100,"altName",2)="PNEUMOCOCCAL PED 1"
"RTN","C0CDACI",443,0)
 S @G@(100,"altName",3)="PNEUMOCOCCAL PED 2"
"RTN","C0CDACI",444,0)
 S @G@(100,"altName",4)="PNEUMOCOCCAL PED 3"
"RTN","C0CDACI",445,0)
 S @G@(100,"altName",5)="PNEUMOCOCCAL,PED"
"RTN","C0CDACI",446,0)
 S @G@(100,"preferredName")="pneumococcal conjugate PCV 7"
"RTN","C0CDACI",447,0)
 S @G@(101,"CPT")=90691
"RTN","C0CDACI",448,0)
 S @G@(101,"CVXcode")=101
"RTN","C0CDACI",449,0)
 S @G@(101,"altName",1)="TYPHOID"
"RTN","C0CDACI",450,0)
 S @G@(101,"preferredName")="typhoid, ViCPs"
"RTN","C0CDACI",451,0)
 S @G@(104,"CPT")=90636
"RTN","C0CDACI",452,0)
 S @G@(104,"CVXcode")=104
"RTN","C0CDACI",453,0)
 S @G@(104,"altName",1)="HEPA/HEPB ADULT"
"RTN","C0CDACI",454,0)
 S @G@(104,"preferredName")="Hep A-Hep B"
"RTN","C0CDACI",455,0)
 S @G@(106,"CPT")=90700
"RTN","C0CDACI",456,0)
 S @G@(106,"CVXcode")=106
"RTN","C0CDACI",457,0)
 S @G@(106,"altName",1)="DTaP5"
"RTN","C0CDACI",458,0)
 S @G@(106,"altName",2)="DIP,PERT,TET (DPT) PED 1"
"RTN","C0CDACI",459,0)
 S @G@(106,"altName",3)="DIP,PERT,TET (DPT) PED 2"
"RTN","C0CDACI",460,0)
 S @G@(106,"altName",4)="DIP,PERT,TET (DPT) PED 3"
"RTN","C0CDACI",461,0)
 S @G@(106,"altName",5)="DIP,PERT,TET (DPT) PED 4"
"RTN","C0CDACI",462,0)
 S @G@(106,"altName",6)="DIP,PERT,TET (DPT) PED 5"
"RTN","C0CDACI",463,0)
 S @G@(106,"altName",7)="DIP-TET-a/PERT"
"RTN","C0CDACI",464,0)
 S @G@(106,"altName",8)="DTaP1"
"RTN","C0CDACI",465,0)
 S @G@(106,"altName",9)="DTaP2"
"RTN","C0CDACI",466,0)
 S @G@(106,"altName",10)="DTaP3"
"RTN","C0CDACI",467,0)
 S @G@(106,"altName",11)="DTaP4"
"RTN","C0CDACI",468,0)
 ; astro gpl
"RTN","C0CDACI",469,0)
 S @G@(106,"altName",12)="TETANUS DIPTHERIA (TD-ADULT)"
"RTN","C0CDACI",470,0)
 ; end astro
"RTN","C0CDACI",471,0)
 S @G@(106,"preferredName")="DTaP, 5 pertussis antigens"
"RTN","C0CDACI",472,0)
 S @G@(110,"CPT")=90723
"RTN","C0CDACI",473,0)
 S @G@(110,"CVXcode")=110
"RTN","C0CDACI",474,0)
 S @G@(110,"preferredName")="DTaP-Hep B-IPV"
"RTN","C0CDACI",475,0)
 S @G@(111,"CPT")=90660
"RTN","C0CDACI",476,0)
 S @G@(111,"CVXcode")=111
"RTN","C0CDACI",477,0)
 S @G@(111,"altName",1)="FLU,NASAL"
"RTN","C0CDACI",478,0)
 S @G@(111,"preferredName")="influenza, live, intranasal"
"RTN","C0CDACI",479,0)
 S @G@(113,"CVXcode")=113
"RTN","C0CDACI",480,0)
 S @G@(113,"preferredName")="Td (adult) preservative free"
"RTN","C0CDACI",481,0)
 S @G@(114,"CPT")=90734
"RTN","C0CDACI",482,0)
 S @G@(114,"CVXcode")=114
"RTN","C0CDACI",483,0)
 S @G@(114,"preferredName")="meningococcal MCV4P"
"RTN","C0CDACI",484,0)
 S @G@(115,"CPT")=90715
"RTN","C0CDACI",485,0)
 S @G@(115,"CVXcode")=115
"RTN","C0CDACI",486,0)
 S @G@(115,"altName",1)="TETANUS, DIPTHERIA AND PERTUSSIS"
"RTN","C0CDACI",487,0)
 S @G@(115,"preferredName")="Tdap"
"RTN","C0CDACI",488,0)
 S @G@(116,"CPT")=90680
"RTN","C0CDACI",489,0)
 S @G@(116,"CVXcode")=116
"RTN","C0CDACI",490,0)
 S @G@(116,"altName",1)="RV 4 PEDS"
"RTN","C0CDACI",491,0)
 S @G@(116,"altName",2)="ROTOVIRUS,ORAL"
"RTN","C0CDACI",492,0)
 S @G@(116,"altName",3)="RV 1 PEDS"
"RTN","C0CDACI",493,0)
 S @G@(116,"altName",4)="RV 2 PEDS"
"RTN","C0CDACI",494,0)
 S @G@(116,"altName",5)="RV 3 PEDS"
"RTN","C0CDACI",495,0)
 S @G@(116,"preferredName")="rotavirus, pentavalent"
"RTN","C0CDACI",496,0)
 S @G@(118,"CPT")=90650
"RTN","C0CDACI",497,0)
 S @G@(118,"CVXcode")=118
"RTN","C0CDACI",498,0)
 S @G@(118,"preferredName")="HPV, bivalent"
"RTN","C0CDACI",499,0)
 S @G@(119,"CPT")=90681
"RTN","C0CDACI",500,0)
 S @G@(119,"CVXcode")=119
"RTN","C0CDACI",501,0)
 S @G@(119,"preferredName")="rotavirus, monovalent"
"RTN","C0CDACI",502,0)
 S @G@(120,"CPT")=90698
"RTN","C0CDACI",503,0)
 S @G@(120,"CVXcode")=120
"RTN","C0CDACI",504,0)
 S @G@(120,"preferredName")="DTaP-Hib-IPV"
"RTN","C0CDACI",505,0)
 S @G@(121,"CPT")=90736
"RTN","C0CDACI",506,0)
 S @G@(121,"CVXcode")=121
"RTN","C0CDACI",507,0)
 S @G@(121,"preferredName")="zoster"
"RTN","C0CDACI",508,0)
 S @G@(125,"CPT")=90664
"RTN","C0CDACI",509,0)
 S @G@(125,"CVXcode")=125
"RTN","C0CDACI",510,0)
 S @G@(125,"preferredName")="Novel Influenza-H1N1-09, nasal"
"RTN","C0CDACI",511,0)
 S @G@(126,"CPT")=90666
"RTN","C0CDACI",512,0)
 S @G@(126,"CVXcode")=126
"RTN","C0CDACI",513,0)
 S @G@(126,"preferredName")="Novel influenza-H1N1-09, preservative-free"
"RTN","C0CDACI",514,0)
 S @G@(127,"CPT")=90668
"RTN","C0CDACI",515,0)
 S @G@(127,"CVXcode")=127
"RTN","C0CDACI",516,0)
 S @G@(127,"preferredName")="Novel influenza-H1N1-09"
"RTN","C0CDACI",517,0)
 S @G@(128,"CPT")=90663
"RTN","C0CDACI",518,0)
 S @G@(128,"CVXcode")=128
"RTN","C0CDACI",519,0)
 S @G@(128,"preferredName")="Novel Influenza-H1N1-09, all formulations"
"RTN","C0CDACI",520,0)
 S @G@(130,"CPT")=90696
"RTN","C0CDACI",521,0)
 S @G@(130,"CVXcode")=130
"RTN","C0CDACI",522,0)
 S @G@(130,"preferredName")="DTaP-IPV"
"RTN","C0CDACI",523,0)
 S @G@(131,"altName",1)="TYPHUS"
"RTN","C0CDACI",524,0)
 S @G@(133,"CPT")=90670
"RTN","C0CDACI",525,0)
 S @G@(133,"CVXcode")=133
"RTN","C0CDACI",526,0)
 S @G@(133,"altName",1)="PCV5 PEDS"
"RTN","C0CDACI",527,0)
 S @G@(133,"altName",2)="PCV1 PEDS"
"RTN","C0CDACI",528,0)
 S @G@(133,"altName",3)="PCV2 PEDS"
"RTN","C0CDACI",529,0)
 S @G@(133,"altName",4)="PCV3 PEDS"
"RTN","C0CDACI",530,0)
 S @G@(133,"altName",5)="PCV4 PEDS"
"RTN","C0CDACI",531,0)
 S @G@(133,"preferredName")="Pneumococcal conjugate PCV 13"
"RTN","C0CDACI",532,0)
 S @G@(134,"CPT")=90738
"RTN","C0CDACI",533,0)
 S @G@(134,"CVXcode")=134
"RTN","C0CDACI",534,0)
 S @G@(134,"preferredName")="Japanese Encephalitis IM"
"RTN","C0CDACI",535,0)
 S @G@(135,"CPT")=90662
"RTN","C0CDACI",536,0)
 S @G@(135,"CVXcode")=135
"RTN","C0CDACI",537,0)
 S @G@(135,"preferredName")="Influenza, high dose seasonal"
"RTN","C0CDACI",538,0)
 S @G@(136,"CVXcode")=136
"RTN","C0CDACI",539,0)
 S @G@(136,"preferredName")="Meningococcal MCV4O"
"RTN","C0CDACI",540,0)
 S @G@(140,"CPT")=90656
"RTN","C0CDACI",541,0)
 S @G@(140,"CVXcode")=140
"RTN","C0CDACI",542,0)
 S @G@(140,"preferredName")="Influenza, seasonal, injectable, preservative free"
"RTN","C0CDACI",543,0)
 S @G@(141,"CPT")=90658
"RTN","C0CDACI",544,0)
 S @G@(141,"CVXcode")=141
"RTN","C0CDACI",545,0)
 S @G@(141,"altName",1)="FLU,3 YRS"
"RTN","C0CDACI",546,0)
 S @G@(141,"preferredName")="Influenza, seasonal, injectable"
"RTN","C0CDACI",547,0)
 S @G@(144,"CPT")=90654
"RTN","C0CDACI",548,0)
 S @G@(144,"CVXcode")=144
"RTN","C0CDACI",549,0)
 S @G@(144,"preferredName")="influenza, seasonal, intradermal, preservative free"
"RTN","C0CDACI",550,0)
 S @G@(148,"CPT")=90644
"RTN","C0CDACI",551,0)
 S @G@(148,"CVXcode")=148
"RTN","C0CDACI",552,0)
 S @G@(148,"preferredName")="Meningococcal C/Y-HIB PRP"
"RTN","C0CDACI",553,0)
 S @G@(149,"CPT")=90672
"RTN","C0CDACI",554,0)
 S @G@(149,"CVXcode")=149
"RTN","C0CDACI",555,0)
 S @G@(149,"preferredName")="influenza, live, intranasal, quadrivalent"
"RTN","C0CDACI",556,0)
 S @G@(150,"CPT")=90686
"RTN","C0CDACI",557,0)
 S @G@(150,"CVXcode")=150
"RTN","C0CDACI",558,0)
 S @G@(150,"preferredName")="influenza, injectable, quadrivalent, preservative free"
"RTN","C0CDACI",559,0)
 S @G@(153,"CPT")=90661
"RTN","C0CDACI",560,0)
 S @G@(153,"CVXcode")=153
"RTN","C0CDACI",561,0)
 S @G@(153,"preferredName")="Influenza, injectable, MDCK, preservative free"
"RTN","C0CDACI",562,0)
 S @G@(155,"CPT")=90673
"RTN","C0CDACI",563,0)
 S @G@(155,"CVXcode")=155
"RTN","C0CDACI",564,0)
 S @G@(155,"preferredName")="influenza, recombinant, injectable, preservative free"
"RTN","C0CDACI",565,0)
 S @G@(158,"CPT")=90688
"RTN","C0CDACI",566,0)
 S @G@(158,"CVXcode")=158
"RTN","C0CDACI",567,0)
 S @G@(158,"preferredName")="influenza, injectable, quadrivalent"
"RTN","C0CDACI",568,0)
 ; astro gpl
"RTN","C0CDACI",569,0)
 S @G@(166,"preferredName")="influenza, intradermal, quadrivalent, preservative free"
"RTN","C0CDACI",570,0)
 S @G@(166,"altName",1)="INFLUENZA-H1N1-09, NOVEL (PANDEMIC)"
"RTN","C0CDACI",571,0)
 S @G@(166,"CVXcode")=166
"RTN","C0CDACI",572,0)
 ; end astro
"RTN","C0CDACI",573,0)
 S @G@(999,"CPT")=90749
"RTN","C0CDACI",574,0)
 S @G@(999,"CVXcode")=999
"RTN","C0CDACI",575,0)
 S @G@(999,"preferredName")="unknown"
"RTN","C0CDACI",576,0)
 S @G@("B","ADENOVIRUS,TYPE 4",54)=""
"RTN","C0CDACI",577,0)
 S @G@("B","ADENOVIRUS,TYPE 7",55)=""
"RTN","C0CDACI",578,0)
 S @G@("B","ANTHRAX,SC",24)=""
"RTN","C0CDACI",579,0)
 S @G@("B","BCG",19)=""
"RTN","C0CDACI",580,0)
 S @G@("B","BCG,PERCUT",19)=""
"RTN","C0CDACI",581,0)
 S @G@("B","CHICKENPOX",21)=""
"RTN","C0CDACI",582,0)
 S @G@("B","CHOLERA",26)=""
"RTN","C0CDACI",583,0)
 S @G@("B","CHOLERA, ORAL",26)=""
"RTN","C0CDACI",584,0)
 S @G@("B","CMVIG",29)=""
"RTN","C0CDACI",585,0)
 S @G@("B","DIP,PERT,TET (DPT)",1)=""
"RTN","C0CDACI",586,0)
 S @G@("B","DIP,PERT,TET (DPT) PED 1",106)=""
"RTN","C0CDACI",587,0)
 S @G@("B","DIP,PERT,TET (DPT) PED 2",106)=""
"RTN","C0CDACI",588,0)
 S @G@("B","DIP,PERT,TET (DPT) PED 3",106)=""
"RTN","C0CDACI",589,0)
 S @G@("B","DIP,PERT,TET (DPT) PED 4",106)=""
"RTN","C0CDACI",590,0)
 S @G@("B","DIP,PERT,TET (DPT) PED 5",106)=""
"RTN","C0CDACI",591,0)
 S @G@("B","DIP-TET-a/PERT",106)=""
"RTN","C0CDACI",592,0)
 S @G@("B","DIP.,PERT.,TET. (DPT)",1)=""
"RTN","C0CDACI",593,0)
 S @G@("B","DIP.,PERT.,TET. (DPT) PED 1",20)=""
"RTN","C0CDACI",594,0)
 S @G@("B","DIP.,PERT.,TET. (DPT) PED 2",20)=""
"RTN","C0CDACI",595,0)
 S @G@("B","DIP.,PERT.,TET. (DPT) PED 3",20)=""
"RTN","C0CDACI",596,0)
 S @G@("B","DIP.,PERT.,TET. (DPT) PED 4",20)=""
"RTN","C0CDACI",597,0)
 S @G@("B","DIP.,PERT.,TET. (DPT) PED 5",20)=""
"RTN","C0CDACI",598,0)
 S @G@("B","DIPTHERIA-TETANUS (DT-PEDS)",28)=""
"RTN","C0CDACI",599,0)
 S @G@("B","DT (pediatric)",28)=""
"RTN","C0CDACI",600,0)
 S @G@("B","DTB/HIB",22)=""
"RTN","C0CDACI",601,0)
 S @G@("B","DTP",1)=""
"RTN","C0CDACI",602,0)
 S @G@("B","DTP-Hib",22)=""
"RTN","C0CDACI",603,0)
 S @G@("B","DTaP",20)=""
"RTN","C0CDACI",604,0)
 S @G@("B","DTaP, 5 pertussis antigens",106)=""
"RTN","C0CDACI",605,0)
 S @G@("B","DTaP-Hep B-IPV",110)=""
"RTN","C0CDACI",606,0)
 S @G@("B","DTaP-Hib",50)=""
"RTN","C0CDACI",607,0)
 S @G@("B","DTaP-Hib-IPV",120)=""
"RTN","C0CDACI",608,0)
 S @G@("B","DTaP-IPV",130)=""
"RTN","C0CDACI",609,0)
 S @G@("B","DTaP1",106)=""
"RTN","C0CDACI",610,0)
 S @G@("B","DTaP2",106)=""
"RTN","C0CDACI",611,0)
 S @G@("B","DTaP3",106)=""
"RTN","C0CDACI",612,0)
 S @G@("B","DTaP4",106)=""
"RTN","C0CDACI",613,0)
 S @G@("B","DTaP5",106)=""
"RTN","C0CDACI",614,0)
 S @G@("B","ENCEPHALITIS",39)=""
"RTN","C0CDACI",615,0)
 S @G@("B","FLU,3 YRS",141)=""
"RTN","C0CDACI",616,0)
 S @G@("B","FLU,NASAL",111)=""
"RTN","C0CDACI",617,0)
 S @G@("B","FLU,WHOLE",16)=""
"RTN","C0CDACI",618,0)
 S @G@("B","GAMMA GLOBULIN",14)=""
"RTN","C0CDACI",619,0)
 S @G@("B","HBIG",30)=""
"RTN","C0CDACI",620,0)
 S @G@("B","HEP A1 PEDS",83)=""
"RTN","C0CDACI",621,0)
 S @G@("B","HEP A2 PEDS",83)=""
"RTN","C0CDACI",622,0)
 S @G@("B","HEP A3 PEDS",84)=""
"RTN","C0CDACI",623,0)
 S @G@("B","HEP B PED/ADOL 3 DOSE",8)=""
"RTN","C0CDACI",624,0)
 S @G@("B","HEP B1 INFANT",42)=""
"RTN","C0CDACI",625,0)
 S @G@("B","HEP B2 INFANT",42)=""
"RTN","C0CDACI",626,0)
 S @G@("B","HEP B3 INFANT",42)=""
"RTN","C0CDACI",627,0)
 S @G@("B","HEP B4 INFANT",42)=""
"RTN","C0CDACI",628,0)
 S @G@("B","HEPA ADULT",52)=""
"RTN","C0CDACI",629,0)
 S @G@("B","HEPA,PED/ADOL-2",83)=""
"RTN","C0CDACI",630,0)
 S @G@("B","HEPA,PED/ADOL-3 DOSE",84)=""
"RTN","C0CDACI",631,0)
 S @G@("B","HEPA/HEPB ADULT",104)=""
"RTN","C0CDACI",632,0)
 S @G@("B","HEPATITIS A",85)=""
"RTN","C0CDACI",633,0)
 S @G@("B","HEPATITIS B",45)=""
"RTN","C0CDACI",634,0)
 S @G@("B","HEPB PED/ADOL-2",8)=""
"RTN","C0CDACI",635,0)
 S @G@("B","HEPB PED/ADOL-3",8)=""
"RTN","C0CDACI",636,0)
 S @G@("B","HEPB PED/ADOL-4",8)=""
"RTN","C0CDACI",637,0)
 S @G@("B","HEPB, ILL PAT",44)=""
"RTN","C0CDACI",638,0)
 S @G@("B","HEPB, PED/ADOL-1",8)=""
"RTN","C0CDACI",639,0)
 S @G@("B","HEPB/HIB",51)=""
"RTN","C0CDACI",640,0)
 S @G@("B","HIB PED 1",47)=""
"RTN","C0CDACI",641,0)
 S @G@("B","HIB PED 2",47)=""
"RTN","C0CDACI",642,0)
 S @G@("B","HIB PED 3",47)=""
"RTN","C0CDACI",643,0)
 S @G@("B","HIB PED 4",47)=""
"RTN","C0CDACI",644,0)
 S @G@("B","HIB,HBOC",47)=""
"RTN","C0CDACI",645,0)
 S @G@("B","HIB,PRP-D",46)=""
"RTN","C0CDACI",646,0)
 S @G@("B","HIB,PRP-OMP",49)=""
"RTN","C0CDACI",647,0)
 S @G@("B","HIB,PRP-T",48)=""
"RTN","C0CDACI",648,0)
 S @G@("B","HPV, bivalent",118)=""
"RTN","C0CDACI",649,0)
 S @G@("B","HPV, quadrivalent",62)=""
"RTN","C0CDACI",650,0)
 S @G@("B","Hep A, adult",52)=""
"RTN","C0CDACI",651,0)
 S @G@("B","Hep A, ped/adol, 2 dose",83)=""
"RTN","C0CDACI",652,0)
 S @G@("B","Hep A, ped/adol, 3 dose",84)=""
"RTN","C0CDACI",653,0)
 S @G@("B","Hep A, unspecified formulation",85)=""
"RTN","C0CDACI",654,0)
 S @G@("B","Hep A-Hep B",104)=""
"RTN","C0CDACI",655,0)
 S @G@("B","Hep B, adolescent or pediatric",8)=""
"RTN","C0CDACI",656,0)
 S @G@("B","Hep B, adolescent/high risk infant",42)=""
"RTN","C0CDACI",657,0)
 S @G@("B","Hep B, adult",43)=""
"RTN","C0CDACI",658,0)
 S @G@("B","Hep B, dialysis",44)=""
"RTN","C0CDACI",659,0)
 S @G@("B","Hep B, unspecified formulation",45)=""
"RTN","C0CDACI",660,0)
 S @G@("B","HiB1",49)=""
"RTN","C0CDACI",661,0)
 S @G@("B","HiB2",49)=""
"RTN","C0CDACI",662,0)
 S @G@("B","HiB3",49)=""
"RTN","C0CDACI",663,0)
 S @G@("B","Hib (HbOC)",47)=""
"RTN","C0CDACI",664,0)
 S @G@("B","Hib (PRP-D)",46)=""
"RTN","C0CDACI",665,0)
 S @G@("B","Hib (PRP-OMP)",49)=""
"RTN","C0CDACI",666,0)
 S @G@("B","Hib (PRP-T)",48)=""
"RTN","C0CDACI",667,0)
 S @G@("B","Hib, unspecified formulation",17)=""
"RTN","C0CDACI",668,0)
 S @G@("B","Hib-Hep B",51)=""
"RTN","C0CDACI",669,0)
 S @G@("B","IG",86)=""
"RTN","C0CDACI",670,0)
 S @G@("B","IG, unspecified formulation",14)=""
"RTN","C0CDACI",671,0)
 S @G@("B","IGIV",87)=""
"RTN","C0CDACI",672,0)
 S @G@("B","INFLUENZA",88)=""
"RTN","C0CDACI",673,0)
 S @G@("B","INFLUENZA B",17)=""
"RTN","C0CDACI",674,0)
 ; astro gpl
"RTN","C0CDACI",675,0)
 S @G@("B","INFLUENZA-H1N1-09, NOVEL (PANDEMIC)",166)=""
"RTN","C0CDACI",676,0)
 ; end gpl 
"RTN","C0CDACI",677,0)
 S @G@("B","IPV",10)=""
"RTN","C0CDACI",678,0)
 S @G@("B","IPV1",10)=""
"RTN","C0CDACI",679,0)
 S @G@("B","IPV2",10)=""
"RTN","C0CDACI",680,0)
 S @G@("B","IPV3",10)=""
"RTN","C0CDACI",681,0)
 S @G@("B","IPV4",10)=""
"RTN","C0CDACI",682,0)
 S @G@("B","Influenza, high dose seasonal",135)=""
"RTN","C0CDACI",683,0)
 S @G@("B","Influenza, injectable, MDCK, preservative free",153)=""
"RTN","C0CDACI",684,0)
 S @G@("B","Influenza, seasonal, injectable",141)=""
"RTN","C0CDACI",685,0)
 S @G@("B","Influenza, seasonal, injectable, preservative free",140)=""
"RTN","C0CDACI",686,0)
 S @G@("B","Japanese Encephalitis IM",134)=""
"RTN","C0CDACI",687,0)
 S @G@("B","Japanese encephalitis SC",39)=""
"RTN","C0CDACI",688,0)
 S @G@("B","LYME DISEASE",66)=""
"RTN","C0CDACI",689,0)
 S @G@("B","Lyme disease",66)=""
"RTN","C0CDACI",690,0)
 S @G@("B","M/R",4)=""
"RTN","C0CDACI",691,0)
 S @G@("B","MEA-MUMPS-RUB-VARCELLA",94)=""
"RTN","C0CDACI",692,0)
 S @G@("B","MEASLES",5)=""
"RTN","C0CDACI",693,0)
 S @G@("B","MEASLES,MUMPS,RUBELLA (MMR)",3)=""
"RTN","C0CDACI",694,0)
 S @G@("B","MEASLES,MUMPS,RUBELLA PED #1",3)=""
"RTN","C0CDACI",695,0)
 S @G@("B","MEASLES,MUMPS,RUBELLA PED #2",3)=""
"RTN","C0CDACI",696,0)
 S @G@("B","MEASLES,RUBELLA (MR)",4)=""
"RTN","C0CDACI",697,0)
 S @G@("B","MENINGOCOCCAL",32)=""
"RTN","C0CDACI",698,0)
 S @G@("B","MMR",3)=""
"RTN","C0CDACI",699,0)
 S @G@("B","MMR1",3)=""
"RTN","C0CDACI",700,0)
 S @G@("B","MMRV",94)=""
"RTN","C0CDACI",701,0)
 S @G@("B","MUMPS",7)=""
"RTN","C0CDACI",702,0)
 S @G@("B","Meningococcal C/Y-HIB PRP",148)=""
"RTN","C0CDACI",703,0)
 S @G@("B","Meningococcal MCV4O",136)=""
"RTN","C0CDACI",704,0)
 S @G@("B","Novel Influenza-H1N1-09, all formulations",128)=""
"RTN","C0CDACI",705,0)
 S @G@("B","Novel Influenza-H1N1-09, nasal",125)=""
"RTN","C0CDACI",706,0)
 S @G@("B","Novel influenza-H1N1-09",127)=""
"RTN","C0CDACI",707,0)
 S @G@("B","Novel influenza-H1N1-09, preservative-free",126)=""
"RTN","C0CDACI",708,0)
 S @G@("B","OPV",2)=""
"RTN","C0CDACI",709,0)
 S @G@("B","ORAL POLIOVIRUS",2)=""
"RTN","C0CDACI",710,0)
 S @G@("B","PCV1 PEDS",133)=""
"RTN","C0CDACI",711,0)
 S @G@("B","PCV2 PEDS",133)=""
"RTN","C0CDACI",712,0)
 S @G@("B","PCV3 PEDS",133)=""
"RTN","C0CDACI",713,0)
 S @G@("B","PCV4 PEDS",133)=""
"RTN","C0CDACI",714,0)
 S @G@("B","PCV5 PEDS",133)=""
"RTN","C0CDACI",715,0)
 S @G@("B","PLAGUE",23)=""
"RTN","C0CDACI",716,0)
 S @G@("B","PNEUMOCOCCAL",33)=""
"RTN","C0CDACI",717,0)
 S @G@("B","PNEUMOCOCCAL PED 1",100)=""
"RTN","C0CDACI",718,0)
 S @G@("B","PNEUMOCOCCAL PED 2",100)=""
"RTN","C0CDACI",719,0)
 S @G@("B","PNEUMOCOCCAL PED 3",100)=""
"RTN","C0CDACI",720,0)
 S @G@("B","PNEUMOCOCCAL PED 4",100)=""
"RTN","C0CDACI",721,0)
 S @G@("B","PNEUMOCOCCAL,PED",100)=""
"RTN","C0CDACI",722,0)
 S @G@("B","PNEUMOVAX",33)=""
"RTN","C0CDACI",723,0)
 S @G@("B","POLIOVIRUS PED #1",10)=""
"RTN","C0CDACI",724,0)
 S @G@("B","POLIOVIRUS PED #2",10)=""
"RTN","C0CDACI",725,0)
 S @G@("B","POLIOVIRUS PED #3",10)=""
"RTN","C0CDACI",726,0)
 S @G@("B","POLIOVIRUS PED #4",10)=""
"RTN","C0CDACI",727,0)
 S @G@("B","Pneumococcal conjugate PCV 13",133)=""
"RTN","C0CDACI",728,0)
 S @G@("B","RABIES",90)=""
"RTN","C0CDACI",729,0)
 S @G@("B","RABIES,ID",40)=""
"RTN","C0CDACI",730,0)
 S @G@("B","RABIES,IM",18)=""
"RTN","C0CDACI",731,0)
 S @G@("B","RIG",34)=""
"RTN","C0CDACI",732,0)
 S @G@("B","ROTOVIRUS,ORAL",116)=""
"RTN","C0CDACI",733,0)
 S @G@("B","RSV-IGIV",71)=""
"RTN","C0CDACI",734,0)
 S @G@("B","RSV-MAb",93)=""
"RTN","C0CDACI",735,0)
 S @G@("B","RUBELLA",6)=""
"RTN","C0CDACI",736,0)
 S @G@("B","RUBELLA, MUMPS",38)=""
"RTN","C0CDACI",737,0)
 S @G@("B","RV 1 PEDS",116)=""
"RTN","C0CDACI",738,0)
 S @G@("B","RV 2 PEDS",116)=""
"RTN","C0CDACI",739,0)
 S @G@("B","RV 3 PEDS",116)=""
"RTN","C0CDACI",740,0)
 S @G@("B","RV 4 PEDS",116)=""
"RTN","C0CDACI",741,0)
 S @G@("B","SMALLPOX",75)=""
"RTN","C0CDACI",742,0)
 S @G@("B","SWINE FLU BIVAL",43)=""
"RTN","C0CDACI",743,0)
 ; astro gpl
"RTN","C0CDACI",744,0)
 ;S @G@("B","TETANUS DIPTHERIA (TD-ADULT)",9)=""
"RTN","C0CDACI",745,0)
 S @G@("B","TETANUS DIPTHERIA (TD-ADULT)",106)=""
"RTN","C0CDACI",746,0)
 ; end astro
"RTN","C0CDACI",747,0)
 S @G@("B","TETANUS TOXOID",35)=""
"RTN","C0CDACI",748,0)
 S @G@("B","TETANUS, DIPTHERIA AND PERTUSSIS",115)=""
"RTN","C0CDACI",749,0)
 S @G@("B","TIG",13)=""
"RTN","C0CDACI",750,0)
 S @G@("B","TYPHOID",91)=""
"RTN","C0CDACI",751,0)
 S @G@("B","TYPHOID",101)=""
"RTN","C0CDACI",752,0)
 S @G@("B","TYPHOID,AKD,SC",53)=""
"RTN","C0CDACI",753,0)
 S @G@("B","TYPHOID,H-P,SC/ID",41)=""
"RTN","C0CDACI",754,0)
 S @G@("B","TYPHOID,ORAL",25)=""
"RTN","C0CDACI",755,0)
 S @G@("B","TYPHUS",131)=""
"RTN","C0CDACI",756,0)
 S @G@("B","Td (adult) preservative free",113)=""
"RTN","C0CDACI",757,0)
 S @G@("B","Td (adult), adsorbed",9)=""
"RTN","C0CDACI",758,0)
 S @G@("B","Tdap",115)=""
"RTN","C0CDACI",759,0)
 S @G@("B","VZIG",36)=""
"RTN","C0CDACI",760,0)
 S @G@("B","VZV1 INFANT",21)=""
"RTN","C0CDACI",761,0)
 S @G@("B","VZV2 INFANT",21)=""
"RTN","C0CDACI",762,0)
 S @G@("B","YELLOW FEVER",37)=""
"RTN","C0CDACI",763,0)
 S @G@("B","adenovirus, type 4",54)=""
"RTN","C0CDACI",764,0)
 S @G@("B","adenovirus, type 7",55)=""
"RTN","C0CDACI",765,0)
 S @G@("B","anthrax",24)=""
"RTN","C0CDACI",766,0)
 S @G@("B","botulinum antitoxin",27)=""
"RTN","C0CDACI",767,0)
 S @G@("B","cholera",26)=""
"RTN","C0CDACI",768,0)
 S @G@("B","diphtheria antitoxin",12)=""
"RTN","C0CDACI",769,0)
 S @G@("B","influenza, injectable, quadrivalent",158)=""
"RTN","C0CDACI",770,0)
 S @G@("B","influenza, injectable, quadrivalent, preservative free",150)=""
"RTN","C0CDACI",771,0)
 S @G@("B","influenza, live, intranasal",111)=""
"RTN","C0CDACI",772,0)
 S @G@("B","influenza, live, intranasal, quadrivalent",149)=""
"RTN","C0CDACI",773,0)
 S @G@("B","influenza, recombinant, injectable, preservative free",155)=""
"RTN","C0CDACI",774,0)
 S @G@("B","influenza, seasonal, intradermal, preservative free",144)=""
"RTN","C0CDACI",775,0)
 S @G@("B","influenza, unspecified formulation",88)=""
"RTN","C0CDACI",776,0)
 S @G@("B","influenza, whole",16)=""
"RTN","C0CDACI",777,0)
 S @G@("B","measles",5)=""
"RTN","C0CDACI",778,0)
 S @G@("B","meningococcal MCV4P",114)=""
"RTN","C0CDACI",779,0)
 S @G@("B","meningococcal MPSV4",32)=""
"RTN","C0CDACI",780,0)
 S @G@("B","mumps",7)=""
"RTN","C0CDACI",781,0)
 S @G@("B","plague",23)=""
"RTN","C0CDACI",782,0)
 S @G@("B","pneumococcal conjugate PCV 7",100)=""
"RTN","C0CDACI",783,0)
 S @G@("B","pneumococcal polysaccharide PPV23",33)=""
"RTN","C0CDACI",784,0)
 S @G@("B","rabies, intradermal injection",40)=""
"RTN","C0CDACI",785,0)
 S @G@("B","rabies, intramuscular injection",18)=""
"RTN","C0CDACI",786,0)
 S @G@("B","rabies, unspecified formulation",90)=""
"RTN","C0CDACI",787,0)
 S @G@("B","rotavirus, monovalent",119)=""
"RTN","C0CDACI",788,0)
 S @G@("B","rotavirus, pentavalent",116)=""
"RTN","C0CDACI",789,0)
 S @G@("B","rubella",6)=""
"RTN","C0CDACI",790,0)
 S @G@("B","tetanus toxoid, adsorbed",35)=""
"RTN","C0CDACI",791,0)
 S @G@("B","typhoid, ViCPs",101)=""
"RTN","C0CDACI",792,0)
 S @G@("B","typhoid, oral",25)=""
"RTN","C0CDACI",793,0)
 S @G@("B","typhoid, parenteral",41)=""
"RTN","C0CDACI",794,0)
 S @G@("B","typhoid, parenteral, AKD (U.S. military)",53)=""
"RTN","C0CDACI",795,0)
 S @G@("B","typhoid, unspecified formulation",91)=""
"RTN","C0CDACI",796,0)
 S @G@("B","unknown",999)=""
"RTN","C0CDACI",797,0)
 S @G@("B","vaccinia immune globulin",79)=""
"RTN","C0CDACI",798,0)
 S @G@("B","varicella",21)=""
"RTN","C0CDACI",799,0)
 S @G@("B","yellow fever",37)=""
"RTN","C0CDACI",800,0)
 S @G@("B","zoster",121)=""
"RTN","C0CDACI",801,0)
 S @G@("CPT",90281,86)=""
"RTN","C0CDACI",802,0)
 S @G@("CPT",90283,87)=""
"RTN","C0CDACI",803,0)
 S @G@("CPT",90287,27)=""
"RTN","C0CDACI",804,0)
 S @G@("CPT",90291,29)=""
"RTN","C0CDACI",805,0)
 S @G@("CPT",90296,12)=""
"RTN","C0CDACI",806,0)
 S @G@("CPT",90371,30)=""
"RTN","C0CDACI",807,0)
 S @G@("CPT",90375,34)=""
"RTN","C0CDACI",808,0)
 S @G@("CPT",90376,34)=""
"RTN","C0CDACI",809,0)
 S @G@("CPT",90378,93)=""
"RTN","C0CDACI",810,0)
 S @G@("CPT",90379,71)=""
"RTN","C0CDACI",811,0)
 S @G@("CPT",90389,13)=""
"RTN","C0CDACI",812,0)
 S @G@("CPT",90393,79)=""
"RTN","C0CDACI",813,0)
 S @G@("CPT",90396,36)=""
"RTN","C0CDACI",814,0)
 S @G@("CPT",90470,128)=""
"RTN","C0CDACI",815,0)
 S @G@("CPT",90476,54)=""
"RTN","C0CDACI",816,0)
 S @G@("CPT",90477,55)=""
"RTN","C0CDACI",817,0)
 S @G@("CPT",90581,24)=""
"RTN","C0CDACI",818,0)
 S @G@("CPT",90585,19)=""
"RTN","C0CDACI",819,0)
 S @G@("CPT",90632,52)=""
"RTN","C0CDACI",820,0)
 S @G@("CPT",90633,83)=""
"RTN","C0CDACI",821,0)
 S @G@("CPT",90634,84)=""
"RTN","C0CDACI",822,0)
 S @G@("CPT",90636,104)=""
"RTN","C0CDACI",823,0)
 S @G@("CPT",90644,148)=""
"RTN","C0CDACI",824,0)
 S @G@("CPT",90645,47)=""
"RTN","C0CDACI",825,0)
 S @G@("CPT",90646,46)=""
"RTN","C0CDACI",826,0)
 S @G@("CPT",90647,49)=""
"RTN","C0CDACI",827,0)
 S @G@("CPT",90648,48)=""
"RTN","C0CDACI",828,0)
 S @G@("CPT",90649,62)=""
"RTN","C0CDACI",829,0)
 S @G@("CPT",90650,118)=""
"RTN","C0CDACI",830,0)
 S @G@("CPT",90654,144)=""
"RTN","C0CDACI",831,0)
 S @G@("CPT",90655,140)=""
"RTN","C0CDACI",832,0)
 S @G@("CPT",90656,140)=""
"RTN","C0CDACI",833,0)
 S @G@("CPT",90657,141)=""
"RTN","C0CDACI",834,0)
 S @G@("CPT",90658,141)=""
"RTN","C0CDACI",835,0)
 S @G@("CPT",90659,16)=""
"RTN","C0CDACI",836,0)
 S @G@("CPT",90660,111)=""
"RTN","C0CDACI",837,0)
 S @G@("CPT",90661,153)=""
"RTN","C0CDACI",838,0)
 S @G@("CPT",90662,135)=""
"RTN","C0CDACI",839,0)
 S @G@("CPT",90663,128)=""
"RTN","C0CDACI",840,0)
 S @G@("CPT",90664,125)=""
"RTN","C0CDACI",841,0)
 S @G@("CPT",90665,66)=""
"RTN","C0CDACI",842,0)
 S @G@("CPT",90666,126)=""
"RTN","C0CDACI",843,0)
 S @G@("CPT",90668,127)=""
"RTN","C0CDACI",844,0)
 S @G@("CPT",90669,100)=""
"RTN","C0CDACI",845,0)
 S @G@("CPT",90670,133)=""
"RTN","C0CDACI",846,0)
 S @G@("CPT",90672,149)=""
"RTN","C0CDACI",847,0)
 S @G@("CPT",90673,155)=""
"RTN","C0CDACI",848,0)
 S @G@("CPT",90675,18)=""
"RTN","C0CDACI",849,0)
 S @G@("CPT",90676,40)=""
"RTN","C0CDACI",850,0)
 S @G@("CPT",90680,116)=""
"RTN","C0CDACI",851,0)
 S @G@("CPT",90681,119)=""
"RTN","C0CDACI",852,0)
 S @G@("CPT",90685,150)=""
"RTN","C0CDACI",853,0)
 S @G@("CPT",90686,150)=""
"RTN","C0CDACI",854,0)
 S @G@("CPT",90688,158)=""
"RTN","C0CDACI",855,0)
 S @G@("CPT",90690,25)=""
"RTN","C0CDACI",856,0)
 S @G@("CPT",90691,101)=""
"RTN","C0CDACI",857,0)
 S @G@("CPT",90692,41)=""
"RTN","C0CDACI",858,0)
 S @G@("CPT",90693,53)=""
"RTN","C0CDACI",859,0)
 S @G@("CPT",90696,130)=""
"RTN","C0CDACI",860,0)
 S @G@("CPT",90698,120)=""
"RTN","C0CDACI",861,0)
 S @G@("CPT",90700,106)=""
"RTN","C0CDACI",862,0)
 S @G@("CPT",90701,1)=""
"RTN","C0CDACI",863,0)
 S @G@("CPT",90702,28)=""
"RTN","C0CDACI",864,0)
 S @G@("CPT",90703,35)=""
"RTN","C0CDACI",865,0)
 S @G@("CPT",90704,7)=""
"RTN","C0CDACI",866,0)
 S @G@("CPT",90705,5)=""
"RTN","C0CDACI",867,0)
 S @G@("CPT",90706,6)=""
"RTN","C0CDACI",868,0)
 S @G@("CPT",90707,3)=""
"RTN","C0CDACI",869,0)
 S @G@("CPT",90708,4)=""
"RTN","C0CDACI",870,0)
 S @G@("CPT",90710,94)=""
"RTN","C0CDACI",871,0)
 S @G@("CPT",90712,2)=""
"RTN","C0CDACI",872,0)
 S @G@("CPT",90713,10)=""
"RTN","C0CDACI",873,0)
 S @G@("CPT",90714,91)=""
"RTN","C0CDACI",874,0)
 S @G@("CPT",90715,115)=""
"RTN","C0CDACI",875,0)
 S @G@("CPT",90716,21)=""
"RTN","C0CDACI",876,0)
 S @G@("CPT",90717,37)=""
"RTN","C0CDACI",877,0)
 S @G@("CPT",90718,9)=""
"RTN","C0CDACI",878,0)
 S @G@("CPT",90720,22)=""
"RTN","C0CDACI",879,0)
 S @G@("CPT",90721,50)=""
"RTN","C0CDACI",880,0)
 S @G@("CPT",90723,110)=""
"RTN","C0CDACI",881,0)
 S @G@("CPT",90724,88)=""
"RTN","C0CDACI",882,0)
 S @G@("CPT",90725,26)=""
"RTN","C0CDACI",883,0)
 S @G@("CPT",90726,90)=""
"RTN","C0CDACI",884,0)
 S @G@("CPT",90727,23)=""
"RTN","C0CDACI",885,0)
 S @G@("CPT",90728,19)=""
"RTN","C0CDACI",886,0)
 S @G@("CPT",90730,85)=""
"RTN","C0CDACI",887,0)
 S @G@("CPT",90731,45)=""
"RTN","C0CDACI",888,0)
 S @G@("CPT",90732,33)=""
"RTN","C0CDACI",889,0)
 S @G@("CPT",90733,32)=""
"RTN","C0CDACI",890,0)
 S @G@("CPT",90734,114)=""
"RTN","C0CDACI",891,0)
 S @G@("CPT",90735,39)=""
"RTN","C0CDACI",892,0)
 S @G@("CPT",90736,121)=""
"RTN","C0CDACI",893,0)
 S @G@("CPT",90737,17)=""
"RTN","C0CDACI",894,0)
 S @G@("CPT",90738,134)=""
"RTN","C0CDACI",895,0)
 S @G@("CPT",90740,44)=""
"RTN","C0CDACI",896,0)
 S @G@("CPT",90741,14)=""
"RTN","C0CDACI",897,0)
 S @G@("CPT",90743,43)=""
"RTN","C0CDACI",898,0)
 S @G@("CPT",90744,8)=""
"RTN","C0CDACI",899,0)
 S @G@("CPT",90745,42)=""
"RTN","C0CDACI",900,0)
 S @G@("CPT",90746,43)=""
"RTN","C0CDACI",901,0)
 S @G@("CPT",90747,44)=""
"RTN","C0CDACI",902,0)
 S @G@("CPT",90748,51)=""
"RTN","C0CDACI",903,0)
 S @G@("CPT",90749,999)=""
"RTN","C0CDACI",904,0)
 Q
"RTN","C0CDACI",905,0)
 ;
"RTN","C0CDACI",906,0)
TNOIMMU ; 
"RTN","C0CDACI",907,0)
 ;;<component>
"RTN","C0CDACI",908,0)
 ;;<section>
"RTN","C0CDACI",909,0)
 ;; <templateId root="2.16.840.1.113883.10.20.22.2.2.1"/>
"RTN","C0CDACI",910,0)
 ;; <code code="11369-6" codeSystem="2.16.840.1.113883.6.1" displayName="History of immunizations" codeSystemName="LOINC"/>
"RTN","C0CDACI",911,0)
 ;; <title>Immunizations</title>
"RTN","C0CDACI",912,0)
 ;; <!--**** Immunzations Section Narrative Block ****-->
"RTN","C0CDACI",913,0)
 ;; <text>
"RTN","C0CDACI",914,0)
 ;;  <paragraph>
"RTN","C0CDACI",915,0)
 ;;   <content ID="ZImmunizations.Immunizations.ORD-PHL02-NO-DATA">No immunizations administered or ordered.</content>
"RTN","C0CDACI",916,0)
 ;;  </paragraph>
"RTN","C0CDACI",917,0)
 ;; </text>
"RTN","C0CDACI",918,0)
 ;; <entry typeCode="DRIV">
"RTN","C0CDACI",919,0)
 ;;  <!--**** Immunzations Section Narrative Block ****-->
"RTN","C0CDACI",920,0)
 ;;   <substanceAdministration classCode="SBADM" moodCode="INT" negationInd="false">   
"RTN","C0CDACI",921,0)
 ;;   <templateId root="2.16.840.1.113883.10.20.22.4.52"/>
"RTN","C0CDACI",922,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.52" extension="2015-08-01"/>
"RTN","C0CDACI",923,0)
 ;;   <id nullFlavor="NI"/>
"RTN","C0CDACI",924,0)
 ;;   <statusCode code="completed"/>
"RTN","C0CDACI",925,0)
 ;;   <effectiveTime nullFlavor="NI"/>
"RTN","C0CDACI",926,0)
 ;;   <consumable>
"RTN","C0CDACI",927,0)
 ;;    <manufacturedProduct classCode="MANU">
"RTN","C0CDACI",928,0)
 ;;     <templateId root="2.16.840.1.113883.10.20.22.4.54"/>
"RTN","C0CDACI",929,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.54" extension="2014-06-09"/>
"RTN","C0CDACI",930,0)
 ;;     <manufacturedMaterial>
"RTN","C0CDACI",931,0)
 ;;       <code code="998" displayName="No Immunization administered" codeSystem="2.16.840.1.113883.12.292" codeSystemName="CVX"/>    
"RTN","C0CDACI",932,0)
 ;;     </manufacturedMaterial>
"RTN","C0CDACI",933,0)
 ;;     </manufacturedProduct>
"RTN","C0CDACI",934,0)
 ;;   </consumable>
"RTN","C0CDACI",935,0)
 ;;  </substanceAdministration>
"RTN","C0CDACI",936,0)
 ;; </entry>
"RTN","C0CDACI",937,0)
 ;;</section>
"RTN","C0CDACI",938,0)
 ;;</component>
"RTN","C0CDACI",939,0)
 Q
"RTN","C0CDACI",940,0)
 ;
"RTN","C0CDACM")
0^15^B91630586
"RTN","C0CDACM",1,0)
C0CDACM ; GPL - Patient Portal - CCDA Mapping Routines ;11/22/13  17:05
"RTN","C0CDACM",2,0)
 ;;0.1;JJOHPP;nopatch;noreleasedate;Build 1
"RTN","C0CDACM",3,0)
 ;
"RTN","C0CDACM",4,0)
 ; License AGPL v3.0
"RTN","C0CDACM",5,0)
 ; 
"RTN","C0CDACM",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDACM",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDACM",8,0)
 Q
"RTN","C0CDACM",9,0)
 ;
"RTN","C0CDACM",10,0)
MAPG() ; 
"RTN","C0CDACM",11,0)
 Q "^C0CDAcodeMap" ; mapping global
"RTN","C0CDACM",12,0)
 ;
"RTN","C0CDACM",13,0)
GETMAP(RTN,MAP,VALUE,DEFAULT) ; extrinsic returns array of mapped values
"RTN","C0CDACM",14,0)
 ; RTN is passed by reference MAP and VALUE are passed by value
"RTN","C0CDACM",15,0)
 ; if DEFAULT is 1, a default value will be returned on VALUE not found
"RTN","C0CDACM",16,0)
 ; calling with no MAP and no VALUE will return a list of maps
"RTN","C0CDACM",17,0)
 ; calling with MAP but no VALUE will return the entire map .
"RTN","C0CDACM",18,0)
 I '$D(@$$MAPG) D INIT
"RTN","C0CDACM",19,0)
 I $G(MAP)="" D  Q 1 ; return a list of all maps
"RTN","C0CDACM",20,0)
 . N ZI S ZI=""
"RTN","C0CDACM",21,0)
 . N GM S GM=$$MAPG
"RTN","C0CDACM",22,0)
 . F  S ZI=$O(@GM@(ZI)) Q:ZI=""  D  ;
"RTN","C0CDACM",23,0)
 . . S RTN(ZI)=""
"RTN","C0CDACM",24,0)
 I $G(VALUE)="" I $D(@$$MAPG@(MAP)) D  Q 1 ; map exists, no value - return entire map
"RTN","C0CDACM",25,0)
 . M RTN=@$$MAPG@(MAP)
"RTN","C0CDACM",26,0)
 I $G(VALUE)="" Q 0 ; map doesn't exist.. fail
"RTN","C0CDACM",27,0)
 I $D(@$$MAPG@(MAP,VALUE)) D  Q 1 ; value found
"RTN","C0CDACM",28,0)
 . M RTN=@$$MAPG@(MAP,VALUE) 
"RTN","C0CDACM",29,0)
 I $G(DEFAULT)'=1 Q 0 ; default not requested
"RTN","C0CDACM",30,0)
 I $D(@$$MAPG@(MAP,"DEFAULT")) D  Q 1 ; default found
"RTN","C0CDACM",31,0)
 . M RTN=@$$MAPG@(MAP,"DEFAULT")
"RTN","C0CDACM",32,0)
 Q 0 
"RTN","C0CDACM",33,0)
 ;
"RTN","C0CDACM",34,0)
INIT ; initialize maps
"RTN","C0CDACM",35,0)
 D SETLOCM
"RTN","C0CDACM",36,0)
 Q
"RTN","C0CDACM",37,0)
 ;
"RTN","C0CDACM",38,0)
SETLOCM ; set location map
"RTN","C0CDACM",39,0)
 N MAP S MAP="getLocationCode"
"RTN","C0CDACM",40,0)
 K @$$MAPG@(MAP)
"RTN","C0CDACM",41,0)
 S @$$MAPG@(MAP,"IMP","code")="1060-1"
"RTN","C0CDACM",42,0)
 S @$$MAPG@(MAP,"IMP","text")="Inpatient medical ward"
"RTN","C0CDACM",43,0)
 S @$$MAPG@(MAP,"AMB","code")="1141-1"
"RTN","C0CDACM",44,0)
 S @$$MAPG@(MAP,"AMB","text")="Provider's office"
"RTN","C0CDACM",45,0)
 S @$$MAPG@(MAP,"DEFAULT","code")="1141-1"
"RTN","C0CDACM",46,0)
 S @$$MAPG@(MAP,"DEFAULT","text")="Provider's office"
"RTN","C0CDACM",47,0)
 Q
"RTN","C0CDACM",48,0)
 ;
"RTN","C0CDACM",49,0)
REACTION ; import Allergy Reactions mapping table
"RTN","C0CDACM",50,0)
 N ZDIR,ZFNAME
"RTN","C0CDACM",51,0)
 I '$$GETDIR(.ZDIR) Q  ;
"RTN","C0CDACM",52,0)
 I '$$GETFN(.ZFNAME,"allergy-reactions-VA-SNOMED-mapping-table-R40.csv") Q  ;
"RTN","C0CDACM",53,0)
 W !,"DIR ",ZDIR," FNAME ",ZFNAME
"RTN","C0CDACM",54,0)
 N GN S GN=$NA(^XTMP("KBAIREAC","CSV"))
"RTN","C0CDACM",55,0)
 K @GN ; CLEAR THE AREA
"RTN","C0CDACM",56,0)
 N GN1 S GN1=$NA(@GN@(1)) ; PLACE TO PUT THE CSV FILE
"RTN","C0CDACM",57,0)
 W !,"READING IN FILE ",ZFNAME," FROM DIRECTORY ",ZDIR
"RTN","C0CDACM",58,0)
 Q:$$FTG^%ZISH(ZDIR,ZFNAME,GN1,3)=""
"RTN","C0CDACM",59,0)
 N ZI S ZI=1
"RTN","C0CDACM",60,0)
 N GMAP S GMAP=$$MAPG() ; global maap
"RTN","C0CDACM",61,0)
 K @GMAP@("reaction")
"RTN","C0CDACM",62,0)
 S @GMAP@("B","reaction","reaction")=""
"RTN","C0CDACM",63,0)
 F  S ZI=$O(@GN@(ZI)) Q:ZI=""  D  ;
"RTN","C0CDACM",64,0)
 . N GR,VUID,VNAME,SNOMED,SNOTXT,PREF,ZV
"RTN","C0CDACM",65,0)
 . S ZV=@GN@(ZI)
"RTN","C0CDACM",66,0)
 . S VUID=$P(ZV,"|",1)
"RTN","C0CDACM",67,0)
 . S VNAME=$P(ZV,"|",2)
"RTN","C0CDACM",68,0)
 . W:$G(DEBUG) !,"VISTA NAME: ",VNAME
"RTN","C0CDACM",69,0)
 . S SNOMED=$P(ZV,"|",3)
"RTN","C0CDACM",70,0)
 . S SNOTXT=$P(ZV,"|",4)
"RTN","C0CDACM",71,0)
 . S PREF=$P(ZV,"|",5)
"RTN","C0CDACM",72,0)
 . I $L(ZV,"|")'=5 D  B  ;
"RTN","C0CDACM",73,0)
 . . W !,"ERROR, MALFORMED ENTRY",!,ZV
"RTN","C0CDACM",74,0)
 . I VNAME["|" D  B  ;
"RTN","C0CDACM",75,0)
 . . W !,"ERROR, MALFORMED ENTRY",!,ZV," ",VNAME
"RTN","C0CDACM",76,0)
 . Q:VNAME=""
"RTN","C0CDACM",77,0)
 . S GR("vuid")=VUID
"RTN","C0CDACM",78,0)
 . S GR("vname")=VNAME
"RTN","C0CDACM",79,0)
 . S GR("snomedCode")=SNOMED
"RTN","C0CDACM",80,0)
 . S GR("snomedText")=SNOTXT
"RTN","C0CDACM",81,0)
 . S GR("preferred")=PREF
"RTN","C0CDACM",82,0)
 . ;I VNAME["ITCHING," ZWR GR
"RTN","C0CDACM",83,0)
 . M @GMAP@("reaction",VNAME)=GR
"RTN","C0CDACM",84,0)
 . S @GMAP@("reaction","VUID",VUID,VNAME)=""
"RTN","C0CDACM",85,0)
 . S @GMAP@("reaction","B",VNAME,VNAME)=""
"RTN","C0CDACM",86,0)
 Q
"RTN","C0CDACM",87,0)
 ;
"RTN","C0CDACM",88,0)
IMPORTVS ; import HL7 valuesets
"RTN","C0CDACM",89,0)
 N ZDIR,ZFNAME
"RTN","C0CDACM",90,0)
 I '$$GETDIR(.ZDIR) Q  ;
"RTN","C0CDACM",91,0)
 I '$$GETFN(.ZFNAME,"index.csv") Q  ;
"RTN","C0CDACM",92,0)
 W !,"DIR ",ZDIR," FNAME ",ZFNAME
"RTN","C0CDACM",93,0)
 N GN S GN=$NA(^XTMP("KBAIVADS","INDEX"))
"RTN","C0CDACM",94,0)
 K @GN ; CLEAR THE AREA
"RTN","C0CDACM",95,0)
 N GN1 S GN1=$NA(@GN@(1)) ; PLACE TO PUT THE XML FILE
"RTN","C0CDACM",96,0)
 W !,"READING IN FILE ",ZFNAME," FROM DIRECTORY ",ZDIR
"RTN","C0CDACM",97,0)
 Q:$$FTG^%ZISH(ZDIR,ZFNAME,GN1,3)=""
"RTN","C0CDACM",98,0)
 N ZI S ZI=1
"RTN","C0CDACM",99,0)
 F  S ZI=$O(@GN@(ZI)) Q:ZI=""  D  ;
"RTN","C0CDACM",100,0)
 . N NAME,OID,VSVER,VSDT,VSFN
"RTN","C0CDACM",101,0)
 . S NAME=$P(@GN@(ZI),"~",1)
"RTN","C0CDACM",102,0)
 . S OID=$P(@GN@(ZI),"~",2)
"RTN","C0CDACM",103,0)
 . S VSVER=$P(@GN@(ZI),"~",3)
"RTN","C0CDACM",104,0)
 . S VSDT=$P(@GN@(ZI),"~",4)
"RTN","C0CDACM",105,0)
 . S VSFN=$P(@GN@(ZI),"~",5)
"RTN","C0CDACM",106,0)
 . D IMPONE(NAME,OID,ZDIR,VSFN)
"RTN","C0CDACM",107,0)
 Q
"RTN","C0CDACM",108,0)
 ;
"RTN","C0CDACM",109,0)
IMPONE(NAME,OID,ZDIR,VSFN) ; import one valueset
"RTN","C0CDACM",110,0)
 N MAP S MAP=$$MAPG()
"RTN","C0CDACM",111,0)
 N GTMP S GTMP=$NA(^TMP("KBAIVADS",$J))
"RTN","C0CDACM",112,0)
 K @GTMP
"RTN","C0CDACM",113,0)
 N GTMP1 S GTMP1=$NA(@GTMP@(1))
"RTN","C0CDACM",114,0)
 W !,"READING IN FILE ",VSFN," FROM DIRECTORY ",ZDIR
"RTN","C0CDACM",115,0)
 Q:$$FTG^%ZISH(ZDIR,VSFN,GTMP1,3)=""
"RTN","C0CDACM",116,0)
 K @MAP@(OID)
"RTN","C0CDACM",117,0)
 N ZZI S ZZI=1
"RTN","C0CDACM",118,0)
 F  S ZZI=$O(@GTMP@(ZZI)) Q:ZZI=""  D  ;
"RTN","C0CDACM",119,0)
 . N VSNAME,VSOID,VSVER,CODE,CODENAME,PREFNAME,ALTCODE,HL7ID,SYSOID,SYSNAME,VSDT
"RTN","C0CDACM",120,0)
 . S VSNAME=$P(@GTMP@(ZZI),"~",1)
"RTN","C0CDACM",121,0)
 . S VSOID=$P(@GTMP@(ZZI),"~",2)
"RTN","C0CDACM",122,0)
 . S VSVER=$P(@GTMP@(ZZI),"~",3)
"RTN","C0CDACM",123,0)
 . S CODE=$P(@GTMP@(ZZI),"~",4)
"RTN","C0CDACM",124,0)
 . S CODENAME=$P(@GTMP@(ZZI),"~",5)
"RTN","C0CDACM",125,0)
 . S PREFNAME=$P(@GTMP@(ZZI),"~",6)
"RTN","C0CDACM",126,0)
 . S ALTCODE=$P(@GTMP@(ZZI),"~",7)
"RTN","C0CDACM",127,0)
 . S HL7ID=$P(@GTMP@(ZZI),"~",8)
"RTN","C0CDACM",128,0)
 . S SYSOID=$P(@GTMP@(ZZI),"~",9)
"RTN","C0CDACM",129,0)
 . S SYSNAME=$P(@GTMP@(ZZI),"~",10)
"RTN","C0CDACM",130,0)
 . S VSDT=$P(@GTMP@(ZZI),"~",11)
"RTN","C0CDACM",131,0)
 . W:$G(DEBUG) !,"VSNAME ",VSNAME," VSOID ",VSOID," VSVER ",VSVER," CODE ",CODE," CODENAME ",CODENAME," PREFNAME ",PREFNAME," ALTCODE ",ALTCODE," HL7ID ",HL7ID," SYSOID ",SYSOID," SYSNAME ",SYSNAME," VSDT ",VSDT
"RTN","C0CDACM",132,0)
 . ;W !,@GTMP@(ZZI)
"RTN","C0CDACM",133,0)
 . N GR
"RTN","C0CDACM",134,0)
 . S GR("vsName")=VSNAME
"RTN","C0CDACM",135,0)
 . S GR("oid")=VSOID
"RTN","C0CDACM",136,0)
 . S GR("vsVersion")=VSVER
"RTN","C0CDACM",137,0)
 . S GR("code")=CODE
"RTN","C0CDACM",138,0)
 . S GR("name")=CODENAME
"RTN","C0CDACM",139,0)
 . S GR("prefName")=PREFNAME
"RTN","C0CDACM",140,0)
 . S GR("altCode")=ALTCODE
"RTN","C0CDACM",141,0)
 . S GR("hl7id")=HL7ID
"RTN","C0CDACM",142,0)
 . S GR("sysOid")=SYSOID
"RTN","C0CDACM",143,0)
 . S GR("sysName")=SYSNAME
"RTN","C0CDACM",144,0)
 . S GR("vsDate")=VSDT
"RTN","C0CDACM",145,0)
 . M @MAP@(OID,CODE)=GR
"RTN","C0CDACM",146,0)
 . S @MAP@("B",VSNAME,OID)=""
"RTN","C0CDACM",147,0)
 . S @MAP@(OID,"B",$E(CODENAME,1,30),CODE)=""
"RTN","C0CDACM",148,0)
 . D FILE(.GR) ; update the fileman file
"RTN","C0CDACM",149,0)
 Q
"RTN","C0CDACM",150,0)
 ;
"RTN","C0CDACM",151,0)
CODEFN() ; EXTRINSIC RETURNS THE CODE FILE FILE NUMBER
"RTN","C0CDACM",152,0)
 Q 8402116.101
"RTN","C0CDACM",153,0)
 ;
"RTN","C0CDACM",154,0)
SUBFN() ; code subfile number
"RTN","C0CDACM",155,0)
 Q 8402116.1011
"RTN","C0CDACM",156,0)
 ;
"RTN","C0CDACM",157,0)
FILE(GR) ; file a code
"RTN","C0CDACM",158,0)
 N JJOHFDA,FN,SFN
"RTN","C0CDACM",159,0)
 S FN=$$CODEFN()
"RTN","C0CDACM",160,0)
 S SFN=$$SUBFN()
"RTN","C0CDACM",161,0)
 S JJOHFDA(FN,"?+1,",.01)=GR("vsName")
"RTN","C0CDACM",162,0)
 S JJOHFDA(FN,"?+1,",.02)=GR("oid")
"RTN","C0CDACM",163,0)
 S JJOHFDA(FN,"?+1,",.1)=GR("vsVersion")
"RTN","C0CDACM",164,0)
 S JJOHFDA(FN,"?+1,",.2)=GR("vsDate")
"RTN","C0CDACM",165,0)
 S JJOHFDA(SFN,"?+2,?+1,",.01)=GR("code")
"RTN","C0CDACM",166,0)
 S JJOHFDA(SFN,"?+2,?+1,",.02)=$TR(GR("name"),"^")
"RTN","C0CDACM",167,0)
 S JJOHFDA(SFN,"?+2,?+1,",.03)=$TR(GR("prefName"),"^")
"RTN","C0CDACM",168,0)
 S JJOHFDA(SFN,"?+2,?+1,",.04)=GR("altCode")
"RTN","C0CDACM",169,0)
 S JJOHFDA(SFN,"?+2,?+1,",.05)=GR("hl7id")
"RTN","C0CDACM",170,0)
 S JJOHFDA(SFN,"?+2,?+1,",.06)=GR("sysOid")
"RTN","C0CDACM",171,0)
 S JJOHFDA(SFN,"?+2,?+1,",.07)=GR("sysName")
"RTN","C0CDACM",172,0)
 D UPDIE(.JJOHFDA) ; 
"RTN","C0CDACM",173,0)
 ;;   File fields:
"RTN","C0CDACM",174,0)
 ;;  .01          VALUE SET NAME
"RTN","C0CDACM",175,0)
 ;;  .02          OID
"RTN","C0CDACM",176,0)
 ;;  .1           VERSION
"RTN","C0CDACM",177,0)
 ;;  .2           DATE
"RTN","C0CDACM",178,0)
 ;;  1            CODE  (multiple)
"RTN","C0CDACM",179,0)
 ;;   Code Subfile fields:
"RTN","C0CDACM",180,0)
 ;;  .01          CODE VALUE
"RTN","C0CDACM",181,0)
 ;;  .02          CODE NAME
"RTN","C0CDACM",182,0)
 ;;  .03          PREFERED NAME
"RTN","C0CDACM",183,0)
 ;;  .04          ALT CODE
"RTN","C0CDACM",184,0)
 ;;  .05          HL7 ID
"RTN","C0CDACM",185,0)
 ;;  .06          CODE SYSTEM OID
"RTN","C0CDACM",186,0)
 ;;  .07          CODE SYSTEM NAME
"RTN","C0CDACM",187,0)
 Q
"RTN","C0CDACM",188,0)
 ;         
"RTN","C0CDACM",189,0)
GETDIR(KBAIDIR,KBAIDEF) ; EXTRINSIC WHICH PROMPTS FOR DIRECTORY
"RTN","C0CDACM",190,0)
 ; RETURNS TRUE IF THE USER GAVE VALUES
"RTN","C0CDACM",191,0)
 S DIR(0)="F^3:240"
"RTN","C0CDACM",192,0)
 S DIR("A")="FILE DIRECTORY"
"RTN","C0CDACM",193,0)
 I '$D(KBAIDEF) S KBAIDEF="/home/vista/ccda/trunk/oids/"
"RTN","C0CDACM",194,0)
 S DIR("B")=KBAIDEF
"RTN","C0CDACM",195,0)
 D ^DIR
"RTN","C0CDACM",196,0)
 I Y="^" Q 0 ;
"RTN","C0CDACM",197,0)
 S KBAIDIR=Y
"RTN","C0CDACM",198,0)
 Q 1
"RTN","C0CDACM",199,0)
 ;
"RTN","C0CDACM",200,0)
GETFN(KBAIFN,KBAIDEF) ; EXTRINSIC WHICH PROMPTS FOR FILENAME
"RTN","C0CDACM",201,0)
 ; RETURNS TRUE IF THE USER GAVE VALUES
"RTN","C0CDACM",202,0)
 S DIR(0)="F^3:240"
"RTN","C0CDACM",203,0)
 S DIR("A")="FILE NAME"
"RTN","C0CDACM",204,0)
 I '$D(KBAIDEF) S KBAIDEF="index.csv"
"RTN","C0CDACM",205,0)
 S DIR("B")=KBAIDEF
"RTN","C0CDACM",206,0)
 D ^DIR
"RTN","C0CDACM",207,0)
 I Y="" Q 0 ;
"RTN","C0CDACM",208,0)
 I Y="^" Q 0 ;
"RTN","C0CDACM",209,0)
 S KBAIFN=Y
"RTN","C0CDACM",210,0)
 Q 1
"RTN","C0CDACM",211,0)
 ;
"RTN","C0CDACM",212,0)
I2S ; 
"RTN","C0CDACM",213,0)
 ; here is an example of one record in the NLM ICD to Snomed mapping file:
"RTN","C0CDACM",214,0)
 ;;ICD_CODE   427.31
"RTN","C0CDACM",215,0)
 ;;ICD_NAME   Atrial fibrillation
"RTN","C0CDACM",216,0)
 ;;IS_CURRENT_ICD   1
"RTN","C0CDACM",217,0)
 ;;IP_USAGE   1.89778
"RTN","C0CDACM",218,0)
 ;;OP_USAGE   3.20644
"RTN","C0CDACM",219,0)
 ;;AVG_USAGE   2.55211
"RTN","C0CDACM",220,0)
 ;;IS_NEC   0
"RTN","C0CDACM",221,0)
 ;;SNOMED_CID   49436004
"RTN","C0CDACM",222,0)
 ;;SNOMED_FSN   Atrial fibrillation (disorder)
"RTN","C0CDACM",223,0)
 ;;IS_1-1MAP   1
"RTN","C0CDACM",224,0)
 ;;CORE_USAGE   0.4746
"RTN","C0CDACM",225,0)
 ;;IN_CORE   1
"RTN","C0CDACM",226,0)
 Q
"RTN","C0CDACM",227,0)
 ;
"RTN","C0CDACM",228,0)
FILEI2S ; file ICD9 to Snomed mapping in file 8402116.201
"RTN","C0CDACM",229,0)
 N GF S GF=8402116.201 ; fileman file number
"RTN","C0CDACM",230,0)
 N GFS S GFS=8402116.211 ; multiple subfile number
"RTN","C0CDACM",231,0)
 N MAP S MAP=$NA(^XTMP("JJOH","MAP")) ; location of the map
"RTN","C0CDACM",232,0)
 N ZI S ZI=""
"RTN","C0CDACM",233,0)
 F  S ZI=$O(@MAP@(ZI)) Q:ZI=""  D  ;
"RTN","C0CDACM",234,0)
 . K JJOHFDA
"RTN","C0CDACM",235,0)
 . S JJOHFDA(GF,"?+1,",.01)=@MAP@(ZI,1,"ICD_CODE")
"RTN","C0CDACM",236,0)
 . S JJOHFDA(GF,"?+1,",.02)=@MAP@(ZI,1,"ICD_NAME")
"RTN","C0CDACM",237,0)
 . S JJOHFDA(GF,"?+1,",5)=@MAP@(ZI,1,"IS_1-1MAP")
"RTN","C0CDACM",238,0)
 . N IS1TO1 S IS1TO1=@MAP@(ZI,1,"IS_1-1MAP")
"RTN","C0CDACM",239,0)
 . S:IS1TO1 JJOHFDA(GF,"?+1,",1)=@MAP@(ZI,1,"SNOMED_CID")
"RTN","C0CDACM",240,0)
 . S:IS1TO1 JJOHFDA(GF,"?+1,",1.1)=@MAP@(ZI,1,"SNOMED_FSN")
"RTN","C0CDACM",241,0)
 . S:IS1TO1 JJOHFDA(GF,"?+1,",1.2)=@MAP@(ZI,1,"IN_CORE")
"RTN","C0CDACM",242,0)
 . S JJOHFDA(GF,"?+1,",9.1)=@MAP@(ZI,1,"IS_CURRENT_ICD")
"RTN","C0CDACM",243,0)
 . S JJOHFDA(GF,"?+1,",9.2)=@MAP@(ZI,1,"IP_USAGE")
"RTN","C0CDACM",244,0)
 . S JJOHFDA(GF,"?+1,",9.3)=@MAP@(ZI,1,"OP_USAGE")
"RTN","C0CDACM",245,0)
 . S JJOHFDA(GF,"?+1,",9.4)=@MAP@(ZI,1,"AVG_USAGE")
"RTN","C0CDACM",246,0)
 . S JJOHFDA(GF,"?+1,",9.5)=@MAP@(ZI,1,"IS_NEC")
"RTN","C0CDACM",247,0)
 . I $D(@MAP@(ZI,2)) D  ; is a multiple
"RTN","C0CDACM",248,0)
 . . S JJOHFDA(GF,"?+1,",2)=@MAP@(ZI,1,"SNOMED_CID")
"RTN","C0CDACM",249,0)
 . . S JJOHFDA(GF,"?+1,",2.1)=$TR(@MAP@(ZI,1,"SNOMED_FSN"),"^") 
"RTN","C0CDACM",250,0)
 . . S JJOHFDA(GF,"?+1,",1.2)=@MAP@(ZI,1,"IN_CORE")
"RTN","C0CDACM",251,0)
 . . N ZJ S ZJ=""
"RTN","C0CDACM",252,0)
 . . F  S ZJ=$O(@MAP@(ZI,ZJ)) Q:ZJ=""  D  ;
"RTN","C0CDACM",253,0)
 . . . N ZK S ZK=ZJ+1
"RTN","C0CDACM",254,0)
 . . . S JJOHFDA(GFS,"?+"_ZK_",?+1,",.01)=@MAP@(ZI,ZJ,"SNOMED_CID")
"RTN","C0CDACM",255,0)
 . . . S JJOHFDA(GFS,"?+"_ZK_",?+1,",.02)=$TR(@MAP@(ZI,ZJ,"SNOMED_FSN"),"^")
"RTN","C0CDACM",256,0)
 . . . S JJOHFDA(GFS,"?+"_ZK_",?+1,",1)=@MAP@(ZI,ZJ,"IN_CORE")
"RTN","C0CDACM",257,0)
 . D UPDIE(.JJOHFDA)
"RTN","C0CDACM",258,0)
 Q
"RTN","C0CDACM",259,0)
 ;
"RTN","C0CDACM",260,0)
XFORM() ;
"RTN","C0CDACM",261,0)
 N GN S GN=$NA(^XTMP("JJOH"))
"RTN","C0CDACM",262,0)
 N SRC1,SRCM,MAP
"RTN","C0CDACM",263,0)
 S SRC1=$NA(@GN@("ICDMAP121"))
"RTN","C0CDACM",264,0)
 S SRCM=$NA(@GN@("ICDMAP12M"))
"RTN","C0CDACM",265,0)
 S MAP=$NA(@GN@("MAP"))
"RTN","C0CDACM",266,0)
 K @MAP
"RTN","C0CDACM",267,0)
 N SRC
"RTN","C0CDACM",268,0)
 F SRC=SRC1,SRCM D  ;
"RTN","C0CDACM",269,0)
 . N ZN S ZN=$O(@SRC@(""),-1)
"RTN","C0CDACM",270,0)
 . N ZH S ZH=@SRC@(1)
"RTN","C0CDACM",271,0)
 . N I,ZT
"RTN","C0CDACM",272,0)
 . F I=1:1:ZN D  ;
"RTN","C0CDACM",273,0)
 . . N J
"RTN","C0CDACM",274,0)
 . . F J=1:1:12 D  ;
"RTN","C0CDACM",275,0)
 . . . S ZT($P(ZH,"~",J))=$P(@SRC@(I),"~",J)
"RTN","C0CDACM",276,0)
 . . ;W !,ZN ZWR ZT
"RTN","C0CDACM",277,0)
 . . N ICD S ICD=ZT("ICD_CODE")
"RTN","C0CDACM",278,0)
 . . N ZI S ZI=1
"RTN","C0CDACM",279,0)
 . . I $D(@MAP@(ICD)) D  ;
"RTN","C0CDACM",280,0)
 . . . S ZI=$O(@MAP@(ICD,""),-1)+1
"RTN","C0CDACM",281,0)
 . . M @MAP@(ICD,ZI)=ZT
"RTN","C0CDACM",282,0)
 . . K ZT
"RTN","C0CDACM",283,0)
 Q
"RTN","C0CDACM",284,0)
 ;
"RTN","C0CDACM",285,0)
FINI2S() ; read in the NLM ICD9 to Snomed mapping files
"RTN","C0CDACM",286,0)
 ; extrinsic returns true if successful
"RTN","C0CDACM",287,0)
 N FILE1,FILE2,DIR
"RTN","C0CDACM",288,0)
 Q:'$$GETDIR(.DIR,"/home/vista/ccda/trunk/map/") 0
"RTN","C0CDACM",289,0)
 W !,"Please enter ICD9 to Snomed 1 to 1 map file name"
"RTN","C0CDACM",290,0)
 Q:'$$GETFN(.FILE1,"icd9toSnomed_1to1.txt") 0
"RTN","C0CDACM",291,0)
 W !,"Please enter ICD9 to Snomed 1 to Many map file name"
"RTN","C0CDACM",292,0)
 Q:'$$GETFN(.FILE2,"icd9toSnomed_1toM.txt") 0
"RTN","C0CDACM",293,0)
 N GN  S GN=$NA(^XTMP("JJOH","ICDMAP121"))
"RTN","C0CDACM",294,0)
 N GN1 S GN1=$NA(@GN@(1))
"RTN","C0CDACM",295,0)
 K @GN
"RTN","C0CDACM",296,0)
 Q:$$FTG^%ZISH(DIR,FILE1,GN1,3)="" 0
"RTN","C0CDACM",297,0)
 S GN=$NA(^XTMP("JJOH","ICDMAP12M"))
"RTN","C0CDACM",298,0)
 S GN1=$NA(@GN@(1))
"RTN","C0CDACM",299,0)
 K @GN
"RTN","C0CDACM",300,0)
 Q:$$FTG^%ZISH(DIR,FILE2,GN1,3)="" 0
"RTN","C0CDACM",301,0)
 Q 1
"RTN","C0CDACM",302,0)
 ;
"RTN","C0CDACM",303,0)
UPDIE(ZFDA,ZIEN) ; INTERNAL ROUTINE TO CALL UPDATE^DIE AND CHECK FOR ERRORS
"RTN","C0CDACM",304,0)
 ; ZFDA IS PASSED BY REFERENCE
"RTN","C0CDACM",305,0)
 ; ZIEN IS PASSED BY REFERENCE
"RTN","C0CDACM",306,0)
 D:$G(DEBUG)
"RTN","C0CDACM",307,0)
 . ZWRITE ZFDA
"RTN","C0CDACM",308,0)
 . B
"RTN","C0CDACM",309,0)
 K ZERR
"RTN","C0CDACM",310,0)
 D CLEAN^DILF
"RTN","C0CDACM",311,0)
 D UPDATE^DIE("K","ZFDA","ZIEN","ZERR")
"RTN","C0CDACM",312,0)
 I '$G(TRUST) I $D(ZERR) S ZZERR=ZZERR ; ZZERR DOESN'T EXIST,
"RTN","C0CDACM",313,0)
 ; INVOKE THE ERROR TRAP IF TASKED
"RTN","C0CDACM",314,0)
 ;. W "ERROR",!
"RTN","C0CDACM",315,0)
 ;. ZWR ZERR
"RTN","C0CDACM",316,0)
 ;. B
"RTN","C0CDACM",317,0)
 K ZFDA
"RTN","C0CDACM",318,0)
 Q
"RTN","C0CDACM",319,0)
 ;
"RTN","C0CDACN")
0^16^B15735600
"RTN","C0CDACN",1,0)
C0CDACN ;SLC/MKB - Serve VistA data as XML via RPC - Patient Portal Version
"RTN","C0CDACN",2,0)
 ;;1.0;C0S;**1**;Oct 25, 2010;Build 1
"RTN","C0CDACN",3,0)
 ;
"RTN","C0CDACN",4,0)
 ; External References          DBIA#
"RTN","C0CDACN",5,0)
 ; -------------------          -----
"RTN","C0CDACN",6,0)
 ; ^DPT                         10035
"RTN","C0CDACN",7,0)
 ; ^SC                          10040
"RTN","C0CDACN",8,0)
 ; DIQ                           2056
"RTN","C0CDACN",9,0)
 ; MPIF001                       2701
"RTN","C0CDACN",10,0)
 ; VASITE                       10112
"RTN","C0CDACN",11,0)
 ; XLFDT                        10103
"RTN","C0CDACN",12,0)
 ; XLFSTR                       10104
"RTN","C0CDACN",13,0)
 ; XUAF4                         2171
"RTN","C0CDACN",14,0)
 ;
"RTN","C0CDACN",15,0)
GET(NHIN,DFN,TYPE,START,STOP,MAX,ID) ; -- Return search results as XML in @NHIN@(n)
"RTN","C0CDACN",16,0)
 ; RPC = NHIN GET VISTA DATA
"RTN","C0CDACN",17,0)
 N ICN,NHINI,NHINTOTL
"RTN","C0CDACN",18,0)
 S NHIN=$NA(^TMP("NHINV",$J)) K @NHIN
"RTN","C0CDACN",19,0)
 ;
"RTN","C0CDACN",20,0)
 ; parse & validate input parameters
"RTN","C0CDACN",21,0)
 S ICN=+$P(DFN,";",2),DFN=+$G(DFN)
"RTN","C0CDACN",22,0)
 I 'DFN S DFN=+$$GETDFN^MPIF001(ICN)
"RTN","C0CDACN",23,0)
 I DFN<1!'$D(^DPT(DFN)) D ERR(1,DFN) G GTQ
"RTN","C0CDACN",24,0)
 S TYPE=$G(TYPE) I TYPE="" S TYPE=$$ALL
"RTN","C0CDACN",25,0)
 S:'$G(START) START=1410101 S:'$G(STOP) STOP=9999998 S:'$G(MAX) MAX=9999
"RTN","C0CDACN",26,0)
 I START,STOP,STOP<START N X S X=START,START=STOP,STOP=X  ;switch
"RTN","C0CDACN",27,0)
 I STOP,$L(STOP,".")<2 S STOP=STOP_".24"
"RTN","C0CDACN",28,0)
 S ID=$G(ID)
"RTN","C0CDACN",29,0)
 ;
"RTN","C0CDACN",30,0)
 ; extract data
"RTN","C0CDACN",31,0)
 N NHINTYPE,NHINP,RTN
"RTN","C0CDACN",32,0)
 S NHINTYPE=TYPE D ADD("<results>")
"RTN","C0CDACN",33,0)
 F NHINP=1:1:$L(NHINTYPE,";") S TYPE=$P(NHINTYPE,";",NHINP) I $L(TYPE) D
"RTN","C0CDACN",34,0)
 . S RTN="EN^"_$$RTN(TYPE) Q:'$L($T(@RTN))  ;D ERR(2) Q
"RTN","C0CDACN",35,0)
 . D @(RTN_"(DFN,START,STOP,MAX,ID)")
"RTN","C0CDACN",36,0)
 D ADD("</results>")
"RTN","C0CDACN",37,0)
 ;
"RTN","C0CDACN",38,0)
 I $G(NHINTOTL),$G(@NHIN@(1))="<results>" S @NHIN@(1)="<results total='"_NHINTOTL_"' >"
"RTN","C0CDACN",39,0)
 ;
"RTN","C0CDACN",40,0)
GTQ ; end
"RTN","C0CDACN",41,0)
 Q
"RTN","C0CDACN",42,0)
 ;
"RTN","C0CDACN",43,0)
RTN(X) ; -- Return name of NHINVxxx routine for clinical domain X
"RTN","C0CDACN",44,0)
 S X=$$UP^XLFSTR(X),Y="NHINV"
"RTN","C0CDACN",45,0)
 I X="ACCESSION"    S Y="NHINVLRA"
"RTN","C0CDACN",46,0)
 I X="ALLERGY"      S Y="NHINVART"
"RTN","C0CDACN",47,0)
 I X="APPOINTMENT"  S Y="NHINVAPT"
"RTN","C0CDACN",48,0)
 ; X="CONSULT"      S Y="NHINVCON"
"RTN","C0CDACN",49,0)
 I X="DOCUMENT"     S Y="NHINVTIU"
"RTN","C0CDACN",50,0)
 I X="IMMUNIZATION" S Y="NHINVIMM"
"RTN","C0CDACN",51,0)
 I X="LAB"          S Y="NHINVLR"
"RTN","C0CDACN",52,0)
 I X="PANEL"        S Y="NHINVLRO"
"RTN","C0CDACN",53,0)
 I X="MED"          S Y="NHINVPS"
"RTN","C0CDACN",54,0)
 I X="RX"           S Y="NHINVPSO"
"RTN","C0CDACN",55,0)
 ; X="ORDER"        S Y="NHINVOR"
"RTN","C0CDACN",56,0)
 I X="PATIENT"      S Y="NHINVPT"
"RTN","C0CDACN",57,0)
 I X="PROBLEM"      S Y="NHINVPL"
"RTN","C0CDACN",58,0)
 I X="PROCEDURE"    S Y="NHINVPRC"
"RTN","C0CDACN",59,0)
 I X="SURGERY"      S Y="NHINVSR"
"RTN","C0CDACN",60,0)
 I X="VISIT"        S Y="NHINVSIT"
"RTN","C0CDACN",61,0)
 I X="VITAL"        S Y="NHINVIT"
"RTN","C0CDACN",62,0)
 I X="RADIOLOGY"    S Y="NHINVRA"
"RTN","C0CDACN",63,0)
 I X="NEW"          S Y="NHINVPR"
"RTN","C0CDACN",64,0)
 Q Y
"RTN","C0CDACN",65,0)
 ;
"RTN","C0CDACN",66,0)
ALL() ; -- return string for all types of data
"RTN","C0CDACN",67,0)
 ;Q "patient;allergy;problem;vital;lab;med;immunization;visit;appointment;document;procedure"
"RTN","C0CDACN",68,0)
 Q "patient;allergy;problem;vital;lab;med;immunization;visit;appointment;procedure"
"RTN","C0CDACN",69,0)
 ;
"RTN","C0CDACN",70,0)
ERR(X,VAL) ; -- return error message
"RTN","C0CDACN",71,0)
 N MSG  S MSG="Error"
"RTN","C0CDACN",72,0)
 I X=1  S MSG="Patient with dfn '"_$G(VAL)_"' not found"
"RTN","C0CDACN",73,0)
 I X=2  S MSG="Requested domain type '"_$G(VAL)_"' not recognized"
"RTN","C0CDACN",74,0)
 I X=99 S MSG="Unknown request"
"RTN","C0CDACN",75,0)
 ;
"RTN","C0CDACN",76,0)
 D ADD("<error>")
"RTN","C0CDACN",77,0)
 D ADD("<message>"_MSG_"</message>")
"RTN","C0CDACN",78,0)
 D ADD("</error>")
"RTN","C0CDACN",79,0)
 Q
"RTN","C0CDACN",80,0)
 ;
"RTN","C0CDACN",81,0)
ESC(X) ; -- escape outgoing XML
"RTN","C0CDACN",82,0)
 ; Q $ZCONVERT(X,"O","HTML")  ; uncomment for fastest performance on Cache
"RTN","C0CDACN",83,0)
 ;
"RTN","C0CDACN",84,0)
 N I,Y,QOT S QOT=""""
"RTN","C0CDACN",85,0)
 S Y=$P(X,"&") F I=2:1:$L(X,"&") S Y=Y_"&amp;"_$P(X,"&",I)
"RTN","C0CDACN",86,0)
 S X=Y,Y=$P(X,"<") F I=2:1:$L(X,"<") S Y=Y_"&lt;"_$P(X,"<",I)
"RTN","C0CDACN",87,0)
 S X=Y,Y=$P(X,">") F I=2:1:$L(X,">") S Y=Y_"&gt;"_$P(X,">",I)
"RTN","C0CDACN",88,0)
 S X=Y,Y=$P(X,"'") F I=2:1:$L(X,"'") S Y=Y_"&apos;"_$P(X,"'",I)
"RTN","C0CDACN",89,0)
 S X=Y,Y=$P(X,QOT) F I=2:1:$L(X,QOT) S Y=Y_"&quot;"_$P(X,QOT,I)
"RTN","C0CDACN",90,0)
 Q Y
"RTN","C0CDACN",91,0)
 ;
"RTN","C0CDACN",92,0)
ADD(X) ; Add a line @NHIN@(n)=X
"RTN","C0CDACN",93,0)
 S NHINI=$G(NHINI)+1
"RTN","C0CDACN",94,0)
 S @NHIN@(NHINI)=X
"RTN","C0CDACN",95,0)
 Q
"RTN","C0CDACN",96,0)
 ;
"RTN","C0CDACN",97,0)
STRING(ARRAY) ; -- Return text in ARRAY(n) or ARRAY(n,0) as a string
"RTN","C0CDACN",98,0)
 N I,X,Y S Y=""
"RTN","C0CDACN",99,0)
 S I=+$O(ARRAY("")) I I=0 S I=+$O(ARRAY(0))
"RTN","C0CDACN",100,0)
 S Y=$S($D(ARRAY(I,0)):ARRAY(I,0),1:$G(ARRAY(I)))
"RTN","C0CDACN",101,0)
 F  S I=$O(ARRAY(I)) Q:I<1  D
"RTN","C0CDACN",102,0)
 . S X=$S($D(ARRAY(I,0)):ARRAY(I,0),1:ARRAY(I))
"RTN","C0CDACN",103,0)
 . I $E(X)=" " S Y=Y_$C(13,10)_X Q
"RTN","C0CDACN",104,0)
 . S Y=Y_$S($E(Y,$L(Y))=" ":"",1:" ")_X
"RTN","C0CDACN",105,0)
 Q Y
"RTN","C0CDACN",106,0)
 ;
"RTN","C0CDACN",107,0)
FAC(X) ; -- return Institution file station# for location X
"RTN","C0CDACN",108,0)
 N HLOC,FAC,Y0,Y S Y=""
"RTN","C0CDACN",109,0)
 S HLOC=$G(^SC(+$G(X),0)),FAC=$P(HLOC,U,4) ;Institution ien
"RTN","C0CDACN",110,0)
 ; Get P:4 via Med Ctr Div, if not directly linked
"RTN","C0CDACN",111,0)
 I 'FAC,$P(HLOC,U,15) S FAC=$$GET1^DIQ(40.8,+$P(HLOC,U,15)_",",.07,"I")
"RTN","C0CDACN",112,0)
 S Y0=$S(FAC:$$NS^XUAF4(FAC),1:$P($$SITE^VASITE,U,2,3)) ;name^stn#
"RTN","C0CDACN",113,0)
 S:$L(Y0) Y=$P(Y0,U,2)_U_$P(Y0,U) ;switch to stn#^name
"RTN","C0CDACN",114,0)
 I $L(Y),'Y S $P(Y,U)=FAC
"RTN","C0CDACN",115,0)
 Q Y
"RTN","C0CDACN",116,0)
 ;
"RTN","C0CDACN",117,0)
VUID(IEN,FILE) ; -- Return VUID for item
"RTN","C0CDACN",118,0)
 Q $$GET1^DIQ(FILE,IEN_",",99.99)
"RTN","C0CDACP")
0^17^B949625958
"RTN","C0CDACP",1,0)
C0CDACP ; GPL - Patient Portal - CCDA Routines ;09/17/13  17:05
"RTN","C0CDACP",2,0)
 ;;0.1;JJOHPP;nopatch;noreleasedate;Build 1
"RTN","C0CDACP",3,0)
 ;
"RTN","C0CDACP",4,0)
 ; License AGPL v3.0
"RTN","C0CDACP",5,0)
 ; 
"RTN","C0CDACP",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDACP",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDACP",8,0)
 Q
"RTN","C0CDACP",9,0)
 ;
"RTN","C0CDACP",10,0)
PROC(BLIST,DFN,CCDAWRK,CCDARPT,CCDACTRL) ;
"RTN","C0CDACP",11,0)
 ;
"RTN","C0CDACP",12,0)
 N CCDAV,CCDAV1
"RTN","C0CDACP",13,0)
 S @CCDARPT@("STATUS")="EXTRACTING"
"RTN","C0CDACP",14,0)
 S @CCDARPT@("EXTRACT-BEGIN")=$$NOW^XLFDT
"RTN","C0CDACP",15,0)
 I $G(C0TEST) D TESTPAT(.CCDAV1) ; use a unit test patient for now
"RTN","C0CDACP",16,0)
 E  D GETPAT^C0CDACE(.CCDAV1,DFN,"procedures")
"RTN","C0CDACP",17,0)
 D HASCPTPROC(.CCDAV1,DFN)
"RTN","C0CDACP",18,0)
 D HFPROC(.CCDAV1,DFN)
"RTN","C0CDACP",19,0)
 I '$D(CCDAV1) Q  ;
"RTN","C0CDACP",20,0)
 I +$G(CCDAV1("results","procedures@total"))=0 Q  ;
"RTN","C0CDACP",21,0)
 I CCDAV1("results","procedures@total")=1 D  ;
"RTN","C0CDACP",22,0)
 . M CCDAV(1)=CCDAV1("results","procedures")
"RTN","C0CDACP",23,0)
 E  M CCDAV=CCDAV1("results","procedures")
"RTN","C0CDACP",24,0)
 S @CCDARPT@("EXTRACT-ENDS")=$$NOW^XLFDT
"RTN","C0CDACP",25,0)
 ;
"RTN","C0CDACP",26,0)
 ; procedures section html
"RTN","C0CDACP",27,0)
 ;
"RTN","C0CDACP",28,0)
 N C0HTML,C0ARY
"RTN","C0CDACP",29,0)
 S C0ARY("TITLE")="Procedure"
"RTN","C0CDACP",30,0)
 S C0ARY("HEADER",1)="Date"
"RTN","C0CDACP",31,0)
 S C0ARY("HEADER",2)="Procedure"
"RTN","C0CDACP",32,0)
 ;S C0ARY("HEADER",3)="Location"
"RTN","C0CDACP",33,0)
 ;S C0ARY("HEADER",4)="Status"
"RTN","C0CDACP",34,0)
 ;
"RTN","C0CDACP",35,0)
 D  ;
"RTN","C0CDACP",36,0)
 . N C0N S C0N=0
"RTN","C0CDACP",37,0)
 . N C0I S C0I=0
"RTN","C0CDACP",38,0)
 . F  S C0I=$O(CCDAV(C0I)) Q:+C0I=0  D  ;
"RTN","C0CDACP",39,0)
 . . N C0DATE S C0DATE=$G(CCDAV(C0I,"procedure","dateTime@value"))
"RTN","C0CDACP",40,0)
 . . N ZURI
"RTN","C0CDACP",41,0)
 . . I $D(CCDAV(C0I,"procedure","id@value")) D  ;
"RTN","C0CDACP",42,0)
 . . . S ZURI=$TR(CCDAV(C0I,"procedure","id@value"),".","_")
"RTN","C0CDACP",43,0)
 . . . S ZURI="uri_"_$G(CCDAV(C0I,"procedure","category@value"))_"_"_ZURI
"RTN","C0CDACP",44,0)
 . . S CCDAV(C0I,"procedure","uri")=$G(ZURI)
"RTN","C0CDACP",45,0)
 . . Q:$$REDACT^C0CDACV(CCDAV(C0I,"procedure","uri"),.PARMS)
"RTN","C0CDACP",46,0)
 . . S C0ARY(C0N,1,"uri")=$G(CCDAV(C0I,"procedure","uri"))
"RTN","C0CDACP",47,0)
 . . S C0N=C0N+1
"RTN","C0CDACP",48,0)
 . . I C0DATE'="" S C0ARY(C0N,1)=$$HTMLDT^C0CDACU(C0DATE) ; procedure date
"RTN","C0CDACP",49,0)
 . . E  S C0ARY(C0N,1)=""
"RTN","C0CDACP",50,0)
 . . S C0ARY(C0N,1,"ID")=$G(CCDAV(C0I,"procedure","uri"))
"RTN","C0CDACP",51,0)
 . . N UNAME,UCODE ; useName, useCode
"RTN","C0CDACP",52,0)
 . . S (UNAME,UCODE)=""
"RTN","C0CDACP",53,0)
 . . N PNAME,PCODE
"RTN","C0CDACP",54,0)
 . . S PNAME=$G(CCDAV(C0I,"procedure","name@value"))
"RTN","C0CDACP",55,0)
 . . S PCODE=$G(CCDAV(C0I,"procedure","order@code"))
"RTN","C0CDACP",56,0)
 . . N TCODE,TNAME
"RTN","C0CDACP",57,0)
 . . S TCODE=$G(CCDAV(C0I,"procedure","type@code"))
"RTN","C0CDACP",58,0)
 . . S TNAME=$G(CCDAV(C0I,"procedure","type@name"))
"RTN","C0CDACP",59,0)
 . . I PNAME="Unknown" S PNAME=""
"RTN","C0CDACP",60,0)
 . . I TNAME'="" S UNAME=TNAME S UCODE=TCODE
"RTN","C0CDACP",61,0)
 . . I UNAME="" S UNAME=PNAME S UCODE=PCODE
"RTN","C0CDACP",62,0)
 . . I UNAME="" D  ;
"RTN","C0CDACP",63,0)
 . . . S UNAME=$G(CCDAV(C0I,"procedure","imagingType@name")) ; procedure name
"RTN","C0CDACP",64,0)
 . . . S UCODE=$G(CCDAV(C0I,"procedure","imagingType@code")) ; procedure code
"RTN","C0CDACP",65,0)
 . . S UNAME=$$CHARCHK^MXMLBLD(UNAME)
"RTN","C0CDACP",66,0)
 . . S PNAME=$$CHARCHK^MXMLBLD(PNAME)
"RTN","C0CDACP",67,0)
 . . S CCDAV(C0I,"procedure","cptCode")=UCODE
"RTN","C0CDACP",68,0)
 . . S CCDAV(C0I,"procedure","cptName")=UNAME
"RTN","C0CDACP",69,0)
 . . S C0ARY(C0N,2)=UNAME
"RTN","C0CDACP",70,0)
 . . S C0ARY(C0N,2)=C0ARY(C0N,2)_" (CODE: "_UCODE_") "_PNAME
"RTN","C0CDACP",71,0)
 . . ;S C0ARY(C0N,3)=$G(CCDAV(C0I,"procedure","location@name")) ; 
"RTN","C0CDACP",72,0)
 . . ;S C0ARY(C0N,4)=$G(CCDAV(C0I,"procedure","status@value"))
"RTN","C0CDACP",73,0)
 ;
"RTN","C0CDACP",74,0)
 I +$O(C0ARY("AAAAA"),-1)=0 Q  ; all procedures have been redacted
"RTN","C0CDACP",75,0)
 ;
"RTN","C0CDACP",76,0)
 ; the procedure section component
"RTN","C0CDACP",77,0)
 ;
"RTN","C0CDACP",78,0)
 N PSECT S PSECT=$NA(@CCDAWRK@("PROCSECT"))
"RTN","C0CDACP",79,0)
 D GET^C0CDACU(PSECT,"TPROCSEC^C0CDACP")
"RTN","C0CDACP",80,0)
 D QUEUE^MXMLTMPL(BLIST,PSECT,1,@PSECT@(0))
"RTN","C0CDACP",81,0)
 ;
"RTN","C0CDACP",82,0)
 ; procedure html digest generation
"RTN","C0CDACP",83,0)
 ;
"RTN","C0CDACP",84,0)
 N PHTML S PHTML=$NA(@CCDAWRK@("PROCHTML"))
"RTN","C0CDACP",85,0)
 D GENHTML^C0CDACU(PHTML,"C0ARY")
"RTN","C0CDACP",86,0)
 D QUEUE^MXMLTMPL(BLIST,PHTML,1,@PHTML@(0))
"RTN","C0CDACP",87,0)
 ;
"RTN","C0CDACP",88,0)
 ; procedure xml generation
"RTN","C0CDACP",89,0)
 ;
"RTN","C0CDACP",90,0)
 N WRK
"RTN","C0CDACP",91,0)
 N C0I S C0I=0
"RTN","C0CDACP",92,0)
 F  S C0I=$O(CCDAV(C0I)) Q:+C0I=0  D  ;
"RTN","C0CDACP",93,0)
 . N C0DATE S C0DATE=$G(CCDAV(C0I,"procedure","dateTime@value"))
"RTN","C0CDACP",94,0)
 . I C0DATE'="" S C0ARY("procedureDate")=$$FMDTOUTC^C0CDACU(C0DATE) ; procedure date
"RTN","C0CDACP",95,0)
 . E  S C0ARY("procedureDate")="UNK"
"RTN","C0CDACP",96,0)
 . I $$REDACT^C0CDACV(CCDAV(C0I,"procedure","uri"),.PARMS) D  Q  ;
"RTN","C0CDACP",97,0)
 . S C0ARY("uri")=$G(CCDAV(C0I,"procedure","uri"))
"RTN","C0CDACP",98,0)
 . S C0ARY("cptName")=$G(CCDAV(C0I,"procedure","cptName"))
"RTN","C0CDACP",99,0)
 . S C0ARY("cptCode")=$G(CCDAV(C0I,"procedure","cptCode"))
"RTN","C0CDACP",100,0)
 . S C0ARY("immuLocation")=$G(CCDAV(C0I,"procedure","facility@name"))
"RTN","C0CDACP",101,0)
 . S C0ARY("guid")=$$UUID^C0CDACU() ; random
"RTN","C0CDACP",102,0)
 . D SETORGV^C0CDAC2(.C0ARY)
"RTN","C0CDACP",103,0)
 . ;
"RTN","C0CDACP",104,0)
 . ; procedure
"RTN","C0CDACP",105,0)
 . S WRK=$NA(@CCDAWRK@("PROC",C0I))
"RTN","C0CDACP",106,0)
 . ;
"RTN","C0CDACP",107,0)
 . N TEMPLATE S TEMPLATE="TPROCPT4^C0CDACP"
"RTN","C0CDACP",108,0)
 . I C0ARY("cptCode")=175135009 S TEMPLATE="TPROCPACE^C0CDACP"
"RTN","C0CDACP",109,0)
 . I C0ARY("cptCode")=90660004 S TEMPLATE="TPROCBURN^C0CDACP"
"RTN","C0CDACP",110,0)
 . I C0ARY("cptCode")=56251003 S TEMPLATE="TPROCNEB^C0CDACP"
"RTN","C0CDACP",111,0)
 . I C0ARY("cptCode")=10847001 S TEMPLATE="TPROCBRON^C0CDACP"
"RTN","C0CDACP",112,0)
 . I C0ARY("cptCode")=168731009 S TEMPLATE="TPROCCHST^C0CDACP"
"RTN","C0CDACP",113,0)
 . D GETNMAP^C0CDACU(WRK,TEMPLATE,"C0ARY")
"RTN","C0CDACP",114,0)
 . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDACP",115,0)
 ; 
"RTN","C0CDACP",116,0)
 ; procedure section ending
"RTN","C0CDACP",117,0)
 ;
"RTN","C0CDACP",118,0)
 N PROCEND S PROCEND=$NA(@CCDAWRK@("PROCEND"))
"RTN","C0CDACP",119,0)
 D GET^C0CDACU(PROCEND,"TPROCEND^C0CDACP")
"RTN","C0CDACP",120,0)
 D QUEUE^MXMLTMPL(BLIST,PROCEND,1,@PROCEND@(0))
"RTN","C0CDACP",121,0)
 ;
"RTN","C0CDACP",122,0)
 Q
"RTN","C0CDACP",123,0)
 ;
"RTN","C0CDACP",124,0)
 ; astro gpl
"RTN","C0CDACP",125,0)
HASCPTPROC(RTN,DFN) ; retrieve CPT codes that are missed by the VPR extract
"RTN","C0CDACP",126,0)
 ; that are really valid procedures
"RTN","C0CDACP",127,0)
 I '$D(^ICPT) Q  ;
"RTN","C0CDACP",128,0)
 N TBL
"RTN","C0CDACP",129,0)
 S TBL("G8427","DOC CUR MEDS BY PROV")="" ; documentation of current meds procedure
"RTN","C0CDACP",130,0)
 N ZI S ZI=""
"RTN","C0CDACP",131,0)
 F  S ZI=$O(TBL(ZI)) Q:ZI=""  D  ;
"RTN","C0CDACP",132,0)
 . NEW CPTNAME S CPTNAME=$O(TBL(ZI,""))
"RTN","C0CDACP",133,0)
 . NEW CPTCODE S CPTCODE=ZI
"RTN","C0CDACP",134,0)
 . NEW CPTIEN
"RTN","C0CDACP",135,0)
 . S CPTIEN=$ORDER(^ICPT("B",ZI,""))
"RTN","C0CDACP",136,0)
 . Q:CPTIEN=""
"RTN","C0CDACP",137,0)
 . NEW PXRMLOC S PXRMLOC=$NA(^PXRMINDX(9000010.18,"PPI",DFN,"U",CPTIEN))
"RTN","C0CDACP",138,0)
 . NEW DESTLOC S DESTLOC=$NA(RTN("results","procedures"))
"RTN","C0CDACP",139,0)
 . NEW DESTIEN
"RTN","C0CDACP",140,0)
 . IF $G(RTN("results","procedures@total"))=1 D  ;
"RTN","C0CDACP",141,0)
 . . N PRTMP 
"RTN","C0CDACP",142,0)
 . . M PRTMP=@DESTLOC@("procedure")
"RTN","C0CDACP",143,0)
 . . K @DESTLOC@("procedure")
"RTN","C0CDACP",144,0)
 . . M @DESTLOC@(1,"procedure")=PRTMP
"RTN","C0CDACP",145,0)
 . IF $G(RTN("results","procedures@total"))=0 D  ;
"RTN","C0CDACP",146,0)
 . . S DESTIEN=1
"RTN","C0CDACP",147,0)
 . . S DESTLOC=$NA(@DESTLOC@("procedure"))
"RTN","C0CDACP",148,0)
 . ELSE  D  ;
"RTN","C0CDACP",149,0)
 . . S DESTIEN=$O(@DESTLOC@(""),-1)+1
"RTN","C0CDACP",150,0)
 . . S DESTLOC=$NA(@DESTLOC@(DESTIEN,"procedure"))
"RTN","C0CDACP",151,0)
 . IF $D(@PXRMLOC) D  ; patient has the CPT code
"RTN","C0CDACP",152,0)
 . . N DATETIME S DATETIME=$O(@PXRMLOC@(""))
"RTN","C0CDACP",153,0)
 . . S @DESTLOC@("dateTime@value")=DATETIME
"RTN","C0CDACP",154,0)
 . . S @DESTLOC@("id@value")="CPT."_$O(@PXRMLOC@(DATETIME,""))
"RTN","C0CDACP",155,0)
 . . S @DESTLOC@("name@value")=CPTNAME
"RTN","C0CDACP",156,0)
 . . S @DESTLOC@("order@code")=CPTCODE
"RTN","C0CDACP",157,0)
 . . S @DESTLOC@("cptName")=CPTNAME
"RTN","C0CDACP",158,0)
 . . S @DESTLOC@("cptCode")=ZI
"RTN","C0CDACP",159,0)
 . . S @DESTLOC@("category@value")="CPT"
"RTN","C0CDACP",160,0)
 . . S RTN("results","procedures@total")=DESTIEN
"RTN","C0CDACP",161,0)
 Q
"RTN","C0CDACP",162,0)
 ;
"RTN","C0CDACP",163,0)
TESTHF ;
"RTN","C0CDACP",164,0)
 S DFN=13166 
"RTN","C0CDACP",165,0)
 D GETPAT^C0CDACE(.CCDAV1,DFN,"procedures")
"RTN","C0CDACP",166,0)
 D HASCPTPROC(.CCDAV1,DFN)
"RTN","C0CDACP",167,0)
 D HFPROC(.CCDAV1,DFN)
"RTN","C0CDACP",168,0)
 ZWR CCDAV1
"RTN","C0CDACP",169,0)
 Q
"RTN","C0CDACP",170,0)
 ; 
"RTN","C0CDACP",171,0)
HFPROC(RTN,DFN) ; retrieve procedures from Health Factors
"RTN","C0CDACP",172,0)
 ; 
"RTN","C0CDACP",173,0)
 N TBL2 ; table of health factors we are looking for
"RTN","C0CDACP",174,0)
 S TBL2("175136005","Intro-cardiac pacemaker - 175136005")="" ; use TPROCPACE
"RTN","C0CDACP",175,0)
 S TBL2("56251003","Nebuliser therapy - 56251003")="" ; use TPROCNEB
"RTN","C0CDACP",176,0)
 S TBL2("10847001","Bronchoscopy 10847001")="" ; use TPROCBRON
"RTN","C0CDACP",177,0)
 S TBL2("168731009","Chest X-Ray 168731009")="" ; use TPROCCHST
"RTN","C0CDACP",178,0)
 S TBL2("90660004","APP OF DRESSING FOR BURN 90660004")="" ; use TPROCBURN
"RTN","C0CDACP",179,0)
 S TBL2("UDI","UDI PACEMAKER")="" ; included in TPROCPACE
"RTN","C0CDACP",180,0)
 N ZJ S ZJ=""
"RTN","C0CDACP",181,0)
 F  S ZJ=$O(TBL2(ZJ)) Q:ZJ=""  D  ; make a B index
"RTN","C0CDACP",182,0)
 . N ZN S ZN=$O(TBL2(ZJ,""))
"RTN","C0CDACP",183,0)
 . S TBL2("B",ZN,ZJ)=""
"RTN","C0CDACP",184,0)
 ;
"RTN","C0CDACP",185,0)
 N C0HF
"RTN","C0CDACP",186,0)
 D GETPAT^C0CDACE(.C0HF,DFN,"health-factors")
"RTN","C0CDACP",187,0)
 N HFLOC S HFLOC=$NA(C0HF("results","healthFactors"))
"RTN","C0CDACP",188,0)
 I $G(C0HF("results","healthFactors@total"))=1 D  ;
"RTN","C0CDACP",189,0)
 . N HFTMP M HFTMP=@HFLOC@("factor")
"RTN","C0CDACP",190,0)
 . K @HFLOC@("factor")
"RTN","C0CDACP",191,0)
 . M @HFLOC@(1,"factor")=HFTMP
"RTN","C0CDACP",192,0)
 N ZI S ZI=0
"RTN","C0CDACP",193,0)
 F  S ZI=$O(@HFLOC@(ZI)) Q:+ZI=0  D  ;
"RTN","C0CDACP",194,0)
 . N HF S HF=$G(@HFLOC@(ZI,"factor","name@value"))
"RTN","C0CDACP",195,0)
 . ;W !,HF
"RTN","C0CDACP",196,0)
 . I $O(TBL2("B",HF,""))="" Q  ; not in table
"RTN","C0CDACP",197,0)
 . ;
"RTN","C0CDACP",198,0)
 . NEW SCTNAME S SCTNAME=HF
"RTN","C0CDACP",199,0)
 . NEW SCTCODE S SCTCODE=$O(TBL2("B",HF,""))
"RTN","C0CDACP",200,0)
 . ;
"RTN","C0CDACP",201,0)
 . I SCTCODE=175136005 S SCTCODE=175135009 ; mapped for certification
"RTN","C0CDACP",202,0)
 . ; 
"RTN","C0CDACP",203,0)
 . I SCTCODE="UDI" Q  ; included in TPROCPACE template
"RTN","C0CDACP",204,0)
 . ;
"RTN","C0CDACP",205,0)
 . NEW DESTLOC S DESTLOC=$NA(RTN("results","procedures"))
"RTN","C0CDACP",206,0)
 . NEW DESTIEN
"RTN","C0CDACP",207,0)
 . IF $G(RTN("results","procedures@total"))=1 D  ;
"RTN","C0CDACP",208,0)
 . . N PRTMP 
"RTN","C0CDACP",209,0)
 . . M PRTMP=@DESTLOC@("procedure")
"RTN","C0CDACP",210,0)
 . . K @DESTLOC@("procedure")
"RTN","C0CDACP",211,0)
 . . M @DESTLOC@(1,"procedure")=PRTMP
"RTN","C0CDACP",212,0)
 . IF $G(RTN("results","procedures@total"))=0 D  ;
"RTN","C0CDACP",213,0)
 . . S DESTIEN=1
"RTN","C0CDACP",214,0)
 . . S DESTLOC=$NA(@DESTLOC@("procedure"))
"RTN","C0CDACP",215,0)
 . ELSE  D  ;
"RTN","C0CDACP",216,0)
 . . S DESTIEN=$O(@DESTLOC@(""),-1)+1
"RTN","C0CDACP",217,0)
 . . S DESTLOC=$NA(@DESTLOC@(DESTIEN,"procedure"))
"RTN","C0CDACP",218,0)
 . IF $G(SCTCODE)'="" D  ; patient has a SNOMED code
"RTN","C0CDACP",219,0)
 . . N DATETIME S DATETIME=$G(@HFLOC@(ZI,"factor","recorded@value"))
"RTN","C0CDACP",220,0)
 . . S @DESTLOC@("dateTime@value")=DATETIME
"RTN","C0CDACP",221,0)
 . . S @DESTLOC@("id@value")="SCT."_$G(@HFLOC@(ZI,"factor","id@value"))
"RTN","C0CDACP",222,0)
 . . S @DESTLOC@("name@value")=SCTNAME
"RTN","C0CDACP",223,0)
 . . S @DESTLOC@("order@code")=SCTCODE
"RTN","C0CDACP",224,0)
 . . S @DESTLOC@("cptName")=SCTNAME
"RTN","C0CDACP",225,0)
 . . S @DESTLOC@("cptCode")=ZI
"RTN","C0CDACP",226,0)
 . . S @DESTLOC@("category@value")="SCT"
"RTN","C0CDACP",227,0)
 . . S RTN("results","procedures@total")=DESTIEN
"RTN","C0CDACP",228,0)
 Q
"RTN","C0CDACP",229,0)
 ;
"RTN","C0CDACP",230,0)
 ; end astro gpl
"RTN","C0CDACP",231,0)
 ;
"RTN","C0CDACP",232,0)
TPROCSEC ; 
"RTN","C0CDACP",233,0)
 ;;<component>
"RTN","C0CDACP",234,0)
 ;;<section>
"RTN","C0CDACP",235,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.7.1"></templateId>
"RTN","C0CDACP",236,0)
 ;;<code code="47519-4" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="HISTORY OF PROCEDURES"></code>
"RTN","C0CDACP",237,0)
 Q
"RTN","C0CDACP",238,0)
 ;
"RTN","C0CDACP",239,0)
TPROCPT4 ;
"RTN","C0CDACP",240,0)
 ;;<entry>
"RTN","C0CDACP",241,0)
 ;;<procedure classCode="PROC" moodCode="EVN">
"RTN","C0CDACP",242,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.14"></templateId>
"RTN","C0CDACP",243,0)
 ;;<id root="@@guid@@"></id>
"RTN","C0CDACP",244,0)
 ;;<code code="@@cptCode@@" codeSystem="2.16.840.1.113883.6.12" codeSystemName="CPT4" displayName="@@cptName@@" xsi:type="CE">
"RTN","C0CDACP",245,0)
 ;;<originalText>
"RTN","C0CDACP",246,0)
 ;;<reference value="#@@uri@@"></reference>
"RTN","C0CDACP",247,0)
 ;;</originalText>
"RTN","C0CDACP",248,0)
 ;;</code>
"RTN","C0CDACP",249,0)
 ;;<statusCode code="completed"></statusCode>
"RTN","C0CDACP",250,0)
 ;;<effectiveTime>
"RTN","C0CDACP",251,0)
 ;;<center value="@@procedureDate@@"></center>
"RTN","C0CDACP",252,0)
 ;;</effectiveTime>
"RTN","C0CDACP",253,0)
 ;;<performer typeCode="PRF">
"RTN","C0CDACP",254,0)
 ;;<assignedEntity>
"RTN","C0CDACP",255,0)
 ;;<id root="@@orgOID@@"></id>
"RTN","C0CDACP",256,0)
 ;;<addr>
"RTN","C0CDACP",257,0)
 ;;<streetAddressLine>@@orgAddr@@</streetAddressLine>
"RTN","C0CDACP",258,0)
 ;;<city>@@orgCity@@</city>
"RTN","C0CDACP",259,0)
 ;;<state>@@orgState@@</state>
"RTN","C0CDACP",260,0)
 ;;<postalCode>@@orgZip@@</postalCode>
"RTN","C0CDACP",261,0)
 ;;</addr>
"RTN","C0CDACP",262,0)
 ;;<telecom use="WP" value="@@orgTelephone@@"></telecom>
"RTN","C0CDACP",263,0)
 ;;<representedOrganization>
"RTN","C0CDACP",264,0)
 ;;<id root="@@orgOID@@"></id>
"RTN","C0CDACP",265,0)
 ;;<name>@@orgName@@</name>
"RTN","C0CDACP",266,0)
 ;;<telecom use="WP" value="@@orgTelephone@@"></telecom>
"RTN","C0CDACP",267,0)
 ;;<addr>
"RTN","C0CDACP",268,0)
 ;;<streetAddressLine>@@orgAddr@@</streetAddressLine>
"RTN","C0CDACP",269,0)
 ;;<city>@@orgCity@@</city>
"RTN","C0CDACP",270,0)
 ;;<state>@@orgState@@</state>
"RTN","C0CDACP",271,0)
 ;;<postalCode>@@orgZip@@</postalCode>
"RTN","C0CDACP",272,0)
 ;;</addr>
"RTN","C0CDACP",273,0)
 ;;</representedOrganization>
"RTN","C0CDACP",274,0)
 ;;</assignedEntity>
"RTN","C0CDACP",275,0)
 ;;</performer>
"RTN","C0CDACP",276,0)
 ;;</procedure>
"RTN","C0CDACP",277,0)
 ;;</entry>
"RTN","C0CDACP",278,0)
 Q
"RTN","C0CDACP",279,0)
 ;
"RTN","C0CDACP",280,0)
TPROCNEB ;
"RTN","C0CDACP",281,0)
 ;;<entry typeCode="DRIV">
"RTN","C0CDACP",282,0)
 ;;  <procedure classCode="PROC" moodCode="EVN">
"RTN","C0CDACP",283,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.4.14" extension="2014-06-09" />
"RTN","C0CDACP",284,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.4.14" />
"RTN","C0CDACP",285,0)
 ;;    <id root="d68b7e32-7810-4f5b-9cc2-acd54b0fd85d" />
"RTN","C0CDACP",286,0)
 ;;    <code code="56251003" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED-CT" displayName="Nebulizer Therapy" />
"RTN","C0CDACP",287,0)
 ;;    <statusCode code="completed" />
"RTN","C0CDACP",288,0)
 ;;    <effectiveTime>
"RTN","C0CDACP",289,0)
 ;;      <low value="20150622" />
"RTN","C0CDACP",290,0)
 ;;      <high value="20150622" />
"RTN","C0CDACP",291,0)
 ;;    </effectiveTime>
"RTN","C0CDACP",292,0)
 ;;    <methodCode nullFlavor="UNK" />
"RTN","C0CDACP",293,0)
 ;;    <targetSiteCode code="82094008" displayName="Lower Respiratory Tract Structure" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED-CT" />
"RTN","C0CDACP",294,0)
 ;;  </procedure>
"RTN","C0CDACP",295,0)
 ;;</entry>
"RTN","C0CDACP",296,0)
 Q
"RTN","C0CDACP",297,0)
 ;
"RTN","C0CDACP",298,0)
TPROCBURN ;
"RTN","C0CDACP",299,0)
 ;;<entry typeCode="DRIV">
"RTN","C0CDACP",300,0)
 ;;  <procedure classCode="PROC" moodCode="EVN">
"RTN","C0CDACP",301,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.4.14" extension="2014-06-09" />
"RTN","C0CDACP",302,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.4.14" />
"RTN","C0CDACP",303,0)
 ;;    <id root="d68b7e32-7810-4f5b-9cc2-acd54b0fd85d" />
"RTN","C0CDACP",304,0)
 ;;    <code code="90660004" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED-CT" displayName="Application of Dressing for burn" />
"RTN","C0CDACP",305,0)
 ;;    <statusCode code="completed" />
"RTN","C0CDACP",306,0)
 ;;    <effectiveTime>
"RTN","C0CDACP",307,0)
 ;;      <low value="20150622" />
"RTN","C0CDACP",308,0)
 ;;      <high value="20150622" />
"RTN","C0CDACP",309,0)
 ;;    </effectiveTime>
"RTN","C0CDACP",310,0)
 ;;    <methodCode nullFlavor="UNK" />
"RTN","C0CDACP",311,0)
 ;;    <targetSiteCode code="281737009" displayName="Skin of part of forearm" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED-CT" />
"RTN","C0CDACP",312,0)
 ;;  </procedure>
"RTN","C0CDACP",313,0)
 ;;</entry>
"RTN","C0CDACP",314,0)
 Q
"RTN","C0CDACP",315,0)
 ;
"RTN","C0CDACP",316,0)
TPROCBRON ;
"RTN","C0CDACP",317,0)
 ;;<entry typeCode="DRIV">
"RTN","C0CDACP",318,0)
 ;;  <procedure classCode="PROC" moodCode="EVN">
"RTN","C0CDACP",319,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.4.14" extension="2014-06-09" />
"RTN","C0CDACP",320,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.4.14" />
"RTN","C0CDACP",321,0)
 ;;    <id root="d68b7e32-7810-4f5b-9cc2-acd54b0fd85d" />
"RTN","C0CDACP",322,0)
 ;;    <code code="10847001" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED-CT" displayName="Bronchoscopy" />
"RTN","C0CDACP",323,0)
 ;;    <statusCode code="completed" />
"RTN","C0CDACP",324,0)
 ;;    <effectiveTime>
"RTN","C0CDACP",325,0)
 ;;      <low value="20150622" />
"RTN","C0CDACP",326,0)
 ;;      <high value="20150622" />
"RTN","C0CDACP",327,0)
 ;;    </effectiveTime>
"RTN","C0CDACP",328,0)
 ;;    <methodCode nullFlavor="UNK" />
"RTN","C0CDACP",329,0)
 ;;    <targetSiteCode code="91724006" displayName="Tracheobronchial structure (body structure)" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED-CT" />
"RTN","C0CDACP",330,0)
 ;;  </procedure>
"RTN","C0CDACP",331,0)
 ;;</entry>
"RTN","C0CDACP",332,0)
 Q
"RTN","C0CDACP",333,0)
 ;
"RTN","C0CDACP",334,0)
TPROCCHST ;
"RTN","C0CDACP",335,0)
 ;;<entry typeCode="DRIV">
"RTN","C0CDACP",336,0)
 ;;  <procedure classCode="PROC" moodCode="EVN">
"RTN","C0CDACP",337,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.4.14" extension="2014-06-09" />
"RTN","C0CDACP",338,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.4.14" />
"RTN","C0CDACP",339,0)
 ;;    <id root="d68b7e32-7810-4f5b-9cc2-acd54b0fd85d" />
"RTN","C0CDACP",340,0)
 ;;    <code code="168731009" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED-CT" displayName="Chest X-Ray" />
"RTN","C0CDACP",341,0)
 ;;    <statusCode code="completed" />
"RTN","C0CDACP",342,0)
 ;;    <effectiveTime>
"RTN","C0CDACP",343,0)
 ;;      <low value="20150622" />
"RTN","C0CDACP",344,0)
 ;;      <high value="20150622" />
"RTN","C0CDACP",345,0)
 ;;    </effectiveTime>
"RTN","C0CDACP",346,0)
 ;;    <methodCode nullFlavor="UNK" />
"RTN","C0CDACP",347,0)
 ;;    <targetSiteCode code="82094008" displayName="Lower Respiratory Tract Structure" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED-CT" />
"RTN","C0CDACP",348,0)
 ;;  </procedure>
"RTN","C0CDACP",349,0)
 ;;</entry>
"RTN","C0CDACP",350,0)
 Q
"RTN","C0CDACP",351,0)
 ;
"RTN","C0CDACP",352,0)
TPROCPACE ;
"RTN","C0CDACP",353,0)
 ;;<entry typeCode="DRIV"> 
"RTN","C0CDACP",354,0)
 ;;  <procedure classCode="PROC" moodCode="EVN">
"RTN","C0CDACP",355,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.4.14" extension="2014-06-09" />
"RTN","C0CDACP",356,0)
 ;;    <templateId root="2.16.840.1.113883.10.20.22.4.14" />
"RTN","C0CDACP",357,0)
 ;;    <id root="d68b7e32-7810-4f5b-9cc2-acd54b0fd85e" />
"RTN","C0CDACP",358,0)
 ;;    <code code="175135009" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED-CT" displayName="Introduction of cardiac pacemaker system via vein" />
"RTN","C0CDACP",359,0)
 ;;    <statusCode code="completed" />
"RTN","C0CDACP",360,0)
 ;;    <effectiveTime>
"RTN","C0CDACP",361,0)
 ;;      <low value="20111005" />
"RTN","C0CDACP",362,0)
 ;;      <high value="20111005" />
"RTN","C0CDACP",363,0)
 ;;    </effectiveTime>
"RTN","C0CDACP",364,0)
 ;;    <methodCode nullFlavor="UNK" />
"RTN","C0CDACP",365,0)
 ;;    <targetSiteCode code="9454009" displayName="Structure of subclavian vein" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED-CT" />
"RTN","C0CDACP",366,0)
 ;;<participant typeCode="DEV">
"RTN","C0CDACP",367,0)
 ;;<participantRole classCode="MANU">
"RTN","C0CDACP",368,0)
 ;;<!-- ** Product instance ** -->
"RTN","C0CDACP",369,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.37"/>
"RTN","C0CDACP",370,0)
 ;;<!-- UDI -db -->
"RTN","C0CDACP",371,0)
 ;;<!-- this UDI provided by the test data is not valid as per CDA schema -db -->
"RTN","C0CDACP",372,0)
 ;;<!-- <id root="00643169007222"/> -->
"RTN","C0CDACP",373,0)
 ;;<!-- <id root="d68b7e32-7810-4f5b-9cc2-acd54b0fd85e" extension="00643169007222"/> -->
"RTN","C0CDACP",374,0)
 ;;<!-- root is FDA OID, extension is the UDI id -->
"RTN","C0CDACP",375,0)
 ;;<id root="2.16.840.1.113883.3.3719" extension="(01)00643169007222(17)160128(21)BLC200461H"/>
"RTN","C0CDACP",376,0)
 ;;<playingDevice>
"RTN","C0CDACP",377,0)
 ;;<!-- the actual UDI device -db -->
"RTN","C0CDACP",378,0)
 ;;<code code="704708004" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED-CT" displayName="Cardiac resynchronization therapy implantable pacemaker">
"RTN","C0CDACP",379,0)
 ;;</code>
"RTN","C0CDACP",380,0)
 ;;</playingDevice>
"RTN","C0CDACP",381,0)
 ;;<!-- FDA Scoping Entity OID for UDI-db -->
"RTN","C0CDACP",382,0)
 ;;<scopingEntity>
"RTN","C0CDACP",383,0)
 ;;<id root="2.16.840.1.113883.3.3719"/>
"RTN","C0CDACP",384,0)
 ;;</scopingEntity>
"RTN","C0CDACP",385,0)
 ;;</participantRole>
"RTN","C0CDACP",386,0)
 ;;</participant>
"RTN","C0CDACP",387,0)
 ;;  </procedure>
"RTN","C0CDACP",388,0)
 ;;</entry>
"RTN","C0CDACP",389,0)
 Q
"RTN","C0CDACP",390,0)
 ;
"RTN","C0CDACP",391,0)
TPROCEND ; end of section
"RTN","C0CDACP",392,0)
 ;;</section>
"RTN","C0CDACP",393,0)
 ;;</component>
"RTN","C0CDACP",394,0)
 Q
"RTN","C0CDACP",395,0)
 ;
"RTN","C0CDACP",396,0)
TESTPAT(G) ; test procedures G is passed by reference
"RTN","C0CDACP",397,0)
 S G("results","procedures",1,"procedure","case@value")=7667
"RTN","C0CDACP",398,0)
 S G("results","procedures",1,"procedure","category@value")="RA"
"RTN","C0CDACP",399,0)
 S G("results","procedures",1,"procedure","dateTime@value")=3121130.1117
"RTN","C0CDACP",400,0)
 S G("results","procedures",1,"procedure","facility@code")=195966
"RTN","C0CDACP",401,0)
 S G("results","procedures",1,"procedure","facility@name")=" HOSPITAL"
"RTN","C0CDACP",402,0)
 S G("results","procedures",1,"procedure","hasImages@value")=0
"RTN","C0CDACP",403,0)
 S G("results","procedures",1,"procedure","id@value")="6878869.8882-1"
"RTN","C0CDACP",404,0)
 S G("results","procedures",1,"procedure","imagingType@code")="US"
"RTN","C0CDACP",405,0)
 S G("results","procedures",1,"procedure","imagingType@name")="ULTRASOUND"
"RTN","C0CDACP",406,0)
 S G("results","procedures",1,"procedure","location@code")=143
"RTN","C0CDACP",407,0)
 S G("results","procedures",1,"procedure","location@name")=" HOSP US"
"RTN","C0CDACP",408,0)
 S G("results","procedures",1,"procedure","name@value")=" EXTREMITY VEINS-UNILAT"
"RTN","C0CDACP",409,0)
 S G("results","procedures",1,"procedure","order@code")=2746341
"RTN","C0CDACP",410,0)
 S G("results","procedures",1,"procedure","order@name")=" EXTREMITY VEINS-UNILAT"
"RTN","C0CDACP",411,0)
 S G("results","procedures",1,"procedure","status@value")="WAITING FOR EXAM"
"RTN","C0CDACP",412,0)
 S G("results","procedures",1,"procedure","type@code")=93971
"RTN","C0CDACP",413,0)
 S G("results","procedures",1,"procedure","type@name")="DUPLEX SCAN OF EXTREMITY VEINS INCLUDING RESPONSES TO COMPRESSION AND OTHER MANEUVERS; UNILATERALOR LIMITED STUDY"
"RTN","C0CDACP",414,0)
 S G("results","procedures",2,"procedure","case@value")=7509
"RTN","C0CDACP",415,0)
 S G("results","procedures",2,"procedure","category@value")="RA"
"RTN","C0CDACP",416,0)
 S G("results","procedures",2,"procedure","dateTime@value")=3121129.1532
"RTN","C0CDACP",417,0)
 S G("results","procedures",2,"procedure","facility@code")=195966
"RTN","C0CDACP",418,0)
 S G("results","procedures",2,"procedure","facility@name")=" HOSPITAL"
"RTN","C0CDACP",419,0)
 S G("results","procedures",2,"procedure","hasImages@value")=0
"RTN","C0CDACP",420,0)
 S G("results","procedures",2,"procedure","id@value")="6878870.8467-1"
"RTN","C0CDACP",421,0)
 S G("results","procedures",2,"procedure","imagingType@code")="RAD"
"RTN","C0CDACP",422,0)
 S G("results","procedures",2,"procedure","imagingType@name")="GENERAL RADIOLOGY"
"RTN","C0CDACP",423,0)
 S G("results","procedures",2,"procedure","location@code")=128
"RTN","C0CDACP",424,0)
 S G("results","procedures",2,"procedure","location@name")=" HOSP RADIOLOGY"
"RTN","C0CDACP",425,0)
 S G("results","procedures",2,"procedure","name@value")=" CHEST 2V AP/LAT"
"RTN","C0CDACP",426,0)
 S G("results","procedures",2,"procedure","order@code")=2742586
"RTN","C0CDACP",427,0)
 S G("results","procedures",2,"procedure","order@name")=" CHEST 2V AP/LAT"
"RTN","C0CDACP",428,0)
 S G("results","procedures",2,"procedure","status@value")="WAITING FOR EXAM"
"RTN","C0CDACP",429,0)
 S G("results","procedures",2,"procedure","type@code")=71020
"RTN","C0CDACP",430,0)
 S G("results","procedures",2,"procedure","type@name")="RADIOLOGIC EXAMINATION, CHEST, 2 VIEWS, FRONTAL AND LATERAL;"
"RTN","C0CDACP",431,0)
 S G("results","procedures",3,"procedure","case@value")=7508
"RTN","C0CDACP",432,0)
 S G("results","procedures",3,"procedure","category@value")="RA"
"RTN","C0CDACP",433,0)
 S G("results","procedures",3,"procedure","dateTime@value")=3121129.1529
"RTN","C0CDACP",434,0)
 S G("results","procedures",3,"procedure","facility@code")=195966
"RTN","C0CDACP",435,0)
 S G("results","procedures",3,"procedure","facility@name")=" HOSPITAL"
"RTN","C0CDACP",436,0)
 S G("results","procedures",3,"procedure","hasImages@value")=0
"RTN","C0CDACP",437,0)
 S G("results","procedures",3,"procedure","id@value")="6878870.847-1"
"RTN","C0CDACP",438,0)
 S G("results","procedures",3,"procedure","imagingType@code")="RAD"
"RTN","C0CDACP",439,0)
 S G("results","procedures",3,"procedure","imagingType@name")="GENERAL RADIOLOGY"
"RTN","C0CDACP",440,0)
 S G("results","procedures",3,"procedure","location@code")=128
"RTN","C0CDACP",441,0)
 S G("results","procedures",3,"procedure","location@name")=" HOSP RADIOLOGY"
"RTN","C0CDACP",442,0)
 S G("results","procedures",3,"procedure","name@value")=" CHEST 2V AP/LAT"
"RTN","C0CDACP",443,0)
 S G("results","procedures",3,"procedure","order@code")=2742534
"RTN","C0CDACP",444,0)
 S G("results","procedures",3,"procedure","order@name")=" CHEST 2V AP/LAT"
"RTN","C0CDACP",445,0)
 S G("results","procedures",3,"procedure","status@value")="WAITING FOR EXAM"
"RTN","C0CDACP",446,0)
 S G("results","procedures",3,"procedure","type@code")=71020
"RTN","C0CDACP",447,0)
 S G("results","procedures",3,"procedure","type@name")="RADIOLOGIC EXAMINATION, CHEST, 2 VIEWS, FRONTAL AND LATERAL;"
"RTN","C0CDACP",448,0)
 S G("results","procedures",4,"procedure","case@value")=7353
"RTN","C0CDACP",449,0)
 S G("results","procedures",4,"procedure","category@value")="RA"
"RTN","C0CDACP",450,0)
 S G("results","procedures",4,"procedure","dateTime@value")=3121129.0937
"RTN","C0CDACP",451,0)
 S G("results","procedures",4,"procedure","facility@code")=195966
"RTN","C0CDACP",452,0)
 S G("results","procedures",4,"procedure","facility@name")=" HOSPITAL"
"RTN","C0CDACP",453,0)
 S G("results","procedures",4,"procedure","hasImages@value")=0
"RTN","C0CDACP",454,0)
 S G("results","procedures",4,"procedure","id@value")="6878870.9062-1"
"RTN","C0CDACP",455,0)
 S G("results","procedures",4,"procedure","imagingType@code")="CT"
"RTN","C0CDACP",456,0)
 S G("results","procedures",4,"procedure","imagingType@name")="CT SCAN"
"RTN","C0CDACP",457,0)
 S G("results","procedures",4,"procedure","location@code")=137
"RTN","C0CDACP",458,0)
 S G("results","procedures",4,"procedure","location@name")=" HOSP CT"
"RTN","C0CDACP",459,0)
 S G("results","procedures",4,"procedure","name@value")=" CT ABD/PELVIS W/CONTRAST"
"RTN","C0CDACP",460,0)
 S G("results","procedures",4,"procedure","order@code")=2739412
"RTN","C0CDACP",461,0)
 S G("results","procedures",4,"procedure","order@name")=" CT ABD/PELVIS W/CONTRAST"
"RTN","C0CDACP",462,0)
 S G("results","procedures",4,"procedure","status@value")="WAITING FOR EXAM"
"RTN","C0CDACP",463,0)
 S G("results","procedures",4,"procedure","type@code")=74177
"RTN","C0CDACP",464,0)
 S G("results","procedures",4,"procedure","type@name")="COMPUTED TOMOGRAPHY, ABDOMEN AND PELVIS; WITH CONTRAST MATERIAL(S)"
"RTN","C0CDACP",465,0)
 S G("results","procedures",5,"procedure","case@value")=7183
"RTN","C0CDACP",466,0)
 S G("results","procedures",5,"procedure","category@value")="RA"
"RTN","C0CDACP",467,0)
 S G("results","procedures",5,"procedure","dateTime@value")=3121128.1319
"RTN","C0CDACP",468,0)
 S G("results","procedures",5,"procedure","facility@code")=195966
"RTN","C0CDACP",469,0)
 S G("results","procedures",5,"procedure","facility@name")=" HOSPITAL"
"RTN","C0CDACP",470,0)
 S G("results","procedures",5,"procedure","hasImages@value")=0
"RTN","C0CDACP",471,0)
 S G("results","procedures",5,"procedure","id@value")="6878871.868-1"
"RTN","C0CDACP",472,0)
 S G("results","procedures",5,"procedure","imagingType@code")="CT"
"RTN","C0CDACP",473,0)
 S G("results","procedures",5,"procedure","imagingType@name")="CT SCAN"
"RTN","C0CDACP",474,0)
 S G("results","procedures",5,"procedure","location@code")=137
"RTN","C0CDACP",475,0)
 S G("results","procedures",5,"procedure","location@name")=" HOSP CT"
"RTN","C0CDACP",476,0)
 S G("results","procedures",5,"procedure","name@value")=" CT ABD/PELVIS W/CONTRAST"
"RTN","C0CDACP",477,0)
 S G("results","procedures",5,"procedure","order@code")=2734102
"RTN","C0CDACP",478,0)
 S G("results","procedures",5,"procedure","order@name")=" CT ABD/PELVIS W/CONTRAST"
"RTN","C0CDACP",479,0)
 S G("results","procedures",5,"procedure","status@value")="WAITING FOR EXAM"
"RTN","C0CDACP",480,0)
 S G("results","procedures",5,"procedure","type@code")=74177
"RTN","C0CDACP",481,0)
 S G("results","procedures",5,"procedure","type@name")="COMPUTED TOMOGRAPHY, ABDOMEN AND PELVIS; WITH CONTRAST MATERIAL(S)"
"RTN","C0CDACP",482,0)
 S G("results","procedures",6,"procedure","case@value")=2901
"RTN","C0CDACP",483,0)
 S G("results","procedures",6,"procedure","category@value")="RA"
"RTN","C0CDACP",484,0)
 S G("results","procedures",6,"procedure","dateTime@value")=3121106.1048
"RTN","C0CDACP",485,0)
 S G("results","procedures",6,"procedure","facility@code")=195966
"RTN","C0CDACP",486,0)
 S G("results","procedures",6,"procedure","facility@name")=" HOSPITAL"
"RTN","C0CDACP",487,0)
 S G("results","procedures",6,"procedure","hasImages@value")=0
"RTN","C0CDACP",488,0)
 S G("results","procedures",6,"procedure","id@value")="6878893.8951-1"
"RTN","C0CDACP",489,0)
 S G("results","procedures",6,"procedure","imagingType@code")="RAD"
"RTN","C0CDACP",490,0)
 S G("results","procedures",6,"procedure","imagingType@name")="GENERAL RADIOLOGY"
"RTN","C0CDACP",491,0)
 S G("results","procedures",6,"procedure","location@code")=128
"RTN","C0CDACP",492,0)
 S G("results","procedures",6,"procedure","location@name")=" HOSP RADIOLOGY"
"RTN","C0CDACP",493,0)
 S G("results","procedures",6,"procedure","name@value")=" KNEE 1 OR 2V RT"
"RTN","C0CDACP",494,0)
 S G("results","procedures",6,"procedure","order@code")=2611620
"RTN","C0CDACP",495,0)
 S G("results","procedures",6,"procedure","order@name")=" KNEE 1 OR 2V RT"
"RTN","C0CDACP",496,0)
 S G("results","procedures",6,"procedure","status@value")="WAITING FOR EXAM"
"RTN","C0CDACP",497,0)
 S G("results","procedures",6,"procedure","type@code")=73560
"RTN","C0CDACP",498,0)
 S G("results","procedures",6,"procedure","type@name")="RADIOLOGIC EXAMINATION, KNEE; 1 OR 2 VIEWS"
"RTN","C0CDACP",499,0)
 S G("results","procedures",7,"procedure","case@value")=2899
"RTN","C0CDACP",500,0)
 S G("results","procedures",7,"procedure","category@value")="RA"
"RTN","C0CDACP",501,0)
 S G("results","procedures",7,"procedure","dateTime@value")=3121106.1044
"RTN","C0CDACP",502,0)
 S G("results","procedures",7,"procedure","facility@code")=195966
"RTN","C0CDACP",503,0)
 S G("results","procedures",7,"procedure","facility@name")=" HOSPITAL"
"RTN","C0CDACP",504,0)
 S G("results","procedures",7,"procedure","hasImages@value")=0
"RTN","C0CDACP",505,0)
 S G("results","procedures",7,"procedure","id@value")="6878893.8955-1"
"RTN","C0CDACP",506,0)
 S G("results","procedures",7,"procedure","imagingType@code")="RAD"
"RTN","C0CDACP",507,0)
 S G("results","procedures",7,"procedure","imagingType@name")="GENERAL RADIOLOGY"
"RTN","C0CDACP",508,0)
 S G("results","procedures",7,"procedure","location@code")=128
"RTN","C0CDACP",509,0)
 S G("results","procedures",7,"procedure","location@name")=" HOSP RADIOLOGY"
"RTN","C0CDACP",510,0)
 S G("results","procedures",7,"procedure","name@value")=" FEMUR 2V LT"
"RTN","C0CDACP",511,0)
 S G("results","procedures",7,"procedure","order@code")=2611579
"RTN","C0CDACP",512,0)
 S G("results","procedures",7,"procedure","order@name")=" FEMUR 2V LT"
"RTN","C0CDACP",513,0)
 S G("results","procedures",7,"procedure","status@value")="WAITING FOR EXAM"
"RTN","C0CDACP",514,0)
 S G("results","procedures",7,"procedure","type@code")=73550
"RTN","C0CDACP",515,0)
 S G("results","procedures",7,"procedure","type@name")="RADIOLOGIC EXAMINATION, FEMUR, 2 VIEWS"
"RTN","C0CDACP",516,0)
 S G("results","procedures",8,"procedure","case@value")=2896
"RTN","C0CDACP",517,0)
 S G("results","procedures",8,"procedure","category@value")="RA"
"RTN","C0CDACP",518,0)
 S G("results","procedures",8,"procedure","dateTime@value")=3121106.1034
"RTN","C0CDACP",519,0)
 S G("results","procedures",8,"procedure","facility@code")=195966
"RTN","C0CDACP",520,0)
 S G("results","procedures",8,"procedure","facility@name")=" HOSPITAL"
"RTN","C0CDACP",521,0)
 S G("results","procedures",8,"procedure","hasImages@value")=0
"RTN","C0CDACP",522,0)
 S G("results","procedures",8,"procedure","id@value")="6878893.8965-1"
"RTN","C0CDACP",523,0)
 S G("results","procedures",8,"procedure","imagingType@code")="RAD"
"RTN","C0CDACP",524,0)
 S G("results","procedures",8,"procedure","imagingType@name")="GENERAL RADIOLOGY"
"RTN","C0CDACP",525,0)
 S G("results","procedures",8,"procedure","location@code")=128
"RTN","C0CDACP",526,0)
 S G("results","procedures",8,"procedure","location@name")=" HOSP RADIOLOGY"
"RTN","C0CDACP",527,0)
 S G("results","procedures",8,"procedure","name@value")=" L-S SPINE 2 OR 3V"
"RTN","C0CDACP",528,0)
 S G("results","procedures",8,"procedure","order@code")=2611463
"RTN","C0CDACP",529,0)
 S G("results","procedures",8,"procedure","order@name")=" L-S SPINE 2 OR 3V"
"RTN","C0CDACP",530,0)
 S G("results","procedures",8,"procedure","status@value")="WAITING FOR EXAM"
"RTN","C0CDACP",531,0)
 S G("results","procedures",8,"procedure","type@code")=72100
"RTN","C0CDACP",532,0)
 S G("results","procedures",8,"procedure","type@name")="RADIOLOGIC EXAMINATION, SPINE, LUMBOSACRAL; 2 OR 3 VIEWS"
"RTN","C0CDACP",533,0)
 S G("results","procedures@total")=8
"RTN","C0CDACP",534,0)
 S G("results@timeZone")="-0800"
"RTN","C0CDACP",535,0)
 S G("results@version")=1.1
"RTN","C0CDACP",536,0)
 Q
"RTN","C0CDACP",537,0)
 ;
"RTN","C0CDACP",538,0)
TESTPAT2(G) ; test procedures G is passed by reference
"RTN","C0CDACP",539,0)
 S G("results","procedures",1,"procedure","case@value")=7178
"RTN","C0CDACP",540,0)
 S G("results","procedures",1,"procedure","category@value")="RA"
"RTN","C0CDACP",541,0)
 S G("results","procedures",1,"procedure","dateTime@value")=3121128.1314
"RTN","C0CDACP",542,0)
 S G("results","procedures",1,"procedure","facility@code")=195966
"RTN","C0CDACP",543,0)
 S G("results","procedures",1,"procedure","facility@name")=" HOSPITAL"
"RTN","C0CDACP",544,0)
 S G("results","procedures",1,"procedure","hasImages@value")=0
"RTN","C0CDACP",545,0)
 S G("results","procedures",1,"procedure","id@value")="6878871.8685-1"
"RTN","C0CDACP",546,0)
 S G("results","procedures",1,"procedure","imagingType@code")="CT"
"RTN","C0CDACP",547,0)
 S G("results","procedures",1,"procedure","imagingType@name")="CT SCAN"
"RTN","C0CDACP",548,0)
 S G("results","procedures",1,"procedure","location@code")=137
"RTN","C0CDACP",549,0)
 S G("results","procedures",1,"procedure","location@name")=" HOSP CT"
"RTN","C0CDACP",550,0)
 S G("results","procedures",1,"procedure","name@value")="Unknown"
"RTN","C0CDACP",551,0)
 S G("results","procedures",2,"procedure","case@value")=7177
"RTN","C0CDACP",552,0)
 S G("results","procedures",2,"procedure","category@value")="RA"
"RTN","C0CDACP",553,0)
 S G("results","procedures",2,"procedure","dateTime@value")=3121128.1313
"RTN","C0CDACP",554,0)
 S G("results","procedures",2,"procedure","facility@code")=195966
"RTN","C0CDACP",555,0)
 S G("results","procedures",2,"procedure","facility@name")=" HOSPITAL"
"RTN","C0CDACP",556,0)
 S G("results","procedures",2,"procedure","hasImages@value")=0
"RTN","C0CDACP",557,0)
 S G("results","procedures",2,"procedure","id@value")="6878871.8686-1"
"RTN","C0CDACP",558,0)
 S G("results","procedures",2,"procedure","imagingType@code")="CT"
"RTN","C0CDACP",559,0)
 S G("results","procedures",2,"procedure","imagingType@name")="CT SCAN"
"RTN","C0CDACP",560,0)
 S G("results","procedures",2,"procedure","location@code")=137
"RTN","C0CDACP",561,0)
 S G("results","procedures",2,"procedure","location@name")=" HOSP CT"
"RTN","C0CDACP",562,0)
 S G("results","procedures",2,"procedure","name@value")="Unknown"
"RTN","C0CDACP",563,0)
 S G("results","procedures",3,"procedure","case@value")=7176
"RTN","C0CDACP",564,0)
 S G("results","procedures",3,"procedure","category@value")="RA"
"RTN","C0CDACP",565,0)
 S G("results","procedures",3,"procedure","dateTime@value")=3121128.1312
"RTN","C0CDACP",566,0)
 S G("results","procedures",3,"procedure","facility@code")=195966
"RTN","C0CDACP",567,0)
 S G("results","procedures",3,"procedure","facility@name")=" HOSPITAL"
"RTN","C0CDACP",568,0)
 S G("results","procedures",3,"procedure","hasImages@value")=0
"RTN","C0CDACP",569,0)
 S G("results","procedures",3,"procedure","id@value")="6878871.8687-1"
"RTN","C0CDACP",570,0)
 S G("results","procedures",3,"procedure","imagingType@code")="CT"
"RTN","C0CDACP",571,0)
 S G("results","procedures",3,"procedure","imagingType@name")="CT SCAN"
"RTN","C0CDACP",572,0)
 S G("results","procedures",3,"procedure","location@code")=137
"RTN","C0CDACP",573,0)
 S G("results","procedures",3,"procedure","location@name")=" HOSP CT"
"RTN","C0CDACP",574,0)
 S G("results","procedures",3,"procedure","name@value")="Unknown"
"RTN","C0CDACP",575,0)
 S G("results","procedures",4,"procedure","case@value")=7173
"RTN","C0CDACP",576,0)
 S G("results","procedures",4,"procedure","category@value")="RA"
"RTN","C0CDACP",577,0)
 S G("results","procedures",4,"procedure","dateTime@value")=3121128.131
"RTN","C0CDACP",578,0)
 S G("results","procedures",4,"procedure","facility@code")=195966
"RTN","C0CDACP",579,0)
 S G("results","procedures",4,"procedure","facility@name")=" HOSPITAL"
"RTN","C0CDACP",580,0)
 S G("results","procedures",4,"procedure","hasImages@value")=0
"RTN","C0CDACP",581,0)
 S G("results","procedures",4,"procedure","id@value")="6878871.8689-1"
"RTN","C0CDACP",582,0)
 S G("results","procedures",4,"procedure","imagingType@code")="CT"
"RTN","C0CDACP",583,0)
 S G("results","procedures",4,"procedure","imagingType@name")="CT SCAN"
"RTN","C0CDACP",584,0)
 S G("results","procedures",4,"procedure","location@code")=137
"RTN","C0CDACP",585,0)
 S G("results","procedures",4,"procedure","location@name")=" HOSP CT"
"RTN","C0CDACP",586,0)
 S G("results","procedures",4,"procedure","name@value")="Unknown"
"RTN","C0CDACP",587,0)
 S G("results","procedures",5,"procedure","case@value")=1127
"RTN","C0CDACP",588,0)
 S G("results","procedures",5,"procedure","category@value")="RA"
"RTN","C0CDACP",589,0)
 S G("results","procedures",5,"procedure","dateTime@value")=3121019.1215
"RTN","C0CDACP",590,0)
 S G("results","procedures",5,"procedure","facility@code")=195966
"RTN","C0CDACP",591,0)
 S G("results","procedures",5,"procedure","facility@name")=" HOSPITAL"
"RTN","C0CDACP",592,0)
 S G("results","procedures",5,"procedure","hasImages@value")=0
"RTN","C0CDACP",593,0)
 S G("results","procedures",5,"procedure","id@value")="6878980.8784-1"
"RTN","C0CDACP",594,0)
 S G("results","procedures",5,"procedure","imagingType@code")="RAD"
"RTN","C0CDACP",595,0)
 S G("results","procedures",5,"procedure","imagingType@name")="GENERAL RADIOLOGY"
"RTN","C0CDACP",596,0)
 S G("results","procedures",5,"procedure","location@code")=128
"RTN","C0CDACP",597,0)
 S G("results","procedures",5,"procedure","location@name")=" HOSP RADIOLOGY"
"RTN","C0CDACP",598,0)
 S G("results","procedures",5,"procedure","name@value")="VMI ABD 2V"
"RTN","C0CDACP",599,0)
 S G("results","procedures",5,"procedure","order@code")=2435673
"RTN","C0CDACP",600,0)
 S G("results","procedures",5,"procedure","order@name")="VMI ABD 2V"
"RTN","C0CDACP",601,0)
 S G("results","procedures",5,"procedure","status@value")="WAITING FOR EXAM"
"RTN","C0CDACP",602,0)
 S G("results","procedures",5,"procedure","type@code")=74020
"RTN","C0CDACP",603,0)
 S G("results","procedures",5,"procedure","type@name")="RADIOLOGIC EXAMINATION, ABDOMEN; COMPLETE, INCLUDING DECUBITUS AND/OR ERECT VIEWS"
"RTN","C0CDACP",604,0)
 S G("results","procedures",6,"procedure","case@value")=3
"RTN","C0CDACP",605,0)
 S G("results","procedures",6,"procedure","category@value")="RA"
"RTN","C0CDACP",606,0)
 S G("results","procedures",6,"procedure","dateTime@value")=3121001.1336
"RTN","C0CDACP",607,0)
 S G("results","procedures",6,"procedure","facility@code")=195966
"RTN","C0CDACP",608,0)
 S G("results","procedures",6,"procedure","facility@name")=" HOSPITAL"
"RTN","C0CDACP",609,0)
 S G("results","procedures",6,"procedure","hasImages@value")=0
"RTN","C0CDACP",610,0)
 S G("results","procedures",6,"procedure","id@value")="6878998.8663-1"
"RTN","C0CDACP",611,0)
 S G("results","procedures",6,"procedure","imagingType@code")="RAD"
"RTN","C0CDACP",612,0)
 S G("results","procedures",6,"procedure","imagingType@name")="GENERAL RADIOLOGY"
"RTN","C0CDACP",613,0)
 S G("results","procedures",6,"procedure","location@code")=128
"RTN","C0CDACP",614,0)
 S G("results","procedures",6,"procedure","location@name")=" HOSP RADIOLOGY"
"RTN","C0CDACP",615,0)
 S G("results","procedures",6,"procedure","name@value")="Unknown"
"RTN","C0CDACP",616,0)
 S G("results","procedures",7,"procedure","case@value")=2
"RTN","C0CDACP",617,0)
 S G("results","procedures",7,"procedure","category@value")="RA"
"RTN","C0CDACP",618,0)
 S G("results","procedures",7,"procedure","dateTime@value")=3121001.0815
"RTN","C0CDACP",619,0)
 S G("results","procedures",7,"procedure","facility@code")=195966
"RTN","C0CDACP",620,0)
 S G("results","procedures",7,"procedure","facility@name")=" HOSPITAL"
"RTN","C0CDACP",621,0)
 S G("results","procedures",7,"procedure","hasImages@value")=0
"RTN","C0CDACP",622,0)
 S G("results","procedures",7,"procedure","id@value")="6878998.9184-1"
"RTN","C0CDACP",623,0)
 S G("results","procedures",7,"procedure","imagingType@code")="RAD"
"RTN","C0CDACP",624,0)
 S G("results","procedures",7,"procedure","imagingType@name")="GENERAL RADIOLOGY"
"RTN","C0CDACP",625,0)
 S G("results","procedures",7,"procedure","location@code")=128
"RTN","C0CDACP",626,0)
 S G("results","procedures",7,"procedure","location@name")=" HOSP RADIOLOGY"
"RTN","C0CDACP",627,0)
 S G("results","procedures",7,"procedure","name@value")="Unknown"
"RTN","C0CDACP",628,0)
 S G("results","procedures@total")=7
"RTN","C0CDACP",629,0)
 S G("results@timeZone")="-0800"
"RTN","C0CDACP",630,0)
 S G("results@version")=1.1
"RTN","C0CDACP",631,0)
 Q
"RTN","C0CDACP",632,0)
 ;
"RTN","C0CDACT")
0^18^B85720702
"RTN","C0CDACT",1,0)
C0CDACT ; GPL - Patient Portal - CCDA Routines ;09/23/13  17:05
"RTN","C0CDACT",2,0)
 ;;0.1;JJOHPP;nopatch;noreleasedate;Build 1
"RTN","C0CDACT",3,0)
 ;
"RTN","C0CDACT",4,0)
 ; License AGPL v3.0
"RTN","C0CDACT",5,0)
 ; 
"RTN","C0CDACT",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDACT",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDACT",8,0)
 ;
"RTN","C0CDACT",9,0)
 Q
"RTN","C0CDACT",10,0)
 ;
"RTN","C0CDACT",11,0)
DOCS(BLIST,DFN,CCDAWRK,CCDARPT,CCDACTRL) ;
"RTN","C0CDACT",12,0)
 ;
"RTN","C0CDACT",13,0)
 N CCDAV,CCDAV1,PARMS,HAVDTS,NTCNT
"RTN","C0CDACT",14,0)
 S NTCNT=0
"RTN","C0CDACT",15,0)
 I $D(@CCDACTRL@("PARMS")) M PARMS=@CCDACTRL@("PARMS")
"RTN","C0CDACT",16,0)
 S HAVDTS=0
"RTN","C0CDACT",17,0)
 I $D(PARMS("startDateTime")) S HAVDTS=1
"RTN","C0CDACT",18,0)
 N STRT,STOP
"RTN","C0CDACT",19,0)
 S STRT=$G(PARMS("startDateTime"))
"RTN","C0CDACT",20,0)
 S STOP=$G(PARMS("endDateTime"))
"RTN","C0CDACT",21,0)
 S @CCDARPT@("STATUS")="EXTRACTING"
"RTN","C0CDACT",22,0)
 S @CCDARPT@("EXTRACT-BEGIN")=$$NOW^XLFDT
"RTN","C0CDACT",23,0)
 D GETPAT^C0CDACE(.CCDAV1,DFN,"documents",STRT,STOP)
"RTN","C0CDACT",24,0)
 N DOINGALL S DOINGALL=0
"RTN","C0CDACT",25,0)
 I +$G(CCDAV1("results","documents@total"))=0 D  ;
"RTN","C0CDACT",26,0)
 . S DOINGALL=1
"RTN","C0CDACT",27,0)
 . D GETPAT^C0CDACE(.CCDAV1,DFN,"documents") ; retrieve all documents
"RTN","C0CDACT",28,0)
 I '$D(CCDAV1) Q  ;
"RTN","C0CDACT",29,0)
 I CCDAV1("results","documents@total")=0 Q  ;
"RTN","C0CDACT",30,0)
 I CCDAV1("results","documents@total")=1 D  ;
"RTN","C0CDACT",31,0)
 . M CCDAV(1)=CCDAV1("results","documents")
"RTN","C0CDACT",32,0)
 E  M CCDAV=CCDAV1("results","documents")
"RTN","C0CDACT",33,0)
 S @CCDARPT@("EXTRACT-ENDS")=$$NOW^XLFDT
"RTN","C0CDACT",34,0)
 ;
"RTN","C0CDACT",35,0)
 ; deterimine if there are documents in the date range
"RTN","C0CDACT",36,0)
 ;
"RTN","C0CDACT",37,0)
 N HAVEDOCS S HAVEDOCS=1
"RTN","C0CDACT",38,0)
 I HAVDTS=1 D  ; we have requested dates
"RTN","C0CDACT",39,0)
 . Q:DOINGALL
"RTN","C0CDACT",40,0)
 . S HAVEDOCS=0 ; assume no docs in date range
"RTN","C0CDACT",41,0)
 . N C0I S C0I=0
"RTN","C0CDACT",42,0)
 . F  S C0I=$O(CCDAV(C0I)) Q:HAVEDOCS  Q:+C0I=0  D  ;
"RTN","C0CDACT",43,0)
 . . N C0DATE S C0DATE=$G(CCDAV(C0I,"document","referenceDateTime@value"))
"RTN","C0CDACT",44,0)
 . . I $$SKIP^C0CDACV(C0DATE,.PARMS)=0 S HAVEDOCS=1
"RTN","C0CDACT",45,0)
 I $D(C0DEBUG) I 'HAVEDOCS W !,"NO DOCUMENTS"
"RTN","C0CDACT",46,0)
 Q:'HAVEDOCS
"RTN","C0CDACT",47,0)
 N ADVCNT,DISCNT,POCCNT,FUNCNT ; counts for Discharge, Plan of Care, Func Stat
"RTN","C0CDACT",48,0)
 S ADVCNT=0,DISCNT=0,POCCNT=0,FUNCNT=0
"RTN","C0CDACT",49,0)
 N DOCTBL S DOCTBL=$NA(@CCDACTRL@("DOCUMENTS"))
"RTN","C0CDACT",50,0)
 D PROCESS ; process this group of extracted documents
"RTN","C0CDACT",51,0)
 D PROCTEAM ; process care team members
"RTN","C0CDACT",52,0)
 Q
"RTN","C0CDACT",53,0)
 ; code below has been cut out because it was causing duplicates in CCD mode
"RTN","C0CDACT",54,0)
 I ((ADVCNT=0)!(FUNCNT=0)) D  ; look for required document types 
"RTN","C0CDACT",55,0)
 . ;outside the data range
"RTN","C0CDACT",56,0)
 . Q:DOINGALL
"RTN","C0CDACT",57,0)
 . S DOINGALL=1 ; doing all this time for entire record
"RTN","C0CDACT",58,0)
 . ;I $G(PARMS("NOTES"))="ALL" Q  ; don't do all twice 
"RTN","C0CDACT",59,0)
 . D GETPAT^C0CDACE(.CCDAV1,DFN,"documents") ; get all documents
"RTN","C0CDACT",60,0)
 . I '$D(CCDAV1) Q  ;
"RTN","C0CDACT",61,0)
 . I CCDAV1("results","documents@total")=0 Q  ;
"RTN","C0CDACT",62,0)
 . I CCDAV1("results","documents@total")=1 D  ;
"RTN","C0CDACT",63,0)
 . . M CCDAV(1)=CCDAV1("results","documents")
"RTN","C0CDACT",64,0)
 . E  M CCDAV=CCDAV1("results","documents")
"RTN","C0CDACT",65,0)
 . S @CCDARPT@("EXTRACT-ENDS")=$$NOW^XLFDT
"RTN","C0CDACT",66,0)
 . D PROCESS ; process all of the documents
"RTN","C0CDACT",67,0)
 Q
"RTN","C0CDACT",68,0)
 ;
"RTN","C0CDACT",69,0)
PROCESS ;
"RTN","C0CDACT",70,0)
 N C0I S C0I=0
"RTN","C0CDACT",71,0)
 F  S C0I=$O(CCDAV(C0I)) Q:+C0I=0  D  ;
"RTN","C0CDACT",72,0)
 . N C0DATE S C0DATE=$G(CCDAV(C0I,"document","referenceDateTime@value"))
"RTN","C0CDACT",73,0)
 . ;I $$SKIP^C0CDACV(C0DATE,.PARMS)=0 Q  ;
"RTN","C0CDACT",74,0)
 . N URI S URI="uri_note_"_$G(CCDAV(C0I,"document","id@value"))
"RTN","C0CDACT",75,0)
 . S C0ARY(C0I,"URI")=URI
"RTN","C0CDACT",76,0)
 . Q:$$REDACT^C0CDACV(URI,.PARMS)
"RTN","C0CDACT",77,0)
 . N NATTYPE,NATTIT,NATSUB,LOCTIT,DOCCLASS
"RTN","C0CDACT",78,0)
 . S DOCCLASS=$G(CCDAV(C0I,"document","documentClass@value"))
"RTN","C0CDACT",79,0)
 . S LOCTIT=$G(CCDAV(C0I,"document","localTitle@value"))
"RTN","C0CDACT",80,0)
 . S NATTIT=$G(CCDAV(C0I,"document","nationalTitle@name"))
"RTN","C0CDACT",81,0)
 . S NATTYPE=$G(CCDAV(C0I,"document","nationalTitleSubject@name"))
"RTN","C0CDACT",82,0)
 . S NATSUB=$G(CCDAV(C0I,"document","nationalTitleType@name"))
"RTN","C0CDACT",83,0)
 . M @DOCTBL@(C0I)=CCDAV(C0I,"document")
"RTN","C0CDACT",84,0)
 . S:DOCCLASS'="" @DOCTBL@("TITLES",DOCCLASS,C0I)=""
"RTN","C0CDACT",85,0)
 . S:LOCTIT'="" @DOCTBL@("TITLES",LOCTIT,C0I)=""
"RTN","C0CDACT",86,0)
 . S:NATTIT'="" @DOCTBL@("TITLES",NATTIT,C0I)=""
"RTN","C0CDACT",87,0)
 . S:NATTYPE'="" @DOCTBL@("TITLES",NATTYPE,C0I)=""
"RTN","C0CDACT",88,0)
 . S:NATSUB'="" @DOCTBL@("TITLES",NATSUB,C0I)=""
"RTN","C0CDACT",89,0)
 . N ZTXT,ZIEN,C0ARY
"RTN","C0CDACT",90,0)
 . S ZIEN=$G(CCDAV(C0I,"document","id@value"))
"RTN","C0CDACT",91,0)
 . Q:ZIEN=""
"RTN","C0CDACT",92,0)
 . N UTIT,TITYPE,UTEMP
"RTN","C0CDACT",93,0)
 . S UTEMP="TNOTESEC^C0CDACT"
"RTN","C0CDACT",94,0)
 . S TITYPE="Note" ; prefix for the note title
"RTN","C0CDACT",95,0)
 . ;S TITYPE="" ; prefix for the note title
"RTN","C0CDACT",96,0)
 . D  ; convert local title to uppercase and store in UTIT
"RTN","C0CDACT",97,0)
 . . N X,Y
"RTN","C0CDACT",98,0)
 . . S X=LOCTIT
"RTN","C0CDACT",99,0)
 . . X ^%ZOSF("UPPERCASE")
"RTN","C0CDACT",100,0)
 . . S UTIT=Y
"RTN","C0CDACT",101,0)
 . I $G(PARMS("NOTES"))="" S PARMS("NOTES")="CCD"
"RTN","C0CDACT",102,0)
 . I UTIT["CCD" D  ; this is a CCD template
"RTN","C0CDACT",103,0)
 . . S UTEMP="TNOTESEC^C0CDAC9" ; 
"RTN","C0CDACT",104,0)
 . . S UTIT=$P(UTIT,"-CCD",1)
"RTN","C0CDACT",105,0)
 . . S TITYPE="CCD"
"RTN","C0CDACT",106,0)
 . I UTIT["DISCHARGE" D  ; this is a discharge component
"RTN","C0CDACT",107,0)
 . . I TITYPE="CCD" Q  ;
"RTN","C0CDACT",108,0)
 . . I $G(PARMS("NOTES"))'="ALL" I DISCNT>0 Q  ; only one allowed
"RTN","C0CDACT",109,0)
 . . I DOINGALL&DISCNT>0 Q  ; 
"RTN","C0CDACT",110,0)
 . . S TITYPE="Discharge-"
"RTN","C0CDACT",111,0)
 . . S UTEMP="TDISSEC^C0CDAC9" ; discharge template
"RTN","C0CDACT",112,0)
 . . S DISCNT=DISCNT+1
"RTN","C0CDACT",113,0)
 . I ((UTIT["PLAN OF CARE")!(UTIT["CARE PLAN")) D  ; 
"RTN","C0CDACT",114,0)
 . . I TITYPE="CCD" Q  ;
"RTN","C0CDACT",115,0)
 . . I $G(PARMS("NOTES"))'="ALL" I POCCNT>0 Q  ; only one allowed
"RTN","C0CDACT",116,0)
 . . I DOINGALL&POCCNT>0 Q  ; 
"RTN","C0CDACT",117,0)
 . . S TITYPE="Plan of Care-"
"RTN","C0CDACT",118,0)
 . . S UTEMP="TPLOCSEC^C0CDAC9" ; 
"RTN","C0CDACT",119,0)
 . . S POCCNT=POCCNT+1
"RTN","C0CDACT",120,0)
 . I ((UTIT["FUNCTION")!(UTIT["FUNCTION")) D  ; 
"RTN","C0CDACT",121,0)
 . . I TITYPE="CCD" Q  ;
"RTN","C0CDACT",122,0)
 . . I $G(PARMS("NOTES"))'="ALL" I FUNCNT>0 Q  ; only one allowed
"RTN","C0CDACT",123,0)
 . . I DOINGALL&FUNCNT>0 Q  ; 
"RTN","C0CDACT",124,0)
 . . S TITYPE="Functional Status - "
"RTN","C0CDACT",125,0)
 . . S UTEMP="TFUNCSEC^C0CDAC9" ; 
"RTN","C0CDACT",126,0)
 . . S FUNCNT=FUNCNT+1
"RTN","C0CDACT",127,0)
 . I UTIT["ADVANCE DIRECTIVE" D  ; 
"RTN","C0CDACT",128,0)
 . . I TITYPE="CCD" Q  ;
"RTN","C0CDACT",129,0)
 . . I $G(PARMS("NOTES"))'="ALL" I ADVCNT>0 Q  ; only one allowed
"RTN","C0CDACT",130,0)
 . . I DOINGALL&ADVCNT>0 Q  ; 
"RTN","C0CDACT",131,0)
 . . S TITYPE="Advance Directives-"
"RTN","C0CDACT",132,0)
 . . S UTEMP="TADVDSEC^C0CDAC9" ; 
"RTN","C0CDACT",133,0)
 . . S ADVCNT=ADVCNT+1
"RTN","C0CDACT",134,0)
 . I UTIT["CLINICAL SUMMARY" D  ; 
"RTN","C0CDACT",135,0)
 . . I TITYPE="CCD" Q  ;
"RTN","C0CDACT",136,0)
 . . Q:DOINGALL  ; don't generate if out of date range
"RTN","C0CDACT",137,0)
 . . S TITYPE="Clinical Summary-"
"RTN","C0CDACT",138,0)
 . . S UTEMP="TNOTESEC^C0CDAC9" ; 
"RTN","C0CDACT",139,0)
 . Q:((DOINGALL)&(TITYPE="Note"))  ; means we are scanning for 
"RTN","C0CDACT",140,0)
 . ; special titles only (handled above)
"RTN","C0CDACT",141,0)
 . I $G(PARMS("NOTES"))'="ALL" I TITYPE="Note" Q  ; skip if not notes=all
"RTN","C0CDACT",142,0)
 . I $G(PARMS("NOTES"))="CCD" I TITYPE'="CCD" Q  ; skip if not a CCD and we are in CCD mode
"RTN","C0CDACT",143,0)
 . I TITYPE="CCD" S TITYPE=""
"RTN","C0CDACT",144,0)
 . I LOCTIT["CCD" S LOCTIT=$P(LOCTIT,"-CCD",1)
"RTN","C0CDACT",145,0)
 . S C0ARY("text",1)="<title>"_TITYPE_" "_$$CHARCHK^MXMLBLD(LOCTIT)_"</title>"
"RTN","C0CDACT",146,0)
 . S C0ARY("text",2)="<text ID="""_URI_""">"
"RTN","C0CDACT",147,0)
 . D GETNOTE("ZTXT",ZIEN)
"RTN","C0CDACT",148,0)
 . N ZJ S ZJ=0
"RTN","C0CDACT",149,0)
 . S C0ARY("text",3)="<list>"
"RTN","C0CDACT",150,0)
 . S C0ARY("text",4)="<item>"_$$FMTE^XLFDT(C0DATE)_"</item>"
"RTN","C0CDACT",151,0)
 . B:$G(C0DEBUG)
"RTN","C0CDACT",152,0)
 . N ZTXT2,%ZT S %ZT=0
"RTN","C0CDACT",153,0)
 . F  S %ZT=$O(ZTXT(%ZT)) Q:+%ZT=0  S ZTXT2(%ZT,0)=ZTXT(%ZT) ; convert to WP format
"RTN","C0CDACT",154,0)
 . D HTML2TXT^TMGHTM1(.ZTXT2)
"RTN","C0CDACT",155,0)
 . K ZTXT F  S %ZT=$O(ZTXT2(%ZT)) Q:+%ZT=0  S ZTXT(%ZT)=ZTXT2(%ZT,0) ; convert from WP format 
"RTN","C0CDACT",156,0)
 . F  S ZJ=$O(ZTXT(ZJ)) Q:+ZJ=0  D  ;
"RTN","C0CDACT",157,0)
 . . ;I ((ZIEN=1169180)&(ZJ=31)) Q  ; there is garbage on this node
"RTN","C0CDACT",158,0)
 . . N OK,%C0 S %C0=ZTXT(ZJ)
"RTN","C0CDACT",159,0)
 . . ;S OK=$$UNHTML(.%C0) ; remove html markup
"RTN","C0CDACT",160,0)
 . . S ZTXT(ZJ)=%C0
"RTN","C0CDACT",161,0)
 . . S C0ARY("text",ZJ+4)="<item>"_$$CLEAN2^C0CDACE($$CHARCHK^MXMLBLD(ZTXT(ZJ)))_"</item>"
"RTN","C0CDACT",162,0)
 . N ZEND S ZEND=$O(ZTXT(" "),-1)+4
"RTN","C0CDACT",163,0)
 . S C0ARY("text",ZEND+1)="</list>"
"RTN","C0CDACT",164,0)
 . S C0ARY("text",ZEND+2)="</text>"
"RTN","C0CDACT",165,0)
 . S NTCNT=NTCNT+1
"RTN","C0CDACT",166,0)
 . N SSECT S SSECT=$NA(@CCDAWRK@("DOCSECT"_NTCNT))
"RTN","C0CDACT",167,0)
 . D GNMAPWP^C0CDACU(SSECT,UTEMP,"C0ARY")
"RTN","C0CDACT",168,0)
 . D QUEUE^MXMLTMPL(BLIST,SSECT,1,@SSECT@(0))
"RTN","C0CDACT",169,0)
 ;B
"RTN","C0CDACT",170,0)
 Q
"RTN","C0CDACT",171,0)
 ;
"RTN","C0CDACT",172,0)
PROCTEAM ; process list of team members
"RTN","C0CDACT",173,0)
 ;
"RTN","C0CDACT",174,0)
 N NAMES,NAME,CDUZ,CVARS,CADDR
"RTN","C0CDACT",175,0)
 N C0I S C0I=0
"RTN","C0CDACT",176,0)
 F  S C0I=$O(CCDAV(C0I)) Q:+C0I=0  D  ;
"RTN","C0CDACT",177,0)
 . N GN S GN=$NA(CCDAV(C0I,"document","clinicians"))
"RTN","C0CDACT",178,0)
 . N C0J S C0J=0
"RTN","C0CDACT",179,0)
 . F  S C0J=$O(@GN@(C0J)) Q:+C0J=0  D  ;
"RTN","C0CDACT",180,0)
 . . S NAME=$G(@GN@(C0J,"clinician@name"))
"RTN","C0CDACT",181,0)
 . . Q:NAME=""
"RTN","C0CDACT",182,0)
 . . S NAMES(NAME)=""
"RTN","C0CDACT",183,0)
 . . S NAMES(NAME,"DUZ")=$G(@GN@(C0J,"clinician@code"))
"RTN","C0CDACT",184,0)
 S C0ARY("text",1)="<title>CARE TEAM MEMBERS</title>"
"RTN","C0CDACT",185,0)
 S C0ARY("text",2)="<text ID=""CARE-TEAM-1"">"
"RTN","C0CDACT",186,0)
 S C0ARY("text",3)="<list>"
"RTN","C0CDACT",187,0)
 N C0N S C0N=3
"RTN","C0CDACT",188,0)
 N C0K S C0K=""
"RTN","C0CDACT",189,0)
 F  S C0K=$O(NAMES(C0K)) Q:C0K=""  D  ;
"RTN","C0CDACT",190,0)
 . S C0N=C0N+1
"RTN","C0CDACT",191,0)
 . S CDUZ=$G(NAMES(C0K,"DUZ"))
"RTN","C0CDACT",192,0)
 . I CDUZ'="" D  ;
"RTN","C0CDACT",193,0)
 . . K CADDR,CVARS
"RTN","C0CDACT",194,0)
 . . S CADDR=$$CLINADDR(CDUZ,"CVARS")
"RTN","C0CDACT",195,0)
 . S C0ARY("text",C0N)="<item>"_C0K_" "_CADDR_"</item>"
"RTN","C0CDACT",196,0)
 S C0ARY("text",C0N+1)="</list>"
"RTN","C0CDACT",197,0)
 S C0ARY("text",C0N+2)="</text>"
"RTN","C0CDACT",198,0)
 ;ZWR NAMES
"RTN","C0CDACT",199,0)
 S UTEMP="TNOTESEC^C0CDAC9" ;
"RTN","C0CDACT",200,0)
 S UTIT="CARE TEAM MEMBERS"
"RTN","C0CDACT",201,0)
 S TITYPE="TEAM"
"RTN","C0CDACT",202,0)
 S NTCNT=NTCNT+1
"RTN","C0CDACT",203,0)
 N SSECT S SSECT=$NA(@CCDAWRK@("DOCSECT"_NTCNT))
"RTN","C0CDACT",204,0)
 D GNMAPWP^C0CDACU(SSECT,UTEMP,"C0ARY")
"RTN","C0CDACT",205,0)
 D QUEUE^MXMLTMPL(BLIST,SSECT,1,@SSECT@(0))
"RTN","C0CDACT",206,0)
 Q
"RTN","C0CDACT",207,0)
 ;
"RTN","C0CDACT",208,0)
CLINADDR(CDUZ,ZVARS) ; extrinsic returns the address and phone number of a clinician as a string
"RTN","C0CDACT",209,0)
 ; ZVARS is passed by name and contains the new person record for the DUZ
"RTN","C0CDACT",210,0)
 Q:$G(CDUZ)=""
"RTN","C0CDACT",211,0)
 D FMX^C0CDACU(ZVARS,200,CDUZ)
"RTN","C0CDACT",212,0)
 N TRTN S TRTN=""
"RTN","C0CDACT",213,0)
 S TRTN=TRTN_$G(@ZVARS@("NEW_PERSON","STREET_ADDRESS_1"))
"RTN","C0CDACT",214,0)
 S TRTN=TRTN_", "_$G(@ZVARS@("NEW_PERSON","CITY"))
"RTN","C0CDACT",215,0)
 S TRTN=TRTN_","_$G(@ZVARS@("NEW_PERSON","STATE"))
"RTN","C0CDACT",216,0)
 S TRTN=TRTN_" "_$G(@ZVARS@("NEW_PERSON","ZIP_CODE"))
"RTN","C0CDACT",217,0)
 S TRTN=TRTN_" Phone: "_$G(@ZVARS@("NEW_PERSON","OFFICE_PHONE"))
"RTN","C0CDACT",218,0)
 ;
"RTN","C0CDACT",219,0)
 q TRTN
"RTN","C0CDACT",220,0)
 ;
"RTN","C0CDACT",221,0)
UNHTML(LN) ; line passed by reference - removes HTML markup 
"RTN","C0CDACT",222,0)
 ; use HTML2TXT^TMGHTM1 if available instead of this
"RTN","C0CDACT",223,0)
 ; extrinsic return 0 if no markup
"RTN","C0CDACT",224,0)
 ; recursive to remove all the markup in the line
"RTN","C0CDACT",225,0)
 N C0LOC1,C0LOC2,C0TMP,OK,BEFORE,AFTER
"RTN","C0CDACT",226,0)
 I LN'["<" Q 0  ; exit condition - no markup on the line
"RTN","C0CDACT",227,0)
 S C0LOC1=$F(LN,"<")
"RTN","C0CDACT",228,0)
 S C0LOC2=$F(LN,">")
"RTN","C0CDACT",229,0)
 S C0TMP=LN
"RTN","C0CDACT",230,0)
 I C0LOC1=2 D  ;
"RTN","C0CDACT",231,0)
 . S BEFORE=""
"RTN","C0CDACT",232,0)
 E  S BEFORE=$E(C0TMP,1,C0LOC1-2)
"RTN","C0CDACT",233,0)
 I C0LOC2=$L(C0TMP) S AFTER=""
"RTN","C0CDACT",234,0)
 E  S AFTER=$E(C0TMP,C0LOC2,$L(C0TMP))
"RTN","C0CDACT",235,0)
 S LN=BEFORE_AFTER
"RTN","C0CDACT",236,0)
 S OK=$$UNHTML(.LN)
"RTN","C0CDACT",237,0)
 Q 1
"RTN","C0CDACT",238,0)
 ;
"RTN","C0CDACT",239,0)
GETNOTE(RTN,ZIEN) ; retrieve the text of a note by ien
"RTN","C0CDACT",240,0)
 ; RTN is passed by name
"RTN","C0CDACT",241,0)
 N OK
"RTN","C0CDACT",242,0)
 S OK=$$GET1^DIQ(8925,ZIEN_",",2,,RTN)
"RTN","C0CDACT",243,0)
 Q
"RTN","C0CDACT",244,0)
 ;
"RTN","C0CDACT",245,0)
GETIENS(RTN,ZARY) ; RTN is passed by reference, ZARY by name
"RTN","C0CDACT",246,0)
 ;
"RTN","C0CDACT",247,0)
 N ZI S ZI=""
"RTN","C0CDACT",248,0)
 F  S ZI=$O(@ZARY@(ZI)) Q:+ZI=0  D  ;
"RTN","C0CDACT",249,0)
 . S RTN(ZI)=$G(@ZARY@(ZI,"id@value"))
"RTN","C0CDACT",250,0)
 ;ZWR RTN
"RTN","C0CDACT",251,0)
 Q 
"RTN","C0CDACT",252,0)
 ;
"RTN","C0CDACT",253,0)
GETALL(RTN,ZIENS) ; RTN passed by name ZIENS passed by reference
"RTN","C0CDACT",254,0)
 N ZI S ZI=""
"RTN","C0CDACT",255,0)
 F  S ZI=$O(ZIENS(ZI)) Q:+ZI=0  D  ;
"RTN","C0CDACT",256,0)
 . D GETNOTE($NA(@RTN@(ZI)),ZIENS(ZI))
"RTN","C0CDACT",257,0)
 ZWR @RTN
"RTN","C0CDACT",258,0)
 Q
"RTN","C0CDACT",259,0)
 ;
"RTN","C0CDACT",260,0)
TNOTESEC ;
"RTN","C0CDACT",261,0)
 ;;<component>
"RTN","C0CDACT",262,0)
 ;;<section>
"RTN","C0CDACT",263,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.45"></templateId>
"RTN","C0CDACT",264,0)
 ;;<id root="184fdbe3-f480-4199-976d-e0bb0dd02551"></id>
"RTN","C0CDACT",265,0)
 ;;<code code="69730-0" codeSystem="2.16.840.1.113883.6.1" codeSystemVersion="LOINC" displayName="Instructions"></code>
"RTN","C0CDACT",266,0)
 ;;@@text@@
"RTN","C0CDACT",267,0)
 ;;</section>
"RTN","C0CDACT",268,0)
 ;;</component>
"RTN","C0CDACT",269,0)
 Q
"RTN","C0CDACT",270,0)
 ;
"RTN","C0CDACT",271,0)
ANALYZE ; find test patients with necessary note titles
"RTN","C0CDACT",272,0)
 ;
"RTN","C0CDACT",273,0)
 Q
"RTN","C0CDACT",274,0)
 ;
"RTN","C0CDACU")
0^19^B104681872
"RTN","C0CDACU",1,0)
C0CDACU ; GPL - Patient Portal - CCDA Utility Routines ;8/29/13  17:05
"RTN","C0CDACU",2,0)
 ;;0.1;C0CDA;nopatch;noreleasedate;Build 1
"RTN","C0CDACU",3,0)
 ;
"RTN","C0CDACU",4,0)
 ; License Affero GPL V3
"RTN","C0CDACU",5,0)
 ; 
"RTN","C0CDACU",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDACU",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDACU",8,0)
 ;
"RTN","C0CDACU",9,0)
 Q
"RTN","C0CDACU",10,0)
 ;
"RTN","C0CDACU",11,0)
UNJSON(IN,OUT) ; assemble json from global and then decode into OUT 
"RTN","C0CDACU",12,0)
 ; IN and OUT are passed by name
"RTN","C0CDACU",13,0)
 Q:'$D(@IN)
"RTN","C0CDACU",14,0)
 N %,%1,%J,ERR
"RTN","C0CDACU",15,0)
 S (%,%1,%J)=""
"RTN","C0CDACU",16,0)
 F  S %=$O(@IN@(%)) Q:%=""  D  ;
"RTN","C0CDACU",17,0)
 . S %J=%J_$G(@IN@(%))
"RTN","C0CDACU",18,0)
 . F  S %1=$O(@IN@(%,%1)) Q:%1=""  D  ;
"RTN","C0CDACU",19,0)
 . . S %J=%J_$G(@IN@(%,%1))
"RTN","C0CDACU",20,0)
 D DECODE^HMPJSON("%J",OUT,"ERR")
"RTN","C0CDACU",21,0)
 Q
"RTN","C0CDACU",22,0)
 ;
"RTN","C0CDACU",23,0)
GETNMAP(OUTXML,INXML,IARY) ; Retrieves XML stored in Mumps routines and maps
"RTN","C0CDACU",24,0)
 ; them using IARY, passed by name. Maps use @@var@@ protocol
"RTN","C0CDACU",25,0)
 ; with @IARY@("var")=value for the map values
"RTN","C0CDACU",26,0)
 ; OUTXML is passed by name and will hold the result
"RTN","C0CDACU",27,0)
 ; INXML is the name of the storage place ie "HEADER^C0CDAC2"
"RTN","C0CDACU",28,0)
 N GTAG,GRT,GI
"RTN","C0CDACU",29,0)
 S GTAG=$P(INXML,"^",1)
"RTN","C0CDACU",30,0)
 S GRT=$P(INXML,"^",2)
"RTN","C0CDACU",31,0)
 ; first get all of the lines of the XML
"RTN","C0CDACU",32,0)
 N TXML ; temp var for xml
"RTN","C0CDACU",33,0)
 S GN=1
"RTN","C0CDACU",34,0)
 F  S GI=GTAG_"+"_GN_"^"_GRT  Q:$T(@GI)'[";;"  D  ;
"RTN","C0CDACU",35,0)
 . S TXML(GN)=$P($T(@GI),";;",2)
"RTN","C0CDACU",36,0)
 . I $G(CCDADEBUG) W !,GN," ",TXML(GN)
"RTN","C0CDACU",37,0)
 . S GN=GN+1
"RTN","C0CDACU",38,0)
 ; next call MAP to resolve mappings and place result directly in OUTXML
"RTN","C0CDACU",39,0)
 D MAP^MXMLTMPL("TXML",IARY,OUTXML)
"RTN","C0CDACU",40,0)
 Q
"RTN","C0CDACU",41,0)
 ;
"RTN","C0CDACU",42,0)
GNMAPWP(OUTXML,INXML,IARY) ; Retrieves XML stored in Mumps routines and maps
"RTN","C0CDACU",43,0)
 ; them using IARY, passed by name. Maps use @@var@@ protocol
"RTN","C0CDACU",44,0)
 ; with @IARY@("var")=value for the map values
"RTN","C0CDACU",45,0)
 ; OUTXML is passed by name and will hold the result
"RTN","C0CDACU",46,0)
 ; INXML is the name of the storage place ie "HEADER^C0CDAC2"
"RTN","C0CDACU",47,0)
 N GTAG,GRT,GI
"RTN","C0CDACU",48,0)
 S GTAG=$P(INXML,"^",1)
"RTN","C0CDACU",49,0)
 S GRT=$P(INXML,"^",2)
"RTN","C0CDACU",50,0)
 ; first get all of the lines of the XML
"RTN","C0CDACU",51,0)
 N TXML ; temp var for xml
"RTN","C0CDACU",52,0)
 S GN=1
"RTN","C0CDACU",53,0)
 F  S GI=GTAG_"+"_GN_"^"_GRT  Q:$T(@GI)'[";;"  D  ;
"RTN","C0CDACU",54,0)
 . S TXML(GN)=$P($T(@GI),";;",2)
"RTN","C0CDACU",55,0)
 . I $G(CCDADEBUG) W !,GN," ",TXML(GN)
"RTN","C0CDACU",56,0)
 . S GN=GN+1
"RTN","C0CDACU",57,0)
 ; 
"RTN","C0CDACU",58,0)
 ; unlike GETNMAP above, this routine supports one multi-line text
"RTN","C0CDACU",59,0)
 ; field per xml template. it is on it's own line and marked like @@var@@
"RTN","C0CDACU",60,0)
 ; the array should have the text lines as var(1) var(2) etc
"RTN","C0CDACU",61,0)
 ;
"RTN","C0CDACU",62,0)
 ;
"RTN","C0CDACU",63,0)
 N ZI,LIN S ZI=0 S LIN=1
"RTN","C0CDACU",64,0)
 F  S ZI=$O(TXML(ZI)) Q:+ZI=0  D  ;
"RTN","C0CDACU",65,0)
 . I TXML(ZI)'["@@" S @OUTXML@(LIN)=TXML(ZI) S LIN=LIN+1 Q  ;
"RTN","C0CDACU",66,0)
 . N VAR
"RTN","C0CDACU",67,0)
 . S VAR=$P($P(TXML(ZI),"@@",2),"@@",1)
"RTN","C0CDACU",68,0)
 . I $D(@IARY@(VAR,1)) D  ;
"RTN","C0CDACU",69,0)
 . . N ZJ S ZJ=0
"RTN","C0CDACU",70,0)
 . . F  S ZJ=$O(@IARY@(VAR,ZJ)) Q:+ZJ=0  D  ;
"RTN","C0CDACU",71,0)
 . . . I $L(@IARY@(VAR,ZJ))>4000 D  ;
"RTN","C0CDACU",72,0)
 . . . . S @OUTXML@(LIN)=$E(@IARY@(VAR,ZJ),1,4000)
"RTN","C0CDACU",73,0)
 . . . . S LIN=LIN+1
"RTN","C0CDACU",74,0)
 . . . . S @OUTXML@(LIN)=$E(@IARY@(VAR,ZJ),4001,$L(@IARY@(VAR,ZJ)))
"RTN","C0CDACU",75,0)
 . . . E  S @OUTXML@(LIN)=@IARY@(VAR,ZJ)
"RTN","C0CDACU",76,0)
 . . . S LIN=LIN+1
"RTN","C0CDACU",77,0)
 . E  I $D(@IARY@(VAR)) D  ;
"RTN","C0CDACU",78,0)
 . . N VAR2 S VAR2="@@"_VAR_"@@"
"RTN","C0CDACU",79,0)
 . . S @OUTXML@(LIN)=$P(TXML(ZI),VAR2,1)_$G(@IARY@(VAR))_$P(TXML(ZI),VAR2,2)
"RTN","C0CDACU",80,0)
 . . S LIN=LIN+1
"RTN","C0CDACU",81,0)
 S @OUTXML@(0)=$O(@OUTXML@(" "),-1)
"RTN","C0CDACU",82,0)
 Q
"RTN","C0CDACU",83,0)
 ;
"RTN","C0CDACU",84,0)
JUSTMAP(IXML,INARY,OXML) ; SUBSTITUTE MULTIPLE @@X@@ VARS WITH VALUES IN INARY
"RTN","C0CDACU",85,0)
 ; AND PUT THE RESULTS IN OXML - gpl DOES NOT MAKE VARS SAFE
"RTN","C0CDACU",86,0)
 N XCNT
"RTN","C0CDACU",87,0)
 I '$D(DEBUG) S DEBUG=0
"RTN","C0CDACU",88,0)
 I '$D(IXML) W "MALFORMED XML PASSED TO MAP",! Q
"RTN","C0CDACU",89,0)
 I '$D(@IXML@(0)) D  ; INITIALIZE COUNT
"RTN","C0CDACU",90,0)
 . S XCNT=$O(@IXML@(""),-1)
"RTN","C0CDACU",91,0)
 E  S XCNT=@IXML@(0) ;COUNT
"RTN","C0CDACU",92,0)
 I $O(@INARY@(""))="" W "EMPTY ARRAY PASSED TO MAP",! Q
"RTN","C0CDACU",93,0)
 N I,J,TNAM,TVAL,TSTR
"RTN","C0CDACU",94,0)
 S @OXML@(0)=XCNT ; TOTAL LINES IN OUTPUT
"RTN","C0CDACU",95,0)
 F I=1:1:XCNT  D   ; LOOP THROUGH WHOLE ARRAY
"RTN","C0CDACU",96,0)
 . S @OXML@(I)=@IXML@(I) ; COPY THE LINE TO OUTPUT
"RTN","C0CDACU",97,0)
 . I @OXML@(I)?.E1"@@".E D  ; IS THERE A VARIABLE HERE?
"RTN","C0CDACU",98,0)
 . . S TSTR=$P(@IXML@(I),"@@",1) ; INIT TO PART BEFORE VARS
"RTN","C0CDACU",99,0)
 . . F J=2:2:10  D  Q:$P(@IXML@(I),"@@",J+2)=""  ; QUIT IF NO MORE VARS
"RTN","C0CDACU",100,0)
 . . . I DEBUG W "IN MAPPING LOOP: ",TSTR,!
"RTN","C0CDACU",101,0)
 . . . S TNAM=$P(@OXML@(I),"@@",J) ; EXTRACT THE VARIABLE NAME
"RTN","C0CDACU",102,0)
 . . . S TVAL="@@"_$P(@IXML@(I),"@@",J)_"@@" ; DEFAULT UNCHANGED
"RTN","C0CDACU",103,0)
 . . . I $D(@INARY@(TNAM))  D  ; IS THE VARIABLE IN THE MAP?
"RTN","C0CDACU",104,0)
 . . . . I '$D(@INARY@(TNAM,"F")) D  ; NOT A SPECIAL FIELD
"RTN","C0CDACU",105,0)
 . . . . . S TVAL=@INARY@(TNAM) ; PULL OUT MAPPED VALUE
"RTN","C0CDACU",106,0)
 . . . . E  D DOFLD ; PROCESS A FIELD
"RTN","C0CDACU",107,0)
 . . . ;S TVAL=$$SYMENC^MXMLUTL(TVAL) ;MAKE SURE THE VALUE IS XML SAFE
"RTN","C0CDACU",108,0)
 . . . S TSTR=TSTR_TVAL_$P(@IXML@(I),"@@",J+1) ; ADD VAR AND PART AFTER
"RTN","C0CDACU",109,0)
 . . S @OXML@(I)=TSTR ; COPY LINE WITH MAPPED VALUES
"RTN","C0CDACU",110,0)
 . . I DEBUG W TSTR
"RTN","C0CDACU",111,0)
 I DEBUG W "MAPPED",!
"RTN","C0CDACU",112,0)
 Q
"RTN","C0CDACU",113,0)
 ;
"RTN","C0CDACU",114,0)
GET(OUTXML,INXML) ; GET ONLY Retrieves XML stored in Mumps routines 
"RTN","C0CDACU",115,0)
 ; OUTXML is passed by name and will hold the result
"RTN","C0CDACU",116,0)
 ; INXML is the name of the storage place ie "HEADER^C0CDAC2"
"RTN","C0CDACU",117,0)
 N GTAG,GRT,GI
"RTN","C0CDACU",118,0)
 S GTAG=$P(INXML,"^",1)
"RTN","C0CDACU",119,0)
 S GRT=$P(INXML,"^",2)
"RTN","C0CDACU",120,0)
 ; first get all of the lines of the XML
"RTN","C0CDACU",121,0)
 S GN=1
"RTN","C0CDACU",122,0)
 F  S GI=GTAG_"+"_GN_"^"_GRT  Q:$T(@GI)'[";;"  D  ;
"RTN","C0CDACU",123,0)
 . S @OUTXML@(GN)=$P($T(@GI),";;",2)
"RTN","C0CDACU",124,0)
 . S @OUTXML@(0)=GN
"RTN","C0CDACU",125,0)
 . I $G(CCDADEBUG) W !,GN," ",@OUTXML@(GN)
"RTN","C0CDACU",126,0)
 . S GN=GN+1
"RTN","C0CDACU",127,0)
 Q
"RTN","C0CDACU",128,0)
 ;
"RTN","C0CDACU",129,0)
TEST ;
"RTN","C0CDACU",130,0)
 N GV S GV("test")="TEST"
"RTN","C0CDACU",131,0)
 K G
"RTN","C0CDACU",132,0)
 D GETNMAP("G","THEADER^C0CDAC2","GV")
"RTN","C0CDACU",133,0)
 ZWR G
"RTN","C0CDACU",134,0)
 Q
"RTN","C0CDACU",135,0)
 ;
"RTN","C0CDACU",136,0)
OUTLOG(ZTXT) ; add text to the log
"RTN","C0CDACU",137,0)
 I '$D(C0LOGLOC) S C0LOGLOC=$NA(^TMP("CCDA",$J,"LOG"))
"RTN","C0CDACU",138,0)
 N LN S LN=$O(@C0LOGLOC@(""),-1)+1
"RTN","C0CDACU",139,0)
 S @C0LOGLOC@(LN)=ZTXT
"RTN","C0CDACU",140,0)
 Q
"RTN","C0CDACU",141,0)
 ;
"RTN","C0CDACU",142,0)
LOGARY(ARY) ; LOG AN ARRAY
"RTN","C0CDACU",143,0)
 N II S II=""
"RTN","C0CDACU",144,0)
 F  S II=$O(@ARY@(II)) Q:II=""  D  ;
"RTN","C0CDACU",145,0)
 . D OUTLOG(ARY_" "_II_" = "_$G(@ARY@(II)))
"RTN","C0CDACU",146,0)
 Q
"RTN","C0CDACU",147,0)
 ;
"RTN","C0CDACU",148,0)
UUID()  ; thanks to Wally for this.
"RTN","C0CDACU",149,0)
 N R,I,J,N 
"RTN","C0CDACU",150,0)
 S N="",R="" F  S N=N_$R(100000) Q:$L(N)>64 
"RTN","C0CDACU",151,0)
 F I=1:2:64 S R=R_$E("0123456789abcdef",($E(N,I,I+1)#16+1)) 
"RTN","C0CDACU",152,0)
 Q $E(R,1,8)_"-"_$E(R,9,12)_"-4"_$E(R,14,16)_"-"_$E("89ab",$E(N,17)#4+1)_$E(R,18,20)_"-"_$E(R,21,32)
"RTN","C0CDACU",153,0)
 ;
"RTN","C0CDACU",154,0)
 ; the following was borrowed from the C0CUTIL and adapted for the CCDA
"RTN","C0CDACU",155,0)
 ;
"RTN","C0CDACU",156,0)
FMDTOUTC(DATE,FORMAT) ; Convert Fileman Date to UTC Date Format; PUBLIC; Extrinsic
"RTN","C0CDACU",157,0)
 ; FORMAT is Format of Date. Can be either D (Day) or DT (Date and Time)
"RTN","C0CDACU",158,0)
 ; If not passed, or passed incorrectly, it's assumed that it is D.
"RTN","C0CDACU",159,0)
 ; FM Date format is "YYYMMDD.HHMMSS" HHMMSS may not be supplied.
"RTN","C0CDACU",160,0)
 ; UTC date is formatted as follows: YYYY-MM-DDThh:mm:ss_offsetfromUTC
"RTN","C0CDACU",161,0)
 ; UTC, Year, Month, Day, Hours, Minutes, Seconds, Time offset (obtained from Mailman Site Parameters)
"RTN","C0CDACU",162,0)
 N UTC,Y,M,D,H,MM,S,OFF
"RTN","C0CDACU",163,0)
 S Y=1700+$E(DATE,1,3)
"RTN","C0CDACU",164,0)
 S M=$E(DATE,4,5)
"RTN","C0CDACU",165,0)
 S D=$E(DATE,6,7)
"RTN","C0CDACU",166,0)
 S H=$E(DATE,9,10)
"RTN","C0CDACU",167,0)
 I $L(H)=1 S H="0"_H
"RTN","C0CDACU",168,0)
 S MM=$E(DATE,11,12)
"RTN","C0CDACU",169,0)
 I $L(MM)=1 S MM="0"_MM
"RTN","C0CDACU",170,0)
 S S=$E(DATE,13,14)
"RTN","C0CDACU",171,0)
 I $L(S)=1 S S="0"_S
"RTN","C0CDACU",172,0)
 S OFF=$$TZ^XLFDT ; See Kernel Manual for documentation.
"RTN","C0CDACU",173,0)
 S OFFS=$E(OFF,1,1)
"RTN","C0CDACU",174,0)
 S OFF0=$TR(OFF,"+-")
"RTN","C0CDACU",175,0)
 S OFF1=$E(OFF0+10000,2,3)
"RTN","C0CDACU",176,0)
 S OFF2=$E(OFF0+10000,4,5)
"RTN","C0CDACU",177,0)
 ;S OFF=OFFS_OFF1_":"_OFF2
"RTN","C0CDACU",178,0)
 S OFF=OFFS_OFF1_OFF2
"RTN","C0CDACU",179,0)
 ;S OFF2=$E(OFF,1,2) ;
"RTN","C0CDACU",180,0)
 ;S OFF2=$E(100+OFF2,2,3) ; GPL 11/08 CHANGED TO -05:00 FORMAT
"RTN","C0CDACU",181,0)
 ;S OFF3=$E(OFF,3,4) ;MINUTES
"RTN","C0CDACU",182,0)
 ;S OFF=$S(OFF2="":"00",0:"00",1:OFF2)_"."_$S(OFF3="":"00",1:OFF3)
"RTN","C0CDACU",183,0)
 ; If H, MM and S are empty, it means that the FM date didn't supply the time.
"RTN","C0CDACU",184,0)
 ; In this case, set H, MM and S to "00"
"RTN","C0CDACU",185,0)
 ; S:('$L(H)&'$L(MM)&'$L(S)) (H,MM,S)="00" ; IF ONLY SOME ARE MISSING?
"RTN","C0CDACU",186,0)
 S:'$L(H) H="00"
"RTN","C0CDACU",187,0)
 S:'$L(MM) MM="00"
"RTN","C0CDACU",188,0)
 S:'$L(S) S="00"
"RTN","C0CDACU",189,0)
 S UTC=Y_M_D_H_MM_$S(S="":"00",1:S)_OFF ; Skip's code to fix hanging colon if no seconds
"RTN","C0CDACU",190,0)
 ;S UTC=Y_"-"_M_"-"_D_"T"_H_":"_MM_$S(S="":":00",1:":"_S)_OFF ; Skip's code to fix hanging colon if no seconds
"RTN","C0CDACU",191,0)
 I $E(UTC,9,14)="000000" S UTC=$E(UTC,1,8) ; admit our precision gpl 9/2013
"RTN","C0CDACU",192,0)
 I $L($G(FORMAT)),FORMAT="DT" Q UTC ; Date with time.
"RTN","C0CDACU",193,0)
 E  Q $P(UTC,"T")
"RTN","C0CDACU",194,0)
 ;
"RTN","C0CDACU",195,0)
HTMLDT(FMDT) ; extrinsic returns date format MM/DD/YYYY for display in html
"RTN","C0CDACU",196,0)
 ;
"RTN","C0CDACU",197,0)
 N TMP,TMP2
"RTN","C0CDACU",198,0)
 S TMP=$$FMDTOUTC(FMDT)
"RTN","C0CDACU",199,0)
 S TMP2=$E(TMP,5,6)_"/"_$E(TMP,7,8)_"/"_$E(TMP,1,4)
"RTN","C0CDACU",200,0)
 I $E(TMP,9,14)'="000000" D  ;
"RTN","C0CDACU",201,0)
 . I $L(TMP)=8 Q  ; no time
"RTN","C0CDACU",202,0)
 . S TMP2=TMP2_" "_$E(TMP,9,10)_":"
"RTN","C0CDACU",203,0)
 . S TMP2=TMP2_$E(TMP,11,12)_":"
"RTN","C0CDACU",204,0)
 . S TMP2=TMP2_$E(TMP,13,19)
"RTN","C0CDACU",205,0)
 Q TMP2
"RTN","C0CDACU",206,0)
 ;
"RTN","C0CDACU",207,0)
TESTDATE ; test the above transform
"RTN","C0CDACU",208,0)
 N GT
"RTN","C0CDACU",209,0)
 S GT=$$FMDTOUTC($$NOW^XLFDT,"DT")
"RTN","C0CDACU",210,0)
 W !,GT
"RTN","C0CDACU",211,0)
 Q
"RTN","C0CDACU",212,0)
 ; 
"RTN","C0CDACU",213,0)
GENHTML(HOUT,HARY) ; generate an HTML table from array HARY
"RTN","C0CDACU",214,0)
 ; HOUT AND HARY are passed by name
"RTN","C0CDACU",215,0)
 ;
"RTN","C0CDACU",216,0)
 ; format of the table:
"RTN","C0CDACU",217,0)
 ;  HARY("TITLE")="Problem List"
"RTN","C0CDACU",218,0)
 ;  HARY("HEADER",1)="column 1 header"
"RTN","C0CDACU",219,0)
 ;  HARY("HEADER",2)="col 2 header"
"RTN","C0CDACU",220,0)
 ;  HARY(1,1)="row 1 col1 value"
"RTN","C0CDACU",221,0)
 ;  HARY(1,2)="row 1 col2 value"
"RTN","C0CDACU",222,0)
 ;  HARY(1,2,"ID")="the ID of the element" 
"RTN","C0CDACU",223,0)
 ;  etc...
"RTN","C0CDACU",224,0)
 ;
"RTN","C0CDACU",225,0)
 N C0I,C0J
"RTN","C0CDACU",226,0)
 I $D(@HARY@("TITLE")) D  ;
"RTN","C0CDACU",227,0)
 . N X
"RTN","C0CDACU",228,0)
 . S X="<title>"_@HARY@("TITLE")_"</title>"
"RTN","C0CDACU",229,0)
 . D ADDTO(HOUT,X)
"RTN","C0CDACU",230,0)
 D ADDTO(HOUT,"<text>")
"RTN","C0CDACU",231,0)
 D ADDTO(HOUT,"<table border=""1"" width=""100%"">")
"RTN","C0CDACU",232,0)
 I $D(@HARY@("HEADER")) D  ;
"RTN","C0CDACU",233,0)
 . D ADDTO(HOUT,"<thead>")
"RTN","C0CDACU",234,0)
 . D ADDTO(HOUT,"<tr>")
"RTN","C0CDACU",235,0)
 . S C0I=0
"RTN","C0CDACU",236,0)
 . F  S C0I=$O(@HARY@("HEADER",C0I)) Q:+C0I=0  D  ;
"RTN","C0CDACU",237,0)
 . . D ADDTO(HOUT,"<th>"_@HARY@("HEADER",C0I)_"</th>")
"RTN","C0CDACU",238,0)
 . D ADDTO(HOUT,"</tr>")
"RTN","C0CDACU",239,0)
 . D ADDTO(HOUT,"</thead>")
"RTN","C0CDACU",240,0)
 D ADDTO(HOUT,"<tbody>")
"RTN","C0CDACU",241,0)
 I $D(@HARY@(1)) D  ;
"RTN","C0CDACU",242,0)
 . S C0I=0 S C0J=0
"RTN","C0CDACU",243,0)
 . F  S C0I=$O(@HARY@(C0I)) Q:+C0I=0  D  ;
"RTN","C0CDACU",244,0)
 . . D ADDTO(HOUT,"<tr>")
"RTN","C0CDACU",245,0)
 . . F  S C0J=$O(@HARY@(C0I,C0J)) Q:+C0J=0  D  ;
"RTN","C0CDACU",246,0)
 . . . N UID S UID=$G(@HARY@(C0I,C0J,"ID"))
"RTN","C0CDACU",247,0)
 . . . I UID'="" D ADDTO(HOUT,"<td ID="""_UID_""">"_@HARY@(C0I,C0J)_"</td>")
"RTN","C0CDACU",248,0)
 . . . E  D ADDTO(HOUT,"<td>"_@HARY@(C0I,C0J)_"</td>")
"RTN","C0CDACU",249,0)
 . . D ADDTO(HOUT,"</tr>")
"RTN","C0CDACU",250,0)
 D ADDTO(HOUT,"</tbody>")
"RTN","C0CDACU",251,0)
 D ADDTO(HOUT,"</table>")
"RTN","C0CDACU",252,0)
 D ADDTO(HOUT,"</text>")
"RTN","C0CDACU",253,0)
 Q
"RTN","C0CDACU",254,0)
 ;
"RTN","C0CDACU",255,0)
TESTHTML ;
"RTN","C0CDACU",256,0)
 N HTML
"RTN","C0CDACU",257,0)
 S HTML("TITLE")="Problem List"
"RTN","C0CDACU",258,0)
 S HTML("HEADER",1)="column 1 header"
"RTN","C0CDACU",259,0)
 S HTML("HEADER",2)="col 2 header"
"RTN","C0CDACU",260,0)
 S HTML(1,1)="row 1 col1 value"
"RTN","C0CDACU",261,0)
 S HTML(1,2)="row 1 col2 value"
"RTN","C0CDACU",262,0)
 N GHTML
"RTN","C0CDACU",263,0)
 D GENHTML("GHTML","HTML")
"RTN","C0CDACU",264,0)
 ZWR GHTML
"RTN","C0CDACU",265,0)
 Q
"RTN","C0CDACU",266,0)
 ;
"RTN","C0CDACU",267,0)
ADDTO(DEST,WHAT) ; adds string WHAT to list DEST 
"RTN","C0CDACU",268,0)
 ; DEST is passed by name
"RTN","C0CDACU",269,0)
 N GN
"RTN","C0CDACU",270,0)
 S GN=$O(@DEST@("AAAAAA"),-1)+1
"RTN","C0CDACU",271,0)
 S @DEST@(GN)=WHAT
"RTN","C0CDACU",272,0)
 S @DEST@(0)=GN ; count
"RTN","C0CDACU",273,0)
 Q
"RTN","C0CDACU",274,0)
 ;
"RTN","C0CDACU",275,0)
ORGOID() ; extrinsic which returns the Organization OID
"RTN","C0CDACU",276,0)
 Q "2.16.840.1.113883.5.83" ; WORLDVISTA HL7 OID - 
"RTN","C0CDACU",277,0)
 ; REPLACE WITH OID LOOKUP FROM INSTITUTION FILE
"RTN","C0CDACU",278,0)
 ;
"RTN","C0CDACU",279,0)
DA2SNO(RTN,DNAME)       ; LOOK UP DRUG ALLERGY CODE IN ^LEX
"RTN","C0CDACU",280,0)
        ; RETURNS AN ARRAY RTN PASSED BY REFERENCE
"RTN","C0CDACU",281,0)
        ; THIS ROUTINE CAN BE USED AS AN RPC
"RTN","C0CDACU",282,0)
        ; RTN(0) IS THE NUMBER OF ELEMENTS IN THE ARRAY
"RTN","C0CDACU",283,0)
        ; RTN(1) IS THE SNOMED CODE FOR THE DRUG ALLERGY
"RTN","C0CDACU",284,0)
        ;
"RTN","C0CDACU",285,0)
        N LEXIEN
"RTN","C0CDACU",286,0)
        I $O(^LEX(757.21,"ADIS",DNAME,""))'="" D  ; IEN FOUND FOR THIS DRUG
"RTN","C0CDACU",287,0)
        . S LEXIEN=$O(^LEX(757.21,"ADIS",DNAME,"")) ; GET THE IEN IN THE LEXICON
"RTN","C0CDACU",288,0)
        . W LEXIEN,!
"RTN","C0CDACU",289,0)
        . S RTN(1)=$P(^LEX(757.02,LEXIEN,0),"^",2) ; SNOMED CODE IN P2
"RTN","C0CDACU",290,0)
        . S RTN(0)=1 ; ONE THING RETURNED
"RTN","C0CDACU",291,0)
        E  S RTN(0)=0 ; NOT FOUND
"RTN","C0CDACU",292,0)
        Q
"RTN","C0CDACU",293,0)
        ;
"RTN","C0CDACU",294,0)
LOWCASE(X) ; extrinsic returns lowercase of X
"RTN","C0CDACU",295,0)
 N Y
"RTN","C0CDACU",296,0)
 S Y=$TR(X,"ABCDEFGHIJKLMNOPQRSTUVWXYZ","abcdefghijklmnopqrstuvwxyz")
"RTN","C0CDACU",297,0)
 Q Y
"RTN","C0CDACU",298,0)
 ;
"RTN","C0CDACU",299,0)
LOOKUP(RTN,PARM) ; generalized lookup routine which hides the
"RTN","C0CDACU",300,0)
 ; messiness of code lookups
"RTN","C0CDACU",301,0)
 I $G(PARM("table"))="Primary Language" D  ;
"RTN","C0CDACU",302,0)
 . I $D(^JJOHcodeMap) D  ; on an Oroville system
"RTN","C0CDACU",303,0)
 . . N LNM S LNM=$G(PARM("name"))
"RTN","C0CDACU",304,0)
 . . Q:LNM=""
"RTN","C0CDACU",305,0)
 . . N LANIEN S LANIEN=$O(^DI(.85,"B",LNM,""))
"RTN","C0CDACU",306,0)
 . . Q:'LANIEN
"RTN","C0CDACU",307,0)
 . . N CTMP,CDEU
"RTN","C0CDACU",308,0)
 . . S CTMP=$G(^DI(.85,LANIEN,0))
"RTN","C0CDACU",309,0)
 . . Q:CTMP=""
"RTN","C0CDACU",310,0)
 . . S CDEU=$P(CTMP,"^",2) ; should be a 3 letter code for the language
"RTN","C0CDACU",311,0)
 . . Q:$L(CDEU)'=3
"RTN","C0CDACU",312,0)
 . . S RTN("code")=$$LOWCASE(CDEU)
"RTN","C0CDACU",313,0)
 Q
"RTN","C0CDACU",314,0)
 ;
"RTN","C0CDACU",315,0)
SUBLIST(RTN,SRC,COUNT,START) ; returns a sublist of SRC starting at START
"RTN","C0CDACU",316,0)
 ; and containing COUNT elements. RTN and SRC passed by name
"RTN","C0CDACU",317,0)
 ; default is COUNT=10 and START=1
"RTN","C0CDACU",318,0)
 I '$D(COUNT) S COUNT=10
"RTN","C0CDACU",319,0)
 I '$D(START) S START=1
"RTN","C0CDACU",320,0)
 N I S I=""
"RTN","C0CDACU",321,0)
 N OCNT S OCNT=0
"RTN","C0CDACU",322,0)
 N ICNT S ICNT=0
"RTN","C0CDACU",323,0)
 F  S I=$O(@SRC@(I)) Q:I=""  D  Q:ICNT=COUNT  ;
"RTN","C0CDACU",324,0)
 . S OCNT=OCNT+1 ; outer count
"RTN","C0CDACU",325,0)
 . I OCNT<START Q  ; not there yet
"RTN","C0CDACU",326,0)
 . S ICNT=ICNT+1 ; inner count
"RTN","C0CDACU",327,0)
 . S @RTN@(I)="" ; add this one
"RTN","C0CDACU",328,0)
 Q
"RTN","C0CDACU",329,0)
 ;
"RTN","C0CDACU",330,0)
FMX(RTN,FILE,IEN,CAMEL) ; return an array of a fileman record for external use in RTN,
"RTN","C0CDACU",331,0)
 ; which is passed by name. input is file number and ien. CAMEL is 1 or 2 for camel case
"RTN","C0CDACU",332,0)
 ;
"RTN","C0CDACU",333,0)
 K @RTN
"RTN","C0CDACU",334,0)
 I $D(PTR) D  ;
"RTN","C0CDACU",335,0)
 . S FILE=$P($P(PTR,"(",2),",",1)
"RTN","C0CDACU",336,0)
 . S IEN=$P(PTR,";",1)
"RTN","C0CDACU",337,0)
 N TREC,FILENM
"RTN","C0CDACU",338,0)
 D GETS^DIQ(FILE,IEN_",","**","ENR","TREC")
"RTN","C0CDACU",339,0)
 S FILENM=$O(^DD(FILE,0,"NM",""))
"RTN","C0CDACU",340,0)
 S FILENM=$TR(FILENM," ","_")
"RTN","C0CDACU",341,0)
 ;ZWR TREC
"RTN","C0CDACU",342,0)
 I $G(DEBUG)=1 B
"RTN","C0CDACU",343,0)
 N % S %=$Q(TREC(""))
"RTN","C0CDACU",344,0)
 F  D  Q:%=""  ;
"RTN","C0CDACU",345,0)
 . N FNUM,FNAME,IENS,FIELD,VAL
"RTN","C0CDACU",346,0)
 . S FNUM=$QS(%,1)
"RTN","C0CDACU",347,0)
 . I $D(^DD(FNUM,0,"NM")) D  ;
"RTN","C0CDACU",348,0)
 . . S FNAME=$O(^DD(FNUM,0,"NM",""))
"RTN","C0CDACU",349,0)
 . . S FNAME=$TR(FNAME," ","_")
"RTN","C0CDACU",350,0)
 . E  S FNAME=FNUM
"RTN","C0CDACU",351,0)
 . S IENS=$QS(%,2)
"RTN","C0CDACU",352,0)
 . S FIELD=$QS(%,3)
"RTN","C0CDACU",353,0)
 . S FIELD=$TR(FIELD," ","_")
"RTN","C0CDACU",354,0)
 . S VAL=@%
"RTN","C0CDACU",355,0)
 . I FNUM=FILE D  ; not a subfile
"RTN","C0CDACU",356,0)
 . . S @RTN@(FNAME,FIELD)=VAL
"RTN","C0CDACU",357,0)
 . . S @RTN@(FNAME,"ien")=$P(IENS,",",1)
"RTN","C0CDACU",358,0)
 . E  D  ;
"RTN","C0CDACU",359,0)
 . . N I2 S I2=$O(@RTN@(FNAME,""),-1)+1
"RTN","C0CDACU",360,0)
 . . I $L(IENS,",")>2 D  ;
"RTN","C0CDACU",361,0)
 . . . S @RTN@(FNAME,IENS,FIELD)=VAL
"RTN","C0CDACU",362,0)
 . . E  D  ;
"RTN","C0CDACU",363,0)
 . . . S @RTN@(FNAME,$P(IENS,","),FIELD)=VAL
"RTN","C0CDACU",364,0)
 . . ;S @RTN@(FNAME,I2,FIELD)=VAL
"RTN","C0CDACU",365,0)
 . . ;S @RTN@(FNAME,I2,"iens")=IENS
"RTN","C0CDACU",366,0)
 . W:$G(DEBUG)=1 !,%,"=",@%
"RTN","C0CDACU",367,0)
 . S %=$Q(@%)
"RTN","C0CDACU",368,0)
 Q
"RTN","C0CDACU",369,0)
 ;
"RTN","C0CDACV")
0^20^B102805139
"RTN","C0CDACV",1,0)
C0CDACV ; GPL - Patient Portal - CCDA Routines ;09/17/13  17:05
"RTN","C0CDACV",2,0)
 ;;0.1;C0CDA;nopatch;noreleasedate;Build 1
"RTN","C0CDACV",3,0)
 ;
"RTN","C0CDACV",4,0)
 ; License AGPL v3.0
"RTN","C0CDACV",5,0)
 ; 
"RTN","C0CDACV",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDACV",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDACV",8,0)
 Q
"RTN","C0CDACV",9,0)
 ;
"RTN","C0CDACV",10,0)
ENC(BLIST,DFN,CCDAWRK,CCDARPT,CCDACTRL) ;
"RTN","C0CDACV",11,0)
 ;
"RTN","C0CDACV",12,0)
 N CCDAV,CCDAV1,PARMS,HAVDTS
"RTN","C0CDACV",13,0)
 I $D(@CCDACTRL@("PARMS")) M PARMS=@CCDACTRL@("PARMS")
"RTN","C0CDACV",14,0)
 S HAVDTS=0
"RTN","C0CDACV",15,0)
 I $D(PARMS("startDateTime")) S HAVDTS=1
"RTN","C0CDACV",16,0)
 N STRT,STOP
"RTN","C0CDACV",17,0)
 S STRT=$G(PARMS("startDateTime"))
"RTN","C0CDACV",18,0)
 S STOP=$G(PARMS("endDateTime"))
"RTN","C0CDACV",19,0)
 S @CCDARPT@("STATUS")="EXTRACTING"
"RTN","C0CDACV",20,0)
 S @CCDARPT@("EXTRACT-BEGIN")=$$NOW^XLFDT
"RTN","C0CDACV",21,0)
 D GETPAT^C0CDACE(.CCDAV1,DFN,"visits",STRT,STOP)
"RTN","C0CDACV",22,0)
 I '$D(CCDAV1) Q  ;
"RTN","C0CDACV",23,0)
 I CCDAV1("results","visits@total")=0 Q  ;
"RTN","C0CDACV",24,0)
 I CCDAV1("results","visits@total")=1 D  ;
"RTN","C0CDACV",25,0)
 . M CCDAV(1)=CCDAV1("results","visits")
"RTN","C0CDACV",26,0)
 E  M CCDAV=CCDAV1("results","visits")
"RTN","C0CDACV",27,0)
 S @CCDARPT@("EXTRACT-ENDS")=$$NOW^XLFDT
"RTN","C0CDACV",28,0)
 ;
"RTN","C0CDACV",29,0)
 ; encounters section html
"RTN","C0CDACV",30,0)
 ;
"RTN","C0CDACV",31,0)
 N C0HTML,C0ARY
"RTN","C0CDACV",32,0)
 S C0ARY("TITLE")="Encounters"
"RTN","C0CDACV",33,0)
 S C0ARY("HEADER",1)="Encounter"
"RTN","C0CDACV",34,0)
 S C0ARY("HEADER",2)="Performer"
"RTN","C0CDACV",35,0)
 S C0ARY("HEADER",3)="Location"
"RTN","C0CDACV",36,0)
 S C0ARY("HEADER",4)="Date"
"RTN","C0CDACV",37,0)
 ;
"RTN","C0CDACV",38,0)
 N C0N S C0N=0 ; output array counter
"RTN","C0CDACV",39,0)
 N C0I S C0I=0
"RTN","C0CDACV",40,0)
 F  S C0I=$O(CCDAV(C0I)) Q:+C0I=0  D  ;
"RTN","C0CDACV",41,0)
 . N C0DATE S C0DATE=$G(CCDAV(C0I,"visit","dateTime@value"))
"RTN","C0CDACV",42,0)
 . Q:$$SKIP(C0DATE,.PARMS)
"RTN","C0CDACV",43,0)
 . Q:$G(CCDAV(C0I,"visit","providers","provider@name"))=""
"RTN","C0CDACV",44,0)
 . S CCDAV(C0I,"visit","uri")="uri_9000010-"_$G(CCDAV(C0I,"visit","id@value"))
"RTN","C0CDACV",45,0)
 . N ENCURI S ENCURI=$G(PARMS("ENCOUNTER"))
"RTN","C0CDACV",46,0)
 . I ENCURI'="" I CCDAV(C0I,"visit","uri")'=ENCURI Q  ;
"RTN","C0CDACV",47,0)
 . Q:$$REDACT(CCDAV(C0I,"visit","uri"),.PARMS)
"RTN","C0CDACV",48,0)
 . ; exclusion section - astro gpl
"RTN","C0CDACV",49,0)
 . I $G(CCDAV(C0I,"visit","reason@narrative"))="Tobacco use" Q  ;
"RTN","C0CDACV",50,0)
 . I $G(CCDAV(C0I,"visit","type@code"))=99238 Q  ;
"RTN","C0CDACV",51,0)
 . I $G(CCDAV(C0I,"visit","reason@narrative"))="Chronic" Q  ;
"RTN","C0CDACV",52,0)
 . ; end exclusions
"RTN","C0CDACV",53,0)
 . S C0N=C0N+1
"RTN","C0CDACV",54,0)
 . I C0DATE'="" S C0ARY(C0N,4)=$$HTMLDT^C0CDACU(C0DATE) ; visit date
"RTN","C0CDACV",55,0)
 . E  S C0ARY(C0N,4)=""
"RTN","C0CDACV",56,0)
 . ; astro gpl
"RTN","C0CDACV",57,0)
 . N REASON,REASONCD
"RTN","C0CDACV",58,0)
 . I $G(CCDAV(C0I,"visit","reason@narrative"))'="" D  ; possible encounter diagnosis
"RTN","C0CDACV",59,0)
 . . S REASON=$G(CCDAV(C0I,"visit","reason@narrative"))
"RTN","C0CDACV",60,0)
 . . S REASONCD=""
"RTN","C0CDACV",61,0)
 . . I REASON["SCT" D  ;
"RTN","C0CDACV",62,0)
 . . . S REASONCD=$P($P(REASON,"SCT ",2),")",1)
"RTN","C0CDACV",63,0)
 . . . S CCDAV(C0I,"visit","reason@code")=REASONCD
"RTN","C0CDACV",64,0)
 . S C0ARY(C0N,1)=$G(CCDAV(C0I,"visit","reason@narrative"))_" "_$G(CCDAV(C0I,"visit","reason@code")) ; reason for visit
"RTN","C0CDACV",65,0)
 . I C0ARY(C0N,1)=" " S C0ARY(C0N,1)=$G(CCDAV(C0I,"visit","type@name"))_" "_$G(CCDAV(C0I,"visit","type@code"))
"RTN","C0CDACV",66,0)
 . N VISITXT S VISITXT=$$CHARCHK^MXMLBLD(C0ARY(C0N,1))
"RTN","C0CDACV",67,0)
 . S C0ARY(C0N,1)=VISITXT
"RTN","C0CDACV",68,0)
 . S C0ARY(C0N,1,"ID")=$G(CCDAV(C0I,"visit","uri"))
"RTN","C0CDACV",69,0)
 . S C0ARY(C0N,2)=$G(CCDAV(C0I,"visit","providers","provider@name"))
"RTN","C0CDACV",70,0)
 . I C0ARY(C0N,2)="" S C0ARY(C0N,2)=$G(CCDAV(C0I,"visit","providers",1,"provider@name"))
"RTN","C0CDACV",71,0)
 . S C0ARY(C0N,3)=$G(CCDAV(C0I,"visit","location@value"))_" "_$G(CCDAV(C0I,"visit","facility@name"))
"RTN","C0CDACV",72,0)
 ;
"RTN","C0CDACV",73,0)
 I +$O(C0ARY("AAAAA"),-1)=0 Q  ; all encounters have been redacted
"RTN","C0CDACV",74,0)
 ;
"RTN","C0CDACV",75,0)
 ;
"RTN","C0CDACV",76,0)
 ; the encounters section component
"RTN","C0CDACV",77,0)
 ;
"RTN","C0CDACV",78,0)
 N ESECT S ESECT=$NA(@CCDAWRK@("ENCSECT"))
"RTN","C0CDACV",79,0)
 D GET^C0CDACU(ESECT,"TENCSEC^C0CDACV")
"RTN","C0CDACV",80,0)
 D QUEUE^MXMLTMPL(BLIST,ESECT,1,@ESECT@(0))
"RTN","C0CDACV",81,0)
 ;
"RTN","C0CDACV",82,0)
 ; encounters html digest generation
"RTN","C0CDACV",83,0)
 ;
"RTN","C0CDACV",84,0)
 N EHTML S EHTML=$NA(@CCDAWRK@("ENCHTML"))
"RTN","C0CDACV",85,0)
 D GENHTML^C0CDACU(EHTML,"C0ARY")
"RTN","C0CDACV",86,0)
 ;B
"RTN","C0CDACV",87,0)
 D QUEUE^MXMLTMPL(BLIST,EHTML,1,@EHTML@(0))
"RTN","C0CDACV",88,0)
 ;
"RTN","C0CDACV",89,0)
 ; encounter xml generation
"RTN","C0CDACV",90,0)
 ;
"RTN","C0CDACV",91,0)
 N WRK
"RTN","C0CDACV",92,0)
 S C0N=0
"RTN","C0CDACV",93,0)
 N C0I S C0I=0
"RTN","C0CDACV",94,0)
 F  S C0I=$O(CCDAV(C0I)) Q:+C0I=0  D  ;
"RTN","C0CDACV",95,0)
 . K C0ARY
"RTN","C0CDACV",96,0)
 . M C0ARY=CCDAV(C0I,"visit")
"RTN","C0CDACV",97,0)
 . Q:$G(CCDAV(C0I,"visit","providers","provider@name"))=""
"RTN","C0CDACV",98,0)
 . ; exclusion section - astro gpl
"RTN","C0CDACV",99,0)
 . I $G(CCDAV(C0I,"visit","reason@narrative"))="Tobacco use" Q  ;
"RTN","C0CDACV",100,0)
 . I $G(CCDAV(C0I,"visit","type@code"))=99238 Q  ;
"RTN","C0CDACV",101,0)
 . I $G(CCDAV(C0I,"visit","reason@narrative"))="Chronic" Q  ;
"RTN","C0CDACV",102,0)
 . ; end exclusions
"RTN","C0CDACV",103,0)
 . S C0ARY("encounterGuid")=$$UUID^C0CDACU() ; random
"RTN","C0CDACV",104,0)
 . N C0DATE S C0DATE=$G(CCDAV(C0I,"visit","dateTime@value"))
"RTN","C0CDACV",105,0)
 . I C0DATE'="" S C0ARY("effectiveTime")=$$FMDTOUTC^C0CDACU(C0DATE) ; date
"RTN","C0CDACV",106,0)
 . E  S C0ARY("effectiveTime")="UNK"
"RTN","C0CDACV",107,0)
 . N OK,G2 S OK=$$GETMAP^C0CDACM(.G2,"getLocationCode",$G(C0ARY("patientClass@value")))
"RTN","C0CDACV",108,0)
 . I 'OK D  ;
"RTN","C0CDACV",109,0)
 . . S C0ARY("locationLoincCode")="1141-1"
"RTN","C0CDACV",110,0)
 . . S C0ARY("locationLoincName")="Provider's office"
"RTN","C0CDACV",111,0)
 . E  D  ;
"RTN","C0CDACV",112,0)
 . . S C0ARY("locationLoincCode")=$G(G2("code"))
"RTN","C0CDACV",113,0)
 . . S C0ARY("locationLoincName")=$G(G2("text"))
"RTN","C0CDACV",114,0)
 . N ENCURI S ENCURI=$G(PARMS("ENCOUNTER"))
"RTN","C0CDACV",115,0)
 . I ENCURI'="" I CCDAV(C0I,"visit","uri")'=ENCURI Q  ;
"RTN","C0CDACV",116,0)
 . Q:$$SKIP(C0DATE,.PARMS)
"RTN","C0CDACV",117,0)
 . I $$REDACT(CCDAV(C0I,"visit","uri"),.PARMS) D  Q  ;
"RTN","C0CDACV",118,0)
 . . W !,"REDACTING ",$G(CCDAV(C0I,"visit","uri"))
"RTN","C0CDACV",119,0)
 . S C0ARY("uri")=$G(CCDAV(C0I,"visit","uri"))
"RTN","C0CDACV",120,0)
 . S C0N=C0N+1
"RTN","C0CDACV",121,0)
 . D SETORGV^C0CDAC2(.C0ARY) ; set organization variables
"RTN","C0CDACV",122,0)
 . ;
"RTN","C0CDACV",123,0)
 . ; beginning of encounter
"RTN","C0CDACV",124,0)
 . S WRK=$NA(@CCDAWRK@("ENC",C0N))
"RTN","C0CDACV",125,0)
 . D GETNMAP^C0CDACU(WRK,"TENC^C0CDACV","C0ARY")
"RTN","C0CDACV",126,0)
 . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDACV",127,0)
 . ;
"RTN","C0CDACV",128,0)
 . ;
"RTN","C0CDACV",129,0)
 . ; add findings and diagnosis here
"RTN","C0CDACV",130,0)
 . ;
"RTN","C0CDACV",131,0)
 . ; begin encounter diagnosis
"RTN","C0CDACV",132,0)
 . ;
"RTN","C0CDACV",133,0)
 . I $G(CCDAV(C0I,"visit","reason@code"))'="" D  ;
"RTN","C0CDACV",134,0)
 . . S C0ARY("reasonCode")=CCDAV(C0I,"visit","reason@code")
"RTN","C0CDACV",135,0)
 . . S C0ARY("reasonName")=$G(CCDAV(C0I,"visit","reason@narrative"))
"RTN","C0CDACV",136,0)
 . . S WRK=$NA(@CCDAWRK@("ENCDIAG",C0N))
"RTN","C0CDACV",137,0)
 . . D GETNMAP^C0CDACU(WRK,"TENCDIAG^C0CDACV","C0ARY")
"RTN","C0CDACV",138,0)
 . . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDACV",139,0)
 . N REASON S REASON=$G(CCDAV(C0I,"visit","reason@narrative"))
"RTN","C0CDACV",140,0)
 . I REASON["SNOMED" D  ;
"RTN","C0CDACV",141,0)
 . . S C0ARY("reasonCode")=$P($P(REASON,"SNOMED CT ",2),")",1)
"RTN","C0CDACV",142,0)
 . . S C0ARY("reasonName")=REASON
"RTN","C0CDACV",143,0)
 . . S WRK=$NA(@CCDAWRK@("ENCDIAG",C0N))
"RTN","C0CDACV",144,0)
 . . D GETNMAP^C0CDACU(WRK,"TENCDIAG^C0CDACV","C0ARY")
"RTN","C0CDACV",145,0)
 . . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDACV",146,0)
 . ;
"RTN","C0CDACV",147,0)
 . ; end encounter diagnosis
"RTN","C0CDACV",148,0)
 . ;
"RTN","C0CDACV",149,0)
 . ; end of encounter
"RTN","C0CDACV",150,0)
 . S WRK=$NA(@CCDAWRK@("ENCEND",C0N))
"RTN","C0CDACV",151,0)
 . D GETNMAP^C0CDACU(WRK,"TENCEND^C0CDACV","C0ARY")
"RTN","C0CDACV",152,0)
 . D QUEUE^MXMLTMPL(BLIST,WRK,1,@WRK@(0))
"RTN","C0CDACV",153,0)
 ; 
"RTN","C0CDACV",154,0)
 ; encounter section ending
"RTN","C0CDACV",155,0)
 ;
"RTN","C0CDACV",156,0)
 N ENCEND S ENCEND=$NA(@CCDAWRK@("ENCEND"))
"RTN","C0CDACV",157,0)
 D GET^C0CDACU(ENCEND,"TENCSEND^C0CDACV")
"RTN","C0CDACV",158,0)
 D QUEUE^MXMLTMPL(BLIST,ENCEND,1,@ENCEND@(0))
"RTN","C0CDACV",159,0)
 ;
"RTN","C0CDACV",160,0)
 S @CCDARPT@("STATUS")="COMPLETE"
"RTN","C0CDACV",161,0)
 Q
"RTN","C0CDACV",162,0)
 ;
"RTN","C0CDACV",163,0)
VAOID() ; Oid for VA coding system
"RTN","C0CDACV",164,0)
 Q "2.16.840.1.113883.6.229"
"RTN","C0CDACV",165,0)
 ;
"RTN","C0CDACV",166,0)
RXNOID() ; RxNorm OID
"RTN","C0CDACV",167,0)
 Q "2.16.840.1.113883.6.88"
"RTN","C0CDACV",168,0)
 ;
"RTN","C0CDACV",169,0)
REDACT(URI,PARMS) ; extrinsic returns true if the parms say to skip this URI
"RTN","C0CDACV",170,0)
 I URI="" Q 0
"RTN","C0CDACV",171,0)
 N X,Y S X=URI
"RTN","C0CDACV",172,0)
 X ^%ZOSF("UPPERCASE")
"RTN","C0CDACV",173,0)
 I $G(PARMS("REDACT",Y)) D  Q 1
"RTN","C0CDACV",174,0)
 . D:C0LOG OUTLOG^C0CDACU("REDACTING "_URI)
"RTN","C0CDACV",175,0)
 . W:$G(C0DEBUG) !,"REDACTING"_URI
"RTN","C0CDACV",176,0)
 I $D(PARMS("redact",URI)) D  Q 1
"RTN","C0CDACV",177,0)
 . D:C0LOG OUTLOG^C0CDACU("REDACTING "_URI)
"RTN","C0CDACV",178,0)
 . W:$G(C0DEBUG) !,"REDACTING"_URI
"RTN","C0CDACV",179,0)
 Q 0
"RTN","C0CDACV",180,0)
 ;
"RTN","C0CDACV",181,0)
SKIP(DATE,PARMS) ; extrinsic returns true if the parms say to skip this entry
"RTN","C0CDACV",182,0)
 N SKIP S SKIP=0
"RTN","C0CDACV",183,0)
 I $G(PARMS("startDateTime"))="" Q SKIP
"RTN","C0CDACV",184,0)
 I DATE<PARMS("startDateTime") S SKIP=1 D OUTLOG^C0CDACU(DATE_" < "_PARMS("startDateTime"))
"RTN","C0CDACV",185,0)
 ;I DATE>=PARMS("endDateTime") S SKIP=1 D OUTLOG^C0CDACU(DATE_" >= "_PARMS("endDateTime"))
"RTN","C0CDACV",186,0)
 I DATE>PARMS("endDateTime") S SKIP=1 D OUTLOG^C0CDACU(DATE_" > "_PARMS("endDateTime"))
"RTN","C0CDACV",187,0)
 I SKIP=0 D OUTLOG^C0CDACU(DATE_" in range")
"RTN","C0CDACV",188,0)
 Q SKIP
"RTN","C0CDACV",189,0)
 ;
"RTN","C0CDACV",190,0)
TENCSEC ;
"RTN","C0CDACV",191,0)
 ;;<component>
"RTN","C0CDACV",192,0)
 ;;<section>
"RTN","C0CDACV",193,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.2.22.1"/>
"RTN","C0CDACV",194,0)
 ;;<!-- Encounters Section - required entries -->
"RTN","C0CDACV",195,0)
 ;;<code code="46240-8" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="History of encounters"/>
"RTN","C0CDACV",196,0)
 Q
"RTN","C0CDACV",197,0)
 ;
"RTN","C0CDACV",198,0)
VISITS(RTN,DFN) ; returns an array of encounters
"RTN","C0CDACV",199,0)
 K RTN
"RTN","C0CDACV",200,0)
 N CCDAV,CCDAV1
"RTN","C0CDACV",201,0)
 D GETPAT^C0CDACE(.CCDAV1,DFN,"visits;cpt")
"RTN","C0CDACV",202,0)
 I '$D(CCDAV1) Q  ;
"RTN","C0CDACV",203,0)
 I CCDAV1("results","visits@total")=0 Q  ;
"RTN","C0CDACV",204,0)
 I CCDAV1("results","visits@total")=1 D  ;
"RTN","C0CDACV",205,0)
 . M CCDAV(1)=CCDAV1("results","visits")
"RTN","C0CDACV",206,0)
 E  M CCDAV=CCDAV1("results","visits")
"RTN","C0CDACV",207,0)
 D ADDSTDC(.CCDAV,DFN)
"RTN","C0CDACV",208,0)
 M RTN=CCDAV
"RTN","C0CDACV",209,0)
 Q
"RTN","C0CDACV",210,0)
 N C0I S C0I=0
"RTN","C0CDACV",211,0)
 F  S C0I=$O(CCDAV(C0I)) Q:+C0I=0  D  ;
"RTN","C0CDACV",212,0)
 . S RTN(C0I,"uri")="uri_9000010-"_$G(CCDAV(C0I,"visit","id@value"))
"RTN","C0CDACV",213,0)
 . S RTN("URI",RTN(C0I,"uri"),C0I)=""
"RTN","C0CDACV",214,0)
 . S RTN(C0I,"date")=$G(CCDAV(C0I,"visit","dateTime@value"))
"RTN","C0CDACV",215,0)
 . S RTN(C0I,"arrivalDate")=$G(CCDAV(C0I,"visit","arrivalDateTime@value"))
"RTN","C0CDACV",216,0)
 . N DEPDATE ; departure date
"RTN","C0CDACV",217,0)
 . S DEPDATE=$G(CCDAV(C0I,"visit","departureDateTime@value"))
"RTN","C0CDACV",218,0)
 . S RTN(C0I,"departureDate")=DEPDATE
"RTN","C0CDACV",219,0)
 . S RTN(C0I,"startDateTime")=RTN(C0I,"date")
"RTN","C0CDACV",220,0)
 . S RTN("DATE",RTN(C0I,"date"),C0I)=""
"RTN","C0CDACV",221,0)
 . I DEPDATE'="" D  ;
"RTN","C0CDACV",222,0)
 . . S RTN(C0I,"endDateTime")=DEPDATE
"RTN","C0CDACV",223,0)
 . E  D  ;
"RTN","C0CDACV",224,0)
 . . I C0I=1 S RTN(C0I,"endDateTime")=$$NOW^XLFDT Q  ; 
"RTN","C0CDACV",225,0)
 . . S RTN(C0I,"endDateTime")=RTN(C0I-1,"date")
"RTN","C0CDACV",226,0)
 . S RTN(C0I,"typeCode")=$G(CCDAV(C0I,"visit","type@code"))
"RTN","C0CDACV",227,0)
 . S RTN(C0I,"typeName")=$G(CCDAV(C0I,"visit","type@name"))
"RTN","C0CDACV",228,0)
 . N VTYPE
"RTN","C0CDACV",229,0)
 . S VTYPE=$G(CCDAV(C0I,"visit","patientClass@value"))
"RTN","C0CDACV",230,0)
 . I VTYPE="" S VTYPE=$G(CCDAV(C0I,"visit","serviceCategory@code"))
"RTN","C0CDACV",231,0)
 . I VTYPE="" S VTYPE=$G(CCDAV(C0I,"visit","type@name"))
"RTN","C0CDACV",232,0)
 . S RTN(C0I,"visitType")=$S(VTYPE="A":"outpatient",VTYPE="I":"inpatient",VTYPE="H":"inpatient",VTYPE="AMB":"outpatient",VTYPE="IMP":"inpatient",VTYPE="HOSPITALIZATION":"inpatient",1:"outpatient")
"RTN","C0CDACV",233,0)
 . S RTN(C0I,"location")=$G(CCDAV(C0I,"visit","location@value"))
"RTN","C0CDACV",234,0)
 . S RTN(C0I,"reasonCode")=$G(CCDAV(C0I,"visit","reason@code"))
"RTN","C0CDACV",235,0)
 . S RTN(C0I,"reasonName")=$G(CCDAV(C0I,"visit","reason@name"))
"RTN","C0CDACV",236,0)
 Q
"RTN","C0CDACV",237,0)
 ;
"RTN","C0CDACV",238,0)
VIEWV(DFN,IN) ;
"RTN","C0CDACV",239,0)
 N G
"RTN","C0CDACV",240,0)
 I $D(IN) M G=IN
"RTN","C0CDACV",241,0)
 E  D VISITS(.G,DFN)
"RTN","C0CDACV",242,0)
 N GCNT S GCNT=$O(G("AAAAA"),-1)
"RTN","C0CDACV",243,0)
 N GI S GI=0
"RTN","C0CDACV",244,0)
 W !,"DATE  ","TYPE    ","    LOCATION","   REASON"
"RTN","C0CDACV",245,0)
 F  S GI=$O(G(GI)) Q:+GI=0  D  ;
"RTN","C0CDACV",246,0)
 . N GARR,GDIS
"RTN","C0CDACV",247,0)
 . S GARR=$G(G(GI,"arrivalDate")) I GARR'="" S GARR=$E($$HTMLDT^C0CDACU(GARR),1,11)
"RTN","C0CDACV",248,0)
 . S GDIS=$G(G(GI,"departureDate")) I GDIS'="" S GDIS=$E($$HTMLDT^C0CDACU(GDIS),1,11)
"RTN","C0CDACV",249,0)
 . W !,GI," ",$$HTMLDT^C0CDACU(G(GI,"date"))," ",GARR," ",GDIS," ",$G(G(GI,"typeCode"))," ",G(GI,"typeName"),"  ",G(GI,"visitType")," "
"RTN","C0CDACV",250,0)
 .  ;W !,GI," ",$$HTMLDT^C0CDACU(G(GI,"date"))," ",$G(G(GI,"typeCode")),"  ",G(GI,"visitType")," "
"RTN","C0CDACV",251,0)
 .  W $G(G(GI,"location")),"  ",G(GI,"reasonCode")
"RTN","C0CDACV",252,0)
 K DIR
"RTN","C0CDACV",253,0)
 S DIR(0)="N^1:"_GCNT
"RTN","C0CDACV",254,0)
 S DIR("B")=1
"RTN","C0CDACV",255,0)
 S DIR("L")="Please select encounter"
"RTN","C0CDACV",256,0)
 D ^DIR
"RTN","C0CDACV",257,0)
 Q:$G(Y)=""
"RTN","C0CDACV",258,0)
 M IN("PARMS")=G(Y)
"RTN","C0CDACV",259,0)
 I $G(IN("PARMS","visitType"))="inpatient" D  ;
"RTN","C0CDACV",260,0)
 . N PTMP M PTMP=IN("PARMS")
"RTN","C0CDACV",261,0)
 . D EXTENDIP^C0CDAC0(.G,.PTMP,Y)
"RTN","C0CDACV",262,0)
 . M IN("PARMS")=PTMP 
"RTN","C0CDACV",263,0)
 W !
"RTN","C0CDACV",264,0)
 ZWR IN("PARMS",*)
"RTN","C0CDACV",265,0)
 ;ZWR G(Y,*)
"RTN","C0CDACV",266,0)
 Q
"RTN","C0CDACV",267,0)
 ;
"RTN","C0CDACV",268,0)
VISITIEN(DFN,ADATE) ; extrinsic returns the ien in ^AUPNVSIT for the visit
"RTN","C0CDACV",269,0)
 N ZRD
"RTN","C0CDACV",270,0)
 S ZRD=$$RDATE(ADATE)
"RTN","C0CDACV",271,0)
 Q $O(^AUPNVSIT("AA",DFN,ZRD,""))
"RTN","C0CDACV",272,0)
 ;
"RTN","C0CDACV",273,0)
GETVISIT(ZRTN,DFN,ADATE)
"RTN","C0CDACV",274,0)
 N VIEN
"RTN","C0CDACV",275,0)
 S VIEN=$$VISITIEN(DFN,ADATE)
"RTN","C0CDACV",276,0)
 Q:VIEN=""
"RTN","C0CDACV",277,0)
 D FMX^KBAIQLD4(ZRTN,9000010,VIEN)
"RTN","C0CDACV",278,0)
 Q
"RTN","C0CDACV",279,0)
 ;
"RTN","C0CDACV",280,0)
VCPTIEN(DFN,ADATE) ; extrinsic returns the ien of the V CPT record
"RTN","C0CDACV",281,0)
 N VIEN
"RTN","C0CDACV",282,0)
 S VIEN=$$VISITIEN(DFN,ADATE)
"RTN","C0CDACV",283,0)
 Q:VIEN="" VIEN
"RTN","C0CDACV",284,0)
 Q $O(^AUPNVCPT("AD",VIEN,""))
"RTN","C0CDACV",285,0)
 ;
"RTN","C0CDACV",286,0)
GETVCPT(ZRTN,DFN,ADATE) ; get the FMX external format of the V CPT record for a visit
"RTN","C0CDACV",287,0)
 N VCPTIEN
"RTN","C0CDACV",288,0)
 S VCPTIEN=$$VCPTIEN(DFN,ADATE)
"RTN","C0CDACV",289,0)
 Q:VCPTIEN=""
"RTN","C0CDACV",290,0)
 D FMX^KBAIQLD4(ZRTN,9000010.18,VCPTIEN)
"RTN","C0CDACV",291,0)
 Q
"RTN","C0CDACV",292,0)
 ;
"RTN","C0CDACV",293,0)
STDCIEN(DFN,ADATE,VIEN) ; extrinsic returns ien in V STANDARD CODES file for visit at DFN,ADATE
"RTN","C0CDACV",294,0)
 I '$D(VIEN) S VIEN=$$VISITIEN(DFN,ADATE)
"RTN","C0CDACV",295,0)
 Q:VIEN="" VIEN
"RTN","C0CDACV",296,0)
 Q $O(^AUPNVSC("AD",VIEN,""))
"RTN","C0CDACV",297,0)
 Q
"RTN","C0CDACV",298,0)
GETSTDC(ZRTN,DFN,ADATE,VIEN) ; returns the FMX array of the V STANDARD CODES file for visit at DFN,ADATE
"RTN","C0CDACV",299,0)
 N SCIEN
"RTN","C0CDACV",300,0)
 S SCIEN=$$STDCIEN(DFN,$G(ADATE),$G(VIEN))
"RTN","C0CDACV",301,0)
 Q:SCIEN=""
"RTN","C0CDACV",302,0)
 D FMX^KBAIQLD4(ZRTN,9000010.71,SCIEN)
"RTN","C0CDACV",303,0)
 Q
"RTN","C0CDACV",304,0)
 ;
"RTN","C0CDACV",305,0)
ADDSTDC(ZARY,DFN) ; ZARY is passed by reference. stanard codes if any are added to the visit array
"RTN","C0CDACV",306,0)
 I '$D(^AUPNVSC) Q  ; standard codes file not installed
"RTN","C0CDACV",307,0)
 I '$D(ZARY) Q  ; nothing in the array
"RTN","C0CDACV",308,0)
 N C0CVST S C0CVST=0
"RTN","C0CDACV",309,0)
 F  S C0CVST=$O(ZARY(C0CVST)) Q:+C0CVST=0  D  ; for each visit
"RTN","C0CDACV",310,0)
 . N C0CVDT,C0CSCARY,C0CVIEN
"RTN","C0CDACV",311,0)
 . S C0CVIEN=$G(ZARY(C0CVST,"visit","id@value")) ; ien of the visit
"RTN","C0CDACV",312,0)
 . ;S C0CVDT=$G(ZARY(C0CVST,"visit","dataTime@value"))
"RTN","C0CDACV",313,0)
 . ;Q:'C0CVDT
"RTN","C0CDACV",314,0)
 . D GETSTDC("C0CSCARY",DFN,,C0CVIEN)
"RTN","C0CDACV",315,0)
 . Q:'$D(C0CSCARY)
"RTN","C0CDACV",316,0)
 . M ZARY(C0CVST,"visit","stdc")=C0CSCARY("V_STANDARD_CODES")
"RTN","C0CDACV",317,0)
 Q
"RTN","C0CDACV",318,0)
 ;
"RTN","C0CDACV",319,0)
RDATE(ADATE) ; extrinsic which returns the reverse index value for a data in FM format
"RTN","C0CDACV",320,0)
 N Z1,Z2,Z3
"RTN","C0CDACV",321,0)
 S Z1=$P(ADATE,".",1)
"RTN","C0CDACV",322,0)
 S Z2=$P(ADATE,".",2)
"RTN","C0CDACV",323,0)
 S Z3=9999999-Z1
"RTN","C0CDACV",324,0)
 S Z3=Z3_"."_Z2 ; date lookup value
"RTN","C0CDACV",325,0)
 Q Z3
"RTN","C0CDACV",326,0)
 ;
"RTN","C0CDACV",327,0)
TESTONE ; 
"RTN","C0CDACV",328,0)
 S DFN=$$PAT^C0CDAC0()
"RTN","C0CDACV",329,0)
 N GARY
"RTN","C0CDACV",330,0)
 ; FILTER1 shows all active meds and all inactive meds in the encounter time window
"RTN","C0CDACV",331,0)
 D VISITS^C0CDACV(.GARY,DFN)
"RTN","C0CDACV",332,0)
 S GARY("PARMS","MEDS")="FILTER1" ; options are ALL ACTIVE and FILTER1
"RTN","C0CDACV",333,0)
 S GARY("PARMS","INCLUDEPREVIOUSERVISIT")=1 ; trying this for a default
"RTN","C0CDACV",334,0)
 D VIEWV^C0CDACV(DFN,.GARY)
"RTN","C0CDACV",335,0)
 ;S GARY("PARMS","meds")="FILTER1" ; options are ALL ACTIVE and FILTER1
"RTN","C0CDACV",336,0)
 ;S GARY("PARMS","INCLUDEPREVIOUSERVISIT")=1 ; trying this for a default
"RTN","C0CDACV",337,0)
 N PRMS
"RTN","C0CDACV",338,0)
 M PRMS=GARY("PARMS")
"RTN","C0CDACV",339,0)
 D CCDARPC^C0CDAC0(.CCDA,DFN,.PRMS)
"RTN","C0CDACV",340,0)
 N ZTYPE S ZTYPE=PRMS("visitType")
"RTN","C0CDACV",341,0)
 ;D BROWSE^DDBR(CCDA,"N","PATIENT "_DFN_" "_ZTYPE)
"RTN","C0CDACV",342,0)
 W $$OUTCCDA^C0CDAC0(CCDA)
"RTN","C0CDACV",343,0)
 N GN S GN=""
"RTN","C0CDACV",344,0)
 K @GN,^TMP("MXMLDOM",$J),^TMP("VPR",$J),^TMP("CCDA",$J),GN
"RTN","C0CDACV",345,0)
 Q
"RTN","C0CDACV",346,0)
 ;
"RTN","C0CDACV",347,0)
TENC ; beginning of encounter
"RTN","C0CDACV",348,0)
 ;;<entry typeCode="DRIV">
"RTN","C0CDACV",349,0)
 ;;<encounter classCode="ENC" moodCode="EVN">
"RTN","C0CDACV",350,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.49"/>
"RTN","C0CDACV",351,0)
 ;;<!-- Encounter Activities -->
"RTN","C0CDACV",352,0)
 ;;<!--********Encounteractivitytemplate********-->
"RTN","C0CDACV",353,0)
 ;;<id root="@@encounterGuid@@"/>
"RTN","C0CDACV",354,0)
 ;;<code code="@@type@code@@" displayName="@@type@name@@" codeSystemName="CPT" codeSystem="2.16.140.1.113883.6.12" codeSystemVersion="4">
"RTN","C0CDACV",355,0)
 ;;<originalText>@@type@name@@<reference value="#@@uri@@"/>
"RTN","C0CDACV",356,0)
 ;;</originalText>
"RTN","C0CDACV",357,0)
 ;;</code>
"RTN","C0CDACV",358,0)
 ;;<effectiveTime value="@@effectiveTime@@"/>
"RTN","C0CDACV",359,0)
 ;;<performer>
"RTN","C0CDACV",360,0)
 ;;<assignedEntity>
"RTN","C0CDACV",361,0)
 ;;<id root="@@encounterGuid@@"/>
"RTN","C0CDACV",362,0)
 ;;<code code="59058001" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED CT" displayName="General Physician"/>
"RTN","C0CDACV",363,0)
 ;;</assignedEntity>
"RTN","C0CDACV",364,0)
 ;;</performer>
"RTN","C0CDACV",365,0)
 ;;<participant typeCode="LOC">
"RTN","C0CDACV",366,0)
 ;;<participantRole classCode="SDLOC">
"RTN","C0CDACV",367,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.32"/>
"RTN","C0CDACV",368,0)
 ;;<!-- Service Delivery Location template -->
"RTN","C0CDACV",369,0)
 ;;<code code="@@locationLoincCode@@" codeSystem="2.16.840.1.113883.6.259" codeSystemName="HealthcareServiceLocation" displayName="@@locationLoincName@@"/>
"RTN","C0CDACV",370,0)
 ;;<addr>
"RTN","C0CDACV",371,0)
 ;;<streetAddressLine>@@orgAddr@@</streetAddressLine>
"RTN","C0CDACV",372,0)
 ;;<city>@@orgCity@@</city>
"RTN","C0CDACV",373,0)
 ;;<state>@@orgState@@</state>
"RTN","C0CDACV",374,0)
 ;;<postalCode>@@orgZip@@</postalCode>
"RTN","C0CDACV",375,0)
 ;;<country>US</country>
"RTN","C0CDACV",376,0)
 ;;</addr>
"RTN","C0CDACV",377,0)
 ;;<telecom use="WP" value="@@orgTelephone@@"></telecom>
"RTN","C0CDACV",378,0)
 ;;<playingEntity classCode="PLC">
"RTN","C0CDACV",379,0)
 ;;<name>@@orgName@@</name>
"RTN","C0CDACV",380,0)
 ;;</playingEntity>
"RTN","C0CDACV",381,0)
 ;;</participantRole>
"RTN","C0CDACV",382,0)
 ;;</participant>
"RTN","C0CDACV",383,0)
 Q
"RTN","C0CDACV",384,0)
 ;
"RTN","C0CDACV",385,0)
TENCFND ; encounter finding
"RTN","C0CDACV",386,0)
 ;;<entryRelationship typeCode="RSON">
"RTN","C0CDACV",387,0)
 ;;<observation classCode="OBS" moodCode="EVN">
"RTN","C0CDACV",388,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.19"/>
"RTN","C0CDACV",389,0)
 ;;<id root="db734647-fc99-424c-a864-7e3cda82e703" extension="45665"/>
"RTN","C0CDACV",390,0)
 ;;<code code="404684003" displayName="Finding" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED CT"/>
"RTN","C0CDACV",391,0)
 ;;<statusCode code="completed"/>
"RTN","C0CDACV",392,0)
 ;;<effectiveTime>
"RTN","C0CDACV",393,0)
 ;;<low value="20120806"/>
"RTN","C0CDACV",394,0)
 ;;</effectiveTime>
"RTN","C0CDACV",395,0)
 ;;<value xsi:type="CD" code="233604007" displayName="Pneumonia" codeSystem="2.16.840.1.113883.6.96"/>
"RTN","C0CDACV",396,0)
 ;;</observation>
"RTN","C0CDACV",397,0)
 ;;</entryRelationship>
"RTN","C0CDACV",398,0)
 Q
"RTN","C0CDACV",399,0)
 ;
"RTN","C0CDACV",400,0)
TENCDIAG ; encounter diagnosis
"RTN","C0CDACV",401,0)
 ;;<entryRelationship typeCode="SUBJ" inversionInd="false">
"RTN","C0CDACV",402,0)
 ;;<act classCode="ACT" moodCode="EVN">
"RTN","C0CDACV",403,0)
 ;;<!--Encounter diagnosis act -->
"RTN","C0CDACV",404,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.80"/>
"RTN","C0CDACV",405,0)
 ;;<id root="5a784260-6856-4f38-9638-80c751aff2fb"/>
"RTN","C0CDACV",406,0)
 ;;<code xsi:type="CE" code="29308-4" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="ENCOUNTER DIAGNOSIS"/>
"RTN","C0CDACV",407,0)
 ;;<statusCode code="active"/>
"RTN","C0CDACV",408,0)
 ;;<effectiveTime>
"RTN","C0CDACV",409,0)
 ;;<low value="@@effectiveTime@@"/>
"RTN","C0CDACV",410,0)
 ;;</effectiveTime>
"RTN","C0CDACV",411,0)
 ;;<entryRelationship typeCode="SUBJ" inversionInd="false">
"RTN","C0CDACV",412,0)
 ;;<observation classCode="OBS" moodCode="EVN" negationInd="false">
"RTN","C0CDACV",413,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.4"/>
"RTN","C0CDACV",414,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.4.4" extension="2015-08-01"/>
"RTN","C0CDACV",415,0)
 ;;<!-- Problem Observation -->
"RTN","C0CDACV",416,0)
 ;;<id root="ab1791b0-5c71-11db-b0de-0800200c9a66"/>
"RTN","C0CDACV",417,0)
 ;;<code code="409586006" codeSystem="2.16.840.1.113883.6.96" displayName="Complaint">
"RTN","C0CDACV",418,0)
 ;;<translation code="75326-9" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Problem"/>
"RTN","C0CDACV",419,0)
 ;;</code>
"RTN","C0CDACV",420,0)
 ;;<statusCode code="completed"/>
"RTN","C0CDACV",421,0)
 ;;<effectiveTime>
"RTN","C0CDACV",422,0)
 ;;<low value="@@effectiveTime@@"/>
"RTN","C0CDACV",423,0)
 ;;</effectiveTime>
"RTN","C0CDACV",424,0)
 ;;<value xsi:type="CD" code="@@reasonCode@@" codeSystem="2.16.840.1.113883.6.96" displayName="@@reasonName@@"/>
"RTN","C0CDACV",425,0)
 ;;</observation>
"RTN","C0CDACV",426,0)
 ;;</entryRelationship>
"RTN","C0CDACV",427,0)
 ;;</act>
"RTN","C0CDACV",428,0)
 ;;</entryRelationship>
"RTN","C0CDACV",429,0)
 Q
"RTN","C0CDACV",430,0)
 ;
"RTN","C0CDACV",431,0)
TENCEND ; end of one encounter
"RTN","C0CDACV",432,0)
 ;;</encounter>
"RTN","C0CDACV",433,0)
 ;;</entry>
"RTN","C0CDACV",434,0)
 Q
"RTN","C0CDACV",435,0)
 ;
"RTN","C0CDACV",436,0)
TENCSEND ; end of section
"RTN","C0CDACV",437,0)
 ;;</section>
"RTN","C0CDACV",438,0)
 ;;</component>
"RTN","C0CDACV",439,0)
 Q
"RTN","C0CDACV",440,0)
 ;
"RTN","C0CDACW")
0^21^B10312003
"RTN","C0CDACW",1,0)
C0CDACW ; GPL - Patient Portal - CCDA HTML Report Routines ;3/1/15  17:05
"RTN","C0CDACW",2,0)
 ;;0.1;JJOHPP;nopatch;noreleasedate;Build 1
"RTN","C0CDACW",3,0)
 ;
"RTN","C0CDACW",4,0)
 ; License AGPL v3.0
"RTN","C0CDACW",5,0)
 ; 
"RTN","C0CDACW",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDACW",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDACW",8,0)
 ;
"RTN","C0CDACW",9,0)
 Q
"RTN","C0CDACW",10,0)
 ;
"RTN","C0CDACW",11,0)
GENHTML(HOUT,HARY) ; generate an HTML table from array HARY
"RTN","C0CDACW",12,0)
 ; HOUT AND HARY are passed by name
"RTN","C0CDACW",13,0)
 ;
"RTN","C0CDACW",14,0)
 ; format of the table:
"RTN","C0CDACW",15,0)
 ;  HARY("TITLE")="Problem List"
"RTN","C0CDACW",16,0)
 ;  HARY("HEADER",1)="column 1 header"
"RTN","C0CDACW",17,0)
 ;  HARY("HEADER",2)="col 2 header"
"RTN","C0CDACW",18,0)
 ;  HARY(1,1)="row 1 col1 value"
"RTN","C0CDACW",19,0)
 ;  HARY(1,2)="row 1 col2 value"
"RTN","C0CDACW",20,0)
 ;  HARY(1,2,"ID")="the ID of the element" 
"RTN","C0CDACW",21,0)
 ;  etc...
"RTN","C0CDACW",22,0)
 ;
"RTN","C0CDACW",23,0)
 N C0I,C0J
"RTN","C0CDACW",24,0)
 D ADDTO(HOUT,"<div align=""center"">")
"RTN","C0CDACW",25,0)
 ;I $D(@HARY@("TITLE")) D  ;
"RTN","C0CDACW",26,0)
 ;. N X
"RTN","C0CDACW",27,0)
 ;. S X="<title>"_@HARY@("TITLE")_"</title>"
"RTN","C0CDACW",28,0)
 ;. D ADDTO(HOUT,X)
"RTN","C0CDACW",29,0)
 D ADDTO(HOUT,"<text>")
"RTN","C0CDACW",30,0)
 D ADDTO(HOUT,"<table border=""1"" style=""width:80%"">")
"RTN","C0CDACW",31,0)
 I $D(@HARY@("TITLE")) D  ;
"RTN","C0CDACW",32,0)
 . N X
"RTN","C0CDACW",33,0)
 . S X="<caption><b>"_@HARY@("TITLE")_"</b></caption>"
"RTN","C0CDACW",34,0)
 . D ADDTO(HOUT,X)
"RTN","C0CDACW",35,0)
 I $D(@HARY@("HEADER")) D  ;
"RTN","C0CDACW",36,0)
 . D ADDTO(HOUT,"<thead>")
"RTN","C0CDACW",37,0)
 . D ADDTO(HOUT,"<tr>")
"RTN","C0CDACW",38,0)
 . S C0I=0
"RTN","C0CDACW",39,0)
 . F  S C0I=$O(@HARY@("HEADER",C0I)) Q:+C0I=0  D  ;
"RTN","C0CDACW",40,0)
 . . D ADDTO(HOUT,"<th>"_@HARY@("HEADER",C0I)_"</th>")
"RTN","C0CDACW",41,0)
 . D ADDTO(HOUT,"</tr>")
"RTN","C0CDACW",42,0)
 . D ADDTO(HOUT,"</thead>")
"RTN","C0CDACW",43,0)
 D ADDTO(HOUT,"<tbody>")
"RTN","C0CDACW",44,0)
 I $D(@HARY@(1)) D  ;
"RTN","C0CDACW",45,0)
 . S C0I=0 S C0J=0
"RTN","C0CDACW",46,0)
 . F  S C0I=$O(@HARY@(C0I)) Q:+C0I=0  D  ;
"RTN","C0CDACW",47,0)
 . . D ADDTO(HOUT,"<tr>")
"RTN","C0CDACW",48,0)
 . . F  S C0J=$O(@HARY@(C0I,C0J)) Q:+C0J=0  D  ;
"RTN","C0CDACW",49,0)
 . . . N UID S UID=$G(@HARY@(C0I,C0J,"ID"))
"RTN","C0CDACW",50,0)
 . . . I UID'="" D ADDTO(HOUT,"<td style=""padding:5px;"" ID="""_UID_""">"_@HARY@(C0I,C0J)_"</td>")
"RTN","C0CDACW",51,0)
 . . . E  D ADDTO(HOUT,"<td style=""padding:5px;"">"_@HARY@(C0I,C0J)_"</td>")
"RTN","C0CDACW",52,0)
 . . D ADDTO(HOUT,"</tr>")
"RTN","C0CDACW",53,0)
 D ADDTO(HOUT,"</tbody>")
"RTN","C0CDACW",54,0)
 D ADDTO(HOUT,"</table>")
"RTN","C0CDACW",55,0)
 D ADDTO(HOUT,"</text>")
"RTN","C0CDACW",56,0)
 D ADDTO(HOUT,"</div>")
"RTN","C0CDACW",57,0)
 Q
"RTN","C0CDACW",58,0)
 ;
"RTN","C0CDACW",59,0)
GENVHTML(HOUT,HARY) ; generate a vertical HTML table from array HARY
"RTN","C0CDACW",60,0)
 ; headers are in the first row
"RTN","C0CDACW",61,0)
 ; HOUT AND HARY are passed by name
"RTN","C0CDACW",62,0)
 ;
"RTN","C0CDACW",63,0)
 ; format of the table:
"RTN","C0CDACW",64,0)
 ;  HARY("TITLE")="Problem List"
"RTN","C0CDACW",65,0)
 ;  HARY("HEADER",1)="row 1 column 1 header"
"RTN","C0CDACW",66,0)
 ;  HARY("HEADER",2)="row 2 col 2 header"
"RTN","C0CDACW",67,0)
 ;  HARY(1,1)="row 1 col2 value"
"RTN","C0CDACW",68,0)
 ;  HARY(2,1)="row 2 col2 value"
"RTN","C0CDACW",69,0)
 ;  etc...
"RTN","C0CDACW",70,0)
 ;
"RTN","C0CDACW",71,0)
 N C0I,C0J
"RTN","C0CDACW",72,0)
 D ADDTO(HOUT,"<div align=""center"">")
"RTN","C0CDACW",73,0)
 D ADDTO(HOUT,"<text>")
"RTN","C0CDACW",74,0)
 D ADDTO(HOUT,"<table border=""1"" style=""width:40%"">")
"RTN","C0CDACW",75,0)
 I $D(@HARY@("TITLE")) D  ;
"RTN","C0CDACW",76,0)
 . N X
"RTN","C0CDACW",77,0)
 . S X="<caption><b>"_@HARY@("TITLE")_"</b></caption>"
"RTN","C0CDACW",78,0)
 . D ADDTO(HOUT,X)
"RTN","C0CDACW",79,0)
 I $D(@HARY@("HEADER")) D  ;
"RTN","C0CDACW",80,0)
 . D ADDTO(HOUT,"<tr>")
"RTN","C0CDACW",81,0)
 . S C0I=0
"RTN","C0CDACW",82,0)
 . F  S C0I=$O(@HARY@("HEADER",C0I)) Q:+C0I=0  D  ;
"RTN","C0CDACW",83,0)
 . . D ADDTO(HOUT,"<th style=""padding:5px;"">"_@HARY@("HEADER",C0I)_"</th>")
"RTN","C0CDACW",84,0)
 . . D ADDTO(HOUT,"<td style=""padding:5px;"">"_@HARY@(C0I,1)_"</td>")
"RTN","C0CDACW",85,0)
 . D ADDTO(HOUT,"</tr>")
"RTN","C0CDACW",86,0)
 D ADDTO(HOUT,"</table>")
"RTN","C0CDACW",87,0)
 D ADDTO(HOUT,"</text>")
"RTN","C0CDACW",88,0)
 D ADDTO(HOUT,"</div>")
"RTN","C0CDACW",89,0)
 Q
"RTN","C0CDACW",90,0)
 ;
"RTN","C0CDACW",91,0)
ADDTO(DEST,WHAT) ; adds string WHAT to list DEST 
"RTN","C0CDACW",92,0)
 ; DEST is passed by name
"RTN","C0CDACW",93,0)
 N GN
"RTN","C0CDACW",94,0)
 S GN=$O(@DEST@("AAAAAA"),-1)+1
"RTN","C0CDACW",95,0)
 S @DEST@(GN)=WHAT
"RTN","C0CDACW",96,0)
 S @DEST@(0)=GN ; count
"RTN","C0CDACW",97,0)
 Q
"RTN","C0CDACW",98,0)
 ;
"RTN","C0CDACW",99,0)
HREF(URL,TAG) ; extrinsic to return an html href statement
"RTN","C0CDACW",100,0)
 N RTN
"RTN","C0CDACW",101,0)
 I $D(TAG) S RTN="<a href="""_URL_""" target="""_URL_""">"_TAG_"</a>"
"RTN","C0CDACW",102,0)
 E  S RTN="<a href="""_URL_""" target="""_URL_""">"_URL_"</a>"
"RTN","C0CDACW",103,0)
 Q RTN
"RTN","C0CDACW",104,0)
 ;
"RTN","C0CDACZ")
0^22^B219667
"RTN","C0CDACZ",1,0)
C0CDACZ ; GPL - Patient Portal - CCDA Test Routines ;09/17/13  17:05
"RTN","C0CDACZ",2,0)
 ;;0.1;JJOHPP;nopatch;noreleasedate;Build 1
"RTN","C0CDACZ",3,0)
 ;
"RTN","C0CDACZ",4,0)
 ; License AGPL v3.0
"RTN","C0CDACZ",5,0)
 ; 
"RTN","C0CDACZ",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDACZ",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDACZ",8,0)
 ;
"RTN","C0CDACZ",9,0)
 Q
"RTN","C0CDACZ",10,0)
 ;
"RTN","C0CDACZ",11,0)
TESTDIR() ; extrinsic which returns the diretory to use to write out
"RTN","C0CDACZ",12,0)
 ; test files
"RTN","C0CDACZ",13,0)
 ;Q "/home/vista/CCDA/"
"RTN","C0CDACZ",14,0)
 Q "/home/astrovistaEHR/www/"  ; for astronaut testing
"RTN","C0CDACZ",15,0)
 ;
"RTN","C0CDAD2")
0^23^B230502977
"RTN","C0CDAD2",1,0)
C0CDAC2 ; GPL - Patient Portal - CCDA Header Routines ;/14/13  17:05
"RTN","C0CDAD2",2,0)
 ;;0.1;C0CDA;nopatch;noreleasedate;Build 1
"RTN","C0CDAD2",3,0)
 ;
"RTN","C0CDAD2",4,0)
 ; License AGPL v3.0
"RTN","C0CDAD2",5,0)
 ; 
"RTN","C0CDAD2",6,0)
 ; This software was funded in part by Oroville Hospital, and was
"RTN","C0CDAD2",7,0)
 ; created with help from Oroville's doctors and staff.
"RTN","C0CDAD2",8,0)
 ;
"RTN","C0CDAD2",9,0)
 Q
"RTN","C0CDAD2",10,0)
 ;
"RTN","C0CDAD2",11,0)
GETHDR(RTN,DFN) ; returns the built header xml
"RTN","C0CDAD2",12,0)
 N GBLD,GWRK,GRPT
"RTN","C0CDAD2",13,0)
 S GWRK=$NA(^TMP("CCDA",$J))
"RTN","C0CDAD2",14,0)
 K @GWRK
"RTN","C0CDAD2",15,0)
 S GBLD=$NA(@GWRK@("BLDLIST"))
"RTN","C0CDAD2",16,0)
 S GRPT=$NA(@GWRK@("CTRL","HEADER"))
"RTN","C0CDAD2",17,0)
 D HEADER(GBLD,DFN,GWRK)
"RTN","C0CDAD2",18,0)
 D BUILD^MXMLTMPL(GBLD,RTN)
"RTN","C0CDAD2",19,0)
 N G2
"RTN","C0CDAD2",20,0)
 D MISSING^MXMLTMPL(RTN,"G2")
"RTN","C0CDAD2",21,0)
 I $D(G2) D  ;
"RTN","C0CDAD2",22,0)
 . W !,"MISSING VARIABLES"
"RTN","C0CDAD2",23,0)
 . ZWR G2
"RTN","C0CDAD2",24,0)
 Q
"RTN","C0CDAD2",25,0)
 ;
"RTN","C0CDAD2",26,0)
HEADER(CCDABLD,DFN,CCDAWRK,CCDARPT,CCDACTRL) ; create a ccda header for patient DFN
"RTN","C0CDAD2",27,0)
 ; use workarea CCDAWRK passed by name
"RTN","C0CDAD2",28,0)
 ; return a build list in CCDABLD passed by name
"RTN","C0CDAD2",29,0)
 ;
"RTN","C0CDAD2",30,0)
 ; the header includes the start of the CCDA document and the patient, author
"RTN","C0CDAD2",31,0)
 ; documentationOf and componentOf sections
"RTN","C0CDAD2",32,0)
 ;
"RTN","C0CDAD2",33,0)
 I '$D(CCDAWRK) S CCDAWRK=$NA(^TMP("CCDA",$J))
"RTN","C0CDAD2",34,0)
 N CCDAV,CCDARTN,PARMS,HAVDTS
"RTN","C0CDAD2",35,0)
 I $D(@CCDACTRL@("PARMS")) M PARMS=@CCDACTRL@("PARMS")
"RTN","C0CDAD2",36,0)
 S HAVDTS=0
"RTN","C0CDAD2",37,0)
 I $D(PARMS("startDateTime")) S HAVDTS=1
"RTN","C0CDAD2",38,0)
 D GETPAT^C0CDACD(.CCDARTN,DFN,"demographics") ; get patient demographics
"RTN","C0CDAD2",39,0)
 M CCDAV=CCDARTN("patient",1)
"RTN","C0CDAD2",40,0)
 N G2
"RTN","C0CDAD2",41,0)
 D  ;
"RTN","C0CDAD2",42,0)
 . S G2(1)="address@stateProvince"
"RTN","C0CDAD2",43,0)
 . S G2(2)="address@city"
"RTN","C0CDAD2",44,0)
 . S G2(3)="address@postalCode"
"RTN","C0CDAD2",45,0)
 . S G2(4)="address@streetLine1"
"RTN","C0CDAD2",46,0)
 N ZI S ZI=""
"RTN","C0CDAD2",47,0)
 F  S ZI=$O(G2(ZI)) Q:ZI=""  D  ;
"RTN","C0CDAD2",48,0)
 . N GV S GV=G2(ZI)
"RTN","C0CDAD2",49,0)
 . I '$D(CCDAV(GV)) S CCDAV(GV)=""
"RTN","C0CDAD2",50,0)
 D SETORGV(.CCDAV)
"RTN","C0CDAD2",51,0)
 ; give the ability to pass in the docId as a parameter
"RTN","C0CDAD2",52,0)
 I $G(PARMS("docId"))'="" S CCDAV("docNumber")=PARMS("docId")
"RTN","C0CDAD2",53,0)
 I $G(PARMS("error"))'="" D  Q  ;
"RTN","C0CDAD2",54,0)
 . S @CCDACTRL@("PARMS","error")=$G(PARMS("error"))
"RTN","C0CDAD2",55,0)
 D SETPATV(.CCDAV)
"RTN","C0CDAD2",56,0)
 ; import episode date and text from parms
"RTN","C0CDAD2",57,0)
 N C0D S C0D=$G(PARMS("date"))
"RTN","C0CDAD2",58,0)
 ;
"RTN","C0CDAD2",59,0)
 ; for wvCQM certification
"RTN","C0CDAD2",60,0)
 ;
"RTN","C0CDAD2",61,0)
 N C0DLOW S C0DLOW=$G(PARMS("dateLow"))
"RTN","C0CDAD2",62,0)
 S C0DLOW=3150101
"RTN","C0CDAD2",63,0)
 S C0D=3151231
"RTN","C0CDAD2",64,0)
 I C0DLOW'="" S CCDAV("docOfDateLow")=$$FMDTOUTC^C0CDACU(C0DLOW)
"RTN","C0CDAD2",65,0)
 ;
"RTN","C0CDAD2",66,0)
 I C0D'="" S CCDAV("docOfDate")=$$FMDTOUTC^C0CDACU(C0D)
"RTN","C0CDAD2",67,0)
 ;S CCDAV("docCreated")=$$FMDTOUTC^C0CDACU($$NOW^XLFDT())
"RTN","C0CDAD2",68,0)
 S CCDAV("docCreated")=$$FMDTOUTC^C0CDACU(C0D)
"RTN","C0CDAD2",69,0)
 S CCDAV("encompassingEncounterExtension")=$$UUID^C0CDACU() ; random
"RTN","C0CDAD2",70,0)
 I C0D'="" S CCDAV("encompassingEncounterEffectiveTime")=$$FMDTOUTC^C0CDACU(C0D)
"RTN","C0CDAD2",71,0)
 N CCDATYPE,WRK
"RTN","C0CDAD2",72,0)
 ; build the header
"RTN","C0CDAD2",73,0)
 S CCDATYPE="HEADER"
"RTN","C0CDAD2",74,0)
 S WRK=$NA(@CCDAWRK@(CCDATYPE))
"RTN","C0CDAD2",75,0)
 D GETNMAP^C0CDACU(WRK,"THEADER^C0CDAC2","CCDAV")
"RTN","C0CDAD2",76,0)
 D QUEUE^MXMLTMPL(CCDABLD,WRK,1,@WRK@(0))
"RTN","C0CDAD2",77,0)
 ;N LAST1
"RTN","C0CDAD2",78,0)
 ;S LAST1(1)="</structuredBody>"
"RTN","C0CDAD2",79,0)
 ;S LAST1(2)="</component>"
"RTN","C0CDAD2",80,0)
 ;S LAST1(3)="</ClinicalDocument>" ; do this after all the rest
"RTN","C0CDAD2",81,0)
 ;S LAST1(0)=3 ; count
"RTN","C0CDAD2",82,0)
 ; build the author
"RTN","C0CDAD2",83,0)
 S CCDATYPE="AUTHOR"
"RTN","C0CDAD2",84,0)
 S WRK=$NA(@CCDAWRK@(CCDATYPE))
"RTN","C0CDAD2",85,0)
 D GETNMAP^C0CDACU(WRK,"TAUTHOR^C0CDAC2","CCDAV")
"RTN","C0CDAD2",86,0)
 D QUEUE^MXMLTMPL(CCDABLD,WRK,1,@WRK@(0))
"RTN","C0CDAD2",87,0)
 ; build the documentationOf
"RTN","C0CDAD2",88,0)
 S CCDATYPE="DOCOF"
"RTN","C0CDAD2",89,0)
 S WRK=$NA(@CCDAWRK@(CCDATYPE))
"RTN","C0CDAD2",90,0)
 D GETNMAP^C0CDACU(WRK,"TDOCOF^C0CDAC2","CCDAV")
"RTN","C0CDAD2",91,0)
 D QUEUE^MXMLTMPL(CCDABLD,WRK,1,@WRK@(0))
"RTN","C0CDAD2",92,0)
 ; build the componentOf
"RTN","C0CDAD2",93,0)
 S CCDATYPE="COMPOF"
"RTN","C0CDAD2",94,0)
 S WRK=$NA(@CCDAWRK@(CCDATYPE))
"RTN","C0CDAD2",95,0)
 D GETNMAP^C0CDACU(WRK,"TCOMPOF^C0CDAC2","CCDAV")
"RTN","C0CDAD2",96,0)
 D QUEUE^MXMLTMPL(CCDABLD,WRK,1,@WRK@(0))
"RTN","C0CDAD2",97,0)
 ; build the last lines - MOVED TO C0
"RTN","C0CDAD2",98,0)
 ;S CCDATYPE="LAST"
"RTN","C0CDAD2",99,0)
 ;S WRK=$NA(@CCDAWRK@(CCDATYPE))
"RTN","C0CDAD2",100,0)
 ;M @WRK=LAST1
"RTN","C0CDAD2",101,0)
 ;D QUEUE^MXMLTMPL(CCDABLD,WRK,1,@WRK@(0))
"RTN","C0CDAD2",102,0)
 ;
"RTN","C0CDAD2",103,0)
 Q
"RTN","C0CDAD2",104,0)
 ;
"RTN","C0CDAD2",105,0)
TEST ;
"RTN","C0CDAD2",106,0)
 N GBLD
"RTN","C0CDAD2",107,0)
 S GBLD=$NA(^TMP("CCDA",$J,"BLDLIST"))
"RTN","C0CDAD2",108,0)
 S CCDAWORK=$NA(^TMP("CCDA",$J))
"RTN","C0CDAD2",109,0)
 S DFN=2
"RTN","C0CDAD2",110,0)
 D HEADER(GBLD,DFN,CCDAWORK)
"RTN","C0CDAD2",111,0)
 ; try building the document
"RTN","C0CDAD2",112,0)
 N CCDA S CCDA=$NA(@CCDAWORK@("XML"))
"RTN","C0CDAD2",113,0)
 D BUILD^MXMLTMPL(GBLD,CCDA)
"RTN","C0CDAD2",114,0)
 K @CCDA@(0)
"RTN","C0CDAD2",115,0)
 N GF S GF=$$FMDTOUTC^C0CDACU($$NOW^XLFDT)_"-HEADER-"_DFN_".xml"
"RTN","C0CDAD2",116,0)
 W $$GTF^%ZISH($na(@CCDA@(1)),4,$$TESTDIR^C0CDACZ(),GF)
"RTN","C0CDAD2",117,0)
 Q
"RTN","C0CDAD2",118,0)
 ;
"RTN","C0CDAD2",119,0)
SETORGV(ARY,ADUZ,ADUZ2) ; sets organization variables based on the DUZ
"RTN","C0CDAD2",120,0)
 ; ARY is passed by reference
"RTN","C0CDAD2",121,0)
 ; optional pass in the DUZ to use. otherwise the current DUZ is used
"RTN","C0CDAD2",122,0)
 ; ADUZ is the person to use ADUZ2 is the institution in DUZ(2) to use
"RTN","C0CDAD2",123,0)
 ;
"RTN","C0CDAD2",124,0)
 ;S ARY("orgOID")="2.16.840.1.113883.5.83" ; WORLDVISTA HL7 OID -
"RTN","C0CDAD2",125,0)
 S ARY("orgOID")=$$ORGOID^C0CDACU() ; look up the oid
"RTN","C0CDAD2",126,0)
 ; REPLACE WITH OROVILLE OID
"RTN","C0CDAD2",127,0)
 S ARY("docNumber")="10C3FBF4-D8EC-11E2-92F7-1708D1228400" ; make random
"RTN","C0CDAD2",128,0)
 S ARY("docNumber")=$$UUID^C0CDACU() ; random
"RTN","C0CDAD2",129,0)
 N UDUZ,UDUZ2
"RTN","C0CDAD2",130,0)
 I $G(ADUZ)="" D  ;
"RTN","C0CDAD2",131,0)
 . S UDUZ=DUZ ; use current DUZ values
"RTN","C0CDAD2",132,0)
 . S UDUZ2=$G(DUZ(2))
"RTN","C0CDAD2",133,0)
 E  D  ;
"RTN","C0CDAD2",134,0)
 . S UDUZ=$G(ADUZ)
"RTN","C0CDAD2",135,0)
 . S UDUZ2=$G(ADUZ2)
"RTN","C0CDAD2",136,0)
 I UDUZ2="" D  Q  ;
"RTN","C0CDAD2",137,0)
 . S PARMS("error")=$G(DUZ(2))_" INSTITUTION NOT KNOWN - EXITING"
"RTN","C0CDAD2",138,0)
 . W:$G(DEBUG) !,$G(DUZ(2))," INSTITUTION NOT KNOWN - EXITING"
"RTN","C0CDAD2",139,0)
 S ARY("orgName")=$$GET1^DIQ(4,UDUZ2_",",.01) ; org name from Institution file
"RTN","C0CDAD2",140,0)
 S ARY("orgState")=$$GET1^DIQ(4,UDUZ2_",",.02) ; 
"RTN","C0CDAD2",141,0)
 S ARY("orgCity")=$$GET1^DIQ(4,UDUZ2_",",1.03) ; 
"RTN","C0CDAD2",142,0)
 S ARY("orgZip")=$$GET1^DIQ(4,UDUZ2_",",1.04) ; 
"RTN","C0CDAD2",143,0)
 S ARY("orgAddr")=$$GET1^DIQ(4,UDUZ2_",",1.01) ; 
"RTN","C0CDAD2",144,0)
 S ARY("orgShortName")=$$GET1^DIQ(4,UDUZ2_",",.05) ; 
"RTN","C0CDAD2",145,0)
 S ARY("orgNPI")=$$GET1^DIQ(4,UDUZ2_",",41.99) ;
"RTN","C0CDAD2",146,0)
 I $G(ARY("orgNPI"))="" S ARY("orgNPI")="UNK" 
"RTN","C0CDAD2",147,0)
 S ARY("healthCareFacilityExtension")=UDUZ2_"^"_ARY("orgShortName")
"RTN","C0CDAD2",148,0)
 S ARY("orgTelephone")="tel:"_$$GET1^DIQ(4.03,"1,"_UDUZ2_",",.03)
"RTN","C0CDAD2",149,0)
 N NAME S NAME=$P(^VA(200,UDUZ,0),U)
"RTN","C0CDAD2",150,0)
 D NAMECOMP^XLFNAME(.NAME)
"RTN","C0CDAD2",151,0)
 S ARY("assignedPersonGivenName")=NAME("GIVEN")
"RTN","C0CDAD2",152,0)
 S ARY("assignedPersonFamilyName")=NAME("FAMILY")
"RTN","C0CDAD2",153,0)
 S ARY("assignedPersonSuffix")=""
"RTN","C0CDAD2",154,0)
 I $G(NAME("SUFFIX"))'="" S ARY("assignedPersonSuffix")="<suffix>"_NAME("SUFFIX")_"</suffix>"
"RTN","C0CDAD2",155,0)
 S ARY("authorTime")=$$FMDTOUTC^C0CDACU($$NOW^XLFDT,"DT")
"RTN","C0CDAD2",156,0)
 Q
"RTN","C0CDAD2",157,0)
 ;
"RTN","C0CDAD2",158,0)
SETPATV(ARY) ; set patient variables
"RTN","C0CDAD2",159,0)
 ;
"RTN","C0CDAD2",160,0)
 ; this is the method that the extract uses for demographics
"RTN","C0CDAD2",161,0)
 ; we need to pull out the display text which is not included in
"RTN","C0CDAD2",162,0)
 ; the extract
"RTN","C0CDAD2",163,0)
 ;
"RTN","C0CDAD2",164,0)
 N VADM,VA,VAERR,X
"RTN","C0CDAD2",165,0)
 S X=+$$GETICN^MPIF001(DFN)
"RTN","C0CDAD2",166,0)
 D DEM^VADPT
"RTN","C0CDAD2",167,0)
 ;
"RTN","C0CDAD2",168,0)
 N VPRDEM,VPRDEM1
"RTN","C0CDAD2",169,0)
 D GETPAT^C0CDACE(.VPRDEM1,DFN,"demographics") ; to get codes
"RTN","C0CDAD2",170,0)
 S VPRDEM=$NA(VPRDEM1("results","demographics","patient"))
"RTN","C0CDAD2",171,0)
 ;
"RTN","C0CDAD2",172,0)
 I '$D(ARY("icn@value")) S ARY("icn@value")="UNK"
"RTN","C0CDAD2",173,0)
 N DOB S DOB=$$FMDTOUTC^C0CDACU(ARY("dob@value"))
"RTN","C0CDAD2",174,0)
 I $L(DOB)<14 S DOB=DOB_$E("00000000000000",1,14-$L(DOB))
"RTN","C0CDAD2",175,0)
 S ARY("birthTime")=DOB
"RTN","C0CDAD2",176,0)
 ; gpl astro
"RTN","C0CDAD2",177,0)
 N GNAME S GNAME=$G(@VPRDEM@("givenNames@value"))
"RTN","C0CDAD2",178,0)
 I GNAME[" " D  ; there is a middle name
"RTN","C0CDAD2",179,0)
 . S ARY("given1")=""
"RTN","C0CDAD2",180,0)
 . S ARY("given2")=""
"RTN","C0CDAD2",181,0)
 . S ARY("given1")=$P(GNAME," ",1)
"RTN","C0CDAD2",182,0)
 . S ARY("given2")=$P(GNAME," ",2)
"RTN","C0CDAD2",183,0)
 ; end gpl astro
"RTN","C0CDAD2",184,0)
 ;S ARY("maritalCode")=$P(VADM(10),U,1)
"RTN","C0CDAD2",185,0)
 N MARCD
"RTN","C0CDAD2",186,0)
 S MARCD=$G(@VPRDEM@("maritalStatus@value"))
"RTN","C0CDAD2",187,0)
 I MARCD="S" S MARCD="L" ; legally separated
"RTN","C0CDAD2",188,0)
 I MARCD="N" S MARCD="S" ; never married
"RTN","C0CDAD2",189,0)
 ;
"RTN","C0CDAD2",190,0)
 ; Here is the value set 2.16.840.1.113883.1.11.12212 for marital status
"RTN","C0CDAD2",191,0)
 ;
"RTN","C0CDAD2",192,0)
 ;  A	Annulled
"RTN","C0CDAD2",193,0)
 ;  D	Divorced
"RTN","C0CDAD2",194,0)
 ;  T	Domestic partner
"RTN","C0CDAD2",195,0)
 ;  I	Interlocutory	
"RTN","C0CDAD2",196,0)
 ;  L	Legally Separated
"RTN","C0CDAD2",197,0)
 ;  M	Married	
"RTN","C0CDAD2",198,0)
 ;  S	Never Married
"RTN","C0CDAD2",199,0)
 ;  P	Polygamous	
"RTN","C0CDAD2",200,0)
 ;  W	Widowed
"RTN","C0CDAD2",201,0)
 ;
"RTN","C0CDAD2",202,0)
 S ARY("maritalCode")=MARCD
"RTN","C0CDAD2",203,0)
 S ARY("maritalText")=$P(VADM(10),U,2)
"RTN","C0CDAD2",204,0)
 S ARY("religionCode")=$P(VADM(9),U,1)
"RTN","C0CDAD2",205,0)
 S ARY("religionName")=$P(VADM(9),U,2)
"RTN","C0CDAD2",206,0)
 ;S ARY("raceCode")=$P($G(VADM(12,1)),U,1)
"RTN","C0CDAD2",207,0)
 S ARY("raceCode")=$G(@VPRDEM@("races","race@value"))
"RTN","C0CDAD2",208,0)
 I $P($G(VADM(12,1)),U,2)="WHITE, NOT OF HISPANIC ORIGIN" S ARY("raceCode")="2106-3" ; this code was left out of the Race file on most systems
"RTN","C0CDAD2",209,0)
 I ARY("raceCode")="" S ARY("raceName")="UNK"
"RTN","C0CDAD2",210,0)
 E  S ARY("raceName")=$P($G(VADM(12,1)),U,2)_" ("_$P($G(VADM(12,1,1)),U,2)_")"
"RTN","C0CDAD2",211,0)
 ;S ARY("ethnicCode")=$P($G(VADM(11,1)),U,1)
"RTN","C0CDAD2",212,0)
 S ARY("ethnicCode")=$G(@VPRDEM@("ethnicities","ethnicity@value"))
"RTN","C0CDAD2",213,0)
 I ARY("ethnicCode")="" S ARY("ethnicName")="UNK"
"RTN","C0CDAD2",214,0)
 E  S ARY("ethnicName")=$P(VADM(11,1),U,2)_" ("_$P(VADM(11,1,1),U,2)_")"
"RTN","C0CDAD2",215,0)
 N LANG S LANG=$$GET1^DIQ(2,DFN_",",256000) ; name of language
"RTN","C0CDAD2",216,0)
 N LPRM ; language lookup parameters
"RTN","C0CDAD2",217,0)
 N LCDE,LRTN ; 
"RTN","C0CDAD2",218,0)
 S LPRM("table")="Primary Language"
"RTN","C0CDAD2",219,0)
 S LPRM("name")=LANG
"RTN","C0CDAD2",220,0)
 D LOOKUP^C0CDACU(.LRTN,.LPRM)
"RTN","C0CDAD2",221,0)
 S LCDE=$G(LRTN("code"))
"RTN","C0CDAD2",222,0)
 I LCDE="" S LCDE="eng"
"RTN","C0CDAD2",223,0)
 S ARY("languageCode")=LCDE
"RTN","C0CDAD2",224,0)
 ;S ARY("languageCode")="eng" ; used to be hardcoded to english
"RTN","C0CDAD2",225,0)
 ;S ARY("encompassingEncounterEffectiveTime")=$$FMDTOUTC^C0CDACU(ARY("facilities.facility@latestDate"))
"RTN","C0CDAD2",226,0)
 N C2I S C2I=""
"RTN","C0CDAD2",227,0)
 F  S C2I=$O(ARY(C2I)) Q:C2I=""  D  ;
"RTN","C0CDAD2",228,0)
 . I C2I="assignedPersonSuffix" Q  
"RTN","C0CDAD2",229,0)
 . I ARY(C2I)="" S ARY(C2I)="UNK"
"RTN","C0CDAD2",230,0)
 Q
"RTN","C0CDAD2",231,0)
 ;
"RTN","C0CDAD2",232,0)
THEADER ;
"RTN","C0CDAD2",233,0)
 ;;<?xml version="1.0" encoding="utf-8" ?>
"RTN","C0CDAD2",234,0)
 ;;<?xml-stylesheet type="text/xsl" href="CDA.xsl"?>
"RTN","C0CDAD2",235,0)
 ;;<ClinicalDocument classCode="DOCCLIN" moodCode="EVN" xmlns="urn:hl7-org:v3" xmlns:sdtc="urn:hl7-org:sdtc" xmlns:voc="urn:hl7-org:v3/voc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:hl7-org:v3 CDASchemas\cda\Schemas\CDA.xsd">
"RTN","C0CDAD2",236,0)
 ;;<realmCode code="US"></realmCode>
"RTN","C0CDAD2",237,0)
 ;;<typeId extension="POCD_HD000040" root="2.16.840.1.113883.1.3"></typeId>
"RTN","C0CDAD2",238,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.1.1"></templateId>
"RTN","C0CDAD2",239,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.1.2"></templateId>
"RTN","C0CDAD2",240,0)
 ;;<id extension="@@docNumber@@" root="@@orgOID@@"></id>
"RTN","C0CDAD2",241,0)
 ;;<code code="34133-9" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Summarization of Episode Note"></code>
"RTN","C0CDAD2",242,0)
 ;;<title>Test Clinic Summarization of Episode Note</title>
"RTN","C0CDAD2",243,0)
 ;;<effectiveTime value="@@docCreated@@"></effectiveTime>
"RTN","C0CDAD2",244,0)
 ;;<confidentialityCode code="N" codeSystem="2.16.840.1.113883.5.25" codeSystemName="Confidentiality" displayName="Normal"></confidentialityCode>
"RTN","C0CDAD2",245,0)
 ;;<languageCode code="en-US"></languageCode>
"RTN","C0CDAD2",246,0)
 ;;<recordTarget contextControlCode="OP" typeCode="RCT">
"RTN","C0CDAD2",247,0)
 ;;<patientRole classCode="PAT">
"RTN","C0CDAD2",248,0)
 ;;<id extension="@@icn@value@@" root="@@orgOID@@"></id>
"RTN","C0CDAD2",249,0)
 ;;<id extension="@@id@value@@" root="@@orgOID@@.2.2"></id>
"RTN","C0CDAD2",250,0)
 ;;<addr>
"RTN","C0CDAD2",251,0)
 ;;<country>US</country>
"RTN","C0CDAD2",252,0)
 ;;<state>@@address@stateProvince@@</state>
"RTN","C0CDAD2",253,0)
 ;;<city>@@address@city@@</city>
"RTN","C0CDAD2",254,0)
 ;;<postalCode>@@address@postalCode@@</postalCode>
"RTN","C0CDAD2",255,0)
 ;;<streetAddressLine>@@address@streetLine1@@</streetAddressLine>
"RTN","C0CDAD2",256,0)
 ;;</addr>
"RTN","C0CDAD2",257,0)
 ;;<telecom nullFlavor="UNK"></telecom>
"RTN","C0CDAD2",258,0)
 ;;<patient classCode="PSN" determinerCode="INSTANCE">
"RTN","C0CDAD2",259,0)
 ;;<name>
"RTN","C0CDAD2",260,0)
 ;;<family>@@familyName@value@@</family>
"RTN","C0CDAD2",261,0)
 ;;<given>@@given1@@</given>
"RTN","C0CDAD2",262,0)
 ;;<given>@@given2@@</given>
"RTN","C0CDAD2",263,0)
 ;;</name>
"RTN","C0CDAD2",264,0)
 ;;<administrativeGenderCode code="@@gender@value@@" codeSystem="2.16.840.1.113883.5.1" codeSystemName="AdministrativeGender" displayName="@@gender@value@@"></administrativeGenderCode>
"RTN","C0CDAD2",265,0)
 ;;<birthTime value="@@birthTime@@"/>
"RTN","C0CDAD2",266,0)
 ;;<maritalStatusCode code="@@maritalCode@@" displayName="@@maritalText@@" codeSystem="2.16.840.1.113883.5.2" codeSystemName="MaritalStatus"/>
"RTN","C0CDAD2",267,0)
 ;;<religiousAffiliationCode code="@@religionCode@@" displayName="@@religionName@@" codeSystem="2.16.840.1.113883.5.1076" codeSystemName="ReligiousAffiliation"/>
"RTN","C0CDAD2",268,0)
 ;;<raceCode code="@@raceCode@@" displayName="@@raceName@@" codeSystem="2.16.840.1.113883.6.238" codeSystemName="OMB Standards for Race and Ethnicity"/>
"RTN","C0CDAD2",269,0)
 ;;<ethnicGroupCode code="@@ethnicCode@@" displayName="@@ethnicName@@" codeSystem="2.16.840.1.113883.6.238" codeSystemName="OMB Standards for Race and Ethnicity"/>
"RTN","C0CDAD2",270,0)
 ;;<languageCommunication>
"RTN","C0CDAD2",271,0)
 ;;<!-- CONF 5407: LanguageCode Code System 2.16.840.1.113883.1.11.11526 -->
"RTN","C0CDAD2",272,0)
 ;;<languageCode code="@@languageCode@@"/>
"RTN","C0CDAD2",273,0)
 ;;<modeCode code="ESP" displayName="Expressed spoken" codeSystem="2.16.840.1.113883.5.60" codeSystemName="LanguageAbilityMode"/>
"RTN","C0CDAD2",274,0)
 ;;</languageCommunication>
"RTN","C0CDAD2",275,0)
 ;;</patient>
"RTN","C0CDAD2",276,0)
 ;;</patientRole>
"RTN","C0CDAD2",277,0)
 ;;</recordTarget>
"RTN","C0CDAD2",278,0)
 Q
"RTN","C0CDAD2",279,0)
 ;
"RTN","C0CDAD2",280,0)
TAUTHOR ;
"RTN","C0CDAD2",281,0)
 ;;<author>
"RTN","C0CDAD2",282,0)
 ;;<time value='@@authorTime@@'></time>
"RTN","C0CDAD2",283,0)
 ;;<assignedAuthor classCode='ASSIGNED'>
"RTN","C0CDAD2",284,0)
 ;;<id nullFlavor='UNK'></id>
"RTN","C0CDAD2",285,0)
 ;;<addr>
"RTN","C0CDAD2",286,0)
 ;;<state>@@orgState@@</state>
"RTN","C0CDAD2",287,0)
 ;;<city>@@orgCity@@</city>
"RTN","C0CDAD2",288,0)
 ;;<postalCode>@@orgZip@@</postalCode>
"RTN","C0CDAD2",289,0)
 ;;<streetAddressLine>@@orgAddr@@</streetAddressLine>
"RTN","C0CDAD2",290,0)
 ;;</addr>
"RTN","C0CDAD2",291,0)
 ;;<telecom use='WP' value='@@orgTelephone@@'></telecom>
"RTN","C0CDAD2",292,0)
 ;;<assignedAuthoringDevice>
"RTN","C0CDAD2",293,0)
 ;;<manufacturerModelName>Opensource CDA Factory</manufacturerModelName>
"RTN","C0CDAD2",294,0)
 ;;<softwareName>Opensource CDA Documents Generator</softwareName>
"RTN","C0CDAD2",295,0)
 ;;</assignedAuthoringDevice>
"RTN","C0CDAD2",296,0)
 ;;</assignedAuthor>
"RTN","C0CDAD2",297,0)
 ;;</author>
"RTN","C0CDAD2",298,0)
 ;;<custodian>
"RTN","C0CDAD2",299,0)
 ;;<assignedCustodian classCode="ASSIGNED">
"RTN","C0CDAD2",300,0)
 ;;<representedCustodianOrganization classCode="ORG" determinerCode="INSTANCE">
"RTN","C0CDAD2",301,0)
 ;;<id extension="CDA" root="@@orgOID@@"></id>
"RTN","C0CDAD2",302,0)
 ;;<name>@@orgName@@</name>
"RTN","C0CDAD2",303,0)
 ;;<telecom use="WP" value="@@orgTelephone@@"></telecom>
"RTN","C0CDAD2",304,0)
 ;;<addr>
"RTN","C0CDAD2",305,0)
 ;;<state>@@orgState@@</state>
"RTN","C0CDAD2",306,0)
 ;;<city>@@orgCity@@</city>
"RTN","C0CDAD2",307,0)
 ;;<postalCode>@@orgZip@@</postalCode>
"RTN","C0CDAD2",308,0)
 ;;<streetAddressLine>@@orgAddr@@</streetAddressLine>
"RTN","C0CDAD2",309,0)
 ;;</addr>
"RTN","C0CDAD2",310,0)
 ;;</representedCustodianOrganization>
"RTN","C0CDAD2",311,0)
 ;;</assignedCustodian>
"RTN","C0CDAD2",312,0)
 ;;</custodian>
"RTN","C0CDAD2",313,0)
 Q
"RTN","C0CDAD2",314,0)
 ;
"RTN","C0CDAD2",315,0)
TDOCOF ;
"RTN","C0CDAD2",316,0)
 ;;<documentationOf>
"RTN","C0CDAD2",317,0)
 ;;<serviceEvent classCode="PCPR" moodCode="EVN">
"RTN","C0CDAD2",318,0)
 ;;<effectiveTime>
"RTN","C0CDAD2",319,0)
 ;;<low value="@@docOfDateLow@@"></low>
"RTN","C0CDAD2",320,0)
 ;;<high value="@@docOfDate@@"></high>
"RTN","C0CDAD2",321,0)
 ;;</effectiveTime>
"RTN","C0CDAD2",322,0)
 ;;<performer typeCode="PRF">
"RTN","C0CDAD2",323,0)
 ;;<assignedEntity>
"RTN","C0CDAD2",324,0)
 ;;<id extension="@@orgNPI@@" root="2.16.840.1.113883.4.6"></id>
"RTN","C0CDAD2",325,0)
 ;;<addr>
"RTN","C0CDAD2",326,0)
 ;;<state>@@orgState@@</state>
"RTN","C0CDAD2",327,0)
 ;;<city>@@orgCity@@</city>
"RTN","C0CDAD2",328,0)
 ;;<postalCode>@@orgZip@@</postalCode>
"RTN","C0CDAD2",329,0)
 ;;<streetAddressLine>@@orgAddr@@</streetAddressLine>
"RTN","C0CDAD2",330,0)
 ;;</addr>
"RTN","C0CDAD2",331,0)
 ;;<telecom use="WP" value="@@orgTelephone@@"></telecom>
"RTN","C0CDAD2",332,0)
 ;;<assignedPerson>
"RTN","C0CDAD2",333,0)
 ;;<name>
"RTN","C0CDAD2",334,0)
 ;;<family>@@assignedPersonFamilyName@@</family>
"RTN","C0CDAD2",335,0)
 ;;<given>@@assignedPersonGivenName@@</given>
"RTN","C0CDAD2",336,0)
 ;;@@assignedPersonSuffix@@
"RTN","C0CDAD2",337,0)
 ;;</name>
"RTN","C0CDAD2",338,0)
 ;;</assignedPerson>
"RTN","C0CDAD2",339,0)
 ;;</assignedEntity>
"RTN","C0CDAD2",340,0)
 ;;</performer>
"RTN","C0CDAD2",341,0)
 ;;</serviceEvent>
"RTN","C0CDAD2",342,0)
 ;;</documentationOf>
"RTN","C0CDAD2",343,0)
 Q
"RTN","C0CDAD2",344,0)
 ;
"RTN","C0CDAD2",345,0)
TCOMPOF ;
"RTN","C0CDAD2",346,0)
 ;;<componentOf>
"RTN","C0CDAD2",347,0)
 ;;<encompassingEncounter>
"RTN","C0CDAD2",348,0)
 ;;<id extension="@@encompassingEncounterExtension@@" root="@@orgOID@@"></id>
"RTN","C0CDAD2",349,0)
 ;;<effectiveTime>
"RTN","C0CDAD2",350,0)
 ;;<low value="@@docOfDateLow@@"></low>
"RTN","C0CDAD2",351,0)
 ;;<high value="@@docOfDate@@"></high>
"RTN","C0CDAD2",352,0)
 ;;</effectiveTime>
"RTN","C0CDAD2",353,0)
 ;;<responsibleParty>
"RTN","C0CDAD2",354,0)
 ;;<assignedEntity>
"RTN","C0CDAD2",355,0)
 ;;<id nullFlavor="UNK"></id>
"RTN","C0CDAD2",356,0)
 ;;<addr>
"RTN","C0CDAD2",357,0)
 ;;<state>@@orgState@@</state>
"RTN","C0CDAD2",358,0)
 ;;<city>@@orgCity@@</city>
"RTN","C0CDAD2",359,0)
 ;;<postalCode>@@orgZip@@</postalCode>
"RTN","C0CDAD2",360,0)
 ;;<streetAddressLine>@@orgAddr@@</streetAddressLine>
"RTN","C0CDAD2",361,0)
 ;;</addr>
"RTN","C0CDAD2",362,0)
 ;;<telecom use="WP" value="@@orgTelephone@@"></telecom>
"RTN","C0CDAD2",363,0)
 ;;<assignedPerson>
"RTN","C0CDAD2",364,0)
 ;;<name>
"RTN","C0CDAD2",365,0)
 ;;<family>@@assignedPersonFamilyName@@</family>
"RTN","C0CDAD2",366,0)
 ;;<given>@@assignedPersonGivenName@@</given>
"RTN","C0CDAD2",367,0)
 ;;@@assignedPersonSuffix@@
"RTN","C0CDAD2",368,0)
 ;;</name>
"RTN","C0CDAD2",369,0)
 ;;</assignedPerson>
"RTN","C0CDAD2",370,0)
 ;;</assignedEntity>
"RTN","C0CDAD2",371,0)
 ;;</responsibleParty>
"RTN","C0CDAD2",372,0)
 ;;<location>
"RTN","C0CDAD2",373,0)
 ;;<healthCareFacility>
"RTN","C0CDAD2",374,0)
 ;;<id extension="@@healthCareFacilityExtension@@" root="@@orgOID@@"></id>
"RTN","C0CDAD2",375,0)
 ;;<location>
"RTN","C0CDAD2",376,0)
 ;;<name>@@orgName@@</name>
"RTN","C0CDAD2",377,0)
 ;;<addr>
"RTN","C0CDAD2",378,0)
 ;;<state>@@orgState@@</state>
"RTN","C0CDAD2",379,0)
 ;;<city>@@orgCity@@</city>
"RTN","C0CDAD2",380,0)
 ;;<postalCode>@@orgCity@@</postalCode>
"RTN","C0CDAD2",381,0)
 ;;<streetAddressLine>@@orgAddr@@</streetAddressLine>
"RTN","C0CDAD2",382,0)
 ;;</addr>
"RTN","C0CDAD2",383,0)
 ;;</location>
"RTN","C0CDAD2",384,0)
 ;;</healthCareFacility>
"RTN","C0CDAD2",385,0)
 ;;</location>
"RTN","C0CDAD2",386,0)
 ;;</encompassingEncounter>
"RTN","C0CDAD2",387,0)
 ;;</componentOf>
"RTN","C0CDAD2",388,0)
 ;;<component>
"RTN","C0CDAD2",389,0)
 ;;<structuredBody>
"RTN","C0CDAD2",390,0)
 Q
"RTN","C0CDAD2",391,0)
 ;
"RTN","C0CDAD2",392,0)
TLAST1 ;
"RTN","C0CDAD2",393,0)
 ;;</structuredBody>
"RTN","C0CDAD2",394,0)
 ;;</component>
"RTN","C0CDAD2",395,0)
 ;;</ClinicalDocument>
"RTN","C0CDAD2",396,0)
 Q
"RTN","C0CDAD2",397,0)
 ;
"RTN","C0CDAOR")
0^25^B38289844
"RTN","C0CDAOR",1,0)
C0CDAOR ;SLC/MKB/GPL -- eRx Medication extract for CCDA ;10/4/13  15:29
"RTN","C0CDAOR",2,0)
 ;;1.0;CCDA;**1**;Sep 01, 2011;Build 1
"RTN","C0CDAOR",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","C0CDAOR",4,0)
 ;
"RTN","C0CDAOR",5,0)
 ; External References          DBIA#
"RTN","C0CDAOR",6,0)
 ; -------------------          -----
"RTN","C0CDAOR",7,0)
 ; ^OR(100                       5771
"RTN","C0CDAOR",8,0)
 ; ^ORD(100.98                    873
"RTN","C0CDAOR",9,0)
 ; ^SC                          10040
"RTN","C0CDAOR",10,0)
 ; ^VA(200                      10060
"RTN","C0CDAOR",11,0)
 ; DIQ                           2056
"RTN","C0CDAOR",12,0)
 ; ORCD                          5493
"RTN","C0CDAOR",13,0)
 ; ORQ1,^TMP("ORR",$J)           3154
"RTN","C0CDAOR",14,0)
 ; ORX8                 871,2467,3071
"RTN","C0CDAOR",15,0)
 ; PSOORRL,^TMP("PS",$J)         2400
"RTN","C0CDAOR",16,0)
 ; PSS50P7                       4662
"RTN","C0CDAOR",17,0)
 ; PSS51P2                       4548
"RTN","C0CDAOR",18,0)
 ;
"RTN","C0CDAOR",19,0)
 ; This routine was copied from VPRDPSOR and modified by 
"RTN","C0CDAOR",20,0)
 ; Oroville Hospital to extract ePrescribing medications
"RTN","C0CDAOR",21,0)
 ; for the CCDA generator. It is called by a modification
"RTN","C0CDAOR",22,0)
 ; to VPRDPS in cases where there is a medication but no order.
"RTN","C0CDAOR",23,0)
 ; the order information is taken from the NVA medication multiple
"RTN","C0CDAOR",24,0)
 ; where it is stored by ePrescribing. 
"RTN","C0CDAOR",25,0)
 ;  - gpl 10/04/2013
"RTN","C0CDAOR",26,0)
 ;
"RTN","C0CDAOR",27,0)
 ; ------------ Get data from VistA ------------
"RTN","C0CDAOR",28,0)
 ;
"RTN","C0CDAOR",29,0)
EN(DFN,BEG,END,MAX,ORIFN) ; -- find a patient's orders
"RTN","C0CDAOR",30,0)
 S DFN=+$G(DFN) Q:DFN<1  ;invalid patient
"RTN","C0CDAOR",31,0)
 S BEG=$G(BEG,1410101),END=$G(END,4141015),MAX=$G(MAX,9999)
"RTN","C0CDAOR",32,0)
 N ORDIALOG              ;med dialog array, keep/reuse
"RTN","C0CDAOR",33,0)
 ;
"RTN","C0CDAOR",34,0)
 ; get one order
"RTN","C0CDAOR",35,0)
 I $G(ORIFN) D EN1(ORIFN,.VPRITM),XML^VPRDPS(.VPRITM):$D(VPRITM) Q
"RTN","C0CDAOR",36,0)
 ;
"RTN","C0CDAOR",37,0)
 ; get all orders
"RTN","C0CDAOR",38,0)
 N TYPE,ORDG,ORVP,ORLIST,VPRITM,VPRCNT,VPRN,ORLIST,ORIFN,X3,X4,DAD
"RTN","C0CDAOR",39,0)
 S TYPE=$G(FILTER("vaType")) S:$L(TYPE) TYPE=$S(TYPE="N":"NV",TYPE="V":"IV",1:TYPE)_" "
"RTN","C0CDAOR",40,0)
 S ORDG=+$O(^ORD(100.98,"B",TYPE_"RX",0)),ORVP=DFN_";DPT("
"RTN","C0CDAOR",41,0)
 D EN^ORQ1(ORVP,ORDG,6,,BEG,END)
"RTN","C0CDAOR",42,0)
 K ^TMP("VPROR",$J) S (VPRCNT,VPRN)=0
"RTN","C0CDAOR",43,0)
 F  S VPRN=$O(^TMP("ORR",$J,ORLIST,VPRN)) Q:VPRN<1  S ORIFN=$G(^(VPRN)) D  Q:VPRCNT'<MAX
"RTN","C0CDAOR",44,0)
 . Q:$D(^TMP("VPROR",$J,+ORIFN))  Q:$P(ORIFN,";",2)>1  S ORIFN=+ORIFN
"RTN","C0CDAOR",45,0)
 . S X3=$G(^OR(100,ORIFN,3)),X4=$G(^(4))
"RTN","C0CDAOR",46,0)
 . Q:$P(X3,U,3)=13  I X4["P",$P(X3,U,3)=1 Q  ;cancelled
"RTN","C0CDAOR",47,0)
 . S DAD=$P(X3,U,9) I DAD Q:$D(^TMP("VPROR",$J,DAD))  S ORIFN=DAD
"RTN","C0CDAOR",48,0)
 . K VPRITM D EN1(ORIFN,.VPRITM) Q:'$D(VPRITM)
"RTN","C0CDAOR",49,0)
 . D XML^VPRDPS(.VPRITM)
"RTN","C0CDAOR",50,0)
 . S ^TMP("VPROR",$J,ORIFN)="",VPRCNT=VPRCNT+1
"RTN","C0CDAOR",51,0)
 K ^TMP("VPROR",$J),^TMP("ORR",$J),^TMP($J,"PSOI")
"RTN","C0CDAOR",52,0)
 Q
"RTN","C0CDAOR",53,0)
 ;
"RTN","C0CDAOR",54,0)
EN1(IFN,MED) ; -- return an order in MED("attribute")=value [from EN]
"RTN","C0CDAOR",55,0)
 N ORUPCHUK,ORVP,ORPCL,ORPK,ORDUZ,ORODT,ORSTRT,ORSTOP,ORL,ORTO,ORSTS,ORNP,ORPV,ORTX
"RTN","C0CDAOR",56,0)
 N CLS,OI,X,LOC,DRUG,DA,CNT,VPRESP K MED
"RTN","C0CDAOR",57,0)
 ;
"RTN","C0CDAOR",58,0)
 ; since for ePrescribing meds, there is no order, the VPRN is passed
"RTN","C0CDAOR",59,0)
 ; as the IFN i.e. ^PS(55,DFN,"NVA",VPRN... this is where the
"RTN","C0CDAOR",60,0)
 ; non-VA med is stored.
"RTN","C0CDAOR",61,0)
 ;
"RTN","C0CDAOR",62,0)
 ;S IFN=+$G(IFN) I IFN<1!'$D(^OR(100,IFN)) Q
"RTN","C0CDAOR",63,0)
 S IFN=+$G(IFN) I IFN<1!'$D(^PS(55,DFN,"NVA",IFN)) Q
"RTN","C0CDAOR",64,0)
 N JJOHNVA S JJOHNVA=$NA(^PS(55,DFN,"NVA",IFN)) ; for indirect reference
"RTN","C0CDAOR",65,0)
 ;S ORPK=$$PKGID^ORX8(IFN)
"RTN","C0CDAOR",66,0)
 ;S X=$S(ORPK:$E(ORPK,$L(ORPK)),1:"Z") S:X=+X X="R" ;last char = PS file
"RTN","C0CDAOR",67,0)
 ;S CLS=$S("RSN"[X:"O","UV"[X:"I",1:$$GET1^DIQ(100,IFN_",",10,"I"))
"RTN","C0CDAOR",68,0)
 ;I CLS="O",ORPK=+ORPK!(ORPK["R") D RX^VPRDPSO(ORPK,.MED) S MED("id")=IFN Q
"RTN","C0CDAOR",69,0)
 S CLS="O" ;all these meds non-VA meds, which are class O for outpatient
"RTN","C0CDAOR",70,0)
 S ORPK=IFN_"N" ; this indicates the NVA ien and N for non-VA meds
"RTN","C0CDAOR",71,0)
 S MED("id")=IFN,MED("orderID")=IFN,MED("vaType")=CLS
"RTN","C0CDAOR",72,0)
 S:ORPK MED("medID")=ORPK_";"_CLS
"RTN","C0CDAOR",73,0)
 S MED("ordered")=$P($G(@JJOHNVA@(1,0)),U,5) ; order date
"RTN","C0CDAOR",74,0)
 N ZDUZ S ZDUZ=$P($G(@JJOHNVA@(0)),U,11)
"RTN","C0CDAOR",75,0)
 I ZDUZ'="" D  ;
"RTN","C0CDAOR",76,0)
 . S MED("orderingProvider")=ZDUZ
"RTN","C0CDAOR",77,0)
 . S MED("currentProvider")=$P($G(^VA(200,ZDUZ),0),U,1)
"RTN","C0CDAOR",78,0)
 S MED("start")=$P($G(@JJOHNVA@(0)),U,9)
"RTN","C0CDAOR",79,0)
 I MED("start")="" S MED("start")=MED("ordered")
"RTN","C0CDAOR",80,0)
 ;
"RTN","C0CDAOR",81,0)
 ; here's sample of what's in VPRPS for an NVA med
"RTN","C0CDAOR",82,0)
 ;^TMP("VPRPS",22184,7,0)="7N;O^NAPROXEN 500MG^^^^^^^ACTIVE"
"RTN","C0CDAOR",83,0)
 ;^TMP("VPRPS",22184,7,"SCH",0)=1
"RTN","C0CDAOR",84,0)
 ;^TMP("VPRPS",22184,7,"SCH",1,0)="BID PRN"
"RTN","C0CDAOR",85,0)
 ;^TMP("VPRPS",22184,7,"SIG",0)=1
"RTN","C0CDAOR",86,0)
 ;^TMP("VPRPS",22184,7,"SIG",1,0)="Naprosyn 500 mg Tab| 1  tablet by mouth BID PRN"
"RTN","C0CDAOR",87,0)
 S MED("vaStatus")=$P(^TMP("VPRPS",$J,IFN,0),U,9)
"RTN","C0CDAOR",88,0)
 I MED("vaStatus")="ACTIVE" S MED("status")="active"
"RTN","C0CDAOR",89,0)
 E  S MED("status")="not active"
"RTN","C0CDAOR",90,0)
 S MED("name")=$P(^TMP("VPRPS",$J,IFN,"SIG",1,0),"|",1)
"RTN","C0CDAOR",91,0)
 S MED("sig")=$P(^TMP("VPRPS",$J,IFN,"SIG",1,0),"|",2)
"RTN","C0CDAOR",92,0)
 S MED("schedule")=^TMP("VPRPS",$J,IFN,"SCH",1,0)
"RTN","C0CDAOR",93,0)
 ;
"RTN","C0CDAOR",94,0)
 ; below for reference are the pieces of the zero node of the NVA meds
"RTN","C0CDAOR",95,0)
 ;^PS(55,D0,"NVA",D1,0)={1} (#.01) ORDERABLE ITEM [1P:50.7] ^ {2}(#1) DISPENSE DRUG
"RTN","C0CDAOR",96,0)
        ;        ==>[2P:50] ^ {3}(#2) DOSAGE [3F] ^ {4}(#3) MEDICATION ROUTE
"RTN","C0CDAOR",97,0)
        ;        ==>[4F] ^ {5}(#4) SCHEDULE [5F] ^ {6}(#5) STATUS [6S] ^ (#6)
"RTN","C0CDAOR",98,0)
        ;        ==>{7}DISCONTINUED DATE [7D] ^ {8}(#7) ORDER NUMBER [8P:100] ^
"RTN","C0CDAOR",99,0)
        ;        ==>{9}(#8) START DATE [9D] ^ {10}(#11) DOCUMENTED DATE [10D] ^
"RTN","C0CDAOR",100,0)
        ;        ==>{11}(#12) DOCUMENTED BY [11P:200] ^
"RTN","C0CDAOR",101,0)
 ;
"RTN","C0CDAOR",102,0)
 ; here's how the codes are stored:
"RTN","C0CDAOR",103,0)
 ;
"RTN","C0CDAOR",104,0)
 ;^PS(55,11,"NVA",8,1,7,0)="MEDID:269382 GCN:8182 RXNORM:310798 VUID:4002651^4013949 DRUG:262^2688^0 "
"RTN","C0CDAOR",105,0)
 ;
"RTN","C0CDAOR",106,0)
 N ZCODES S ZCODES=$G(@JJOHNVA@(1,7,0))
"RTN","C0CDAOR",107,0)
 I ZCODES'="" D  ;
"RTN","C0CDAOR",108,0)
 . S MED("MEDID")=$P($P(ZCODES,"MEDID:",2)," ",1)
"RTN","C0CDAOR",109,0)
 . S MED("GCN")=$P($P(ZCODES,"GCN:",2)," ",1)
"RTN","C0CDAOR",110,0)
 . S MED("RxNormCode")=$P($P(ZCODES,"RXNORM:",2)," ",1)
"RTN","C0CDAOR",111,0)
 . S MED("vuid")=$P($P(ZCODES,"VUID:",2)," ",1)
"RTN","C0CDAOR",112,0)
 . S MED("DRUG")=$P($P(ZCODES,"DRUG:",2)," ",1)
"RTN","C0CDAOR",113,0)
 ;D EN^ORX8(IFN) S X="" F  S X=$O(ORUPCHUK(X)) Q:X=""  S:$D(ORUPCHUK(X))#2 @X=ORUPCHUK(X)
"RTN","C0CDAOR",114,0)
 ;S MED("ordered")=$G(ORODT),MED("orderingProvider")=$G(ORNP)
"RTN","C0CDAOR",115,0)
 ;S MED("currentProvider")=$$LASTPROV(IFN)
"RTN","C0CDAOR",116,0)
 ;S MED("start")=$G(ORSTRT),MED("stop")=$G(ORSTOP)
"RTN","C0CDAOR",117,0)
 ;S MED("vaStatus")=$P($G(ORSTS),U,2),MED("status")=$$STATUS(+$G(ORSTS))
"RTN","C0CDAOR",118,0)
 ;S LOC=+$G(ORL) S:LOC MED("location")=LOC_U_$P(^SC(LOC,0),U)
"RTN","C0CDAOR",119,0)
 ;I CLS="I" D
"RTN","C0CDAOR",120,0)
 ;. S:$P($G(^SC(+$G(LOC),0)),U,25) MED("IMO")=1
"RTN","C0CDAOR",121,0)
 ;. S X=$P($G(^OR(100,IFN,3)),U,9) S:X MED("parent")=X
"RTN","C0CDAOR",122,0)
 ;S MED("facility")=$$FAC^VPRD(LOC) I ORPK D
"RTN","C0CDAOR",123,0)
 ;. N IFN D OEL^PSOORRL(DFN,ORPK_";"_CLS)
"RTN","C0CDAOR",124,0)
 ;I $$IV D IV^VPRDPSI Q
"RTN","C0CDAOR",125,0)
 ;S:CLS="O" MED("type")="Prescription"
"RTN","C0CDAOR",126,0)
 S:ORPK["N" MED("vaType")="N",MED("type")="OTC"
"RTN","C0CDAOR",127,0)
ENA ; get order responses
"RTN","C0CDAOR",128,0)
 ;S OI=$$OI^ORX8(IFN) I OI S MED("name")=$P(OI,U,2) D
"RTN","C0CDAOR",129,0)
 ;. D ZERO^PSS50P7(+$P(OI,U,3),,,"PSOI")
"RTN","C0CDAOR",130,0)
 ;. S MED("form")=$P($G(^TMP($J,"PSOI",+$P(OI,U,3),.02)),U,2)
"RTN","C0CDAOR",131,0)
 ;. S:+$G(^TMP($J,"PSOI",+$P(OI,U,3),.09)) MED("supply")=1
"RTN","C0CDAOR",132,0)
 ;D RESP(IFN,.VPRESP) ;order responses
"RTN","C0CDAOR",133,0)
 ;S DRUG=+$G(^TMP("PS",$J,"DD",1,0)) S:'DRUG DRUG=+$G(VPRESP("DRUG",1))
"RTN","C0CDAOR",134,0)
 ;S MED("sig")=$S(CLS="I":"Give: ",1:"")_$G(VPRESP("SIG",1)) ;ORTX(2)
"RTN","C0CDAOR",135,0)
 ;I CLS="I"!(ORPK["N") D  G ENQ ;UD or NVA: single dose, or child orders
"RTN","C0CDAOR",136,0)
 ;. I '$O(^OR(100,IFN,2,0)) S MED("dose",1)=$$DOSE(1)_U_$G(ORSTRT)_U_$G(ORSTOP) Q
"RTN","C0CDAOR",137,0)
 ;. N DD,CONJ M CONJ=VPRESP("CONJ")
"RTN","C0CDAOR",138,0)
 ;. S (DA,CNT)=0 F  S DA=$O(^OR(100,IFN,2,DA)) Q:DA<1  D
"RTN","C0CDAOR",139,0)
 ;.. K VPRESP D RESP(DA,.VPRESP)
"RTN","C0CDAOR",140,0)
 ;.. S CNT=CNT+1,MED("dose",CNT)=$$DOSE(1)_U_$P($G(^OR(100,DA,0)),U,8,9)_U_DA
"RTN","C0CDAOR",141,0)
 ;.. S $P(MED("dose",CNT),U,8)=$G(CONJ(CNT))
"RTN","C0CDAOR",142,0)
 ;.. I $P(MED("dose",CNT),U,10)>$G(ORSTOP) S ORSTOP=$P(MED("dose",CNT),U,10)
"RTN","C0CDAOR",143,0)
 ;.. S:'DRUG DD=+$G(VPRESP("DRUG",1)),DD(DD,DA)="" ;dispense drug(s)
"RTN","C0CDAOR",144,0)
 ;.. ; get ^TMP("PS",$J) from 1st child, if Inpt parent:
"RTN","C0CDAOR",145,0)
 ;.. I '$D(^TMP("PS",$J)) S ORPK=$$PKGID^ORX8(DA) D OEL^PSOORRL(DFN,ORPK_";"_CLS)
"RTN","C0CDAOR",146,0)
 ;. S MED("stop")=$G(ORSTOP) ;reset from last child order
"RTN","C0CDAOR",147,0)
 ;. S DD=$O(DD(0)) I DD,'$O(DD(DD)) S DRUG=DD Q  ;1 drug for order
"RTN","C0CDAOR",148,0)
 ;. S (DD,CNT)=0 F  S DD=$O(DD(DD)) Q:DD<1  S DA=0 F  S DA=$O(DD(DD,DA)) Q:DA<1  S CNT=CNT+1 D NDF^VPRDPS(DD,CNT,DA)
"RTN","C0CDAOR",149,0)
 ; pending Rx: dose(s), qty, etc.
"RTN","C0CDAOR",150,0)
 ;S CNT=0 F  S CNT=$O(VPRESP("INSTR",CNT)) Q:CNT<1  S MED("dose",CNT)=$$DOSE(CNT) ;_STRT^STOP
"RTN","C0CDAOR",151,0)
 ;S MED("quantity")=$G(VPRESP("QTY",1))
"RTN","C0CDAOR",152,0)
 ;S MED("daysSupply")=$G(VPRESP("SUPPLY",1))
"RTN","C0CDAOR",153,0)
 ;S MED("routing")=$G(VPRESP("PICKUP",1))
"RTN","C0CDAOR",154,0)
 ;S MED("fillsAllowed")=$G(VPRESP("REFILLS",1))
"RTN","C0CDAOR",155,0)
 ;S MED("ptInstructions")=$G(VPRESP("PI",1))
"RTN","C0CDAOR",156,0)
ENQ ; finish
"RTN","C0CDAOR",157,0)
 ;D:DRUG NDF^VPRDPS(+DRUG)
"RTN","C0CDAOR",158,0)
 ;S X=+$P($G(^TMP("PS",$J,"RXN",0)),U,5)
"RTN","C0CDAOR",159,0)
 ;S:X MED("pharmacist")=X_U_$P($G(^VA(200,X,0)),U)
"RTN","C0CDAOR",160,0)
 ;K ^TMP("PS",$J),^TMP($J,"PSOI")
"RTN","C0CDAOR",161,0)
 Q
"RTN","C0CDAOR",162,0)
 ;
"RTN","C0CDAOR",163,0)
IV() ; -- Return 1 or 0, if order is for IV/infusion
"RTN","C0CDAOR",164,0)
 I ORPK["V" Q 1
"RTN","C0CDAOR",165,0)
 I $P($G(ORTO),U,2)?1"IV".E Q 1
"RTN","C0CDAOR",166,0)
 I +$G(ORPCL)=130 Q 1
"RTN","C0CDAOR",167,0)
 I $G(^TMP("PS",$J,"B",0)) Q 1
"RTN","C0CDAOR",168,0)
 Q 0
"RTN","C0CDAOR",169,0)
 ;
"RTN","C0CDAOR",170,0)
DOSE(N) ; --add dosage data from VPRESP(ID,N) [instance N]
"RTN","C0CDAOR",171,0)
 N DOSE,X,ID S N=+$G(N,1)
"RTN","C0CDAOR",172,0)
 S DOSE=$P($G(VPRESP("DOSE",N)),"&",1,4),DOSE=$TR(DOSE,"&","^")
"RTN","C0CDAOR",173,0)
 I '$L($P(DOSE,U)) S DOSE=$G(VPRESP("INSTR",N))_"^^^"
"RTN","C0CDAOR",174,0)
 S X=+$G(VPRESP("ROUTE",N)) D ALL^PSS51P2(X,,,,"VPRTE")
"RTN","C0CDAOR",175,0)
 S DOSE=DOSE_U_$G(^TMP($J,"VPRTE",X,1))
"RTN","C0CDAOR",176,0)
 F ID="SCHEDULE","DAYS","CONJ" S DOSE=DOSE_U_$G(VPRESP(ID,N))
"RTN","C0CDAOR",177,0)
 K ^TMP($J,"VPRTE")
"RTN","C0CDAOR",178,0)
 Q DOSE
"RTN","C0CDAOR",179,0)
 ;
"RTN","C0CDAOR",180,0)
LASTPROV(IFN) ; -- return last provider who took action on order IFN
"RTN","C0CDAOR",181,0)
 N I,X,Y S Y=""
"RTN","C0CDAOR",182,0)
 S I="A" F  S I=$O(^OR(100,IFN,8,I),-1) Q:I<1  S X=$G(^(I,0)) D  Q:Y
"RTN","C0CDAOR",183,0)
 . I $P(X,U,5) S Y=+$P(X,U,5) Q  ;signer
"RTN","C0CDAOR",184,0)
 . I $P(X,U,3) S Y=+$P(X,U,3) Q  ;orderer
"RTN","C0CDAOR",185,0)
 S:Y Y=Y_U_$P($G(^VA(200,Y,0)),U)
"RTN","C0CDAOR",186,0)
 Q Y
"RTN","C0CDAOR",187,0)
 ;
"RTN","C0CDAOR",188,0)
STRING(IFN,ID) ; -- return text value as a string
"RTN","C0CDAOR",189,0)
 N DA,I,X,Y
"RTN","C0CDAOR",190,0)
 S DA=+$O(^OR(100,IFN,4.5,"ID",ID,0)) Q:DA<1 ""
"RTN","C0CDAOR",191,0)
 S I=+$O(^OR(100,IFN,4.5,DA,2,0)),Y=$G(^(I,0))
"RTN","C0CDAOR",192,0)
 F  S I=+$O(^OR(100,IFN,4.5,DA,2,I)) Q:I<1  S X=$G(^(I,0)) D
"RTN","C0CDAOR",193,0)
 . I $E(Y,$L(Y))'=" " S Y=Y_" "
"RTN","C0CDAOR",194,0)
 . S Y=Y_X
"RTN","C0CDAOR",195,0)
 Q Y
"RTN","C0CDAOR",196,0)
 ;
"RTN","C0CDAOR",197,0)
STATUS(X) ; -- return HITSP status for 100.01 #X
"RTN","C0CDAOR",198,0)
 S X=+$G(X) S:'X X=99  ;no status
"RTN","C0CDAOR",199,0)
 I X=3 Q "hold"
"RTN","C0CDAOR",200,0)
 I X=10!(X=11)!(X=5) Q "not active"
"RTN","C0CDAOR",201,0)
 I X=1!(X=12)!(X=13) Q "not active"
"RTN","C0CDAOR",202,0)
 I X=14!(X=99)       Q "not active"
"RTN","C0CDAOR",203,0)
 I X=2!(X=7)!(X=15)  Q "historical"
"RTN","C0CDAOR",204,0)
 Q "active"
"RTN","C0CDAOR",205,0)
 ;
"RTN","C0CDAOR",206,0)
RESP(ORIFN,RESP) ; -- return order responses [internal form]
"RTN","C0CDAOR",207,0)
 N VPRDLG,I,J,W,ID,TYPE,X,Y
"RTN","C0CDAOR",208,0)
 I '$D(ORDIALOG) S ORDIALOG=129 D GETDLG1^ORCD(129)
"RTN","C0CDAOR",209,0)
 D GETORDER^ORCD(+$G(ORIFN),"VPRDLG")
"RTN","C0CDAOR",210,0)
 S I=0 F  S I=$O(VPRDLG(I)) Q:I<1  D
"RTN","C0CDAOR",211,0)
 . S ID=$P($G(ORDIALOG(I)),U,2) Q:'$L(ID)
"RTN","C0CDAOR",212,0)
 . S TYPE=$P($G(ORDIALOG(I,0)),U)
"RTN","C0CDAOR",213,0)
 . S J=0 F  S J=$O(VPRDLG(I,J)) Q:J<1  I $D(VPRDLG(I,J)) D
"RTN","C0CDAOR",214,0)
 .. S X=VPRDLG(I,J) I TYPE'="W" S RESP(ID,J)=X Q
"RTN","C0CDAOR",215,0)
 .. S Y=$G(@X@(1,0)),W=1 F  S W=$O(@X@(W)) Q:W<1  S Y=Y_$S($E(Y,$L(Y))'=" ":" ",1:"")_$G(@X@(W,0))
"RTN","C0CDAOR",216,0)
 .. S:$L(Y) RESP(ID,J)=Y
"RTN","C0CDAOR",217,0)
 Q
"RTN","C0CDAPCE")
0^26^B2521747
"RTN","C0CDAPCE",1,0)
C0CDAPCE ; GPL - encounter handling routines ;8/29/13  17:05
"RTN","C0CDAPCE",2,0)
 ;;0.1;C0CDA;nopatch;noreleasedate;Build 1
"RTN","C0CDAPCE",3,0)
 ;
"RTN","C0CDAPCE",4,0)
 ; License AGPL v3.0
"RTN","C0CDAPCE",5,0)
 ; 
"RTN","C0CDAPCE",6,0)
 Q
"RTN","C0CDAPCE",7,0)
 ;
"RTN","C0CDAPCE",8,0)
PCE2DATA(RTN,FILTER) ; retrieve a patient's encounters
"RTN","C0CDAPCE",9,0)
 ; includes results from VISIT, V CPT, V STANDARD CODES, V HEALTH FACTORS, AND V POV
"RTN","C0CDAPCE",10,0)
 ; options are specifies in the filter
"RTN","C0CDAPCE",11,0)
 ; FILTER("dfn") or FILTER("patientId") are the dfn of the patient
"RTN","C0CDAPCE",12,0)
 ; FILTER("format") is:
"RTN","C0CDAPCE",13,0)
 ;    mumps (default)
"RTN","C0CDAPCE",14,0)
 ;    xml
"RTN","C0CDAPCE",15,0)
 ;    json  - json version of Fileman fields
"RTN","C0CDAPCE",16,0)
 ;    json-vpr - json version of vpr field names
"RTN","C0CDAPCE",17,0)
 ;    json-camel - json version of Fileman field names converted to camel case
"RTN","C0CDAPCE",18,0)
 ;    json-fhir - json FHIR resources
"RTN","C0CDAPCE",19,0)
 ;    data2pce - format which could be direcly used by DATA2PCE
"RTN","C0CDAPCE",20,0)
 ; FILTER("ien") is the ien of the Visit - optional 
"RTN","C0CDAPCE",21,0)
 ; FILTER("startDate") beginning of the search for visits - optional
"RTN","C0CDAPCE",22,0)
 ; FILTER("endDate") end of the search for visits - optional
"RTN","C0CDAPCE",23,0)
 ; if no ien or startDate is provided, all visits will be returned
"RTN","C0CDAPCE",24,0)
 ; if endDate is not provided, NOW will be used.
"RTN","C0CDAPCE",25,0)
 ; FILTER("cqm")="CMSXXXvY" only returns elements used by the CMS quality measure - eg. CMS128v5
"RTN","C0CDAPCE",26,0)
 ;
"RTN","C0CDAPCE",27,0)
 ;
"RTN","C0CDAPCE",28,0)
 N DFN,C0CDAI,C0CDAJ,WORK,START,STOPT
"RTN","C0CDAPCE",29,0)
 ;
"RTN","C0CDAPCE",30,0)
 S DFN=$G(FILTER("dfn"))
"RTN","C0CDAPCE",31,0)
 I DFN="" S DFN=$G(FILTER("patientId"))
"RTN","C0CDAPCE",32,0)
 I DFN="" D  Q  ;
"RTN","C0CDAPCE",33,0)
 . S RTN="-1^No patient specified"
"RTN","C0CDAPCE",34,0)
 ;
"RTN","C0CDAPCE",35,0)
 S START=$G(FILTER("startDate"))
"RTN","C0CDAPCE",36,0)
 S STOP=$G(FILTER("endDate"))
"RTN","C0CDAPCE",37,0)
 ;
"RTN","C0CDAPCE",38,0)
 ;D GET^VPRD(.RTNTMP,DFN,"visit",START,STOP)
"RTN","C0CDAPCE",39,0)
 D GET^HMPDJ(.RTNTMP,DFN,"visit",START,STOP)
"RTN","C0CDAPCE",40,0)
 ;K ^TMP("MXMLDOM",$J,1)
"RTN","C0CDAPCE",41,0)
 N C0CDADID
"RTN","C0CDAPCE",42,0)
 S C0CDADID=$$PARSE(RTNTMP,DFN_"-visits")
"RTN","C0CDAPCE",43,0)
 N ZDOM S ZDOM=$NA(^TMP("MXMLDOM",$J,C0CDADID))
"RTN","C0CDAPCE",44,0)
 d domo3^C0CDACE("WORK",,,ZDOM)
"RTN","C0CDAPCE",45,0)
 N FORMAT S FORMAT=$G(FILTER("format"))
"RTN","C0CDAPCE",46,0)
 I FORMAT="" S FORMAT="mumps"
"RTN","C0CDAPCE",47,0)
 I FORMAT["mumps" D  Q  ;
"RTN","C0CDAPCE",48,0)
 . S RTN=$NA(^TMP("C0CDAPCE",$J))
"RTN","C0CDAPCE",49,0)
 . K @RTN
"RTN","C0CDAPCE",50,0)
 . M @RTN@("visits")=WORK("results","visits")
"RTN","C0CDAPCE",51,0)
 Q
"RTN","C0CDAPCE",52,0)
 ;
"RTN","C0CDAPCE",53,0)
PARSE(INXML,INDOC) ;CALL THE MXML PARSER ON INXML, PASSED BY NAME
"RTN","C0CDAPCE",54,0)
 ; INDOC IS PASSED AS THE DOCUMENT NAME - DON'T KNOW WHERE TO STORE THIS NOW
"RTN","C0CDAPCE",55,0)
 ; EXTRINSIC WHICH RETURNS THE DOCID ASSIGNED BY MXML
"RTN","C0CDAPCE",56,0)
 ;Q $$EN^MXMLDOM(INXML)
"RTN","C0CDAPCE",57,0)
 Q $$EN^MXMLDOM(INXML,"W")
"RTN","C0CDAPCE",58,0)
 ;
"RTN","C0CDAPCE",59,0)
 
"RTN","C0CDAQH")
0^27^B142601431
"RTN","C0CDAQH",1,0)
C0CDAQH ; GPL - QRDA Header Routines ;/14/13  17:05
"RTN","C0CDAQH",2,0)
 ;;0.1;C0CDA;nopatch;noreleasedate;Build 1
"RTN","C0CDAQH",3,0)
 ;
"RTN","C0CDAQH",4,0)
 ; License AGPL v3.0
"RTN","C0CDAQH",5,0)
 ; 
"RTN","C0CDAQH",6,0)
 Q
"RTN","C0CDAQH",7,0)
 ;
"RTN","C0CDAQH",8,0)
TQHEADER ;
"RTN","C0CDAQH",9,0)
 ;;<?xml version="1.0" encoding="utf-8"?>
"RTN","C0CDAQH",10,0)
 ;;<ClinicalDocument xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
"RTN","C0CDAQH",11,0)
 ;;xmlns="urn:hl7-org:v3"
"RTN","C0CDAQH",12,0)
 ;;xmlns:voc="urn:hl7-org:v3/voc"
"RTN","C0CDAQH",13,0)
 ;;xmlns:sdtc="urn:hl7-org:sdtc">
"RTN","C0CDAQH",14,0)
 ;;<!-- QRDA Header -->
"RTN","C0CDAQH",15,0)
 ;;<realmCode code="US"/>
"RTN","C0CDAQH",16,0)
 ;;<typeId root="2.16.840.1.113883.1.3" extension="POCD_HD000040"/>
"RTN","C0CDAQH",17,0)
 ;;<!-- US Realm Header Template Id -->
"RTN","C0CDAQH",18,0)
 ;;<templateId root="2.16.840.1.113883.10.20.22.1.1" extension="2015-08-01"/>
"RTN","C0CDAQH",19,0)
 ;;<!-- QRDA templateId -->
"RTN","C0CDAQH",20,0)
 ;;<templateId root="2.16.840.1.113883.10.20.24.1.1" extension="2016-02-01"/>
"RTN","C0CDAQH",21,0)
- ;;<!-- QDM-based QRDA templateId -->
"RTN","C0CDAQH",22,0)
 ;;<templateId root="2.16.840.1.113883.10.20.24.1.2" extension="2016-02-01"/>
"RTN","C0CDAQH",23,0)
 ;;<!-- CMS QRDA templateId -->
"RTN","C0CDAQH",24,0)
 ;;<templateId root="2.16.840.1.113883.10.20.24.1.3" extension="2015-07-01" />
"RTN","C0CDAQH",25,0)
 ;;<!-- This is the globally unique identifier for this QRDA document -->
"RTN","C0CDAQH",26,0)
 ;;<id root="@@docNumber@@"/>
"RTN","C0CDAQH",27,0)
 ;;<!-- QRDA document type code -->
"RTN","C0CDAQH",28,0)
 ;;<code code="55182-0" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Quality Measure Report"/>
"RTN","C0CDAQH",29,0)
 ;;<title>QRDA Incidence Report</title>
"RTN","C0CDAQH",30,0)
 ;;<!-- This is the document creation time -->
"RTN","C0CDAQH",31,0)
 ;;<effectiveTime value="@@effectiveTime@@"/>
"RTN","C0CDAQH",32,0)
 ;;<confidentialityCode code="N" codeSystem="2.16.840.1.113883.5.25"/>
"RTN","C0CDAQH",33,0)
 ;;<languageCode code="en"/>
"RTN","C0CDAQH",34,0)
 ;;<!-- reported patient -->
"RTN","C0CDAQH",35,0)
 ;;<recordTarget>
"RTN","C0CDAQH",36,0)
 ;;<patientRole>
"RTN","C0CDAQH",37,0)
 ;;<id extension="0c08d310-356f-0134-bb5d-20999b0ed66f" root="2.16.840.1.113883.4.572"/>
"RTN","C0CDAQH",38,0)
 ;;<addr use="HP">
"RTN","C0CDAQH",39,0)
 ;;<state>@@address@stateProvince@@</state>
"RTN","C0CDAQH",40,0)
 ;;<city>@@address@city@@</city>
"RTN","C0CDAQH",41,0)
 ;;<postalCode>@@address@postalCode@@</postalCode>
"RTN","C0CDAQH",42,0)
 ;;<streetAddressLine>@@address@streetLine1@@</streetAddressLine>
"RTN","C0CDAQH",43,0)
 ;;<country>US</country>
"RTN","C0CDAQH",44,0)
 ;;</addr>
"RTN","C0CDAQH",45,0)
 ;;<telecom use="WP" value="tel:+1-781-271-3000"/>
"RTN","C0CDAQH",46,0)
 ;;<patient>
"RTN","C0CDAQH",47,0)
 ;;<name>
"RTN","C0CDAQH",48,0)
 ;;<family>@@familyName@value@@</family>
"RTN","C0CDAQH",49,0)
 ;;<given>@@givenNames@value@@</given>
"RTN","C0CDAQH",50,0)
 ;;</name>
"RTN","C0CDAQH",51,0)
 ;;<administrativeGenderCode code="@@gender@value@@" codeSystem="2.16.840.1.113883.5.1" codeSystemName="HL7 AdministrativeGender"/>
"RTN","C0CDAQH",52,0)
 ;;<birthTime value="@@birthTime@@"/>
"RTN","C0CDAQH",53,0)
 ;;<raceCode code="@@raceCode@@" displayName="@@raceName@@" codeSystem="2.16.840.1.113883.6.238" codeSystemName="OMB Standards for Race and Ethnicity"/>
"RTN","C0CDAQH",54,0)
 ;;<ethnicGroupCode code="@@ethnicCode@@" displayName="@@ethnicName@@" codeSystem="2.16.840.1.113883.6.238" codeSystemName="OMB Standards for Race and Ethnicity"/>
"RTN","C0CDAQH",55,0)
 ;;<languageCommunication>
"RTN","C0CDAQH",56,0)
 ;;<templateId root="2.16.840.1.113883.3.88.11.83.2" assigningAuthorityName="HITSP/C83"/>
"RTN","C0CDAQH",57,0)
 ;;<templateId root="1.3.6.1.4.1.19376.1.5.3.1.2.1" assigningAuthorityName="IHE/PCC"/>
"RTN","C0CDAQH",58,0)
 ;;<languageCode code="eng"/>
"RTN","C0CDAQH",59,0)
 ;;</languageCommunication>
"RTN","C0CDAQH",60,0)
 ;;</patient>
"RTN","C0CDAQH",61,0)
 ;;</patientRole>
"RTN","C0CDAQH",62,0)
 ;;</recordTarget>
"RTN","C0CDAQH",63,0)
 Q
"RTN","C0CDAQH",64,0)
 ;
"RTN","C0CDAQH",65,0)
TQAUTHOR ;
"RTN","C0CDAQH",66,0)
 ;;<author>
"RTN","C0CDAQH",67,0)
 ;;<time value='@@authorTime@@'></time>
"RTN","C0CDAQH",68,0)
 ;;<assignedAuthor classCode='ASSIGNED'>
"RTN","C0CDAQH",69,0)
 ;;<id nullFlavor='UNK'></id>
"RTN","C0CDAQH",70,0)
 ;;<addr>
"RTN","C0CDAQH",71,0)
 ;;<state>@@orgState@@</state>
"RTN","C0CDAQH",72,0)
 ;;<city>@@orgCity@@</city>
"RTN","C0CDAQH",73,0)
 ;;<postalCode>@@orgZip@@</postalCode>
"RTN","C0CDAQH",74,0)
 ;;<streetAddressLine>@@orgAddr@@</streetAddressLine>
"RTN","C0CDAQH",75,0)
 ;;</addr>
"RTN","C0CDAQH",76,0)
 ;;<telecom use='WP' value='@@orgTelephone@@'></telecom>
"RTN","C0CDAQH",77,0)
 ;;<assignedAuthoringDevice>
"RTN","C0CDAQH",78,0)
 ;;<manufacturerModelName>Opensource CDA Factory</manufacturerModelName>
"RTN","C0CDAQH",79,0)
 ;;<softwareName>Opensource CDA Documents Generator</softwareName>
"RTN","C0CDAQH",80,0)
 ;;</assignedAuthoringDevice>
"RTN","C0CDAQH",81,0)
 ;;</assignedAuthor>
"RTN","C0CDAQH",82,0)
 ;;</author>
"RTN","C0CDAQH",83,0)
 ;;<custodian>
"RTN","C0CDAQH",84,0)
 ;;<assignedCustodian classCode="ASSIGNED">
"RTN","C0CDAQH",85,0)
 ;;<representedCustodianOrganization classCode="ORG" determinerCode="INSTANCE">
"RTN","C0CDAQH",86,0)
 ;;<id extension="CDA" root="@@orgOID@@"></id>
"RTN","C0CDAQH",87,0)
 ;;<name>@@orgName@@</name>
"RTN","C0CDAQH",88,0)
 ;;<telecom use="WP" value="@@orgTelephone@@"></telecom>
"RTN","C0CDAQH",89,0)
 ;;<addr>
"RTN","C0CDAQH",90,0)
 ;;<state>@@orgState@@</state>
"RTN","C0CDAQH",91,0)
 ;;<city>@@orgCity@@</city>
"RTN","C0CDAQH",92,0)
 ;;<postalCode>@@orgZip@@</postalCode>
"RTN","C0CDAQH",93,0)
 ;;<streetAddressLine>@@orgAddr@@</streetAddressLine>
"RTN","C0CDAQH",94,0)
 ;;</addr>
"RTN","C0CDAQH",95,0)
 ;;</representedCustodianOrganization>
"RTN","C0CDAQH",96,0)
 ;;</assignedCustodian>
"RTN","C0CDAQH",97,0)
 ;;</custodian>
"RTN","C0CDAQH",98,0)
 ;;<!-- This needs to take reporting program into account EH/EP-->
"RTN","C0CDAQH",99,0)
 ;;<informationRecipient>
"RTN","C0CDAQH",100,0)
 ;;<intendedRecipient>
"RTN","C0CDAQH",101,0)
 ;;<id root="2.16.840.1.113883.3.249.7" extension="PQRS_MU_INDIVIDUAL"/>
"RTN","C0CDAQH",102,0)
 ;;</intendedRecipient>
"RTN","C0CDAQH",103,0)
 ;;</informationRecipient>
"RTN","C0CDAQH",104,0)
 ;;<legalAuthenticator>
"RTN","C0CDAQH",105,0)
 ;;<time value="20170423141505"/>
"RTN","C0CDAQH",106,0)
 ;;<signatureCode code="S"/>
"RTN","C0CDAQH",107,0)
 ;;<assignedEntity>
"RTN","C0CDAQH",108,0)
 ;;<id root="bc01a5d1-3a34-4286-82cc-43eb04c972a7"/>
"RTN","C0CDAQH",109,0)
 ;;<addr>
"RTN","C0CDAQH",110,0)
 ;;<streetAddressLine>202 Burlington Rd.</streetAddressLine>
"RTN","C0CDAQH",111,0)
 ;;<city>Bedford</city>
"RTN","C0CDAQH",112,0)
 ;;<state>MA</state>
"RTN","C0CDAQH",113,0)
 ;;<postalCode>01730</postalCode>
"RTN","C0CDAQH",114,0)
 ;;<country>US</country>
"RTN","C0CDAQH",115,0)
 ;;</addr>
"RTN","C0CDAQH",116,0)
 ;;<telecom use="WP" value="tel:(781)271-3000"/>
"RTN","C0CDAQH",117,0)
 ;;<assignedPerson>
"RTN","C0CDAQH",118,0)
 ;;<name>
"RTN","C0CDAQH",119,0)
 ;;<given>Henry</given>
"RTN","C0CDAQH",120,0)
 ;;<family>Seven</family>
"RTN","C0CDAQH",121,0)
 ;;</name>
"RTN","C0CDAQH",122,0)
 ;;</assignedPerson>
"RTN","C0CDAQH",123,0)
 ;;<representedOrganization>
"RTN","C0CDAQH",124,0)
 ;;<id root="2.16.840.1.113883.19.5"/>
"RTN","C0CDAQH",125,0)
 ;;<name>Cypress</name>
"RTN","C0CDAQH",126,0)
 ;;</representedOrganization>
"RTN","C0CDAQH",127,0)
 ;;</assignedEntity>
"RTN","C0CDAQH",128,0)
 ;;</legalAuthenticator>
"RTN","C0CDAQH",129,0)
 Q
"RTN","C0CDAQH",130,0)
 ;
"RTN","C0CDAQH",131,0)
TQDOCOF ;
"RTN","C0CDAQH",132,0)
 ;;<documentationOf typeCode="DOC">
"RTN","C0CDAQH",133,0)
 ;;<serviceEvent classCode="PCPR"> <!-- care provision -->
"RTN","C0CDAQH",134,0)
 ;;<effectiveTime>
"RTN","C0CDAQH",135,0)
 ;;<low nullFlavor='UNK'/>
"RTN","C0CDAQH",136,0)
 ;;<high nullFlavor='UNK'/>
"RTN","C0CDAQH",137,0)
 ;;</effectiveTime>
"RTN","C0CDAQH",138,0)
 ;;<!-- You can include multiple performers, each with an NPI, TIN, CCN. -->
"RTN","C0CDAQH",139,0)
 ;;<performer typeCode="PRF"> 
"RTN","C0CDAQH",140,0)
 ;;<time>
"RTN","C0CDAQH",141,0)
 ;;<low nullFlavor='UNK'/>
"RTN","C0CDAQH",142,0)
 ;;<high nullFlavor='UNK'/>
"RTN","C0CDAQH",143,0)
 ;;</time>
"RTN","C0CDAQH",144,0)
 ;;<assignedEntity>
"RTN","C0CDAQH",145,0)
 ;;<id root="2.16.840.1.113883.4.6" extension="1753228646" />
"RTN","C0CDAQH",146,0)
 ;;<code code="207Q00000X" codeSystemName="Healthcare Provider Taxonomy (HIPAA)" codeSystem="2.16.840.1.113883.6.101"/>
"RTN","C0CDAQH",147,0)
 ;;<addr use="HP">
"RTN","C0CDAQH",148,0)
 ;;<streetAddressLine>54708 Marian Cove Trail</streetAddressLine>
"RTN","C0CDAQH",149,0)
 ;;<streetAddressLine>Apt. 264</streetAddressLine>
"RTN","C0CDAQH",150,0)
 ;;<city>East Adam</city>
"RTN","C0CDAQH",151,0)
 ;;<state>OK</state>
"RTN","C0CDAQH",152,0)
 ;;<postalCode>73079</postalCode>
"RTN","C0CDAQH",153,0)
 ;;<country>US</country>
"RTN","C0CDAQH",154,0)
 ;;</addr>
"RTN","C0CDAQH",155,0)
 ;;<assignedPerson>
"RTN","C0CDAQH",156,0)
 ;;<name>
"RTN","C0CDAQH",157,0)
 ;;<given>Leah</given>
"RTN","C0CDAQH",158,0)
 ;;<family>Banks</family>
"RTN","C0CDAQH",159,0)
 ;;</name>
"RTN","C0CDAQH",160,0)
 ;;</assignedPerson>
"RTN","C0CDAQH",161,0)
 ;;<representedOrganization>
"RTN","C0CDAQH",162,0)
 ;;<id root="2.16.840.1.113883.4.2" extension="618777508" />
"RTN","C0CDAQH",163,0)
 ;;<addr use="HP">
"RTN","C0CDAQH",164,0)
 ;;<streetAddressLine>54708 Marian Cove Trail</streetAddressLine>
"RTN","C0CDAQH",165,0)
 ;;<streetAddressLine>Apt. 264</streetAddressLine>
"RTN","C0CDAQH",166,0)
 ;;<city>East Adam</city>
"RTN","C0CDAQH",167,0)
 ;;<state>OK</state>
"RTN","C0CDAQH",168,0)
 ;;<postalCode>73079</postalCode>
"RTN","C0CDAQH",169,0)
 ;;<country>US</country>
"RTN","C0CDAQH",170,0)
 ;;</addr>
"RTN","C0CDAQH",171,0)
 ;;</representedOrganization>
"RTN","C0CDAQH",172,0)
 ;;</assignedEntity>
"RTN","C0CDAQH",173,0)
 ;;</performer>
"RTN","C0CDAQH",174,0)
 ;;</serviceEvent>
"RTN","C0CDAQH",175,0)
 ;;</documentationOf>
"RTN","C0CDAQH",176,0)
 Q
"RTN","C0CDAQH",177,0)
 ;
"RTN","C0CDAQH",178,0)
TQCMS160 ;
"RTN","C0CDAQH",179,0)
 ;;<component>
"RTN","C0CDAQH",180,0)
 ;;<structuredBody>
"RTN","C0CDAQH",181,0)
 ;;<component>
"RTN","C0CDAQH",182,0)
 ;;<section>
"RTN","C0CDAQH",183,0)
 ;;<!-- 
"RTN","C0CDAQH",184,0)
 ;;*****************************************************************
"RTN","C0CDAQH",185,0)
 ;;Measure Section
"RTN","C0CDAQH",186,0)
 ;;*****************************************************************
"RTN","C0CDAQH",187,0)
 ;;         -->
"RTN","C0CDAQH",188,0)
 ;;         <!-- This is the templateId for Measure Section -->
"RTN","C0CDAQH",189,0)
 ;;         <templateId root="2.16.840.1.113883.10.20.24.2.2"/>
"RTN","C0CDAQH",190,0)
 ;;         <!-- This is the templateId for Measure Section QDM -->
"RTN","C0CDAQH",191,0)
 ;;         <templateId root="2.16.840.1.113883.10.20.24.2.3"/>
"RTN","C0CDAQH",192,0)
 ;;         <!-- This is the LOINC code for "Measure document". This stays the same for all measure section required by QRDA standard -->
"RTN","C0CDAQH",193,0)
 ;;         <code code="55186-1" codeSystem="2.16.840.1.113883.6.1"/>
"RTN","C0CDAQH",194,0)
 ;;         <title>Measure Section</title>
"RTN","C0CDAQH",195,0)
 ;;         <text>
"RTN","C0CDAQH",196,0)
 ;;           <table border="1" width="100%">
"RTN","C0CDAQH",197,0)
 ;;             <thead>
"RTN","C0CDAQH",198,0)
 ;;               <tr>
"RTN","C0CDAQH",199,0)
 ;;                 <th>eMeasure Title</th>
"RTN","C0CDAQH",200,0)
 ;;                 <th>Version neutral identifier</th>
"RTN","C0CDAQH",201,0)
 ;;                <th>eMeasure Version Number</th>
"RTN","C0CDAQH",202,0)
 ;;                 <th>Version specific identifier</th>
"RTN","C0CDAQH",203,0)
 ;;               </tr>
"RTN","C0CDAQH",204,0)
 ;;             </thead>
"RTN","C0CDAQH",205,0)
 ;;             <tbody>
"RTN","C0CDAQH",206,0)
 ;;               <tr>
"RTN","C0CDAQH",207,0)
 ;;                 <td>Depression Utilization of the PHQ-9 Tool</td>
"RTN","C0CDAQH",208,0)
 ;;                 <td>A4B9763C-847E-4E02-BB7E-ACC596E90E2C</td>
"RTN","C0CDAQH",209,0)
 ;;                 <td>5</td>
"RTN","C0CDAQH",210,0)
 ;;                 <td>40280381-503F-A1FC-0150-AFE320C01761</td>
"RTN","C0CDAQH",211,0)
 ;;                 <td></td>
"RTN","C0CDAQH",212,0)
 ;;               </tr>
"RTN","C0CDAQH",213,0)
 ;;             </tbody>
"RTN","C0CDAQH",214,0)
 ;;           </table>
"RTN","C0CDAQH",215,0)
 ;;         </text>
"RTN","C0CDAQH",216,0)
 ;;         <!-- 1..* Organizers, each containing a reference to an eMeasure -->
"RTN","C0CDAQH",217,0)
 ;;         <entry>
"RTN","C0CDAQH",218,0)
 ;;           <organizer classCode="CLUSTER" moodCode="EVN">
"RTN","C0CDAQH",219,0)
 ;;             <!-- This is the templateId for Measure Reference -->
"RTN","C0CDAQH",220,0)
 ;;             <templateId root="2.16.840.1.113883.10.20.24.3.98"/>
"RTN","C0CDAQH",221,0)
 ;;             <!-- This is the templateId for eMeasure Reference QDM -->
"RTN","C0CDAQH",222,0)
 ;;             <templateId root="2.16.840.1.113883.10.20.24.3.97"/>
"RTN","C0CDAQH",223,0)
 ;;             <id root="1.3.6.1.4.1.115" extension="40280381-503F-A1FC-0150-AFE320C01761"/>
"RTN","C0CDAQH",224,0)
 ;;             <statusCode code="completed"/>
"RTN","C0CDAQH",225,0)
 ;;             <!-- Containing isBranch external references -->
"RTN","C0CDAQH",226,0)
 ;;             <reference typeCode="REFR">
"RTN","C0CDAQH",227,0)
 ;;               <externalDocument classCode="DOC" moodCode="EVN">
"RTN","C0CDAQH",228,0)
 ;;                 <!-- SHALL: This is the version specific identifier for eMeasure: QualityMeasureDocument/id it is a GUID-->
"RTN","C0CDAQH",229,0)
 ;;                 <id root="2.16.840.1.113883.4.738" extension="40280381-503F-A1FC-0150-AFE320C01761"/>
"RTN","C0CDAQH",230,0)
 ;;                 <!-- SHOULD This is the title of the eMeasure -->
"RTN","C0CDAQH",231,0)
 ;;                 <text>Depression Utilization of the PHQ-9 Tool</text>
"RTN","C0CDAQH",232,0)
 ;;                 <!-- SHOULD: setId is the eMeasure version neutral id  -->
"RTN","C0CDAQH",233,0)
 ;;                 <setId root="A4B9763C-847E-4E02-BB7E-ACC596E90E2C"/>
"RTN","C0CDAQH",234,0)
 ;;                 <!-- This is the sequential eMeasure Version number -->
"RTN","C0CDAQH",235,0)
 ;;                 <versionNumber value="5"/>                  
"RTN","C0CDAQH",236,0)
 ;;               </externalDocument>
"RTN","C0CDAQH",237,0)
 ;;             </reference>
"RTN","C0CDAQH",238,0)
 ;;           </organizer>
"RTN","C0CDAQH",239,0)
 ;;         </entry>
"RTN","C0CDAQH",240,0)
 ;;       </section>
"RTN","C0CDAQH",241,0)
 ;;     </component>
"RTN","C0CDAQH",242,0)
 ;;           <component>
"RTN","C0CDAQH",243,0)
 ;;       <section>
"RTN","C0CDAQH",244,0)
 ;;         <!-- This is the templateId for Reporting Parameters section -->
"RTN","C0CDAQH",245,0)
 ;;         <templateId root="2.16.840.1.113883.10.20.17.2.1" />
"RTN","C0CDAQH",246,0)
 ;;         <templateId root="2.16.840.1.113883.10.20.17.2.1" extension="2015-07-01" />
"RTN","C0CDAQH",247,0)
 ;;         <code code="55187-9" codeSystem="2.16.840.1.113883.6.1"/>
"RTN","C0CDAQH",248,0)
 ;;         <title>Reporting Parameters</title>
"RTN","C0CDAQH",249,0)
 ;;         <text>
"RTN","C0CDAQH",250,0)
 ;;           <list>
"RTN","C0CDAQH",251,0)
 ;;             <item>Reporting period: January 1st, 2015 00:00 - December 31st, 2015 23:59</item>
"RTN","C0CDAQH",252,0)
 ;;           </list>
"RTN","C0CDAQH",253,0)
 ;;         </text>
"RTN","C0CDAQH",254,0)
 ;;         <entry typeCode="DRIV">
"RTN","C0CDAQH",255,0)
 ;;           <act classCode="ACT" moodCode="EVN">
"RTN","C0CDAQH",256,0)
 ;;             <!-- This is the templateId for Reporting Parameteres Act -->
"RTN","C0CDAQH",257,0)
 ;;             <templateId root="2.16.840.1.113883.10.20.17.3.8" />
"RTN","C0CDAQH",258,0)
 ;;             <templateId root="2.16.840.1.113883.10.20.17.3.8" extension="2015-07-01" />
"RTN","C0CDAQH",259,0)
 ;;             <id root="1.3.6.1.4.1.115" extension="D371E142B952DFC21A97F4810691AC2B" />
"RTN","C0CDAQH",260,0)
 ;;             <code code="252116004" codeSystem="2.16.840.1.113883.6.96" displayName="Observation Parameters"/>
"RTN","C0CDAQH",261,0)
 ;;             <effectiveTime>
"RTN","C0CDAQH",262,0)
 ;;               <low value="20150101000000"/>
"RTN","C0CDAQH",263,0)
 ;;               <high value="20151231235959"/>
"RTN","C0CDAQH",264,0)
 ;;             </effectiveTime>
"RTN","C0CDAQH",265,0)
 ;;           </act>
"RTN","C0CDAQH",266,0)
 ;;         </entry>
"RTN","C0CDAQH",267,0)
 ;;       </section>
"RTN","C0CDAQH",268,0)
 ;;     </component>
"RTN","C0CDAQH",269,0)
 Q
"RTN","C0CDAQH",270,0)
 ;
"RTN","C0CDAQH",271,0)
TQPDATA ;
"RTN","C0CDAQH",272,0)
 ;;<component>
"RTN","C0CDAQH",273,0)
 ;;<section>
"RTN","C0CDAQH",274,0)
 ;;<!-- This is the templateId for Patient Data section -->
"RTN","C0CDAQH",275,0)
 ;;<templateId root="2.16.840.1.113883.10.20.17.2.4"/>
"RTN","C0CDAQH",276,0)
 ;;<!-- This is the templateId for Patient Data QDM section -->
"RTN","C0CDAQH",277,0)
 ;;<templateId root="2.16.840.1.113883.10.20.24.2.1" extension="2016-02-01" />
"RTN","C0CDAQH",278,0)
 ;;<templateId root="2.16.840.1.113883.10.20.24.2.1" extension="2015-07-01"/>
"RTN","C0CDAQH",279,0)
 ;;<code code="55188-7" codeSystem="2.16.840.1.113883.6.1"/>
"RTN","C0CDAQH",280,0)
 ;;<title>Patient Data</title>
"RTN","C0CDAQH",281,0)
 ;;<text>
"RTN","C0CDAQH",282,0)
 ;;</text>
"RTN","C0CDAQH",283,0)
 Q
"RTN","C0CDAQH",284,0)
 ;
"RTN","C0CDAQH",285,0)
TQPEND ;
"RTN","C0CDAQH",286,0)
 ;;        </section>
"RTN","C0CDAQH",287,0)
 ;;     </component>
"RTN","C0CDAQH",288,0)
 ;;   </structuredBody>
"RTN","C0CDAQH",289,0)
 ;; </component>
"RTN","C0CDAQH",290,0)
 ;;</ClinicalDocument>
"RTN","C0CDAQH",291,0)
 Q
"RTN","C0CDAQH",292,0)
 ;
"RTN","C0CDAQU")
0^28^B1447833
"RTN","C0CDAQU",1,0)
C0CDAQU ; GPL - QRDA Utility Routines ;6/24/17  17:05
"RTN","C0CDAQU",2,0)
 ;;0.1;C0CDAQ;nopatch;noreleasedate;Build 1
"RTN","C0CDAQU",3,0)
 ;
"RTN","C0CDAQU",4,0)
 ; License AGPL v3.0
"RTN","C0CDAQU",5,0)
 ; 
"RTN","C0CDAQU",6,0)
 Q
"RTN","C0CDAQU",7,0)
 ;
"RTN","C0CDAQU",8,0)
ADDTEMP(TEMPOID,VSOID,DOMAIN) ; add a Template OID and ValueSet OID to the C0CDAQ XML TEMPLATE file (176.901)
"RTN","C0CDAQU",9,0)
 ;
"RTN","C0CDAQU",10,0)
 ; gpl astro
"RTN","C0CDAQU",11,0)
 q
"RTN","C0CDAQU",12,0)
 ;
"RTN","C0CDAQU",13,0)
 N FN S FN=176.901
"RTN","C0CDAQU",14,0)
 N FDA
"RTN","C0CDAQU",15,0)
 S FDA(FN,"?+1,",.01)=TEMPOID
"RTN","C0CDAQU",16,0)
 I $G(DOMAIN)'="" S FDA(FN,"?+1,",.03)=DOMAIN
"RTN","C0CDAQU",17,0)
 D UPDIE^C0CDAC0(.FDA)
"RTN","C0CDAQU",18,0)
 N IEN S IEN=$O(^C0CDA(176.901,"B",TEMPOID,""))
"RTN","C0CDAQU",19,0)
 I IEN="" D  Q  ;
"RTN","C0CDAQU",20,0)
 . W !,"ERROR CREATE TEMPLATE RECORD"
"RTN","C0CDAQU",21,0)
 K FDA
"RTN","C0CDAQU",22,0)
 S FDA(176.9011,"?+1,"_IEN_",",.01)=VSOID
"RTN","C0CDAQU",23,0)
 D UPDIE^C0CDAC0(.FDA)
"RTN","C0CDAQU",24,0)
 Q
"RTN","C0CDAQU",25,0)
 ;
"RTN","C0CDAQU",26,0)
wsCQMGEN(RTN,FILTER) ; return the completed template for the code if used in the cqm
"RTN","C0CDAQU",27,0)
 ; FILTER("code")= the code that drives the generation
"RTN","C0CDAQU",28,0)
 ; FILTER("cqm")= the quality measure to filter by
"RTN","C0CDAQU",29,0)
 ; FILTER("date")= the date/time associated with the code
"RTN","C0CDAQU",30,0)
 ;
"RTN","C0CDAQU",31,0)
 
"RTN","C0CDAQU",32,0)
CDATRTN(VSOID) ; extrinsic returns the routine to call to generate the correct
"RTN","C0CDAQU",33,0)
 ; template for the valueset with OID VSOID
"RTN","C0CDAQU",34,0)
 ;
"RTN","C0CDAQU",35,0)
 N FN S FN=176.901 ; file number of the template file
"RTN","C0CDAQU",36,0)
 N IEN
"RTN","C0CDAQU",37,0)
 S IEN=$O(^C0CDA(176.901,"VSOID",VSOID,""))
"RTN","C0CDAQU",38,0)
 I IEN="" Q ""
"RTN","C0CDAQU",39,0)
 N RTN S RTN=$$GET1^DIQ(FN,IEN_",",2.5)
"RTN","C0CDAQU",40,0)
 S RTN=$TR(RTN,"|","^")
"RTN","C0CDAQU",41,0)
 Q RTN
"RTN","C0CDAQU",42,0)
 ;
"RTN","KBAIQLDM")
0^29^B159500041
"RTN","KBAIQLDM",1,0)
KBAIQLDM ; GPL - QRDA loader entry routines ; 3/8/15 6:03pm
"RTN","KBAIQLDM",2,0)
 ;;0.1;QRDA LOADER;nopatch;noreleasedate;Build 1
"RTN","KBAIQLDM",3,0)
 ;
"RTN","KBAIQLDM",4,0)
 Q
"RTN","KBAIQLDM",5,0)
 ;
"RTN","KBAIQLDM",6,0)
INITMAPS ; initialize maps 
"RTN","KBAIQLDM",7,0)
 N G
"RTN","KBAIQLDM",8,0)
 S G=$NA(^XTMP("KBAIQLD","MAPS"))
"RTN","KBAIQLDM",9,0)
 K @G
"RTN","KBAIQLDM",10,0)
 N MAP
"RTN","KBAIQLDM",11,0)
 ; SOP (payment?)
"RTN","KBAIQLDM",12,0)
 S MAP="SOP"
"RTN","KBAIQLDM",13,0)
 S @G@(MAP,"CODE","394","OTHER")=""
"RTN","KBAIQLDM",14,0)
 ; race
"RTN","KBAIQLDM",15,0)
 S MAP="race"
"RTN","KBAIQLDM",16,0)
 S @G@(MAP,"CODE","1002-5","AMERICAN INDIAN OR ALASKA NATI")=""
"RTN","KBAIQLDM",17,0)
 S @G@(MAP,"CODE","2028-9","ASIAN")=""
"RTN","KBAIQLDM",18,0)
 S @G@(MAP,"CODE","2054-5","BLACK OR AFRICAN AMERICAN")=""
"RTN","KBAIQLDM",19,0)
 S @G@(MAP,"CODE","2076-8","NATIVE HAWAIIAN OR OTHER PACIFIC ISLANDER")=""
"RTN","KBAIQLDM",20,0)
 S @G@(MAP,"CODE","2106-3","WHITE")=""
"RTN","KBAIQLDM",21,0)
 S @G@(MAP,"CODE","213101","DECLINED TO SPECIFY")=""
"RTN","KBAIQLDM",22,0)
 S @G@(MAP,"CODE","9999-4","UNKNOWN BY PATIENT")=""
"RTN","KBAIQLDM",23,0)
 ; ethnicity
"RTN","KBAIQLDM",24,0)
 S MAP="ethnicity"
"RTN","KBAIQLDM",25,0)
 S @G@(MAP,"CODE","21350-2","HISPANIC OR LATINO")=""
"RTN","KBAIQLDM",26,0)
 S @G@(MAP,"CODE","2186-5","NOT HISPANIC OR LATINO")=""
"RTN","KBAIQLDM",27,0)
 S @G@(MAP,"CODE","213101","DECLINED TO ANSWER")=""
"RTN","KBAIQLDM",28,0)
 ; Health Factors - SNOMED
"RTN","KBAIQLDM",29,0)
 S MAP="HF"
"RTN","KBAIQLDM",30,0)
 S @G@(MAP,"CODE","4525004","ED [ARRIVAL-DEPARTURE] TIME")=""
"RTN","KBAIQLDM",31,0)
 S @G@(MAP,"CODE","1748006","VTE COMFIRMED")=""
"RTN","KBAIQLDM",32,0)
 S @G@(MAP,"CODE","10378005","TIME DECISION TO ADMIT MADE")=""
"RTN","KBAIQLDM",33,0)
 S @G@(MAP,"CODE","225337009","SUICIDE RISK ASSESSMENT")=""
"RTN","KBAIQLDM",34,0)
 S @G@(MAP,"CODE","428191000124101","DOCUMENTATION OF CURRENT MEDS")=""
"RTN","KBAIQLDM",35,0)
 S @G@(MAP,"CODE","371530004","CLINICAL CONSULTATION REPORT")=""
"RTN","KBAIQLDM",36,0)
 S @G@(MAP,"CODE","428171000124102","ADOLESCENT DEPRESSION SCREEN NEGATIVE")=""
"RTN","KBAIQLDM",37,0)
 S @G@(MAP,"CODE","428231000124106","MATERNAL POSTPARTUM DEPRESSION CARE")=""
"RTN","KBAIQLDM",38,0)
 S @G@(MAP,"CODE","428341000124108","MACULAR EDEMA ABSENT")=""
"RTN","KBAIQLDM",39,0)
 S @G@(MAP,"CODE","193350004","MACULAR EDEMA PRESENT")=""
"RTN","KBAIQLDM",40,0)
 S @G@(MAP,"CODE","417886001","TREATMENT ADJUSTED PER PROTOCOL")=""
"RTN","KBAIQLDM",41,0)
 S @G@(MAP,"CODE","105480006","WRITTEN INFORMATION NOT GIVEN")=""
"RTN","KBAIQLDM",42,0)
 S @G@(MAP,"CODE","413318004","WRITTEN INFORMATION GIVEN")=""
"RTN","KBAIQLDM",43,0)
 S @G@(MAP,"CODE","226789007","BREAST MILK ADMINISTERED")=""
"RTN","KBAIQLDM",44,0)
 S @G@(MAP,"CODE","105480006","PATIENT REFUSED TREATMENT")=""
"RTN","KBAIQLDM",45,0)
 S @G@(MAP,"CODE","428171000124102","ADULT DEPRESSION SCREEN")=""
"RTN","KBAIQLDM",46,0)
 S @G@(MAP,"CODE","183932001","PROCEDURE CONTRAINDICATED")=""
"RTN","KBAIQLDM",47,0)
 ; Health Factors - LOINC
"RTN","KBAIQLDM",48,0)
 S @G@(MAP,"CODE","38208-5","STANDARD PAIN ASSMNT TOOL")=""
"RTN","KBAIQLDM",49,0)
 S @G@(MAP,"CODE","44249-1","PHQ-9 RESULT")=""
"RTN","KBAIQLDM",50,0)
 S @G@(MAP,"CODE","71955-9","PROMIS-29: ")=""
"RTN","KBAIQLDM",51,0)
 S @G@(MAP,"CODE","71938-5","MLHFQ")=""
"RTN","KBAIQLDM",52,0)
 S @G@(MAP,"CODE","71955-9","PROMIS-29")=""
"RTN","KBAIQLDM",53,0)
 S @G@(MAP,"CODE","58151-2","BIMS SCORE")=""
"RTN","KBAIQLDM",54,0)
 S @G@(MAP,"CODE","73830-2","FALL RISK ASSESSMENT")=""
"RTN","KBAIQLDM",55,0)
 S @G@(MAP,"CODE","73831-0","ADOLESCENT DEPRESSION SCREEN")=""
"RTN","KBAIQLDM",56,0)
 S @G@(MAP,"CODE","73832-8","ADULT DEPRESSION SCREEN")=""
"RTN","KBAIQLDM",57,0)
 S @G@(MAP,"CODE","69981-9","ASTHMA ACTION PLAN")=""
"RTN","KBAIQLDM",58,0)
 ; Encounters - SNOMED
"RTN","KBAIQLDM",59,0)
 S MAP="encounters"
"RTN","KBAIQLDM",60,0)
 ;S @G@(MAP,"CODE","183452005","IP")=""
"RTN","KBAIQLDM",61,0)
 S @G@(MAP,"CODE","185349003","OP")=""
"RTN","KBAIQLDM",62,0)
 ;S @G@(MAP,"CODE","4525004","ER")=""
"RTN","KBAIQLDM",63,0)
 ;S @G@(MAP,"CODE","10197000","PS")=""
"RTN","KBAIQLDM",64,0)
 ;S @G@(MAP,"CODE","10378005","IP")=""
"RTN","KBAIQLDM",65,0)
 S @G@(MAP,"CODE","108313002","OP")=""
"RTN","KBAIQLDM",66,0)
 ;S @G@(MAP,"CODE","171047005","IO")=""
"RTN","KBAIQLDM",67,0)
 ;S @G@(MAP,"CODE","32485007","IP")=""
"RTN","KBAIQLDM",68,0)
 ;S @G@(MAP,"CODE","305351004","ICU")=""
"RTN","KBAIQLDM",69,0)
 ;S @G@(MAP,"CODE","112689000","IP")=""
"RTN","KBAIQLDM",70,0)
 ;S @G@(MAP,"CODE","8715000","IP")=""
"RTN","KBAIQLDM",71,0)
 ; Encounters - CPT
"RTN","KBAIQLDM",72,0)
 S @G@(MAP,"CODE","92002","OP")=""
"RTN","KBAIQLDM",73,0)
 ;S @G@(MAP,"CODE","96150","PS")=""
"RTN","KBAIQLDM",74,0)
 S @G@(MAP,"CODE","99201","OP")=""
"RTN","KBAIQLDM",75,0)
 ;S @G@(MAP,"CODE","99285","ER")=""
"RTN","KBAIQLDM",76,0)
 ;S @G@(MAP,"CODE","90791","PS")=""
"RTN","KBAIQLDM",77,0)
 S @G@(MAP,"CODE","99202","OP")=""
"RTN","KBAIQLDM",78,0)
 ;S @G@(MAP,"CODE","99285","ER")=""
"RTN","KBAIQLDM",79,0)
 S @G@(MAP,"CODE","99381","OP")=""
"RTN","KBAIQLDM",80,0)
 ; location
"RTN","KBAIQLDM",81,0)
 S MAP="location"
"RTN","KBAIQLDM",82,0)
 ;S @G@(MAP,"CODE","OP","CLINIC A")=""
"RTN","KBAIQLDM",83,0)
 S @G@(MAP,"CODE","OP","VISTA HEALTH CARE")=""
"RTN","KBAIQLDM",84,0)
 S @G@(MAP,"CODE","ER","EMERGENCY DEPT")=""
"RTN","KBAIQLDM",85,0)
 S @G@(MAP,"CODE","IP","CERT MED SURG")=""
"RTN","KBAIQLDM",86,0)
 S @G@(MAP,"CODE","ICU","CERT ICU")=""
"RTN","KBAIQLDM",87,0)
 S @G@(MAP,"CODE","PS","CLINIC A")=""
"RTN","KBAIQLDM",88,0)
 ; roombed
"RTN","KBAIQLDM",89,0)
 S MAP="roombed"
"RTN","KBAIQLDM",90,0)
 S @G@(MAP,"CODE","IP","M1-A")=""
"RTN","KBAIQLDM",91,0)
 S @G@(MAP,"CODE","ICU","1-A")=""
"RTN","KBAIQLDM",92,0)
 S @G@(MAP,"CODE","PS","CLINIC PSYCHIATRY")=""
"RTN","KBAIQLDM",93,0)
 ; provider
"RTN","KBAIQLDM",94,0)
 S MAP="provider"
"RTN","KBAIQLDM",95,0)
 ;S @G@(MAP,"CODE","OP","CQM,HISTORICAL MD")=""
"RTN","KBAIQLDM",96,0)
 S @G@(MAP,"CODE","OP","USER,THREE")=""
"RTN","KBAIQLDM",97,0)
 S @G@(MAP,"CODE","ER","CQM,HISTORICAL MD")=""
"RTN","KBAIQLDM",98,0)
 S @G@(MAP,"CODE","IP","CQM,HISTORICAL MD")=""
"RTN","KBAIQLDM",99,0)
 S @G@(MAP,"CODE","ICU","CQM,HISTORICAL MD")=""
"RTN","KBAIQLDM",100,0)
 S @G@(MAP,"CODE","PS","CQM,HISTORICAL MD")=""
"RTN","KBAIQLDM",101,0)
 ; admitting regulation
"RTN","KBAIQLDM",102,0)
 S MAP="regs"
"RTN","KBAIQLDM",103,0)
 S @G@(MAP,"CODE","IP","OBSERVATION (AND) EXAMINATION")=""
"RTN","KBAIQLDM",104,0)
 S @G@(MAP,"CODE","ICU","OBSERVATION (AND) EXAMINATION")=""
"RTN","KBAIQLDM",105,0)
 ; facility treating speciality
"RTN","KBAIQLDM",106,0)
 S MAP="facilityTreatingSpeciality"
"RTN","KBAIQLDM",107,0)
 S @G@(MAP,"CODE","IP","MEDICAL OBSERVATION")=""
"RTN","KBAIQLDM",108,0)
 S @G@(MAP,"CODE","ICU","MEDICAL OBSERVATION")=""
"RTN","KBAIQLDM",109,0)
 ; discharge type
"RTN","KBAIQLDM",110,0)
 S MAP="dischargeType"
"RTN","KBAIQLDM",111,0)
 S @G@(MAP,"CODE","10161009","DISCHARGE TO HOME OR POLICE CU")=""
"RTN","KBAIQLDM",112,0)
 ; vitals
"RTN","KBAIQLDM",113,0)
 S MAP="vitals"
"RTN","KBAIQLDM",114,0)
 S @G@(MAP,"CODE","8462-4","BLOOD PRESSURE")=""
"RTN","KBAIQLDM",115,0)
 S @G@(MAP,"CODE","8480-6","BLOOD PRESSURE")=""
"RTN","KBAIQLDM",116,0)
 S @G@(MAP,"CODE","39156-5","BMI")=""
"RTN","KBAIQLDM",117,0)
 S @G@(MAP,"CODE","59408-5","PULSE OXIMETRY")=""
"RTN","KBAIQLDM",118,0)
 S @G@(MAP,"CODE","59408-5","OXYGEN SATURATION")=""
"RTN","KBAIQLDM",119,0)
 ; VPatientEd
"RTN","KBAIQLDM",120,0)
 S MAP="vPatientEd"
"RTN","KBAIQLDM",121,0)
 S @G@(MAP,"CODE","11816003","DIET EDUCATION")=""
"RTN","KBAIQLDM",122,0)
 S @G@(MAP,"CODE","171047005","DRUGS OF ADDICTION EDUCATION")=""
"RTN","KBAIQLDM",123,0)
 ; consults
"RTN","KBAIQLDM",124,0)
 S MAP="consults"
"RTN","KBAIQLDM",125,0)
 S @G@(MAP,"CODE","103697008","DENTAL")=""
"RTN","KBAIQLDM",126,0)
 S @G@(MAP,"CODE","171047005","PHYSICAL REHAB")=""
"RTN","KBAIQLDM",127,0)
 ; rad orders - LOINC
"RTN","KBAIQLDM",128,0)
 S MAP="rad"
"RTN","KBAIQLDM",129,0)
 S @G@(MAP,"CODE","24533-2","ABDOMINAL VESSELS MRI ANGIOGRAM W/CON  IV")=""
"RTN","KBAIQLDM",130,0)
 S @G@(MAP,"CODE","24604-1","BREAST MAMMOGRAM DIAGNOSTIC LIMITED")=""
"RTN","KBAIQLDM",131,0)
 S @G@(MAP,"CODE","25031-6","BONE SCAN")=""
"RTN","KBAIQLDM",132,0)
 S @G@(MAP,"CODE","24665-2","SACRUM AND COCCYX X-RAY")=""
"RTN","KBAIQLDM",133,0)
 ; rad orders - SNOMED
"RTN","KBAIQLDM",134,0)
 S @G@(MAP,"CODE","113094008","DIAGNOSTIC RADIOGRAPHY OF CHEST, LATERAL")=""
"RTN","KBAIQLDM",135,0)
 S @G@(MAP,"CODE","168731009","CHEST XRAY")=""
"RTN","KBAIQLDM",136,0)
 S @G@(MAP,"CODE","1748006","VTE Confirmed.")=""
"RTN","KBAIQLDM",137,0)
 ; immunizations - CVX
"RTN","KBAIQLDM",138,0)
 S MAP="immunizations"
"RTN","KBAIQLDM",139,0)
 S @G@(MAP,"CODE","3","MEASLES,MUMPS,RUBELLA (MMR)")=""
"RTN","KBAIQLDM",140,0)
 S @G@(MAP,"CODE","8","HEPATITIS B")=""
"RTN","KBAIQLDM",141,0)
 S @G@(MAP,"CODE","10","POLIOMYELITIS")=""
"RTN","KBAIQLDM",142,0)
 S @G@(MAP,"CODE","20","DIP-TET-a/PERT")=""
"RTN","KBAIQLDM",143,0)
 S @G@(MAP,"CODE","21","VARICELLA")=""
"RTN","KBAIQLDM",144,0)
 S @G@(MAP,"CODE","33","PNEUMOCOCCAL CONJUGATE PCV23")=""
"RTN","KBAIQLDM",145,0)
 S @G@(MAP,"CODE","48","HIB,PRP-T")=""
"RTN","KBAIQLDM",146,0)
 S @G@(MAP,"CODE","83","HEPA,PED/ADOL-2")=""
"RTN","KBAIQLDM",147,0)
 S @G@(MAP,"CODE","104","HEPA/HEPB ADULT")=""
"RTN","KBAIQLDM",148,0)
 S @G@(MAP,"CODE","111","FLU,NASAL")=""
"RTN","KBAIQLDM",149,0)
 S @G@(MAP,"CODE","116","ROTOVIRUS,ORAL")=""
"RTN","KBAIQLDM",150,0)
 S @G@(MAP,"CODE","140","INFLUENZA")=""
"RTN","KBAIQLDM",151,0)
 ; immunizations - SNOMED
"RTN","KBAIQLDM",152,0)
 S @G@(MAP,"CODE","442333005","INFLUENZA")=""
"RTN","KBAIQLDM",153,0)
 ; VExam LOINC
"RTN","KBAIQLDM",154,0)
 S MAP="vExam"
"RTN","KBAIQLDM",155,0)
 S @G@(MAP,"CODE","24604-1","MAMMOGRAM")=""
"RTN","KBAIQLDM",156,0)
 S @G@(MAP,"CODE","32451-7","MACULAR EXAM")=""
"RTN","KBAIQLDM",157,0)
 S @G@(MAP,"CODE","44249-1","PHQ-9 RESULT")=""
"RTN","KBAIQLDM",158,0)
 S @G@(MAP,"CODE","54108-6","NEONATAL HEARING EXAM")=""
"RTN","KBAIQLDM",159,0)
 S @G@(MAP,"CODE","54109-4","NEONATAL HEARING EXAM")=""
"RTN","KBAIQLDM",160,0)
 S @G@(MAP,"CODE","57254-5","FALL RISK ASSESSMENT")=""
"RTN","KBAIQLDM",161,0)
 S @G@(MAP,"CODE","58151-2","BIMS SCORE")=""
"RTN","KBAIQLDM",162,0)
 S @G@(MAP,"CODE","65853-4","CARDIOVASCULAR RISK")=""
"RTN","KBAIQLDM",163,0)
 S @G@(MAP,"CODE","71484-0","CUP TO DISK RATIO EXAM")=""
"RTN","KBAIQLDM",164,0)
 S @G@(MAP,"CODE","71486-5","OPTIC DISK EXAM")=""
"RTN","KBAIQLDM",165,0)
 S @G@(MAP,"CODE","71938-5","MLHFQ")=""
"RTN","KBAIQLDM",166,0)
 S @G@(MAP,"CODE","71955-9","PROMIS-29:")=""
"RTN","KBAIQLDM",167,0)
 S @G@(MAP,"CODE","73831-0","ADOLESCENT DEPRESSION SCREEN NEGATIVE")=""
"RTN","KBAIQLDM",168,0)
 ; VExam - SNOMED
"RTN","KBAIQLDM",169,0)
 S @G@(MAP,"CODE","225337009","SUICIDE RISK ASSESSMENT")=""
"RTN","KBAIQLDM",170,0)
 S @G@(MAP,"CODE","91161007","PULSE FOOT EXAM")=""
"RTN","KBAIQLDM",171,0)
 S @G@(MAP,"CODE","134388005","DIABETIC FOOT EXAM")=""
"RTN","KBAIQLDM",172,0)
 S @G@(MAP,"CODE","252779009","DILATED EYE EXAM")=""
"RTN","KBAIQLDM",173,0)
 S @G@(MAP,"CODE","401191002","DIABETIC FOOT CHECK")=""
"RTN","KBAIQLDM",174,0)
 S @G@(MAP,"CODE","419775003","VISION EXAM")=""
"RTN","KBAIQLDM",175,0)
 S @G@(MAP,"CODE","412726003","LENGTH OF GESTATION AT BIRTH")=""
"RTN","KBAIQLDM",176,0)
 S @G@(MAP,"CODE","44413500","ESTIMATED FETAL GESTATIONAL AGE")=""
"RTN","KBAIQLDM",177,0)
 S @G@(MAP,"CODE","417491009","NEONATAL HEARING EXAM")=""
"RTN","KBAIQLDM",178,0)
 ; VCPT - CPT
"RTN","KBAIQLDM",179,0)
 S MAP="vCPT"
"RTN","KBAIQLDM",180,0)
 S @G@(MAP,"CODE","99201","OP")=""
"RTN","KBAIQLDM",181,0)
 S @G@(MAP,"CODE","90791","PS")=""
"RTN","KBAIQLDM",182,0)
 S @G@(MAP,"CODE","99202","OP")=""
"RTN","KBAIQLDM",183,0)
 S @G@(MAP,"CODE","99381","OP")=""
"RTN","KBAIQLDM",184,0)
 ; astro gpl
"RTN","KBAIQLDM",185,0)
 S @G@(MAP,"CODE","99499","NPP VISIT")=""
"RTN","KBAIQLDM",186,0)
 ; VCPT - SNOMED
"RTN","KBAIQLDM",187,0)
 S @G@(MAP,"CODE","10492003","55810")=""
"RTN","KBAIQLDM",188,0)
 S @G@(MAP,"CODE","84755001","77427")=""
"RTN","KBAIQLDM",189,0)
 S @G@(MAP,"CODE","234723000","D1206")=""
"RTN","KBAIQLDM",190,0)
 S @G@(MAP,"CODE","10745001","59400")=""
"RTN","KBAIQLDM",191,0)
 S @G@(MAP,"CODE","10178000","66840")=""
"RTN","KBAIQLDM",192,0)
 S @G@(MAP,"CODE","105355005","99408")=""
"RTN","KBAIQLDM",193,0)
 S @G@(MAP,"CODE","12350003","44388")=""
"RTN","KBAIQLDM",194,0)
 S @G@(MAP,"CODE","15163009","27130")=""
"RTN","KBAIQLDM",195,0)
 S @G@(MAP,"CODE","177184002","59409")=""
"RTN","KBAIQLDM",196,0)
 S @G@(MAP,"CODE","179344006","27447")=""
"RTN","KBAIQLDM",197,0)
 S @G@(MAP,"CODE","13767004","65235")=""
"RTN","KBAIQLDM",198,0)
 S @G@(MAP,"CODE","108241001","90937")=""
"RTN","KBAIQLDM",199,0)
 S @G@(MAP,"CODE","185349003","99202")=""
"RTN","KBAIQLDM",200,0)
 S @G@(MAP,"CODE","442333005","90653")=""
"RTN","KBAIQLDM",201,0)
 S @G@(MAP,"CODE","444783004","45378")=""
"RTN","KBAIQLDM",202,0)
 S @G@(MAP,"CODE","4525004","99285")=""
"RTN","KBAIQLDM",203,0)
 S @G@(MAP,"CODE","185349003","99381")=""
"RTN","KBAIQLDM",204,0)
 ; labs
"RTN","KBAIQLDM",205,0)
 S MAP="labs"
"RTN","KBAIQLDM",206,0)
 S @G@(MAP,"CODE","2085-9","HDL CHOLESTEROL")=""
"RTN","KBAIQLDM",207,0)
 S @G@(MAP,"CODE","34714-6","PT/INR")=""
"RTN","KBAIQLDM",208,0)
 S @G@(MAP,"CODE","2093-3","CHOLESTEROL, TOTAL")=""
"RTN","KBAIQLDM",209,0)
 S @G@(MAP,"CODE","12773-8","LDL CHOLESTEROL")=""
"RTN","KBAIQLDM",210,0)
 S @G@(MAP,"CODE","13457-7","LDL CHOLESTEROL")=""
"RTN","KBAIQLDM",211,0)
 S @G@(MAP,"CODE","13056-7","PLATELET COUNT")=""
"RTN","KBAIQLDM",212,0)
 S @G@(MAP,"CODE","10524-7","PAP TEST")=""
"RTN","KBAIQLDM",213,0)
 S @G@(MAP,"CODE","17856-6","HEMOGLOBIN A1C")=""
"RTN","KBAIQLDM",214,0)
 S @G@(MAP,"CODE","17855-8","HEMOGLOBIN A1C")=""
"RTN","KBAIQLDM",215,0)
 S @G@(MAP,"CODE","10508-0","PSA")=""
"RTN","KBAIQLDM",216,0)
 S @G@(MAP,"CODE","10351-5","HIV 1 RNA")=""
"RTN","KBAIQLDM",217,0)
 S @G@(MAP,"CODE","35266-6","GLEASON SCORE")=""
"RTN","KBAIQLDM",218,0)
 S @G@(MAP,"CODE","24467-3","CD4 COUNT")=""
"RTN","KBAIQLDM",219,0)
 S @G@(MAP,"CODE","20447-9","HIV 1 RNA")=""
"RTN","KBAIQLDM",220,0)
 S @G@(MAP,"CODE","19080-1","PREGNANCY TEST")=""
"RTN","KBAIQLDM",221,0)
 S @G@(MAP,"CODE","10674-0","HEPATITIS B SURFACE ANTIGEN")=""
"RTN","KBAIQLDM",222,0)
 S @G@(MAP,"CODE","2093-3","CHOLESTEROL, TOTAL")=""
"RTN","KBAIQLDM",223,0)
 S @G@(MAP,"CODE","12951-0","TRIGLYCERIDES")=""
"RTN","KBAIQLDM",224,0)
 S @G@(MAP,"CODE","11268-0","STREPTOZYME")=""
"RTN","KBAIQLDM",225,0)
 S @G@(MAP,"CODE","13217-5","CHLAMYDIA CULTURE")=""
"RTN","KBAIQLDM",226,0)
 S @G@(MAP,"CODE","14463-4","CHLAMYDIA CULTURE")=""
"RTN","KBAIQLDM",227,0)
 ; astro gpl
"RTN","KBAIQLDM",228,0)
 S @G@(MAP,"CODE","30313-1","HGB")=""
"RTN","KBAIQLDM",229,0)
 S @G@(MAP,"CODE","30313-1","HB (HGB)")=""
"RTN","KBAIQLDM",230,0)
 S @G@(MAP,"CODE","33765-9","WBC")=""
"RTN","KBAIQLDM",231,0)
 S @G@(MAP,"CODE","26515-7","PLT")=""
"RTN","KBAIQLDM",232,0)
 S @G@(MAP,"CODE","26515-7","PLT ")=""
"RTN","KBAIQLDM",233,0)
 S @G@(MAP,"CODE","50544-6","EVEROLIMUS BLOOD")=""
"RTN","KBAIQLDM",234,0)
 S @G@(MAP,"CODE","50544-6","EVEROLIMUS BLOOD LEVEL")=""
"RTN","KBAIQLDM",235,0)
 S @G@(MAP,"CODE","5778-6","URINE COLOR")=""
"RTN","KBAIQLDM",236,0)
 S @G@(MAP,"CODE","5767-9","APPEARANCE OF URINE")=""
"RTN","KBAIQLDM",237,0)
 S @G@(MAP,"CODE","5811-5","URINE DENSITY")=""
"RTN","KBAIQLDM",238,0)
 S @G@(MAP,"CODE","24357-6","URINALALYSIS MACRO (DIPSTICK) PANEL")=""
"RTN","KBAIQLDM",239,0)
 S @G@(MAP,"CODE","58410-2","CBC")=""
"RTN","KBAIQLDM",240,0)
 S @G@(MAP,"CODE","5803-2","URINE PH")=""
"RTN","KBAIQLDM",241,0)
 S @G@(MAP,"CODE","5792-7","URINE GLUCOSE")=""
"RTN","KBAIQLDM",242,0)
 S @G@(MAP,"CODE","5792-7","GLUCOSE1")=""
"RTN","KBAIQLDM",243,0)
 S @G@(MAP,"CODE","5797-6","URINE KEYTONES")=""
"RTN","KBAIQLDM",244,0)
 S @G@(MAP,"CODE","5797-6","URINE KETONES")=""
"RTN","KBAIQLDM",245,0)
 S @G@(MAP,"CODE","5797-6","KETONES")=""
"RTN","KBAIQLDM",246,0)
 S @G@(MAP,"CODE","5804-0","URINE PROTEIN")=""
"RTN","KBAIQLDM",247,0)
 S @G@(MAP,"CODE","5804-0","PROTEIN")=""
"RTN","KBAIQLDM",248,0)
 ; lab units
"RTN","KBAIQLDM",249,0)
 S MAP="units"
"RTN","KBAIQLDM",250,0)
 S @G@(MAP,"CODE","5804-0","mg/dL")="" ; PROTEIN
"RTN","KBAIQLDM",251,0)
 S @G@(MAP,"CODE","5792-7","mb/dL")="" ; URINE GLOCOSE
"RTN","KBAIQLDM",252,0)
 S @G@(MAP,"CODE","5811-5","1")="" ; URINE DENSITY
"RTN","KBAIQLDM",253,0)
 S @G@(MAP,"CODE","5803-2","[pH]")="" ; URINE PH
"RTN","KBAIQLDM",254,0)
 S @G@(MAP,"CODE","30313-1","g/dL")="" ; HGB
"RTN","KBAIQLDM",255,0)
 S @G@(MAP,"CODE","33765-9","10*3/uL")="" ; WBC
"RTN","KBAIQLDM",256,0)
 S @G@(MAP,"CODE","26515-7","10*3/uL")="" ; PLATELETS
"RTN","KBAIQLDM",257,0)
 S @G@(MAP,"CODE","50544-6","ng/mL")="" ;EVEROLIMUS BLOOD LEVEL
"RTN","KBAIQLDM",258,0)
 ; reference range low
"RTN","KBAIQLDM",259,0)
 S MAP="rangeLow"
"RTN","KBAIQLDM",260,0)
 S @G@(MAP,"CODE","5804-0","0.0")="" ; PROTEIN
"RTN","KBAIQLDM",261,0)
 S @G@(MAP,"CODE","5792-7","0.0")="" ; URINE GLOCOSE
"RTN","KBAIQLDM",262,0)
 S @G@(MAP,"CODE","5811-5","1.005")="" ; URINE DENSITY
"RTN","KBAIQLDM",263,0)
 S @G@(MAP,"CODE","5803-2","4.5")="" ; URINE PH
"RTN","KBAIQLDM",264,0)
 S @G@(MAP,"CODE","30313-1","13.5")="" ; HGB
"RTN","KBAIQLDM",265,0)
 S @G@(MAP,"CODE","33765-9","4.5")="" ; WBC
"RTN","KBAIQLDM",266,0)
 S @G@(MAP,"CODE","5797-6","0.6")="" ; URINE KETONES
"RTN","KBAIQLDM",267,0)
 S @G@(MAP,"CODE","26515-7","150")="" ; PLATELETS
"RTN","KBAIQLDM",268,0)
 S @G@(MAP,"CODE","50544-6","2.0")="" ;EVEROLIMUS BLOOD LEVEL
"RTN","KBAIQLDM",269,0)
 ; reference range high
"RTN","KBAIQLDM",270,0)
 S MAP="rangeHigh"
"RTN","KBAIQLDM",271,0)
 S @G@(MAP,"CODE","5804-0","20.0")="" ; PROTEIN
"RTN","KBAIQLDM",272,0)
 S @G@(MAP,"CODE","5792-7","0.8")="" ; URINE GLOCOSE
"RTN","KBAIQLDM",273,0)
 S @G@(MAP,"CODE","5811-5","1.030")="" ; URINE DENSITY
"RTN","KBAIQLDM",274,0)
 S @G@(MAP,"CODE","5803-2","8.0")="" ; URINE PH
"RTN","KBAIQLDM",275,0)
 S @G@(MAP,"CODE","30313-1","17.5")="" ; HGB
"RTN","KBAIQLDM",276,0)
 S @G@(MAP,"CODE","33765-9","11")="" ; WBC
"RTN","KBAIQLDM",277,0)
 S @G@(MAP,"CODE","5797-6","1.5")="" ; URINE KETONES
"RTN","KBAIQLDM",278,0)
 S @G@(MAP,"CODE","26515-7","400")="" ; PLATELETS
"RTN","KBAIQLDM",279,0)
 S @G@(MAP,"CODE","50544-6","8.0")="" ;EVEROLIMUS BLOOD LEVEL
"RTN","KBAIQLDM",280,0)
 ; 
"RTN","KBAIQLDM",281,0)
 ; rxnorm to vuid
"RTN","KBAIQLDM",282,0)
 S MAP="rxnorm"
"RTN","KBAIQLDM",283,0)
 S @G@(MAP,"CODE",1000097,4002480)=""
"RTN","KBAIQLDM",284,0)
 S @G@(MAP,"CODE",313585,4012182)=""
"RTN","KBAIQLDM",285,0)
 S @G@(MAP,"CODE",314153,4013783)=""
"RTN","KBAIQLDM",286,0)
 S @G@(MAP,"CODE",692876,4025906)=""
"RTN","KBAIQLDM",287,0)
 S @G@(MAP,"CODE",577154,4025018)=""
"RTN","KBAIQLDM",288,0)
 S @G@(MAP,"CODE",860215,4003764)=""
"RTN","KBAIQLDM",289,0)
 S @G@(MAP,"CODE",860221,4003765)=""
"RTN","KBAIQLDM",290,0)
 S @G@(MAP,"CODE",151226,4024528)=""
"RTN","KBAIQLDM",291,0)
 S @G@(MAP,"CODE",198029,4010104)=""
"RTN","KBAIQLDM",292,0)
 S @G@(MAP,"CODE",198030,4010106)=""
"RTN","KBAIQLDM",293,0)
 S @G@(MAP,"CODE",198031,4010105)=""
"RTN","KBAIQLDM",294,0)
 S @G@(MAP,"CODE",198045,4001216)=""
"RTN","KBAIQLDM",295,0)
 S @G@(MAP,"CODE",198046,4001218)=""
"RTN","KBAIQLDM",296,0)
 S @G@(MAP,"CODE",198047,4001215)=""
"RTN","KBAIQLDM",297,0)
 S @G@(MAP,"CODE",199888,4013030)=""
"RTN","KBAIQLDM",298,0)
 S @G@(MAP,"CODE",199889,4013031)=""
"RTN","KBAIQLDM",299,0)
 S @G@(MAP,"CODE",199890,4013032)=""
"RTN","KBAIQLDM",300,0)
 S @G@(MAP,"CODE",205315,4013343)=""
"RTN","KBAIQLDM",301,0)
 S @G@(MAP,"CODE",205316,4013342)=""
"RTN","KBAIQLDM",302,0)
 S @G@(MAP,"CODE",250983,4013568)=""
"RTN","KBAIQLDM",303,0)
 S @G@(MAP,"CODE",311975,4005637)=""
"RTN","KBAIQLDM",304,0)
 S @G@(MAP,"CODE",312036,4001214)=""
"RTN","KBAIQLDM",305,0)
 S @G@(MAP,"CODE",314119,4005636)=""
"RTN","KBAIQLDM",306,0)
 S @G@(MAP,"CODE",317136,4001217)=""
"RTN","KBAIQLDM",307,0)
 S @G@(MAP,"CODE",359817,4016739)=""
"RTN","KBAIQLDM",308,0)
 S @G@(MAP,"CODE",359818,4016738)=""
"RTN","KBAIQLDM",309,0)
 S @G@(MAP,"CODE",636671,4025534)=""
"RTN","KBAIQLDM",310,0)
 S @G@(MAP,"CODE",636676,4025535)=""
"RTN","KBAIQLDM",311,0)
 S @G@(MAP,"CODE",749289,4025532)=""
"RTN","KBAIQLDM",312,0)
 S @G@(MAP,"CODE",749788,4025533)=""
"RTN","KBAIQLDM",313,0)
 S @G@(MAP,"CODE",896100,4010112)=""
"RTN","KBAIQLDM",314,0)
 S @G@(MAP,"CODE",966531,4017048)=""
"RTN","KBAIQLDM",315,0)
 S @G@(MAP,"CODE",993503,4016940)=""
"RTN","KBAIQLDM",316,0)
 S @G@(MAP,"CODE",993518,4017073)=""
"RTN","KBAIQLDM",317,0)
 S @G@(MAP,"CODE",993536,4024749)=""
"RTN","KBAIQLDM",318,0)
 S @G@(MAP,"CODE",993541,4026567)=""
"RTN","KBAIQLDM",319,0)
 S @G@(MAP,"CODE",993550,4029871)=""
"RTN","KBAIQLDM",320,0)
 S @G@(MAP,"CODE",993557,4026568)=""
"RTN","KBAIQLDM",321,0)
 S @G@(MAP,"CODE",993567,4029870)=""
"RTN","KBAIQLDM",322,0)
 S @G@(MAP,"CODE",993681,4029872)=""
"RTN","KBAIQLDM",323,0)
 S @G@(MAP,"CODE",998671,4002473)=""
"RTN","KBAIQLDM",324,0)
 S @G@(MAP,"CODE",998675,4002474)=""
"RTN","KBAIQLDM",325,0)
 S @G@(MAP,"CODE",998679,4002475)=""
"RTN","KBAIQLDM",326,0)
 ; prefered rxnorm for astro
"RTN","KBAIQLDM",327,0)
 S MAP="preferedRxnorm"
"RTN","KBAIQLDM",328,0)
 S @G@(MAP,"CODE",70618,7980)="" ; pennicilin g
"RTN","KBAIQLDM",329,0)
 S @G@(MAP,"CODE",204871,309090)="" ; ceftriaxone 1 gram Solution for Injection
"RTN","KBAIQLDM",330,0)
 S @G@(MAP,"CODE",198440,209459)="" ; Acetaminophen 500 MG Oral Tablet [Tylenol]
"RTN","KBAIQLDM",331,0)
 N ZI
"RTN","KBAIQLDM",332,0)
 S ZI=""
"RTN","KBAIQLDM",333,0)
 F  S ZI=$O(@G@(ZI)) Q:ZI=""  D  ;
"RTN","KBAIQLDM",334,0)
 . N ZJ S ZJ=""
"RTN","KBAIQLDM",335,0)
 . F  S ZJ=$O(@G@(ZI,"CODE",ZJ)) Q:ZJ=""  D  ;
"RTN","KBAIQLDM",336,0)
 . . N ZK S ZK=""
"RTN","KBAIQLDM",337,0)
 . . F  S ZK=$O(@G@(ZI,"CODE",ZJ,ZK)) Q:ZK=""  D  ;
"RTN","KBAIQLDM",338,0)
 . . . N VAL
"RTN","KBAIQLDM",339,0)
 . . . S VAL=ZK
"RTN","KBAIQLDM",340,0)
 . . . S @G@(ZI,"VALUE",VAL,ZJ)=""
"RTN","KBAIQLDM",341,0)
 . . . S @G@("CODE",ZJ,VAL,ZI)=""
"RTN","KBAIQLDM",342,0)
 . . . S @G@("VALUE",VAL,ZJ,ZI)=""
"RTN","KBAIQLDM",343,0)
 Q
"RTN","KBAIQLDM",344,0)
 ;
"RTN","KBAIQLDM",345,0)
MAP(CDE,MAP) ; extrinsic returns the Value for the Code in map MAP, which is optional
"RTN","KBAIQLDM",346,0)
 N RTN
"RTN","KBAIQLDM",347,0)
 Q:CDE="" ""
"RTN","KBAIQLDM",348,0)
 N GN S GN=$NA(^XTMP("KBAIQLD","MAPS"))
"RTN","KBAIQLDM",349,0)
 I '$D(@GN) D INITMAPS
"RTN","KBAIQLDM",350,0)
 I '$D(MAP) D  Q RTN
"RTN","KBAIQLDM",351,0)
 . S RTN=$O(@GN@("CODE",CDE,""))
"RTN","KBAIQLDM",352,0)
 I '$D(@GN@(MAP)) S RTN="" Q  ;
"RTN","KBAIQLDM",353,0)
 S RTN=$O(@GN@(MAP,"CODE",CDE,""))
"RTN","KBAIQLDM",354,0)
 I $O(@GN@(MAP,"CODE",CDE,RTN))'="" S RTN=-1 ; more than one match
"RTN","KBAIQLDM",355,0)
 Q RTN
"RTN","KBAIQLDM",356,0)
 ;
"RTN","KBAIQLDM",357,0)
UNMAP(VAL,MAP) ; extrinsic returns the Value for the Code in map MAP, which is optional
"RTN","KBAIQLDM",358,0)
 N RTN
"RTN","KBAIQLDM",359,0)
 N GN S GN=$NA(^XTMP("KBAIQLD","MAPS"))
"RTN","KBAIQLDM",360,0)
 I '$D(MAP) D  Q RTN
"RTN","KBAIQLDM",361,0)
 . S RTN=$O(@GN@("VALUE",VAL,""))
"RTN","KBAIQLDM",362,0)
 I '$D(@GN@(MAP)) S RTN="" Q  ;
"RTN","KBAIQLDM",363,0)
 S RTN=$O(@GN@(MAP,"VALUE",VAL,""))
"RTN","KBAIQLDM",364,0)
 I $O(@GN@(MAP,"VALUE",VAL,RTN))'="" S RTN=-1 ; more than one match
"RTN","KBAIQLDM",365,0)
 Q RTN
"RTN","KBAIQLDM",366,0)
 ;
"RTN","KBAIQLDM",367,0)
GETMAP(RTN,MAP) ; returns an array of the MAP. if MAP is not specified, it returns an
"RTN","KBAIQLDM",368,0)
 ; array of the names of all the maps
"RTN","KBAIQLDM",369,0)
 N GN S GN=$NA(^XTMP("KBAIQLD","MAPS"))
"RTN","KBAIQLDM",370,0)
 I '$D(MAP) D  Q  ;
"RTN","KBAIQLDM",371,0)
 . N ZI S ZI=""
"RTN","KBAIQLDM",372,0)
 . F  S ZI=$O(@GN@(ZI)) Q:ZI=""  D  ;
"RTN","KBAIQLDM",373,0)
 . . Q:ZI="CODE"
"RTN","KBAIQLDM",374,0)
 . . Q:ZI="VALUE"
"RTN","KBAIQLDM",375,0)
 . . S @RTN@(ZI)=""
"RTN","KBAIQLDM",376,0)
 I $D(@GN@(MAP)) M @RTN=@GN@(MAP)
"RTN","KBAIQLDM",377,0)
 Q
"RTN","KBAIQLDM",378,0)
 ;
"VER")
8.0^22.2V2
**END**
**END**
